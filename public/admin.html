<!doctype html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… | Smart Menu</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    

    <script>
      const urlParamsGate = new URLSearchParams(window.location.search);
      const tokenGate =
        urlParamsGate.get("t") || sessionStorage.getItem("ownerToken");

      if (!tokenGate) {
        window.location.href = "/login";
      }
    </script>

    <style>
      * { box-sizing: border-box; } /* Ù‡Ø°Ø§ Ø§Ù„Ø³Ø·Ø± Ø³ÙŠØ¶Ø¨Ø· Ù…Ù‚Ø§Ø³Ø§Øª Ø§Ù„Ø¹Ù†Ø§ØµØ± ØªÙ…Ø§Ù…Ø§Ù‹ */
      :root {
        --primary: #4338ca;
        --primary-light: #e0e7ff;
        --secondary: #64748b;
        --bg: #f3f4f6;
        --surface: #ffffff;
        --border-color: #e2e8f0;
        --text-main: #1e293b;
        --success: #10b981;
        --danger: #ef4444;
        --warning: #f59e0b;
      }

      body.dark-mode {
        --primary: #6366f1;
        --primary-light: #312e81;
        --secondary: #94a3b8;
        --bg: #0f172a;
        --surface: #1e293b;
        --border-color: #334155;
        --text-main: #f1f5f9;
      }

      body {
        font-family: "Tajawal", sans-serif;
        background: var(--bg);
        margin: 0;
        display: flex;
        height: 100vh;
        overflow: hidden;
        color: var(--text-main);
        transition:
          background 0.3s,
          color 0.3s;
      }

      .mobile-header {
        display: none;
        background: var(--surface);
        padding: 15px;
        justify-content: space-between;
        align-items: center;
        border-bottom: 1px solid var(--border-color);
        position: fixed;
        top: 0;
        width: 100%;
        z-index: 1000;
        box-sizing: border-box;
      }
      .mobile-menu-btn {
        background: none;
        border: none;
        font-size: 24px;
        color: var(--text-main);
        cursor: pointer;
      }

      .sidebar {
        width: 260px;
        background: var(--surface);
        height: 100%;
        border-left: 1px solid var(--border-color);
        display: flex;
        flex-direction: column;
        padding: 20px;
        box-shadow: 2px 0 10px rgba(0, 0, 0, 0.02);
        z-index: 1001;
        transition: 0.3s;
      }
      .logo {
        font-size: 22px;
        font-weight: 800;
        color: var(--primary);
        margin-bottom: 40px;
        display: flex;
        align-items: center;
        gap: 10px;
      }
      .nav-item {
        padding: 12px 15px;
        margin-bottom: 8px;
        cursor: pointer;
        border-radius: 10px;
        color: var(--secondary);
        font-weight: 500;
        transition: 0.3s;
        display: flex;
        align-items: center;
        gap: 12px;
      }
      .nav-item:hover {
        background: var(--bg);
        color: var(--primary);
      }
      .nav-item.active {
        background: var(--primary);
        color: white;
        box-shadow: 0 4px 12px rgba(67, 56, 202, 0.3);
      }
      .nav-item i {
        width: 20px;
        text-align: center;
        font-size: 18px;
      }

      .overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        display: none;
      }

      .main-content {
        flex: 1;
        padding: 30px;
        overflow-y: auto;
        width: 100%;
      }
      .header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
      }
      .page-title {
        font-size: 24px;
        font-weight: 700;
        color: var(--text-main);
      }
      .btn-preview {
        background: var(--surface);
        border: 1px solid var(--border-color);
        padding: 10px 20px;
        border-radius: 30px;
        color: var(--primary);
        font-weight: bold;
        text-decoration: none;
        display: flex;
        align-items: center;
        gap: 8px;
        transition: 0.3s;
      }
      .btn-preview:hover {
        border-color: var(--primary);
        background: var(--primary-light);
      }

      .login-wrapper {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: var(--bg);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 2000;
      }
      .login-box {
        background: var(--surface);
        padding: 40px;
        border-radius: 20px;
        width: 400px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        text-align: center;
      }

      .card {
        background: var(--surface);
        border-radius: 16px;
        padding: 25px;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
        border: 1px solid var(--border-color);
        margin-bottom: 25px;
      }
      .form-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
      }
      .form-group {
        margin-bottom: 15px;
      }
      .form-label {
        display: block;
        margin-bottom: 8px;
        font-size: 14px;
        font-weight: 600;
        color: var(--secondary);
      }
      input,
      select,
      textarea {
        width: 100%;
        padding: 12px 15px;
        border: 1px solid #cbd5e1;
        border-radius: 10px;
        font-family: inherit;
        font-size: 14px;
        transition: 0.3s;
        outline: none;
        box-sizing: border-box;
        background: var(--bg);
        color: var(--text-main);
      }
      input:focus,
      select:focus,
      textarea:focus {
        border-color: var(--primary);
        box-shadow: 0 0 0 3px var(--primary-light);
      }

      input[type="file"] {
        display: none;
      }

      .custom-file-upload {
        border: 1px solid #cbd5e1;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        padding: 10px 15px;
        cursor: pointer;
        border-radius: 10px;
        background: var(--bg);
        color: var(--secondary);
        font-size: 14px;
        font-weight: 500;
        transition: 0.2s;
        height: 45px;
        box-sizing: border-box;
        width: 100%;
        white-space: nowrap;
      }
      .custom-file-upload:hover {
        border-color: var(--primary);
        color: var(--primary);
      }

      .img-preview {
        width: 45px;
        height: 45px;
        border-radius: 8px;
        object-fit: cover;
        display: none;
        border: 1px solid var(--border-color);
        margin-right: 10px;
      }

      .btn {
        padding: 12px 20px;
        border: none;
        border-radius: 10px;
        cursor: pointer;
        font-weight: bold;
        font-size: 14px;
        transition: 0.2s;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
      }
      .btn-primary {
        background: var(--primary);
        color: white;
        width: 100%;
      }
      .btn-primary:hover {
        background: #3730a3;
      }
      .btn-success {
        background: var(--success);
        color: white;
      }
      .btn-outline {
        background: transparent;
        border: 1px solid #cbd5e1;
        color: var(--secondary);
      }

      .search-container {
        position: relative;
        max-width: 400px;
        margin-bottom: 20px;
      }
      .search-input {
        padding-right: 40px;
        border-radius: 50px;
        background: var(--surface);
        border: 1px solid var(--border-color);
        color: var(--text-main);
      }
      .search-icon {
        position: absolute;
        right: 15px;
        top: 13px;
        color: var(--secondary);
      }

      .table-wrapper {
        overflow-x: auto;
        background: var(--surface);
        border-radius: 16px;
        border: 1px solid var(--border-color);
      }
      table {
        width: 100%;
        border-collapse: collapse;
        min-width: 600px;
      }
      th {
        background: var(--bg);
        text-align: right;
        padding: 18px;
        font-size: 13px;
        color: var(--secondary);
        font-weight: 700;
        border-bottom: 1px solid var(--border-color);
      }
      td {
        padding: 15px;
        border-bottom: 1px solid var(--border-color);
        font-size: 14px;
        vertical-align: middle;
        color: var(--text-main);
      }
      tr:last-child td {
        border-bottom: none;
      }
      tr:hover {
        background: var(--bg);
      }

      .badge {
        padding: 4px 10px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: bold;
      }
      .badge-cat {
        background: var(--primary-light);
        color: var(--primary);
      }

      .bulk-card {
        background: var(--surface);
        border: 1px dashed #cbd5e1;
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 15px;
        position: relative;
        transition: 0.3s;
      }
      .bulk-card:hover {
        border-color: var(--primary);
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
      }
      .btn-remove-row {
        position: absolute;
        left: 15px;
        top: 15px;
        color: var(--danger);
        background: var(--bg);
        border: none;
        width: 30px;
        height: 30px;
        border-radius: 50%;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: 0.2s;
      }
      .btn-remove-row:hover {
        background: var(--danger);
        color: white;
      }

     .hidden {
        display: none !important;
      }

/* ================================================= */
/* ğŸ“± Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙƒØ§Ù…Ù„ (Mobile App System) */
/* ================================================= */

/* Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø¨Ø§Ø± Ø§Ù„Ø³ÙÙ„ÙŠ ÙÙŠ Ø§Ù„ÙƒÙ…Ø¨ÙŠÙˆØªØ± */
.mobile-bottom-nav { display: none; }

@media (max-width: 768px) {
    
    /* 1. Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© ÙˆØªØ­ÙˆÙŠÙ„Ù‡Ø§ Ù„Ù‚Ø§Ø¦Ù…Ø© "Ø§Ù„Ù…Ø²ÙŠØ¯" */
    .sidebar {
        position: fixed !important; /* Ù‡Ø°Ø§ Ø§Ù„Ø³Ø·Ø± Ù‡Ùˆ Ø§Ù„Ø­Ù„ Ù„ØªØ«Ø¨ÙŠØª Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© ÙˆØ¥Ø®ÙØ§Ø¦Ù‡Ø§ */
        z-index: 9999 !important;
        width: 100% !important; /* ØªØºØ·ÙŠ Ø§Ù„Ø´Ø§Ø´Ø© Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ Ø¹Ù†Ø¯ Ø§Ù„ÙØªØ­ */
        right: -100% !important;
        top: 0 !important;
        background: rgba(255,255,255,0.98) !important;
        backdrop-filter: blur(10px);
        transition: right 0.3s ease-in-out;
    }
    .sidebar.active { right: 0 !important; }

    /* 2. ØªØµÙ…ÙŠÙ… Ø§Ù„Ø¨Ø§Ø± Ø§Ù„Ø³ÙÙ„ÙŠ (App Bar) */
    .mobile-bottom-nav {
        display: flex;
        position: fixed;
        bottom: 0; left: 0; width: 100%;
        height: 65px;
        background: #ffffff;
        box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
        z-index: 9000;
        justify-content: space-around;
        align-items: center;
        border-top: 1px solid #f1f5f9;
        padding-bottom: 5px; /* Ø¹Ø´Ø§Ù† Ø§Ù„Ù€ iPhone Home Indicator */
    }

    .nav-icon {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        color: #94a3b8;
        font-size: 10px;
        width: 20%;
        cursor: pointer;
        position: relative;
    }

    .nav-icon i { font-size: 20px; margin-bottom: 4px; transition: 0.2s; }
    
    .nav-icon.active { color: var(--primary); font-weight: bold; }
    .nav-icon.active i { transform: translateY(-3px); }

    /* 3. Ø¶Ø¨Ø· Ø¬Ø³Ù… Ø§Ù„ØµÙØ­Ø© Ù„ÙŠØªÙ†Ø§Ø³Ø¨ Ù…Ø¹ Ø§Ù„Ø¨Ø§Ø± Ø§Ù„Ø³ÙÙ„ÙŠ */
    body { background: #f8fafc; padding-bottom: 80px; } /* Ù…Ø³Ø§Ø­Ø© Ù„Ù„Ø¨Ø§Ø± */
    
    .main-content {
        width: 100% !important;
        padding: 70px 15px 20px 15px !important; /* Ù…Ø³Ø§Ø­Ø© Ù„Ù„Ù‡ÙŠØ¯Ø± */
        margin: 0 !important;
    }

    /* 4. Ø§Ù„Ù‡ÙŠØ¯Ø± Ø§Ù„Ø¹Ù„ÙˆÙŠ (App Header) */
    .mobile-header {
        height: 60px;
        background: #ffffff;
        box-shadow: 0 1px 5px rgba(0,0,0,0.03);
        position: fixed; top: 0; left: 0; width: 100%;
        z-index: 8000;
        padding: 0 15px;
        display: flex !important;
        align-items: center;
        justify-content: space-between;
    }
    
    /* Ø¥Ø®ÙØ§Ø¡ Ø²Ø± Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù‚Ø¯ÙŠÙ… ÙÙŠ Ø§Ù„Ù‡ÙŠØ¯Ø± Ù„Ø£Ù†Ù†Ø§ Ù†Ù‚Ù„Ù†Ø§Ù‡ ØªØ­Øª */
    .mobile-menu-btn { display: none !important; }

    /* 5. ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ Ø¥Ù„Ù‰ ÙƒØ±ÙˆØª (Cards UI) - Ù†Ø³Ø®Ø© Ù…Ø¯Ù…Ø¬Ø© */
    .table-wrapper { background: transparent !important; border: none !important; box-shadow: none !important; }
    /* Ø¥Ø¶Ø§ÙØ© min-width: 0 Ù„Ù…Ù†Ø¹ Ø§Ù„Ø®Ø±ÙˆØ¬ Ø¹Ù† Ø§Ù„Ø´Ø§Ø´Ø© */
    table { display: block !important; width: 100% !important; min-width: 0 !important; }
    thead { display: none !important; }
    tbody, th, td, tr { display: block !important; width: 100% !important; }

    tr {
        background: #fff;
        margin-bottom: 10px; /* ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ù…Ø³Ø§ÙØ© Ø¨ÙŠÙ† Ø§Ù„ÙƒØ±ÙˆØª */
        border-radius: 12px;
        padding: 12px; /* ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ø­Ø´Ùˆ Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠ Ù„Ù„ÙƒØ§Ø±Øª */
        box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        border: 1px solid #f1f5f9;
        position: relative;
    }

    td {
        display: flex !important;
        justify-content: space-between;
        align-items: center;
        padding: 6px 0 !important; /* ØªÙ‚Ù„ÙŠÙ„ Ø§Ø±ØªÙØ§Ø¹ Ø§Ù„Ø³Ø·Ø± Ø¯Ø§Ø®Ù„ Ø§Ù„ÙƒØ§Ø±Øª */
        border-bottom: 1px dashed #f1f5f9;
        text-align: right;
        font-size: 13px; /* ØªØµØºÙŠØ± Ø§Ù„Ø®Ø· Ù‚Ù„ÙŠÙ„Ø§Ù‹ */
        color: #334155;
    }
    
    td:last-child { border-bottom: none !important; padding-top: 10px !important; justify-content: flex-end; gap: 5px; }
    
    /* ØªØ­Ø³ÙŠÙ† Ø§Ù„ØµÙˆØ± Ø¯Ø§Ø®Ù„ Ø§Ù„ÙƒØ±ÙˆØª */
    td img { width: 40px !important; height: 40px !important; border-radius: 8px !important; }

    /* 6. ØªØ­Ø³ÙŠÙ† Ø§Ù„Ù†Ù…Ø§Ø°Ø¬ (Inputs) Ù„ØªÙ†Ø§Ø³Ø¨ Ø§Ù„Ø´Ø§Ø´Ø© Ø§Ù„ØµØºÙŠØ±Ø© */
    .card {
        border-radius: 16px !important;
        border: none !important;
        box-shadow: 0 2px 10px rgba(0,0,0,0.02) !important;
        padding: 15px !important; /* ØªÙ‚Ù„ÙŠÙ„ Ø­Ø´Ùˆ Ø§Ù„Ù†Ù…Ø§Ø°Ø¬ */
        margin-bottom: 15px !important;
    }
    
    .form-grid { display: flex !important; flex-direction: column !important; gap: 10px !important; }
    
    input, select, textarea {
        height: 40px !important; /* ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ø§Ø±ØªÙØ§Ø¹ Ù…Ù† 50 Ø¥Ù„Ù‰ 40 */
        background: #f8fafc !important;
        border: 1px solid #e2e8f0 !important;
        border-radius: 8px !important;
        font-size: 14px !important;
        padding: 0 10px !important;
    }

    /* ØªØµØºÙŠØ± Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ù„ØªÙƒÙˆÙ† Ø£Ù†ÙŠÙ‚Ø© */
    .btn { 
        height: 40px !important; 
        border-radius: 8px !important; 
        font-size: 14px !important; 
        padding: 0 15px !important;
    }
    .table-wrapper { background: transparent !important; border: none !important; box-shadow: none !important; }
    /* Ø¥Ø¶Ø§ÙØ© min-width: 0 Ù„Ù…Ù†Ø¹ Ø§Ù„Ø®Ø±ÙˆØ¬ Ø¹Ù† Ø§Ù„Ø´Ø§Ø´Ø© */
    table { display: block !important; width: 100% !important; min-width: 0 !important; }
    thead { display: none !important; }
    tbody, th, td, tr { display: block !important; width: 100% !important; }

    tr {
        background: #fff;
        margin-bottom: 10px; /* ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ù…Ø³Ø§ÙØ© Ø¨ÙŠÙ† Ø§Ù„ÙƒØ±ÙˆØª */
        border-radius: 12px;
        padding: 12px; /* ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ø­Ø´Ùˆ Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠ Ù„Ù„ÙƒØ§Ø±Øª */
        box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        border: 1px solid #f1f5f9;
        position: relative;
    }

    td {
        display: flex !important;
        justify-content: space-between;
        align-items: center;
        padding: 6px 0 !important; /* ØªÙ‚Ù„ÙŠÙ„ Ø§Ø±ØªÙØ§Ø¹ Ø§Ù„Ø³Ø·Ø± Ø¯Ø§Ø®Ù„ Ø§Ù„ÙƒØ§Ø±Øª */
        border-bottom: 1px dashed #f1f5f9;
        text-align: right;
        font-size: 13px; /* ØªØµØºÙŠØ± Ø§Ù„Ø®Ø· Ù‚Ù„ÙŠÙ„Ø§Ù‹ */
        color: #334155;
    }
    
    td:last-child { border-bottom: none !important; padding-top: 10px !important; justify-content: flex-end; gap: 5px; }
    
    /* ØªØ­Ø³ÙŠÙ† Ø§Ù„ØµÙˆØ± Ø¯Ø§Ø®Ù„ Ø§Ù„ÙƒØ±ÙˆØª */
    td img { width: 40px !important; height: 40px !important; border-radius: 8px !important; }

    /* 6. ØªØ­Ø³ÙŠÙ† Ø§Ù„Ù†Ù…Ø§Ø°Ø¬ (Inputs) Ù„ØªÙ†Ø§Ø³Ø¨ Ø§Ù„Ø´Ø§Ø´Ø© Ø§Ù„ØµØºÙŠØ±Ø© */
    .card {
        border-radius: 16px !important;
        border: none !important;
        box-shadow: 0 2px 10px rgba(0,0,0,0.02) !important;
        padding: 15px !important; /* ØªÙ‚Ù„ÙŠÙ„ Ø­Ø´Ùˆ Ø§Ù„Ù†Ù…Ø§Ø°Ø¬ */
        margin-bottom: 15px !important;
    }
    
    .form-grid { display: flex !important; flex-direction: column !important; gap: 10px !important; }
    
    input, select, textarea {
        height: 40px !important; /* ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ø§Ø±ØªÙØ§Ø¹ Ù…Ù† 50 Ø¥Ù„Ù‰ 40 */
        background: #f8fafc !important;
        border: 1px solid #e2e8f0 !important;
        border-radius: 8px !important;
        font-size: 14px !important;
        padding: 0 10px !important;
    }

    /* ØªØµØºÙŠØ± Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ù„ØªÙƒÙˆÙ† Ø£Ù†ÙŠÙ‚Ø© */
    .btn { 
        height: 40px !important; 
        border-radius: 8px !important; 
        font-size: 14px !important; 
        padding: 0 15px !important;
    }

    /* 7. Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø¹Ù†Ø§ØµØ± ØºÙŠØ± Ø§Ù„Ø¶Ø±ÙˆØ±ÙŠØ© */
    /* --- Ø¨Ø¯Ø§ÙŠØ© ÙƒÙˆØ¯ Ø¥ØµÙ„Ø§Ø­ Ø§Ù„ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© --- */

    /* Ø¥Ø®ÙØ§Ø¡ Ø²Ø± Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© ÙÙ‚Ø· (Ø¨Ø¯ÙˆÙ† Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù€ overlay) */
    #preview-link { display: none !important; }

    /* Ø¥Ø¬Ø¨Ø§Ø± Ù†Ø§ÙØ°Ø© Ø§Ù„ÙÙˆØ§ØªÙŠØ± Ø¹Ù„Ù‰ Ø§Ù„Ø¸Ù‡ÙˆØ± ÙÙˆÙ‚ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø³ÙÙ„ÙŠØ© */
    #recent-orders-modal {
        z-index: 999999 !important; /* Ø±Ù‚Ù… Ø£Ø¹Ù„Ù‰ Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø³ÙÙ„ÙŠØ© */
        background: rgba(0,0,0,0.85) !important; /* ØªØ¹ØªÙŠÙ… Ø§Ù„Ø®Ù„ÙÙŠØ© */
    }

    /* Ø¹Ù†Ø¯Ù…Ø§ ØªØ¹Ù…Ù„ Ø§Ù„Ù†Ø§ÙØ°Ø©ØŒ Ø§Ø¬Ø¹Ù„Ù‡Ø§ ÙÙŠ Ù…Ù†ØªØµÙ Ø§Ù„Ø´Ø§Ø´Ø© */
    #recent-orders-modal[style*="block"] {
        display: flex !important;
        align-items: center;
        justify-content: center;
    }

    /* Ø¶Ø¨Ø· Ø­Ø¬Ù… ÙƒØ§Ø±Øª Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ù†ÙØ³Ù‡ */
    #recent-orders-modal .card {
        width: 90% !important;
        max-width: 90% !important;
        margin: 0 !important;
        max-height: 80vh !important;
    }

    /* --- Ù†Ù‡Ø§ÙŠØ© ÙƒÙˆØ¯ Ø§Ù„Ø¥ØµÙ„Ø§Ø­ --- */
    
    /* Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ ÙŠØ¸Ù‡Ø± ÙÙˆÙ‚ ÙƒÙ„ Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø¹Ù†Ø¯ Ø§Ù„ÙØªØ­ */
    #recent-orders-modal.overlay { 
        display: none; 
        z-index: 99999 !important; /* Ø±Ù‚Ù… Ø¹Ø§Ù„ÙŠ Ø¬Ø¯Ø§Ù‹ Ù„ÙŠØ¸Ù‡Ø± ÙÙˆÙ‚ Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… */
    }

    /* 8. Ø¥ØµÙ„Ø§Ø­Ø§Øª Ø§Ù„ØµÙØ­Ø§Øª */
    #orders-grid { grid-template-columns: 1fr !important; }
    .phone-frame { width: 100% !important; height: 550px !important; border-width: 4px !important; }
}
/* ================================================= */
/* ğŸ“± Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙƒØ§Ù…Ù„ (Mobile App System) */
/* ================================================= */

/* Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø¨Ø§Ø± Ø§Ù„Ø³ÙÙ„ÙŠ ÙÙŠ Ø§Ù„ÙƒÙ…Ø¨ÙŠÙˆØªØ± */
.mobile-bottom-nav { display: none; }

@media (max-width: 768px) {
    
    /* 1. Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© ÙˆØªØ­ÙˆÙŠÙ„Ù‡Ø§ Ù„Ù‚Ø§Ø¦Ù…Ø© "Ø§Ù„Ù…Ø²ÙŠØ¯" */
    .sidebar {
        position: fixed !important; /* Ù‡Ø°Ø§ Ø§Ù„Ø³Ø·Ø± Ù‡Ùˆ Ø§Ù„Ø­Ù„ Ù„ØªØ«Ø¨ÙŠØª Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© ÙˆØ¥Ø®ÙØ§Ø¦Ù‡Ø§ */
        z-index: 9999 !important;
        width: 100% !important; /* ØªØºØ·ÙŠ Ø§Ù„Ø´Ø§Ø´Ø© Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ Ø¹Ù†Ø¯ Ø§Ù„ÙØªØ­ */
        right: -100% !important;
        top: 0 !important;
        background: rgba(255,255,255,0.98) !important;
        backdrop-filter: blur(10px);
        transition: right 0.3s ease-in-out;
    }
    .sidebar.active { right: 0 !important; }

    /* 2. ØªØµÙ…ÙŠÙ… Ø§Ù„Ø¨Ø§Ø± Ø§Ù„Ø³ÙÙ„ÙŠ (App Bar) */
    .mobile-bottom-nav {
        display: flex;
        position: fixed;
        bottom: 0; left: 0; width: 100%;
        height: 65px;
        background: #ffffff;
        box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
        z-index: 9000;
        justify-content: space-around;
        align-items: center;
        border-top: 1px solid #f1f5f9;
        padding-bottom: 5px; /* Ø¹Ø´Ø§Ù† Ø§Ù„Ù€ iPhone Home Indicator */
    }

    .nav-icon {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        color: #94a3b8;
        font-size: 10px;
        width: 20%;
        cursor: pointer;
        position: relative;
    }

    .nav-icon i { font-size: 20px; margin-bottom: 4px; transition: 0.2s; }
    
    .nav-icon.active { color: var(--primary); font-weight: bold; }
    .nav-icon.active i { transform: translateY(-3px); }

    /* 3. Ø¶Ø¨Ø· Ø¬Ø³Ù… Ø§Ù„ØµÙØ­Ø© Ù„ÙŠØªÙ†Ø§Ø³Ø¨ Ù…Ø¹ Ø§Ù„Ø¨Ø§Ø± Ø§Ù„Ø³ÙÙ„ÙŠ */
    body { background: #f8fafc; padding-bottom: 80px; } /* Ù…Ø³Ø§Ø­Ø© Ù„Ù„Ø¨Ø§Ø± */
    
    .main-content {
        width: 100% !important;
        padding: 70px 15px 20px 15px !important; /* Ù…Ø³Ø§Ø­Ø© Ù„Ù„Ù‡ÙŠØ¯Ø± */
        margin: 0 !important;
    }

    /* 4. Ø§Ù„Ù‡ÙŠØ¯Ø± Ø§Ù„Ø¹Ù„ÙˆÙŠ (App Header) */
    .mobile-header {
        height: 60px;
        background: #ffffff;
        box-shadow: 0 1px 5px rgba(0,0,0,0.03);
        position: fixed; top: 0; left: 0; width: 100%;
        z-index: 8000;
        padding: 0 15px;
        display: flex !important;
        align-items: center;
        justify-content: space-between;
    }
    
    /* Ø¥Ø®ÙØ§Ø¡ Ø²Ø± Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù‚Ø¯ÙŠÙ… ÙÙŠ Ø§Ù„Ù‡ÙŠØ¯Ø± Ù„Ø£Ù†Ù†Ø§ Ù†Ù‚Ù„Ù†Ø§Ù‡ ØªØ­Øª */
    .mobile-menu-btn { display: none !important; }

    /* 5. ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ Ø¥Ù„Ù‰ ÙƒØ±ÙˆØª (Cards UI) - Ù†Ø³Ø®Ø© Ù…Ø¯Ù…Ø¬Ø© */
    .table-wrapper { background: transparent !important; border: none !important; box-shadow: none !important; }
    /* Ø¥Ø¶Ø§ÙØ© min-width: 0 Ù„Ù…Ù†Ø¹ Ø§Ù„Ø®Ø±ÙˆØ¬ Ø¹Ù† Ø§Ù„Ø´Ø§Ø´Ø© */
    table { display: block !important; width: 100% !important; min-width: 0 !important; }
    thead { display: none !important; }
    tbody, th, td, tr { display: block !important; width: 100% !important; }

    tr {
        background: #fff;
        margin-bottom: 10px; /* ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ù…Ø³Ø§ÙØ© Ø¨ÙŠÙ† Ø§Ù„ÙƒØ±ÙˆØª */
        border-radius: 12px;
        padding: 12px; /* ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ø­Ø´Ùˆ Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠ Ù„Ù„ÙƒØ§Ø±Øª */
        box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        border: 1px solid #f1f5f9;
        position: relative;
    }

    td {
        display: flex !important;
        justify-content: space-between;
        align-items: center;
        padding: 6px 0 !important; /* ØªÙ‚Ù„ÙŠÙ„ Ø§Ø±ØªÙØ§Ø¹ Ø§Ù„Ø³Ø·Ø± Ø¯Ø§Ø®Ù„ Ø§Ù„ÙƒØ§Ø±Øª */
        border-bottom: 1px dashed #f1f5f9;
        text-align: right;
        font-size: 13px; /* ØªØµØºÙŠØ± Ø§Ù„Ø®Ø· Ù‚Ù„ÙŠÙ„Ø§Ù‹ */
        color: #334155;
    }
    
    td:last-child { border-bottom: none !important; padding-top: 10px !important; justify-content: flex-end; gap: 5px; }
    
    /* ØªØ­Ø³ÙŠÙ† Ø§Ù„ØµÙˆØ± Ø¯Ø§Ø®Ù„ Ø§Ù„ÙƒØ±ÙˆØª */
    td img { width: 40px !important; height: 40px !important; border-radius: 8px !important; }

    /* 6. ØªØ­Ø³ÙŠÙ† Ø§Ù„Ù†Ù…Ø§Ø°Ø¬ (Inputs) Ù„ØªÙ†Ø§Ø³Ø¨ Ø§Ù„Ø´Ø§Ø´Ø© Ø§Ù„ØµØºÙŠØ±Ø© */
    .card {
        border-radius: 16px !important;
        border: none !important;
        box-shadow: 0 2px 10px rgba(0,0,0,0.02) !important;
        padding: 15px !important; /* ØªÙ‚Ù„ÙŠÙ„ Ø­Ø´Ùˆ Ø§Ù„Ù†Ù…Ø§Ø°Ø¬ */
        margin-bottom: 15px !important;
    }
    
    .form-grid { display: flex !important; flex-direction: column !important; gap: 10px !important; }
    
    input, select, textarea {
        height: 40px !important; /* ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ø§Ø±ØªÙØ§Ø¹ Ù…Ù† 50 Ø¥Ù„Ù‰ 40 */
        background: #f8fafc !important;
        border: 1px solid #e2e8f0 !important;
        border-radius: 8px !important;
        font-size: 14px !important;
        padding: 0 10px !important;
    }

    /* ØªØµØºÙŠØ± Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ù„ØªÙƒÙˆÙ† Ø£Ù†ÙŠÙ‚Ø© */
    .btn { 
        height: 40px !important; 
        border-radius: 8px !important; 
        font-size: 14px !important; 
        padding: 0 15px !important;
    }
    .table-wrapper { background: transparent !important; border: none !important; box-shadow: none !important; }
    /* Ø¥Ø¶Ø§ÙØ© min-width: 0 Ù„Ù…Ù†Ø¹ Ø§Ù„Ø®Ø±ÙˆØ¬ Ø¹Ù† Ø§Ù„Ø´Ø§Ø´Ø© */
    table { display: block !important; width: 100% !important; min-width: 0 !important; }
    thead { display: none !important; }
    tbody, th, td, tr { display: block !important; width: 100% !important; }

    tr {
        background: #fff;
        margin-bottom: 10px; /* ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ù…Ø³Ø§ÙØ© Ø¨ÙŠÙ† Ø§Ù„ÙƒØ±ÙˆØª */
        border-radius: 12px;
        padding: 12px; /* ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ø­Ø´Ùˆ Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠ Ù„Ù„ÙƒØ§Ø±Øª */
        box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        border: 1px solid #f1f5f9;
        position: relative;
    }

    td {
        display: flex !important;
        justify-content: space-between;
        align-items: center;
        padding: 6px 0 !important; /* ØªÙ‚Ù„ÙŠÙ„ Ø§Ø±ØªÙØ§Ø¹ Ø§Ù„Ø³Ø·Ø± Ø¯Ø§Ø®Ù„ Ø§Ù„ÙƒØ§Ø±Øª */
        border-bottom: 1px dashed #f1f5f9;
        text-align: right;
        font-size: 13px; /* ØªØµØºÙŠØ± Ø§Ù„Ø®Ø· Ù‚Ù„ÙŠÙ„Ø§Ù‹ */
        color: #334155;
    }
    
    td:last-child { border-bottom: none !important; padding-top: 10px !important; justify-content: flex-end; gap: 5px; }
    
    /* ØªØ­Ø³ÙŠÙ† Ø§Ù„ØµÙˆØ± Ø¯Ø§Ø®Ù„ Ø§Ù„ÙƒØ±ÙˆØª */
    td img { width: 40px !important; height: 40px !important; border-radius: 8px !important; }

    /* 6. ØªØ­Ø³ÙŠÙ† Ø§Ù„Ù†Ù…Ø§Ø°Ø¬ (Inputs) Ù„ØªÙ†Ø§Ø³Ø¨ Ø§Ù„Ø´Ø§Ø´Ø© Ø§Ù„ØµØºÙŠØ±Ø© */
    .card {
        border-radius: 16px !important;
        border: none !important;
        box-shadow: 0 2px 10px rgba(0,0,0,0.02) !important;
        padding: 15px !important; /* ØªÙ‚Ù„ÙŠÙ„ Ø­Ø´Ùˆ Ø§Ù„Ù†Ù…Ø§Ø°Ø¬ */
        margin-bottom: 15px !important;
    }
    
    .form-grid { display: flex !important; flex-direction: column !important; gap: 10px !important; }
    
    input, select, textarea {
        height: 40px !important; /* ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ø§Ø±ØªÙØ§Ø¹ Ù…Ù† 50 Ø¥Ù„Ù‰ 40 */
        background: #f8fafc !important;
        border: 1px solid #e2e8f0 !important;
        border-radius: 8px !important;
        font-size: 14px !important;
        padding: 0 10px !important;
    }

    /* ØªØµØºÙŠØ± Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ù„ØªÙƒÙˆÙ† Ø£Ù†ÙŠÙ‚Ø© */
    .btn { 
        height: 40px !important; 
        border-radius: 8px !important; 
        font-size: 14px !important; 
        padding: 0 15px !important;
    }

    /* 7. Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø¹Ù†Ø§ØµØ± ØºÙŠØ± Ø§Ù„Ø¶Ø±ÙˆØ±ÙŠØ© */
    /* --- Ø¨Ø¯Ø§ÙŠØ© ÙƒÙˆØ¯ Ø¥ØµÙ„Ø§Ø­ Ø§Ù„ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© --- */

    /* Ø¥Ø®ÙØ§Ø¡ Ø²Ø± Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© ÙÙ‚Ø· (Ø¨Ø¯ÙˆÙ† Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù€ overlay) */
    #preview-link { display: none !important; }

    /* Ø¥Ø¬Ø¨Ø§Ø± Ù†Ø§ÙØ°Ø© Ø§Ù„ÙÙˆØ§ØªÙŠØ± Ø¹Ù„Ù‰ Ø§Ù„Ø¸Ù‡ÙˆØ± ÙÙˆÙ‚ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø³ÙÙ„ÙŠØ© */
    #recent-orders-modal {
        z-index: 999999 !important; /* Ø±Ù‚Ù… Ø£Ø¹Ù„Ù‰ Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø³ÙÙ„ÙŠØ© */
        background: rgba(0,0,0,0.85) !important; /* ØªØ¹ØªÙŠÙ… Ø§Ù„Ø®Ù„ÙÙŠØ© */
    }

    /* Ø¹Ù†Ø¯Ù…Ø§ ØªØ¹Ù…Ù„ Ø§Ù„Ù†Ø§ÙØ°Ø©ØŒ Ø§Ø¬Ø¹Ù„Ù‡Ø§ ÙÙŠ Ù…Ù†ØªØµÙ Ø§Ù„Ø´Ø§Ø´Ø© */
    #recent-orders-modal[style*="block"] {
        display: flex !important;
        align-items: center;
        justify-content: center;
    }

    /* Ø¶Ø¨Ø· Ø­Ø¬Ù… ÙƒØ§Ø±Øª Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ù†ÙØ³Ù‡ */
    #recent-orders-modal .card {
        width: 90% !important;
        max-width: 90% !important;
        margin: 0 !important;
        max-height: 80vh !important;
    }

    /* --- Ù†Ù‡Ø§ÙŠØ© ÙƒÙˆØ¯ Ø§Ù„Ø¥ØµÙ„Ø§Ø­ --- */
    /* Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ ÙŠØ¸Ù‡Ø± ÙÙˆÙ‚ ÙƒÙ„ Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø¹Ù†Ø¯ Ø§Ù„ÙØªØ­ */
    #recent-orders-modal.overlay { 
        display: none; 
        z-index: 99999 !important; /* Ø±Ù‚Ù… Ø¹Ø§Ù„ÙŠ Ø¬Ø¯Ø§Ù‹ Ù„ÙŠØ¸Ù‡Ø± ÙÙˆÙ‚ Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… */
    }

    /* 8. Ø¥ØµÙ„Ø§Ø­Ø§Øª Ø§Ù„ØµÙØ­Ø§Øª */
    #orders-grid { grid-template-columns: 1fr !important; }
    .phone-frame { width: 100% !important; height: 550px !important; border-width: 4px !important; }
}
:root {
        --primary: #4338ca;
        --primary-light: #e0e7ff;
        --secondary: #64748b;
        --bg: #f8fafc; /* Ù„ÙˆÙ† Ø®Ù„ÙÙŠØ© Ø£ÙØªØ­ Ù‚Ù„ÙŠÙ„Ø§Ù‹ */
        --surface: #ffffff;
        --border-color: #e2e8f0;
        --text-main: #1e293b;
        --success: #10b981;
        --danger: #ef4444;
        --warning: #f59e0b;
        --radius: 16px; /* ØªÙˆØ­ÙŠØ¯ Ø§Ù„Ø§Ù†Ø­Ù†Ø§Ø¡Ø§Øª */
        --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
      }

      body.dark-mode {
        --primary: #6366f1;
        --primary-light: #312e81;
        --secondary: #94a3b8;
        --bg: #0f172a;
        --surface: #1e293b;
        --border-color: #334155;
        --text-main: #f1f5f9;
        --shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
      }

      * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
      
      body {
        font-family: "Tajawal", sans-serif;
        background: var(--bg);
        margin: 0;
        display: flex;
        height: 100vh;
        overflow: hidden;
        color: var(--text-main);
        transition: background 0.3s, color 0.3s;
      }

      /* === Animations === */
      @keyframes fadeInScale {
        0% { opacity: 0; transform: scale(0.98) translateY(10px); }
        100% { opacity: 1; transform: scale(1) translateY(0); }
      }
      
      @keyframes slideInRight {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
      }

      .view-animate {
        animation: fadeInScale 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards;
      }

      /* === Sidebar & Nav === */
      .sidebar {
        width: 280px;
        background: var(--surface);
        height: 100%;
        border-left: 1px solid var(--border-color);
        display: flex;
        flex-direction: column;
        padding: 15px 10px; /* ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ø­Ø´Ùˆ Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠ Ù„ØªÙˆÙÙŠØ± Ù…Ø³Ø§Ø­Ø© */
        z-index: 1001;
        transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        overflow-y: auto; /* [Ù‡Ø§Ù…] Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„Ø³ÙƒØ±ÙˆÙ„ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ø¹Ù†Ø§ØµØ± ÙƒØ«ÙŠØ±Ø© */
      }
      /* ØªØ­Ø³ÙŠÙ† Ø´ÙƒÙ„ Ø§Ù„Ø³ÙƒØ±ÙˆÙ„ Ø¨Ø§Ø± Ù„Ù„Ù‚Ø§Ø¦Ù…Ø© */
      .sidebar::-webkit-scrollbar { width: 4px; }
      .sidebar::-webkit-scrollbar-track { background: transparent; }
      .sidebar::-webkit-scrollbar-thumb { background: var(--border-color); border-radius: 10px; }

      .logo {
        font-size: 24px;
        font-weight: 800;
        color: var(--primary);
        margin-bottom: 40px;
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 0 10px;
      }

      .nav-item {
        padding: 10px 14px; /* ØªØµØºÙŠØ± Ø­Ø¬Ù… Ø§Ù„Ø²Ø± */
        margin-bottom: 4px; /* ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ù…Ø³Ø§ÙØ© Ø¨ÙŠÙ† Ø§Ù„Ø£Ø²Ø±Ø§Ø± */
        cursor: pointer;
        border-radius: 10px;
        color: var(--secondary);
        font-weight: 600;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        gap: 12px;
        font-size: 14px; /* ØªØµØºÙŠØ± Ø§Ù„Ø®Ø· Ø¯Ø±Ø¬Ø© ÙˆØ§Ø­Ø¯Ø© */
      }

      .nav-item:hover {
        background: var(--bg);
        color: var(--primary);
        transform: translateX(-5px);
      }

      .nav-item.active {
        background: var(--primary);
        color: white;
        box-shadow: 0 4px 15px rgba(67, 56, 202, 0.25);
        transform: translateX(-5px);
      }

      /* === Main Content === */
      .main-content {
        flex: 1;
        padding: 30px; /* Default desktop padding */
        overflow-y: auto;
        width: 100%;
        scroll-behavior: smooth;
      }

      .header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
      }

      .page-title {
        font-size: 26px;
        font-weight: 800;
        color: var(--text-main);
      }

      /* === Cards & Inputs === */
      .card {
        background: var(--surface);
        border-radius: var(--radius);
        padding: 25px;
        box-shadow: var(--shadow);
        border: 1px solid var(--border-color);
        margin-bottom: 25px;
        transition: transform 0.2s, box-shadow 0.2s;
      }
      
      .form-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
      }

      .form-label {
        display: block;
        margin-bottom: 8px;
        font-size: 14px;
        font-weight: 600;
        color: var(--secondary);
      }

      input, select, textarea {
        width: 100%;
        padding: 14px 16px;
        border: 1.5px solid var(--border-color);
        border-radius: 12px;
        font-family: inherit;
        font-size: 15px;
        transition: all 0.3s;
        outline: none;
        background: var(--bg);
        color: var(--text-main);
      }

      input:focus, select:focus, textarea:focus {
        border-color: var(--primary);
        box-shadow: 0 0 0 4px var(--primary-light);
        background: var(--surface);
        transform: translateY(-2px);
      }

      /* === Buttons === */
      .btn {
        padding: 14px 24px;
        border: none;
        border-radius: 12px;
        cursor: pointer;
        font-weight: 700;
        font-size: 15px;
        transition: all 0.2s;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
        position: relative;
        overflow: hidden;
      }
      
      .btn:active { transform: scale(0.96); }

      .btn-primary {
        background: var(--primary);
        color: white;
        box-shadow: 0 4px 15px rgba(67, 56, 202, 0.2);
      }
      .btn-primary:hover { background: #3730a3; box-shadow: 0 6px 20px rgba(67, 56, 202, 0.3); }

      .btn-success { background: var(--success); color: white; }
      .btn-outline { background: transparent; border: 1.5px solid var(--border-color); color: var(--secondary); }
      .btn-outline:hover { border-color: var(--secondary); background: var(--bg); }

      .custom-file-upload {
        border: 1.5px dashed var(--border-color);
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
        padding: 12px;
        cursor: pointer;
        border-radius: 12px;
        background: var(--bg);
        color: var(--secondary);
        font-weight: 600;
        transition: 0.2s;
        width: 100%;
        height: 50px; /* Fixed height for alignment */
      }
      .custom-file-upload:hover { border-color: var(--primary); color: var(--primary); background: var(--primary-light); }

      /* === Tables === */
      .table-wrapper {
        overflow-x: auto;
        background: var(--surface);
        border-radius: var(--radius);
        border: 1px solid var(--border-color);
        box-shadow: var(--shadow);
      }
      table { width: 100%; border-collapse: collapse; min-width: 600px; }
      th { background: var(--bg); text-align: right; padding: 18px; color: var(--secondary); font-weight: 700; }
      td { padding: 18px; border-bottom: 1px solid var(--border-color); color: var(--text-main); }
      
      /* === Mobile Specific Styles === */
      .mobile-header, .mobile-bottom-nav, .overlay { display: none; }

      @media (max-width: 768px) {
        .sidebar {
          position: fixed;
          top: 0; right: -100%; width: 85%; max-width: 300px;
          box-shadow: -5px 0 25px rgba(0,0,0,0.1);
          transition: right 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        }
        .sidebar.active { right: 0; }
        
        .overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.4); backdrop-filter: blur(4px);
            z-index: 1000;
            display: none; opacity: 0; transition: opacity 0.3s;
        }
        .overlay.visible { display: block; opacity: 1; }

        .main-content {
            padding: 80px 15px 100px 15px !important; /* Ù…Ø³Ø§Ø­Ø© Ù„Ù„Ù‡ÙŠØ¯Ø± ÙˆØ§Ù„ÙÙˆØªØ± */
        }

        /* Mobile Header */
        .mobile-header {
            display: flex; justify-content: space-between; align-items: center;
            position: fixed; top: 0; left: 0; width: 100%; height: 65px;
            background: rgba(255,255,255,0.95); backdrop-filter: blur(10px);
            padding: 0 20px; z-index: 900;
            border-bottom: 1px solid var(--border-color);
            box-shadow: 0 2px 10px rgba(0,0,0,0.03);
        }
        body.dark-mode .mobile-header { background: rgba(30, 41, 59, 0.95); }

        /* Mobile Bottom Nav */
        .mobile-bottom-nav {
            display: flex; position: fixed; bottom: 0; left: 0; width: 100%;
            background: var(--surface); border-top: 1px solid var(--border-color);
            padding: 10px 0 25px 0; /* Extra padding for iPhone home indicator */
            z-index: 900; justify-content: space-around;
            box-shadow: 0 -4px 20px rgba(0,0,0,0.05);
        }
        .nav-icon {
            display: flex; flex-direction: column; align-items: center;
            font-size: 11px; color: var(--secondary); gap: 5px;
            transition: 0.3s; padding: 5px 10px; border-radius: 12px;
        }
        .nav-icon i { font-size: 22px; margin-bottom: 2px; transition: 0.3s; }
        .nav-icon.active { color: var(--primary); font-weight: bold; background: var(--primary-light); }
        .nav-icon.active i { transform: translateY(-2px); }

        /* Transform Tables to Cards on Mobile */
        .table-wrapper { background: transparent; border: none; box-shadow: none; overflow: visible; }
        table, thead, tbody, th, td, tr { display: block; }
        thead { display: none; }
        
        tr {
            background: var(--surface);
            border-radius: 16px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
            border: 1px solid var(--border-color);
            position: relative;
            animation: fadeInScale 0.4s ease-out;
        }
        
        td {
            padding: 8px 0;
            border-bottom: 1px dashed var(--border-color);
            display: flex; justify-content: space-between; align-items: center;
            font-size: 14px;
        }
        td:last-child { border-bottom: none; padding-top: 15px; justify-content: flex-end; gap: 8px; }
        
        /* Mobile Input & Form Adjustments */
        .form-grid { grid-template-columns: 1fr; gap: 15px; }
        input, select, textarea { height: 48px; font-size: 16px; /* Prevent zoom on iOS */ }
        .btn { height: 48px; width: 100%; margin-top: 5px; }
        
        /* Specific Fixes */
        .btn-preview { display: none; } /* Hide preview button on mobile header */
        .phone-frame { width: 100% !important; height: 500px !important; }
        #live-preview { border-radius: 20px; }
      }

      /* Utilities */
      .hidden { display: none !important; }
      .badge { padding: 4px 10px; border-radius: 20px; font-size: 12px; font-weight: 700; }
      .img-preview { width: 48px; height: 48px; border-radius: 10px; object-fit: cover; border: 1px solid var(--border-color); display:none; }
      /* === ØªØ­Ø³ÙŠÙ† Ø£Ø²Ø±Ø§Ø± Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ØªØ®Ø·ÙŠØ· === */
      .layout-options-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 12px;
        margin-top: 10px;
      }

      .btn-layout {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: 8px;
        padding: 15px 10px;
        background: var(--surface);
        border: 2px solid var(--border-color);
        border-radius: 16px;
        cursor: pointer;
        transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        color: var(--secondary);
        font-size: 13px;
        font-weight: 700;
        height: 100px; /* Ø§Ø±ØªÙØ§Ø¹ Ù…ÙˆØ­Ø¯ */
      }

      .btn-layout i {
        font-size: 28px;
        margin-bottom: 5px;
        color: var(--secondary);
        transition: 0.2s;
      }

      .btn-layout:hover {
        border-color: var(--primary);
        background: var(--bg);
        transform: translateY(-3px);
      }

      .btn-layout.active {
        border-color: var(--primary);
        background: var(--primary-light);
        color: var(--primary);
        box-shadow: 0 4px 12px rgba(67, 56, 202, 0.15);
      }

      .btn-layout.active i {
        color: var(--primary);
        transform: scale(1.1);
      }

      /* === ØªØ­Ø³ÙŠÙ† ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„ØªØµÙ…ÙŠÙ… Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© === */
      .design-container {
        display: flex;
        gap: 25px;
        height: calc(100vh - 100px);
        overflow: hidden;
      }
      
      .design-controls {
        flex: 1.2;
        overflow-y: auto;
        padding-right: 5px;
        display: flex;
        flex-direction: column;
        gap: 20px;
      }

      .design-preview-pane {
        flex: 0.8;
        min-width: 350px;
        display: flex;
        justify-content: center;
        align-items: flex-start;
        padding-top: 20px;
        background: var(--bg); 
        border-radius: 20px;
        position: relative;
      }

      .design-section {
        background: var(--surface);
        border: 1px solid var(--border-color);
        border-radius: 16px;
        padding: 20px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.03);
        transition: transform 0.2s;
      }
      .design-section:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.05); }

      .design-section-title {
        font-size: 16px;
        font-weight: 800;
        color: var(--primary);
        margin-bottom: 15px;
        display: flex;
        align-items: center;
        gap: 10px;
        border-bottom: 1px solid var(--border-color);
        padding-bottom: 10px;
      }

      /* Toggle Switch Design */
      .toggle-switch {
        position: relative;
        display: inline-block;
        width: 44px;
        height: 24px;
      }
      .toggle-switch input { opacity: 0; width: 0; height: 0; }
      .slider {
        position: absolute;
        cursor: pointer;
        top: 0; left: 0; right: 0; bottom: 0;
        background-color: #ccc;
        transition: .4s;
        border-radius: 34px;
      }
      .slider:before {
        position: absolute;
        content: "";
        height: 18px; width: 18px;
        left: 3px; bottom: 3px;
        background-color: white;
        transition: .4s;
        border-radius: 50%;
      }
      input:checked + .slider { background-color: var(--primary); }
      input:checked + .slider:before { transform: translateX(20px); }

      /* Color Input Wrapper */
      .color-wrapper {
        display: flex;
        align-items: center;
        gap: 10px;
        background: var(--bg);
        padding: 8px 12px;
        border-radius: 10px;
        border: 1px solid var(--border-color);
        cursor: pointer;
      }
      .color-preview-box {
        width: 30px; height: 30px;
        border-radius: 50%;
        border: 2px solid #fff;
        box-shadow: 0 0 5px rgba(0,0,0,0.1);
      }

      @media (max-width: 1000px) {
        .design-container { flex-direction: column; height: auto; overflow: visible; }
        .design-controls { overflow: visible; }
        .design-preview-pane { height: 600px; align-items: center; margin-top: 20px; }
      }

      /* === ØªØµÙ…ÙŠÙ… Ø§Ù„Ù‡Ø§ØªÙ (Phone Frame) === */
      .phone-frame {
        width: 320px;
        height: 650px;
        background: #000;
        border-radius: 45px;
        box-shadow: 
            0 0 0 9px #334155,   /* Ø¥Ø·Ø§Ø± Ø±Ù…Ø§Ø¯ÙŠ Ø®Ø§Ø±Ø¬ÙŠ */
            0 0 0 11px #000,     /* Ø®Ø· Ø£Ø³ÙˆØ¯ Ø±ÙÙŠØ¹ */
            0 25px 50px -12px rgba(0, 0, 0, 0.5); /* Ø¸Ù„ Ù„Ù„ÙƒØ§Ø±Øª */
        border: 6px solid #000;  /* Ø­ÙˆØ§Ù Ø§Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ø³ÙˆØ¯Ø§Ø¡ */
        overflow: hidden;
        position: relative;
        z-index: 10;
        transition: all 0.3s;
        transform-origin: top center;
      }

      /* Ø§Ù„Ù†ÙˆØªØ´ (Notch) Ø§Ù„Ø¹Ù„ÙˆÙŠ */
      .phone-frame::before {
        content: '';
        position: absolute;
        top: 0;
        left: 50%;
        transform: translateX(-50%);
        width: 120px;
        height: 25px;
        background: #000;
        border-bottom-left-radius: 14px;
        border-bottom-right-radius: 14px;
        z-index: 20;
      }

      /* Ø§Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠØ© */
      iframe#live-preview {
        width: 100%;
        height: 100%;
        border: none;
        background: white;
        border-radius: 38px;
        display: block;
      }

      /* ØªØµØºÙŠØ± Ø§Ù„Ù‡Ø§ØªÙ Ù‚Ù„ÙŠÙ„Ø§Ù‹ Ù„Ù„Ø´Ø§Ø´Ø§Øª Ø§Ù„Ù…ØªÙˆØ³Ø·Ø© */
      @media (max-width: 1300px) {
        .phone-frame {
            transform: scale(0.9);
            margin-top: 20px;
        }
      }

      /* === ØªØ­Ø³ÙŠÙ† Ø´ÙƒÙ„ Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ (Phone Mockup) === */
      .phone-mockup-wrapper {
        flex: 1;
        min-width: 350px;
        display: flex;
        justify-content: center;
        align-items: center;
        background: #1e293b; /* Ø®Ù„ÙÙŠØ© Ø¯Ø§ÙƒÙ†Ø© Ù„Ø¥Ø¨Ø±Ø§Ø² Ø§Ù„Ù‡Ø§ØªÙ */
        border-radius: 30px;
        padding: 40px 20px;
        box-shadow: inset 0 0 50px rgba(0,0,0,0.3);
        position: relative;
        overflow: hidden;
      }

      .phone-frame {
        width: 340px;          /* Ø¹Ø±Ø¶ Ø§ÙŠÙÙˆÙ† Ù‚ÙŠØ§Ø³ÙŠ */
        height: 700px;         /* Ø§Ø±ØªÙØ§Ø¹ Ø§ÙŠÙÙˆÙ† Ù‚ÙŠØ§Ø³ÙŠ */
        background: #000;
        border-radius: 50px;   /* Ø­ÙˆØ§Ù Ø¯Ø§Ø¦Ø±ÙŠØ© ÙƒØ¨ÙŠØ±Ø© */
        box-shadow: 
            0 0 0 12px #2d3748, /* Ø§Ù„Ø¥Ø·Ø§Ø± Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠ Ø§Ù„Ø±Ù…Ø§Ø¯ÙŠ */
            0 0 0 14px #000,    /* Ø®Ø· Ø£Ø³ÙˆØ¯ Ø±ÙÙŠØ¹ */
            0 25px 50px -12px rgba(0, 0, 0, 0.6); /* Ø¸Ù„ Ù‚ÙˆÙŠ */
        border: 8px solid #000; /* Ø§Ù„Ø­ÙˆØ§Ù Ø§Ù„Ø³ÙˆØ¯Ø§Ø¡ Ù„Ù„Ø´Ø§Ø´Ø© */
        overflow: hidden;
        position: relative;
        z-index: 10;
        transition: transform 0.3s;
      }

      /* Ø§Ù„Ù†ÙˆØªØ´ (Notch) Ø§Ù„Ø¹Ù„ÙˆÙŠ */
      .phone-frame::before {
        content: '';
        position: absolute;
        top: 0;
        left: 50%;
        transform: translateX(-50%);
        width: 150px;
        height: 30px;
        background: #000;
        border-bottom-left-radius: 16px;
        border-bottom-right-radius: 16px;
        z-index: 20;
      }

      iframe#live-preview {
        width: 100%;
        height: 100%;
        border: none;
        background: white;
        border-radius: 40px; /* ØªØ¯ÙˆÙŠØ± Ø²ÙˆØ§ÙŠØ§ Ø§Ù„Ù€ iframe */
        display: block;
      }

      /* ØªØµØºÙŠØ± Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ Ù„Ù„Ø´Ø§Ø´Ø§Øª Ø§Ù„Ù…ØªÙˆØ³Ø·Ø© */
      @media (max-width: 1200px) {
        .phone-frame {
            transform: scale(0.9);
        }
      }

      /* === POS System Styles === */
      .pos-layout {
        display: flex;
        gap: 20px;
        height: calc(100vh - 100px); /* Ø§Ø±ØªÙØ§Ø¹ Ù…Ù„Ø¡ Ø§Ù„Ø´Ø§Ø´Ø© Ù†Ø§Ù‚Øµ Ø§Ù„Ù‡ÙŠØ¯Ø± */
        overflow: hidden;
      }

      .pos-menu-area {
        flex: 2;
        overflow-y: auto;
        padding-right: 5px;
      }

      .pos-cart-area {
        flex: 1;
        min-width: 320px;
        background: var(--surface);
        border: 1px solid var(--border-color);
        border-radius: 16px;
        display: flex;
        flex-direction: column;
        box-shadow: 0 4px 15px rgba(0,0,0,0.05);
        height: 100%;
      }

      /* Category Cards in POS */
      .pos-cat-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
        gap: 15px;
      }

      .pos-cat-card {
        background: var(--surface);
        border: 1px solid var(--border-color);
        border-radius: 12px;
        padding: 20px;
        text-align: center;
        cursor: pointer;
        transition: 0.2s;
        box-shadow: 0 2px 5px rgba(0,0,0,0.03);
      }

      .pos-cat-card:hover {
        border-color: var(--primary);
        transform: translateY(-3px);
        background: var(--primary-light);
      }

      .pos-cat-card i {
        font-size: 30px;
        color: var(--primary);
        margin-bottom: 10px;
      }

      .pos-cat-card img {
        width: 50px;
        height: 50px;
        object-fit: cover;
        border-radius: 8px;
        margin-bottom: 10px;
      }

      /* Product Cards in POS */
      .pos-prod-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
        gap: 15px;
      }

      .pos-prod-card {
        background: var(--surface);
        border: 1px solid var(--border-color);
        border-radius: 12px;
        overflow: hidden;
        cursor: pointer;
        transition: 0.2s;
        position: relative;
      }

      .pos-prod-card:hover {
        border-color: var(--primary);
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      }

      .pos-prod-img {
        width: 100%;
        height: 100px;
        object-fit: cover;
        background: #f1f5f9;
      }

      .pos-prod-info {
        padding: 10px;
      }

      .pos-prod-price {
        color: var(--primary);
        font-weight: bold;
        font-size: 15px;
      }

      /* Cart Items */
      .pos-cart-items {
        flex: 1;
        overflow-y: auto;
        padding: 10px;
      }

      .pos-cart-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px;
        border-bottom: 1px dashed var(--border-color);
        background: var(--bg);
        border-radius: 8px;
        margin-bottom: 8px;
      }

      /* Mobile Adjustments */
      @media (max-width: 900px) {
        .pos-layout {
          flex-direction: column;
          height: auto;
          overflow: visible;
        }
        .pos-cart-area {
          min-width: 100%;
          height: auto;
          order: -1; /* Ø§Ù„Ø³Ù„Ø© ÙÙˆÙ‚ ÙÙŠ Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ Ø£Ùˆ ØªØ­Øª Ø­Ø³Ø¨ Ø±ØºØ¨ØªÙƒ */
          margin-bottom: 20px;
        }
      }
      /* ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø¹Ù†ØµØ± Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø³Ø­Ø¨ */
.sortable-ghost {
    opacity: 0.4;
    background: var(--primary-light) !important;
    border: 2px dashed var(--primary) !important;
}
.sortable-drag {
    cursor: grabbing;
    opacity: 1 !important;
    background: #fff;
    box-shadow: 0 10px 20px rgba(0,0,0,0.2);
    transform: scale(1.02);
}
    </style>
  </head>
  <body>
    <div class="mobile-header">
      <div style="display:flex; align-items:center; gap:15px;">
          <button class="mobile-menu-btn" onclick="toggleSidebar()">
            <i class="fas fa-bars"></i>
          </button>
          <div class="logo" style="margin: 0; font-size: 18px; display:flex; align-items:center; gap:5px;">
            <i class="fas fa-pizza-slice" style="color:var(--primary)"></i> Smart Menu
          </div>
      </div>
      <div style="display:flex; gap:15px; align-items:center;">
          <button onclick="toggleDarkMode()" style="background:none; border:none; font-size:18px; color:var(--text-main);">
            <i class="fas fa-adjust"></i>
          </button>
          <button onclick="logout()" style="background:none; border:none; font-size:18px; color:var(--danger);">
            <i class="fas fa-sign-out-alt"></i>
          </button>
      </div>
    </div>
    <div class="overlay" onclick="toggleSidebar()"></div>

    <div
      id="dashboard-section"
      class="hidden"
      style="display: flex; width: 100%"
    >
      <div class="sidebar" id="sidebar">
        <button class="btn-close-sidebar" style="display:none;" onclick="toggleSidebar()">
            <i class="fas fa-times"></i>
        </button>

        <div class="logo"><i class="fas fa-pizza-slice"></i> Smart Menu</div>

        <div
          class="nav-item active"
          onclick="switchView('categories')"
          id="nav-categories"
        >
          <i class="fas fa-layer-group"></i> Ø§Ù„Ø£Ù‚Ø³Ø§Ù…
        </div>
        <div
          class="nav-item"
          onclick="switchView('products')"
          id="nav-products"
        >
          <i class="fas fa-hamburger"></i> Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª
        </div>
        <div class="nav-item" onclick="switchView('bulk')" id="nav-bulk">
          <i class="fas fa-rocket"></i> Ø¥Ø¶Ø§ÙØ© Ø¬Ù…Ù„Ø©
        </div>
        
       <div class="nav-item" onclick="switchView('orders')" id="nav-orders">
          <i class="fas fa-bell"></i> Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø­ÙŠØ©
          <span
            id="live-badge"
            class="badge badge-cat hidden"
            style="background: var(--danger); color: white"
            >0</span
          >
        </div>
        
        <div class="nav-item" onclick="switchView('manual-pos')" id="nav-manual-pos">
          <i class="fas fa-cash-register"></i> Ø£ÙˆØ±Ø¯Ø± Ù…Ø¨Ø§Ø´Ø±
        </div>

        <div class="nav-item hidden" onclick="switchView('recipes')" id="nav-recipes">
          <i class="fas fa-blender"></i> Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù‚Ø§Ø¯ÙŠØ±
        </div>
        <div class="nav-item hidden" onclick="switchView('stock')" id="nav-stock">
          <i class="fas fa-boxes"></i> Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø®Ø²Ù†
          <span id="stock-badge-count" class="badge" style="background:var(--danger); color:white; display:none; margin-right:auto; font-size:10px;">0</span>
        </div>
        <div class="nav-item hidden" onclick="switchView('accounting')" id="nav-accounting">
          <i class="fas fa-calculator"></i> Ø§Ù„Ù…Ø­Ø§Ø³Ø¨ ÙˆØ§Ù„Ø±ÙˆØ§ØªØ¨
        </div>
        <div class="nav-item" onclick="switchView('history')" id="nav-history">
          <i class="fas fa-history"></i> Ø³Ø¬Ù„ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª
        </div>
        <div class="nav-item" onclick="switchView('design')" id="nav-design">
          <i class="fas fa-paint-brush"></i> Ø§Ù„ØªØµÙ…ÙŠÙ…
        </div>
        <div
          class="nav-item"
          onclick="switchView('settings')"
          id="nav-settings"
        >
          <i class="fas fa-cog"></i> Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…ØªØ¬Ø±
        </div>
        <div
          class="nav-item hidden"
          onclick="switchView('staff')"
          id="nav-staff"
        >
          <i class="fas fa-users-cog"></i> Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†
        </div>

        <div
          class="nav-item hidden"
          onclick="switchView('coupons')"
          id="nav-coupons"
        >
          <i class="fas fa-ticket-alt"></i> Ø§Ù„ÙƒÙˆØ¨ÙˆÙ†Ø§Øª
        </div>
        <div class="nav-item hidden" onclick="switchView('reservations')" id="nav-reservations">
          <i class="fas fa-calendar-check"></i> Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø­Ø¬Ø²
        </div>
        <div class="nav-item" onclick="toggleDarkMode()">
          <i class="fas fa-moon"></i> ÙˆØ¶Ø¹ Ù„ÙŠÙ„ÙŠ/Ù†Ù‡Ø§Ø±ÙŠ
        </div>

        <div style="margin-top: auto">
          <div class="nav-item" onclick="logout()" style="color: var(--danger)">
            <i class="fas fa-sign-out-alt"></i> Ø®Ø±ÙˆØ¬
          </div>
        </div>
      </div>

      <div class="main-content">
        <div class="header">
          <div class="page-title" id="page-title">Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
          <a href="#" id="preview-link" target="_blank" class="btn-preview">
            <i class="fas fa-external-link-alt"></i> Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ù…Ù†ÙŠÙˆ
          </a>
        </div>

        <div id="view-orders" class="hidden">
          <div
            style="
              display: flex;
              justify-content: space-between;
              align-items: center;
              margin-bottom: 20px;
            "
          >
            <h3 style="margin: 0; color: var(--primary)">Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„ÙˆØ§Ø±Ø¯Ø©</h3>
            <button
              id="btn-recent-orders"
              class="btn btn-primary"
              onclick="showRecentOrders()"
              style="margin-left: 10px"
            >
              <i class="fas fa-history"></i> ÙÙˆØ§ØªÙŠØ± Ø³Ø§Ø¨Ù‚Ø©
            </button>
            
            <button class="btn btn-outline" onclick="loadOrders()">
              <i class="fas fa-sync"></i> ØªØ­Ø¯ÙŠØ«
            </button>
          </div>
          <div style="margin-bottom: 20px; display: flex; gap: 10px">
            <input
              type="number"
              id="live-order-search"
              placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„ÙŠÙˆÙ…ÙŠ..."
              style="
                padding: 10px;
                border-radius: 8px;
                border: 1px solid var(--border-color);
                flex: 1;
              "
              onkeydown="if (event.key === 'Enter') searchOrderHistory();"
            />
            <button
              class="btn btn-primary"
              onclick="searchOrderHistory()"
              style="width: auto"
            >
              <i class="fas fa-search"></i> Ø¨Ø­Ø«
            </button>
          </div>
          <div
            id="orders-grid"
            style="
              display: grid;
              grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
              gap: 20px;
            "
          ></div>
          <audio
            id="order-sound"
            src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3"
          ></audio>
        </div>

        <div id="view-manual-pos" class="hidden">
            <div class="pos-layout">
                <div class="pos-menu-area">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <div id="pos-breadcrumbs" style="font-size: 18px; font-weight: bold; color: var(--text-main);">
                            <i class="fas fa-layer-group"></i> Ø§Ù„Ø£Ù‚Ø³Ø§Ù…
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <button id="btn-pos-back" class="btn btn-outline hidden" onclick="renderPosCategories()" style="height: 40px;">
                                <i class="fas fa-arrow-right"></i> Ø±Ø¬ÙˆØ¹
                            </button>
                            <div class="search-container" style="margin:0; width: 250px;">
                                <i class="fas fa-search search-icon"></i>
                                <input type="text" id="pos-search" class="search-input" placeholder="Ø¨Ø­Ø« Ø¹Ù† Ù…Ù†ØªØ¬..." onkeyup="searchPosProducts()" style="height: 40px;">
                            </div>
                        </div>
                    </div>

                    <div id="pos-categories-container" class="pos-cat-grid"></div>
                    <div id="pos-products-container" class="pos-prod-grid hidden"></div>
                </div>

                <div class="pos-cart-area">
                    <div style="padding: 15px; border-bottom: 1px solid var(--border-color); background: white;">
                        <h3 style="margin: 0; color: var(--primary); font-size: 16px; display: flex; align-items: center; justify-content: space-between;">
                            <span><i class="fas fa-shopping-basket"></i> ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ø·Ù„Ø¨</span>
                            <span class="badge" id="pos-cart-count" style="background: var(--primary); color: white;">0</span>
                        </h3>
                    </div>
                    
                    <div style="padding: 10px; background: white; border-bottom: 1px solid var(--border-color);">
    <input type="text" id="pos-table-num" placeholder="Ø±Ù‚Ù… Ø§Ù„Ø·Ø§ÙˆÙ„Ø© (Ø§ØªØ±ÙƒÙ‡ ÙØ§Ø±ØºØ§Ù‹ Ù„Ù„ØªÙŠÙƒ Ø£ÙˆØ§ÙŠ)" 
           style="background: var(--bg); border: 1px solid var(--border-color); height: 40px; margin-bottom: 10px;">
    
    <input type="number" id="pos-manual-order-num" placeholder="# Ø±Ù‚Ù… Ø§Ù„Ø£ÙˆØ±Ø¯Ø± (Ù„Ø¥Ø¶Ø§ÙØªÙ‡ Ø¹Ù„Ù‰ ÙØ§ØªÙˆØ±Ø© Ø³Ø§Ø¨Ù‚Ø©)" 
           style="background: var(--bg); border: 1px solid var(--border-color); height: 40px;">
</div>

                    <div id="pos-cart-items" class="pos-cart-items">
                        <div style="text-align: center; color: var(--secondary); margin-top: 50px;">
                            <i class="fas fa-cart-arrow-down fa-3x" style="opacity: 0.2; margin-bottom: 10px;"></i>
                            <p>Ø§Ù„Ø³Ù„Ø© ÙØ§Ø±ØºØ©</p>
                        </div>
                    </div>

                    <div style="padding: 20px; background: white; border-top: 1px solid var(--border-color);">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 5px; font-size: 14px;">
                            <span>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹:</span> <span id="pos-subtotal">0</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 14px; color: var(--secondary);">
                            <span>Ø§Ù„Ø¶Ø±ÙŠØ¨Ø© ÙˆØ§Ù„Ø®Ø¯Ù…Ø©:</span> <span id="pos-tax">0</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; font-size: 22px; font-weight: 800; color: var(--primary); border-top: 1px dashed var(--border-color); padding-top: 10px; margin-bottom: 15px;">
                            <span>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ:</span> <span id="pos-total">0</span>
                        </div>
                        
                        <button class="btn btn-success" onclick="submitPosOrder()" style="width: 100%; height: 55px; font-size: 18px; display: flex; justify-content: center; align-items: center; gap: 10px;">
                            <span>Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ø·Ù„Ø¨</span> <i class="fas fa-check-circle"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div id="view-history" class="hidden">
          <div
            style="
              display: flex;
              justify-content: space-between;
              align-items: center;
              margin-bottom: 20px;
              flex-wrap: wrap;
              gap: 10px;
            "
          >
            <h3 style="margin: 0; color: var(--primary)">
              <span id="history-title">Ø³Ø¬Ù„ Ø§Ù„Ø¬Ø±Ø¯</span>
            </h3>

            <div
              id="owner-filters"
              class="hidden"
              style="display: flex; gap: 10px; align-items: center"
            >
              <input
                type="date"
                id="filter-start"
                style="padding: 5px; height: 35px"
              />
              <span style="font-weight: bold">:</span>
              <input
                type="date"
                id="filter-end"
                style="padding: 5px; height: 35px"
              />
              <button
                class="btn btn-primary"
                style="height: 35px; padding: 0 15px"
                onclick="window.loadHistory()"
              >
                <i class="fas fa-filter"></i> Ø¹Ø±Ø¶
              </button>
              <input
                type="text"
                id="history-search"
                placeholder="Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨ / Ø§Ù„Ø·Ø§ÙˆÙ„Ø©"
                style="padding: 5px; height: 35px; width: 120px"
              />
            </div>

            <button class="btn btn-outline" onclick="window.loadHistory()">
              <i class="fas fa-sync"></i> ØªØ­Ø¯ÙŠØ«
            </button>
            <button class="btn btn-success" onclick="exportToExcel('sales-table', 'ØªÙ‚Ø±ÙŠØ±_Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª')">
  <i class="fas fa-file-excel"></i> ØªØµØ¯ÙŠØ± Excel
</button>
          </div>

          <div
            style="
              background: linear-gradient(45deg, var(--primary), #6366f1);
              color: white;
              padding: 20px;
              border-radius: 16px;
              margin-bottom: 25px;
              display: flex;
              justify-content: space-between;
              align-items: center;
              box-shadow: 0 4px 15px rgba(99, 102, 241, 0.3);
            "
          >
            <div>
              <div style="font-size: 14px; opacity: 0.9">
                Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª (ÙƒÙ„ Ø§Ù„Ø£ÙˆÙ‚Ø§Øª)
              </div>
              <div
                style="font-size: 32px; font-weight: 800"
                id="total-sales-display"
              >
                0 Ø¬.Ù…
              </div>
            </div>
            <i class="fas fa-wallet fa-3x" style="opacity: 0.2"></i>
          </div>

          <div class="table-wrapper">
  <table id="sales-table">
    <thead>
                <tr>
                  <th>Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨</th>
                  <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                  <th>Ø§Ù„Ø·Ø§ÙˆÙ„Ø©</th>
                  <th>Ø§Ù„Ø£ØµÙ†Ø§Ù</th>
                  <th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
                  <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                </tr>
              </thead>
              <tbody id="history-list"></tbody>
            </table>
          </div>
        </div>

        <div id="view-categories" class="hidden">
          
          <style>
            .stats-card-modern {
                background: var(--surface);
                border-radius: 20px;
                padding: 20px;
                display: flex;
                align-items: center;
                justify-content: space-between;
                box-shadow: 0 4px 20px rgba(0,0,0,0.03);
                border: 1px solid rgba(0,0,0,0.05);
                transition: 0.3s;
            }
            .stats-card-modern:hover { transform: translateY(-5px); box-shadow: 0 10px 25px rgba(0,0,0,0.08); }
            
            .cat-form-panel {
                background: var(--surface);
                border-radius: 24px;
                padding: 25px;
                box-shadow: 0 10px 30px -10px rgba(0,0,0,0.05);
                border: 1px solid rgba(0,0,0,0.05);
                margin-bottom: 30px;
            }

            .cat-grid-modern {
                display: grid;
                grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
                gap: 20px;
            }

            .cat-card-pro {
                background: var(--surface);
                border-radius: 18px;
                padding: 15px;
                display: flex;
                align-items: center;
                justify-content: space-between;
                border: 1px solid rgba(0,0,0,0.04);
                box-shadow: 0 4px 15px rgba(0,0,0,0.02);
                transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
                cursor: grab;
                position: relative;
                overflow: hidden;
            }
            .cat-card-pro:hover {
                transform: translateY(-3px) scale(1.02);
                box-shadow: 0 10px 30px rgba(0,0,0,0.08);
                border-color: var(--primary-light);
            }
            .cat-card-pro.active-edit {
                border: 2px solid var(--primary);
                background: linear-gradient(to right, var(--surface), var(--bg));
            }
            
            .cat-img-box {
                width: 55px; height: 55px;
                border-radius: 14px;
                object-fit: cover;
                background: #f1f5f9;
                box-shadow: inset 0 0 10px rgba(0,0,0,0.05);
            }
            
            /* Modern Tabs */
            .cat-tabs { display: flex; gap: 15px; margin-bottom: 20px; border-bottom: 1px solid var(--border-color); padding-bottom: 10px; }
            .cat-tab-btn {
                padding: 10px 20px;
                border-radius: 12px;
                cursor: pointer;
                font-weight: bold;
                font-size: 14px;
                transition: 0.3s;
                color: var(--secondary);
                background: transparent;
            }
            .cat-tab-btn.active {
                background: var(--primary-light);
                color: var(--primary);
            }
          </style>

          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px;">
              <div class="stats-card-modern">
                  <div>
                      <div style="font-size: 13px; color: var(--secondary); font-weight:bold;">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</div>
                      <div style="font-size: 28px; font-weight: 800; color: var(--primary);" id="stat-total-cats">0</div>
                  </div>
                  <div style="width:50px; height:50px; background:var(--primary-light); border-radius:15px; display:flex; align-items:center; justify-content:center; color:var(--primary);">
                      <i class="fas fa-layer-group fa-lg"></i>
                  </div>
              </div>
              <div class="stats-card-modern">
                  <div>
                      <div style="font-size: 13px; color: var(--secondary); font-weight:bold;">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</div>
                      <div style="font-size: 28px; font-weight: 800; color: var(--success);" id="stat-total-prods">0</div>
                  </div>
                  <div style="width:50px; height:50px; background:#dcfce7; border-radius:15px; display:flex; align-items:center; justify-content:center; color:var(--success);">
                      <i class="fas fa-hamburger fa-lg"></i>
                  </div>
              </div>
          </div>

          <div class="cat-form-panel" id="card-cat-form">
            <div class="cat-tabs">
                <div onclick="toggleCatTab('single')" id="tab-cat-single" class="cat-tab-btn active">
                    <i class="fas fa-plus-circle"></i> Ø¥Ø¶Ø§ÙØ© Ù‚Ø³Ù…
                </div>
                <div onclick="toggleCatTab('bulk')" id="tab-cat-bulk" class="cat-tab-btn">
                    <i class="fas fa-list-ul"></i> Ø¥Ø¶Ø§ÙØ© Ø¬Ù…Ù„Ø© (Ø³Ø±ÙŠØ¹)
                </div>
            </div>

            <div id="cat-form-single">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h3 style="margin: 0; font-size: 16px; color: var(--text-main);" id="cat-form-title">Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‚Ø³Ù…</h3>
                    <button id="btn-cancel-cat" class="btn hidden" onclick="resetCategoryForm()" style="font-size: 12px; padding: 5px 15px; background: #f1f5f9; color: var(--secondary); border-radius: 8px;">Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„</button>
                </div>

                <div style="display: flex; gap: 20px; align-items: flex-end; flex-wrap: wrap;">
                  <input type="hidden" id="edit-cat-id" />
                  <input type="hidden" id="c-old-name" /> 
                  
                  <div style="flex: 2; min-width: 250px;">
                    <label class="form-label">Ø§Ø³Ù… Ø§Ù„Ù‚Ø³Ù…</label>
                    <input type="text" id="c-name" class="modern-input" placeholder="Ù…Ø«Ø§Ù„: Ù…Ø´ÙˆÙŠØ§ØªØŒ Ù…Ø´Ø±ÙˆØ¨Ø§Øª..." style="padding: 12px 15px; border-radius: 12px; border: 1px solid var(--border-color);" />
                  </div>
                  
                  <div style="flex: 1; min-width: 200px;">
                    <label class="form-label">ØµÙˆØ±Ø© Ø§Ù„ØºÙ„Ø§Ù (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
                    <div style="display: flex; align-items: center; gap: 10px;">
                      <img id="c-preview" class="img-preview" style="width: 45px; height: 45px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);" />
                      <label for="c-image" class="custom-file-upload" style="margin:0; flex:1; height:45px; border-radius:12px; font-size:13px;">
                        <i class="fas fa-camera"></i> Ø§Ø®ØªØ± ØµÙˆØ±Ø©
                      </label>
                      <input type="file" id="c-image" accept="image/*" onchange="previewImage(this, 'c-preview')" />
                    </div>
                  </div>
                  
                  <button id="btn-save-cat" class="btn btn-primary" style="height: 45px; padding: 0 30px; border-radius: 12px; font-weight: bold; box-shadow: 0 4px 15px rgba(67, 56, 202, 0.2);" onclick="saveCategory()">
                    <i class="fas fa-check"></i> Ø­ÙØ¸
                  </button>
                </div>
            </div>

            <div id="cat-form-bulk" class="hidden">
                <div style="background: #f0f9ff; padding: 15px; border-radius: 12px; border: 1px dashed #0284c7; margin-bottom: 15px; font-size: 14px; color: #0369a1;">
                    <i class="fas fa-info-circle"></i> Ø§ÙƒØªØ¨ ÙƒÙ„ Ø§Ø³Ù… ÙÙŠ Ø³Ø·Ø± Ù…Ù†ÙØµÙ„ØŒ ÙˆØ³ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¤Ù‡Ù… Ø¯ÙØ¹Ø© ÙˆØ§Ø­Ø¯Ø©.
                </div>
                <textarea id="bulk-cat-names" rows="5" class="modern-input" placeholder="Ù…Ø´ÙˆÙŠØ§Øª&#10;Ù…Ù‚Ø¨Ù„Ø§Øª&#10;Ù…Ø´Ø±ÙˆØ¨Ø§Øª" style="border-radius: 12px;"></textarea>
                <button class="btn btn-success" style="width: 100%; margin-top: 15px; padding: 12px; border-radius: 12px;" onclick="saveCategoryBulk()">
                    <i class="fas fa-rocket"></i> ØªÙ†ÙÙŠØ° Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¬Ù…Ø§Ø¹ÙŠØ©
                </button>
            </div>
          </div>

          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
              <div style="position: relative; width: 300px;">
                  <input type="text" id="searchCatInput" onkeyup="searchCategory()" placeholder="Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…..." 
                         style="width: 100%; padding: 10px 35px 10px 15px; border-radius: 12px; border: 1px solid var(--border-color); background: var(--bg);">
                  <i class="fas fa-search" style="position: absolute; right: 12px; top: 13px; color: var(--secondary);"></i>
              </div>
              <small style="color: var(--secondary);"><i class="fas fa-hand-pointer"></i> ÙŠÙ…ÙƒÙ†Ùƒ Ø³Ø­Ø¨ Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ù„ØªØ±ØªÙŠØ¨Ù‡Ø§</small>
          </div>

          <div id="categories-grid" class="cat-grid-modern"></div>
        </div>

        <div id="view-products" class="hidden">
            <style>
                /* --- Luxury & Practical Product Styles --- */
                .prod-layout-pro {
                    display: flex;
                    gap: 25px;
                    height: calc(100vh - 120px);
                    overflow: hidden;
                    font-family: 'Tajawal', sans-serif;
                }

                /* Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© */
                .prod-list-container {
                    flex: 1.3;
                    display: flex;
                    flex-direction: column;
                    padding-right: 5px;
                }

                .prod-list-scroll {
                    flex: 1;
                    overflow-y: auto;
                    padding: 5px;
                    padding-bottom: 80px;
                }

                /* ÙƒØ§Ø±Øª Ø§Ù„Ù…Ù†ØªØ¬ Ø§Ù„ÙØ®Ù… */
                .prod-card-item {
                    background: var(--surface);
                    border-radius: 20px;
                    padding: 15px;
                    margin-bottom: 15px;
                    display: flex;
                    align-items: center;
                    justify-content: space-between;
                    border: 1px solid rgba(0,0,0,0.04);
                    box-shadow: 0 4px 20px rgba(0,0,0,0.03);
                    transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
                    cursor: pointer;
                    position: relative;
                    overflow: hidden;
                }

                .prod-card-item:hover {
                    transform: translateY(-3px) scale(1.01);
                    box-shadow: 0 10px 30px rgba(0,0,0,0.08);
                    border-color: var(--primary-light);
                }

                .prod-card-item.active-edit {
                    border: 2px solid var(--primary);
                    background: linear-gradient(to right, var(--surface), var(--bg));
                }

                .prod-img-thumb {
                    width: 65px;
                    height: 65px;
                    border-radius: 16px;
                    object-fit: cover;
                    box-shadow: 0 4px 10px rgba(0,0,0,0.1);
                    margin-left: 15px;
                }

                /* Ù„ÙˆØ­Ø© Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ÙØ®Ù…Ø© */
                .prod-editor-panel {
                    flex: 1;
                    background: var(--surface);
                    border-radius: 24px;
                    box-shadow: -10px 0 40px rgba(0,0,0,0.05);
                    border: 1px solid rgba(0,0,0,0.05);
                    display: flex;
                    flex-direction: column;
                    overflow: hidden;
                }

                .editor-header {
                    padding: 25px;
                    background: rgba(255,255,255,0.8);
                    backdrop-filter: blur(10px);
                    border-bottom: 1px solid rgba(0,0,0,0.05);
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                }

                .editor-body {
                    padding: 25px;
                    overflow-y: auto;
                    flex: 1;
                }

                /* Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¹ØµØ±ÙŠØ© */
                .input-group-modern { margin-bottom: 20px; }
                .input-group-modern label {
                    font-size: 13px;
                    color: var(--secondary);
                    font-weight: 700;
                    margin-bottom: 8px;
                    display: block;
                    letter-spacing: 0.5px;
                }
                
                .modern-input {
                    width: 100%;
                    padding: 16px 20px;
                    border-radius: 16px;
                    border: 2px solid transparent;
                    background: var(--bg);
                    font-family: inherit;
                    font-size: 15px;
                    font-weight: 600;
                    color: var(--text-main);
                    transition: 0.3s;
                    box-shadow: inset 0 2px 4px rgba(0,0,0,0.02);
                }
                .modern-input:focus {
                    background: var(--surface);
                    border-color: var(--primary);
                    box-shadow: 0 8px 20px rgba(0,0,0,0.05);
                    outline: none;
                }

                /* Ø²Ø± Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø© */
                .upload-box-modern {
                    border: 2px dashed #cbd5e1;
                    border-radius: 20px;
                    padding: 30px;
                    text-align: center;
                    cursor: pointer;
                    transition: 0.3s;
                    background: #f8fafc;
                }
                .upload-box-modern:hover {
                    border-color: var(--primary);
                    background: var(--primary-light);
                    transform: scale(0.99);
                }

                /* Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„ØµØºÙŠØ±Ø© ÙÙŠ Ø§Ù„ÙƒØ§Ø±Øª */
                .action-btn-mini {
                    width: 35px; height: 35px;
                    border-radius: 12px;
                    border: none;
                    display: flex; align-items: center; justify-content: center;
                    font-size: 14px;
                    transition: 0.2s;
                    cursor: pointer;
                    background: var(--bg);
                    color: var(--secondary);
                }
                .action-btn-mini:hover {
                    background: var(--primary);
                    color: white;
                    transform: rotate(5deg);
                }
                .action-btn-mini.danger:hover { background: var(--danger); }

                /* Ù…ÙØªØ§Ø­ Ø§Ù„ØªÙˆÙØ± Switch */
                .switch-status {
                    position: relative;
                    display: inline-block;
                    width: 40px;
                    height: 22px;
                }
                .switch-status input { opacity: 0; width: 0; height: 0; }
                .slider-status {
                    position: absolute; cursor: pointer;
                    top: 0; left: 0; right: 0; bottom: 0;
                    background-color: #cbd5e1;
                    transition: .4s;
                    border-radius: 34px;
                }
                .slider-status:before {
                    position: absolute; content: "";
                    height: 16px; width: 16px;
                    left: 3px; bottom: 3px;
                    background-color: white;
                    transition: .4s;
                    border-radius: 50%;
                    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
                }
                input:checked + .slider-status { background-color: var(--success); }
                input:checked + .slider-status:before { transform: translateX(18px); }

                @media (max-width: 1000px) {
                    .prod-layout-pro { flex-direction: column-reverse; height: auto; overflow: visible; }
                    .prod-list-container, .prod-editor-panel { width: 100%; height: auto; overflow: visible; }
                    .prod-list-scroll { height: auto; max-height: 600px; }
                }
          /* --- ØªØµÙ…ÙŠÙ… Ù†Ø¸Ø§Ù… Ø§Ù„Ø¬Ù…Ù„Ø© Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠ (Bulk System) - Ù†Ø³Ø®Ø© Ù…Ø±ÙŠØ­Ø© Ù…Ø¹ ØªØ¨ÙˆÙŠØ¨Ø§Øª --- */
.bulk-toolbar {
  display: flex; gap: 15px; margin-bottom: 25px; background: var(--surface);
  padding: 20px; border-radius: 16px; box-shadow: var(--shadow);
  align-items: center; flex-wrap: wrap; border: 1px solid var(--border-color);
}
.bulk-row-pro {
  display: flex; background: var(--surface); border-radius: 16px;
  border: 1px solid var(--border-color); margin-bottom: 20px;
  padding: 20px; gap: 20px; align-items: flex-start;
  transition: all 0.2s; position: relative; box-shadow: 0 4px 10px rgba(0,0,0,0.02);
}
.bulk-row-pro:hover { border-color: var(--primary); box-shadow: 0 8px 25px rgba(0,0,0,0.06); }

/* Ø§Ù„Ù…Ù†Ø·Ù‚Ø© Ø§Ù„ÙŠØ³Ø±Ù‰ (Ø§Ù„ØµÙˆØ±) */
.bulk-img-upload {
  width: 90px; height: 90px; flex-shrink: 0;
  border: 2px dashed var(--border-color); border-radius: 14px;
  display: flex; flex-direction: column; align-items: center; justify-content: center;
  cursor: pointer; background: var(--bg); overflow: hidden; position: relative; transition: 0.2s;
}
.bulk-img-upload:hover { border-color: var(--primary); background: var(--primary-light); }
.bulk-img-preview { width: 100%; height: 100%; object-fit: cover; display: none; }

/* Ø§Ù„Ø´Ø¨ÙƒØ© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© */
.bulk-inputs-grid {
    flex: 1; display: grid;
    grid-template-columns: 1.2fr 1.5fr 1.3fr; /* ØªÙ‚Ø³ÙŠÙ… Ø§Ù„Ù…Ø³Ø§Ø­Ø©: Ø§Ù„Ø§Ø³Ù… - Ø§Ù„ÙˆØµÙ - Ø§Ù„Ø³Ø¹Ø± */
    gap: 15px;
}
.bulk-input-styled {
    width: 100%; padding: 10px 12px; border-radius: 8px;
    border: 1px solid #cbd5e1; height: 42px; font-size: 13px; background: var(--bg);
}
.bulk-input-styled:focus { border-color: var(--primary); background: #fff; }
.bulk-label-sm { font-size: 11px; font-weight: 700; color: var(--secondary); margin-bottom: 5px; display: block; }

/* --- ØªØµÙ…ÙŠÙ… ØªØ¨ÙˆÙŠØ¨Ø§Øª Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯ --- */
.price-box {
    background: #f8fafc; padding: 8px; border-radius: 12px; 
    border: 1px solid #e2e8f0; height: 100%; display: flex; flex-direction: column;
}
.price-tabs {
    display: flex; background: #e2e8f0; border-radius: 8px; padding: 3px; margin-bottom: 12px;
}
.p-tab {
    flex: 1; text-align: center; padding: 6px; font-size: 12px; font-weight: 700;
    border-radius: 6px; cursor: pointer; color: #64748b; transition: all 0.2s; user-select: none;
}
.p-tab.active {
    background: white; color: var(--primary); box-shadow: 0 2px 4px rgba(0,0,0,0.05);
}
.p-content { flex: 1; display: flex; flex-direction: column; justify-content: center; }

/* Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ­ÙƒÙ… */
.bulk-actions { display: flex; flex-direction: column; gap: 8px; justify-content: center; height: 100%; padding-top: 10px; }
.action-icon-btn { width: 35px; height: 35px; border-radius: 8px; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: 0.2s; font-size: 14px; }
.btn-dup { background: #eff6ff; color: var(--primary); }
.btn-del { background: #fef2f2; color: var(--danger); }

@media (max-width: 992px) {
  .bulk-inputs-grid { grid-template-columns: 1fr 1fr; } /* Ø¹Ù…ÙˆØ¯ÙŠÙ† ÙÙŠ Ø§Ù„ØªØ§Ø¨Ù„Øª */
  .price-box { grid-column: span 2; }
}
@media (max-width: 600px) {
  .bulk-row-pro { flex-direction: column; }
  .bulk-inputs-grid { grid-template-columns: 1fr; display: flex; flex-direction: column; }
  .price-box { grid-column: span 1; }
  .bulk-actions { flex-direction: row; width: 100%; justify-content: flex-end; }
}

            </style>

            <div class="prod-layout-pro">
                
                <div class="prod-list-container">
                    <div style="margin-bottom: 15px; position: relative;">
                        <input type="text" id="searchInput" onkeyup="searchTable()" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ù…Ù†ØªØ¬..." 
                               style="width: 100%; padding: 14px 45px 14px 20px; border-radius: 14px; border: none; box-shadow: 0 4px 15px rgba(0,0,0,0.05); font-weight: bold;">
                        <i class="fas fa-search" style="position: absolute; right: 15px; top: 16px; color: var(--secondary); font-size: 18px;"></i>
                    </div>

                    <div id="products-list-container" class="prod-list-scroll">
                        </div>
                </div>

                <div class="prod-editor-panel" id="card-prod-form">
                    <div class="editor-header">
                        <div style="display:flex; align-items:center; gap:10px;">
                            <div style="width:40px; height:40px; background:var(--primary-light); border-radius:12px; display:flex; align-items:center; justify-content:center; color:var(--primary);">
                                <i class="fas fa-edit"></i>
                            </div>
                            <div>
                                <h3 style="margin:0; font-size:16px; font-weight:800; color:var(--text-main);" id="form-mode-title">Ù…Ù†ØªØ¬ Ø¬Ø¯ÙŠØ¯</h3>
                                <p style="margin:0; font-size:11px; color:var(--secondary);">Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø«Ù… Ø§Ø¶ØºØ· Ø­ÙØ¸</p>
                            </div>
                        </div>
                        <button id="btn-cancel" class="btn hidden" onclick="resetProductForm()" style="background:#f1f5f9; color:var(--text-main); font-size:12px; padding:8px 15px; border-radius:10px;">
                            Ø¥Ù„ØºØ§Ø¡ / Ø¬Ø¯ÙŠØ¯
                        </button>
                    </div>

                    <div class="editor-body">
                        <div class="input-group-modern">
                            <label>Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬</label>
                            <input type="text" id="p-name" class="modern-input" placeholder="Ø§Ø³Ù… Ø§Ù„ÙˆØ¬Ø¨Ø© (Ù…Ø«Ø§Ù„: Ø¨Ø±Ø¬Ø± Ø¯Ø¬Ø§Ø¬)">
                        </div>

                        <div style="display: flex; gap: 15px;">
                            <div class="input-group-modern" style="flex: 1;">
                                <label>Ø§Ù„Ù‚Ø³Ù…</label>
                                <select id="p-cat" class="modern-input" style="cursor:pointer;"></select>
                            </div>
                            <div class="input-group-modern" style="flex: 1;">
                                <label>Ø§Ù„Ø³Ø¹Ø± (Ø¬.Ù…)</label>
                                <input type="number" id="p-price" class="modern-input" placeholder="0" style="font-weight:800; color:var(--success);">
                            </div>
                        </div>

                        <div style="background:var(--bg); padding:15px; border-radius:16px; margin-bottom:20px;">
                            <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                                <label class="form-label" style="margin:0; font-size:12px;">Ø®ÙŠØ§Ø±Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©</label>
                                <div style="display:flex; gap:15px;">
                                    <label style="cursor:pointer; font-size:12px;"><input type="radio" name="pricingMode" value="single" checked onchange="togglePricingMode()"> Ø³Ø¹Ø± ÙˆØ§Ø­Ø¯</label>
                                    <label style="cursor:pointer; font-size:12px;"><input type="radio" name="pricingMode" value="multi" onchange="togglePricingMode()"> Ø£Ø­Ø¬Ø§Ù…</label>
                                </div>
                            </div>
                            
                            <div id="mode-single">
                                <input type="number" id="p-old-price" class="modern-input" placeholder="Ø³Ø¹Ø± Ù‚Ø¨Ù„ Ø§Ù„Ø®ØµÙ… (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)" style="background:white; border:1px dashed #cbd5e1; font-size:13px;">
                            </div>

                            <div id="mode-multi" class="hidden">
                                <div id="sizes-list"></div>
                                <button onclick="addSizeRow()" style="width:100%; padding:12px; border:1px dashed var(--primary); background:rgba(255,255,255,0.5); color:var(--primary); border-radius:12px; font-weight:bold; cursor:pointer; font-size:13px; margin-top:5px;">
                                    <i class="fas fa-plus"></i> Ø¥Ø¶Ø§ÙØ© Ø­Ø¬Ù… Ø¬Ø¯ÙŠØ¯
                                </button>
                            </div>
                        </div>

                        <div class="input-group-modern">
                             <label>Ø§Ù„ØµÙˆØ±Ø©</label>
                             <div class="upload-box-modern" onclick="document.getElementById('p-image').click()">
                                 <div style="display:flex; align-items:center; justify-content:center; gap:20px;">
                                     <img id="p-preview" class="img-preview" style="width:80px; height:80px; border-radius:16px; object-fit:cover; display:none; box-shadow:0 5px 15px rgba(0,0,0,0.1);">
                                     <div style="text-align:right;">
                                         <div style="font-weight:800; font-size:15px; color:var(--primary);"><i class="fas fa-cloud-upload-alt"></i> Ø§Ø®ØªØ± ØµÙˆØ±Ø©</div>
                                         <div style="font-size:12px; color:var(--secondary); margin-top:5px;">ÙŠÙØ¶Ù„ ØµÙˆØ±Ø© Ù…Ø±Ø¨Ø¹Ø© Ø¹Ø§Ù„ÙŠØ© Ø§Ù„Ø¬ÙˆØ¯Ø©</div>
                                     </div>
                                 </div>
                                 <input type="file" id="p-image" class="hidden" accept="image/*" onchange="previewImage(this, 'p-preview')">
                             </div>
                        </div>

                        <div class="input-group-modern">
                            <label>Ø§Ù„ÙˆØµÙ ÙˆØ§Ù„Ù…ÙƒÙˆÙ†Ø§Øª</label>
                            <textarea id="p-desc" rows="3" class="modern-input" placeholder="ÙˆØµÙ Ø§Ù„Ø·Ø¨Ù‚ Ù„ÙŠØ¸Ù‡Ø± Ù„Ù„Ø¹Ù…ÙŠÙ„..."></textarea>
                        </div>
                        
                        <div id="ingredients-section" class="hidden" style="margin-top: 15px; background: #ecfdf5; padding: 15px; border-radius: 16px; border: 1px dashed #10b981;">
                            <label style="color:#047857; font-weight:bold; font-size:13px; display:block; margin-bottom:10px;">
                                <i class="fas fa-boxes"></i> Ø±Ø¨Ø· Ø¨Ø§Ù„Ù…Ø®Ø²Ù† (Ù„Ø®ØµÙ… Ø§Ù„ÙƒÙ…ÙŠØ§Øª ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹)
                            </label>
                            <div id="prod-ingredients-list" style="margin-bottom:10px;"></div>
                            <div style="display:flex; gap:8px;">
                                <select id="stock-select" style="flex:2; border-radius:10px; border:1px solid #a7f3d0; padding:8px;"></select>
                                <input type="number" id="stock-qty" placeholder="Ø§Ù„ÙƒÙ…ÙŠØ©" style="flex:1; border-radius:10px; border:1px solid #a7f3d0; padding:8px;">
                                <button onclick="addIngredientRow()" style="background:#10b981; color:white; border:none; border-radius:10px; width:40px; cursor:pointer;"><i class="fas fa-plus"></i></button>
                            </div>
                        </div>
                    </div>

                    <div style="padding: 20px; background: var(--surface); border-top: 1px solid rgba(0,0,0,0.05); display:flex; gap:10px;">
                        <button id="btn-add-prod" class="btn btn-primary" onclick="saveProduct('POST')" style="flex:1; padding:16px; border-radius:16px; font-size:16px; box-shadow: 0 8px 20px rgba(67, 56, 202, 0.25);">
                            <i class="fas fa-check-circle"></i> Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ù…Ù†ÙŠÙˆ
                        </button>
                        <button id="btn-update-prod" class="btn hidden" onclick="saveProduct('PATCH')" style="flex:1; padding:16px; border-radius:16px; font-size:16px; background:var(--text-main); color:white; box-shadow: 0 8px 20px rgba(0,0,0,0.2);">
                            <i class="fas fa-save"></i> Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div id="view-recipes" class="hidden">
            <div style="display:flex; gap:20px; flex-wrap:wrap; height:calc(100vh - 150px);">
                
                <div class="card" style="flex:1; min-width:300px; display:flex; flex-direction:column; padding:15px; height:100%;">
                    <h3 style="margin-top:0; color:var(--primary); border-bottom:1px solid var(--border-color); padding-bottom:10px;">
                        <i class="fas fa-hamburger"></i> Ø§Ø®ØªØ± Ø§Ù„Ù…Ù†ØªØ¬
                    </h3>
                    <input type="text" id="recipe-search" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ù…Ù†ØªØ¬..." 
                           style="margin-bottom:10px; padding:10px; border-radius:8px; border:1px solid var(--border-color); width:100%;"
                           onkeyup="filterRecipeProducts()">
                    
                    <div id="recipe-products-list" style="overflow-y:auto; flex:1; display:flex; flex-direction:column; gap:8px;">
                        </div>
                </div>

                <div class="card" style="flex:2; min-width:300px; display:flex; flex-direction:column; padding:20px; height:100%;">
                    <div id="recipe-editor-empty" style="text-align:center; margin:auto; color:var(--secondary);">
                        <i class="fas fa-arrow-right fa-3x" style="opacity:0.3; margin-bottom:20px;"></i>
                        <h3>Ø§Ø®ØªØ± Ù…Ù†ØªØ¬Ø§Ù‹ Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ù„Ø¨Ø¯Ø¡ Ø±Ø¨Ø· Ø§Ù„Ù…ÙƒÙˆÙ†Ø§Øª</h3>
                    </div>

                    <div id="recipe-editor-content" class="hidden" style="height:100%; display:flex; flex-direction:column;">
                        <h3 style="margin-top:0; color:var(--primary); display:flex; justify-content:space-between; align-items:center;">
                            <span><i class="fas fa-edit"></i> Ù…Ù‚Ø§Ø¯ÙŠØ±: <span id="recipe-active-name" style="color:var(--text-main)">--</span></span>
                            <div style="font-size:13px; font-weight:bold; color:var(--primary); background:var(--primary-light); padding:5px 12px; border-radius:20px;" id="recipe-cost-display">
                                Ø§Ù„ØªÙƒÙ„ÙØ©: 0.00 Ø¬.Ù…
                            </div>
                            <button class="btn btn-success" onclick="saveActiveRecipe()" style="width:auto; padding:5px 20px;">
                                <i class="fas fa-save"></i> Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª
                            </button>
                        </h3>

                        <div style="background:var(--bg); padding:15px; border-radius:12px; border:1px solid var(--border-color); margin-bottom:15px;">
                            <label class="form-label" style="margin-bottom:5px;">Ø¥Ø¶Ø§ÙØ© Ù…ÙƒÙˆÙ† Ù…Ù† Ø§Ù„Ù…Ø®Ø²Ù†</label>
                            <div style="display:flex; gap:10px;">
                                <select id="recipe-stock-select" style="flex:2"></select>
                                <input type="number" id="recipe-stock-qty" placeholder="Ø§Ù„ÙƒÙ…ÙŠØ©" style="flex:1">
                                <button class="btn btn-primary" onclick="addIngredientToActive()" style="width:auto;">
                                    <i class="fas fa-plus"></i>
                                </button>
                            </div>
                            <small id="recipe-unit-hint" style="color:var(--secondary); font-size:12px; margin-top:5px; display:block;"></small>
                        </div>

                        <div class="table-wrapper" style="flex:1; overflow-y:auto;">
                            <table style="width:100%;">
                                <thead>
                                    <tr>
                                        <th>Ø§Ù„Ø®Ø§Ù…Ø©</th>
                                        <th>Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ø³ØªÙ‡Ù„ÙƒØ©</th>
                                        <th>Ø§Ù„ÙˆØ­Ø¯Ø©</th>
                                        <th>Ø­Ø°Ù</th>
                                    </tr>
                                </thead>
                                <tbody id="recipe-active-list"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="view-bulk" class="hidden">
          
          <div class="bulk-toolbar">
            <div style="flex: 1;">
                <h3 style="margin:0; color:var(--primary); font-size:18px;">
                    <i class="fas fa-boxes"></i> Ù…Ø­Ø±Ø± Ø§Ù„Ø¬Ù…Ù„Ø© Ø§Ù„Ø°ÙƒÙŠ
                </h3>
                <p style="margin:5px 0 0; font-size:12px; color:var(--secondary);">
                    Ø£Ø¶ÙØŒ Ø¹Ø¯Ù„ØŒ ÙˆÙƒØ±Ø± Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø¨Ø³Ø±Ø¹Ø©.
                </p>
            </div>
            
            <div style="position:relative; width: 200px;">
                <input type="text" id="bulk-search-filter" placeholder="Ø¨Ø­Ø« ÙÙŠ Ø§Ù„ØµÙÙˆÙ..." onkeyup="filterBulkRows()" 
                       style="padding: 8px 30px 8px 10px; border-radius: 8px; font-size: 13px; height: 38px;">
                <i class="fas fa-search" style="position: absolute; right: 10px; top: 11px; color: var(--secondary); font-size: 12px;"></i>
            </div>

            <div style="display:flex; gap:8px;">
                <button class="btn btn-outline" onclick="addBulkRows(1)" style="font-size:13px; padding: 8px 15px;">
                    <i class="fas fa-plus"></i> ØµÙ
                </button>
                <button class="btn btn-outline" onclick="addBulkRows(5)" style="background:#f0f9ff; border-color:var(--primary); color:var(--primary); font-size:13px; padding: 8px 15px;">
                    <i class="fas fa-layer-group"></i> +5
                </button>
                <button class="btn btn-success" onclick="submitBulkAll()" style="font-size:13px; padding: 8px 20px; box-shadow: 0 4px 12px rgba(16, 185, 129, 0.2);">
                    <i class="fas fa-save"></i> Ø­ÙØ¸ Ø§Ù„ÙƒÙ„
                </button>
            </div>
          </div>

          <div id="bulk-container" style="padding-bottom: 80px; min-height: 300px;"></div>

        </div>
        <div id="view-staff" class="hidden">
          <div class="card">
            <h3 style="color: var(--primary); margin-top: 0">
              <i class="fas fa-user-plus"></i> Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ¸Ù Ø¬Ø¯ÙŠØ¯
            </h3>
            <div class="form-grid">
              <input type="text" id="staff-name" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù" />
              <input
                type="email"
                id="staff-email"
                placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ù„Ù„Ø¯Ø®ÙˆÙ„"
              />
            </div>
            <div class="form-grid" style="margin-top: 15px">
              <input
                type="text"
                id="staff-password"
                placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±"
              />
              <select id="staff-role">
                <option value="cashier">ÙƒØ§Ø´ÙŠØ±</option>
                <option value="kitchen">Ø´ÙŠÙ</option>
              </select>
            </div>

            <div
              style="
                background: var(--bg);
                padding: 15px;
                border-radius: 10px;
                margin-top: 15px;
                border: 1px solid var(--border-color);
              "
            >
              <h4 style="margin-top: 0; color: var(--secondary)">
                â° Ù…ÙˆØ§Ø¹ÙŠØ¯ Ø§Ù„Ø¹Ù…Ù„ ÙˆØ§Ù„Ø¥Ø¬Ø§Ø²Ø§Øª
              </h4>
              <div class="form-grid">
                <div>
                  <label class="form-label">Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø´ÙŠÙØª</label>
                  <input type="time" id="staff-start" value="09:00" />
                </div>
                <div>
                  <label class="form-label">Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø´ÙŠÙØª</label>
                  <input type="time" id="staff-end" value="17:00" />
                </div>
              </div>
              <label class="form-label" style="margin-top: 10px"
                >Ø£ÙŠØ§Ù… Ø§Ù„Ø¥Ø¬Ø§Ø²Ø© Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠØ©</label
              >
              <div
                style="display: flex; gap: 10px; flex-wrap: wrap"
                id="rest-days-container"
              >
                <label><input type="checkbox" value="6" /> Ø§Ù„Ø³Ø¨Øª</label>
                <label><input type="checkbox" value="0" /> Ø§Ù„Ø£Ø­Ø¯</label>
                <label><input type="checkbox" value="1" /> Ø§Ù„Ø¥Ø«Ù†ÙŠÙ†</label>
                <label><input type="checkbox" value="2" /> Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡</label>
                <label><input type="checkbox" value="3" /> Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡</label>
                <label><input type="checkbox" value="4" /> Ø§Ù„Ø®Ù…ÙŠØ³</label>
                <label><input type="checkbox" value="5" /> Ø§Ù„Ø¬Ù…Ø¹Ø©</label>
              </div>
            </div>
            <button
              class="btn btn-primary"
              onclick="addStaff()"
              style="margin-top: 15px"
            >
              Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            </button>
          </div>

          <div class="table-wrapper">
            <table>
              <thead>
                <tr>
                  <th>Ø§Ù„Ø§Ø³Ù…</th>
                  <th>Ø§Ù„Ø¨Ø±ÙŠØ¯</th>
                  <th>Ø§Ù„Ø¯ÙˆØ±</th>
                  <th>Ø­Ø°Ù</th>
                </tr>
              </thead>
              <tbody id="staff-list"></tbody>
            </table>
          </div>
        </div>
        <div id="view-coupons" class="hidden">
          <div class="card">
            <h3 style="color: var(--primary); margin-top: 0">Ø¥Ø¶Ø§ÙØ© ÙƒÙˆØ¨ÙˆÙ† Ø¬Ø¯ÙŠØ¯</h3>
            <div class="form-grid">
              <input type="text" id="coup-code" placeholder="ÙƒÙˆØ¯ Ø§Ù„ÙƒÙˆØ¨ÙˆÙ† (SAVE20)" />
              <select id="coup-type">
                <option value="percent">Ù†Ø³Ø¨Ø© Ù…Ø¦ÙˆÙŠØ© (%)</option>
                <option value="fixed">Ù…Ø¨Ù„Øº Ø«Ø§Ø¨Øª (Ø¬.Ù…)</option>
              </select>
            </div>
            <div class="form-grid" style="margin-top: 10px">
              <input type="number" id="coup-value" placeholder="Ù‚ÙŠÙ…Ø© Ø§Ù„Ø®ØµÙ…" />
              <input type="number" id="coup-min" placeholder="Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ Ù„Ù„Ø·Ù„Ø¨" />
            </div>
            <button class="btn btn-primary" style="margin-top: 15px" onclick="createCoupon()">Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ÙƒÙˆØ¨ÙˆÙ†</button>
          </div>
          <div class="table-wrapper">
            <table>
              <thead>
                <tr><th>Ø§Ù„ÙƒÙˆØ¯</th><th>Ø§Ù„Ø®ØµÙ…</th><th>Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…</th><th>Ø­Ø°Ù</th></tr>
              </thead>
              <tbody id="coupons-list"></tbody>
            </table>
          </div>
        </div>

        <div id="view-reservations" class="hidden">
          <div class="header">
            <h3 class="page-title">Ø¥Ø¯Ø§Ø±Ø© Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø­Ø¬Ø²</h3>
            <button class="btn btn-outline" onclick="loadReservations()"><i class="fas fa-sync"></i> ØªØ­Ø¯ÙŠØ«</button>
          </div>
          <div class="table-wrapper">
            <table>
              <thead>
                <tr>
                  <th>Ø§Ù„Ø¹Ù…ÙŠÙ„</th>
                  <th>Ø§Ù„Ù‡Ø§ØªÙ</th>
                  <th>Ø§Ù„Ù…Ù‚Ø§Ø¹Ø¯</th>
                  <th>Ø§Ù„ÙˆÙ‚Øª</th>
                  <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                  <th>Ø¥Ø¬Ø±Ø§Ø¡</th>
                </tr>
              </thead>
              <tbody id="res-requests-list"></tbody>
            </table>
          </div>
        </div>
        <div id="view-stock" class="hidden">
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <div>
                        <h3 style="color: var(--primary); margin: 0;"><i class="fas fa-cubes"></i> Ø¯ÙˆÙ„Ø§Ø¨ Ø§Ù„Ø®Ø§Ù…Ø§Øª</h3>
                        <p style="margin: 5px 0 0; color: var(--secondary); font-size: 13px;">Ù‡Ù†Ø§ Ø¨ØªØ³Ø¬Ù„ ÙƒÙ„ Ø§Ù„Ø®Ø§Ù…Ø§Øª Ø§Ù„Ù„ÙŠ Ø¨ØªØ´ØªØ±ÙŠÙ‡Ø§ (Ø¨Ù†ØŒ Ø³ÙƒØ±ØŒ Ø­Ù„ÙŠØ¨ØŒ Ù„Ø­ÙˆÙ…...)</p>
                    </div>
                    <button class="btn btn-primary" style="width: auto;" onclick="openStockModal()">
                        <i class="fas fa-plus"></i> ØªØ³Ø¬ÙŠÙ„ Ø®Ø§Ù…Ø© Ø¬Ø¯ÙŠØ¯Ø©
                    </button>
                </div>

                <div class="table-wrapper">
                    <table>
                        <thead>
                            <tr>
                                <th>Ø§Ø³Ù… Ø§Ù„Ø®Ø§Ù…Ø©</th>
                                <th>Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ø­Ø§Ù„ÙŠØ©</th>
                                <th>Ø§Ù„ÙˆØ­Ø¯Ø©</th>
                                <th>Ø§Ù„ØªÙƒÙ„ÙØ©</th>
                                <th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                            </tr>
                        </thead>
                        <tbody id="stock-items-list"></tbody>
                    </table>
                </div>
            </div>

            <div class="card" style="margin-top: 25px;">
                <h3 style="color: var(--primary); margin-top: 0; margin-bottom: 15px;">
                    <i class="fas fa-history"></i> Ø³Ø¬Ù„ Ø­Ø±ÙƒØ© Ø§Ù„Ù…Ø®Ø²Ù† (ÙˆØ§Ø±Ø¯ / ØµØ§Ø¯Ø±)
                </h3>
                
                <div style="display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap; align-items: center; background: var(--bg); padding: 10px; border-radius: 10px;">
                    <label style="font-weight: bold; font-size: 13px;">ØªØ§Ø±ÙŠØ®:</label>
                    <input type="date" id="stock-report-start" style="width: auto; height: 35px;">
                    <span style="font-weight: bold;">Ø¥Ù„Ù‰</span>
                    <input type="date" id="stock-report-end" style="width: auto; height: 35px;">
                    <button class="btn btn-outline" style="width: auto; height: 35px; padding: 0 15px;" onclick="loadStockLogs()">
                        <i class="fas fa-filter"></i> Ø¹Ø±Ø¶ Ø§Ù„ØªÙ‚Ø±ÙŠØ±
                    </button>
                    <button class="btn btn-success" style="width: auto; height: 35px; padding: 0 15px;" onclick="exportToExcel('stock-table', 'Ø³Ø¬Ù„_Ø§Ù„Ù…Ø®Ø²Ù†')">
    <i class="fas fa-file-excel"></i> Excel
</button>
                </div>

                <div class="table-wrapper">
    <table id="stock-table">
        <thead>
            <tr>
                <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                                <th>Ø§Ù„ØµÙ†Ù</th>
                                <th>Ù†ÙˆØ¹ Ø§Ù„Ø­Ø±ÙƒØ©</th>
                                <th>Ø§Ù„ÙƒÙ…ÙŠØ©</th>
                                <th>Ø§Ù„Ø³Ø¨Ø¨</th>
                            </tr>
                        </thead>
                        <tbody id="stock-logs-list"></tbody>
                    </table>
                </div>
            </div>
        </div>
       <div id="view-accounting" class="hidden">
            <div class="card" style="margin-bottom: 20px; padding: 15px; display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 10px;">
                <div style="display: flex; align-items: center; gap: 10px;">
                    <i class="fas fa-calendar-alt" style="color: var(--primary); font-size: 20px;"></i>
                    <div style="display: flex; gap: 10px;">
                        <div>
                            <label style="font-size: 12px; font-weight: bold; color: var(--secondary); display: block;">Ø§Ù„Ø³Ù†Ø©</label>
                            <select id="acc-stats-year" class="modern-input" style="height: 40px; padding: 0 10px; font-family: 'Tajawal', sans-serif; font-weight:bold; cursor:pointer;" onchange="loadAccStats()">
                            </select>
                        </div>
                        <div>
                            <label style="font-size: 12px; font-weight: bold; color: var(--secondary); display: block;">Ø§Ù„Ø´Ù‡Ø±</label>
                            <select id="acc-stats-month" class="modern-input" style="height: 40px; padding: 0 10px; font-family: 'Tajawal', sans-serif; font-weight:bold; cursor:pointer;" onchange="loadAccStats()">
                            </select>
                        </div>
                    </div>
<script>
    (function(){
        const yearSel = document.getElementById("acc-stats-year");
        const monthSel = document.getElementById("acc-stats-month");
        
        if(yearSel && monthSel) {
            const d = new Date();
            const currentYear = d.getFullYear();
            const currentMonth = d.getMonth() + 1; // 1-12

            // ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø³Ù†ÙˆØ§Øª (Ø³Ù†ØªÙŠÙ† Ù‚Ø¨Ù„ ÙˆØ³Ù†ØªÙŠÙ† Ø¨Ø¹Ø¯)
            for(let i = currentYear - 2; i <= currentYear + 2; i++){
                const opt = document.createElement("option");
                opt.value = i;
                opt.text = i;
                if(i === currentYear) opt.selected = true;
                yearSel.appendChild(opt);
            }

            // ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø´Ù‡ÙˆØ±
            const months = ["ÙŠÙ†Ø§ÙŠØ±", "ÙØ¨Ø±Ø§ÙŠØ±", "Ù…Ø§Ø±Ø³", "Ø£Ø¨Ø±ÙŠÙ„", "Ù…Ø§ÙŠÙˆ", "ÙŠÙˆÙ†ÙŠÙˆ", "ÙŠÙˆÙ„ÙŠÙˆ", "Ø£ØºØ³Ø·Ø³", "Ø³Ø¨ØªÙ…Ø¨Ø±", "Ø£ÙƒØªÙˆØ¨Ø±", "Ù†ÙˆÙÙ…Ø¨Ø±", "Ø¯ÙŠØ³Ù…Ø¨Ø±"];
            months.forEach((m, index) => {
                const opt = document.createElement("option");
                // Ø§Ù„Ù‚ÙŠÙ…Ø© ØªÙƒÙˆÙ† 01, 02...
                opt.value = String(index + 1).padStart(2, '0');
                opt.text = m;
                if((index + 1) === currentMonth) opt.selected = true;
                monthSel.appendChild(opt);
            });
        }
    })();
</script>
                </div>
                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-outline" onclick="loadAccStats()">
                        <i class="fas fa-sync"></i> ØªØ­Ø¯ÙŠØ«
                    </button>
                    <button class="btn btn-primary" onclick="downloadFinancialReportPDF()" style="background: var(--danger); border-color: var(--danger);">
                        <i class="fas fa-file-pdf"></i> ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªÙ‚Ø±ÙŠØ± PDF
                    </button>
                </div>
            </div>

            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; margin-bottom: 25px;">
                <div class="stats-card-modern" style="border-left: 5px solid var(--primary);">
                    <div>
                        <div style="font-size: 12px; color: var(--secondary); font-weight:bold;">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</div>
                        <div style="font-size: 24px; font-weight: 800; color: var(--primary);" id="acc-stat-sales">0 Ø¬.Ù…</div>
                    </div>
                    <i class="fas fa-coins fa-2x" style="color: var(--primary); opacity: 0.2;"></i>
                </div>
                <div class="stats-card-modern" style="border-left: 5px solid var(--danger);">
                    <div>
                        <div style="font-size: 12px; color: var(--secondary); font-weight:bold;">Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª + Ø§Ù„Ø±ÙˆØ§ØªØ¨</div>
                        <div style="font-size: 24px; font-weight: 800; color: var(--danger);" id="acc-stat-expenses">0 Ø¬.Ù…</div>
                    </div>
                    <i class="fas fa-file-invoice-dollar fa-2x" style="color: var(--danger); opacity: 0.2;"></i>
                </div>
                <div class="stats-card-modern" style="border-left: 5px solid var(--success);">
                    <div>
                        <div style="font-size: 12px; color: var(--secondary); font-weight:bold;">ØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­</div>
                        <div style="font-size: 24px; font-weight: 800; color: var(--success);" id="acc-stat-profit">0 Ø¬.Ù…</div>
                    </div>
                    <i class="fas fa-chart-line fa-2x" style="color: var(--success); opacity: 0.2;"></i>
                </div>
            </div>

            <div class="card">
                <div class="cat-tabs" style="justify-content: flex-start; overflow-x: auto;">
                    <div onclick="showAccTab('dashboard')" id="btn-tab-dashboard" class="cat-tab-btn active"><i class="fas fa-chart-pie"></i> Ø§Ù„Ù…Ø§Ù„ÙŠØ©</div>
                    <div onclick="showAccTab('expenses')" id="btn-tab-expenses" class="cat-tab-btn"><i class="fas fa-receipt"></i> Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª</div>
                    <div onclick="showAccTab('employees')" id="btn-tab-employees" class="cat-tab-btn"><i class="fas fa-users"></i> Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† ÙˆØ§Ù„Ø³Ù„Ù</div>
                    <div onclick="showAccTab('attendance')" id="btn-tab-attendance" class="cat-tab-btn"><i class="fas fa-fingerprint"></i> Ø§Ù„Ø­Ø¶ÙˆØ±</div>
                    <div onclick="showAccTab('payroll')" id="btn-tab-payroll" class="cat-tab-btn"><i class="fas fa-money-check-alt"></i> Ø§Ù„Ø±ÙˆØ§ØªØ¨</div>
                </div>

                <div id="acc-tab-dashboard">
                  <div style="background:var(--bg); padding:20px; border-radius:12px; margin-bottom:20px; border:1px solid var(--primary);">
                        <h4 style="margin-top:0; color:var(--primary); display:flex; align-items:center; gap:10px;">
                            <i class="fas fa-cogs"></i> Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø§Ø­ØªØ³Ø§Ø¨ Ø§Ù„Ø¢Ù„ÙŠ
                        </h4>
                        <p style="font-size:12px; color:var(--secondary);">Ø£Ø¯Ø®Ù„ Ø§Ù„Ù‚ÙˆØ§Ø¹Ø¯ Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© ÙˆØ³ÙŠÙ‚ÙˆÙ… Ø§Ù„Ù†Ø¸Ø§Ù… Ø¨Ø­Ø³Ø§Ø¨ Ø±ÙˆØ§ØªØ¨ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ ÙƒÙ„ Ø´Ù‡Ø±.</p>
                        
                        <div class="form-grid">
                            <div>
                                <label class="form-label">Ù‚ÙŠÙ…Ø© Ø³Ø§Ø¹Ø© Ø§Ù„Ø¥Ø¶Ø§ÙÙŠ (Ø¬.Ù…)</label>
                                <input type="number" id="acc-set-overtime" placeholder="Ù…Ø«Ø§Ù„: 50" class="modern-input">
                            </div>
                            <div>
                                <label class="form-label">Ø®ØµÙ… Ø³Ø§Ø¹Ø© Ø§Ù„ØªØ£Ø®ÙŠØ± (Ø¬.Ù…)</label>
                                <input type="number" id="acc-set-late" placeholder="Ù…Ø«Ø§Ù„: 20" class="modern-input">
                            </div>
                            <div>
                                <label class="form-label">Ø®ØµÙ… ÙŠÙˆÙ… Ø§Ù„ØºÙŠØ§Ø¨ (ÙƒÙ… ÙŠÙˆÙ… Ø¹Ù…Ù„ØŸ)</label>
                                <input type="number" id="acc-set-absence" placeholder="Ù…Ø«Ø§Ù„: 1 (Ø§Ù„ÙŠÙˆÙ… Ø¨ÙŠÙˆÙ…) Ø£Ùˆ 2" class="modern-input">
                            </div>
                        </div>
                        <button class="btn btn-primary" onclick="saveAccSettings()" style="margin-top:15px; width:100%;">
                            <i class="fas fa-save"></i> Ø­ÙØ¸ Ø§Ù„Ù‚ÙˆØ§Ø¹Ø¯ Ø§Ù„Ù…Ø­Ø§Ø³Ø¨ÙŠØ©
                        </button>
                    </div>
                </div>

                <div id="acc-tab-expenses" class="hidden">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                        <h3 style="color:var(--primary); margin:0;">Ø³Ø¬Ù„ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª</h3>
                        <button class="btn btn-primary" onclick="openExpenseModal()">
                            <i class="fas fa-plus"></i> ØªØ³Ø¬ÙŠÙ„ Ù…ØµØ±ÙˆÙ
                        </button>
                    </div>
                    <div class="table-wrapper">
                        <table>
                            <thead><tr><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ø¨Ù†Ø¯</th><th>Ø§Ù„ÙØ¦Ø©</th><th>Ø§Ù„Ù‚ÙŠÙ…Ø©</th><th>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th><th>Ø­Ø°Ù</th></tr></thead>
                            <tbody id="acc-expenses-list"></tbody>
                        </table>
                    </div>
                </div>

                <div id="acc-tab-employees" class="hidden">
                    <div style="background:var(--bg); padding:15px; border-radius:12px; margin-bottom:20px; border:1px solid var(--border-color);">
                        <h4 style="margin-top:0; color:var(--primary);"><i class="fas fa-user-plus"></i> Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ¸Ù Ø¬Ø¯ÙŠØ¯</h4>
                        <div class="form-grid">
                            <input type="text" id="acc-emp-name" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù" class="modern-input">
                            <input type="text" id="acc-emp-job" placeholder="Ø§Ù„Ù…Ø³Ù…Ù‰ Ø§Ù„ÙˆØ¸ÙŠÙÙŠ" class="modern-input">
                            <select id="acc-emp-type" class="modern-input">
                                <option value="monthly">Ø±Ø§ØªØ¨ Ø´Ù‡Ø±ÙŠ</option>
                                <option value="daily">ÙŠÙˆÙ…ÙŠØ©</option>
                            </select>
                            <input type="number" id="acc-emp-salary" placeholder="Ø§Ù„Ø±Ø§ØªØ¨/Ø§Ù„ÙŠÙˆÙ…ÙŠØ©" class="modern-input">
                        </div>
                        <div class="form-grid" style="margin-top:10px;">
                            <input type="number" id="acc-emp-hours" placeholder="Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ø¹Ù…Ù„" value="9" class="modern-input">
                            <div style="display:flex; gap:10px; align-items:center;">
                                <label style="font-size:12px; color:var(--secondary); width:80px;">Ù…ÙˆØ§Ø¹ÙŠØ¯ Ø§Ù„Ø¹Ù…Ù„:</label>
                                <input type="time" id="acc-emp-start" value="09:00" class="modern-input">
                                <span style="font-weight:bold;">Ø¥Ù„Ù‰</span>
                                <input type="time" id="acc-emp-end" value="18:00" class="modern-input">
                            </div>
                        </div>
                        <button class="btn btn-success" style="margin-top:15px; width:100%;" onclick="addEmployee()">Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
                    </div>
                    
                    <h4 style="color:var(--secondary); border-bottom:1px solid var(--border-color); padding-bottom:10px;">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</h4>
                    <div class="table-wrapper">
                        <table>
                            <thead><tr><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„ÙˆØ¸ÙŠÙØ©</th><th>Ø§Ù„Ù†Ø¸Ø§Ù…</th><th>Ø§Ù„Ø±Ø§ØªØ¨</th><th>Ø±ØµÙŠØ¯ Ø§Ù„Ø³Ù„Ù</th><th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th></tr></thead>
                            <tbody id="acc-emp-list"></tbody>
                        </table>
                    </div>
                </div>

                <div id="acc-tab-attendance" class="hidden">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; background:var(--bg); padding:10px; border-radius:10px;">
                        <div style="font-weight:bold;">ğŸ“… Ø¯ÙØªØ± Ø§Ù„Ø­Ø¶ÙˆØ±:</div>
                        <input type="date" id="acc-att-date" class="modern-input" style="width:auto;" onchange="loadAttendance()">
                    </div>
                    <div class="table-wrapper">
                        <table>
                            <thead><tr><th>Ø§Ù„Ù…ÙˆØ¸Ù</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th><th>ÙˆÙ‚Øª Ø§Ù„Ø­Ø¶ÙˆØ±</th><th>ÙˆÙ‚Øª Ø§Ù„Ø§Ù†ØµØ±Ø§Ù</th><th>Ø£ÙˆÙØ± ØªØ§ÙŠÙ…</th><th>ØªØ³Ø¬ÙŠÙ„</th></tr></thead>
                            <tbody id="acc-att-list"></tbody>
                        </table>
                    </div>
                </div>

                <div id="acc-tab-payroll" class="hidden">
                    <div style="background:#f0f9ff; padding:20px; border-radius:12px; margin-bottom:20px; border:1px dashed #0ea5e9;">
                        <h4 style="margin-top:0; color:#0369a1;"><i class="fas fa-calculator"></i> Ø¥ØµØ¯Ø§Ø± Ø§Ù„Ø±ÙˆØ§ØªØ¨</h4>
                        <div style="display:flex; align-items:center; gap:15px; flex-wrap:wrap;">
                           <select id="acc-pay-month" class="modern-input" style="width:auto; min-width: 150px; direction: rtl; font-weight: bold; cursor: pointer; font-family: 'Tajawal', sans-serif;" onchange="preparePayrollUI()"></select>

<script>
  (function() {
    const sel = document.getElementById("acc-pay-month");
    if(sel) {
        const d = new Date();
        const currentYear = d.getFullYear(); // Ø§Ù„Ø³Ù†Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
        const currentMonthIdx = d.getMonth(); // Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ (0-11)

        // Ù…ØµÙÙˆÙØ© Ø§Ù„Ø´Ù‡ÙˆØ± Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠ
        const months = ["ÙŠÙ†Ø§ÙŠØ±", "ÙØ¨Ø±Ø§ÙŠØ±", "Ù…Ø§Ø±Ø³", "Ø£Ø¨Ø±ÙŠÙ„", "Ù…Ø§ÙŠÙˆ", "ÙŠÙˆÙ†ÙŠÙˆ", "ÙŠÙˆÙ„ÙŠÙˆ", "Ø£ØºØ³Ø·Ø³", "Ø³Ø¨ØªÙ…Ø¨Ø±", "Ø£ÙƒØªÙˆØ¨Ø±", "Ù†ÙˆÙÙ…Ø¨Ø±", "Ø¯ÙŠØ³Ù…Ø¨Ø±"];
        
        // Ø¹Ø±Ø¶ Ø´Ù‡ÙˆØ± Ø§Ù„Ø³Ù†Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© ÙÙ‚Ø· (Ù…Ù† ÙŠÙ†Ø§ÙŠØ± Ø¥Ù„Ù‰ Ø¯ÙŠØ³Ù…Ø¨Ø±)
        for (let i = 0; i < 12; i++) { 
          
          // Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ù„ÙŠ Ù‡ØªØ±ÙˆØ­ Ù„Ù„Ø³ÙŠØ±ÙØ± (Ø³Ù†Ø©-Ø´Ù‡Ø±)
          // Ø¨Ù†Ø²ÙˆØ¯ 1 Ù„Ø£Ù† i ØªØ¨Ø¯Ø£ Ù…Ù† 0
          const monthNum = String(i + 1).padStart(2, '0');
          const val = `${currentYear}-${monthNum}`; 
          
          // Ø§Ù„Ù†Øµ Ø§Ù„Ù„ÙŠ Ù‡ÙŠØ¸Ù‡Ø± Ù„ÙŠÙƒ (Ø¹Ø±Ø¨ÙŠ)
          const txt = `${months[i]} ${currentYear}`;
          
          const opt = document.createElement("option");
          opt.value = val;
          opt.text = txt;
          
          // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
          if (i === currentMonthIdx) opt.selected = true;
          
          sel.appendChild(opt);
        }
    }
  })();
</script>
                            <button class="btn btn-primary" onclick="preparePayrollUI()">Ø¹Ø±Ø¶ ÙƒØ´Ù Ø§Ù„Ø±ÙˆØ§ØªØ¨ (Ø§Ù„Ù…Ø³ÙˆØ¯Ø©)</button>
                        </div>
                    </div>

                    <div id="payroll-preview-area" class="hidden">
                        <div class="table-wrapper">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Ø§Ù„Ù…ÙˆØ¸Ù</th>
                                        <th>Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ</th>
                                        <th style="color:green">Ø¥Ø¶Ø§ÙÙŠ (+)</th>
                                        <th style="color:blue">Ù…ÙƒØ§ÙØ¢Øª (+)</th>
                                        <th style="color:red">Ø¬Ø²Ø§Ø¡Ø§Øª (-)</th>
                                        <th style="color:orange">Ø®ØµÙ… Ø³Ù„ÙØ© (-)</th>
                                        <th>Ø§Ù„ØµØ§ÙÙŠ</th>
                                        <th>Ø·Ø¨Ø§Ø¹Ø©</th> </tr>
                                </thead>
                                <tbody id="acc-pay-list"></tbody>
                            </table>
                        </div>
                        <button class="btn btn-success" onclick="confirmPayrollGeneration()" style="width:100%; margin-top:15px; height:50px; font-size:16px;">
                            <i class="fas fa-save"></i> Ø§Ø¹ØªÙ…Ø§Ø¯ ÙˆØ­ÙØ¸ Ø§Ù„Ø±ÙˆØ§ØªØ¨
                        </button>
                    </div>
                </div>
            </div>
        </div>
        <div id="view-settings" class="hidden">
          <div class="card" style="max-width: 800px; margin: 0 auto">
            <h3
              style="
                color: var(--primary);
                margin-top: 0;
                border-bottom: 1px solid var(--border-color);
                padding-bottom: 15px;
                margin-bottom: 20px;
              "
            >
              <i class="fas fa-cogs"></i> Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ø·Ù„Ø¨Ø§Øª
            </h3>

            <div class="form-group">
              <label class="form-label">Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ´ØºÙŠÙ„ (Order Mode)</label>
              <select
                id="set-orderMode"
                style="height: 50px; font-size: 15px; font-weight: bold"
              >
                <option value="whatsapp">ğŸ“± ÙˆØ§ØªØ³Ø§Ø¨ (Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ Ù„Ø±Ù‚Ù…Ùƒ)</option>
                <option value="system">
                  ğŸš€ Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø°ÙƒÙŠ (Live Orders System)
                </option>
                <option value="view_only">ğŸ‘€ Ù„Ù„Ø¹Ø±Ø¶ ÙÙ‚Ø· (Ø¨Ø¯ÙˆÙ† Ø·Ù„Ø¨)</option>
              </select>
              <small
                style="color: var(--secondary); display: block; margin-top: 5px"
              >
                <i class="fas fa-info-circle"></i>
                <b>ÙˆØ§ØªØ³Ø§Ø¨:</b> Ø§Ù„Ø²Ø¨ÙˆÙ† ÙŠØ®ØªØ§Ø± Ø§Ù„Ø·Ù„Ø¨ ÙˆÙŠØªØ­ÙˆÙ„ Ù„Ù„Ø´Ø§Øª Ù…Ø¹Ø§Ùƒ. <br />
                <b>Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø°ÙƒÙŠ:</b> Ø§Ù„Ø·Ù„Ø¨Ø§Øª ØªÙ†Ø²Ù„ ÙÙŠ ØµÙØ­Ø© "Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø­ÙŠØ©" ÙˆØªØ³Ù…Ø¹
                ØµÙˆØª ØªÙ†Ø¨ÙŠÙ‡. <br />
                <b>Ù„Ù„Ø¹Ø±Ø¶ ÙÙ‚Ø·:</b> Ø¥Ø®ÙØ§Ø¡ Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¥Ø¶Ø§ÙØ© ÙˆØ§Ù„Ø³Ù„Ø© (ÙƒØªØ§Ù„ÙˆØ¬).
              </small>
            </div>

            <div class="form-grid" style="margin-top: 20px">
              <div>
                <label class="form-label">Ù†Ø³Ø¨Ø© Ø§Ù„Ø¶Ø±ÙŠØ¨Ø© (%)</label>
                <input
                  type="number"
                  id="set-taxRate"
                  placeholder="0"
                  min="0"
                  step="0.1"
                />
              </div>
              <div>
                <label class="form-label">Ù†Ø³Ø¨Ø© Ø§Ù„Ø®Ø¯Ù…Ø© (%)</label>
                <input
                  type="number"
                  id="set-serviceRate"
                  placeholder="0"
                  min="0"
                  step="0.1"
                />
              </div>
            </div>
            <div class="form-group" style="margin-top: 20px">
              <label class="form-label">Ø®ÙŠØ§Ø±Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©</label>
              <div
                style="
                  display: flex;
                  gap: 10px;
                  align-items: center;
                  background: var(--bg);
                  padding: 15px;
                  border-radius: 10px;
                  border: 1px solid var(--border-color);
                "
              >
                <input
                  type="checkbox"
                  id="set-useTableNumbers"
                  style="width: 20px; height: 20px"
                />
                <label
                  for="set-useTableNumbers"
                  style="cursor: pointer; font-weight: bold"
                  >ØªÙØ¹ÙŠÙ„ Ù†Ø¸Ø§Ù… Ø§Ù„Ø·Ø§ÙˆÙ„Ø§Øª (Table Numbers)</label
                >
              </div>
              <div
                style="
                  display: flex;
                  gap: 10px;
                  align-items: center;
                  background: var(--bg);
                  padding: 15px;
                  border-radius: 10px;
                  border: 1px solid var(--border-color);
                  margin-top: 10px;
                "
              >
                <input
                  type="checkbox"
                  id="set-enableCoupons"
                  style="width: 20px; height: 20px"
                />
                <label
                  for="set-enableCoupons"
                  style="cursor: pointer; font-weight: bold"
                  >ØªÙØ¹ÙŠÙ„ Ø§Ù„ÙƒÙˆØ¨ÙˆÙ†Ø§Øª (Coupons)</label
                >
              </div>
              
              <div
                style="
                  display: flex;
                  gap: 10px;
                  align-items: center;
                  background: var(--bg);
                  padding: 15px;
                  border-radius: 10px;
                  border: 1px solid var(--border-color);
                  margin-top: 10px;
                "
              >
                <input
                  type="checkbox"
                  id="set-printOrderNum"
                  style="width: 20px; height: 20px"
                />
                <label
                  for="set-printOrderNum"
                  style="cursor: pointer; font-weight: bold"
                  >Ø·Ø¨Ø§Ø¹Ø© Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨ ÙÙŠ Ø§Ù„ÙØ§ØªÙˆØ±Ø© (Order #)</label
                >
              </div>

              <div class="card" style="margin-top: 30px; border: 1px solid var(--success);">
              <h3 style="color: var(--success); margin-top: 0; border-bottom: 1px solid var(--border-color); padding-bottom: 15px; margin-bottom: 20px;">
                <i class="fas fa-ticket-alt"></i> Ù†Ø¸Ø§Ù… Ø­Ø¬Ø² Ø§Ù„Ù…Ù‚Ø§Ø¹Ø¯ (Event Mode)
              </h3>
              
              <div class="form-group">
                  <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                      <label class="toggle-switch">
                          <input type="checkbox" id="res-enable" onchange="saveReservationSettings()">
                          <span class="slider"></span>
                      </label>
                      <span style="font-weight:bold;">ØªÙØ¹ÙŠÙ„ Ù†Ø¸Ø§Ù… Ø§Ù„Ø­Ø¬Ø²</span>
                  </div>

                  <label class="form-label">Ø§Ù„Ø¹Ø¯Ø¯ Ø§Ù„ÙƒÙ„ÙŠ Ù„Ù„Ù…Ù‚Ø§Ø¹Ø¯ Ø§Ù„Ù…ØªØ§Ø­Ø©</label>
                  <input type="number" id="res-total-seats" placeholder="Ù…Ø«Ø§Ù„: 100" class="modern-input">
              </div>

              <div style="background:var(--bg); padding:15px; border-radius:10px; margin: 15px 0;">
                  <div style="display:flex; justify-content:space-between; font-size:14px; margin-bottom:5px;">
                      <span>ØªÙ… Ø­Ø¬Ø²:</span>
                      <strong id="res-booked-display" style="color:var(--primary)">0</strong>
                  </div>
                  <div style="display:flex; justify-content:space-between; font-size:14px;">
                      <span>Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ:</span>
                      <strong id="res-available-display" style="color:var(--success)">0</strong>
                  </div>
              </div>

              <div style="display:flex; gap:10px;">
                  <button class="btn btn-success" onclick="saveReservationSettings()" style="flex:2;">
                      <i class="fas fa-save"></i> Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
                  </button>
                  <button class="btn btn-outline" onclick="resetReservationCounter()" style="flex:1; border-color:var(--danger); color:var(--danger);" title="ØªØµÙÙŠØ± Ø§Ù„Ø¹Ø¯Ø§Ø¯ Ù„Ø¨Ø¯Ø¡ ÙŠÙˆÙ… Ø¬Ø¯ÙŠØ¯">
                      <i class="fas fa-redo"></i> ØªØµÙÙŠØ±
                  </button>
              </div>

              <div style="margin-top:20px; padding-top:15px; border-top:1px dashed #ccc;">
                  <label class="form-label">Ø±Ø§Ø¨Ø· Ø§Ù„Ø­Ø¬Ø² Ù„Ù„Ø¹Ù…Ù„Ø§Ø¡</label>
                  <div style="display:flex; gap:5px;">
                      <input type="text" id="res-link-input" readonly class="modern-input" style="background:#eee; font-size:12px;">
                      <button class="btn btn-primary" onclick="copyResLink()" style="width:auto;"><i class="fas fa-copy"></i></button>
                      <a href="#" target="_blank" id="res-link-btn" class="btn btn-outline" style="width:auto;"><i class="fas fa-external-link-alt"></i></a>
                  </div>
              </div>
            </div>
              </div>

            <div class="form-group" style="margin-top: 20px">
              <label class="form-label">Ø±Ù‚Ù… Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨ Ù„Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</label>
              <input
                type="text"
                id="set-whatsapp"
                placeholder="Ù…Ø«Ø§Ù„: 01000000000"
                style="font-size: 16px; font-weight: bold; letter-spacing: 1px"
              />
            </div>

            <button
              class="btn btn-success"
              onclick="saveSettings()"
              style="margin-top: 20px; font-size: 16px"
            >
              <i class="fas fa-save"></i> Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
            </button>

            <div class="card" style="margin-top: 30px; border: 1px solid var(--primary);">
              <h3 style="color: var(--primary); margin-top: 0; border-bottom: 1px solid var(--border-color); padding-bottom: 15px; margin-bottom: 20px;">
                <i class="fas fa-lock"></i> ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±
              </h3>
              
              <div class="form-group">
                  <label class="form-label">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©</label>
                  <div style="position: relative;">
                      <input type="password" id="new-password" placeholder="Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø¬Ø¯ÙŠØ¯Ø© (6 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„)" style="padding-left: 40px;">
                      <i class="fas fa-key" style="position: absolute; left: 15px; top: 15px; color: var(--secondary);"></i>
                  </div>
              </div>

              <button class="btn btn-primary" onclick="changePassword()" style="width: 100%; margin-top: 10px;">
                  <i class="fas fa-check-circle"></i> ØªØ­Ø¯ÙŠØ« ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±
              </button>
            </div>

          </div>
        </div>

       <div id="view-design" class="hidden">
          <div class="design-container">
            
            <div class="design-controls">
              
              <div class="design-section">
                <div class="design-section-title">
                  <i class="fas fa-magic"></i> Ø§Ù„Ù‚ÙˆØ§Ù„Ø¨ Ø§Ù„Ø³Ø­Ø±ÙŠØ© (Themes)
                </div>
                <p style="font-size:12px; color:var(--secondary); margin-bottom:10px;">Ø§Ø®ØªØ± Ù…Ø¸Ù‡Ø±Ø§Ù‹ Ø¬Ø§Ù‡Ø²Ø§Ù‹ ÙˆØ³ÙŠØªÙ… ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø£Ù„ÙˆØ§Ù† ÙˆØ§Ù„Ø®Ø·ÙˆØ· ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹.</p>
                
                <label class="form-label">Ù‚ÙˆØ§Ù„Ø¨ Ø£Ø³Ø§Ø³ÙŠØ©</label>
                <div class="theme-grid" id="theme-library" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 10px; margin-bottom: 15px;"></div>
                
                <label class="form-label" style="color: #d4af37;"><i class="fas fa-crown"></i> Ù‚ÙˆØ§Ù„Ø¨ Ù…ØªØ­Ø±ÙƒØ© ÙØ§Ø®Ø±Ø©</label>
                <div class="theme-grid" id="animated-theme-library" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 10px;"></div>
              </div>

              <div class="design-section">
                <div class="design-section-title">
                  <i class="fas fa-palette"></i> Ø£Ù„ÙˆØ§Ù† ÙˆØ®Ø·ÙˆØ· Ø§Ù„Ù‡ÙˆÙŠØ©
                </div>
                <div class="form-grid">
                  <div>
                      <label class="form-label">Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ</label>
                      <label class="color-wrapper" for="ui-primaryColor">
                          <div id="color-preview-primary" class="color-preview-box" style="background-color: var(--primary);"></div>
                          <input type="color" id="ui-primaryColor" oninput="document.getElementById('color-preview-primary').style.backgroundColor=this.value; setUiParam('primaryColor', this.value)" style="opacity:0; width:0; height:0; position:absolute;">
                          <span style="font-size:13px; font-weight:bold;">Ø§Ø®ØªØ± Ø§Ù„Ù„ÙˆÙ†</span>
                      </label>
                   </div>
                   <div>
                      <label class="form-label">Ù„ÙˆÙ† Ø¹Ù†Ø§ÙˆÙŠÙ† Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</label>
                      <label class="color-wrapper" for="ui-secTitleColor">
                          <div id="color-preview-secTitle" class="color-preview-box" style="background-color: #2d2d2d;"></div>
                          <input type="color" id="ui-secTitleColor" oninput="document.getElementById('color-preview-secTitle').style.backgroundColor=this.value; setUiParam('secTitleColor', this.value)" style="opacity:0; width:0; height:0; position:absolute;">
                          <span style="font-size:13px; font-weight:bold;">Ø§Ø®ØªØ± Ø§Ù„Ù„ÙˆÙ†</span>
                      </label>
                   </div>
                   <div>
                      <label class="form-label">Ù„ÙˆÙ† Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬</label>
                      <label class="color-wrapper" for="ui-prodTitleColor">
                          <div id="color-preview-prodTitle" class="color-preview-box" style="background-color: #2d2d2d;"></div>
                          <input type="color" id="ui-prodTitleColor" oninput="document.getElementById('color-preview-prodTitle').style.backgroundColor=this.value; setUiParam('prodTitleColor', this.value)" style="opacity:0; width:0; height:0; position:absolute;">
                          <span style="font-size:13px; font-weight:bold;">Ø§Ø®ØªØ± Ø§Ù„Ù„ÙˆÙ†</span>
                      </label>
                   </div>

                   <div>
                      <label class="form-label">Ù„ÙˆÙ† Ø§Ù„Ø³Ø¹Ø±</label>
                      <label class="color-wrapper" for="ui-prodPriceColor">
                          <div id="color-preview-prodPrice" class="color-preview-box" style="background-color: #b78728;"></div>
                          <input type="color" id="ui-prodPriceColor" oninput="document.getElementById('color-preview-prodPrice').style.backgroundColor=this.value; setUiParam('prodPriceColor', this.value)" style="opacity:0; width:0; height:0; position:absolute;">
                          <span style="font-size:13px; font-weight:bold;">Ø§Ø®ØªØ± Ø§Ù„Ù„ÙˆÙ†</span>
                      </label>
                   </div>
                   <div>
                      <label class="form-label">Ù†ÙˆØ¹ Ø§Ù„Ø®Ø·</label>
                      <select id="ui-fontFamily" onchange="setUiParam('fontFamily', this.value)" style="height:48px;">
                        <option value="Tajawal">Tajawal (Ø§ÙØªØ±Ø§Ø¶ÙŠ)</option>
                        <option value="Cairo">Cairo (Ø±Ø³Ù…ÙŠ)</option>
                        <option value="Almarai">Almarai (Ø¹ØµØ±ÙŠ)</option>
                        <option value="Amiri">Amiri (ÙƒÙ„Ø§Ø³ÙŠÙƒ)</option>
                        <option value="Zain">Zain (Ø´Ø¨Ø§Ø¨ÙŠ)</option>
                      </select>
                   </div>
                </div>

                <div style="margin-top: 15px;">
                    <label class="form-label">Ø®Ù„ÙÙŠØ© Ø§Ù„Ù…ÙˆÙ‚Ø¹</label>
                    <div style="display:flex; gap:10px; margin-bottom:10px;">
                        <select id="ui-bgType" onchange="toggleBgInput()" style="flex:1;">
                          <option value="color">Ù„ÙˆÙ† Ù…ÙˆØ­Ø¯</option>
                          <option value="pattern">Ù†Ù‚Ø´ (Pattern)</option>
                          <option value="image">ØµÙˆØ±Ø© Ø®Ø§ØµØ©</option>
                        </select>
                        <input type="color" id="ui-bgColor" oninput="setUiParam('bgValue', this.value)" style="height:48px; width:60px; padding:2px;">
                    </div>
                    
                    <div id="ui-bgImage-container" class="hidden">
                      <div style="display: flex; align-items: center; gap: 10px; background:var(--bg); padding:10px; border-radius:10px; margin-bottom:10px;">
                        <img id="bg-preview" class="img-preview" style="width: 40px; height: 40px;">
                        <label for="ui-bgFile" class="custom-file-upload" style="margin: 0; background:white; font-size:12px;">
                          <i class="fas fa-upload"></i> Ø±ÙØ¹ Ø®Ù„ÙÙŠØ©
                        </label>
                        <input type="file" id="ui-bgFile" accept="image/*" onchange="handleBgUpload(this)">
                      </div>
                      
                      <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                          <div>
                              <label style="font-size:11px; color:var(--secondary)">Ø­Ø¬Ù… Ø§Ù„ØµÙˆØ±Ø©</label>
                              <select id="ui-bgSize" onchange="setUiParam('bgSize', this.value)" style="height:35px; font-size:12px;">
                                  <option value="cover">ØªØºØ·ÙŠØ© ÙƒØ§Ù…Ù„Ø© (Cover)</option>
                                  <option value="contain">Ø§Ø­ØªÙˆØ§Ø¡ (Contain)</option>
                                  <option value="auto">Ø·Ø¨ÙŠØ¹ÙŠ (Auto)</option>
                              </select>
                          </div>
                          <div>
                              <label style="font-size:11px; color:var(--secondary)">ØªÙƒØ±Ø§Ø±</label>
                              <select id="ui-bgRepeat" onchange="setUiParam('bgRepeat', this.value)" style="height:35px; font-size:12px;">
                                  <option value="no-repeat">Ø¨Ø¯ÙˆÙ† ØªÙƒØ±Ø§Ø±</option>
                                  <option value="repeat">ØªÙƒØ±Ø§Ø± (Repeat)</option>
                              </select>
                          </div>
                          <div>
                              <label style="font-size:11px; color:var(--secondary)">ØªØ«Ø¨ÙŠØª Ø§Ù„Ø®Ù„ÙÙŠØ©</label>
                              <select id="ui-bgAttachment" onchange="setUiParam('bgAttachment', this.value)" style="height:35px; font-size:12px;">
                                  <option value="fixed">Ø«Ø§Ø¨ØªØ© (Fixed)</option>
                                  <option value="scroll">ØªØªØ­Ø±Ùƒ (Scroll)</option>
                              </select>
                          </div>
                          <div>
                              <label style="font-size:11px; color:var(--secondary)">Ø§Ù„Ù…Ø­Ø§Ø°Ø§Ø©</label>
                              <select id="ui-bgPosition" onchange="setUiParam('bgPosition', this.value)" style="height:35px; font-size:12px;">
                                  <option value="center">ÙˆØ³Ø·</option>
                                  <option value="top">Ø£Ø¹Ù„Ù‰</option>
                                  <option value="bottom">Ø£Ø³ÙÙ„</option>
                                  <option value="left">ÙŠØ³Ø§Ø±</option>
                                  <option value="right">ÙŠÙ…ÙŠÙ†</option>
                              </select>
                          </div>
                      </div>
                      <div style="margin-top:10px; background:white; padding:10px; border-radius:8px;">
                          <label style="font-size:11px; display:block; color:var(--secondary); margin-bottom:5px;">Ø¯Ø±Ø¬Ø© ØªØ¹ØªÙŠÙ… Ø§Ù„Ø®Ù„ÙÙŠØ© (Overlay Opacity)</label>
                          <div style="display:flex; align-items:center; gap:10px;">
                              <input type="range" min="0" max="100" value="90" id="ui-bgOverlay" oninput="setUiParam('bgOverlay', this.value); document.getElementById('bgOverlayVal').innerText = this.value + '%'" style="width:100%">
                              <span id="bgOverlayVal" style="font-size:12px; font-weight:bold; color:var(--primary); min-width:35px;">90%</span>
                          </div>
                      </div>
                    </div>
                </div>
              </div>

              <div class="design-section">
                <div class="design-section-title">
                  <i class="fas fa-window-maximize"></i> Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù‡ÙŠØ¯Ø± (Header)
                </div>

                <div style="margin-bottom: 20px;">
                  <label class="form-label">ØµÙˆØ±Ø© Ø§Ù„ØºÙ„Ø§Ù</label>
                  <div style="display: flex; align-items: center; gap: 10px;">
                    <img id="hero-preview" class="img-preview" style="width: 80px; height: 50px; border-radius:8px; display:block;">
                    <label for="ui-heroFile" class="custom-file-upload" style="margin: 0; flex:1;">
                      <i class="fas fa-image"></i> ØªØºÙŠÙŠØ± Ø§Ù„ØºÙ„Ø§Ù
                    </label>
                    <input type="file" id="ui-heroFile" accept="image/*" onchange="handleHeroUpload(this)">
                  </div>
                  
                  <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:10px;">
                      <div style="background:var(--bg); padding:10px; border-radius:8px;">
                          <label style="font-size:11px; display:block; color:var(--secondary)">Ø§Ø±ØªÙØ§Ø¹ Ø§Ù„ØºÙ„Ø§Ù</label>
                          <input type="range" min="150" max="400" value="200" id="ui-heroHeight" oninput="setUiParam('heroHeight', this.value)" style="width:100%">
                      </div>
                      <div style="background:var(--bg); padding:10px; border-radius:8px;">
                          <label style="font-size:11px; display:block; color:var(--secondary)">ØªØ¹ØªÙŠÙ… Ø§Ù„ØµÙˆØ±Ø©</label>
                          <input type="range" min="0" max="90" value="30" id="ui-heroOverlay" oninput="setUiParam('heroOverlay', this.value)" style="width:100%">
                      </div>
                  </div>
                </div>

                <div style="background:#f8fafc; padding:15px; border-radius:12px; border:1px dashed #cbd5e1;">
                   <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:10px;">
                      <div style="display:flex; align-items:center; gap:10px;">
                          <label class="toggle-switch">
                            <input type="checkbox" id="ui-showResName" onchange="setUiParam('showResName', this.checked)">
                            <span class="slider"></span>
                          </label>
                          <span style="font-size:14px; font-weight:bold;">Ø§Ø³Ù… Ø§Ù„Ù…Ø·Ø¹Ù…</span>
                      </div>
                      <input type="color" id="ui-resNameColor" oninput="setUiParam('resNameColor', this.value)" style="width:30px; height:30px; border:none; padding:0; background:none;">
                   </div>
                   <input type="text" id="ui-customResName" placeholder="Ø§Ø³ØªØ®Ø¯Ù… Ø§Ø³Ù…Ø§Ù‹ Ù…Ø®ØµØµØ§Ù‹ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)" oninput="setUiParam('customResName', this.value)" style="font-size:12px; margin-bottom:15px;">

                   <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:10px;">
                      <div style="display:flex; align-items:center; gap:10px;">
                          <label class="toggle-switch">
                            <input type="checkbox" id="ui-showResDesc" onchange="setUiParam('showResDesc', this.checked)">
                            <span class="slider"></span>
                          </label>
                          <span style="font-size:14px; font-weight:bold;">Ø§Ù„ÙˆØµÙ Ø§Ù„Ù…Ø®ØªØµØ±</span>
                      </div>
                      <input type="color" id="ui-resDescColor" oninput="setUiParam('resDescColor', this.value)" style="width:30px; height:30px; border:none; padding:0; background:none;">
                   </div>
                   <input type="text" id="ui-customResDesc" placeholder="ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ÙˆØµÙ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)" oninput="setUiParam('customResDesc', this.value)" style="font-size:12px;">
                   
                   <div style="width:100%; height:1px; background:#cbd5e1; margin:15px 0;"></div>

                   <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:10px;">
                      <div style="display:flex; align-items:center; gap:10px;">
                          <label class="toggle-switch">
                            <input type="checkbox" id="ui-showSearch" onchange="setUiParam('showSearch', this.checked)">
                            <span class="slider"></span>
                          </label>
                          <span style="font-size:14px; font-weight:bold;">Ø´Ø±ÙŠØ· Ø§Ù„Ø¨Ø­Ø«</span>
                      </div>
                   </div>
                   <input type="text" id="ui-searchPlaceholder" placeholder="Ù†Øµ Ø§Ù„Ø¨Ø­Ø« (Ù…Ø«Ø§Ù„: Ø§Ø¨Ø­Ø« Ø¹Ù† ÙˆØ¬Ø¨ØªÙƒ...)" oninput="setUiParam('searchPlaceholder', this.value)" style="font-size:12px; margin-bottom:15px;">

                   <label style="font-size:12px; font-weight:bold; margin-bottom:5px; display:block;">Ù…Ø­Ø§Ø°Ø§Ø© Ù†ØµÙˆØµ Ø§Ù„Ù‡ÙŠØ¯Ø±</label>
                   <select id="ui-headerAlign" onchange="setUiParam('headerTextAlignment', this.value)" style="height:40px; font-size:13px;">
                      <option value="center">ÙˆØ³Ø· (Center)</option>
                      <option value="right">ÙŠÙ…ÙŠÙ† (Right)</option>
                      <option value="left">ÙŠØ³Ø§Ø± (Left)</option>
                   </select>

                   <div style="margin-top:10px;">
                       <label style="font-size:12px; font-weight:bold; margin-bottom:5px; display:block;">Ù…ÙƒØ§Ù† Ø§Ø³Ù… Ø§Ù„Ù…Ø·Ø¹Ù…</label>
                       <select id="ui-resNamePosition" onchange="setUiParam('resNamePosition', this.value)" style="height:40px; font-size:13px;">
                          <option value="inside">Ø¯Ø§Ø®Ù„ Ø§Ù„Ù‡ÙŠØ¯Ø± (Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ)</option>
                          <option value="below">ØªØ­Øª ØµÙˆØ±Ø© Ø§Ù„Ù‡ÙŠØ¯Ø±</option>
                       </select>
                   </div>

                </div>
              </div>

              <div class="design-section">
                <div class="design-section-title">
                  <i class="fas fa-th"></i> Ø´ÙƒÙ„ Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª
                </div>
                
                <div class="layout-options-grid" style="grid-template-columns: repeat(3, 1fr);">
                  <button class="btn-layout active" onclick="setUiParam('layoutType', 'modern')" id="btn-layout-modern">
                    <i class="fas fa-bolt" style="color:#f59e0b"></i> <span>Ù…ÙˆØ¯Ø±Ù†</span>
                  </button>
                  <button class="btn-layout" onclick="setUiParam('layoutType', 'grid')" id="btn-layout-grid">
                    <i class="fas fa-border-all" style="color:#3b82f6"></i> <span>Ø´Ø¨ÙƒØ©</span>
                  </button>
                  <button class="btn-layout" onclick="setUiParam('layoutType', 'list')" id="btn-layout-list">
                    <i class="fas fa-list" style="color:#10b981"></i> <span>Ù‚Ø§Ø¦Ù…Ø©</span>
                  </button>
                  <button class="btn-layout" onclick="setUiParam('layoutType', 'focus')" id="btn-layout-focus">
                    <i class="fas fa-image" style="color:#8b5cf6"></i> <span>ØµÙˆØ± ÙƒØ¨ÙŠØ±Ø©</span>
                  </button>
                  <button class="btn-layout" onclick="setUiParam('layoutType', 'magazine')" id="btn-layout-magazine">
                    <i class="fas fa-newspaper" style="color:#ef4444"></i> <span>Ù…Ø¬Ù„Ø©</span>
                  </button>
                  <button class="btn-layout" onclick="setUiParam('layoutType', 'minimal')" id="btn-layout-minimal">
                    <i class="fas fa-align-left" style="color:#64748b"></i> <span>Ø¨Ø³ÙŠØ·</span>
                  </button>
                </div>

                <div style="margin-top: 15px; display:flex; justify-content:space-between; align-items:center;">
                    <label class="form-label" style="margin:0">Ø§Ù†Ø­Ù†Ø§Ø¡ Ø§Ù„ÙƒØ±ÙˆØª (Radius)</label>
                    <div style="display:flex; align-items:center; gap:5px;">
                        <input type="range" min="0" max="30" id="ui-cardRadius" oninput="setUiParam('cardRadius', this.value)">
                        <span id="radius-val" style="font-weight:bold; color:var(--primary); width:30px; text-align:center;">16</span>px
                    </div>
                </div>
                <div style="margin-top: 10px;">
                    <label class="form-label">Ø³ØªØ§ÙŠÙ„ Ø§Ù„ÙƒØ§Ø±Øª</label>
                    <select id="ui-cardStyle" onchange="setUiParam('cardStyle', this.value)">
                      <option value="solid">Solid (Ù…ØµÙ…Øª)</option>
                      <option value="glass">Glass (Ø²Ø¬Ø§Ø¬ÙŠ Ø´ÙØ§Ù)</option>
                      <option value="outlined">Outlined (Ø¥Ø·Ø§Ø± ÙÙ‚Ø·)</option>
                    </select>
                </div>
              </div>

              <div style="position: sticky; bottom: 0; background: var(--bg); padding: 15px 0; border-top: 1px solid var(--border-color); display:flex; gap:10px; z-index:10;">
                <button class="btn btn-outline" onclick="resetDesign()" style="flex: 1; border-color: var(--danger); color: var(--danger);">
                  <i class="fas fa-undo"></i> Ø§Ø³ØªØ¹Ø§Ø¯Ø©
                </button>
                <button class="btn btn-success" onclick="saveDesignSettings()" style="flex: 2; font-size: 16px; box-shadow: 0 4px 15px rgba(16, 185, 129, 0.2);">
                  <i class="fas fa-save"></i> Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª
                </button>
              </div>

            </div>

            <div class="design-preview-pane">
               <div class="phone-frame">
                 <iframe id="live-preview" src="" scrolling="yes"></iframe>
               </div>
            </div>

          </div>
        </div>
    <input type="hidden" id="restaurant-id" />
<input type="hidden" id="setting-print-num" value="true" />

    <script>
      const urlParams = new URLSearchParams(window.location.search);
      const urlToken = urlParams.get("t");

      if (urlToken) {
        sessionStorage.setItem("ownerToken", urlToken);

        window.history.replaceState(
          {},
          document.title,
          window.location.pathname,
        );
      }

      let token = sessionStorage.getItem("ownerToken");

      let categoriesData = [];
      let stockItemsData = [];
      let currentIngredients = [];
      let editingProductId = null;
      let editingAccEmpId = null; // Ù…ØªØºÙŠØ± Ù„ØªØ®Ø²ÙŠÙ† Ù‡ÙˆÙŠØ© Ø§Ù„Ù…ÙˆØ¸Ù Ø§Ù„Ù…Ø±Ø§Ø¯ ØªØ¹Ø¯ÙŠÙ„Ù‡
      let currentUserRole = null;
      let serverTimeOffset = 0;

      if (localStorage.getItem("theme") === "dark") {
        document.body.classList.add("dark-mode");
      }

      async function initDashboard() {
        try {
          const res = await fetch("/api/v1/restaurants/my-restaurant", {
            headers: { Authorization: `Bearer ${token}` },
          });

          const serverDateHeader = res.headers.get("date");
          if (serverDateHeader) {
            const serverTime = new Date(serverDateHeader).getTime();
            const localTime = Date.now();
            serverTimeOffset = serverTime - localTime;
          }

          // === Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø¥ØµÙ„Ø§Ø­ ===
          const text = await res.text();
          let result;
          try {
            result = JSON.parse(text);
          } catch (err) {
            console.error("Server Error (initDashboard):", text);
            return;
          }
          // === Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø¥ØµÙ„Ø§Ø­ ===

          if (result.status === "success") {
            const data = result.data;
            document.getElementById("restaurant-id").value = data.restaurant._id;
            document.getElementById("preview-link").href = `/menu/${data.restaurant.slug}`;

            // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…ØªØ¬Ø±
            document.getElementById("set-orderMode").value = data.restaurant.orderMode || "whatsapp";
            // ØªÙ‡ÙŠØ¦Ø© Ù†Ø¸Ø§Ù… Ø§Ù„Ø­Ø¬Ø²
            initReservationUI(data);
            document.getElementById("set-taxRate").value = data.restaurant.taxRate || 0;
            document.getElementById("set-serviceRate").value = data.restaurant.serviceRate || 0;
            document.getElementById("set-useTableNumbers").checked = data.restaurant.useTableNumbers === true;
            document.getElementById("set-enableCoupons").checked = data.restaurant.enableCoupons === true;
            // ØªØ­Ù…ÙŠÙ„ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø­Ø§Ø³Ø¨Ø©
            if(data.restaurant.accountingSettings) {
                document.getElementById("acc-set-overtime").value = data.restaurant.accountingSettings.overtimeRate || 0;
                document.getElementById("acc-set-late").value = data.restaurant.accountingSettings.latePenalty || 0;
                document.getElementById("acc-set-absence").value = data.restaurant.accountingSettings.absencePenalty || 1;
            }
            
            // Ø¥Ø¹Ø¯Ø§Ø¯ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø±Ù‚Ù…
            const localPrintSetting = localStorage.getItem("localPrintOrderNum");
            let shouldPrintNum = localPrintSetting !== null ? (localPrintSetting === "true") : (data.restaurant.printOrderNumber !== false);
            document.getElementById("set-printOrderNum").checked = shouldPrintNum;
            document.getElementById("setting-print-num").value = shouldPrintNum;

            if (data.restaurant.contactInfo) {
              document.getElementById("set-whatsapp").value = data.restaurant.contactInfo.whatsapp || "";
            }

            applyPermissions(data.userRole);
            currentUserRole = data.userRole;
            if (data.shiftStart) sessionStorage.setItem("shiftStart", data.shiftStart);
            if (data.shiftEnd) sessionStorage.setItem("shiftEnd", data.shiftEnd);

            // === ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ø­ÙŠØ© Ù„Ù„Ø­Ø¬ÙˆØ²Ø§Øª ===
            const socket = io();
            socket.emit("join-restaurant", data.restaurant._id);

            // 1. Ø¹Ù†Ø¯ ÙˆØµÙˆÙ„ Ø·Ù„Ø¨ Ø­Ø¬Ø² Ø¬Ø¯ÙŠØ¯
            socket.on("new_reservation_request", (payload) => {
                // ØªØ´ØºÙŠÙ„ ØµÙˆØª ØªÙ†Ø¨ÙŠÙ‡
                const audio = new Audio('https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3'); 
                audio.play().catch(e => console.log('Audio play failed'));
                
                // Ø¥Ø¸Ù‡Ø§Ø± Ø±Ø³Ø§Ù„Ø© Ù…Ù†Ø¨Ø«Ù‚Ø©
                Swal.fire({
                    toast: true,
                    position: 'top-end',
                    icon: 'info',
                    title: `ğŸ”” Ø·Ù„Ø¨ Ø­Ø¬Ø² Ø¬Ø¯ÙŠØ¯: ${payload.name} (${payload.seats} Ù…Ù‚Ø¹Ø¯)`,
                    showConfirmButton: false,
                    timer: 5000
                });

                // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø£ÙˆÙ†Ø± ÙØ§ØªØ­ ØµÙØ­Ø© Ø§Ù„Ø­Ø¬ÙˆØ²Ø§ØªØŒ Ù†Ø­Ø¯Ø« Ø§Ù„Ø¬Ø¯ÙˆÙ„ ÙÙˆØ±Ø§Ù‹
                if(!document.getElementById('view-reservations').classList.contains('hidden')) {
                    loadReservations();
                }
            });

            // 2. ØªØ­Ø¯ÙŠØ« Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ù‚Ø§Ø¹Ø¯ ÙÙŠ ØµÙØ­Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
            socket.on("seats_updated", (payload) => {
                 if(document.getElementById('res-booked-display')) {
                     updateReservationStats(payload.total, payload.booked);
                 }
            });
            // =======================================

            // ØªØ´ØºÙŠÙ„ ØªØ­Ø°ÙŠØ± Ø§Ù„ÙØªØ±Ø© Ø§Ù„ØªØ¬Ø±ÙŠØ¨ÙŠØ© Ø¥Ø°Ø§ ÙˆØ¬Ø¯
            if (data.restaurant.owner && data.restaurant.owner.isTrial && typeof checkTrialWarning === 'function') {
                // Ù†ØµÙ†Ø¹ ÙƒØ§Ø¦Ù† ØªØ­Ø°ÙŠØ± ÙˆÙ‡Ù…ÙŠ Ø¨Ù†Ø§Ø¡ Ø¹Ù„Ù‰ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                const trialWarning = { message: "Ø£Ù†Øª ØªØ³ØªØ®Ø¯Ù… Ø­Ø³Ø§Ø¨ ØªØ¬Ø±ÙŠØ¨ÙŠ. Ø³ØªÙÙ‚Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø¹Ø¯ Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„ÙØªØ±Ø©." };
                checkTrialWarning(trialWarning);
            }
            // Ù„Ùˆ Ø§Ù„Ø¨Ø§Ùƒ Ø§Ù†Ø¯ Ø¨ÙŠØ¨Ø¹Øª warning Ø¬Ø§Ù‡Ø²
            if (data.warning && typeof checkTrialWarning === 'function') {
                 checkTrialWarning(data.warning);
            }

            // Ø¹Ø±Ø¶ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
            const roleNames = { owner: "Ø§Ù„Ù…Ø§Ù„Ùƒ", cashier: "Ø§Ù„ÙƒØ§Ø´ÙŠØ±", kitchen: "Ø§Ù„Ù…Ø·Ø¨Ø®" };
            const roleAr = roleNames[currentUserRole] || currentUserRole;
            const userName = sessionStorage.getItem("currentUserName") || "Ù…Ø³ØªØ®Ø¯Ù…";

            document.getElementById("page-title").innerHTML = `
                <div>${data.restaurant.restaurantName}</div>
                <div style="font-size:14px; color:var(--secondary); font-weight:normal; margin-top:5px;">
                    <i class="fas fa-user-circle"></i> ${userName} <span class="badge" style="background:var(--primary); color:white; font-size:12px;">${roleAr}</span>
                </div>
            `;

            document.getElementById("dashboard-section").classList.remove("hidden");
            
            if (data.userRole === "cashier" || data.userRole === "kitchen") {
              checkShiftStatus(data.userRole);
            }
            
            // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ù„Ù„ÙƒØ§Ø´ÙŠØ± ÙˆØ§Ù„Ø£ÙˆÙ†Ø±
            if (data.userRole === "owner" || data.userRole === "cashier") {
              loadCategories();
              loadProducts();
            }

            if (data.userRole === "owner") {
              initDesignStudio(data.restaurant);
              
              // ğŸŸ¢ Ø¥ØµÙ„Ø§Ø­ Ù…Ù†Ø·Ù‚ Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø®Ø§Ø²Ù† (ÙŠØ¹ØªÙ…Ø¯ Ø§Ù„Ø¢Ù† Ø¹Ù„Ù‰ Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ù‚Ø§Ø¯Ù…Ø© Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±)
              const isStockEnabled = data.hasStock;

              if (isStockEnabled) {
                // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø¹Ù†Ø§ØµØ±
                document.getElementById('nav-stock').classList.remove('hidden');
                if (data.hasAccounting) {
        document.getElementById('nav-accounting').classList.remove('hidden');
    } else {
        document.getElementById('nav-accounting').classList.add('hidden');
    }
                document.getElementById('nav-recipes').classList.remove('hidden');
                document.getElementById('ingredients-section').classList.remove('hidden');
                if(document.getElementById('mob-nav-stock')) document.getElementById('mob-nav-stock').classList.remove('hidden');
                
                loadStockItems(); 
              } else {
                // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø¹Ù†Ø§ØµØ± (Ù„Ø¶Ù…Ø§Ù† Ø§Ø®ØªÙØ§Ø¦Ù‡Ø§ Ù„Ùˆ Ø§Ù„Ù…ÙŠØ²Ø© Ø§ØªÙ„ØºØª)
                document.getElementById('nav-stock').classList.add('hidden');
                document.getElementById('nav-recipes').classList.add('hidden');
                document.getElementById('ingredients-section').classList.add('hidden');
                if(document.getElementById('mob-nav-stock')) document.getElementById('mob-nav-stock').classList.add('hidden');
              }
            }

            // ØªÙˆØ¬ÙŠÙ‡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„Ø¢Ø®Ø± ØµÙØ­Ø© ÙƒØ§Ù† ÙÙŠÙ‡Ø§
            const lastView = localStorage.getItem("lastActiveView");
            if (data.userRole === "kitchen") switchView("orders");
            else if (data.userRole === "cashier") {
              if (lastView === "history") switchView("history");
              else switchView("orders");
            } else {
              if (lastView && lastView !== "orders") switchView(lastView);
              else switchView("categories");
            }

          } else {
             // Handle Errors
             if (res.status === 401) {
              sessionStorage.removeItem("ownerToken");
              window.location.href = "/login";
            } else {
              Swal.fire({ icon: "warning", title: "ØªÙ†Ø¨ÙŠÙ‡", text: result.message || "Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª" })
              .then(() => { window.location.href = "/login"; });
            }
          }
        } catch (e) {
          console.error(e);
          Swal.fire("Ø®Ø·Ø£", "ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±", "error");
        }
      }
      function toggleDarkMode() {
        document.body.classList.toggle("dark-mode");
        localStorage.setItem(
          "theme",
          document.body.classList.contains("dark-mode") ? "dark" : "light",
        );
      }

      function toggleSidebar() {
        const sidebar = document.getElementById("sidebar");
        const overlay = document.querySelector(".overlay");
        
        if (sidebar.classList.contains("active")) {
            sidebar.classList.remove("active");
            overlay.classList.remove("visible");
            setTimeout(() => { overlay.style.display = "none"; }, 300);
        } else {
            overlay.style.display = "block";
            // Timeout to allow display:block to apply before opacity transition
            setTimeout(() => { 
                sidebar.classList.add("active");
                overlay.classList.add("visible");
            }, 10);
        }
      }
      function previewImage(input, previewId) {
        const preview = document.getElementById(previewId);
        if (input.files && input.files[0]) {
          const reader = new FileReader();
          reader.onload = function (e) {
            preview.src = e.target.result;
            preview.style.display = "block";
          };
          reader.readAsDataURL(input.files[0]);
        } else {
          preview.src = "";
          preview.style.display = "none";
        }
      }

// --- Reservation Logic ---
async function loadReservations() {
    const list = document.getElementById("res-requests-list");
    if(!list) return;
    list.innerHTML = '<tr><td colspan="6" style="text-align:center; padding:20px;">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„... <i class="fas fa-spinner fa-spin"></i></td></tr>';
    
    try {
        const res = await fetch('/api/v1/reservations/list', {
            headers: { Authorization: `Bearer ${token}` }
        });
        const data = await res.json();
        
        if(data.status === 'success') {
            list.innerHTML = "";
            if(!data.data.reservations || data.data.reservations.length === 0) {
                list.innerHTML = '<tr><td colspan="6" style="text-align:center; padding:20px; color:#64748b;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ø­Ø¬Ø² Ø­Ø§Ù„ÙŠØ§Ù‹</td></tr>';
                return;
            }
            
            data.data.reservations.forEach(r => {
                let statusBadge = '';
                let actions = '';
                
                if(r.status === 'pending') {
                    statusBadge = '<span class="badge" style="background:#f59e0b; color:white">Ø§Ù†ØªØ¸Ø§Ø±</span>';
                    actions = `
                        <button onclick="updateResStatus('${r._id}', 'approved')" class="btn btn-success" style="padding:5px 10px; font-size:12px;">Ù‚Ø¨ÙˆÙ„</button>
                        <button onclick="updateResStatus('${r._id}', 'rejected')" class="btn btn-outline" style="padding:5px 10px; font-size:12px; color:#ef4444; border-color:#ef4444;">Ø±ÙØ¶</button>
                    `;
                } else if(r.status === 'approved') {
                    statusBadge = '<span class="badge" style="background:#10b981; color:white">Ù…Ù‚Ø¨ÙˆÙ„</span>';
                    actions = `<button onclick="updateResStatus('${r._id}', 'rejected')" class="btn btn-outline" style="padding:5px 10px; font-size:12px; color:#ef4444; border-color:#ef4444;">Ø¥Ù„ØºØ§Ø¡</button>`;
                } else {
                    statusBadge = '<span class="badge" style="background:#ef4444; color:white">Ù…Ø±ÙÙˆØ¶</span>';
                    actions = '-';
                }

                const date = new Date(r.createdAt).toLocaleString('ar-EG');
                
                list.innerHTML += `
                    <tr>
                        <td>${r.name}</td>
                        <td>${r.phone}</td>
                        <td style="font-weight:bold; color:var(--primary)">${r.seats}</td>
                        <td style="font-size:12px; direction:ltr">${date}</td>
                        <td>${statusBadge}</td>
                        <td><div style="display:flex; gap:5px;">${actions}</div></td>
                    </tr>
                `;
            });
        }
    } catch(e) {
        console.error(e);
        list.innerHTML = '<tr><td colspan="6" style="text-align:center; color:red;">ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±</td></tr>';
    }
}

async function updateResStatus(id, status) {
    if(!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† ØªØºÙŠÙŠØ± Ø§Ù„Ø­Ø§Ù„Ø©ØŸ')) return;
    
    try {
        const res = await fetch(`/api/v1/reservations/action/${id}`, {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${token}` },
            body: JSON.stringify({ status })
        });
        const data = await res.json();
        if(data.status === 'success') {
            Swal.fire({toast:true, icon:'success', title:'ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø¨Ù†Ø¬Ø§Ø­'});
            loadReservations();
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø¯Ø§Ø¯ ÙÙŠ ØµÙØ­Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù„Ùˆ Ù…ÙØªÙˆØ­Ø©
            const rId = document.getElementById("restaurant-id").value;
            // ÙŠÙ…ÙƒÙ† Ù‡Ù†Ø§ Ø¥Ø¹Ø§Ø¯Ø© Ø·Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø·Ø¹Ù… Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø¯Ø§Ø¯Ø§Øª
        } else {
            Swal.fire('Ø®Ø·Ø£', data.message, 'error');
        }
    } catch(e) {
        Swal.fire('Ø®Ø·Ø£', 'ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„', 'error');
    }
}

function switchView(viewName) {
    if(viewName === 'reservations') setTimeout(loadReservations, 100);
        Swal.close(); // Ø¥ØºÙ„Ø§Ù‚ Ø£ÙŠ ØªÙˆØ³Øª Ø£Ùˆ ØªÙ†Ø¨ÙŠÙ‡ Ù…ÙØªÙˆØ­ ÙÙˆØ±Ø§Ù‹
        // Ø­ÙØ¸ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ø¹Ø´Ø§Ù† Ù„Ù…Ø§ ØªØ¹Ù…Ù„ Ø±ÙŠÙØ±ÙŠØ´ ØªØ±Ø¬Ø¹ Ù„Ù‡Ø§
        localStorage.setItem("lastActiveView", viewName);

        // 1. Scroll to top automatically
        window.scrollTo({ top: 0, behavior: 'smooth' });

        // 2. Hide all views and remove active states
        // ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© "recipes" Ùˆ "design" Ù„Ù„Ù‚Ø§Ø¦Ù…Ø© Ù„Ø¥ØµÙ„Ø§Ø­ Ù…Ø´ÙƒÙ„Ø© Ø¹Ø¯Ù… Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ØªØµÙ…ÙŠÙ…
const allViews = ["categories", "products", "recipes", "bulk", "orders", "history", "stock", "settings", "staff", "manual-pos", "design", "coupons", "accounting", "reservations"];
        
        allViews.forEach((v) => {
            const el = document.getElementById(`view-${v}`);
            if (el) {
                el.classList.add("hidden");
                el.classList.remove("view-animate"); // Reset animation
            }

            // Desktop Sidebar
            const nav = document.getElementById(`nav-${v}`);
            if (nav) nav.classList.remove("active");
            
            // Mobile Bottom Nav
            const mobNav = document.getElementById(`mob-nav-${v}`);
            if (mobNav) mobNav.classList.remove("active");
        });

        // 3. Show Target View with Animation
        const targetEl = document.getElementById(`view-${viewName}`);
        if (targetEl) {
            targetEl.classList.remove("hidden");
            // Trigger reflow to restart animation
            void targetEl.offsetWidth; 
            targetEl.classList.add("view-animate");
        }

        // 4. Update Active Buttons
        const targetNav = document.getElementById(`nav-${viewName}`);
        if (targetNav) targetNav.classList.add("active");

        const targetMobNav = document.getElementById(`mob-nav-${viewName}`);
        if (targetMobNav) targetMobNav.classList.add("active");

        // 5. Close Mobile Sidebar if Open
        if (window.innerWidth <= 768) {
            const sidebar = document.getElementById("sidebar");
            const overlay = document.querySelector(".overlay");
            if (sidebar && sidebar.classList.contains("active")) {
                sidebar.classList.remove("active");
            }
            if (overlay) {
                overlay.classList.remove("visible");
                setTimeout(() => { overlay.style.display = 'none'; }, 300);
            }
        }

        // 6. View Specific Logic (Load Data)
        if (viewName === "orders") {
            const badge = document.getElementById("live-badge");
            if (badge) { badge.innerText = "0"; badge.classList.add("hidden"); }
            
            const mobBadge = document.getElementById("mob-badge");
            if (mobBadge) mobBadge.classList.add("hidden");

            if (typeof window.loadOrders === 'function') window.loadOrders();
        }

        if (viewName === "bulk") {
            // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø£ÙˆÙ„Ø§Ù‹ Ø¥Ø°Ø§ Ù„Ù… ØªÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø©
            if (categoriesData.length === 0) {
                loadCategories().then(() => {
                     const bulkContainer = document.getElementById("bulk-container");
                     if (bulkContainer && bulkContainer.innerHTML.trim() === "") {
                         addBulkRows(1);
                     }
                });
            } else {
                const bulkContainer = document.getElementById("bulk-container");
                if (bulkContainer && bulkContainer.innerHTML.trim() === "") {
                    addBulkRows(1);
                }
            }
        }

        if (viewName === "history") {
            if (typeof window.loadHistory === 'function') window.loadHistory();
        }

        if (viewName === "coupons") {
            if (typeof loadCoupons === 'function') loadCoupons();
        }
        if (viewName === "recipes") {
            if (typeof initRecipesView === 'function') initRecipesView();
        }
        if (viewName === "manual-pos") {
            initPosSystem();
        }
      }
      function isNumberKey(evt) {
        var charCode = evt.which ? evt.which : evt.keyCode;
        if (charCode != 46 && charCode > 31 && (charCode < 48 || charCode > 57))
          return false;
        return true;
      }

      function logout() {
        sessionStorage.removeItem("ownerToken");
        localStorage.removeItem("ownerToken");
        location.reload();
      }

      // --- Reservation System Logic ---
      function initReservationUI(data) {
          const settings = data.restaurant.reservationSettings || { isEnabled: false, totalSeats: 0, bookedSeats: 0 };
          
          document.getElementById('res-enable').checked = settings.isEnabled;
          document.getElementById('res-total-seats').value = settings.totalSeats;
          
          updateReservationStats(settings.totalSeats, settings.bookedSeats);

          // Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø±Ø§Ø¨Ø·
          const link = `${window.location.origin}/reserve/${data.restaurant.slug}`;
          document.getElementById('res-link-input').value = link;
          document.getElementById('res-link-btn').href = link;
      }

      function updateReservationStats(total, booked) {
          const available = total - booked;
          document.getElementById('res-booked-display').innerText = booked;
          const availEl = document.getElementById('res-available-display');
          availEl.innerText = available > 0 ? available : "0 (Ù…ÙƒØªÙ…Ù„)";
          availEl.style.color = available > 0 ? "var(--success)" : "var(--danger)";
      }

      async function saveReservationSettings() {
          const rId = document.getElementById("restaurant-id").value;
          const isEnabled = document.getElementById('res-enable').checked;
          const totalSeats = document.getElementById('res-total-seats').value;

          if(isEnabled && !totalSeats) return Swal.fire('ØªÙ†Ø¨ÙŠÙ‡', 'ÙŠØ¬Ø¨ ØªØ­Ø¯ÙŠØ¯ Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ù‚Ø§Ø¹Ø¯', 'warning');

          try {
              const res = await fetch('/api/v1/reservations/settings', {
                  method: 'PATCH',
                  headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${token}` },
                  body: JSON.stringify({ restaurantId: rId, isEnabled, totalSeats })
              });
              const data = await res.json();
              if(data.status === 'success') {
                  const s = data.data.reservationSettings;
                  updateReservationStats(s.totalSeats, s.bookedSeats);
                  Swal.fire({ toast: true, icon: 'success', title: 'ØªÙ… Ø­ÙØ¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø­Ø¬Ø²' });
              }
          } catch(e) { console.error(e); }
      }

      async function resetReservationCounter() {
          const result = await Swal.fire({
              title: 'ØªØµÙÙŠØ± Ø§Ù„Ø¹Ø¯Ø§Ø¯ØŸ',
              text: "Ø³ÙŠØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ© ÙˆØ¥ØªØ§Ø­Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù‚Ø§Ø¹Ø¯ Ù…Ù† Ø¬Ø¯ÙŠØ¯.",
              icon: 'warning',
              showCancelButton: true,
              confirmButtonText: 'Ù†Ø¹Ù…ØŒ ØªØµÙÙŠØ±',
              cancelButtonText: 'Ø¥Ù„ØºØ§Ø¡'
          });

          if (result.isConfirmed) {
              const rId = document.getElementById("restaurant-id").value;
              try {
                  const res = await fetch('/api/v1/reservations/settings', {
                      method: 'PATCH',
                      headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${token}` },
                      body: JSON.stringify({ restaurantId: rId, resetCounter: true })
                  });
                  const data = await res.json();
                  if(data.status === 'success') {
                      const s = data.data.reservationSettings;
                      updateReservationStats(s.totalSeats, s.bookedSeats);
                      Swal.fire('ØªÙ…', 'ØªÙ… ØªØµÙÙŠØ± Ø§Ù„Ø¹Ø¯Ø§Ø¯ Ø¨Ù†Ø¬Ø§Ø­', 'success');
                  }
              } catch(e) { console.error(e); }
          }
      }

      function copyResLink() {
          const copyText = document.getElementById("res-link-input");
          copyText.select();
          document.execCommand("copy");
          Swal.fire({ toast: true, icon: 'success', title: 'ØªÙ… Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø·' });
      }

      // --- Ø¯ÙˆØ§Ù„ Ø§Ù„Ù…Ø­Ø§Ø³Ø¨Ø© Ø§Ù„Ø¢Ù„ÙŠØ© ---

      async function saveAccSettings() {
          const rId = document.getElementById("restaurant-id").value;
          const body = {
              overtimeRate: Number(document.getElementById("acc-set-overtime").value),
              latePenalty: Number(document.getElementById("acc-set-late").value),
              absencePenalty: Number(document.getElementById("acc-set-absence").value)
          };

          try {
              const res = await fetch(`/api/v1/restaurants/accounting-settings/${rId}`, {
                  method: 'PATCH',
                  headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${token}` },
                  body: JSON.stringify(body)
              });
              if(res.ok) Swal.fire({toast:true, icon:'success', title:'ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù‚ÙˆØ§Ø¹Ø¯ Ø§Ù„Ù…Ø­Ø§Ø³Ø¨ÙŠØ©'});
          } catch(e) { console.error(e); }
      }

      // ğŸŸ¢ Ø¯Ø§Ù„Ø© Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙÙˆØ±ÙŠ (Excel-like)
      async function updatePayrollRow(payrollId, inputElement, field) {
          const row = document.getElementById(`pay-row-${payrollId}`);
          // Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø©ØŒ ÙˆØ¥Ù† Ù„Ù… ØªÙˆØ¬Ø¯ (Ø¨Ø³Ø¨Ø¨ Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø³Ø±ÙŠØ¹) Ù†Ø­Ø§ÙˆÙ„ Ø¬Ù„Ø¨Ù‡Ø§ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰
          let statusIcon = document.getElementById(`status-${payrollId}`);
          
          const newVal = Number(inputElement.value);
          
          if(newVal < 0) { inputElement.value = 0; return; }

          // ØªØºÙŠÙŠØ± Ø§Ù„Ø­Ø§Ù„Ø© Ù„Ù€ "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸" (ÙÙ‚Ø· Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø© Ù…ÙˆØ¬ÙˆØ¯Ø©)
          if (statusIcon) {
              statusIcon.className = "fas fa-spinner fa-spin";
              statusIcon.style.color = "var(--primary)";
          }
          row.style.background = "#f0f9ff";

          try {
              const body = {};
              body[field] = newVal;

              const res = await fetch(`/api/v1/accounting/payroll/${payrollId}`, {
                  method: 'PATCH',
                  headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${token}` },
                  body: JSON.stringify(body)
              });
              
              const result = await res.json();
              
              if(result.status === "success") {
                  // Ø¹Ù†Ø¯ Ø§Ù„Ù†Ø¬Ø§Ø­ Ù†Ø¹ÙŠØ¯ Ø±Ø³Ù… Ø§Ù„Ø®Ù„ÙŠØ© Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ Ù„Ø¶Ù…Ø§Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ù€ ID Ø§Ù„ØµØ­ÙŠØ­ Ù„Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø©
                  const netCell = document.getElementById(`net-${payrollId}`);
                  if(netCell) {
                      netCell.innerHTML = `${result.data.totalSalary} Ø¬.Ù… <i id="status-${payrollId}" class="fas fa-check-circle" style="margin-right:5px; font-size:12px; color:var(--success);"></i>`;
                  }
                  
                  if(row) setTimeout(() => row.style.background = "white", 500);
              }
          } catch(e) {
              console.error(e);
              if(statusIcon) {
                  statusIcon.className = "fas fa-exclamation-circle";
                  statusIcon.style.color = "var(--danger)";
              }
              Swal.fire({toast:true, icon:'error', title:'ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸'});
          }
      }

      async function saveSettings() {
        const rId = document.getElementById("restaurant-id").value;
        const orderMode = document.getElementById("set-orderMode").value;
        const useTables = document.getElementById(
          "set-useTableNumbers",
        ).checked;
        const enableCoupons =
          document.getElementById("set-enableCoupons").checked;
        // Ù‚Ø±Ø§Ø¡Ø© Ù‚ÙŠÙ…Ø© Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø±Ù‚Ù…
        const printOrderNum = document.getElementById("set-printOrderNum").checked;
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ù‚Ù„ Ø§Ù„Ù…Ø®ÙÙŠ ÙˆØªØ®Ø²ÙŠÙ† Ø§Ù„Ù‚ÙŠÙ…Ø© Ù…Ø­Ù„ÙŠØ§Ù‹ Ù„Ø¶Ù…Ø§Ù† Ø¹Ø¯Ù… Ø¶ÙŠØ§Ø¹Ù‡Ø§
        document.getElementById("setting-print-num").value = printOrderNum;
        localStorage.setItem("localPrintOrderNum", printOrderNum);

        const whatsapp = document.getElementById("set-whatsapp").value;
        const taxRate = document.getElementById("set-taxRate").value;
        const serviceRate = document.getElementById("set-serviceRate").value;

        const bodyData = {
          orderMode: orderMode,
          taxRate: taxRate,
          serviceRate: serviceRate,
          useTableNumbers: useTables,
          enableCoupons: enableCoupons,
          printOrderNumber: printOrderNum, // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ù„Ù„Ø¨Ø§Ùƒ Ø§Ù†Ø¯
          contactInfo: {
            whatsapp: whatsapp,
          },
        };

        Swal.showLoading();
        try {
          const res = await fetch(`/api/v1/restaurants/${rId}`, {
            method: "PATCH",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${token}`,
            },
            body: JSON.stringify(bodyData),
          });

          if (res.ok) {
            Swal.fire({
              icon: "success",
              title: "ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª",
              showConfirmButton: false,
              timer: 1500,
            });
          } else {
            throw new Error("ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸");
          }
        } catch (e) {
          console.error(e);
          Swal.fire("Ø®Ø·Ø£", "Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­ÙØ¸", "error");
        }
      }

      // ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª ÙÙŠ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…
      // ØªØ­Ø¯ÙŠØ« Ø¯Ø§Ù„Ø© Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª Ù„ØªÙ†Ø§Ø³Ø¨ Ø§Ù„ØªØµÙ…ÙŠÙ… Ø§Ù„Ø¬Ø¯ÙŠØ¯
      function toggleCatTab(mode) {
          const tabSingle = document.getElementById('tab-cat-single');
          const tabBulk = document.getElementById('tab-cat-bulk');
          const formSingle = document.getElementById('cat-form-single');
          const formBulk = document.getElementById('cat-form-bulk');

          if(mode === 'single') {
              formSingle.classList.remove('hidden');
              formBulk.classList.add('hidden');
              tabSingle.classList.add('active');
              tabBulk.classList.remove('active');
          } else {
              formSingle.classList.add('hidden');
              formBulk.classList.remove('hidden');
              tabBulk.classList.add('active');
              tabSingle.classList.remove('active');
          }
      }

      // Ø¯Ø§Ù„Ø© Ù„Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù„Ù„Ù…Ù†ØªØ¬Ø§Øª ÙˆØ§Ù„Ø¨Ø­Ø« Ø¨Ø§Ø³Ù… Ø§Ù„Ù‚Ø³Ù…
      function showCategoryProducts(catName) {
          switchView('products'); // ØªØ­ÙˆÙŠÙ„ Ù„Ù„ØµÙØ­Ø©
          const searchInput = document.getElementById('searchInput');
          searchInput.value = catName; // ÙˆØ¶Ø¹ Ø§Ø³Ù… Ø§Ù„Ù‚Ø³Ù… ÙÙŠ Ø§Ù„Ø¨Ø­Ø«
          searchTable(); // ØªØ´ØºÙŠÙ„ Ø§Ù„ÙÙ„ØªØ±Ø©
      }

      async function loadCategories() {
        const rId = document.getElementById("restaurant-id").value;
        const grid = document.getElementById("categories-grid");

        try {
          const res = await fetch(`/api/v1/categories/${rId}`, {
            headers: { Authorization: `Bearer ${token}` },
          });

          if (res.status === 401) return;
          const result = await res.json();

          if (result.status === "success") {
            categoriesData = result.data.categories;
            updateCategoryDropdowns();
            grid.innerHTML = "";

            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
            if (result.data.stats) {
                if(document.getElementById("stat-total-cats")) document.getElementById("stat-total-cats").innerText = result.data.stats.totalCats;
                if(document.getElementById("stat-total-prods")) document.getElementById("stat-total-prods").innerText = result.data.stats.totalProds;
            }

            if (categoriesData.length === 0) {
              grid.innerHTML = '<div style="grid-column: 1/-1; text-align:center; padding:40px; color:#94a3b8;"><i class="fas fa-folder-open fa-3x" style="opacity:0.3; margin-bottom:10px;"></i><p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ù‚Ø³Ø§Ù….. Ø§Ø¨Ø¯Ø£ Ø¨Ø¥Ø¶Ø§ÙØ© Ù‚Ø³Ù… Ø¬Ø¯ÙŠØ¯!</p></div>';
              return;
            }

            categoriesData.forEach((cat) => {
              // 1. Ø¥Ø®ÙØ§Ø¡ Ø§Ù„ØµÙˆØ±Ø© ØªÙ…Ø§Ù…Ø§Ù‹ Ù„Ùˆ Ù…Ø´ Ù…ÙˆØ¬ÙˆØ¯Ø©
              const imgHtml = cat.image 
                  ? `<div style="flex-shrink: 0;">
                       <img src="${cat.image}" style="width: 60px; height: 60px; border-radius: 12px; object-fit: cover; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
                     </div>`
                  : ``; // Ù‡Ù†Ø§ Ø®Ù„ÙŠÙ†Ø§ Ø§Ù„Ù…ØªØºÙŠØ± ÙØ§Ø¶ÙŠ Ù„Ùˆ Ù…ÙÙŠØ´ ØµÙˆØ±Ø©

              // 2. ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø¹Ø¯Ø§Ø¯
              const countBadge = cat.productCount > 0 
                  ? `<span style="font-size:12px; background:var(--bg); color:var(--text-main); padding:2px 10px; border-radius:20px; font-weight:bold; border: 1px solid var(--border-color);"><i class="fas fa-box-open" style="color:var(--primary)"></i> ${cat.productCount}</span>` 
                  : `<span style="font-size:12px; background:#f8fafc; color:#94a3b8; padding:2px 10px; border-radius:20px; border: 1px solid #e2e8f0;">ÙØ§Ø±Øº</span>`;

              // 3. Ø§Ù„Ù‡ÙŠÙƒÙ„
              grid.innerHTML += `
                <div class="cat-card-pro" id="cat-card-${cat._id}" data-id="${cat._id}" 
                     style="
                        background: var(--surface);
                        border-radius: 16px;
                        padding: 15px;
                        margin-bottom: 15px;
                        border: 1px solid var(--border-color);
                        box-shadow: 0 4px 6px -1px rgba(0,0,0,0.02);
                        display: flex;
                        flex-direction: column;
                        gap: 15px;
                     ">
                    
                    <div style="display: flex; align-items: center; gap: 15px; width: 100%;">
                        <div style="cursor: grab; color: #cbd5e1; padding: 5px; font-size: 14px;"><i class="fas fa-grip-vertical"></i></div>
                        
                        ${imgHtml} <div style="flex: 1;"> 
                            <h3 style="
                                margin: 0 0 5px 0; 
                                font-size: 17px; 
                                font-weight: 800; 
                                color: var(--text-main);
                            ">${cat.name}</h3>
                            ${countBadge}
                        </div>
                    </div>

                    <div style="display: flex; gap: 10px; width: 100%; border-top: 1px dashed var(--border-color); padding-top: 12px;">
                        
                        <button onclick="showCategoryProducts('${cat.name}')" title="Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª" 
                            style="flex: 1; height: 38px; border-radius: 10px; border: none; background: var(--bg); color: var(--primary); font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 5px;">
                            <i class="fas fa-eye"></i> Ø¹Ø±Ø¶
                        </button>

                        <button onclick="editCategory('${cat._id}', '${cat.name}', '${cat.image || ""}')" title="ØªØ¹Ø¯ÙŠÙ„" 
                            style="flex: 1; height: 38px; border-radius: 10px; border: none; background: var(--bg); color: var(--secondary); font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 5px;">
                            <i class="fas fa-pen"></i> ØªØ¹Ø¯ÙŠÙ„
                        </button>
                        
                        <button onclick="deleteCategory('${cat._id}')" title="Ø­Ø°Ù" 
                            style="flex: 1; height: 38px; border-radius: 10px; border: none; background: #fee2e2; color: var(--danger); font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 5px;">
                            <i class="fas fa-trash"></i> Ø­Ø°Ù
                        </button>
                    </div>

                </div>
              `;
            });

            // ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø³Ø­Ø¨ ÙˆØ§Ù„Ø¥ÙÙ„Ø§Øª
            new Sortable(grid, {
                animation: 150,
                handle: '.cat-card-pro',
                onEnd: function (evt) {
                    updateCategoryOrder();
                },
            });
          }
        } catch (e) {
          console.error(e);
        }
      }

      // Ø¯Ø§Ù„Ø© Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø£Ù‚Ø³Ø§Ù… (Ø¬Ø¯ÙŠØ¯Ø©)
      function searchCategory() {
        let input = document.getElementById("searchCatInput").value.toLowerCase();
        let cards = document.querySelectorAll(".cat-card-pro");
        
        cards.forEach((card) => {
          let text = card.innerText.toLowerCase();
          card.style.display = text.includes(input) ? "flex" : "none";
        });
      }

      async function updateCategoryOrder() {
          const cards = document.querySelectorAll('#categories-grid .category-card');
          const order = Array.from(cards).map((card, index) => ({
              id: card.getAttribute('data-id'),
              sortOrder: index + 1
          }));

          try {
              await fetch('/api/v1/categories/reorder', {
                  method: 'PATCH',
                  headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${token}` },
                  body: JSON.stringify({ order })
              });
          } catch(e) {
              console.error("Category Sorting error", e);
          }
      }

      // âœ… Ø¥ØµÙ„Ø§Ø­: Ø¯Ø§Ù„Ø© ØªØ±ØªÙŠØ¨ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù…ÙÙ‚ÙˆØ¯Ø©
      async function updateProductOrder() {
          const rows = document.querySelectorAll('#products-list tr');
          const order = Array.from(rows).map((row, index) => ({
              id: row.getAttribute('data-id'),
              sortOrder: index + 1
          }));

          try {
              await fetch('/api/v1/products/reorder', {
                  method: 'PATCH',
                  headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${token}` },
                  body: JSON.stringify({ order })
              });
          } catch(e) {
              console.error("Product Sorting error", e);
          }
      }

      async function saveCategoryBulk() {
          const text = document.getElementById('bulk-cat-names').value;
          const rId = document.getElementById("restaurant-id").value;
          
          if(!text.trim()) return Swal.fire("ØªÙ†Ø¨ÙŠÙ‡", "Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ù‚Ø³Ù… ÙˆØ§Ø­Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„", "warning");
          
          const names = text.split('\n').map(n => n.trim()).filter(n => n !== "");
          if(names.length === 0) return;

          Swal.showLoading();
          try {
              const res = await fetch('/api/v1/categories/bulk', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${token}` },
                  body: JSON.stringify({ names, restaurantId: rId })
              });
              const data = await res.json();
              Swal.close();
              if(data.status === 'success') {
                  document.getElementById('bulk-cat-names').value = "";
                  loadCategories();
                  toggleCatTab('single'); // Ø§Ù„Ø±Ø¬ÙˆØ¹ Ù„Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø¹Ø§Ø¯ÙŠ
                  Swal.fire({ toast: true, icon: "success", title: `ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© ${data.count} Ø£Ù‚Ø³Ø§Ù…` });
              }
          } catch(e) {
              Swal.fire("Ø®Ø·Ø£", "ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸", "error");
          }
      }
      function updateCategoryDropdowns() {
        const select = document.getElementById("p-cat");
        const currentVal = select.value;
        select.innerHTML = '<option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ù‚Ø³Ù… --</option>';
        categoriesData.forEach((cat) => {
          const option = document.createElement("option");
          option.value = cat.name;
          option.innerText = cat.name;
          select.appendChild(option);
        });
        if (currentVal) select.value = currentVal;
      }

      async function addCategory() {
        const name = document.getElementById("c-name").value;
        const imageFile = document.getElementById("c-image").files[0];
        const rId = document.getElementById("restaurant-id").value;

        if (!name) return Swal.fire("ØªÙ†Ø¨ÙŠÙ‡", "Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ù‚Ø³Ù…", "warning");

        const formData = new FormData();
        formData.append("name", name);
        formData.append("restaurantId", rId);
        if (imageFile) formData.append("image", imageFile);

        Swal.showLoading();

        try {
          const res = await fetch("/api/v1/categories", {
            method: "POST",
            headers: { Authorization: `Bearer ${token}` },
            body: formData,
          });

          if (res.status === 401) {
            sessionStorage.removeItem("ownerToken");
            window.location.href = "/login";
            return;
          }

          const data = await res.json();
          Swal.close();

          if (data.status === "success") {
            document.getElementById("c-name").value = "";
            document.getElementById("c-image").value = "";
            document.getElementById("c-preview").style.display = "none";
            loadCategories();
            Swal.fire({ toast: true, icon: "success", title: "ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ©" });
          } else {
            Swal.fire("Ø®Ø·Ø£", data.message || "ÙØ´Ù„ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù‚Ø³Ù…", "error");
          }
        } catch (e) {
          console.error(e);
          Swal.fire("Ø®Ø·Ø£", "Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±", "error");
        }
      }
      async function deleteCategory(id) {
        // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ø³Ù… Ø§Ù„Ù‚Ø³Ù… Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø­Ù…Ù„Ø©
        const catObj = categoriesData.find(c => c._id === id);
        const catName = catObj ? catObj.name : null;

        if (
          (
            await Swal.fire({
              title: "Ø­Ø°Ù Ø§Ù„Ù‚Ø³Ù…ØŸ",
              text: "Ø³ÙŠØªÙ… Ø­Ø°Ù Ø§Ù„Ù‚Ø³Ù… ÙˆØ¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø¨Ø¯Ø§Ø®Ù„Ù‡ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹!",
              icon: "warning",
              showCancelButton: true,
              confirmButtonColor: "#ef4444",
              confirmButtonText: "Ù†Ø¹Ù…ØŒ Ø§Ø­Ø°Ù Ø§Ù„ÙƒÙ„",
              cancelButtonText: "Ø¥Ù„ØºØ§Ø¡",
            })
          ).isConfirmed
        ) {
          try {
            Swal.fire({title: 'Ø¬Ø§Ø±ÙŠ Ø­Ø°Ù Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª ÙˆØ§Ù„Ù‚Ø³Ù…...', didOpen: () => Swal.showLoading()});
            const rId = document.getElementById("restaurant-id").value;

            // 1. Ø­Ø°Ù Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø© (Ù„Ùˆ Ø¹Ø±ÙÙ†Ø§ Ø§Ø³Ù… Ø§Ù„Ù‚Ø³Ù…)
            if (catName) {
                const prodRes = await fetch(`/api/v1/products/restaurant/${rId}`, { headers: { Authorization: `Bearer ${token}` } });
                const prodData = await prodRes.json();
                if(prodData.status === 'success') {
                    const productsToDelete = prodData.data.products.filter(p => p.category === catName);
                    const deletes = productsToDelete.map(p => 
                        fetch(`/api/v1/products/${p._id}`, {
                            method: 'DELETE',
                            headers: { Authorization: `Bearer ${token}` }
                        })
                    );
                    await Promise.all(deletes);
                }
            }

            // 2. Ø­Ø°Ù Ø§Ù„Ù‚Ø³Ù… Ù†ÙØ³Ù‡
            const res = await fetch(`/api/v1/categories/${id}`, {
              method: "DELETE",
              headers: { Authorization: `Bearer ${token}` },
            });

            if (res.status === 401) {
              window.location.href = "/login";
              return;
            }

            if (res.ok) {
              Swal.fire({ toast: true, icon: "success", title: "ØªÙ… Ø­Ø°Ù Ø§Ù„Ù‚Ø³Ù… ÙˆÙ…Ù†ØªØ¬Ø§ØªÙ‡", timer: 1500, showConfirmButton: false });
              loadCategories();
              loadProducts(); // ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ù„Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù…Ø­Ø°ÙˆÙ
            } else {
              Swal.fire("Ø®Ø·Ø£", "ÙØ´Ù„ Ø§Ù„Ø­Ø°Ù", "error");
            }
          } catch (e) {
            console.error(e);
            Swal.fire("Ø®Ø·Ø£", "Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„", "error");
          }
        }
      }
      async function saveCategory() {
        const id = document.getElementById("edit-cat-id").value;
        const name = document.getElementById("c-name").value; // Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯
        const oldName = document.getElementById("c-old-name").value; // Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ù‚Ø¯ÙŠÙ…
        const imageFile = document.getElementById("c-image").files[0];
        const rId = document.getElementById("restaurant-id").value;

        if (!name) return Swal.fire("ØªÙ†Ø¨ÙŠÙ‡", "Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ù‚Ø³Ù…", "warning");

        const formData = new FormData();
        formData.append("name", name);
        if (imageFile) formData.append("image", imageFile);

        let url = "/api/v1/categories";
        let method = "POST";

        if (id) {
          url = `/api/v1/categories/${id}`;
          method = "PATCH";
        } else {
          formData.append("restaurantId", rId);
        }

        Swal.showLoading();
        try {
          // 1. Ø­ÙØ¸ Ø§Ù„Ù‚Ø³Ù… Ø£ÙˆÙ„Ø§Ù‹
          const res = await fetch(url, {
            method: method,
            headers: { Authorization: `Bearer ${token}` },
            body: formData,
          });
          const data = await res.json();

          // 2. ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø© (Ù„Ùˆ ÙƒØ§Ù† ØªØ¹Ø¯ÙŠÙ„ ÙˆØ§Ù„Ø§Ø³Ù… Ø§ØªØºÙŠØ±)
          if (data.status === "success" && id && oldName && oldName !== name) {
             Swal.fire({title: 'Ø¬Ø§Ø±ÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª...', didOpen: () => Swal.showLoading()});
             
             // Ø¬Ù„Ø¨ ÙƒÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø¹Ø´Ø§Ù† Ù†Ø¹Ø¯Ù„Ù‡Ù…
             const prodRes = await fetch(`/api/v1/products/restaurant/${rId}`, { headers: { Authorization: `Bearer ${token}` } });
             const prodData = await prodRes.json();
             
             if(prodData.status === 'success') {
                 const productsToUpdate = prodData.data.products.filter(p => p.category === oldName);
                 
                 // ØªØ­Ø¯ÙŠØ« ÙƒÙ„ Ù…Ù†ØªØ¬
                 const updates = productsToUpdate.map(p => {
                     const pData = new FormData();
                     pData.append("category", name); // Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯
                     // Ù„Ø§Ø²Ù… Ù†Ø¨Ø¹Øª Ø§Ù„Ø§Ø³Ù… ØªØ§Ù†ÙŠ Ø¹Ø´Ø§Ù† Ø§Ù„Ù€ Validation ÙÙŠ Ø§Ù„Ø³ÙŠØ±ÙØ±
                     pData.append("name", JSON.stringify(p.name)); 
                     return fetch(`/api/v1/products/${p._id}`, {
                         method: 'PATCH',
                         headers: { Authorization: `Bearer ${token}` },
                         body: pData
                     });
                 });
                 
                 await Promise.all(updates);
             }
          }

          Swal.close();

          if (data.status === "success") {
            resetCategoryForm();
            loadCategories();
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª ÙÙŠ Ø§Ù„Ø®Ù„ÙÙŠØ© Ø¹Ø´Ø§Ù† Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯ ÙŠØ¸Ù‡Ø±
            loadProducts(); 
            Swal.fire({
              toast: true,
              icon: "success",
              title: id ? "ØªÙ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ ÙˆØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª" : "ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ©",
              timer: 1500, // ÙŠØ®ØªÙÙŠ Ø¨Ø¹Ø¯ Ø«Ø§Ù†ÙŠØ© ÙˆÙ†ØµÙ
              showConfirmButton: false
            });
          } else {
            Swal.fire("Ø®Ø·Ø£", data.message, "error");
          }
        } catch (e) {
          console.error(e);
          Swal.fire("Ø®Ø·Ø£", "Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„", "error");
        }
      }
      function editCategory(id, name, image) {
        document.getElementById("edit-cat-id").value = id;
        document.getElementById("c-name").value = name;
        document.getElementById("c-old-name").value = name; // Ø­ÙØ¸ Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ù‚Ø¯ÙŠÙ… Ù„Ù„Ù…Ù‚Ø§Ø±Ù†Ø©
        document.getElementById("cat-form-title").innerText =
          "ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù‚Ø³Ù…: " + name;
        document.getElementById("btn-save-cat").innerHTML =
          '<i class="fas fa-save"></i> ØªØ­Ø¯ÙŠØ«';
        document.getElementById("btn-save-cat").classList.remove("btn-primary");
        document.getElementById("btn-save-cat").style.backgroundColor =
          "var(--warning)";
        document.getElementById("btn-save-cat").style.color = "white";
        document.getElementById("btn-cancel-cat").classList.remove("hidden");

        if (image) {
          document.getElementById("c-preview").src = image;
          document.getElementById("c-preview").style.display = "block";
       } else {
      document.getElementById("c-preview").style.display = "none";
    }
    // âœ… Ø¥ØµÙ„Ø§Ø­: Ø§Ù„Ø°Ù‡Ø§Ø¨ Ù„Ù…ÙƒØ§Ù† Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ù…Ø¨Ø§Ø´Ø±Ø©
    document.getElementById('card-cat-form').scrollIntoView({ behavior: 'smooth', block: 'center' });
  }

      function resetCategoryForm() {
        document.getElementById("edit-cat-id").value = "";
        document.getElementById("c-name").value = "";
        document.getElementById("c-image").value = "";
        document.getElementById("c-preview").style.display = "none";
        document.getElementById("cat-form-title").innerText = "Ø¥Ø¶Ø§ÙØ© Ù‚Ø³Ù… Ø¬Ø¯ÙŠØ¯";
        document.getElementById("btn-save-cat").innerHTML =
          '<i class="fas fa-plus"></i> Ø­ÙØ¸';
        document.getElementById("btn-save-cat").classList.add("btn-primary");
        document.getElementById("btn-save-cat").style.backgroundColor = "";
        document.getElementById("btn-save-cat").style.color = "";
        document.getElementById("btn-cancel-cat").classList.add("hidden");
      }

     function searchTable() {
        let input = document.getElementById("searchInput").value.toLowerCase();
        let cards = document.querySelectorAll(".prod-card-item"); // Ù„Ø§Ø­Ø¸ Ù‡Ù†Ø§ Ø¨Ù†Ø¨Ø­Ø« ÙÙŠ Ø§Ù„ÙƒØ±ÙˆØª
        
        cards.forEach((card) => {
          let text = card.innerText.toLowerCase();
          card.style.display = text.includes(input) ? "flex" : "none"; // flex Ø¹Ø´Ø§Ù† Ù†Ø­Ø§ÙØ¸ Ø¹Ù„Ù‰ Ø§Ù„ØªØµÙ…ÙŠÙ…
        });
      }

      async function loadProducts() {
        window.allProductsGlobal = []; // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù…ØªØºÙŠØ± ÙÙˆØ±Ø§Ù‹ Ù„Ù…Ù†Ø¹ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡
        const rId = document.getElementById("restaurant-id").value;
        const container = document.getElementById("products-list-container");

        try {
          const res = await fetch(`/api/v1/products/restaurant/${rId}`, {
            headers: { Authorization: `Bearer ${token}` },
          });

          if (res.status === 401) {
            sessionStorage.removeItem("ownerToken");
            window.location.href = "/login";
            return;
          }

          const result = await res.json();

          if (result.status === "success") {
            window.allProductsGlobal = result.data.products;
            container.innerHTML = "";

            if (result.data.products.length === 0) {
              container.innerHTML = `
                <div style="text-align:center; padding:50px 20px; color:var(--secondary);">
                    <div style="width:80px; height:80px; background:var(--bg); border-radius:50%; display:flex; align-items:center; justify-content:center; margin:0 auto 20px;">
                        <i class="fas fa-pizza-slice fa-2x" style="opacity:0.3;"></i>
                    </div>
                    <h3 style="margin:0;">Ù‚Ø§Ø¦Ù…ØªÙƒ ÙØ§Ø±ØºØ©!</h3>
                    <p style="margin:5px 0 0; opacity:0.7;">Ø§Ø¨Ø¯Ø£ Ø¨Ø¥Ø¶Ø§ÙØ© Ø£ÙˆÙ„ Ø·Ø¨Ù‚ Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ©</p>
                </div>`;
              return;
            }

            result.data.products.forEach((p) => {
              const imgUrl = p.image || "https://placehold.co/100x100/f1f5f9/94a3b8?text=No+Img";
              const pData = encodeURIComponent(JSON.stringify(p));
              
              // Ø­Ø§Ù„Ø© Ø§Ù„ØªÙˆÙØ± (Ù…ÙØªØ§Ø­ Ø³ÙˆÙŠØªØ´)
              const checkedAttr = p.isAvailable ? 'checked' : '';
              
              // Ø¹Ø±Ø¶ Ø§Ù„Ø³Ø¹Ø±
              let priceDisplay = p.sizes && p.sizes.length > 0 
                  ? `<span style="font-size:11px; background:var(--bg); padding:4px 10px; border-radius:20px; font-weight:bold;">Ù…ØªØ¹Ø¯Ø¯</span>` 
                  : `<span style="font-weight:800; color:var(--primary); font-size:15px;">${p.price} <small>Ø¬.Ù…</small></span>`;

              container.innerHTML += `
                <div class="prod-card-item" id="prod-card-${p._id}" onclick="editProd('${pData}')">
                    <div style="display: flex; align-items: center; flex: 1;">
                        <div class="drag-handle" style="cursor: grab; color: #cbd5e1; padding: 10px;"><i class="fas fa-grip-vertical"></i></div>
                        
                        <img src="${imgUrl}" class="prod-img-thumb" onerror="this.src='https://placehold.co/100x100?text=Error'">
                        
                        <div style="margin-right: 15px;">
                            <div style="font-weight: 800; font-size: 15px; color: var(--text-main); margin-bottom: 5px;">${p.name.ar}</div>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <span class="badge badge-cat">${p.category}</span>
                                ${priceDisplay}
                            </div>
                        </div>
                    </div>

                    <div style="display: flex; align-items: center; gap: 10px; padding-left:10px;">
                        <div onclick="event.stopPropagation();" title="ØªØºÙŠÙŠØ± Ø§Ù„Ø­Ø§Ù„Ø© (Ù…ØªØ§Ø­/Ù†ÙØ°)">
                            <label class="switch-status">
                                <input type="checkbox" ${checkedAttr} onchange="toggleProd('${p._id}')">
                                <span class="slider-status"></span>
                            </label>
                        </div>

                        <button onclick="event.stopPropagation(); duplicateProd('${pData}')" class="action-btn-mini" title="Ù†Ø³Ø® Ø§Ù„Ù…Ù†ØªØ¬">
                            <i class="fas fa-copy"></i>
                        </button>

                        <button onclick="event.stopPropagation(); deleteProd('${p._id}')" class="action-btn-mini danger" title="Ø­Ø°Ù">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </div>
                </div>
              `;
            });

            new Sortable(container, {
              animation: 150,
              handle: '.drag-handle',
              onEnd: function () {
                const cards = document.querySelectorAll('.prod-card-item');
                const order = Array.from(cards).map((card, index) => ({
                  id: card.id.replace('prod-card-', ''),
                  sortOrder: index + 1
                }));
                fetch('/api/v1/products/reorder', {
                  method: 'PATCH',
                  headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${token}` },
                  body: JSON.stringify({ order })
                });
              }
            });
            
            searchTable();
          }
        } catch (e) {
          console.error(e);
        }
      }

      // Ø¯Ø§Ù„Ø© Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
      function duplicateProd(dataEncoded) {
          const p = JSON.parse(decodeURIComponent(dataEncoded));
          // Ù…Ù„Ø¡ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ø¨Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù†ØªØ¬ Ø§Ù„Ù‚Ø¯ÙŠÙ…
          document.getElementById("p-name").value = p.name.ar + " (Ù†Ø³Ø®Ø©)";
          document.getElementById("p-cat").value = p.category;
          document.getElementById("p-desc").value = p.description ? p.description.ar : "";
          
          // ØªÙØ±ÙŠØº Ø§Ù„ØµÙˆØ±Ø© Ù„Ø£Ù†Ù†Ø§ Ù„Ø§ Ù†Ø³ØªØ·ÙŠØ¹ Ù†Ø³Ø® Ø§Ù„Ù…Ù„Ù
          document.getElementById("p-preview").style.display = "none";
          document.getElementById("p-image").value = ""; 

          // Ù†Ø³Ø® Ø§Ù„Ø£Ø³Ø¹Ø§Ø±
          if (p.sizes && p.sizes.length > 0) {
              document.querySelector('input[name="pricingMode"][value="multi"]').checked = true;
              document.getElementById("sizes-list").innerHTML = "";
              p.sizes.forEach((s) => addSizeRow(s.name, s.price, s.oldPrice));
          } else {
              document.querySelector('input[name="pricingMode"][value="single"]').checked = true;
              document.getElementById("p-price").value = p.price;
              document.getElementById("p-old-price").value = p.oldPrice;
          }
          togglePricingMode();

          // ØªØºÙŠÙŠØ± Ø§Ù„Ø¹Ù†ÙˆØ§Ù† ÙˆØªØ¬Ù‡ÙŠØ² Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ù„Ù„Ø­ÙØ¸ ÙƒÙ…Ù†ØªØ¬ Ø¬Ø¯ÙŠØ¯
          document.getElementById("form-mode-title").innerText = "Ù†Ø³Ø® Ù…Ù†ØªØ¬: " + p.name.ar;
          document.getElementById("btn-add-prod").classList.remove("hidden");
          document.getElementById("btn-update-prod").classList.add("hidden");
          document.getElementById("btn-cancel").classList.remove("hidden");
          editingProductId = null; // ØªØ£ÙƒÙŠØ¯ Ø£Ù†Ù‡ Ù…Ù†ØªØ¬ Ø¬Ø¯ÙŠØ¯

          // ØªÙ…Ø±ÙŠØ± Ø³Ù„Ø³ Ù„Ù„Ù†Ù…ÙˆØ°Ø¬
          document.getElementById('card-prod-form').scrollIntoView({ behavior: 'smooth', block: 'center' });
          Swal.fire({
              toast: true,
              icon: 'info',
              title: 'ØªÙ… Ù†Ø³Ø® Ø§Ù„Ø¨ÙŠØ§Ù†Ø§ØªØŒ Ø§Ø¶ØºØ· "Ø¥Ø¶Ø§ÙØ©" Ù„Ù„Ø­ÙØ¸',
              timer: 3000,
              showConfirmButton: false
          });
      }

      async function saveProduct(method) {
        const url =
          method === "POST"
            ? "/api/v1/products"
            : `/api/v1/products/${editingProductId}`;
        const name = document.getElementById("p-name").value;
        const cat = document.getElementById("p-cat").value;
        const desc = document.getElementById("p-desc").value;
        const imageFile = document.getElementById("p-image").files[0];
        const pricingMode = document.querySelector(
          'input[name="pricingMode"]:checked',
        ).value;

        if (!name || !cat)
          return Swal.fire("Ù†Ø§Ù‚Øµ Ø¨ÙŠØ§Ù†Ø§Øª", "Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ù„Ù‚Ø³Ù… Ù…Ø·Ù„ÙˆØ¨ÙŠÙ†", "warning");

        const formData = new FormData();
        formData.append(
          "restaurantId",
          document.getElementById("restaurant-id").value,
        );
        formData.append("category", cat);
        formData.append("name", JSON.stringify({ ar: name, en: name }));
        formData.append("description", JSON.stringify({ ar: desc, en: "" }));
        // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù‚Ø§Ø¯ÙŠØ± Ù„Ù„Ù€ FormData
        if(currentIngredients.length > 0) {
            formData.append("ingredients", JSON.stringify(currentIngredients));
        }
        if (imageFile) formData.append("image", imageFile);

        if (pricingMode === "single") {
          const price = parseFloat(document.getElementById("p-price").value);
          if (!price) return Swal.fire("ØªÙ†Ø¨ÙŠÙ‡", "ÙŠØ¬Ø¨ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø³Ø¹Ø±", "warning");

          let oldPriceInput =
            parseFloat(document.getElementById("p-old-price").value) || 0;

          if (oldPriceInput <= price) {
            oldPriceInput = 0;
          }

          formData.append("price", price);
          formData.append("oldPrice", oldPriceInput);
          formData.append("sizes", JSON.stringify([]));
        } else {
          const rows = document.querySelectorAll(".size-row");
          let sizesArr = [];
          rows.forEach((row) => {
            const sName = row.querySelector(".s-name").value;
            const sPrice = Number(row.querySelector(".s-price").value);
            let sOld = Number(row.querySelector(".s-old").value) || 0;

            if (sOld <= sPrice) sOld = 0;

            if (sName && sPrice) {
              sizesArr.push({ name: sName, price: sPrice, oldPrice: sOld });
            }
          });

          if (sizesArr.length === 0)
            return Swal.fire(
              "ØªÙ†Ø¨ÙŠÙ‡",
              "ÙŠØ¬Ø¨ Ø¥Ø¶Ø§ÙØ© Ø­Ø¬Ù… ÙˆØ§Ø­Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„",
              "warning",
            );

          formData.append("price", sizesArr[0].price);
          formData.append("sizes", JSON.stringify(sizesArr));
        }

        const headers = { Authorization: `Bearer ${token}` };

        Swal.showLoading();
        try {
          const res = await fetch(url, {
            method: method,
            headers: headers,
            body: formData,
          });
          const data = await res.json();

          if (data.status === "success") {
            // Swal.close(); // Ø´ÙŠÙ„Ù†Ø§ Ø¯ÙŠ Ø¹Ø´Ø§Ù† Ø§Ù„ØªÙˆØ³Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯ ÙŠØ¸Ù‡Ø± Ù…ÙƒØ§Ù† Ø§Ù„Ù‚Ø¯ÙŠÙ… Ø¹Ù„Ø·ÙˆÙ„
            loadProducts();
            resetProductForm();
            Swal.fire({
              toast: true,
              icon: "success",
              title: "ØªÙ… Ø§Ù„Ø­ÙØ¸ Ø¨Ù†Ø¬Ø§Ø­",
              timer: 1500, // ÙŠØ®ØªÙÙŠ Ø¨Ø¹Ø¯ Ø«Ø§Ù†ÙŠØ© ÙˆÙ†ØµÙ
              showConfirmButton: false
            });
          } else {
            throw new Error(data.message);
          }
        } catch (e) {
          Swal.fire("Ø®Ø·Ø£", e.message || "ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸", "error");
        }
      }

      function editProd(dataEncoded) {
        const p = JSON.parse(decodeURIComponent(dataEncoded));
        editingProductId = p._id;

        // 1. Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªÙ…ÙŠÙŠØ² Ø¹Ù† ÙƒÙ„ Ø§Ù„ÙƒØ±ÙˆØª
        document.querySelectorAll('.prod-card-item').forEach(c => c.classList.remove('active-edit'));
        
        // 2. ØªÙ…ÙŠÙŠØ² Ø§Ù„ÙƒØ§Ø±Øª Ø§Ù„Ø­Ø§Ù„ÙŠ
        const activeCard = document.getElementById(`prod-card-${p._id}`);
        if(activeCard) activeCard.classList.add('active-edit');

        // Ù…Ù„Ø¡ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ø§Ù„ÙÙˆØ±Ù… (Ù†ÙØ³ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ù‚Ø¯ÙŠÙ…)
        document.getElementById("p-name").value = p.name.ar;
        document.getElementById("p-cat").value = p.category;
        document.getElementById("p-desc").value = p.description ? p.description.ar : "";

        if (p.image) {
          document.getElementById("p-preview").src = p.image;
          document.getElementById("p-preview").style.display = "block";
        } else {
          document.getElementById("p-preview").src = ""; // ØªÙØ±ÙŠØº Ø§Ù„ØµÙˆØ±Ø©
          document.getElementById("p-preview").style.display = "none";
        }

        const sizesList = document.getElementById("sizes-list");
        sizesList.innerHTML = "";

        if (p.sizes && p.sizes.length > 0) {
          document.querySelector('input[name="pricingMode"][value="multi"]').checked = true;
          p.sizes.forEach((s) => addSizeRow(s.name, s.price, s.oldPrice));
        } else {
          document.querySelector('input[name="pricingMode"][value="single"]').checked = true;
          document.getElementById("p-price").value = p.price;
          document.getElementById("p-old-price").value = p.oldPrice && p.oldPrice > 0 ? p.oldPrice : "";
        }

        togglePricingMode();

        document.getElementById("form-mode-title").innerText = `ØªØ¹Ø¯ÙŠÙ„: ${p.name.ar}`;
        document.getElementById("btn-add-prod").classList.add("hidden");
        document.getElementById("btn-update-prod").classList.remove("hidden");
        document.getElementById("btn-cancel").classList.remove("hidden");

        // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù‚Ø§Ø¯ÙŠØ±
        currentIngredients = p.ingredients || [];
        renderIngredientsList();
      }
      

      function resetProductForm() {
        editingProductId = null;
        document.querySelectorAll('.prod-card-item').forEach(c => c.classList.remove('active-edit'));
        document.getElementById("p-name").value = "";
        document.getElementById("p-price").value = "";
        document.getElementById("p-cat").value = "";
        document.getElementById("p-desc").value = "";
        document.getElementById("p-image").value = "";
        document.getElementById("p-preview").style.display = "none";
        document.getElementById("form-mode-title").innerText =
          "Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬ Ø¬Ø¯ÙŠØ¯";
        document.getElementById("btn-add-prod").classList.remove("hidden");
        document.getElementById("btn-update-prod").classList.add("hidden");
        document.getElementById("btn-cancel").classList.add("hidden");
        currentIngredients = [];
        renderIngredientsList();
      }

      // Ø¯Ø§Ù„Ø© ØªØºÙŠÙŠØ± Ø­Ø§Ù„Ø© Ø§Ù„ØªÙˆÙØ± (Ø¥ØµÙ„Ø§Ø­ Ø´Ø§Ù…Ù„)
      async function toggleProd(id) {
        // 1. Ù†Ø¬ÙŠØ¨ Ø§Ù„Ù…Ù†ØªØ¬ Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø­Ù…Ù„Ø© Ø¹Ø´Ø§Ù† Ù†Ø¹Ø±Ù Ø­Ø§Ù„ØªÙ‡
        const product = window.allProductsGlobal.find(p => p._id === id);
        if (!product) return;

        const newStatus = !product.isAvailable; // Ø¹ÙƒØ³ Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©

        try {
            // 2. Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªØ­Ø¯ÙŠØ« Ù„Ù„Ø±Ø§Ø¨Ø· Ø§Ù„ØµØ­ÙŠØ­
            const res = await fetch(`/api/v1/products/${id}`, {
                method: 'PATCH',
                headers: { 
                    'Content-Type': 'application/json',
                    Authorization: `Bearer ${token}` 
                },
                body: JSON.stringify({ isAvailable: newStatus })
            });

            if (res.ok) {
                // 3. ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ù†Ø¯Ù†Ø§ Ø¹Ø´Ø§Ù† Ù…ÙŠØ¨Ù‚Ø§Ø´ ÙÙŠÙ‡ ØªØ¹Ø§Ø±Ø¶
                product.isAvailable = newStatus;
                
                // ØªØ­Ø¯ÙŠØ« Ø´ÙƒÙ„ Ø§Ù„ÙƒØ§Ø±Øª ÙÙˆØ±Ø§Ù‹ (ØªØºÙ…ÙŠÙ‚ Ø§Ù„Ù„ÙˆÙ† ÙˆØªØºÙŠÙŠØ± Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø©)
                const card = document.getElementById(`prod-card-${id}`);
                if(card) {
                    card.style.opacity = newStatus ? '1' : '0.6';
                    const iconBtn = card.querySelector('.fa-eye, .fa-eye-slash');
                    if(iconBtn) {
                        iconBtn.className = newStatus ? 'fas fa-eye' : 'fas fa-eye-slash';
                        // ØªØºÙŠÙŠØ± Ù„ÙˆÙ† Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø©
                        iconBtn.parentElement.style.color = newStatus ? 'var(--success)' : 'var(--secondary)';
                        iconBtn.parentElement.style.borderColor = newStatus ? 'var(--success)' : 'var(--secondary)';
                    }
                }

                // Ø±Ø³Ø§Ù„Ø© ØªØ£ÙƒÙŠØ¯ Ø³Ø±ÙŠØ¹Ø©
                Swal.fire({
                    toast: true,
                    icon: 'success',
                    title: newStatus ? 'Ø§Ù„Ù…Ù†ØªØ¬ Ø¸Ù‡Ø± ÙÙŠ Ø§Ù„Ù…Ù†ÙŠÙˆ' : 'ØªÙ… Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù…Ù†ØªØ¬ Ù…Ù† Ø§Ù„Ù…Ù†ÙŠÙˆ',
                    timer: 1500,
                    showConfirmButton: false
                });

            } else {
                Swal.fire('Ø®Ø·Ø£', 'Ø§Ù„Ø³ÙŠØ±ÙØ± Ù…Ø±Ø¯Ø´ØŒ ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø§ØªØµØ§Ù„', 'error');
            }
        } catch (e) {
            console.error(e);
            Swal.fire('Ø®Ø·Ø£', 'Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„', 'error');
        }
      }

      async function deleteProd(id) {
        if (
          (
            await Swal.fire({
              title: "Ø­Ø°Ù Ø§Ù„Ù…Ù†ØªØ¬ØŸ",
              icon: "warning",
              showCancelButton: true,
            })
          ).isConfirmed
        ) {
          await fetch(`/api/v1/products/${id}`, {
            method: "DELETE",
            headers: { Authorization: `Bearer ${token}` },
          });
          loadProducts();
        }
      }

      // 1. Ø¯Ø§Ù„Ø© Ø§Ù„ÙÙ„ØªØ±Ø© (Ø¨Ø­Ø« Ø¯Ø§Ø®Ù„ Ø§Ù„ØµÙÙˆÙ)
function filterBulkRows() {
    const term = document.getElementById('bulk-search-filter').value.toLowerCase();
    document.querySelectorAll('.bulk-row-pro').forEach(row => {
        const name = row.querySelector('.b-name').value.toLowerCase();
        if(name.includes(term)) {
            row.style.display = 'flex';
        } else {
            row.style.display = 'none';
        }
    });
}

// 1. Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ù…ÙÙ‚ÙˆØ¯Ø© (Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ø®Ø·Ø£)
function removeBulkRow(rowId) {
    const row = document.getElementById(`row-${rowId}`);
    if(row) {
        row.style.transform = "scale(0.95)";
        row.style.opacity = "0";
        setTimeout(() => row.remove(), 200);
    }
}

// 2. Ø¯Ø§Ù„Ø© Ø§Ù„Ø±Ø³Ù… Ø¨Ø§Ù„ØªØµÙ…ÙŠÙ… Ø§Ù„ÙˆØ§Ø³Ø¹ Ø§Ù„Ù…Ø±ÙŠØ­
// Ø¯Ø§Ù„Ø© Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ Ø¨ÙŠÙ† Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª (Ø³Ø¹Ø± Ù…ÙˆØ­Ø¯ / Ø£Ø­Ø¬Ø§Ù…) - Ù†Ø³Ø®Ø© Ù…ØµØ­Ø­Ø©
function switchPriceTab(rowId, mode, tabElement) {
    // 1. ØªØ­Ø¯ÙŠØ« Ø´ÙƒÙ„ Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª
    const parent = tabElement.parentElement;
    parent.querySelectorAll('.p-tab').forEach(el => el.classList.remove('active'));
    tabElement.classList.add('active');

    // 2. Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù…Ù†Ø§Ø³Ø¨
    const singleContainer = document.getElementById(`single-inputs-${rowId}`);
    const multiContainer = document.getElementById(`multi-inputs-${rowId}`);
    
    if (mode === 'single') {
        // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ù…ÙˆØ­Ø¯
        singleContainer.classList.remove('hidden');
        singleContainer.style.display = 'flex';
        
        // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø£Ø­Ø¬Ø§Ù…
        multiContainer.classList.add('hidden');
        multiContainer.style.display = 'none';
    } else {
        // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ù…ÙˆØ­Ø¯
        singleContainer.classList.add('hidden');
        singleContainer.style.display = 'none';
        
        // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø£Ø­Ø¬Ø§Ù… (Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ù…Ø´ÙƒÙ„Ø© Ù‡Ù†Ø§ Ø¨Ø¥Ø²Ø§Ù„Ø© ÙƒÙ„Ø§Ø³ hidden)
        multiContainer.classList.remove('hidden');
        multiContainer.style.display = 'block';
        
        // Ø¥Ø¶Ø§ÙØ© ØµÙ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© ÙØ§Ø±ØºØ©
        const sizesContainer = document.getElementById(`sizes-container-${rowId}`);
        if (sizesContainer && sizesContainer.children.length === 0) {
            addBulkSizeRow(rowId);
        }
    }

    // 3. ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±Ø§Ø¯ÙŠÙˆ Ø§Ù„Ù…Ø®ÙÙŠ (Ù„Ø¶Ù…Ø§Ù† Ø¹Ù…Ù„ Ø§Ù„Ø­ÙØ¸ Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­)
    const radio = document.querySelector(`input[name="mode-${rowId}"][value="${mode}"]`);
    if(radio) radio.checked = true;
}

// Ø¯Ø§Ù„Ø© Ø§Ù„Ø±Ø³Ù… Ø§Ù„Ù…Ø­Ø¯Ø«Ø© (Ø¨Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª)
function addBulkRows(count = 1) {
    const container = document.getElementById("bulk-container");
    
    let catOptions = '<option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ù‚Ø³Ù… --</option>';
    if(typeof categoriesData !== 'undefined' && categoriesData.length > 0){
        categoriesData.forEach((cat) => {
            catOptions += `<option value="${cat.name}">${cat.name}</option>`;
        });
    }

    for (let i = 0; i < count; i++) {
        const rowId = Date.now() + Math.floor(Math.random() * 10000);
        
        const html = `
        <div class="bulk-row-pro" id="row-${rowId}">
            <div class="bulk-img-upload" onclick="document.getElementById('img-${rowId}').click()">
                <img id="preview-${rowId}" class="bulk-img-preview">
                <div id="placeholder-${rowId}" style="text-align:center;">
                    <i class="fas fa-camera" style="color:#cbd5e1; font-size:20px;"></i>
                    <div style="font-size:10px; color:#64748b; margin-top:4px;">ØµÙˆØ±Ø©</div>
                </div>
                <input type="file" id="img-${rowId}" class="b-image hidden" accept="image/*" onchange="handleBulkImage('${rowId}', this)">
            </div>

            <div class="bulk-inputs-grid">
                
                <div>
                    <label class="bulk-label-sm">Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©</label>
                    <input type="text" class="b-name bulk-input-styled" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬" style="margin-bottom:10px;">
                    <select class="b-cat bulk-input-styled">${catOptions}</select>
                </div>
                
                <div>
                     <label class="bulk-label-sm">Ø§Ù„ÙˆØµÙ ÙˆØ§Ù„Ù…ÙƒÙˆÙ†Ø§Øª</label>
                     <textarea class="b-desc bulk-input-styled" placeholder="Ø£Ø¶Ù ÙˆØµÙØ§Ù‹ Ù…Ø®ØªØµØ±Ø§Ù‹..." style="height: 94px; resize: none;"></textarea>
                </div>

                <div class="price-box">
                    <div class="price-tabs">
                        <div class="p-tab active" onclick="switchPriceTab('${rowId}', 'single', this)">Ø³Ø¹Ø± Ù…ÙˆØ­Ø¯</div>
                        <div class="p-tab" onclick="switchPriceTab('${rowId}', 'multi', this)">Ø£Ø­Ø¬Ø§Ù… Ù…ØªØ¹Ø¯Ø¯Ø©</div>
                    </div>
                    
                    <input type="radio" name="mode-${rowId}" value="single" class="hidden" checked>
                    <input type="radio" name="mode-${rowId}" value="multi" class="hidden">

                    <div class="p-content">
                        <div id="single-inputs-${rowId}" style="display:flex; gap:8px;">
                            <div style="flex:1">
                                <label class="bulk-label-sm">Ø§Ù„Ø³Ø¹Ø±</label>
                                <input type="number" class="b-price bulk-input-styled" placeholder="0" style="color:var(--success); font-weight:bold; text-align:center;">
                            </div>
                            <div style="flex:1">
                                <label class="bulk-label-sm">Ù‚Ø¨Ù„ Ø§Ù„Ø®ØµÙ…</label>
                                <input type="number" class="b-old-price bulk-input-styled" placeholder="0" style="background:#fff1f2; text-align:center;">
                            </div>
                        </div>

                        <div id="multi-inputs-${rowId}" class="hidden">
                            <div id="sizes-container-${rowId}" style="max-height:60px; overflow-y:auto; margin-bottom:8px;"></div>
                            <button class="btn btn-outline" style="width:100%; font-size:11px; height:30px; border-style:dashed;" onclick="addBulkSizeRow('${rowId}')">
                                <i class="fas fa-plus"></i> Ø¥Ø¶Ø§ÙØ© Ø­Ø¬Ù…
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="bulk-actions">
                <button class="action-icon-btn btn-dup" onclick="duplicateBulkRow('${rowId}')"><i class="fas fa-copy"></i></button>
                <button class="action-icon-btn btn-del" onclick="removeBulkRow('${rowId}')"><i class="fas fa-trash-alt"></i></button>
            </div>
        </div>`;
        
        container.insertAdjacentHTML("beforeend", html);
    }
}
// ==========================================
// 3. Ø¯ÙˆØ§Ù„ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø­Ø¬Ø§Ù… (Ø§Ù„Ù…ÙÙ‚ÙˆØ¯Ø©)
// ==========================================

function addBulkSizeRow(rowId) {
    const container = document.getElementById(`sizes-container-${rowId}`);
    const sizeId = Date.now() + Math.floor(Math.random() * 1000);
    
    const html = `
    <div id="size-${sizeId}" class="b-size-row" style="display: flex; gap: 5px; margin-bottom: 5px; align-items: center; background: #fff; padding: 4px; border-radius: 6px; border: 1px solid #e2e8f0;">
        <input type="text" class="bs-name bulk-input-styled" placeholder="Ø§Ø³Ù… Ø§Ù„Ø­Ø¬Ù…" style="flex: 2; height: 28px; font-size: 11px; padding: 0 5px;">
        <input type="number" class="bs-price bulk-input-styled" placeholder="Ø§Ù„Ø³Ø¹Ø±" style="flex: 1; height: 28px; font-size: 11px; text-align: center; padding: 0 5px;">
        <input type="number" class="bs-old bulk-input-styled" placeholder="Ù‚Ø¯ÙŠÙ…" style="flex: 1; height: 28px; font-size: 11px; text-align: center; padding: 0 5px; background:#fff1f2;">
        <button type="button" onclick="document.getElementById('size-${sizeId}').remove()" style="background: #fee2e2; color: #ef4444; border: none; width: 24px; height: 24px; border-radius: 4px; cursor: pointer; display: flex; align-items: center; justify-content: center;">
            <i class="fas fa-times" style="font-size: 10px;"></i>
        </button>
    </div>`;
    
    container.insertAdjacentHTML('beforeend', html);
}

// Ø­Ø°Ù ØµÙ Ø­Ø¬Ù… Ù…Ø­Ø¯Ø¯
function removeSizeRow(sizeId) {
    const el = document.getElementById(`size-${sizeId}`);
    if (el) el.remove();
}

// 3. Ø¯Ø§Ù„Ø© Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ØµÙˆØ±Ø©
function handleBulkImage(id, input) {
    if (input.files && input.files[0]) {
        const reader = new FileReader();
        reader.onload = function(e) {
            document.getElementById(`preview-${id}`).src = e.target.result;
            document.getElementById(`preview-${id}`).style.display = 'block';
            document.getElementById(`placeholder-${id}`).style.display = 'none';
        }
        reader.readAsDataURL(input.files[0]);
    }
}

// 4. Ø¯Ø§Ù„Ø© ØªÙƒØ±Ø§Ø± Ø§Ù„ØµÙ (Ù†Ø³Ø® Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª)
function duplicateBulkRow(originalId) {
    const originalRow = document.getElementById(`row-${originalId}`);
    addBulkRows(1); // Ø¥Ø¶Ø§ÙØ© ØµÙ Ø¬Ø¯ÙŠØ¯
    
    const container = document.getElementById("bulk-container");
    const newRow = container.lastElementChild;
    
    // Ù†Ø³Ø® Ø§Ù„Ù‚ÙŠÙ…
    newRow.querySelector('.b-name').value = originalRow.querySelector('.b-name').value;
    newRow.querySelector('.b-cat').value = originalRow.querySelector('.b-cat').value;
    newRow.querySelector('.b-desc').value = originalRow.querySelector('.b-desc').value;
    
    // Ù†Ø³Ø® Ø§Ù„Ø³Ø¹Ø±
    const mode = originalRow.querySelector(`input[name="mode-${originalId}"]:checked`).value;
    const newId = newRow.id.replace('row-', '');
    
    if(mode === 'single') {
        newRow.querySelector('.b-price').value = originalRow.querySelector('.b-price').value;
        newRow.querySelector('.b-old-price').value = originalRow.querySelector('.b-old-price').value;
    }
    
    // ØªØ£Ø«ÙŠØ± Ø¨ØµØ±ÙŠ Ù„Ù„Ù†Ø³Ø®
    newRow.style.borderColor = "var(--primary)";
    setTimeout(() => newRow.style.borderColor = "var(--border-color)", 500);
}

// 5. ØªØ­Ø¯ÙŠØ« Ø¯Ø§Ù„Ø© Ø§Ù„Ø­ÙØ¸ (Ù„ØªØ¹Ù…Ù„ Ù…Ø¹ Ø§Ù„ÙƒÙ„Ø§Ø³ Ø§Ù„Ø¬Ø¯ÙŠØ¯)
async function submitBulkAll() {
    const rows = document.querySelectorAll(".bulk-row-pro"); // ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙƒÙ„Ø§Ø³ Ù‡Ù†Ø§
    const rId = document.getElementById("restaurant-id").value;
    let promises = [];
    let validCount = 0;

    for (const row of rows) {
        const rowId = row.id.split("-")[1];
        const name = row.querySelector(".b-name").value;
        const cat = row.querySelector(".b-cat").value;
        const desc = row.querySelector(".b-desc").value;
        const imageFile = row.querySelector(".b-image").files[0];
        const mode = row.querySelector(`input[name="mode-${rowId}"]:checked`).value;

        if (!name || !cat) continue;

        let finalPrice = 0;
        let finalOldPrice = 0;
        let finalSizes = [];

        if (mode === "single") {
            const priceVal = row.querySelector(".b-price").value;
            if (!priceVal) continue;
            finalPrice = parseFloat(priceVal);
            finalOldPrice = parseFloat(row.querySelector(".b-old-price").value) || 0;
        } else {
            // Ù…Ù†Ø·Ù‚ Ø§Ù„Ø£Ø­Ø¬Ø§Ù… (Ù†ÙØ³ Ø§Ù„Ø³Ø§Ø¨Ù‚)
            const sizeRows = row.querySelectorAll(".b-size-row");
            if (sizeRows.length === 0) continue;
            let hasValid = false;
            sizeRows.forEach(sr => {
                const sName = sr.querySelector(".bs-name").value;
                const sPrice = parseFloat(sr.querySelector(".bs-price").value);
                let sOld = parseFloat(sr.querySelector(".bs-old").value) || 0;
                if(sName && sPrice) {
                    finalSizes.push({name: sName, price: sPrice, oldPrice: sOld});
                    hasValid = true;
                }
            });
            if(!hasValid) continue;
            finalPrice = finalSizes[0].price;
        }

        validCount++;
        const formData = new FormData();
        formData.append("restaurantId", rId);
        formData.append("name", JSON.stringify({ ar: name, en: name }));
        formData.append("description", JSON.stringify({ ar: desc, en: "" }));
        formData.append("category", cat);
        formData.append("price", finalPrice);
        formData.append("oldPrice", finalOldPrice);
        formData.append("sizes", JSON.stringify(finalSizes));
        if (imageFile) formData.append("image", imageFile);

        promises.push(fetch("/api/v1/products", {
             method: "POST",
             headers: { Authorization: `Bearer ${token}` },
             body: formData,
        }));
    }

    if (validCount === 0) return Swal.fire("ØªÙ†Ø¨ÙŠÙ‡", "Ø§Ù…Ù„Ø£ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù†ØªØ¬ ÙˆØ§Ø­Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„", "warning");

    Swal.showLoading();
    try {
        await Promise.all(promises);
        Swal.close();
        Swal.fire({ toast: true, icon: "success", title: `ØªÙ… Ø±ÙØ¹ ${validCount} Ù…Ù†ØªØ¬Ø§Øª` });
        document.getElementById("bulk-container").innerHTML = "";
        addBulkRows(1); // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ†
        loadProducts();
    } catch (e) {
        Swal.fire("Ø®Ø·Ø£", "Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø±ÙØ¹", "error");
    }
}

// Ø§Ø¬Ø¹Ù„ addBulkRow Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© ØªØ³ØªØ¯Ø¹ÙŠ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ù„Ø¶Ù…Ø§Ù† Ø¹Ø¯Ù… Ø­Ø¯ÙˆØ« Ø£Ø®Ø·Ø§Ø¡
window.addBulkRow = function() { addBulkRows(1); };

      const themesLibrary = [
        {
          id: "default",
          name: "Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ",
          primary: "#4338ca",
          bg: "#F3F4F6",
          type: "color",
          font: "Tajawal",
          radius: 16,
          style: "solid",
          layout: "modern",
        },
        {
          id: "dark_lux",
          name: "ÙØ®Ø§Ù…Ø©",
          primary: "#D4AF37",
          bg: "#121212",
          type: "color",
          font: "Amiri",
          radius: 8,
          style: "glass",
          layout: "focus",
        },
        {
          id: "fresh",
          name: "ÙØ±ÙŠØ´",
          primary: "#10b981",
          bg: "#ecfdf5",
          type: "color",
          font: "Almarai",
          radius: 24,
          style: "solid",
          layout: "grid",
        },
        {
          id: "burger",
          name: "Ø¨Ø±Ø¬Ø±",
          primary: "#f59e0b",
          bg: "#1f2937",
          type: "color",
          font: "Cairo",
          radius: 30,
          style: "outlined",
          layout: "modern",
        },
        {
          id: "sky",
          name: "Ø³Ù…Ø§ÙˆÙŠ",
          primary: "#0ea5e9",
          bg: "#f0f9ff",
          type: "color",
          font: "Tajawal",
          radius: 12,
          style: "glass",
          layout: "list",
        },
        {
          id: "paper",
          name: "ÙˆØ±Ù‚ÙŠ",
          primary: "#4b5563",
          bg: "#fffbeb",
          type: "color",
          font: "Cairo",
          radius: 4,
          style: "outlined",
          layout: "minimal",
        },
        {
          id: "neon",
          name: "Ù†ÙŠÙˆÙ† (Cyberpunk)",
          primary: "#0ff",
          bg: "#050505",
          type: "color",
          font: "Cairo",
          radius: 0,
          style: "neon",
          layout: "focus",
        },
        {
          id: "soft",
          name: "Ø³ÙˆÙØª (3D)",
          primary: "#8899a6",
          bg: "#e0e5ec",
          type: "color",
          font: "Tajawal",
          radius: 20,
          style: "neumorphism",
          layout: "modern",
        },
        {
          id: "luxury",
          name: "ÙØ®Ø§Ù…Ø© (Royal)",
          primary: "#D4AF37",
          bg: "#1a1a1a",
          type: "pattern",
          font: "Amiri",
          radius: 8,
          style: "glass",
          layout: "magazine",
        },
        {
          id: "brutal",
          name: "Ø¨Ø±ÙˆØªØ§Ù„ (Trend)",
          primary: "#000000",
          bg: "#fffd00",
          type: "color",
          font: "Cairo",
          radius: 0,
          style: "brutalism",
          layout: "zigzag",
        },
        {
          id: "oriental",
          name: "Ø´Ø±Ù‚ÙŠ (Ø£ØµÙŠÙ„)",
          primary: "#c2410c",
          bg: "#fff7ed",
          type: "pattern",
          font: "Amiri",
          radius: 12,
          style: "solid",
          layout: "list",
        },
        {
          id: "gold_dust",
          name: "ØºØ¨Ø§Ø± Ø§Ù„Ø°Ù‡Ø¨",
          primary: "#FFD700",
          bg: "#0f0f0f",
          type: "color",
          font: "Amiri",
          radius: 20,
          style: "glass",
          layout: "focus",
          animationClass: "theme-gold-dust",
          resNameColor: "#FFD700"
        },
        {
          id: "royal_pulse",
          name: "Ù†Ø¨Ø¶ Ù…Ù„ÙƒÙŠ",
          primary: "#9b59b6",
          bg: "#1a0b2e",
          type: "color",
          font: "Cairo",
          radius: 12,
          style: "outlined",
          layout: "modern",
          animationClass: "theme-royal-pulse",
          resNameColor: "#e0bbff"
        },
        {
          id: "midnight_float",
          name: "Ù„ÙŠÙ„Ø© Ø¹Ø§Ø¦Ù…Ø©",
          primary: "#38bdf8",
          bg: "#0f172a",
          type: "color",
          font: "Tajawal",
          radius: 24,
          style: "glass",
          layout: "grid",
          animationClass: "theme-midnight-float",
          resNameColor: "#38bdf8"
        },
        {
          id: "elegant_fade",
          name: "Ø£Ù†Ø§Ù‚Ø© Ù‡Ø§Ø¯Ø¦Ø©",
          primary: "#57534e",
          bg: "#fafaf9",
          type: "pattern",
          font: "Almarai",
          radius: 8,
          style: "solid",
          layout: "list",
          animationClass: "theme-elegant-fade",
          resNameColor: "#292524"
        },
        {
          id: "cyber_glow",
          name: "Ø³Ø§ÙŠØ¨Ø± Ù†ÙŠÙˆÙ† (Cyber)",
          primary: "#00ff9d",
          bg: "#000000",
          type: "color",
          font: "Zain",
          radius: 0,
          style: "neon",
          layout: "zigzag",
          animationClass: "theme-cyber-glow",
          resNameColor: "#00ff9d"
        },
        // --- New 10 Luxury Themes ---
        {
          id: "cosmic_nebula",
          name: "Ø³Ø¯ÙŠÙ… ÙƒÙˆÙ†ÙŠ (Cosmic)",
          primary: "#c084fc",
          bg: "#0b0014",
          type: "color",
          font: "Cairo",
          radius: 20,
          style: "glass",
          layout: "focus",
          animationClass: "theme-cosmic",
          resNameColor: "#e879f9"
        },
        {
          id: "liquid_gold",
          name: "Ø°Ù‡Ø¨ Ø³Ø§Ø¦Ù„ (Liquid Gold)",
          primary: "#FFD700",
          bg: "#000000",
          type: "color",
          font: "Amiri",
          radius: 12,
          style: "solid",
          layout: "magazine",
          animationClass: "theme-liquid-gold",
          resNameColor: "#FFD700"
        },
        {
          id: "matrix_code",
          name: "Ø§Ù„Ù…ØµÙÙˆÙØ© (Matrix)",
          primary: "#00FF41",
          bg: "#0D0208",
          type: "color",
          font: "Courier New", 
          radius: 0,
          style: "outlined",
          layout: "minimal",
          animationClass: "theme-matrix",
          resNameColor: "#00FF41"
        },
        {
          id: "ocean_glass",
          name: "Ø²Ø¬Ø§Ø¬ Ø§Ù„Ù…Ø­ÙŠØ· (Ocean Glass)",
          primary: "#0ea5e9",
          bg: "#f0f9ff",
          type: "color",
          font: "Tajawal",
          radius: 24,
          style: "glass",
          layout: "grid",
          animationClass: "theme-ocean-glass",
          resNameColor: "#0284c7"
        },
        {
          id: "volcanic_ember",
          name: "Ø¬Ù…Ø± Ø¨Ø±ÙƒØ§Ù†ÙŠ (Volcanic)",
          primary: "#f97316",
          bg: "#1a0500",
          type: "color",
          font: "Cairo",
          radius: 30,
          style: "solid",
          layout: "modern",
          animationClass: "theme-volcano",
          resNameColor: "#fdba74"
        },
        {
          id: "diamond_prism",
          name: "Ù…Ù†Ø´ÙˆØ± Ù…Ø§Ø³ÙŠ (Prism)",
          primary: "#a855f7",
          bg: "#ffffff",
          type: "color",
          font: "Almarai",
          radius: 8,
          style: "outlined",
          layout: "focus",
          animationClass: "theme-prism",
          resNameColor: "#6b21a8"
        },
        {
          id: "retro_vapor",
          name: "Ø±ÙŠØªØ±Ùˆ (Vaporwave)",
          primary: "#ff00ff",
          bg: "#2b003b",
          type: "color",
          font: "Zain",
          radius: 0,
          style: "neon",
          layout: "zigzag",
          animationClass: "theme-vapor",
          resNameColor: "#00ffff"
        },
        {
          id: "frosted_mint",
          name: "Ù†Ø¹Ù†Ø§Ø¹ Ù…Ø«Ù„Ø¬ (Frosted)",
          primary: "#10b981",
          bg: "#ecfdf5",
          type: "color",
          font: "Tajawal",
          radius: 16,
          style: "glass",
          layout: "list",
          animationClass: "theme-frosted",
          resNameColor: "#059669"
        },
        {
          id: "phantom_dark",
          name: "Ø´Ø¨Ø­ Ø§Ù„Ù„ÙŠÙ„ (Phantom)",
          primary: "#f43f5e",
          bg: "#000000",
          type: "color",
          font: "Cairo",
          radius: 50,
          style: "solid",
          layout: "modern",
          animationClass: "theme-phantom",
          resNameColor: "#e11d48"
        },
        {
          id: "holographic_silver",
          name: "Ù‡ÙˆÙ„ÙˆØºØ±Ø§ÙÙŠÙƒ (Holographic)",
          primary: "#64748b",
          bg: "#f8fafc",
          type: "color",
          font: "Almarai",
          radius: 10,
          style: "glass",
          layout: "grid",
          animationClass: "theme-holo",
          resNameColor: "#334155"
        }
      ];

      function renderAnimatedThemes() {
        const container = document.getElementById("animated-theme-library");
        // Ø§Ù„ØªØµØ­ÙŠØ­: ØªØ¹Ø±ÙŠÙ animatedThemesLibrary Ø¹Ù† Ø·Ø±ÙŠÙ‚ ØªØµÙÙŠØ© Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
        const animatedThemesLibrary = themesLibrary.filter(t => t.animationClass);

        if (container) {
          container.innerHTML = "";
          animatedThemesLibrary.forEach((t) => {
            const btn = document.createElement("div");
            btn.style.cssText = "cursor:pointer; text-align:center;";
            btn.onclick = () => applyAnimatedTheme(t);
            btn.innerHTML = `
                <div style="height:50px; border-radius:10px; background:${t.bg}; border:2px solid ${t.primary}; position:relative; overflow:hidden; box-shadow:0 0 10px ${t.primary}40; margin-bottom:5px; display:flex; align-items:center; justify-content:center;">
                    <div style="width:10px; height:10px; background:${t.primary}; border-radius:50%; box-shadow:0 0 5px ${t.primary}"></div>
                </div>
                <div style="font-size:11px; font-weight:bold; color:var(--text-main)">${t.name}</div>
            `;
            container.appendChild(btn);
          });
        }
      }

      function applyAnimatedTheme(t) {
        // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
        setUiParam('primaryColor', t.primary);
        setUiParam('bgType', t.type);
        setUiParam('bgValue', t.bg);
        setUiParam('fontFamily', t.font);
        setUiParam('cardRadius', t.radius);
        setUiParam('cardStyle', t.style);
        setUiParam('layoutType', t.layout);
        
        // ØªØ·Ø¨ÙŠÙ‚ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù†ØµÙˆØµ
        setUiParam('resNameColor', t.resNameColor);
        
        // ØªØ·Ø¨ÙŠÙ‚ ÙƒÙ„Ø§Ø³ Ø§Ù„Ø£Ù†ÙŠÙ…ÙŠØ´Ù†
        setUiParam('animationTheme', t.animationClass);
        
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø¯Ø®Ù„Ø§Øª ÙÙŠ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
        document.getElementById("ui-primaryColor").value = t.primary;
        document.getElementById("ui-fontFamily").value = t.font;
        document.getElementById("ui-cardRadius").value = t.radius;
        document.getElementById("ui-cardStyle").value = t.style;
        document.getElementById("ui-resNameColor").value = t.resNameColor;
        
        if (t.type === "color") document.getElementById("ui-bgColor").value = t.bg;
        
        toggleBgInput();
        
        Swal.fire({
          toast: true,
          position: "top-end",
          icon: "success",
          title: `ØªÙ… ØªØ·Ø¨ÙŠÙ‚ Ø«ÙŠÙ…: ${t.name}`,
          showConfirmButton: false,
          timer: 1000,
        });
      }

      let currentDesign = {
        layoutType: "modern",
        primaryColor: "#B78728",
        bgType: "color",
        bgValue: "#F9F9F9",
        cardStyle: "solid",
        cardRadius: 16,
        fontFamily: "Tajawal",
        heroOverlay: 30,
        heroHeight: 200,
        
        // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù†ØµÙˆØµ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
        showResName: true,
        customResName: "",
        resNameColor: "#b78728",
        
        showResDesc: true,
        customResDesc: "",
        resDescColor: "#ffffff",
        
        showSearch: true,
        searchPlaceholder: "",
        
        headerTextAlignment: "center",
        resNamePosition: "inside", // ğŸŸ¢ Ø¬Ø¯ÙŠØ¯: Ù…ÙƒØ§Ù† Ø§Ù„Ø§Ø³Ù…
        animationTheme: "" // Ù„Ù„Ø«ÙŠÙ…Ø§Øª Ø§Ù„Ù…ØªØ­Ø±ÙƒØ©
      };

      function initDesignStudio(restaurantData) {
        if (restaurantData.customUI) {
          currentDesign = { ...currentDesign, ...restaurantData.customUI };
        }

        const themeContainer = document.getElementById("theme-library");
        if (themeContainer) {
          themeContainer.innerHTML = "";
          themesLibrary.forEach((t) => {
            const btn = document.createElement("div");
            btn.style.cssText = "cursor:pointer; text-align:center;";
            btn.onclick = () => applyTheme(t.id);
            btn.innerHTML = `
                <div style="height:45px; border-radius:10px; background:${t.bg}; border:2px solid ${t.primary}; position:relative; overflow:hidden; box-shadow:0 2px 5px rgba(0,0,0,0.1); margin-bottom:5px;">
                    <div style="position:absolute; bottom:0; width:100%; height:15px; background:${t.primary}"></div>
                </div>
                <div style="font-size:11px; font-weight:bold; color:var(--secondary)">${t.name}</div>
            `;
            themeContainer.appendChild(btn);
          });
        }

        if (document.getElementById("ui-heroOverlay"))
          document.getElementById("ui-heroOverlay").value =
            currentDesign.heroOverlay || 30;
        if (document.getElementById("ui-heroHeight"))
          document.getElementById("ui-heroHeight").value =
            currentDesign.heroHeight || 200;

        document.getElementById("ui-primaryColor").value = currentDesign.primaryColor;
        // âœ… ØªØ­Ù…ÙŠÙ„ Ù„ÙˆÙ† Ø¹Ù†Ø§ÙˆÙŠÙ† Ø§Ù„Ø£Ù‚Ø³Ø§Ù…
        const secColor = currentDesign.secTitleColor || "#2d2d2d";
        const secColorInput = document.getElementById("ui-secTitleColor");
        const secColorPreview = document.getElementById("color-preview-secTitle");
        
        if (secColorInput) secColorInput.value = secColor;
        if (secColorPreview) secColorPreview.style.backgroundColor = secColor;
        // âœ… ØªØ­Ù…ÙŠÙ„ Ù„ÙˆÙ† Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬
        const pTitleColor = currentDesign.prodTitleColor || "#2d2d2d";
        const pTitleInput = document.getElementById("ui-prodTitleColor");
        const pTitlePreview = document.getElementById("color-preview-prodTitle");
        if (pTitleInput) pTitleInput.value = pTitleColor;
        if (pTitlePreview) pTitlePreview.style.backgroundColor = pTitleColor;

        // âœ… ØªØ­Ù…ÙŠÙ„ Ù„ÙˆÙ† Ø§Ù„Ø³Ø¹Ø±
        const pPriceColor = currentDesign.prodPriceColor || "#b78728";
        const pPriceInput = document.getElementById("ui-prodPriceColor");
        const pPricePreview = document.getElementById("color-preview-prodPrice");
        if (pPriceInput) pPriceInput.value = pPriceColor;
        if (pPricePreview) pPricePreview.style.backgroundColor = pPriceColor;
        document.getElementById("ui-bgType").value = currentDesign.bgType;
        document.getElementById("ui-cardStyle").value = currentDesign.cardStyle;

        // ØªØ­Ù…ÙŠÙ„ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù†ØµÙˆØµ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
        document.getElementById("ui-showResName").checked = currentDesign.showResName !== false;
        document.getElementById("ui-customResName").value = currentDesign.customResName || "";
        document.getElementById("ui-resNameColor").value = currentDesign.resNameColor || "#b78728";

        document.getElementById("ui-showResDesc").checked = currentDesign.showResDesc !== false;
        document.getElementById("ui-customResDesc").value = currentDesign.customResDesc || "";
        document.getElementById("ui-resDescColor").value = currentDesign.resDescColor || "#ffffff";

        document.getElementById("ui-showSearch").checked = currentDesign.showSearch !== false;
        document.getElementById("ui-searchPlaceholder").value = currentDesign.searchPlaceholder || "";
        
        document.getElementById("ui-headerAlign").value = currentDesign.headerTextAlignment || "center";
        
        // ğŸŸ¢ Ø¬Ø¯ÙŠØ¯: ØªØ­Ù…ÙŠÙ„ Ù‚ÙŠÙ…Ø© Ù…ÙƒØ§Ù† Ø§Ù„Ø§Ø³Ù…
        const resNamePos = document.getElementById("ui-resNamePosition");
        // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„Ù‚ÙŠÙ…Ø© Ù…ÙˆØ¬ÙˆØ¯Ø©ØŒ ÙˆØ¥Ù„Ø§ Ù†Ø¹ÙˆØ¯ Ù„Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ
        if(resNamePos) {
             resNamePos.value = currentDesign.resNamePosition || "inside";
             // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø¨Ø§Ø´Ø± ÙŠØ¯ÙˆÙŠØ§Ù‹ Ù„Ù„ØªØ£ÙƒØ¯
             setUiParam('resNamePosition', resNamePos.value); 
        }
        
        renderAnimatedThemes(); // Ø±Ø³Ù… Ø§Ù„Ø«ÙŠÙ…Ø§Øª Ø§Ù„Ù…ØªØ­Ø±ÙƒØ©
        document.getElementById("ui-cardRadius").value =
          currentDesign.cardRadius;
        document.getElementById("ui-fontFamily").value =
          currentDesign.fontFamily;
          // ØªØ­Ù…ÙŠÙ„ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø®Ù„ÙÙŠØ©
        // ØªØ­Ù…ÙŠÙ„ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø®Ù„ÙÙŠØ©
    currentDesign.bgSize = currentDesign.bgSize || "cover";
    currentDesign.bgRepeat = currentDesign.bgRepeat || "no-repeat";
    currentDesign.bgAttachment = currentDesign.bgAttachment || "fixed";
    currentDesign.bgPosition = currentDesign.bgPosition || "center";
    currentDesign.bgOverlay = currentDesign.bgOverlay !== undefined ? currentDesign.bgOverlay : 90;

    document.getElementById("ui-bgSize").value = currentDesign.bgSize;
    document.getElementById("ui-bgRepeat").value = currentDesign.bgRepeat;
    document.getElementById("ui-bgAttachment").value = currentDesign.bgAttachment;
    document.getElementById("ui-bgPosition").value = currentDesign.bgPosition;
    
    // ØªØ­Ù…ÙŠÙ„ Ù‚ÙŠÙ…Ø© Ø§Ù„ØªØ¹ØªÙŠÙ… (Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø´Ø±ÙŠØ· Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹)
    const overlayInput = document.getElementById("ui-bgOverlay");
    if(overlayInput) {
        overlayInput.value = currentDesign.bgOverlay;
        const overlayVal = document.getElementById("bgOverlayVal");
        if(overlayVal) overlayVal.innerText = currentDesign.bgOverlay + '%';
    }

        toggleBgInput();
        if (currentDesign.bgType === "color") {
          const bgColorInput = document.getElementById("ui-bgColor");
          if (bgColorInput) bgColorInput.value = currentDesign.bgValue;
        } else {
           // Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ¹ÙŠÙŠÙ† Ù‚ÙŠÙ…Ø© Ù„Ø­Ù‚Ù„ Ø§Ù„Ù…Ù„ÙØ§Øª Ø¨Ø±Ù…Ø¬ÙŠØ§Ù‹ØŒ ÙˆØ¨Ø¯Ù„Ø§Ù‹ Ù…Ù† Ø°Ù„Ùƒ Ù†Ø¹Ø±Ø¶ Ø§Ù„ØµÙˆØ±Ø© ÙÙŠ Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©
           const bgPreview = document.getElementById("bg-preview");
           if (bgPreview && currentDesign.bgValue) {
               bgPreview.src = currentDesign.bgValue;
               bgPreview.style.display = "block";
           }
        }

        if (currentDesign.heroImage) {
          const heroPreview = document.getElementById("hero-preview");
          heroPreview.src = currentDesign.heroImage.replace(/\\/g, "/");
          heroPreview.style.display = "block";
        }

        document
          .querySelectorAll(".btn-layout")
          .forEach((b) => b.classList.remove("active"));
        document
          .getElementById(`btn-layout-${currentDesign.layoutType}`)
          .classList.add("active");

        const previewFrame = document.getElementById("live-preview");
        previewFrame.src = `/menu/${restaurantData.slug}`;

        previewFrame.onload = () => {
          updatePreview();
        };
      }

      function setUiParam(key, value) {
        currentDesign[key] = value;
        if (key === "cardRadius")
          document.getElementById("radius-val").innerText = value;
        if (key === "layoutType") {
          document
            .querySelectorAll(".btn-layout")
            .forEach((b) => b.classList.remove("active"));
          document
            .getElementById(`btn-layout-${value}`)
            .classList.add("active");
        }
        updatePreview();
      }

      function toggleBgInput() {
        const type = document.getElementById("ui-bgType").value;
        currentDesign.bgType = type;

        const colorInput = document.getElementById("ui-bgColor");
        const imgContainer = document.getElementById("ui-bgImage-container");

        if (type === "color") {
          colorInput.classList.remove("hidden");
          imgContainer.classList.add("hidden");
        } else if (type === "image") {
          colorInput.classList.add("hidden");
          imgContainer.classList.remove("hidden");
        } else {
          colorInput.classList.remove("hidden");
          imgContainer.classList.add("hidden");
        }
        updatePreview();
      }
      function updatePreview() {
        const iframe = document.getElementById("live-preview");
        if (iframe.contentWindow) {
          iframe.contentWindow.postMessage(
            { type: "UPDATE_THEME", config: currentDesign },
            "*",
          );
        }
      }

      async function saveDesignSettings() {
        const rId = document.getElementById("restaurant-id").value;
        const bgFile = document.getElementById("ui-bgFile").files[0];

        const formData = new FormData();

        formData.append("customUI", JSON.stringify(currentDesign));

        if (bgFile && currentDesign.bgType === "image") {
          formData.append("bgImage", bgFile);
        }

        const heroFile = document.getElementById("ui-heroFile").files[0];
        if (heroFile) {
          formData.append("heroImage", heroFile);
        }

        Swal.showLoading();
        try {
          const res = await fetch(`/api/v1/restaurants/${rId}`, {
            method: "PATCH",
            headers: { Authorization: `Bearer ${token}` },
            body: formData,
          });

          if (res.ok) {
            Swal.fire({
              icon: "success",
              title: "ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØµÙ…ÙŠÙ… ÙˆØ§Ù„ØµÙˆØ±Ø©",
              timer: 1500,
              showConfirmButton: false,
            });
          } else {
            throw new Error("ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸");
          }
        } catch (e) {
          console.error(e);
          Swal.fire("Ø®Ø·Ø£", "Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­ÙØ¸", "error");
        }
      }

      const defaultDesign = {
        layoutType: "modern",
        primaryColor: "#B78728",
        bgType: "color",
        bgValue: "#F9F9F9",
        cardStyle: "solid",
        cardRadius: 16,
        fontFamily: "Tajawal",
      };

      function resetDesign() {
        Swal.fire({
          title: "Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ",
          text: "Ø³ÙŠØ¹ÙˆØ¯ Ø§Ù„ØªØµÙ…ÙŠÙ… Ù„Ù„Ø´ÙƒÙ„ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ (Ù„Ù† ÙŠØªÙ… Ø§Ù„Ø­ÙØ¸ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¥Ù„Ø§ Ø¨Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø­ÙØ¸).",
          icon: "warning",
          showCancelButton: true,
          confirmButtonColor: "#3085d6",
          cancelButtonColor: "#d33",
          confirmButtonText: "Ù†Ø¹Ù…ØŒ Ø§Ø³ØªØ¹Ø¯ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ",
          cancelButtonText: "Ø¥Ù„ØºØ§Ø¡",
        }).then((result) => {
          if (result.isConfirmed) {
            currentDesign = { ...defaultDesign };

            document.getElementById("ui-primaryColor").value =
              currentDesign.primaryColor;
            document.getElementById("ui-bgType").value = currentDesign.bgType;
            document.getElementById("ui-cardStyle").value =
              currentDesign.cardStyle;
            document.getElementById("ui-cardRadius").value =
              currentDesign.cardRadius;
            document.getElementById("ui-fontFamily").value =
              currentDesign.fontFamily;
            document.getElementById("radius-val").innerText =
              currentDesign.cardRadius;

            toggleBgInput();
            if (currentDesign.bgType === "color") {
              document.getElementById("ui-bgColor").value =
                currentDesign.bgValue;
            } else {
              document.getElementById("ui-bgImage").value = "";
            }

            document
              .querySelectorAll(".btn-layout")
              .forEach((b) => b.classList.remove("active"));
            document
              .getElementById(`btn-layout-${currentDesign.layoutType}`)
              .classList.add("active");

            updatePreview();

            Swal.fire({
              toast: true,
              position: "top-end",
              icon: "info",
              title: "ØªÙ… Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø´ÙƒÙ„ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ",
              showConfirmButton: false,
              timer: 1500,
            });
          }
        });
      }

      function handleBgUpload(input) {
        previewImage(input, "bg-preview");

        if (input.files && input.files[0]) {
          const reader = new FileReader();
          reader.onload = function (e) {
            setUiParam("bgValue", e.target.result);
          };
          reader.readAsDataURL(input.files[0]);
        }
      }
      function handleHeroUpload(input) {
        previewImage(input, "hero-preview");
        if (input.files && input.files[0]) {
          const reader = new FileReader();
          reader.onload = function (e) {
            setUiParam("heroImage", e.target.result);
          };
          reader.readAsDataURL(input.files[0]);
        }
      }

      let socket;

      window.loadOrders = async function () {
        const rId = document.getElementById("restaurant-id").value;

        // 1. Ø¥ØµÙ„Ø§Ø­: Ù„Ùˆ Ø§Ù„Ù€ ID Ù…Ø´ Ù…ÙˆØ¬ÙˆØ¯ (Ù„Ø³Ù‡ Ù…Ø§Ù„Ø­Ù‚Ø´ ÙŠØ­Ù…Ù„)ØŒ Ù†ÙˆÙ‚Ù Ø§Ù„Ø¯Ø§Ù„Ø© ÙÙˆØ±Ø§Ù‹ Ø¹Ø´Ø§Ù† Ù…Ø§ÙŠØ­ØµÙ„Ø´ Ø®Ø·Ø£
        if (!rId) return;

        const badge = document.getElementById("live-badge");
        if (badge) {
          badge.classList.add("hidden");
          badge.innerText = "0";
        }

        const container = document.getElementById("orders-grid");
        if (!container) return;

        // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„ ÙÙ‚Ø· Ù„Ùˆ Ø§Ù„ÙƒÙˆÙ†ØªÙŠÙ†Ø± ÙØ§Ø¶ÙŠ
        if(container.innerHTML.trim() === "") {
            container.innerHTML = '<div class="loading"><i class="fas fa-circle-notch fa-spin"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>';
        }

        try {
          const res = await fetch(`/api/v1/orders/active/${rId}`, {
            headers: { Authorization: `Bearer ${token}` },
          });

          // 2. Ø¥ØµÙ„Ø§Ø­ Ù†Ù‡Ø§Ø¦ÙŠ: Ø§Ù„ØªØ£ÙƒØ¯ Ø¥Ù† Ø§Ù„Ø±Ø¯ JSON Ù…Ø´ HTML Ù‚Ø¨Ù„ Ù…Ø§ Ù†ÙÙƒÙ‡
          const contentType = res.headers.get("content-type");
          if (!res.ok || !contentType || !contentType.includes("application/json")) {
             console.warn("Server returned HTML/Error instead of JSON");
             // Ù…Ù…ÙƒÙ† Ù†ÙˆÙ‚Ù Ù‡Ù†Ø§ Ø£Ùˆ Ù†Ù…Ø³Ø­ Ø§Ù„Ù„ÙˆØ¯ÙŠÙ†Ø¬ Ø¨Ø³ Ø¹Ø´Ø§Ù† Ù…Ø§ÙŠØ¶Ø±Ø¨Ø´ Ø§ÙŠØ±ÙˆØ±
             return; 
          }

          const data = await res.json();
          container.innerHTML = "";

          if (!data.data || !data.data.orders || data.data.orders.length === 0) {
            container.innerHTML =
              '<div style="grid-column: 1/-1; text-align:center; padding:40px; color:var(--secondary)"><i class="fas fa-clipboard-list fa-3x" style="margin-bottom:15px; opacity:0.5"></i><p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ù†Ø´Ø·Ø© Ø­Ø§Ù„ÙŠØ§Ù‹.</p></div>';
            return;
          }

          data.data.orders.forEach((order) => {
            container.innerHTML += window.createOrderCardHTML(order);
          });
        } catch (e) {
          console.error(e);
          container.innerHTML =
            '<p style="color:red; text-align:center">Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</p>';
        }
      };

      // --- Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ ØªÙ†Ø¨ÙŠÙ‡ Ø§Ù„Ø¥Ù„ØºØ§Ø¡ (ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØª ÙˆØ§Ù„Ø±Ø³Ø§Ù„Ø©) ---
    if(typeof socket !== 'undefined' && !socket.hasListeners("order_cancelled_alert")) {
        socket.on("order_cancelled_alert", (order) => {
            const audio = document.getElementById("order-sound");
            if(audio) { audio.currentTime = 0; audio.play().catch(e=>console.log(e)); }
            
            Swal.fire({
                position: 'top-end',
                icon: 'warning',
                title: `âš ï¸ ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø·Ù„Ø¨!`,
                text: `Ø§Ù„Ø·Ù„Ø¨ Ø±Ù‚Ù… #${order.orderNum} ØªÙ… Ø¥Ù„ØºØ§Ø¤Ù‡ Ù…Ù† Ù‚Ø¨Ù„ Ø§Ù„Ø¹Ù…ÙŠÙ„`,
                showConfirmButton: false,
                timer: 8000,
                toast: true,
                background: '#fef2f2',
                color: '#b91c1c'
            });
            if(typeof loadOrders === 'function') loadOrders();
        });
        // ÙˆØ¶Ø¹ Ø¹Ù„Ø§Ù…Ø© Ù„Ù…Ù†Ø¹ ØªÙƒØ±Ø§Ø± Ø§Ù„Ù…Ø³ØªÙ…Ø¹
        socket.hasListeners = (ev) => true; 
    }

window.createOrderCardHTML = function (order) {
        const role =
          currentUserRole && currentUserRole !== ""
            ? currentUserRole
            : "cashier";

        if (
          role === "kitchen" &&
          (order.status === "completed" || order.status === "canceled")
        ) {
          return "";
        }

        const time = new Date(order.createdAt).toLocaleTimeString("ar-EG", {
          hour: "2-digit",
          minute: "2-digit",
        });

        let statusColor = "#f59e0b";
        let statusText = "Ø¬Ø¯ÙŠØ¯ (Ø§Ù†ØªØ¸Ø§Ø±)";
        let cardBg = "var(--surface)";

        if (order.status === "preparing") {
          statusColor = "#3b82f6";
          statusText = "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ¬Ù‡ÙŠØ²";
        }

        let textColor = "var(--text-main)";

        if (order.status === "completed") {
          statusColor = "#10b981";
          statusText = "Ù…ÙƒØªÙ…Ù„";
          cardBg = "#ecfdf5";
          textColor = "#1f2937";
        }
        if (order.status === "canceled") {
          statusColor = "#ef4444";
          statusText = "Ù…Ù„ØºÙŠ";
          cardBg = "#fee2e2";
          textColor = "#1f2937";
        }

        let itemsHtml = "";
        order.items.forEach((item) => {
          itemsHtml += `<div style="display:flex; justify-content:space-between; margin-bottom:5px; font-size:14px; border-bottom:1px solid #eee; padding-bottom:5px;">
            <span>- ${item.name} <span style="font-weight:bold">x${item.qty}</span></span>
            ${role !== "kitchen" ? `<span>${item.price * item.qty}</span>` : ""} </div>`;
        });

        if (order.discountAmount > 0 && role !== "kitchen") {
          itemsHtml += `<div style="display:flex; justify-content:space-between; margin-bottom:5px; font-size:14px; color:var(--danger); font-weight:bold;">
            <span>Ø®ØµÙ… ÙƒÙˆØ¨ÙˆÙ† (${order.couponCode || ""}):</span>
            <span>-${order.discountAmount}</span>
        </div>`;
        }

        const orderDataEncoded = encodeURIComponent(JSON.stringify(order));
        let actions = "";

        const printBtn =
          role !== "kitchen"
            ? `<button class="btn btn-outline" onclick="window.printOrder('${orderDataEncoded}')" style="margin-left:5px; color:var(--text-main);" title="Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ÙØ§ØªÙˆØ±Ø©"><i class="fas fa-print"></i></button>`
            : "";

        if (order.status === "pending") {
          actions = `${printBtn} <button class="btn btn-primary" onclick="window.updateOrderStatus('${order._id}', 'preparing')" style="width:100%; margin-left:5px;">Ø¨Ø¯Ø¡ Ø§Ù„ØªØ­Ø¶ÙŠØ± <i class="fas fa-fire"></i></button>`;
        } else if (order.status === "preparing") {
          actions = `${printBtn} <button class="btn btn-success" onclick="window.updateOrderStatus('${order._id}', 'completed')" style="width:100%; margin-left:5px;">ØªÙ… Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ <i class="fas fa-check"></i></button>`;
        } else {
          actions = `${printBtn}`;
        }

        const cancelBtn =
          role !== "kitchen" &&
          order.status !== "completed" &&
          order.status !== "canceled"
            ? `<button class="btn btn-outline" onclick="window.updateOrderStatus('${order._id}', 'canceled')" style="color:var(--danger); border-color:var(--danger); padding:0 15px;"><i class="fas fa-times"></i></button>`
            : "";

        const tableDisplay =
          order.tableNumber === 0
            ? "ØªÙŠÙƒ Ø£ÙˆØ§ÙŠ ğŸƒ"
            : `Ø·Ø§ÙˆÙ„Ø©: ${order.tableNumber}`;

        const displayNum = order.orderNum
          ? `#${order.orderNum}`
          : `#${String(order._id).slice(-4)}`;

        return `
        <div class="card" id="order-${order._id}" style="border-top: 4px solid ${statusColor}; padding:15px; position:relative; background: ${cardBg}; color: ${textColor}">
            <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                <span style="font-weight:bold; font-size:18px; background:var(--primary); color:white; padding:2px 12px; border-radius:8px">${displayNum}</span>
                <span id="status-text-${order._id}" style="background:${statusColor}20; color:${statusColor}; padding:2px 8px; border-radius:10px; font-size:12px; font-weight:bold;">${statusText}</span>
            </div>
            <div style="font-weight:bold; font-size:18px; margin-bottom:5px;">${tableDisplay}</div>
            <div style="color:var(--secondary); font-size:12px; margin-bottom:15px;"><i class="far fa-clock"></i> ${time}</div>
            
            <div style="background:var(--bg); padding:10px; border-radius:8px; margin-bottom:15px; max-height:150px; overflow-y:auto;">
                ${itemsHtml}
            </div>
            
            ${
              role !== "kitchen"
                ? `
            <div style="display:flex; justify-content:space-between; font-weight:bold; margin-bottom:15px; border-top:1px dashed var(--border-color); padding-top:10px;">
                <span>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ:</span>
                <span style="color:var(--primary); font-size:18px">${order.totalPrice} Ø¬.Ù…</span>
            </div>`
                : ""
            } 
            
            <div id="actions-${order._id}" style="display:flex; justify-content:space-between;">
                <div style="flex:1; display:flex;">${actions}</div>
                ${cancelBtn}
            </div>
        </div>
    `;
      };
      window.updateOrderStatus = async function (orderId, status) {
        try {
          const btn = document.querySelector(`#order-${orderId} button`);
          if (btn) {
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
          }

          await fetch(`/api/v1/orders/status/${orderId}`, {
            method: "PATCH",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${token}`,
            },
            body: JSON.stringify({ status }),
          });

          const card = document.getElementById(`order-${orderId}`);
          if (card) {
            if (status === "completed") {
              card.style.background = "#ecfdf5";
              card.style.borderTopColor = "#10b981";
              const statusText = document.getElementById(
                `status-text-${orderId}`,
              );
              if (statusText) {
                statusText.innerText = "Ù…ÙƒØªÙ…Ù„";
                statusText.style.color = "#10b981";
              }
              window.loadOrders();
            } else if (status === "preparing") {
              card.style.borderTopColor = "#3b82f6";
              window.loadOrders();
            } else {
              window.loadOrders();
            }
          }
        } catch (e) {
          console.error(e);
          Swal.fire("Ø®Ø·Ø£", "ÙØ´Ù„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø©", "error");
        }
      };

      window.prependOrderCard = function (order) {
        const container = document.getElementById("orders-grid");
        if (container) {
          const html = window.createOrderCardHTML(order);
          container.insertAdjacentHTML("afterbegin", html);
        }
      };

      window.initSocket = function (rId) {
        if (typeof io === 'undefined') {
            console.error("âŒ Socket.io library not loaded!");
            return;
        }
        
        if (socket) return;

        try {
            socket = io({
              transports: ["websocket", "polling"], // Ø¥Ø¶Ø§ÙØ© polling ÙƒØ®ÙŠØ§Ø± Ø§Ø­ØªÙŠØ§Ø·ÙŠ
              upgrade: true,
              reconnection: true,
              reconnectionAttempts: 5
            });
    
            socket.on("connect", () => {
              console.log("âœ… Connected to Live Orders System");
              socket.emit("join-restaurant", rId);
            });
            
            socket.on("connect_error", (err) => {
                console.warn("âš ï¸ Socket connection error:", err.message);
            });
        } catch (e) {
            console.error("ğŸ”¥ Error initializing socket:", e);
        }

        socket.on("order-updated", (updatedOrder) => {
          console.log("ğŸ”„ Order Updated:", updatedOrder);

          const isOrdersPageOpen = !document
            .getElementById("view-orders")
            .classList.contains("hidden");
          if (isOrdersPageOpen) {
            window.loadOrders();
          }
        });
        socket.on("seats_updated", (data) => {
            // data = { total, booked, available }
            if(document.getElementById('res-booked-display')) {
                updateReservationStats(data.total, data.booked);
            }
        });

        socket.on("new-order", (order) => {
          console.log("ğŸ”” New Order Received:", order);

          const audio = document.getElementById("order-sound");
          if (audio) {
            if (currentUserRole === "kitchen") {
              audio.src =
                "https://assets.mixkit.co/active_storage/sfx/alarm-tone-996.wav";
            } else {
              audio.src =
                "https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3";
            }
            audio.currentTime = 0;
            audio
              .play()
              .catch((err) =>
                console.log("ğŸ”Š Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø£ÙŠ Ù…ÙƒØ§Ù† ÙÙŠ Ø§Ù„ØµÙØ­Ø© Ù„ØªÙØ¹ÙŠÙ„ Ø§Ù„ØµÙˆØª"),
              );
          }

          Swal.fire({
            position: "top-end",
            icon: "success",
            title: `Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯! Ø·Ø§ÙˆÙ„Ø©: ${order.tableNumber}`,
            showConfirmButton: false,
            timer: 3000,
            toast: true,
          });

          const isOrdersPageOpen = !document
            .getElementById("view-orders")
            .classList.contains("hidden");

          if (isOrdersPageOpen) {
            window.prependOrderCard(order);
          } else {
            const badge = document.getElementById("live-badge");
            if (badge) {
              let currentCount = parseInt(badge.innerText || "0");
              if (isNaN(currentCount)) currentCount = 0;
              badge.innerText = currentCount + 1;
              badge.classList.remove("hidden");
              badge.style.display = "inline-block";
            }
          }
        });
      };

     function startShiftMonitor() {
        // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯
        const startStr = sessionStorage.getItem("shiftStart");
        const endStr = sessionStorage.getItem("shiftEnd");
        
        if (!startStr || !endStr) return;

        // ØªØ´ØºÙŠÙ„ Ø§Ù„ÙØ­Øµ ÙÙˆØ±Ø§Ù‹
        checkTime(startStr, endStr);

        // ØªØ´ØºÙŠÙ„ Ø§Ù„ÙØ­Øµ ÙƒÙ„ Ø¯Ù‚ÙŠÙ‚Ø©
        setInterval(() => {
          if (typeof currentUserRole !== 'undefined' && currentUserRole !== 'owner') {
            checkTime(startStr, endStr);
          }
        }, 60000);
      }

      function checkTime(startStr, endStr) {
        if (typeof currentUserRole !== 'undefined' && currentUserRole === 'owner') {
            return;
        }

        const now = new Date(Date.now() + serverTimeOffset);
        const currentMins = now.getHours() * 60 + now.getMinutes();

        const [sh, sm] = startStr.split(":").map(Number);
        const [eh, em] = endStr.split(":").map(Number);

        const startMins = sh * 60 + sm;
        const endMins = eh * 60 + em;

        let isWorking = false;

        // Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„Ø´ÙŠÙØª Ø§Ù„Ù„ÙŠ Ø¨ÙŠØ¹Ø¯ÙŠ Ù†Øµ Ø§Ù„Ù„ÙŠÙ„ (Ù…Ø«Ù„Ø§Ù‹ Ù…Ù† 8 Ù…Ø³Ø§Ø¡Ù‹ Ù„Ù€ 2 ØµØ¨Ø§Ø­Ø§Ù‹)
        if (endMins < startMins) {
            // ÙŠØ¹ØªØ¨Ø± Ø´ØºØ§Ù„ Ù„Ùˆ Ø§Ù„ÙˆÙ‚Øª Ø£ÙƒØ¨Ø± Ù…Ù† Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© (Ø¨Ø§Ù„Ù„ÙŠÙ„) Ø£Ùˆ Ø£ØµØºØ± Ù…Ù† Ø§Ù„Ù†Ù‡Ø§ÙŠØ© (Ø§Ù„ÙØ¬Ø±)
            if (currentMins >= startMins || currentMins < endMins) isWorking = true;
        } else {
            // Ø´ÙŠÙØª Ù†Ù‡Ø§Ø±ÙŠ Ø¹Ø§Ø¯ÙŠ
            if (currentMins >= startMins && currentMins < endMins) isWorking = true;
        }

        if (!isWorking) {
            Swal.fire({
                icon: "warning",
                title: "Ø§Ù†ØªÙ‡Ù‰ ÙˆÙ‚Øª Ø§Ù„Ø¹Ù…Ù„",
                text: `Ø£Ù†Øª Ø®Ø§Ø±Ø¬ Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ø¹Ù…Ù„ Ø§Ù„Ø±Ø³Ù…ÙŠØ© (${startStr} - ${endStr})ØŒ Ø³ÙŠØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬.`,
                timer: 4000,
                showConfirmButton: false,
                allowOutsideClick: false
            }).then(() => {
                logout();
            });
            return; // ØªÙˆÙ‚Ù Ù‡Ù†Ø§
        }

        // --- Ù…Ù†Ø·Ù‚ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ Ù‚Ø¨Ù„ Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ Ø¨Ù€ 10 Ø¯Ù‚Ø§Ø¦Ù‚ ---
        // Ù†Ø­Ø³Ø¨ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ ÙÙ‚Ø· Ù„ØºØ±Ø¶ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡
        let remaining = 0;
        if (endMins < startMins) { 
             // Ù„Ùˆ Ø´ÙŠÙØª Ù„ÙŠÙ„ÙŠ
             let tempCurrent = currentMins < startMins ? currentMins + 1440 : currentMins;
             let tempEnd = endMins + 1440;
             remaining = tempEnd - tempCurrent;
        } else {
             remaining = endMins - currentMins;
        }

        if (remaining <= 10 && remaining > 0) {
            if (!sessionStorage.getItem('shift_warning_shown')) {
                Swal.fire({
                    icon: 'info',
                    title: 'ØªÙ†Ø¨ÙŠÙ‡ Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ø¯ÙˆØ§Ù…',
                    text: `Ù…ØªØ¨Ù‚ÙŠ ${remaining} Ø¯Ù‚Ø§Ø¦Ù‚ Ø¹Ù„Ù‰ Ø§Ù†ØªÙ‡Ø§Ø¡ Ø´ÙŠÙØªÙƒ.`,
                    toast: true,
                    position: 'top-end',
                    timer: 8000,
                    showConfirmButton: false,
                    background: '#fffbeb',
                    color: '#92400e'
                });
                const audio = document.getElementById("order-sound");
                if(audio) { audio.play().catch(e=>{}); }
                sessionStorage.setItem('shift_warning_shown', 'true');
            }
        }
      }

    

      function exportToExcel(tableId, filename) {
        const table = document.getElementById(tableId);
        if (!table) return;

        // 1. Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ø¬Ø¯ÙˆÙ„
        const wb = XLSX.utils.table_to_book(table, { sheet: "Sheet1" });

        // 2. Ø¥Ù†Ø´Ø§Ø¡ Ø§Ø³Ù… Ø§Ù„Ù…Ù„Ù Ø¨Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ø­Ø§Ù„ÙŠ
        const date = new Date().toLocaleDateString('ar-EG').replace(/\//g, "-");
        const fullName = `${filename}_${date}.xlsx`;

        // 3. ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ù
        XLSX.writeFile(wb, fullName);
      }

      /* ==========================================
          ğŸš€ POS System Logic (Ù†Ø¸Ø§Ù… Ø§Ù„ÙƒØ§Ø´ÙŠØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯)
          ========================================== */
      let posCart = [];
      
      async function initPosSystem() {
          // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø¥Ø°Ø§ Ù„Ù… ØªÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø©
          if (categoriesData.length === 0) await loadCategories();
          
          // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø¥Ø°Ø§ Ù„Ù… ØªÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø©
          if (!window.allProductsGlobal || window.allProductsGlobal.length === 0) {
              await loadProducts(); 
          }
          
          renderPosCategories();
          renderPosCart();
      }

      function renderPosCategories() {
          const container = document.getElementById('pos-categories-container');
          const prodContainer = document.getElementById('pos-products-container');
          const breadcrumbs = document.getElementById('pos-breadcrumbs');
          const backBtn = document.getElementById('btn-pos-back');
          const searchInput = document.getElementById('pos-search');

          container.innerHTML = '';
          container.classList.remove('hidden');
          prodContainer.classList.add('hidden');
          backBtn.classList.add('hidden');
          if(searchInput) searchInput.value = ''; // ØªØµÙÙŠØ± Ø§Ù„Ø¨Ø­Ø«
          breadcrumbs.innerHTML = '<span style="color:var(--text-main)"><i class="fas fa-layer-group"></i> Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</span>';

          categoriesData.forEach(cat => {
              const img = cat.image ? `<img src="${cat.image}">` : `<div style="font-size:30px; margin-bottom:10px; color:var(--primary)"><i class="fas fa-utensils"></i></div>`;
              
              container.innerHTML += `
                  <div class="pos-cat-card" onclick="openPosCategory('${cat.name}')">
                      ${cat.image ? img : img}
                      <div style="font-weight:bold; font-size:15px;">${cat.name}</div>
                      <div style="font-size:12px; color:var(--secondary); margin-top:2px;">${cat.productCount || 0} Ù…Ù†ØªØ¬</div>
                  </div>
              `;
          });
      }

      function openPosCategory(catName) {
          const catContainer = document.getElementById('pos-categories-container');
          const prodContainer = document.getElementById('pos-products-container');
          const breadcrumbs = document.getElementById('pos-breadcrumbs');
          const backBtn = document.getElementById('btn-pos-back');

          catContainer.classList.add('hidden');
          prodContainer.classList.remove('hidden');
          backBtn.classList.remove('hidden');
          
          breadcrumbs.innerHTML = `
              <span onclick="renderPosCategories()" style="cursor:pointer; color:var(--secondary)">Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</span> 
              <i class="fas fa-chevron-left" style="font-size:12px; margin:0 5px; color:#ccc"></i> 
              <span style="color:var(--primary); font-weight:bold">${catName}</span>
          `;

          // ØªØµÙÙŠØ© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø­Ø³Ø¨ Ø§Ù„Ù‚Ø³Ù… ÙˆØªÙˆÙØ±Ù‡Ø§
          if (!window.allProductsGlobal) window.allProductsGlobal = []; // Ø³Ø·Ø± Ø­Ù…Ø§ÙŠØ© Ù„Ù…Ù†Ø¹ Ø§Ù„Ø®Ø·Ø£// ØªØµÙÙŠØ© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø­Ø³Ø¨ Ø§Ù„Ù‚Ø³Ù… ÙˆØªÙˆÙØ±Ù‡Ø§
          const productsList = window.allProductsGlobal || [];
          const products = productsList.filter(p => p.category === catName && p.isAvailable);
          renderPosProductsGrid(products);
      }

      function renderPosProductsGrid(products) {
          const container = document.getElementById('pos-products-container');
          container.innerHTML = '';

          if (products.length === 0) {
              container.innerHTML = '<div style="grid-column:1/-1; text-align:center; padding:40px; color:var(--secondary);"><i class="fas fa-box-open fa-3x" style="opacity:0.3; margin-bottom:15px;"></i><p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª Ù…ØªØ§Ø­Ø© ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ù‚Ø³Ù…</p></div>';
              return;
          }

          products.forEach(p => {
              // ØªÙ… Ø§Ù„Ø¥ØµÙ„Ø§Ø­: Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù‚ÙŠÙ…Ø© ÙØ§Ø±ØºØ© Ù„ØªØ¬Ù†Ø¨ Ø·Ù„Ø¨ Ø±Ø§Ø¨Ø· Ø®Ø§Ø±Ø¬ÙŠ
const img = p.image || ''; 
const imgHTML = img 
    ? `<img src="${img}" class="pos-prod-img">` 
    : `<div class="pos-prod-img" style="display:flex;align-items:center;justify-content:center;background:#f1f5f9;color:#cbd5e1"><i class="fas fa-image fa-2x"></i></div>`;
              const pData = encodeURIComponent(JSON.stringify(p));
              
              let priceDisplay = `<span style="font-size:18px;">${p.price}</span> <small>Ø¬.Ù…</small>`;
              let badge = '';

              if (p.sizes && p.sizes.length > 0) {
                  priceDisplay = `<span style="font-size:12px; color:var(--secondary)">ÙŠØ¨Ø¯Ø£ Ù…Ù†</span> <span style="font-size:18px;">${p.sizes[0].price}</span>`;
                  badge = '<span style="position:absolute; top:8px; left:8px; background:var(--primary); color:white; font-size:10px; padding:3px 8px; border-radius:4px; font-weight:bold;">Ø®ÙŠØ§Ø±Ø§Øª</span>';
              }

              container.innerHTML += `
                  <div class="pos-prod-card" onclick="clickPosProduct('${pData}')">
                     ${imgHTML}
                      ${badge}
                      <div class="pos-prod-info">
                          <div style="font-weight:bold; font-size:14px; line-height:1.4;">${p.name.ar}</div>
                          <div class="pos-prod-price">${priceDisplay}</div>
                      </div>
                  </div>
              `;
          });
      }

      function searchPosProducts() {
          const term = document.getElementById('pos-search').value.toLowerCase();
          
          if (term === '') {
              renderPosCategories();
              return;
          }

          document.getElementById('pos-categories-container').classList.add('hidden');
          document.getElementById('pos-products-container').classList.remove('hidden');
          document.getElementById('btn-pos-back').classList.remove('hidden');
          document.getElementById('pos-breadcrumbs').innerHTML = '<span style="color:var(--primary)">Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø«...</span>';

          const filtered = window.allProductsGlobal.filter(p => p.name.ar.toLowerCase().includes(term) && p.isAvailable);
          renderPosProductsGrid(filtered);
      }

      async function clickPosProduct(pData) {
          const product = JSON.parse(decodeURIComponent(pData));

          // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªØ¹Ø¯Ø¯ Ø§Ù„Ø£Ø­Ø¬Ø§Ù…
          if (product.sizes && product.sizes.length > 0) {
              const inputOptions = {};
              product.sizes.forEach((s, index) => {
                  inputOptions[index] = `${s.name} - ${s.price} Ø¬.Ù…`;
              });

              const { value: sizeIndex } = await Swal.fire({
                  title: `Ø§Ø®ØªØ± Ø­Ø¬Ù…: ${product.name.ar}`,
                  input: 'radio',
                  inputOptions: inputOptions,
                  inputValue: 0,
                  confirmButtonText: 'Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ø³Ù„Ø©',
                  confirmButtonColor: 'var(--primary)',
                  showCancelButton: true,
                  cancelButtonText: 'Ø¥Ù„ØºØ§Ø¡'
              });

              if (sizeIndex) {
                  const selectedSize = product.sizes[sizeIndex];
                  addToPosCart(product, selectedSize.name, selectedSize.price);
              }
          } else {
              addToPosCart(product, null, product.price);
          }
      }

      function addToPosCart(product, sizeName, price) {
          const cartItemName = sizeName ? `${product.name.ar} (${sizeName})` : product.name.ar;
          const uniqueId = sizeName ? `${product._id}-${sizeName}` : product._id;

          const existing = posCart.find(item => item.uniqueId === uniqueId);
          if (existing) {
              existing.qty++;
          } else {
              posCart.push({
                  uniqueId: uniqueId,
                  productId: product._id,
                  name: cartItemName,
                  price: Number(price),
                  qty: 1
              });
          }
          renderPosCart();
      }

      function renderPosCart() {
          const container = document.getElementById('pos-cart-items');
          container.innerHTML = '';
          
          let subtotal = 0;
          let count = 0;

          if (posCart.length === 0) {
              container.innerHTML = `
                  <div style="text-align: center; color: var(--secondary); margin-top: 50px;">
                      <i class="fas fa-shopping-basket fa-3x" style="opacity: 0.2; margin-bottom:15px;"></i>
                      <p>Ø§Ù„Ø³Ù„Ø© ÙØ§Ø±ØºØ©</p>
                  </div>
              `;
          } else {
              posCart.forEach((item, index) => {
                  subtotal += item.price * item.qty;
                  count += item.qty;

                  container.innerHTML += `
                      <div class="pos-cart-item">
                          <div style="flex:1">
                              <div style="font-weight:bold; font-size:14px; margin-bottom:3px;">${item.name}</div>
                              <div style="color:var(--primary); font-size:13px;">${item.price} Ø¬.Ù…</div>
                          </div>
                          <div style="display:flex; align-items:center; gap:8px; background:#f1f5f9; padding:3px; border-radius:6px;">
                              <button class="btn btn-outline" onclick="updatePosQty(${index}, -1)" style="width:28px; height:28px; padding:0; background:white; border:none; box-shadow:0 1px 2px rgba(0,0,0,0.1); font-weight:bold;">-</button>
                              <span style="font-weight:bold; width:20px; text-align:center; font-size:14px;">${item.qty}</span>
                              <button class="btn btn-outline" onclick="updatePosQty(${index}, 1)" style="width:28px; height:28px; padding:0; background:white; border:none; box-shadow:0 1px 2px rgba(0,0,0,0.1); font-weight:bold;">+</button>
                          </div>
                          <button onclick="removeFromPosCart(${index})" style="background:none; border:none; color:#ef4444; cursor:pointer; margin-right:10px; width:30px; height:30px;">
                              <i class="fas fa-trash-alt"></i>
                          </button>
                      </div>
                  `;
              });
          }

          // Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª
          const taxRate = parseFloat(document.getElementById('set-taxRate').value) || 0;
          const serviceRate = parseFloat(document.getElementById('set-serviceRate').value) || 0;
          
          const taxAmount = (subtotal * taxRate) / 100;
          const serviceAmount = (subtotal * serviceRate) / 100;
          const finalTotal = subtotal + taxAmount + serviceAmount;

          document.getElementById('pos-subtotal').innerText = subtotal.toFixed(2);
          document.getElementById('pos-tax').innerText = (taxAmount + serviceAmount).toFixed(2);
          document.getElementById('pos-total').innerText = finalTotal.toFixed(2) + ' Ø¬.Ù…';
          document.getElementById('pos-cart-count').innerText = count;
      }

      function updatePosQty(index, change) {
          posCart[index].qty += change;
          if (posCart[index].qty <= 0) posCart.splice(index, 1);
          renderPosCart();
      }

      function removeFromPosCart(index) {
          posCart.splice(index, 1);
          renderPosCart();
      }

   async function submitPosOrder() {
    if (posCart.length === 0) return Swal.fire('ØªÙ†Ø¨ÙŠÙ‡', 'Ø§Ù„Ø³Ù„Ø© ÙØ§Ø±ØºØ©!', 'warning');

    const tableNumVal = document.getElementById('pos-table-num').value;
    // âœ… 1. Ù‚Ø±Ø§Ø¡Ø© Ø±Ù‚Ù… Ø§Ù„Ø£ÙˆØ±Ø¯Ø± Ø§Ù„ÙŠØ¯ÙˆÙŠ
    const manualOrderNumVal = document.getElementById('pos-manual-order-num').value; 
    
    const rId = document.getElementById('restaurant-id').value;
    const tableNumber = tableNumVal ? tableNumVal : "ØªÙŠÙƒ Ø£ÙˆØ§ÙŠ";

    // ØªØ¬Ù‡ÙŠØ² Ø§Ù„Ù‚ÙŠÙ…
    const subTotal = parseFloat(document.getElementById('pos-subtotal').innerText);
    const finalTotal = parseFloat(document.getElementById('pos-total').innerText);
    const taxRate = parseFloat(document.getElementById('set-taxRate').value) || 0;
    const serviceRate = parseFloat(document.getElementById('set-serviceRate').value) || 0;
    const taxAmount = (subTotal * taxRate) / 100;
    const serviceAmount = (subTotal * serviceRate) / 100;

    const items = posCart.map(i => ({
        name: i.name,
        qty: i.qty,
        price: i.price
    }));

    const body = {
        restaurantId: rId,
        manualOrderNum: manualOrderNumVal, // âœ… 2. Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ù‚Ù… Ù„Ù„Ø³ÙŠØ±ÙØ±
        tableNumber: tableNumber === "ØªÙŠÙƒ Ø£ÙˆØ§ÙŠ" ? 0 : tableNumber,
        items: items,
        subTotal: subTotal,
        taxAmount: taxAmount,
        serviceAmount: serviceAmount,
        discountAmount: 0,
        totalPrice: finalTotal,
        status: 'pending'
    };

    Swal.fire({
        title: 'Ø¬Ø§Ø±ÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨...',
        didOpen: () => Swal.showLoading()
    });

    try {
        const res = await fetch('/api/v1/orders', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(body)
        });
        
        const data = await res.json();
        
        if (data.status === 'success') {
            // Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù†Ø¬Ø§Ø­ (Ù…Ù…ÙƒÙ† ØªØ®ØªÙ„Ù Ù„Ùˆ ÙƒØ§Ù† Ø¯Ù…Ø¬ Ø£Ùˆ Ø¬Ø¯ÙŠØ¯)
            const msg = data.message || 'ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø·Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­';
            Swal.fire({ icon: 'success', title: msg, timer: 2000, showConfirmButton: false });
            
            // ØªÙØ±ÙŠØº Ø§Ù„Ø³Ù„Ø© ÙˆØ§Ù„Ø®Ø§Ù†Ø§Øª
            posCart = [];
            document.getElementById('pos-table-num').value = '';
            document.getElementById('pos-manual-order-num').value = ''; // âœ… 3. ØªØµÙÙŠØ± Ø§Ù„Ø®Ø§Ù†Ø©
            renderPosCart();
            
            // Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ù„ØµÙØ­Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø­ÙŠØ© ÙÙˆØ±Ø§Ù‹
            switchView('orders'); 
            
        } else {
            Swal.fire('Ø®Ø·Ø£', data.message || 'ÙØ´Ù„ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø·Ù„Ø¨', 'error');
        }
    } catch (e) {
        console.error(e);
        Swal.fire('Ø®Ø·Ø£', 'ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±', 'error');
    }
}
      const startApp = async function () {
        if (!token) {
          document.getElementById("login-section").style.display = "flex";
          return;
        }

        await initDashboard();

        const rId = document.getElementById("restaurant-id").value;
        if (rId) {
          window.initSocket(rId);
        }

        if (
          !document.getElementById("view-orders").classList.contains("hidden")
        ) {
          window.loadOrders();
        }

        startShiftMonitor();
      };

      if (document.readyState === "loading") {
        document.addEventListener("DOMContentLoaded", () => {
            startApp();
            // Ø¥Ø¬Ø¨Ø§Ø± Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø¥ØºÙ„Ø§Ù‚ Ø¹Ù†Ø¯ Ø§Ù„ÙØªØ­
            document.getElementById('sidebar').classList.remove('active');
            document.querySelector('.overlay').style.display = 'none';
        });
      } else {
        startApp();
        // Ø¥Ø¬Ø¨Ø§Ø± Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø¥ØºÙ„Ø§Ù‚ Ø¹Ù†Ø¯ Ø§Ù„ÙØªØ­
        document.getElementById('sidebar').classList.remove('active');
        document.querySelector('.overlay').style.display = 'none';
      }
      window.loadHistory = async function () {
        const rId = document.getElementById("restaurant-id").value;
        const tbody = document.getElementById("history-list");
        const salesDisplay = document.getElementById("total-sales-display");
        const title = document.getElementById("history-title");

        let queryParams = "";

        const role =
          typeof currentUserRole !== "undefined" ? currentUserRole : "cashier";

        if (role === "owner") {
          const filterDiv = document.getElementById("owner-filters");
          if (filterDiv) filterDiv.style.display = "flex";
          if (title) title.innerText = "Ø³Ø¬Ù„ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª (Ø´Ø§Ù…Ù„)";

          const start = document.getElementById("filter-start").value;
          const end = document.getElementById("filter-end").value;

          if (start && end) {
            queryParams = `?startDate=${start}&endDate=${end}`;
          }
          const searchVal = document.getElementById("history-search").value;
          if (searchVal) {
            queryParams += queryParams
              ? `&search=${searchVal}`
              : `?search=${searchVal}`;
          }
        } else {
          const filterDiv = document.getElementById("owner-filters");
          if (filterDiv) filterDiv.style.display = "none";
          if (title) title.innerText = "Ø¬Ø±Ø¯ Ø§Ù„Ø´ÙŠÙØª Ø§Ù„Ø­Ø§Ù„ÙŠ (Ø§Ù„ÙŠÙˆÙ…)";
        }

        tbody.innerHTML =
          '<tr><td colspan="6" style="text-align:center">Ø¬Ø§Ø±Ù Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</td></tr>';

        try {
          const res = await fetch(
            `/api/v1/orders/history/${rId}${queryParams}`,
            {
              headers: { Authorization: `Bearer ${token}` },
            },
          );

          const data = await res.json();

          tbody.innerHTML = "";

          if (data.status !== "success") {
            tbody.innerHTML = `<tr><td colspan="6" style="text-align:center; color:red">${data.message || "Ø­Ø¯Ø« Ø®Ø·Ø£"}</td></tr>`;
            return;
          }

          if (salesDisplay)
            salesDisplay.innerText =
              (data.data.totalSales || 0).toLocaleString() + " Ø¬.Ù…";

          if (!data.data.orders || data.data.orders.length === 0) {
            tbody.innerHTML =
              '<tr><td colspan="6" style="text-align:center; padding:20px;">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø³Ø¬Ù„ Ù…Ø¨ÙŠØ¹Ø§Øª Ù„Ù‡Ø°Ù‡ Ø§Ù„ÙØªØ±Ø©</td></tr>';
            return;
          }

          const groups = {};
          data.data.orders.forEach((order) => {
            const dateObj = new Date(order.createdAt);
            const monthKey = dateObj.toLocaleDateString("ar-EG", {
              month: "long",
              year: "numeric",
            });

            if (!groups[monthKey]) {
              groups[monthKey] = { orders: [], total: 0, count: 0 };
            }

            groups[monthKey].orders.push(order);
            if (order.status === "completed") {
              groups[monthKey].total += order.totalPrice;
              groups[monthKey].count += 1;
            }
          });

          for (const [month, info] of Object.entries(groups)) {
            tbody.innerHTML += `
                    <tr style="background-color: var(--primary-light); border-top: 2px solid var(--primary);">
                        <td colspan="6" style="padding: 10px 15px;">
                            <div style="display:flex; justify-content:space-between; align-items:center; font-weight:bold; color:var(--primary)">
                                <span><i class="fas fa-calendar-alt"></i> ${month}</span>
                                <span>Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„Ø´Ù‡Ø±: ${info.total.toLocaleString()} Ø¬.Ù… (${info.count} Ø·Ù„Ø¨)</span>
                            </div>
                        </td>
                    </tr>
                `;

            info.orders.forEach((order) => {
              const time = new Date(order.createdAt).toLocaleTimeString(
                "ar-EG",
                { hour: "2-digit", minute: "2-digit" },
              );
              const dateDay = new Date(order.createdAt).toLocaleDateString(
                "ar-EG",
                { day: "numeric", month: "numeric" },
              );
              const itemsSummary = order.items
                .map((i) => `${i.name} (${i.qty})`)
                .join(", ");

              let statusBadge = "";
              if (order.status === "completed")
                statusBadge =
                  '<span class="badge" style="background:#dcfce7; color:#166534">Ù…ÙƒØªÙ…Ù„</span>';
              else if (order.status === "canceled")
                statusBadge =
                  '<span class="badge" style="background:#fee2e2; color:#991b1b">Ù…Ù„ØºÙŠ</span>';

              const tableNum =
                order.tableNumber === 0 ? "ØªÙŠÙƒ Ø£ÙˆØ§ÙŠ" : order.tableNumber;

              tbody.innerHTML += `
                        <tr style="background:var(--surface)">
                            <td style="font-weight:bold">#${order.orderNum || String(order._id).slice(-4)}</td>
                            <td style="font-size:12px">${dateDay} - ${time}</td>
                            <td>${tableNum}</td>
                            <td style="font-size:13px; color:var(--secondary); max-width:200px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap" title="${itemsSummary}">${itemsSummary}</td>
                            <td style="font-weight:bold">${order.totalPrice}</td>
                            <td>${statusBadge}</td>
                        </tr>
                    `;
            });
          }
        } catch (e) {
          console.error(e);
          tbody.innerHTML =
            '<tr><td colspan="6" style="text-align:center; color:red">Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„</td></tr>';
        }
      };

      function applyPermissions(role) {
        const allNavs = [
          "nav-categories",
          "nav-products",
          "nav-bulk",
          "nav-history",
          "nav-design",
          "nav-settings",
          "nav-staff",
        ];

        const permissions = {
          owner: [
            "nav-categories",
            "nav-products",
            "nav-bulk",
            "nav-history",
            "nav-design",
            "nav-settings",
            "nav-orders",
            "nav-staff",
            "nav-coupons",
            "nav-reservations"
          ],
          cashier: ["nav-orders", "nav-history"],
          kitchen: ["nav-orders"],
        };

        const allowed = permissions[role] || [];

        allNavs.forEach((id) => {
          const el = document.getElementById(id);
          if (el) el.classList.add("hidden");
        });

        allowed.forEach((id) => {
          const el = document.getElementById(id);
          if (el) el.classList.remove("hidden");
        });

        if (role === "owner") loadStaff();

        const recentBtn = document.getElementById("btn-recent-orders");
        if (recentBtn) {
          if (role === "kitchen") {
            recentBtn.classList.add("hidden");
          } else {
            recentBtn.classList.remove("hidden");
          }
        }
      }

      async function loadStaff() {
        try {
          const res = await fetch("/api/v1/users/my-staff", {
            headers: { Authorization: `Bearer ${token}` },
          });
          const data = await res.json();
          const list = document.getElementById("staff-list");
          list.innerHTML = "";
          data.data.staff.forEach((u) => {
            let roleBadge =
              u.role === "cashier"
                ? '<span class="badge" style="background:#dbeafe; color:#1e40af">ÙƒØ§Ø´ÙŠØ±</span>'
                : '<span class="badge" style="background:#ffedd5; color:#9a3412">Ù…Ø·Ø¨Ø®</span>';

            const shiftInfo =
              u.shiftStart && u.shiftEnd
                ? `<div style="font-size:11px; color:var(--secondary); margin-top:5px;"><i class="far fa-clock"></i> ${u.shiftStart} - ${u.shiftEnd}</div>`
                : "";

            // ØªØ´ÙÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø¥Ø±Ø³Ø§Ù„Ù‡Ø§ Ù„Ø¯Ø§Ù„Ø© Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
            const staffData = encodeURIComponent(JSON.stringify(u));

            list.innerHTML += `
                    <tr>
                        <td>${u.name}${shiftInfo}</td>
                        <td>${u.email}</td>
                        <td>${roleBadge}</td>
                        <td>
                            <div style="display:flex; gap:5px;">
                                <button class="btn btn-outline" style="color:var(--primary); border-color:var(--primary); padding:5px 10px;" 
                                    onclick="editStaff('${staffData}')" title="ØªØ¹Ø¯ÙŠÙ„">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-outline" style="color:red; padding:5px 10px;" 
                                    onclick="deleteStaff('${u._id}')" title="Ø­Ø°Ù">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
          });
        } catch (e) {
          console.error(e);
        }
      }

      let editingStaffId = null;

      async function addStaff() {
        const name = document.getElementById("staff-name").value;
        const email = document.getElementById("staff-email").value;
        const password = document.getElementById("staff-password").value;
        const role = document.getElementById("staff-role").value;
        const rId = document.getElementById("restaurant-id").value;
        const shiftStart = document.getElementById("staff-start").value;
        const shiftEnd = document.getElementById("staff-end").value;

        const restDays = [];
        document
          .querySelectorAll("#rest-days-container input:checked")
          .forEach((cb) => {
            restDays.push(parseInt(cb.value));
          });

        if (!name || !email)
          return Swal.fire("ØªÙ†Ø¨ÙŠÙ‡", "Ø£ÙƒÙ…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©", "warning");

        // Ø§Ù„Ø¨Ø§Ø³ÙˆØ±Ø¯ Ù…Ø·Ù„ÙˆØ¨ ÙÙ‚Ø· ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
        if (!editingStaffId && !password)
           return Swal.fire("ØªÙ†Ø¨ÙŠÙ‡", "ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ù…Ø·Ù„ÙˆØ¨Ø© Ù„Ù„Ù…ÙˆØ¸Ù Ø§Ù„Ø¬Ø¯ÙŠØ¯", "warning");

        const bodyData = {
            name, email, role, restaurantId: rId,
            shiftStart, shiftEnd, restDays
        };
        // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨Ø§Ø³ÙˆØ±Ø¯ ÙÙ‚Ø· Ø¥Ø°Ø§ ØªÙ… ÙƒØªØ§Ø¨ØªÙ‡ (Ù„ØªØ¬Ù†Ø¨ ØªØºÙŠÙŠØ±Ù‡ Ù„ÙØ§Ø±Øº)
        if(password) bodyData.password = password;

        try {
          let url = "/api/v1/users/staff";
          let method = "POST";

          if (editingStaffId) {
              url = `/api/v1/users/staff/${editingStaffId}`;
              method = "PATCH";
          }

          const res = await fetch(url, {
            method: method,
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${token}`,
            },
            body: JSON.stringify(bodyData),
          });
          const data = await res.json();
          
          if (data.status === "success") {
            Swal.fire("ØªÙ…", editingStaffId ? "ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆØ¸Ù" : "ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…ÙˆØ¸Ù", "success");
            resetStaffForm();
            loadStaff();
          } else {
            Swal.fire("Ø®Ø·Ø£", data.message, "error");
          }
        } catch (e) {
          console.error(e);
          Swal.fire("Ø®Ø·Ø£", "Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„", "error");
        }
      }

      function editStaff(staffDataEncoded) {
          const u = JSON.parse(decodeURIComponent(staffDataEncoded));
          editingStaffId = u._id;

          // ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ø§Ù„ÙÙˆØ±Ù…
          document.getElementById("staff-name").value = u.name;
          document.getElementById("staff-email").value = u.email;
          document.getElementById("staff-password").value = ""; // ØªÙØ±ÙŠØº Ø§Ù„Ø¨Ø§Ø³ÙˆØ±Ø¯
          document.getElementById("staff-role").value = u.role;
          document.getElementById("staff-start").value = u.shiftStart || "09:00";
          document.getElementById("staff-end").value = u.shiftEnd || "17:00";

          // ØªØ­Ø¯ÙŠØ¯ Ø£ÙŠØ§Ù… Ø§Ù„Ø¥Ø¬Ø§Ø²Ø©
          const checkboxes = document.querySelectorAll("#rest-days-container input");
          checkboxes.forEach(cb => cb.checked = false); // ØªØµÙÙŠØ± Ø£ÙˆÙ„Ø§Ù‹
          if (u.restDays) {
              checkboxes.forEach(cb => {
                  if (u.restDays.includes(parseInt(cb.value))) cb.checked = true;
              });
          }

          // ØªØºÙŠÙŠØ± Ø´ÙƒÙ„ Ø§Ù„Ø²Ø±
          const btn = document.querySelector("#view-staff .btn-primary");
          btn.innerHTML = '<i class="fas fa-save"></i> Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª';
          btn.style.backgroundColor = "var(--warning)";
          btn.style.borderColor = "var(--warning)";

          // Ø¥Ø¶Ø§ÙØ© Ø²Ø± Ø¥Ù„ØºØ§Ø¡ Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹
          if (!document.getElementById("btn-cancel-staff")) {
              const cancelBtn = document.createElement("button");
              cancelBtn.id = "btn-cancel-staff";
              cancelBtn.className = "btn btn-outline";
              cancelBtn.innerHTML = "Ø¥Ù„ØºØ§Ø¡";
              cancelBtn.style.marginRight = "10px";
              cancelBtn.onclick = resetStaffForm;
              btn.parentNode.insertBefore(cancelBtn, btn.nextSibling);
          }
          
          window.scrollTo({ top: 0, behavior: 'smooth' });
      }

      function resetStaffForm() {
          editingStaffId = null;
          document.getElementById("staff-name").value = "";
          document.getElementById("staff-email").value = "";
          document.getElementById("staff-password").value = "";
          document.getElementById("staff-start").value = "09:00";
          document.getElementById("staff-end").value = "17:00";
          document.querySelectorAll("#rest-days-container input").forEach(cb => cb.checked = false);

          const btn = document.querySelector("#view-staff .btn-primary");
          btn.innerHTML = 'Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª';
          btn.style.backgroundColor = "";
          btn.style.borderColor = "";

          const cancelBtn = document.getElementById("btn-cancel-staff");
          if (cancelBtn) cancelBtn.remove();
      }

      async function deleteStaff(id) {
        if (
          (
            await Swal.fire({
              title: "Ø­Ø°Ù Ø§Ù„Ù…ÙˆØ¸ÙØŸ",
              icon: "warning",
              showCancelButton: true,
            })
          ).isConfirmed
        ) {
          await fetch(`/api/v1/users/staff/${id}`, {
            method: "DELETE",
            headers: { Authorization: `Bearer ${token}` },
          });
          loadStaff();
        }
      }

      window.printOrder = function (orderEncoded) {
        const order = JSON.parse(decodeURIComponent(orderEncoded));

        let fullTitle = document.getElementById("page-title").innerText;
        const restName = fullTitle.split("\n")[0] || "Smart Menu";

        const cashierName =
          sessionStorage.getItem("currentUserName") || "Cashier";

        const date = new Date(order.createdAt).toLocaleString("ar-EG");
        const orderNumDisplay = order.orderNum
          ? order.orderNum
          : String(order._id).slice(-4);
        
        // Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ Ù…Ù† Ø§Ù„Ø­Ù‚Ù„ Ø§Ù„Ù…Ø®ÙÙŠ
        const showOrderNum = document.getElementById("setting-print-num").value === "true";
        const orderNumHTML = showOrderNum ? `<div style="font-size:12px">Ø£ÙˆØ±Ø¯Ø± #${orderNumDisplay}</div>` : '';

        let itemsHtml = "";
        order.items.forEach((item) => {
          itemsHtml += `
                <div style="display:flex; justify-content:space-between; margin-bottom:5px; font-size:12px;">
                    <span style="font-weight:bold;">${item.name}</span>
                    <span>${item.qty} x ${item.price}</span>
                </div>
                <div style="text-align:left; border-bottom:1px dashed #000; margin-bottom:5px; padding-bottom:2px;">
                    ${item.qty * item.price} Ø¬.Ù…
                </div>
            `;
        });

        const subTotal = order.subTotal || order.totalPrice;
        const taxVal = order.taxAmount || 0;
        const serviceVal = order.serviceAmount || 0;

        const receiptHTML = `
            <html>
            <head>
                <style>
                    body { font-family: 'Courier New', monospace; width: 300px; margin: 0; padding: 10px; direction: rtl; }
                    .header { text-align: center; margin-bottom: 10px; }
                    .title { font-size: 20px; font-weight: bold; }
                    .meta { font-size: 12px; margin-bottom: 10px; border-bottom: 1px solid #000; padding-bottom: 5px; }
                    .totals { margin-top: 10px; border-top: 1px dashed #000; padding-top: 5px; font-size: 14px; }
                    .row { display: flex; justify-content: space-between; }
                    .grand-total { font-size: 18px; font-weight: bold; margin-top: 5px; }
                    @media print { .no-print { display: none; } }
                </style>
            </head>
            <body>
                <div class="header">
                    <div class="title">${restName}</div>
                    ${orderNumHTML}
                </div>
                
                <div class="meta">
                    <div>Ø§Ù„ØªØ§Ø±ÙŠØ®: ${date}</div>
                    <div>Ø¨ÙˆØ§Ø³Ø·Ø©: ${cashierName}</div>
                    <div>Ø§Ù„Ø·Ø§ÙˆÙ„Ø©: <strong>${order.tableNumber}</strong></div>
                    <div>Ù†ÙˆØ¹ Ø§Ù„Ø·Ù„Ø¨: ${order.tableNumber === 0 ? "ØªÙŠÙƒ Ø£ÙˆØ§ÙŠ" : "ØµØ§Ù„Ø©"}</div>
                </div>

                <div class="items">${itemsHtml}</div>

                <div class="totals">
                    <div class="row"><span>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹:</span> <span>${subTotal}</span></div>
                    ${taxVal > 0 ? `<div class="row"><span>Ø¶Ø±ÙŠØ¨Ø©:</span> <span>${taxVal}</span></div>` : ""}
                    ${serviceVal > 0 ? `<div class="row"><span>Ø®Ø¯Ù…Ø©:</span> <span>${serviceVal}</span></div>` : ""}
                    ${order.discountAmount > 0 ? `<div class="row" style="color:black"><span>Ø®ØµÙ…:</span> <span>-${order.discountAmount}</span></div>` : ""}
                    <div class="row grand-total">
                        <span>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ:</span> <span>${order.totalPrice} Ø¬.Ù…</span>
                    </div>
                </div>

                <div style="text-align:center; margin-top:20px; font-size:12px;">
                    *** Ø´ÙƒØ±Ø§Ù‹ Ù„Ø²ÙŠØ§Ø±ØªÙƒÙ… ***
                </div>

                <script>
                    window.onload = function() { window.print(); setTimeout(() => window.close(), 1000); }
                <\/script>
            </body>
            </html>
        `;

        const popup = window.open("", "_blank", "width=350,height=600");
        popup.document.open();
        popup.document.write(receiptHTML);
        popup.document.close();
      };
    </script>

    <div
      id="recent-orders-modal"
      class="overlay"
      style="z-index: 2000; display: none"
    >
      <div
        class="card"
        style="
          width: 90%;
          max-width: 600px;
          max-height: 80vh;
          margin: 5vh auto;
          display: flex;
          flex-direction: column;
          padding: 0;
        "
      >
        <div
          style="
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
          "
        >
          <h3 style="margin: 0; color: var(--primary)">ğŸ§¾ ÙÙˆØ§ØªÙŠØ± Ø¢Ø®Ø± Ø³Ø§Ø¹ØªÙŠÙ†</h3>
          <button
            onclick="
              document.getElementById('recent-orders-modal').style.display =
                'none'
            "
            style="
              background: none;
              border: none;
              font-size: 20px;
              cursor: pointer;
              color: var(--text-main);
            "
          >
            <i class="fas fa-times"></i>
          </button>
        </div>
        <div
          id="recent-orders-list"
          style="padding: 20px; overflow-y: auto; flex: 1"
        ></div>
      </div>
    </div>

    <script>
      window.showRecentOrders = async function () {
        const rId = document.getElementById("restaurant-id").value;
        if (!rId) return; // ğŸ›‘ Safety Check

        const modal = document.getElementById("recent-orders-modal");
        const container = document.getElementById("recent-orders-list");

        modal.style.display = "block";
        container.innerHTML =
          '<div style="text-align:center"><i class="fas fa-spinner fa-spin"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>';

        try {
          const res = await fetch(`/api/v1/orders/recent-completed/${rId}`, {
            headers: {
              Authorization: `Bearer ${sessionStorage.getItem("ownerToken")}`,
            },
          });
          const data = await res.json();

          container.innerHTML = "";
          if (data.data.orders.length === 0) {
            container.innerHTML =
              '<p style="text-align:center; color:var(--secondary)">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ù…ÙƒØªÙ…Ù„Ø© ÙÙŠ Ø¢Ø®Ø± Ø³Ø§Ø¹ØªÙŠÙ†</p>';
            return;
          }

          data.data.orders.forEach((order) => {
            const time = new Date(order.updatedAt).toLocaleTimeString("ar-EG", {
              hour: "2-digit",
              minute: "2-digit",
            });
            const orderDataEncoded = encodeURIComponent(JSON.stringify(order));

            container.innerHTML += `
                <div style="background:var(--bg); border:1px solid var(--border-color); padding:10px; border-radius:10px; margin-bottom:10px; display:flex; justify-content:space-between; align-items:center;">
                    <div>
                        <div style="font-weight:bold; color:var(--text-main)">Ø£ÙˆØ±Ø¯Ø± #${String(order._id).slice(-4)} <span style="font-size:12px; color:var(--success)">(${time})</span></div>
                        <div style="font-size:12px; color:var(--secondary)">${order.tableNumber === 0 ? "ØªÙŠÙƒ Ø£ÙˆØ§ÙŠ" : "Ø·Ø§ÙˆÙ„Ø© " + order.tableNumber} - ${order.totalPrice} Ø¬.Ù…</div>
                    </div>
                    <button class="btn btn-outline" onclick="window.printOrder('${orderDataEncoded}')" style="padding:5px 15px;">
                        <i class="fas fa-print"></i> Ø·Ø¨Ø§Ø¹Ø©
                    </button>
                </div>
            `;
          });
        } catch (e) {
          container.innerHTML =
            '<p style="color:red; text-align:center">Ø­Ø¯Ø« Ø®Ø·Ø£</p>';
        }
      };

      let currentSizes = [];

      function togglePricingMode() {
        const mode = document.querySelector('input[name="pricingMode"]:checked').value;
        const sizesList = document.getElementById("sizes-list");

        if (mode === "single") {
          document.getElementById("mode-single").classList.remove("hidden");
          document.getElementById("mode-multi").classList.add("hidden");
        } else {
          document.getElementById("mode-single").classList.add("hidden");
          document.getElementById("mode-multi").classList.remove("hidden");
          
          // Ø¥ØµÙ„Ø§Ø­: Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¹Ø¯Ø¯ ØµÙÙˆÙ Ø§Ù„Ø£Ø­Ø¬Ø§Ù… Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø© ÙØ¹Ù„ÙŠØ§Ù‹
          // Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù‡Ù†Ø§Ùƒ Ø£ÙŠ ØµÙ (ØµÙØ±)ØŒ Ù†Ù‚ÙˆÙ… Ø¨Ø¥Ø¶Ø§ÙØ© ØµÙ Ø¬Ø¯ÙŠØ¯ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
          if (sizesList.querySelectorAll('.size-row').length === 0) {
            addSizeRow();
          }
        }
      }

      function addSizeRow(name = "", price = "", oldPrice = "") {
        const id = Date.now();
        const oldValDisplay = oldPrice && oldPrice > 0 ? oldPrice : "";

        // ØªØµÙ…ÙŠÙ… ÙƒØ§Ø±Øª Ø£Ù†ÙŠÙ‚ Ù„ÙƒÙ„ Ø­Ø¬Ù…
        const html = `
            <div class="size-row" id="size-${id}" style="
                background: #fff; 
                padding: 12px; 
                border-radius: 12px; 
                border: 1px solid var(--border-color); 
                margin-bottom: 10px; 
                box-shadow: 0 2px 8px rgba(0,0,0,0.03);
                display: flex; 
                align-items: center; 
                gap: 12px;
                transition: transform 0.2s;
            ">
                <div style="color: var(--secondary); opacity: 0.4; cursor: grab; padding: 5px;">
                    <i class="fas fa-grip-vertical"></i>
                </div>

                <div style="flex: 2;">
                    <label style="font-size: 11px; color: var(--secondary); font-weight: bold; margin-bottom: 4px; display: block;">Ø§Ø³Ù… Ø§Ù„Ø­Ø¬Ù…</label>
                    <input type="text" class="s-name" placeholder="Ù…Ø«Ø§Ù„: ÙˆØ³Ø· / ÙƒÙˆÙ…Ø¨Ùˆ" value="${name}" 
                        style="height: 38px; border: 1px solid #cbd5e1; background: #f8fafc; font-size: 13px; width: 100%;">
                </div>

                <div style="flex: 1;">
                    <label style="font-size: 11px; color: var(--primary); font-weight: bold; margin-bottom: 4px; display: block;">Ø§Ù„Ø³Ø¹Ø±</label>
                    <input type="number" class="s-price" placeholder="0" value="${price}" 
                        style="height: 38px; border: 1px solid var(--primary-light); background: #fff; font-weight: bold; color: var(--primary); font-size: 14px; width: 100%; text-align:center;">
                </div>

                <div style="flex: 1;">
                    <label style="font-size: 11px; color: var(--danger); font-weight: bold; margin-bottom: 4px; display: block;">Ø®ØµÙ… (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
                    <input type="number" class="s-old" placeholder="0" value="${oldValDisplay}" 
                        style="height: 38px; border: 1px dashed #fca5a5; background: #fef2f2; color: var(--danger); font-size: 13px; width: 100%; text-align:center;">
                </div>

                <div style="padding-top: 18px;">
                    <button type="button" onclick="document.getElementById('size-${id}').remove()" 
                        style="
                            background: #fee2e2; 
                            color: #ef4444; 
                            border: none; 
                            width: 38px; 
                            height: 38px; 
                            border-radius: 10px; 
                            cursor: pointer; 
                            display: flex; 
                            align-items: center; 
                            justify-content: center;
                            transition: 0.2s;
                        "
                        title="Ø­Ø°Ù Ø§Ù„Ø­Ø¬Ù…"
                        onmouseover="this.style.background='#fecaca'"
                        onmouseout="this.style.background='#fee2e2'"
                    >
                        <i class="fas fa-trash-alt" style="font-size: 14px;"></i>
                    </button>
                </div>
            </div>
        `;
        
        document.getElementById("sizes-list").insertAdjacentHTML("beforeend", html);
      }
      async function loadCoupons() {
        const rId = document.getElementById("restaurant-id").value;
        const res = await fetch(`/api/v1/coupons/${rId}`, {
          headers: { Authorization: `Bearer ${token}` },
        });
        const data = await res.json();
        const list = document.getElementById("coupons-list");
        list.innerHTML = "";
        data.data.coupons.forEach((c) => {
          const val =
            c.discountType === "percent" ? `${c.value}%` : `${c.value} Ø¬.Ù…`;
          list.innerHTML += `
            <tr>
                <td style="font-weight:bold; color:var(--primary)">${c.code}</td>
                <td>${val}</td>
                <td>${c.usedCount} / ${c.usageLimit}</td>
                <td><button class="btn btn-outline" style="color:red" onclick="deleteCoupon('${c._id}')"><i class="fas fa-trash"></i></button></td>
            </tr>
        `;
        });
      }

      async function createCoupon() {
        const rId = document.getElementById("restaurant-id").value;
        const body = {
          code: document.getElementById("coup-code").value,
          discountType: document.getElementById("coup-type").value,
          value: document.getElementById("coup-value").value,
          minOrderVal: document.getElementById("coup-min").value || 0,
          maxDiscount: document.getElementById("coup-max-disc").value || 0,
          usageLimit: document.getElementById("coup-limit").value || 1000,
        };
        if (!body.code || !body.value)
          return Swal.fire("ØªÙ†Ø¨ÙŠÙ‡", "Ø£Ø¯Ø®Ù„ Ø§Ù„ÙƒÙˆØ¯ ÙˆØ§Ù„Ù‚ÙŠÙ…Ø©", "warning");

        const res = await fetch(`/api/v1/coupons/${rId}`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${token}`,
          },
          body: JSON.stringify(body),
        });
        const data = await res.json();
        if (data.status === "success") {
          Swal.fire({
            toast: true,
            icon: "success",
            title: "ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ÙƒÙˆØ¨ÙˆÙ†",
          });
          document.getElementById("coup-code").value = "";
          loadCoupons();
        } else {
          Swal.fire("Ø®Ø·Ø£", data.message, "error");
        }
      }

      async function deleteCoupon(id) {
        if (
          (
            await Swal.fire({
              title: "Ø­Ø°Ù Ø§Ù„ÙƒÙˆØ¨ÙˆÙ†ØŸ",
              icon: "warning",
              showCancelButton: true,
            })
          ).isConfirmed
        ) {
          await fetch(`/api/v1/coupons/${id}`, {
            method: "DELETE",
            headers: { Authorization: `Bearer ${token}` },
          });
          loadCoupons();
        }
      }
      function createRecentOrderHTML(order) {
        const time = new Date(order.updatedAt).toLocaleTimeString("ar-EG", {
          hour: "2-digit",
          minute: "2-digit",
        });
        const orderDataEncoded = encodeURIComponent(JSON.stringify(order));

        let itemsTxt = order.items
          .map((i) => `${i.name} (x${i.qty})`)
          .join("ØŒ ");

        return `
        <div style="background:var(--bg); border:1px solid var(--border-color); padding:15px; border-radius:10px; margin-bottom:10px;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                <div>
                    <span style="font-weight:bold; color:var(--text-main); font-size:16px;">Ø£ÙˆØ±Ø¯Ø± #${order.orderNum}</span>
                    <span style="font-size:12px; color:var(--success); margin-right:5px;">(${time})</span>
                </div>
                <button class="btn btn-outline" onclick="window.printOrder('${orderDataEncoded}')" style="padding:5px 15px;">
                    <i class="fas fa-print"></i>
                </button>
            </div>
            
            <div style="font-size:13px; color:var(--text-main); margin-bottom:8px; line-height:1.6;">
                <strong>Ø§Ù„Ø£ØµÙ†Ø§Ù:</strong> ${itemsTxt}
            </div>
            
            <div style="display:flex; justify-content:space-between; font-size:12px; color:var(--secondary); border-top:1px dashed #ddd; padding-top:5px;">
                <span>${order.tableNumber === 0 ? "ØªÙŠÙƒ Ø£ÙˆØ§ÙŠ" : "Ø·Ø§ÙˆÙ„Ø© " + order.tableNumber}</span>
                <span style="font-weight:bold; color:var(--primary); font-size:14px;">${order.totalPrice} Ø¬.Ù…</span>
            </div>
        </div>
    `;
      }

      window.searchOrderHistory = async function () {
        const orderNum = document.getElementById("live-order-search").value;
        if (!orderNum) return;

        const rId = document.getElementById("restaurant-id").value;
        Swal.showLoading();

        try {
          const res = await fetch(
            `/api/v1/orders/${rId}/history?search=${orderNum}`,
            {
              headers: { Authorization: `Bearer ${token}` },
            },
          );
          const data = await res.json();
          Swal.close();

          if (data.status === "success" && data.data.orders.length > 0) {
            const modal = document.getElementById("recent-orders-modal");
            const container = document.getElementById("recent-orders-list");
            modal.style.display = "block";

            container.innerHTML = `<h4 style="text-align:center; margin-top:0">Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø£ÙˆØ±Ø¯Ø± #${orderNum}</h4>`;

            data.data.orders.forEach((order) => {
              container.innerHTML += createRecentOrderHTML(order);
            });
          } else {
            Swal.fire("ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯", "Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø·Ù„Ø¨ Ø¨Ù‡Ø°Ø§ Ø§Ù„Ø±Ù‚Ù…", "info");
          }
        } catch (e) {
          Swal.fire("Ø®Ø·Ø£", "Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨Ø­Ø«", "error");
        }
      };

      function applyTheme(themeId) {
        const theme = themesLibrary.find((t) => t.id === themeId);
        if (!theme) return;

        currentDesign.primaryColor = theme.primary;
        currentDesign.bgType = theme.type;
        currentDesign.bgValue = theme.bg;
        currentDesign.fontFamily = theme.font;
        currentDesign.cardRadius = theme.radius;
        currentDesign.cardStyle = theme.style;
        currentDesign.layoutType = theme.layout;

        document.getElementById("ui-primaryColor").value = theme.primary;
        document.getElementById("ui-fontFamily").value = theme.font;
        document.getElementById("ui-cardRadius").value = theme.radius;
        document.getElementById("ui-cardStyle").value = theme.style;
        document.getElementById("radius-val").innerText = theme.radius;

        document.getElementById("ui-bgType").value = theme.type;
        toggleBgInput();
        if (theme.type === "color")
          document.getElementById("ui-bgColor").value = theme.bg;

        document
          .querySelectorAll(".btn-layout")
          .forEach((b) => b.classList.remove("active"));
        const activeBtn = document.getElementById(`btn-layout-${theme.layout}`);
        if (activeBtn) activeBtn.classList.add("active");

        updatePreview();

        Swal.fire({
          toast: true,
          position: "top-end",
          icon: "success",
          title: `ØªÙ… ØªØ·Ø¨ÙŠÙ‚ Ù‚Ø§Ù„Ø¨: ${theme.name}`,
          showConfirmButton: false,
          timer: 1000,
        });
      }
      async function checkShiftStatus(role) {
        setInterval(async () => {
          const now = new Date();
          try {
            const res = await fetch("/api/v1/users/my-staff", {
              headers: { Authorization: `Bearer ${token}` },
            });

            if (res.status === 403) {
              const data = await res.json();
              if (data.message.includes("Ø®Ø§Ø±Ø¬ ÙˆÙ‚Øª Ø§Ù„Ø´ÙŠÙØª")) {
                logout();
              }
            }
          } catch (e) {}
        }, 60000);
      }

      function toggleBulkPricing(rowId) {
        const mode = document.querySelector(
          `input[name="mode-${rowId}"]:checked`,
        ).value;
        const singleDiv = document.getElementById(`single-inputs-${rowId}`);
        const multiDiv = document.getElementById(`multi-inputs-${rowId}`);

        if (mode === "single") {
          singleDiv.classList.remove("hidden");
          multiDiv.classList.add("hidden");
        } else {
          singleDiv.classList.add("hidden");
          multiDiv.classList.remove("hidden");

          const container = document.getElementById(`sizes-container-${rowId}`);
          if (container.innerHTML.trim() === "") {
            addBulkSizeRow(rowId);
          }
        }
      }

      
      // --- Accounting Logic ---
function showAccTab(tab) {
    document.getElementById('acc-tab-employees').classList.add('hidden');
    document.getElementById('acc-tab-attendance').classList.add('hidden');
    document.getElementById('acc-tab-payroll').classList.add('hidden');
    document.getElementById('acc-tab-' + tab).classList.remove('hidden');
    
    if(tab === 'employees') loadEmployees();
    if(tab === 'attendance') {
        document.getElementById('acc-att-date').valueAsDate = new Date();
        loadAttendance();
    }
}

async function addEmployee() {
    const name = document.getElementById('acc-emp-name').value;
    const jobTitle = document.getElementById('acc-emp-job').value;
    const salaryType = document.getElementById('acc-emp-type').value;
    const baseSalary = document.getElementById('acc-emp-salary').value;
    const workHours = document.getElementById('acc-emp-hours').value;
    const shiftStart = document.getElementById('acc-emp-start').value;
    const shiftEnd = document.getElementById('acc-emp-end').value;

    if(!name || !baseSalary) return Swal.fire('ØªÙ†Ø¨ÙŠÙ‡', 'Ø£Ø¯Ø®Ù„ Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ù„Ø±Ø§ØªØ¨', 'warning');

    const bodyData = { name, jobTitle, salaryType, baseSalary, workHours, shiftStart, shiftEnd };

    try {
        let url = '/api/v1/accounting/employees';
        let method = 'POST';

        // Ù„Ùˆ Ø¨Ù†Ø¹Ø¯Ù„ Ù…ÙˆØ¸ÙØŒ Ù†ØºÙŠØ± Ø§Ù„Ø±Ø§Ø¨Ø· ÙˆØ§Ù„Ø·Ø±ÙŠÙ‚Ø©
        if (editingAccEmpId) {
            url = `/api/v1/accounting/employees/${editingAccEmpId}`;
            method = 'PATCH';
        }

        await fetch(url, {
            method: method,
            headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${token}` },
            body: JSON.stringify(bodyData)
        });
        
        Swal.fire('ØªÙ…', editingAccEmpId ? 'ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª' : 'ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…ÙˆØ¸Ù', 'success');
        
        loadEmployees();
        resetAccEmpForm(); // ØªÙØ±ÙŠØº Ø§Ù„ÙÙˆØ±Ù…
    } catch(e) { console.error(e); }
}

// Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„ØªØ¬Ù‡ÙŠØ² Ø§Ù„ÙÙˆØ±Ù… Ù„Ù„ØªØ¹Ø¯ÙŠÙ„
function editAccEmployee(empDataEncoded) {
    const emp = JSON.parse(decodeURIComponent(empDataEncoded));
    editingAccEmpId = emp._id;
    
    document.getElementById('acc-emp-name').value = emp.name;
    document.getElementById('acc-emp-job').value = emp.jobTitle || '';
    document.getElementById('acc-emp-type').value = emp.salaryType;
    document.getElementById('acc-emp-salary').value = emp.baseSalary;
    document.getElementById('acc-emp-hours').value = emp.workHours || 9;
    document.getElementById('acc-emp-start').value = emp.shiftStart || "09:00";
    document.getElementById('acc-emp-end').value = emp.shiftEnd || "18:00";

    // ØªØºÙŠÙŠØ± Ù†Øµ Ø§Ù„Ø²Ø±
    const btn = document.querySelector('#acc-tab-employees .btn-success');
    if(btn) {
        btn.innerText = 'Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª';
        btn.style.background = 'var(--warning)';
    }
    
    // Ø³ÙƒØ±ÙˆÙ„ Ù„Ù„ÙÙˆØ±Ù…
    document.getElementById('acc-tab-employees').scrollIntoView({ behavior: 'smooth' });
}

// Ø¯Ø§Ù„Ø© Ù„ØªÙØ±ÙŠØº Ø§Ù„ÙÙˆØ±Ù…
function resetAccEmpForm() {
    editingAccEmpId = null;
    document.getElementById('acc-emp-name').value = '';
    document.getElementById('acc-emp-job').value = '';
    document.getElementById('acc-emp-salary').value = '';
    
    const btn = document.querySelector('#acc-tab-employees .btn-success');
    if(btn) {
        btn.innerText = 'Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª';
        btn.style.background = ''; // Ø±Ø¬ÙˆØ¹ Ù„Ù„ÙˆÙ† Ø§Ù„Ø£ØµÙ„ÙŠ
    }
}


async function loadEmployees() {
    try {
        const res = await fetch('/api/v1/accounting/employees', { headers: { Authorization: `Bearer ${token}` } });
        const data = await res.json();
        
        // âœ… Ø¥ØµÙ„Ø§Ø­: Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ù†Ø¬Ø§Ø­ Ø§Ù„Ø·Ù„Ø¨ ÙˆÙˆØ¬ÙˆØ¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        if (data.status === 'success' && Array.isArray(data.data)) {
            window.employeesData = data.data; // Store globally
            const tbody = document.getElementById('acc-emp-list');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            if (data.data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…ÙˆØ¸ÙÙŠÙ† Ù…Ø³Ø¬Ù„ÙŠÙ†</td></tr>';
                return;
            }

            data.data.forEach(emp => {
                const empData = encodeURIComponent(JSON.stringify(emp));
                tbody.innerHTML += `
                    <tr>
                        <td style="font-weight:bold;">${emp.name}</td>
                        <td>${emp.jobTitle || '-'}</td>
                        <td>${emp.salaryType === 'monthly' ? 'Ø´Ù‡Ø±ÙŠ' : 'ÙŠÙˆÙ…ÙŠ'}</td>
                        <td>${emp.baseSalary}</td>
                        <td style="color:${emp.loanBalance > 0 ? 'red' : 'green'}; font-weight:bold;">${emp.loanBalance} Ø¬.Ù…</td>
                        <td>
                            <div style="display:flex; gap:5px;">
                                <button class="btn btn-outline" style="font-size:11px; padding:5px; color:var(--primary); border-color:var(--primary);" onclick="editAccEmployee('${empData}')" title="ØªØ¹Ø¯ÙŠÙ„">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-outline" style="font-size:11px; padding:5px;" onclick="giveAdvance('${emp._id}', '${emp.name}')" title="ØµØ±Ù Ø³Ù„ÙØ©">
                                    <i class="fas fa-hand-holding-usd"></i>
                                </button>
                                <button class="btn btn-outline" style="font-size:11px; padding:5px; color:red;" onclick="deleteEmployee('${emp._id}')">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            });
        } else {
            console.warn("Employees Load Failed:", data);
        }
    } catch(e) { console.error("Employees Error:", e); }
}
async function deleteEmployee(id) {
    if(confirm('Ø­Ø°Ù Ø§Ù„Ù…ÙˆØ¸ÙØŸ')) {
        await fetch(`/api/v1/accounting/employees/${id}`, { method: 'DELETE', headers: { Authorization: `Bearer ${token}` } });
        loadEmployees();
    }
}

async function loadAttendance() {
    const date = document.getElementById('acc-att-date').value;
    const resAtt = await fetch(`/api/v1/accounting/attendance?date=${date}`, { headers: { Authorization: `Bearer ${token}` } });
    const dataAtt = await resAtt.json();
    const logs = dataAtt.data;

    // Ø¬Ù„Ø¨ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† Ù„Ø¹Ù…Ù„ Ø¬Ø¯ÙˆÙ„ ÙƒØ§Ù…Ù„
    const resEmp = await fetch('/api/v1/accounting/employees', { headers: { Authorization: `Bearer ${token}` } });
    const dataEmp = await resEmp.json();
    
    const tbody = document.getElementById('acc-att-list');
    tbody.innerHTML = '';

    dataEmp.data.forEach(emp => {
        const log = logs.find(l => l.employee && l.employee._id === emp._id);
        const checkInBtn = log ? (new Date(log.checkIn).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})) : `<button onclick="markAttendance('${emp._id}', 'checkIn')" class="btn btn-success" style="padding:5px 10px; font-size:12px;">ØªØ³Ø¬ÙŠÙ„ Ø­Ø¶ÙˆØ±</button>`;
        
        // ØªØ¹Ø¯ÙŠÙ„: Ø²Ø± Ø§Ù„Ø§Ù†ØµØ±Ø§Ù Ø¨Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø£Ø­Ù…Ø±
        const checkOutBtn = log ? (log.checkOut ? new Date(log.checkOut).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) : `<button onclick="markAttendance('${emp._id}', 'checkOut')" class="btn btn-outline" style="padding:5px 10px; font-size:12px; color:white; background:var(--danger); border-color:var(--danger);">Ø§Ù†ØµØ±Ø§Ù</button>`) : '-';
        
        tbody.innerHTML += `
            <tr>
                <td>
                    <div style="font-weight:bold;">${emp.name}</div>
                    <div style="font-size:11px; color:var(--secondary);">${emp.jobTitle || ''}</div>
                </td>
                <td>${log ? '<span style="color:green">Ø­Ø¶ÙˆØ±</span>' : '<span style="color:red">ØºØ§Ø¦Ø¨</span>'}</td>
                <td>${checkInBtn}</td>
                <td>${checkOutBtn}</td>
                <td>${log ? (log.overtimeHours || 0) + ' Ø³Ø§Ø¹Ø©' : '-'}</td>
                <td>-</td>
            </tr>
        `;
    });
}
async function markAttendance(empId, type) {
    const date = document.getElementById('acc-att-date').value;
    try {
        const res = await fetch('/api/v1/accounting/attendance', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${token}` },
            body: JSON.stringify({ employeeId: empId, type, date })
        });
        if(res.ok) loadAttendance();
        else Swal.fire('Ø®Ø·Ø£', 'ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„ØªØ³Ù„Ø³Ù„', 'error');
    } catch(e) { console.error(e); }
}

async function generatePayroll() {
    const month = document.getElementById('acc-pay-month').value;
    if(!month) return Swal.fire('ØªÙ†Ø¨ÙŠÙ‡', 'Ø§Ø®ØªØ± Ø§Ù„Ø´Ù‡Ø± Ø£ÙˆÙ„Ø§Ù‹', 'warning');
    
    Swal.showLoading();
    try {
        const res = await fetch('/api/v1/accounting/payroll/generate', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${token}` },
            body: JSON.stringify({ month })
        });
        const data = await res.json();
        Swal.close();
        
        const tbody = document.getElementById('acc-pay-list');
        tbody.innerHTML = '';
        data.data.forEach(p => {
            tbody.innerHTML += `
                <tr>
                    <td>${p.employee.name}</td>
                    <td>${p.baseAmount}</td>
                    <td style="color:green">+${p.overtimeAmount}</td>
                    <td>${p.bonuses}</td>
                    <td style="color:red">-${p.deductions}</td>
                    <td style="font-weight:bold; color:var(--primary); font-size:16px;">${p.totalSalary} Ø¬.Ù…</td>
                </tr>
            `;
        });
    } catch(e) { Swal.fire('Ø®Ø·Ø£', 'ÙØ´Ù„ Ø§Ù„Ø­Ø³Ø§Ø¨', 'error'); }
}
      // --- ğŸ“¦ Ø¯ÙˆØ§Ù„ Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø®Ø§Ø²Ù† (Ø§Ù„Ù…Ø¨Ø³Ø·Ø©) ---

async function loadStockItems() {
    const rId = document.getElementById("restaurant-id").value;
    const tbody = document.getElementById('stock-items-list');
    
    tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</td></tr>';

    try {
        const res = await fetch(`/api/v1/stock/${rId}`, { headers: { 'Authorization': `Bearer ${token}` } });
        const data = await res.json();
        
        if(data.status === 'success') {
            stockItemsData = data.data.items;
            
            // === [New] ØªØ­Ø¯ÙŠØ« Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù†ÙˆØ§Ù‚Øµ ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© ===
            let lowStockCount = 0;
            if(stockItemsData) {
                stockItemsData.forEach(item => {
                    if (item.quantity <= item.alertLevel) lowStockCount++;
                });
            }
            const badge = document.getElementById('stock-badge-count');
            if(badge) {
                if(lowStockCount > 0) {
                    badge.innerText = lowStockCount;
                    badge.style.display = 'inline-block';
                } else {
                    badge.style.display = 'none';
                }
            }
            // ====================================================

            renderStockTable();
            renderStockDropdown();
        } else {
            tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; color:red;">ÙØ´Ù„ Ø§Ù„ØªØ­Ù…ÙŠÙ„</td></tr>';
        }
    } catch(e) { console.error(e); }
}

function renderStockTable() {
    const tbody = document.getElementById('stock-items-list');
    tbody.innerHTML = '';
    
    if(stockItemsData.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; color:var(--secondary); padding:20px;">Ø§Ù„Ù…Ø®Ø²Ù† ÙØ§Ø±Øº! Ø§Ø¨Ø¯Ø£ Ø¨Ø¥Ø¶Ø§ÙØ© Ø®Ø§Ù…Ø§ØªÙƒ.</td></tr>';
        return;
    }

    stockItemsData.forEach(item => {
        // ØªÙ†Ø¨ÙŠÙ‡ Ù„Ùˆ Ø§Ù„ÙƒÙ…ÙŠØ© Ù‚Ù„ÙŠÙ„Ø©
        const isLow = item.quantity <= item.alertLevel;
        const qtyStyle = isLow ? 'color:red; font-weight:bold; background:#fee2e2; padding:2px 8px; border-radius:4px;' : 'font-weight:bold; color:green;';
        const alertIcon = isLow ? '<i class="fas fa-exclamation-circle" style="color:red" title="ÙƒÙ…ÙŠØ© Ù…Ù†Ø®ÙØ¶Ø©"></i>' : '';

        tbody.innerHTML += `
            <tr>
                <td style="font-weight:bold; font-size:15px;">${item.name} ${alertIcon}</td>
                <td><span style="${qtyStyle}">${item.quantity}</span></td>
                <td>${item.unit}</td>
                <td>${item.costPerUnit || 0}</td>
                <td>
                    <div style="display:flex; gap:5px;">
                        <button class="btn btn-outline" style="font-size:12px; padding:5px 10px; color:var(--primary); border-color:var(--primary)" 
                            onclick="adjustStock('${item._id}', '${item.name}')" title="ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙƒÙ…ÙŠØ© (Ø´Ø±Ø§Ø¡/Ø§Ø³ØªÙ‡Ù„Ø§Ùƒ)">
                            <i class="fas fa-sync-alt"></i> Ø¬Ø±Ø¯
                        </button>
                        <button class="btn btn-outline" style="font-size:12px; padding:5px 10px; color:var(--danger); border-color:var(--danger)" 
                            onclick="deleteStockItem('${item._id}')" title="Ø­Ø°Ù Ø§Ù„Ø®Ø§Ù…Ø© Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </td>
            </tr>
        `;
    });
}

function renderStockDropdown() {
    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ù…Ù†Ø³Ø¯Ù„Ø© ÙÙŠ ØµÙØ­Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª ÙˆØµÙØ­Ø© Ø§Ù„Ù…Ù‚Ø§Ø¯ÙŠØ±
    const selectors = ['stock-select', 'recipe-stock-select'];
    
    selectors.forEach(selId => {
        const sel = document.getElementById(selId);
        if(sel) {
            sel.innerHTML = '<option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ø®Ø§Ù…Ø© --</option>';
            stockItemsData.forEach(item => {
                sel.innerHTML += `<option value="${item._id}" data-unit="${item.unit}" data-name="${item.name}">${item.name} (Ø¨Ø§Ù„Ù€ ${item.unit})</option>`;
            });
        }
    });
}

// Ø¥Ø¶Ø§ÙØ© Ø®Ø§Ù…Ø© Ø¬Ø¯ÙŠØ¯Ø©
async function openStockModal() {
    const { value: formValues } = await Swal.fire({
        title: 'ğŸ“ Ø¥Ø¶Ø§ÙØ© Ø®Ø§Ù…Ø© Ø¬Ø¯ÙŠØ¯Ø©',
        html:
            '<label style="display:block; text-align:right; margin-bottom:5px;">Ø§Ø³Ù… Ø§Ù„Ø®Ø§Ù…Ø©</label>' +
            '<input id="swal-st-name" class="swal2-input" placeholder="Ù…Ø«Ø§Ù„: Ø¨Ù† Ø¨Ø±Ø§Ø²ÙŠÙ„ÙŠ" style="margin-top:0;">' +
            
            '<label style="display:block; text-align:right; margin-bottom:5px; margin-top:10px;">ÙˆØ­Ø¯Ø© Ø§Ù„Ù‚ÙŠØ§Ø³</label>' +
            '<input id="swal-st-unit" class="swal2-input" placeholder="Ù…Ø«Ø§Ù„: kg Ø£Ùˆ liter Ø£Ùˆ Ù‚Ø·Ø¹Ø©" style="margin-top:0;">' +
            
            '<div style="display:flex; gap:10px; margin-top:10px;">' +
                '<div style="flex:1"><label style="display:block; text-align:right; font-size:12px;">Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ø­Ø§Ù„ÙŠØ©</label><input id="swal-st-qty" type="number" class="swal2-input" placeholder="0" style="margin:0;"></div>' +
                '<div style="flex:1"><label style="display:block; text-align:right; font-size:12px;">Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø©</label><input id="swal-st-cost" type="number" class="swal2-input" placeholder="0" style="margin:0;"></div>' +
            '</div>' +
            
            '<label style="display:block; text-align:right; margin-bottom:5px; margin-top:10px; font-size:12px; color:var(--secondary)">Ù†Ø¨Ù‡Ù†ÙŠ Ù„Ù…Ø§ Ø§Ù„ÙƒÙ…ÙŠØ© ØªÙˆØµÙ„ Ù„Ù€:</label>' +
            '<input id="swal-st-alert" type="number" class="swal2-input" value="5" style="margin-top:0;">',
        focusConfirm: false,
        confirmButtonText: 'Ø­ÙØ¸ Ø§Ù„Ø®Ø§Ù…Ø©',
        showCancelButton: true,
        cancelButtonText: 'Ø¥Ù„ØºØ§Ø¡',
        preConfirm: () => {
            const name = document.getElementById('swal-st-name').value;
            const unit = document.getElementById('swal-st-unit').value;
            if(!name || !unit) Swal.showValidationMessage('Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ù„ÙˆØ­Ø¯Ø© Ù…Ø·Ù„ÙˆØ¨ÙŠÙ†!');
            
            return {
                name: name,
                quantity: document.getElementById('swal-st-qty').value || 0,
                unit: unit,
                costPerUnit: document.getElementById('swal-st-cost').value || 0,
                alertLevel: document.getElementById('swal-st-alert').value || 5
            }
        }
    });

    if (formValues) {
        const rId = document.getElementById("restaurant-id").value;
        try {
            await fetch('/api/v1/stock', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                body: JSON.stringify({ ...formValues, restaurantId: rId })
            });
            loadStockItems();
            Swal.fire({ toast: true, icon: 'success', title: 'ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ø¨Ù†Ø¬Ø§Ø­' });
        } catch(e) { Swal.fire('Ø®Ø·Ø£', 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­ÙØ¸', 'error'); }
    }
}

// ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙƒÙ…ÙŠØ© (Ø¬Ø±Ø¯)
async function adjustStock(id, name) {
    const { value: adjustment } = await Swal.fire({
        title: `Ø¬Ø±Ø¯: ${name}`,
        html: `
            <p>Ø£Ø¯Ø®Ù„ Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„ØªÙŠ ØªØ±ÙŠØ¯ Ø¥Ø¶Ø§ÙØªÙ‡Ø§ Ø£Ùˆ Ø®ØµÙ…Ù‡Ø§.</p>
            <ul style="text-align:right; font-size:13px; color:var(--secondary)">
                <li>Ù„Ø¥Ø¶Ø§ÙØ© Ù…Ø´ØªØ±ÙŠØ§Øª Ø¬Ø¯ÙŠØ¯Ø©: Ø§ÙƒØªØ¨ Ø±Ù‚Ù… Ù…ÙˆØ¬Ø¨ (Ù…Ø«Ø§Ù„: 5)</li>
                <li>Ù„ØªØ³Ø¬ÙŠÙ„ Ù‡Ø§Ù„Ùƒ Ø£Ùˆ Ø¹Ø¬Ø²: Ø§ÙƒØªØ¨ Ø±Ù‚Ù… Ø³Ø§Ù„Ø¨ (Ù…Ø«Ø§Ù„: -1)</li>
            </ul>
        `,
        input: 'number',
        inputLabel: 'Ø§Ù„ÙƒÙ…ÙŠØ©',
        showCancelButton: true,
        confirmButtonText: 'ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±ØµÙŠØ¯',
        cancelButtonText: 'Ø¥Ù„ØºØ§Ø¡'
    });

    if (adjustment) {
        // Ù„Ùˆ Ø§Ù„Ø±Ù‚Ù… Ù…ÙˆØ¬Ø¨ ÙŠØ¨Ù‚Ù‰ Ø´Ø±Ø§Ø¡ØŒ Ù„Ùˆ Ø³Ø§Ù„Ø¨ ÙŠØ¨Ù‚Ù‰ Ø¹Ø¬Ø²/Ø¬Ø±Ø¯
        const type = Number(adjustment) > 0 ? 'restock' : 'adjustment';
        try {
            await fetch(`/api/v1/stock/${id}/adjust`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                body: JSON.stringify({ amount: Number(adjustment), type })
            });
            loadStockItems();
            Swal.fire({ toast: true, icon: 'success', title: 'ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±ØµÙŠØ¯' });
        } catch(e) { Swal.fire('Ø®Ø·Ø£', 'ÙØ´Ù„ Ø§Ù„ØªØ­Ø¯ÙŠØ«', 'error'); }
    }
}

// Ø­Ø°Ù Ø®Ø§Ù…Ø© (Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„ØªÙŠ ÙƒØ§Ù†Øª Ù†Ø§Ù‚ØµØ©)
async function deleteStockItem(id) {
    const result = await Swal.fire({
        title: 'Ø­Ø°Ù Ø§Ù„Ø®Ø§Ù…Ø©ØŸ',
        text: "Ø³ÙŠØªÙ… Ø­Ø°Ù Ø§Ù„Ø®Ø§Ù…Ø© Ù…Ù† Ø§Ù„Ù…Ø®Ø²Ù†. Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ù…Ù†ØªØ¬Ø§Øª (ÙÙŠ Ø§Ù„Ù…Ù‚Ø§Ø¯ÙŠØ±) ÙŠÙØ¶Ù„ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø£ÙˆÙ„Ø§Ù‹.",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#d33',
        confirmButtonText: 'Ù†Ø¹Ù…ØŒ Ø§Ø­Ø°Ù',
        cancelButtonText: 'ØªØ±Ø§Ø¬Ø¹'
    });

    if (result.isConfirmed) {
        try {
            const res = await fetch(`/api/v1/stock/${id}`, {
                method: 'DELETE',
                headers: { 'Authorization': `Bearer ${token}` }
            });
            if(res.ok) {
                loadStockItems();
                Swal.fire({ toast: true, icon: 'success', title: 'ØªÙ… Ø§Ù„Ø­Ø°Ù' });
            } else {
                Swal.fire('Ø®Ø·Ø£', 'ÙØ´Ù„ Ø§Ù„Ø­Ø°Ù', 'error');
            }
        } catch(e) { Swal.fire('Ø®Ø·Ø£', 'Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„', 'error'); }
    }
}

async function loadStockLogs() {
    const rId = document.getElementById("restaurant-id").value;
    const start = document.getElementById('stock-report-start').value;
    const end = document.getElementById('stock-report-end').value;
    const tbody = document.getElementById('stock-logs-list');
    
    tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;">Ø¬Ø§Ø±ÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø³Ø¬Ù„...</td></tr>';

    let query = `?restaurantId=${rId}`;
    if(start && end) query += `&startDate=${start}&endDate=${end}`;

    try {
        const res = await fetch(`/api/v1/stock/logs${query}`, { headers: { 'Authorization': `Bearer ${token}` } });
        const data = await res.json();
        
        tbody.innerHTML = '';
        
        if(data.data.logs.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø³Ø¬Ù„ Ø­Ø±ÙƒØ© ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„ÙØªØ±Ø©</td></tr>';
            return;
        }

        data.data.logs.forEach(log => {
            let typeAr = '';
            let typeColor = '';
            
            switch(log.type) {
                case 'consumption': typeAr = 'Ø¨ÙŠØ¹ (Ø£ÙˆØ±Ø¯Ø±)'; typeColor = '#64748b'; break;
                case 'restock': typeAr = 'Ø´Ø±Ø§Ø¡ / ØªÙˆØ±ÙŠØ¯'; typeColor = 'green'; break;
                case 'adjustment': typeAr = 'ØªØ³ÙˆÙŠÙ‡ Ø¬Ø±Ø¯ / Ù‡Ø§Ù„Ùƒ'; typeColor = 'orange'; break;
                default: typeAr = log.type;
            }

            let changeColor = log.changeAmount > 0 ? 'green' : 'red';
            let note = log.orderId ? `<span style="font-family:monospace; background:#f1f5f9; padding:2px 5px; border-radius:4px;">#${String(log.orderId).slice(-4)}</span>` : '-';
            
            tbody.innerHTML += `
                <tr>
                    <td>${new Date(log.date).toLocaleDateString('ar-EG')} <span style="font-size:11px; color:#999">${new Date(log.date).toLocaleTimeString('ar-EG')}</span></td>
                    <td style="font-weight:bold;">${log.itemName || 'Ø®Ø§Ù…Ø© Ù…Ø­Ø°ÙˆÙØ©'}</td>
                    <td style="color:${typeColor}; font-weight:bold;">${typeAr}</td>
                    <td style="color:${changeColor}; direction:ltr; text-align:right; font-weight:bold;">${log.changeAmount}</td>
                    <td>${note}</td>
                </tr>
            `;
        });
    } catch(e) {
        tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; color:red;">Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø³Ø¬Ù„</td></tr>';
    }
}

// --- ğŸ² Ø¯ÙˆØ§Ù„ Ø±Ø¨Ø· Ø§Ù„Ù…Ù‚Ø§Ø¯ÙŠØ± (Ù„ØµÙØ­Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© ÙÙ‚Ø·) ---
// Ù…Ù„Ø§Ø­Ø¸Ø©: ØªÙ… ØªØ·ÙˆÙŠØ± ØµÙØ­Ø© "Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù‚Ø§Ø¯ÙŠØ±" Ø§Ù„Ù…Ù†ÙØµÙ„Ø© Ù„ØªÙƒÙˆÙ† Ø£Ø³Ù‡Ù„ØŒ Ù‡Ø°Ù‡ Ø§Ù„Ø¯ÙˆØ§Ù„ Ù‡Ù†Ø§ ÙÙ‚Ø· Ù„Ø¯Ø¹Ù… ØµÙØ­Ø© "Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬" Ø§Ù„ØªÙ‚Ù„ÙŠØ¯ÙŠØ©.

function addIngredientRow(stockItem = null, qty = null) {
    const select = document.getElementById('stock-select');
    const qtyInput = document.getElementById('stock-qty');
    
    // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø³ÙˆØ§Ø¡ Ù…Ù† Ø§Ù„Ø¨Ø±Ø§Ù…ÙŠØªØ± Ø£Ùˆ Ù…Ù† Ø§Ù„Ù€ input
    let id, name, unit, amount;

    if (stockItem) {
        // Ø­Ø§Ù„Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø¹Ù†Ø¯ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
        id = stockItem.stockItem._id || stockItem.stockItem; 
        name = stockItem.stockItem.name || 'Ø®Ø§Ù…Ø©';
        unit = stockItem.stockItem.unit || '';
        amount = stockItem.quantity;
    } else {
        // Ø­Ø§Ù„Ø© Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙŠØ¯ÙˆÙŠØ©
        id = select.value;
        const selectedOpt = select.options[select.selectedIndex];
        name = selectedOpt.getAttribute('data-name');
        unit = selectedOpt.getAttribute('data-unit');
        amount = qtyInput.value;
    }

    if(!id || !amount) return;

    currentIngredients.push({ stockItem: id, quantity: Number(amount) });
    renderIngredientsList();
    
    // ØªÙØ±ÙŠØº Ø§Ù„Ø­Ù‚ÙˆÙ„
    qtyInput.value = '';
    select.value = '';
}

function renderIngredientsList() {
    const container = document.getElementById('prod-ingredients-list');
    container.innerHTML = '';
    
    if (currentIngredients.length === 0) {
        container.innerHTML = '<div style="text-align:center; font-size:12px; color:var(--secondary); padding:10px; border:1px dashed #cbd5e1; border-radius:8px;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ÙƒÙˆÙ†Ø§Øª Ù…Ø¶Ø§ÙØ©</div>';
        return;
    }

    currentIngredients.forEach((ing, index) => {
        // Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø§Ø³Ù… Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø­Ù…Ù„Ø©
        let stockObj = stockItemsData.find(s => s._id === ing.stockItem || s._id === ing.stockItem._id);
        
        let displayName = stockObj ? stockObj.name : 'Ø®Ø§Ù…Ø©';
        let displayUnit = stockObj ? stockObj.unit : '';

        container.innerHTML += `
            <div style="
                background: #fff; 
                padding: 10px 12px; 
                margin-bottom: 8px; 
                border-radius: 10px; 
                border: 1px solid #bae6fd; 
                display: flex; 
                justify-content: space-between; 
                align-items: center;
                box-shadow: 0 2px 5px rgba(0,0,0,0.02);
            ">
                <div style="display:flex; align-items:center; gap:10px;">
                    <div style="background:#e0f2fe; color:#0284c7; width:30px; height:30px; border-radius:50%; display:flex; align-items:center; justify-content:center;">
                        <i class="fas fa-cube" style="font-size:12px;"></i>
                    </div>
                    <div>
                        <div style="font-weight:bold; font-size:13px; color:var(--text-main);">${displayName}</div>
                        <div style="font-size:11px; color:var(--secondary);">Ø§Ù„Ø®ØµÙ…: <span style="color:#0284c7; font-weight:bold;">${ing.quantity}</span> ${displayUnit}</div>
                    </div>
                </div>
                
                <button type="button" onclick="removeIngredient(${index})" 
                    style="color:#ef4444; background:none; border:none; cursor:pointer; padding:5px;">
                    <i class="fas fa-times-circle"></i>
                </button>
            </div>
        `;
    });
}

function removeIngredient(index) {
    currentIngredients.splice(index, 1);
    renderIngredientsList();
}
// === Recipe Manager Logic ===
      let activeRecipeProduct = null;
      let activeIngredients = [];

      // ØªØ´ØºÙŠÙ„ Ø§Ù„Ù‚Ø³Ù… Ø¹Ù†Ø¯ Ø§Ù„ÙØªØ­
      function initRecipesView() {
          loadStockItems().then(() => {
              renderRecipeStockSelect(); // Ù…Ù„Ø¡ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø®Ø§Ù…Ø§Øª
          });
          loadRecipeProducts(); // Ù…Ù„Ø¡ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª
      }

      // 1. ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª ÙˆØ¹Ø±Ø¶Ù‡Ø§ ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ©
      async function loadRecipeProducts() {
          const rId = document.getElementById("restaurant-id").value;
          const container = document.getElementById("recipe-products-list");
          container.innerHTML = '<div style="text-align:center; padding:10px;"><i class="fas fa-spinner fa-spin"></i></div>';

          try {
              const res = await fetch(`/api/v1/products/restaurant/${rId}`, {
                  headers: { Authorization: `Bearer ${token}` },
              });
              const data = await res.json();
              
              if (data.status === "success") {
                  window.allRecipeProducts = data.data.products; // Ø­ÙØ¸ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ù„Ù„Ø¨Ø­Ø«
                  renderRecipeProductList(window.allRecipeProducts);
              }
          } catch (e) {
              console.error(e);
              container.innerHTML = '<div style="color:red; text-align:center;">Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„</div>';
          }
      }

      function renderRecipeProductList(products) {
          const container = document.getElementById("recipe-products-list");
          container.innerHTML = "";
          
          if(products.length === 0) {
              container.innerHTML = '<div style="text-align:center; color:gray;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª</div>';
              return;
          }

          products.forEach(p => {
              const hasIngredients = p.ingredients && p.ingredients.length > 0;
              const statusIcon = hasIngredients 
                  ? '<i class="fas fa-check-circle" style="color:var(--success)"></i>' 
                  : '<i class="fas fa-circle" style="color:#e2e8f0"></i>';

              const div = document.createElement("div");
              div.style.cssText = `
                  padding: 10px; background: var(--bg); border-radius: 8px; cursor: pointer;
                  display: flex; align-items: center; gap: 10px; transition: 0.2s; border: 1px solid transparent;
              `;
              div.innerHTML = `
                  ${statusIcon}
                  <div style="flex:1; font-weight:bold; font-size:14px;">${p.name.ar}</div>
                  <i class="fas fa-chevron-left" style="font-size:12px; color:var(--secondary)"></i>
              `;
              
              div.onclick = () => {
                  // ØªØ¸Ù„ÙŠÙ„ Ø§Ù„Ø¹Ù†ØµØ± Ø§Ù„Ù…Ø®ØªØ§Ø±
                  document.querySelectorAll("#recipe-products-list > div").forEach(d => d.style.borderColor = "transparent");
                  div.style.borderColor = "var(--primary)";
                  div.style.background = "var(--primary-light)";
                  openRecipeEditor(p);
              };
              container.appendChild(div);
          });
      }

      // Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª
      function filterRecipeProducts() {
          const term = document.getElementById("recipe-search").value.toLowerCase();
          const filtered = window.allRecipeProducts.filter(p => p.name.ar.toLowerCase().includes(term));
          renderRecipeProductList(filtered);
      }

      // 2. ÙØªØ­ Ø§Ù„Ù…Ø­Ø±Ø± Ù„Ù…Ù†ØªØ¬ Ù…Ø¹ÙŠÙ†
      function openRecipeEditor(product) {
          activeRecipeProduct = product;
          activeIngredients = product.ingredients ? [...product.ingredients] : []; // Ù†Ø³Ø® Ø§Ù„Ù…Ù‚Ø§Ø¯ÙŠØ± Ø§Ù„Ø­Ø§Ù„ÙŠØ©

          document.getElementById("recipe-editor-empty").classList.add("hidden");
          document.getElementById("recipe-editor-content").classList.remove("hidden");
          document.getElementById("recipe-active-name").innerText = product.name.ar;

          renderActiveIngredientsTable();
      }

      // 3. Ù…Ù„Ø¡ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø®Ø§Ù…Ø§Øª (Dropdown)
      function renderRecipeStockSelect() {
          const select = document.getElementById("recipe-stock-select");
          select.innerHTML = '<option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ø®Ø§Ù…Ø© --</option>';
          
          // stockItemsData ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† Ù…Ø­Ù…Ù„Ø© Ù…Ù† Ø¯Ø§Ù„Ø© loadStockItems Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø© Ù…Ø³Ø¨Ù‚Ø§Ù‹
          if(typeof stockItemsData !== 'undefined') {
              stockItemsData.forEach(item => {
                  select.innerHTML += `<option value="${item._id}" data-unit="${item.unit}" data-name="${item.name}">${item.name} (${item.unit})</option>`;
              });
          }

          // ØªØ­Ø¯ÙŠØ« Ù‡Ù†Ø¯ Ø§Ù„ÙˆØ­Ø¯Ø© Ø¹Ù†Ø¯ Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±
          select.onchange = function() {
              const unit = this.options[this.selectedIndex].getAttribute("data-unit");
              document.getElementById("recipe-unit-hint").innerText = unit ? `Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…Ø©: ${unit}` : "";
          };
      }

      // 4. Ø¥Ø¶Ø§ÙØ© Ù…ÙƒÙˆÙ† Ù„Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø¤Ù‚ØªØ©
      function addIngredientToActive() {
          const select = document.getElementById("recipe-stock-select");
          const qtyInput = document.getElementById("recipe-stock-qty");
          
          const stockId = select.value;
          const qty = parseFloat(qtyInput.value);
          const name = select.options[select.selectedIndex]?.getAttribute("data-name");
          const unit = select.options[select.selectedIndex]?.getAttribute("data-unit");

          if(!stockId || !qty || qty <= 0) return Swal.fire("ØªÙ†Ø¨ÙŠÙ‡", "Ø§Ø®ØªØ± Ø§Ù„Ø®Ø§Ù…Ø© ÙˆØ§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„ØµØ­ÙŠØ­Ø©", "warning");

          // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªÙƒØ±Ø§Ø± (Ù…Ø¹ ØªØ¬Ø§Ù‡Ù„ Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„ØªØ§Ù„ÙØ©)
          const existing = activeIngredients.find(i => i.stockItem && (i.stockItem._id || i.stockItem) === stockId);
          if(existing) {
              existing.quantity = qty; // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙƒÙ…ÙŠØ© Ù„Ùˆ Ù…ÙˆØ¬ÙˆØ¯
          } else {
              // Ø¥Ø¶Ø§ÙØ© Ù‡ÙŠÙƒÙ„ ÙŠØ´Ø¨Ù‡ Ø§Ù„Ù…Ø±ØªØ¬Ø¹ Ù…Ù† Ø§Ù„Ø¯Ø§ØªØ§Ø¨ÙŠØ² Ù„Ù„Ø¹Ø±Ø¶
              activeIngredients.push({
                  stockItem: { _id: stockId, name: name, unit: unit }, 
                  quantity: qty
              });
          }

          renderActiveIngredientsTable();
          select.value = "";
          qtyInput.value = "";
          document.getElementById("recipe-unit-hint").innerText = "";
      }

      // 5. Ø±Ø³Ù… Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…ÙƒÙˆÙ†Ø§Øª
      function renderActiveIngredientsTable() {
          const tbody = document.getElementById("recipe-active-list");
          tbody.innerHTML = "";

          activeIngredients.forEach((ing, index) => {
              // [Fix] Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ø®Ø§Ù…Ø© Ù…Ø­Ø°ÙˆÙØ© (null)
              if (!ing.stockItem) {
                  tbody.innerHTML += `
                      <tr style="background:#fff1f2;">
                          <td style="color:red; font-weight:bold;">âš ï¸ Ø®Ø§Ù…Ø© Ù…Ø­Ø°ÙˆÙØ©</td>
                          <td style="font-weight:bold;">${ing.quantity}</td>
                          <td>-</td>
                          <td>
                              <button class="btn btn-outline" style="color:red; padding:2px 8px;" onclick="removeActiveIngredient(${index})">
                                  <i class="fas fa-trash"></i>
                              </button>
                          </td>
                      </tr>
                  `;
                  return; // ØªØ®Ø·ÙŠ Ù‡Ø°Ø§ Ø§Ù„ØµÙ
              }

              // Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø³ÙˆØ§Ø¡ ÙƒØ§Ù†Øª populated Ø£Ùˆ Ù…Ø¬Ø±Ø¯ ID (Ù„Ù„Ø¹Ø±Ø¶ Ø§Ù„ÙÙˆØ±ÙŠ)
              let name = ing.stockItem.name || "Ø®Ø§Ù…Ø©";
              let unit = ing.stockItem.unit || "-";
              
              // Ù…Ø­Ø§ÙˆÙ„Ø© Ø¥ÙŠØ¬Ø§Ø¯ Ø§Ù„Ø§Ø³Ù… Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø­Ù…Ù„Ø© Ù„Ùˆ ÙƒØ§Ù† Ù…Ø¬Ø±Ø¯ ID
              if(!ing.stockItem.name && typeof stockItemsData !== 'undefined') {
                  const s = stockItemsData.find(x => x._id === ing.stockItem);
                  if(s) { name = s.name; unit = s.unit; }
              }

              tbody.innerHTML += `
                  <tr>
                      <td>${name}</td>
                      <td style="font-weight:bold; color:var(--primary)">${ing.quantity}</td>
                      <td>${unit}</td>
                      <td>
                          <button class="btn btn-outline" style="color:red; padding:2px 8px;" onclick="removeActiveIngredient(${index})">
                              <i class="fas fa-trash"></i>
                          </button>
                      </td>
                  </tr>
              `;
          });

          if(activeIngredients.length === 0) {
              tbody.innerHTML = '<tr><td colspan="4" style="text-align:center; color:gray;">Ù„Ù… ÙŠØªÙ… Ø¥Ø¶Ø§ÙØ© Ù…Ù‚Ø§Ø¯ÙŠØ± Ø¨Ø¹Ø¯</td></tr>';
          }

          // === [New] Ø­Ø³Ø§Ø¨ Ø§Ù„ØªÙƒÙ„ÙØ© Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ© Ù„Ù„Ù…Ù‚Ø§Ø¯ÙŠØ± ===
          let totalCost = 0;
          activeIngredients.forEach(ing => {
              if(ing.stockItem) {
                  // Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø³Ø¹Ø± Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø­Ù…Ù„Ø© (Ù„Ø£Ù† Ø§Ù„Ù€ object Ø§Ù„Ø­Ø§Ù„ÙŠ Ù‚Ø¯ Ù„Ø§ ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø§Ù„Ø³Ø¹Ø±)
                  let cost = ing.stockItem.costPerUnit || 0;
                  
                  // Ù„Ùˆ Ø§Ù„Ø³Ø¹Ø± 0 (Ø±Ø¨Ù…Ø§ Ù„Ù… ÙŠØªÙ… Ø¹Ù…Ù„ populate)ØŒ Ù†Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© stockItemsData
                  if(!cost && typeof stockItemsData !== 'undefined') {
                      const originalItem = stockItemsData.find(x => x._id === (ing.stockItem._id || ing.stockItem));
                      if(originalItem) cost = originalItem.costPerUnit;
                  }
                  totalCost += (ing.quantity * cost);
              }
          });
          const costDisplay = document.getElementById('recipe-cost-display');
          if(costDisplay) costDisplay.innerText = `Ø§Ù„ØªÙƒÙ„ÙØ©: ${totalCost.toFixed(2)} Ø¬.Ù…`;
          // =============================================
      }

      function removeActiveIngredient(index) {
          activeIngredients.splice(index, 1);
          renderActiveIngredientsTable();
      }

      // 6. Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª ÙÙŠ Ø§Ù„Ø³ÙŠØ±ÙØ±
      async function saveActiveRecipe() {
          if(!activeRecipeProduct) return;

          // ØªØ­Ø¶ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø§Ù„Ø´ÙƒÙ„ Ø§Ù„Ø°ÙŠ ÙŠÙ‚Ø¨Ù„Ù‡ Ø§Ù„Ø¨Ø§Ùƒ Ø§Ù†Ø¯ (ID ÙˆØ§Ù„ÙƒÙ…ÙŠØ© ÙÙ‚Ø·)
          // [Fix] ØªØµÙÙŠØ© Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„ØªØ§Ù„ÙØ© (null) Ù‚Ø¨Ù„ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø© Ù„ØªØ¬Ù†Ø¨ ØªÙˆÙ‚Ù Ø§Ù„Ù†Ø¸Ø§Ù…
          const cleanIngredients = activeIngredients
              .filter(i => i.stockItem) // Ù†Ø£Ø®Ø° ÙÙ‚Ø· Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ø³Ù„ÙŠÙ…Ø©
              .map(i => ({
                  stockItem: i.stockItem._id || i.stockItem, 
                  quantity: i.quantity
              }));

          // Ø¨Ù†Ø§Ø¡ FormData ÙƒÙ…Ø§ ÙÙŠ Ø¯Ø§Ù„Ø© saveProduct Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
          const formData = new FormData();
          // Ù†Ø­ØªØ§Ø¬ Ù†Ø±Ø³Ù„ ÙÙ‚Ø· Ø§Ù„Ù…Ù‚Ø§Ø¯ÙŠØ±ØŒ Ù„ÙƒÙ† Ø§Ù„Ù€ Controller Ø§Ù„Ø­Ø§Ù„ÙŠ ÙŠØªÙˆÙ‚Ø¹ Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø£Ùˆ ÙŠØªØ¬Ø§Ù‡Ù„Ù‡Ø§.
          // Ø¨ÙØ¶Ù„ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø³Ø§Ø¨Ù‚ ÙÙŠ productControllerØŒ Ø³ÙŠØ¨Ø­Ø« Ø¹Ù† ingredients ÙˆÙŠØ­Ø¯Ø«Ù‡Ø§.
          
          formData.append("ingredients", JSON.stringify(cleanIngredients));
          
          // Ù…Ù„Ø§Ø­Ø¸Ø©: Ø§Ù„Ù€ controller Ù‚Ø¯ ÙŠØ­ØªØ§Ø¬ Ù„Ø­Ù‚ÙˆÙ„ Ø£Ø®Ø±Ù‰ Ø¥Ù„Ø²Ø§Ù…ÙŠØ© Ù…Ø«Ù„ Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ù„Ù‚Ø³Ù…ØŒ 
          // Ù„Ø°Ø§ Ø³Ù†Ø±Ø³Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© ÙƒÙ…Ø§ Ù‡ÙŠ Ù„ØªØ¬Ù†Ø¨ Ù…Ø´Ø§ÙƒÙ„ Ø§Ù„Ù€ Validation
          formData.append("name", JSON.stringify(activeRecipeProduct.name));
          formData.append("category", activeRecipeProduct.category);
          formData.append("restaurantId", document.getElementById("restaurant-id").value);

          Swal.showLoading();
          try {
              const res = await fetch(`/api/v1/products/${activeRecipeProduct._id}`, {
                  method: "PATCH",
                  headers: { Authorization: `Bearer ${token}` },
                  body: formData
              });
              
              const data = await res.json();
              Swal.close();

              if (data.status === "success") {
                  Swal.fire({ toast: true, icon: "success", title: "ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ù‚Ø§Ø¯ÙŠØ± Ø¨Ù†Ø¬Ø§Ø­" });
                  
                  // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ù†ØªØ¬ ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø­Ù„ÙŠØ©
                  const updatedProd = data.data.product;
                  const idx = window.allRecipeProducts.findIndex(p => p._id === updatedProd._id);
                  if(idx !== -1) window.allRecipeProducts[idx] = updatedProd;
                  
                  renderRecipeProductList(window.allRecipeProducts); // Ø¥Ø¹Ø§Ø¯Ø© Ø±Ø³Ù… Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø©
              } else {
                  Swal.fire("Ø®Ø·Ø£", data.message, "error");
              }
          } catch (e) {
              console.error(e);
              Swal.fire("Ø®Ø·Ø£", "ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±", "error");
          }
      }
    </script>
    <div id="manual-order-modal" class="overlay" style="z-index: 9999; display: none;">
        <div class="card" style="width: 90%; max-width: 800px; margin: 2vh auto; max-height: 95vh; display: flex; flex-direction: column; padding: 0;">
            <div style="padding: 15px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; background: var(--bg);">
                <h3 style="margin: 0; color: var(--primary)"><i class="fas fa-cash-register"></i> Ø¥Ù†Ø´Ø§Ø¡ Ø·Ù„Ø¨ ÙŠØ¯ÙˆÙŠ</h3>
                <button onclick="closeManualOrderModal()" style="background: none; border: none; font-size: 20px; cursor: pointer; color: var(--danger);"><i class="fas fa-times"></i></button>
            </div>
            
            <div style="padding: 15px; overflow-y: auto; flex: 1;">
                <div style="display: flex; gap: 15px; flex-wrap: wrap; margin-bottom: 20px;">
                    <div style="flex: 1; min-width: 200px;">
                         <label class="form-label">Ø¨Ø­Ø« Ø¹Ù† Ù…Ù†ØªØ¬</label>
                         <input type="text" id="manual-search" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬..." onkeyup="filterManualProducts()" style="margin-bottom: 5px;">
                         <div id="manual-products-results" style="border: 1px solid var(--border-color); max-height: 150px; overflow-y: auto; display: none; background: var(--surface); position: absolute; width: 300px; z-index: 100; border-radius: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.1);"></div>
                    </div>
                    <div style="flex: 1; min-width: 150px;">
                        <label class="form-label">Ø±Ù‚Ù… Ø§Ù„Ø·Ø§ÙˆÙ„Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
                        <input type="text" id="manual-table" placeholder="Ù…Ø«Ø§Ù„: 5 Ø£Ùˆ ØªÙŠÙƒ Ø£ÙˆØ§ÙŠ">
                    </div>
                </div>

                <div class="table-wrapper" style="margin-bottom: 15px;">
                    <table style="min-width: 100%;">
                        <thead>
                            <tr>
                                <th>Ø§Ù„Ù…Ù†ØªØ¬</th>
                                <th>Ø§Ù„Ø³Ø¹Ø±</th>
                                <th>Ø§Ù„ÙƒÙ…ÙŠØ©</th>
                                <th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
                                <th>Ø­Ø°Ù</th>
                            </tr>
                        </thead>
                        <tbody id="manual-cart-list">
                            </tbody>
                    </table>
                </div>

                <div style="background: var(--bg); padding: 15px; border-radius: 12px; border: 1px solid var(--border-color);">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                        <span>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹:</span> <span id="manual-subtotal" style="font-weight: bold;">0</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                         <span>Ø§Ù„Ø¶Ø±ÙŠØ¨Ø© / Ø§Ù„Ø®Ø¯Ù…Ø©:</span> <span id="manual-tax-serv">0</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; font-size: 18px; font-weight: bold; color: var(--primary); border-top: 1px dashed var(--border-color); padding-top: 5px;">
                        <span>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ:</span> <span id="manual-final">0</span>
                    </div>
                </div>
            </div>

            <div style="padding: 15px; border-top: 1px solid var(--border-color); background: var(--bg); text-align: left;">
                <button class="btn btn-success" onclick="submitManualOrder()" style="width: 100%; font-size: 16px;">
                    <i class="fas fa-check"></i> ØªØ£ÙƒÙŠØ¯ ÙˆØ¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø·Ù„Ø¨
                </button>
            </div>
        </div>
    </div>

    <script>
        let manualCart = [];

        function openManualOrderModal() {
            // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø£ÙˆÙ„Ø§Ù‹
            if (!window.allProductsGlobal || window.allProductsGlobal.length === 0) {
                loadProducts().then(() => {
                    document.getElementById('manual-order-modal').style.display = 'block';
                });
            } else {
                document.getElementById('manual-order-modal').style.display = 'block';
            }
            manualCart = [];
            renderManualCart();
            document.getElementById('manual-table').value = '';
        }

        function closeManualOrderModal() {
            document.getElementById('manual-order-modal').style.display = 'none';
        }

        function filterManualProducts() {
            const term = document.getElementById('manual-search').value.toLowerCase();
            const resultsDiv = document.getElementById('manual-products-results');
            
            if (!term) {
                resultsDiv.style.display = 'none';
                return;
            }

            const filtered = window.allProductsGlobal.filter(p => p.name.ar.toLowerCase().includes(term));
            
            resultsDiv.innerHTML = '';
            if (filtered.length > 0) {
                resultsDiv.style.display = 'block';
                filtered.forEach(p => {
                    const price = p.sizes && p.sizes.length > 0 ? p.sizes[0].price : p.price;
                    const name = p.name.ar;
                    // ØªÙ…Ø±ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙƒÙ€ String
                    const pData = encodeURIComponent(JSON.stringify(p));
                    
                    const div = document.createElement('div');
                    div.style.padding = '10px';
                    div.style.borderBottom = '1px solid #eee';
                    div.style.cursor = 'pointer';
                    div.innerHTML = `<b>${name}</b> - <small>${price} Ø¬.Ù…</small>`;
                    div.onclick = () => selectManualProduct(pData);
                    resultsDiv.appendChild(div);
                });
            } else {
                resultsDiv.style.display = 'none';
            }
        }

        function selectManualProduct(pData) {
            const product = JSON.parse(decodeURIComponent(pData));
            document.getElementById('manual-products-results').style.display = 'none';
            document.getElementById('manual-search').value = '';

            let finalPrice = product.price;
            let finalName = product.name.ar;

            // Ù„Ùˆ ÙÙŠÙ‡ Ø£Ø­Ø¬Ø§Ù…ØŒ Ù†Ø§Ø®Ø¯ Ø£ÙˆÙ„ Ø­Ø¬Ù… ØªÙ„Ù‚Ø§Ø¦ÙŠ (Ù„Ù„Ø³Ù‡ÙˆÙ„Ø©) Ø£Ùˆ Ù…Ù…ÙƒÙ† Ù†Ø¹Ù…Ù„ Ù…ÙˆØ¯Ø§Ù„ ØªØ§Ù†ÙŠ Ù„Ù„Ø£Ø­Ø¬Ø§Ù…
            // Ù‡Ù†Ø§ Ù‡Ù†Ø§Ø®Ø¯ Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ Ø£Ùˆ Ø³Ø¹Ø± Ø£ÙˆÙ„ Ø­Ø¬Ù…
            if (product.sizes && product.sizes.length > 0) {
                finalPrice = product.sizes[0].price;
                finalName += ` (${product.sizes[0].name})`;
            }

            const existing = manualCart.find(item => item.id === product._id && item.name === finalName);
            if (existing) {
                existing.qty++;
            } else {
                manualCart.push({
                    id: product._id,
                    name: finalName,
                    price: finalPrice,
                    qty: 1
                });
            }
            renderManualCart();
        }

        function renderManualCart() {
            const tbody = document.getElementById('manual-cart-list');
            tbody.innerHTML = '';
            let subtotal = 0;

            manualCart.forEach((item, index) => {
                const total = item.price * item.qty;
                subtotal += total;
                tbody.innerHTML += `
                    <tr>
                        <td>${item.name}</td>
                        <td>${item.price}</td>
                        <td style="display:flex; gap:5px; align-items:center;">
                            <button onclick="updateManualQty(${index}, 1)" class="btn btn-outline" style="padding:2px 8px;">+</button>
                            <span>${item.qty}</span>
                            <button onclick="updateManualQty(${index}, -1)" class="btn btn-outline" style="padding:2px 8px;">-</button>
                        </td>
                        <td>${total}</td>
                        <td><button onclick="removeFromManualCart(${index})" style="color:red; border:none; background:none; cursor:pointer;"><i class="fas fa-trash"></i></button></td>
                    </tr>
                `;
            });

            // Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª
            const taxRate = parseFloat(document.getElementById('set-taxRate').value) || 0;
            const serviceRate = parseFloat(document.getElementById('set-serviceRate').value) || 0;

            const taxVal = (subtotal * taxRate) / 100;
            const serviceVal = (subtotal * serviceRate) / 100;
            const finalTotal = subtotal + taxVal + serviceVal;

            document.getElementById('manual-subtotal').innerText = subtotal.toFixed(2);
            document.getElementById('manual-tax-serv').innerText = (taxVal + serviceVal).toFixed(2);
            document.getElementById('manual-final').innerText = finalTotal.toFixed(2);
        }

        function updateManualQty(index, change) {
            manualCart[index].qty += change;
            if (manualCart[index].qty <= 0) manualCart.splice(index, 1);
            renderManualCart();
        }

        function removeFromManualCart(index) {
            manualCart.splice(index, 1);
            renderManualCart();
        }

        async function submitManualOrder() {
            if (manualCart.length === 0) return Swal.fire('ØªÙ†Ø¨ÙŠÙ‡', 'Ø§Ù„Ø³Ù„Ø© ÙØ§Ø±ØºØ©', 'warning');

            const tableNum = document.getElementById('manual-table').value || 'ØªÙŠÙƒ Ø£ÙˆØ§ÙŠ';
            const rId = document.getElementById('restaurant-id').value;

            // ØªØ¬Ù‡ÙŠØ² Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†ÙØ³ Ù‡ÙŠÙƒÙ„ Ø§Ù„Ù€ API
            const subTotal = parseFloat(document.getElementById('manual-subtotal').innerText);
            const taxServ = parseFloat(document.getElementById('manual-tax-serv').innerText);
            const finalTotal = parseFloat(document.getElementById('manual-final').innerText);

            // ØªÙ‚Ø³ÙŠÙ… Ø§Ù„Ø¶Ø±ÙŠØ¨Ø© ÙˆØ§Ù„Ø®Ø¯Ù…Ø© ØªÙ‚Ø±ÙŠØ¨ÙŠØ§Ù‹
            const taxRate = parseFloat(document.getElementById('set-taxRate').value) || 0;
            const serviceRate = parseFloat(document.getElementById('set-serviceRate').value) || 0;
            
            const taxAmount = (subTotal * taxRate) / 100;
            const serviceAmount = (subTotal * serviceRate) / 100;

            const items = manualCart.map(i => ({
                name: i.name,
                qty: i.qty,
                price: i.price
            }));

            const body = {
                restaurantId: rId,
                tableNumber: tableNum,
                items: items,
                subTotal: subTotal,
                taxAmount: taxAmount,
                serviceAmount: serviceAmount,
                couponCode: null,
                discountAmount: 0,
                totalPrice: finalTotal
            };

            Swal.showLoading();
            try {
                const res = await fetch('/api/v1/orders', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });
                
                const data = await res.json();
                
                                if (data.status === 'success') {
                    Swal.fire({ icon: 'success', title: 'ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø·Ù„Ø¨', timer: 1500, showConfirmButton: false });
                    closeManualOrderModal();
                    switchView('orders'); // Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ù„ØµÙØ­Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø­ÙŠØ©
                    loadOrders(); 
                } else {
                    Swal.fire('Ø®Ø·Ø£', data.message, 'error');
                }
            } catch (e) {
                console.error(e);
                Swal.fire('Ø®Ø·Ø£', 'ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„', 'error');
            }
        }
        function applyUserPermissions(user) {
        const stockSidebar = document.getElementById('nav-stock'); // ØªØ£ÙƒØ¯ Ø£Ù† Ù„Ø¯ÙŠÙƒ ID Ù„Ù„Ø²Ø± ÙÙŠ Ø§Ù„Ø³Ø§ÙŠØ¯ Ø¨Ø§Ø±
        const stockMobile = document.getElementById('mob-nav-stock');

        // Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ: Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø¹Ù†Ø§ØµØ±
        if (stockSidebar) stockSidebar.style.display = 'none';
        if (stockMobile) stockMobile.style.display = 'none';

        // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ù…ÙŠØ²Ø© Ù…ÙØ¹Ù„Ø©ØŒ Ù‚Ù… Ø¨Ø¥Ø¸Ù‡Ø§Ø±Ù‡Ø§
        if (user.hasStock === true) {
            if (stockSidebar) stockSidebar.style.display = 'flex'; // Ø£Ùˆ block Ø­Ø³Ø¨ ØªØµÙ…ÙŠÙ…Ùƒ
            if (stockMobile) stockMobile.style.display = 'flex';
        }
    }

    // Ù…Ø«Ø§Ù„: Ø£ÙŠÙ† ØªØ¶Ø¹ Ù‡Ø°Ù‡ Ø§Ù„Ø¯Ø§Ù„Ø©ØŸ
    // Ø§Ø³ØªØ¯Ø¹Ù Ù‡Ø°Ù‡ Ø§Ù„Ø¯Ø§Ù„Ø© ÙÙˆØ± Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±
    // Ù…Ø«Ù„Ø§Ù‹ Ø¯Ø§Ø®Ù„ getMyRestaurant() Ø£Ùˆ checkAuth()
    
    async function initPage() {
        try {
            const res = await fetch("/api/v1/restaurants/my-restaurant", {
                headers: { Authorization: `Bearer ${token}` },
            });
            const result = await res.json();
            
            if (result.status === 'success') {
                const restaurant = result.data.restaurant;
                const userRole = result.data.userRole;
                
                // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªÙØ¹ÙŠÙ„ Ù…ÙŠØ²Ø© Ø§Ù„Ù…Ø®Ø§Ø²Ù† Ù„Ù„Ù…Ø§Ù„Ùƒ Ø£Ùˆ Ø§Ù„Ù…Ø·Ø¹Ù…
                const isStockEnabled = restaurant.owner.hasStock || restaurant.hasStock;

                if (isStockEnabled && userRole === 'owner') {
                    // Ø¥Ø¸Ù‡Ø§Ø± ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© (Sidebar)
                    if (document.getElementById('nav-stock')) document.getElementById('nav-stock').classList.remove('hidden');
                    if (document.getElementById('nav-recipes')) document.getElementById('nav-recipes').classList.remove('hidden');
                    
                    // Ø¥Ø¸Ù‡Ø§Ø± ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø³ÙÙ„ÙŠØ© Ù„Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ (Mobile Nav)
                    const stockMobile = document.getElementById('mob-nav-stock');
                    if (stockMobile) stockMobile.classList.remove('hidden');
                    
                    // Ø¥Ø¸Ù‡Ø§Ø± Ù‚Ø³Ù… Ø§Ù„Ù…Ù‚Ø§Ø¯ÙŠØ± ÙÙŠ ØµÙØ­Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª
                    if (document.getElementById('ingredients-section')) document.getElementById('ingredients-section').classList.remove('hidden');
                } else {
                    // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ø®ÙØ§Ø¦Ù‡Ø§ ØªÙ…Ø§Ù…Ø§Ù‹ Ø¥Ø°Ø§ Ù„Ù… ØªÙƒÙ† Ù…ÙØ¹Ù„Ø©
                    if (document.getElementById('nav-stock')) document.getElementById('nav-stock').classList.add('hidden');
                    if (document.getElementById('nav-recipes')) document.getElementById('nav-recipes').classList.add('hidden');
                    if (document.getElementById('mob-nav-stock')) document.getElementById('mob-nav-stock').classList.add('hidden');
                    if (document.getElementById('ingredients-section')) document.getElementById('ingredients-section').classList.add('hidden');
                }
            }
        } catch (err) {
            console.error("Error in initPage permissions:", err);
        }
    }
    async function updateProductOrder() {
          const rows = document.querySelectorAll('#products-list tr');
          const order = [];
          
          rows.forEach((row, index) => {
              const id = row.getAttribute('data-id');
              if(id) {
                  order.push({ id: id, sortOrder: index + 1 });
              }
          });

          if(order.length > 0) {
              try {
                  await fetch('/api/v1/products/reorder', {
                      method: 'PATCH',
                      headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${token}` },
                      body: JSON.stringify({ order })
                  });
              } catch(e) { console.error(e); }
          }
      }
      // --- Ø¯Ø§Ù„Ø© ØªØºÙŠÙŠØ± Ø­Ø§Ù„Ø© Ø§Ù„ØªÙˆÙØ± (Ø¥ØµÙ„Ø§Ø­ Ø®Ø·Ø£ 404) ---
      async function toggleProd(id) {
        // 1. Ù†Ø¬ÙŠØ¨ Ø§Ù„Ù…Ù†ØªØ¬ Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù„ÙŠ Ø­Ù…Ù„Ù†Ø§Ù‡Ø§ Ø¹Ø´Ø§Ù† Ù†Ø¹Ø±Ù Ø­Ø§Ù„ØªÙ‡ Ø§Ù„Ø­Ø§Ù„ÙŠØ©
        const product = window.allProductsGlobal.find(p => p._id === id);
        if (!product) return;

        const newStatus = !product.isAvailable; // Ø¹ÙƒØ³ Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©

        try {
            // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø±Ø§Ø¨Ø· Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù‚ÙŠØ§Ø³ÙŠ Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† toggle
            const res = await fetch(`/api/v1/products/${id}`, {
                method: 'PATCH',
                headers: { 
                    'Content-Type': 'application/json',
                    Authorization: `Bearer ${token}` 
                },
                body: JSON.stringify({ isAvailable: newStatus })
            });

            if (res.ok) {
                // ØªØ­Ø¯ÙŠØ« Ø³Ø±ÙŠØ¹ ÙÙŠ Ø§Ù„Ù…ØªØµÙØ­
                product.isAvailable = newStatus;
                
                // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø´ÙƒÙ„ ÙÙ‚Ø· Ù„Ù„ÙƒØ§Ø±Øª Ø¯Ù‡ (Ø¨Ø¯ÙˆÙ† Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø© ÙƒÙ„Ù‡Ø§)
                const card = document.getElementById(`prod-card-${id}`);
                if(card) {
                    card.style.opacity = newStatus ? '1' : '0.6';
                    const icon = card.querySelector('.fa-eye, .fa-eye-slash');
                    if(icon) {
                        icon.className = newStatus ? 'fas fa-eye' : 'fas fa-eye-slash';
                        // ØªÙ… Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ù„ÙˆÙ† Ù„ÙŠÙƒÙˆÙ† Ø£Ø®Ø¶Ø± Ø¹Ù†Ø¯ Ø§Ù„ØªÙØ¹ÙŠÙ„
                        icon.style.color = newStatus ? 'var(--success)' : 'var(--secondary)';
                        
                        // ØªÙ… Ù†Ù‚Ù„ Ù‡Ø°Ø§ Ø§Ù„Ø³Ø·Ø± Ù„Ù„Ø¯Ø§Ø®Ù„ Ù„Ù…Ù†Ø¹ Ø§Ù„Ø®Ø·Ø£
                        if(newStatus && icon.classList.contains('text-danger')) {
                            icon.classList.replace('text-danger', 'text-success');
                        }
                    }
                }

                Swal.fire({
                    toast: true,
                    icon: 'success',
                    title: newStatus ? 'Ø§Ù„Ù…Ù†ØªØ¬ Ù…ØªØ§Ø­ Ø§Ù„Ø¢Ù†' : 'ØªÙ… Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù…Ù†ØªØ¬',
                    timer: 1500,
                    showConfirmButton: false
                });
            } else {
                Swal.fire('Ø®Ø·Ø£', 'ÙØ´Ù„ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø©', 'error');
            }
        } catch (e) {
            console.error(e);
            Swal.fire('Ø®Ø·Ø£', 'Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„', 'error');
        }
      }

      // --- Ø¯Ø§Ù„Ø© Ø­Ø°Ù Ø§Ù„Ù…Ù†ØªØ¬ ---
      async function deleteProd(id) {
        const result = await Swal.fire({
            title: 'Ø­Ø°Ù Ø§Ù„Ù…Ù†ØªØ¬ØŸ',
            text: "Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#ef4444',
            confirmButtonText: 'Ù†Ø¹Ù…ØŒ Ø­Ø°Ù',
            cancelButtonText: 'Ø¥Ù„ØºØ§Ø¡'
        });

        if (result.isConfirmed) {
            try {
                const res = await fetch(`/api/v1/products/${id}`, {
                    method: 'DELETE',
                    headers: { Authorization: `Bearer ${token}` }
                });

                if (res.ok) {
                    // Ø­Ø°Ù Ø§Ù„ÙƒØ§Ø±Øª Ù…Ù† Ø§Ù„Ø´Ø§Ø´Ø© ÙÙˆØ±Ø§Ù‹ Ø¨Ø­Ø±ÙƒØ© Ù†Ø§Ø¹Ù…Ø©
                    const card = document.getElementById(`prod-card-${id}`);
                    if(card) {
                        card.style.transform = 'translateX(100px)';
                        card.style.opacity = '0';
                        setTimeout(() => card.remove(), 300);
                    }
                    
                    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ØµÙÙˆÙØ© Ø§Ù„Ø¹Ø§Ù„Ù…ÙŠØ©
                    window.allProductsGlobal = window.allProductsGlobal.filter(p => p._id !== id);

                    Swal.fire({
                        toast: true,
                        icon: 'success',
                        title: 'ØªÙ… Ø§Ù„Ø­Ø°Ù',
                        timer: 1500,
                        showConfirmButton: false
                    });
                } else {
                    Swal.fire('Ø®Ø·Ø£', 'ÙØ´Ù„ Ø§Ù„Ø­Ø°Ù', 'error');
                }
            } catch (e) {
                console.error(e);
            }
        }
      }
      // --- New Accounting & Finance System Logic ---

// 1. Navigation & Stats
function showAccTab(tabName) {
    // Hide all contents
    ['dashboard', 'expenses', 'employees', 'attendance', 'payroll'].forEach(t => {
        document.getElementById(`acc-tab-${t}`).classList.add('hidden');
        document.getElementById(`btn-tab-${t}`).classList.remove('active');
    });

    // Show selected
    document.getElementById(`acc-tab-${tabName}`).classList.remove('hidden');
    document.getElementById(`btn-tab-${tabName}`).classList.add('active');

    // Load data based on tab
    if (tabName === 'dashboard') loadAccStats();
    if (tabName === 'expenses') loadExpenses();
    if (tabName === 'employees') loadEmployees();
    if (tabName === 'attendance') {
        document.getElementById('acc-att-date').valueAsDate = new Date();
        loadAttendance();
    }
}

async function loadAccStats() {
    // 1. ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø³Ù†Ø© ÙˆØ§Ù„Ø´Ù‡Ø± Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…ØªÙŠÙ† ÙˆØ¯Ù…Ø¬Ù‡Ù…Ø§
    const yearInput = document.getElementById('acc-stats-year');
    const monthInput = document.getElementById('acc-stats-month');
    
    let year = yearInput ? yearInput.value : new Date().getFullYear();
    let month = monthInput ? monthInput.value : String(new Date().getMonth() + 1).padStart(2, '0');

    // ØªÙƒÙˆÙŠÙ† Ø§Ù„ØµÙŠØºØ© YYYY-MM
    let selectedMonth = `${year}-${month}`;

    try {
        // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø´Ù‡Ø± Ù„Ù„Ø³ÙŠØ±ÙØ±
        const res = await fetch(`/api/v1/accounting/stats?month=${selectedMonth}`, { headers: { Authorization: `Bearer ${token}` } });
        
        const contentType = res.headers.get("content-type");
        if (!res.ok || !contentType || !contentType.includes("application/json")) {
            console.warn("Accounting Stats: Server returned non-JSON response");
            return; 
        }

        const data = await res.json();
        if(data.status === 'success') {
            const d = data.data;
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø¨Ø§Ù„Ø£Ø±Ù‚Ø§Ù…
            document.getElementById('acc-stat-sales').innerText = (d.totalSales || 0).toLocaleString() + ' Ø¬.Ù…';
            // Ù†Ø¬Ù…Ø¹ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª ÙˆØ§Ù„Ø±ÙˆØ§ØªØ¨ Ù„Ù„Ø¹Ø±Ø¶
            const totalExp = (d.totalExpenses || 0) + (d.totalSalaries || 0);
            document.getElementById('acc-stat-expenses').innerText = totalExp.toLocaleString() + ' Ø¬.Ù…';
            
            const profit = (d.netProfit || 0);
            const profitEl = document.getElementById('acc-stat-profit');
            profitEl.innerText = profit.toLocaleString() + ' Ø¬.Ù…';
            
            // ØªÙ„ÙˆÙŠÙ† Ø§Ù„Ø±Ø¨Ø­ ÙˆØ§Ù„Ø®Ø³Ø§Ø±Ø©
            profitEl.style.color = profit >= 0 ? 'var(--success)' : 'var(--danger)';
            // ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø¤Ù‚ØªØ§Ù‹ Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…Ù‡Ø§ ÙÙŠ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© Ø¯ÙˆÙ† Ø·Ù„Ø¨ Ø§Ù„Ø³ÙŠØ±ÙØ± Ù…Ø±Ø© Ø£Ø®Ø±Ù‰
            window.currentStatsData = d; 
            window.currentStatsMonth = selectedMonth;
        }
    } catch(e) { console.error("Stats Error:", e); }
}

// Ø¯Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø© Ù„ØªÙˆÙ„ÙŠØ¯ ØªÙ‚Ø±ÙŠØ± PDF Ø§Ø­ØªØ±Ø§ÙÙŠ
function downloadFinancialReportPDF() {
    if (!window.currentStatsData) {
        Swal.fire('ØªÙ†Ø¨ÙŠÙ‡', 'ÙŠØ±Ø¬Ù‰ Ø§Ù†ØªØ¸Ø§Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø£ÙˆÙ„Ø§Ù‹', 'info');
        return;
    }

    const d = window.currentStatsData;
    const monthVal = window.currentStatsMonth;
    const [year, month] = monthVal.split('-');
    const monthsAr = ["ÙŠÙ†Ø§ÙŠØ±", "ÙØ¨Ø±Ø§ÙŠØ±", "Ù…Ø§Ø±Ø³", "Ø£Ø¨Ø±ÙŠÙ„", "Ù…Ø§ÙŠÙˆ", "ÙŠÙˆÙ†ÙŠÙˆ", "ÙŠÙˆÙ„ÙŠÙˆ", "Ø£ØºØ³Ø·Ø³", "Ø³Ø¨ØªÙ…Ø¨Ø±", "Ø£ÙƒØªÙˆØ¨Ø±", "Ù†ÙˆÙÙ…Ø¨Ø±", "Ø¯ÙŠØ³Ù…Ø¨Ø±"];
    const monthName = monthsAr[parseInt(month) - 1];
    
    const restName = document.getElementById("page-title").innerText.split("\n")[0] || "Ø§Ù„Ù…Ø·Ø¹Ù…";
    const totalExp = (d.totalExpenses || 0) + (d.totalSalaries || 0);

    // ØªØµÙ…ÙŠÙ… Ø§Ù„ØªÙ‚Ø±ÙŠØ±
    const element = document.createElement('div');
    element.innerHTML = `
      <div style="padding:30px; font-family:'Tajawal', sans-serif; direction:rtl; border:2px solid #4338ca;">
          <div style="text-align:center; border-bottom:2px solid #eee; padding-bottom:15px; margin-bottom:30px;">
              <h1 style="color:#4338ca; margin:0;">${restName}</h1>
              <h3 style="color:#666; margin:10px 0 0;">ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø£Ø¯Ø§Ø¡ Ø§Ù„Ù…Ø§Ù„ÙŠ</h3>
              <p style="margin:5px 0; color:#888;">Ø¹Ù† Ø´Ù‡Ø±: <strong>${monthName} ${year}</strong></p>
          </div>

          <div style="display:flex; justify-content:space-between; margin-bottom:30px;">
              <div style="background:#f0f9ff; padding:20px; border-radius:10px; width:30%; text-align:center; border:1px solid #bae6fd;">
                  <div style="color:#0369a1; font-size:14px; font-weight:bold;">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</div>
                  <div style="font-size:22px; font-weight:bold; margin-top:10px;">${(d.totalSales || 0).toLocaleString()} Ø¬.Ù…</div>
              </div>
              <div style="background:#fef2f2; padding:20px; border-radius:10px; width:30%; text-align:center; border:1px solid #fecaca;">
                  <div style="color:#b91c1c; font-size:14px; font-weight:bold;">Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª ÙˆØ§Ù„Ø±ÙˆØ§ØªØ¨</div>
                  <div style="font-size:22px; font-weight:bold; margin-top:10px; color:#dc2626;">${totalExp.toLocaleString()} Ø¬.Ù…</div>
              </div>
              <div style="background:#f0fdf4; padding:20px; border-radius:10px; width:30%; text-align:center; border:1px solid #bbf7d0;">
                  <div style="color:#15803d; font-size:14px; font-weight:bold;">ØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­</div>
                  <div style="font-size:22px; font-weight:bold; margin-top:10px; color:${d.netProfit >= 0 ? '#16a34a' : '#dc2626'};">${(d.netProfit || 0).toLocaleString()} Ø¬.Ù…</div>
              </div>
          </div>

          <table style="width:100%; border-collapse:collapse; margin-bottom:30px;">
              <tr style="background:#4338ca; color:white;">
                  <th style="padding:12px; border:1px solid #3730a3;">Ø§Ù„Ø¨Ù†Ø¯</th>
                  <th style="padding:12px; border:1px solid #3730a3;">Ø§Ù„Ù‚ÙŠÙ…Ø©</th>
              </tr>
              <tr>
                  <td style="padding:12px; border:1px solid #eee;">(+) Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„Ù…ÙƒØªÙ…Ù„Ø©</td>
                  <td style="padding:12px; border:1px solid #eee; font-weight:bold;">${(d.totalSales || 0).toLocaleString()} Ø¬.Ù…</td>
              </tr>
              <tr>
                  <td style="padding:12px; border:1px solid #eee;">(-) Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª Ø§Ù„ØªØ´ØºÙŠÙ„ÙŠØ©</td>
                  <td style="padding:12px; border:1px solid #eee; color:#dc2626;">${(d.totalExpenses || 0).toLocaleString()} Ø¬.Ù…</td>
              </tr>
              <tr>
                  <td style="padding:12px; border:1px solid #eee;">(-) Ø±ÙˆØ§ØªØ¨ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</td>
                  <td style="padding:12px; border:1px solid #eee; color:#dc2626;">${(d.totalSalaries || 0).toLocaleString()} Ø¬.Ù…</td>
              </tr>
              <tr style="background:#eee; font-weight:bold;">
                  <td style="padding:12px; border:1px solid #ccc;">(=) ØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­ / Ø§Ù„Ø®Ø³Ø§Ø±Ø©</td>
                  <td style="padding:12px; border:1px solid #ccc; color:${d.netProfit >= 0 ? '#16a34a' : '#dc2626'}; font-size:18px;">${(d.netProfit || 0).toLocaleString()} Ø¬.Ù…</td>
              </tr>
          </table>

          <div style="margin-top:50px; text-align:center; color:#999; font-size:12px; border-top:1px solid #eee; padding-top:10px;">
              ØªÙ… Ø¥ØµØ¯Ø§Ø± Ù‡Ø°Ø§ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø¢Ù„ÙŠØ§Ù‹ Ù…Ù† Ù†Ø¸Ø§Ù… Smart Menu Ø¨ØªØ§Ø±ÙŠØ® ${new Date().toLocaleDateString('ar-EG')}
          </div>
      </div>
    `;

    const opt = {
      margin: 10,
      filename: `Report_${year}_${month}.pdf`,
      image: { type: 'jpeg', quality: 0.98 },
      html2canvas: { scale: 2 },
      jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
    };

    html2pdf().set(opt).from(element).save();
}

// 2. Expenses Functions
async function openExpenseModal() {
    const { value: formValues } = await Swal.fire({
        title: 'ØªØ³Ø¬ÙŠÙ„ Ù…ØµØ±ÙˆÙ Ø¬Ø¯ÙŠØ¯',
        html:
            '<input id="swal-exp-title" class="swal2-input" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¨Ù†Ø¯ (Ù…Ø«Ø§Ù„: ÙØ§ØªÙˆØ±Ø© ÙƒÙ‡Ø±Ø¨Ø§Ø¡)">' +
            '<input id="swal-exp-amount" type="number" class="swal2-input" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº">' +
            '<select id="swal-exp-cat" class="swal2-input">' +
            '  <option value="supplies">Ø®Ø§Ù…Ø§Øª ÙˆÙ…Ø´ØªØ±ÙŠØ§Øª</option>' +
            '  <option value="bills">ÙÙˆØ§ØªÙŠØ± ÙˆÙ…Ø±Ø§ÙÙ‚</option>' +
            '  <option value="rent">Ø¥ÙŠØ¬Ø§Ø±</option>' +
            '  <option value="maintenance">ØµÙŠØ§Ù†Ø©</option>' +
            '  <option value="other">Ù†Ø«Ø±ÙŠØ§Øª ÙˆØ£Ø®Ø±Ù‰</option>' +
            '</select>' +
            '<input id="swal-exp-desc" class="swal2-input" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)">',
        focusConfirm: false,
        showCancelButton: true,
        confirmButtonText: 'Ø­ÙØ¸',
        preConfirm: () => {
            return {
                title: document.getElementById('swal-exp-title').value,
                amount: document.getElementById('swal-exp-amount').value,
                category: document.getElementById('swal-exp-cat').value,
                description: document.getElementById('swal-exp-desc').value
            }
        }
    });

    if (formValues) {
        if(!formValues.title || !formValues.amount) return Swal.fire('Ø®Ø·Ø£', 'Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ù„Ù…Ø¨Ù„Øº Ù…Ø·Ù„ÙˆØ¨ÙŠÙ†', 'error');
        
        try {
            await fetch('/api/v1/accounting/expenses', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${token}` },
                body: JSON.stringify(formValues)
            });
            Swal.fire({ toast: true, icon: 'success', title: 'ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…ØµØ±ÙˆÙ' });
            loadExpenses();
            loadAccStats(); // Update Dashboard
        } catch(e) { Swal.fire('Ø®Ø·Ø£', 'ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸', 'error'); }
    }
}

async function loadExpenses() {
    try {
        const res = await fetch('/api/v1/accounting/expenses', { headers: { Authorization: `Bearer ${token}` } });
        const data = await res.json();
        
        const tbody = document.getElementById('acc-expenses-list');
        if (!tbody) return;
        tbody.innerHTML = '';
        
        // âœ… Ø¥ØµÙ„Ø§Ø­: Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù‚Ø¨Ù„ Ø§Ø³ØªØ®Ø¯Ø§Ù…Ù‡Ø§
        if (data.status === 'success' && Array.isArray(data.data)) {
            if(data.data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ØµØ±ÙˆÙØ§Øª Ù…Ø³Ø¬Ù„Ø©</td></tr>';
                return;
            }

            const catMap = { supplies: 'Ø®Ø§Ù…Ø§Øª', bills: 'ÙÙˆØ§ØªÙŠØ±', rent: 'Ø¥ÙŠØ¬Ø§Ø±', maintenance: 'ØµÙŠØ§Ù†Ø©', other: 'Ø£Ø®Ø±Ù‰' };

            data.data.forEach(ex => {
                tbody.innerHTML += `
                    <tr>
                        <td>${new Date(ex.date).toLocaleDateString('ar-EG')}</td>
                        <td style="font-weight:bold;">${ex.title}</td>
                        <td><span class="badge" style="background:#f1f5f9; color:#64748b;">${catMap[ex.category] || ex.category}</span></td>
                        <td style="color:var(--danger); font-weight:bold;">${ex.amount}</td>
                        <td>${ex.description || '-'}</td>
                        <td><button onclick="deleteExpense('${ex._id}')" style="color:red; background:none; border:none; cursor:pointer;"><i class="fas fa-trash"></i></button></td>
                    </tr>
                `;
            });
        } else {
            console.error("API Error:", data);
            tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; color:red;">ÙØ´Ù„ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</td></tr>';
        }
    } catch(e) { console.error("Load Expenses Error:", e); }
}

async function deleteExpense(id) {
    if(confirm('Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…ØµØ±ÙˆÙØŸ')) {
        await fetch(`/api/v1/accounting/expenses/${id}`, { method: 'DELETE', headers: { Authorization: `Bearer ${token}` } });
        loadExpenses();
    }
}

// 3. Employees & Loans

async function giveAdvance(id, name) {
    const { value: amount } = await Swal.fire({
        title: `ØµØ±Ù Ø³Ù„ÙØ© Ù„Ù€: ${name}`,
        input: 'number',
        inputLabel: 'Ù‚ÙŠÙ…Ø© Ø§Ù„Ø³Ù„ÙØ©',
        inputPlaceholder: 'Ø£Ø¯Ø®Ù„ Ø§Ù„Ù…Ø¨Ù„Øº',
        showCancelButton: true,
        confirmButtonText: 'ØªØ£ÙƒÙŠØ¯ Ø§Ù„ØµØ±Ù',
        confirmButtonColor: '#f97316'
    });

    if (amount) {
        try {
            Swal.showLoading();
            await fetch(`/api/v1/accounting/employees/${id}/advance`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${token}` },
                body: JSON.stringify({ amount })
            });
            
            Swal.fire({ toast: true, icon: 'success', title: 'ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø³Ù„ÙØ© Ø¨Ù†Ø¬Ø§Ø­' });
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙˆØ±Ø§Ù‹ Ø¨Ø¯ÙˆÙ† Ø±ÙŠÙØ±ÙŠØ´ ÙƒØ§Ù…Ù„ Ù„Ù„ØµÙØ­Ø©
            await loadEmployees(); 
            
        } catch(e) { Swal.fire('Ø®Ø·Ø£', 'ÙØ´Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©', 'error'); }
    }
}
// 4. Payroll Logic (Enhanced)
// Ø¯Ø§Ù„Ø© Ø¹Ø±Ø¶ Ù…Ø³ÙˆØ¯Ø© Ø§Ù„Ø±ÙˆØ§ØªØ¨ (Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©)
// Ø¯Ø§Ù„Ø© Ø°ÙƒÙŠØ©: ØªØ¬Ù„Ø¨ Ø§Ù„Ù…Ø­ÙÙˆØ¸ Ø£ÙˆÙ„Ø§Ù‹ØŒ ÙˆØ¥Ù† Ù„Ù… ØªØ¬Ø¯ ØªØ­Ø³Ø¨ Ø§Ù„Ø¬Ø¯ÙŠØ¯
// ğŸŸ¢ Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ù…Ø·ÙˆØ±Ø©: ØªØ­Ø¶ÙŠØ± ÙˆØ¹Ø±Ø¶ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø±ÙˆØ§ØªØ¨ (Ø°ÙƒÙŠ: Ø¬Ù„Ø¨ Ø§Ù„Ù‚Ø¯ÙŠÙ… Ø£Ùˆ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯)
// ğŸŸ¢ Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ù…Ø·ÙˆØ±Ø©: ØªØ­Ø¶ÙŠØ± ÙˆØ¹Ø±Ø¶ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø±ÙˆØ§ØªØ¨ (Ø°ÙƒÙŠ: Ø¬Ù„Ø¨ Ø§Ù„Ù‚Ø¯ÙŠÙ… Ø£Ùˆ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯)
      async function preparePayrollUI() {
          const month = document.getElementById("acc-pay-month").value;
          const rId = document.getElementById("restaurant-id").value;
          if(!month) return Swal.fire("ØªÙ†Ø¨ÙŠÙ‡", "Ø§Ø®ØªØ± Ø§Ù„Ø´Ù‡Ø± Ø£ÙˆÙ„Ø§Ù‹", "warning");

          Swal.fire({title: 'Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...', didOpen: () => Swal.showLoading()});

          try {
              let payrollData = [];
              let isMonthApproved = false;

              // 1. Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰: Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­ÙÙˆØ¸Ø© Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (GET)
              // Ù‡Ø°Ø§ ÙŠØ¶Ù…Ù† Ø£Ù† Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø§Ù„ÙŠØ¯ÙˆÙŠØ© Ø§Ù„ØªÙŠ Ø­ÙØ¸ØªÙ‡Ø§ Ù„Ø§ ØªØ¶ÙŠØ¹
              const getRes = await fetch(`/api/v1/accounting/payroll?month=${month}&restaurantId=${rId}`, {
                  headers: { Authorization: `Bearer ${token}` }
              });
              const getResult = await getRes.json();

              if (getResult.status === "success" && getResult.data.length > 0) {
                  payrollData = getResult.data;
                  isMonthApproved = payrollData[0].status === 'Approved';
                  Swal.close();
              } else {
                  // 2. Ø¥Ø°Ø§ Ù„Ù… Ù†Ø¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­ÙÙˆØ¸Ø©ØŒ Ù†Ù‚ÙˆÙ… Ø¨Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø³ÙˆØ¯Ø© Ù„Ø£ÙˆÙ„ Ù…Ø±Ø© (POST)
                  const genRes = await fetch("/api/v1/accounting/generate-payroll", {
                      method: "POST",
                      headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${token}` },
                      body: JSON.stringify({ month, restaurantId: rId, isPreview: true })
                  });
                  const genResult = await genRes.json();
                  Swal.close();

                  if(genResult.status === "success") {
                      payrollData = genResult.data;
                  } else {
                      return Swal.fire("Ø®Ø·Ø£", genResult.message, "error");
                  }
              }

              // Ø±Ø³Ù… Ø§Ù„Ø¬Ø¯ÙˆÙ„
              const tbody = document.getElementById("acc-pay-list");
              tbody.innerHTML = "";
              
              const disabledAttr = isMonthApproved ? 'disabled style="background:#eee; color:#777; cursor:not-allowed;"' : '';

              if (payrollData.length === 0) {
                  tbody.innerHTML = '<tr><td colspan="8" style="text-align:center; padding:20px;">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…ÙˆØ¸ÙÙŠÙ† Ø£Ùˆ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±</td></tr>';
              }

              payrollData.forEach(p => {
                // Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ø®Ø·Ø£: Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ù…ÙˆØ¸Ù Ø£ÙˆÙ„Ø§Ù‹
                  const empName = p.employee ? p.employee.name : 'Ù…ÙˆØ¸Ù Ù…Ø­Ø°ÙˆÙ';
                  const empJob = p.employee ? (p.employee.jobTitle || 'Ù…ÙˆØ¸Ù') : '--';

                  const printData = encodeURIComponent(JSON.stringify({
                      name: empName,
                      job: empJob,
                      base: p.baseAmount,
                      bonuses: p.bonuses,
                      deductions: p.deductions,
                      loans: p.loansDeducted,
                      net: p.totalSalary,
                      month: p.month
                  }));

                  tbody.innerHTML += `
                      <tr id="pay-row-${p._id}" class="payroll-row" data-base="${p.baseAmount}" data-ot="${p.overtimeAmount}" style="background: ${isMonthApproved ? '#fcfcfc' : 'white'}; transition:0.3s;">
                          <td>
                              <div style="font-weight:bold; color:var(--primary);">${p.employee ? p.employee.name : 'Ù…ÙˆØ¸Ù Ù…Ø­Ø°ÙˆÙ'}</div>
                              <small style="color:var(--secondary);">${p.employee ? (p.employee.jobTitle || 'Ù…ÙˆØ¸Ù') : '--'}</small>
                              ${isMonthApproved ? '<span class="badge" style="background:#10b981; color:white; font-size:10px;">Ù…Ø¹ØªÙ…Ø¯</span>' : ''}
                          </td>
                          <td style="font-weight:bold;">${p.baseAmount}</td>
                          <td style="color:green;">+${p.overtimeAmount}</td>
                          
                          <td>
                            <input type="number" class="modern-input p-bonus" value="${p.bonuses}" 
                                   style="width:80px; padding:5px; text-align:center; border:1px dashed #3b82f6;"
                                   onkeyup="clientSideCalc('${p._id}')" 
                                   onchange="updatePayrollRow('${p._id}', this, 'bonuses')" 
                                   ${disabledAttr}>
                          </td>
                          <td>
                            <input type="number" class="modern-input p-deduct" value="${p.deductions}" 
                                   style="width:80px; padding:5px; text-align:center; border:1px dashed #ef4444;"
                                   onkeyup="clientSideCalc('${p._id}')" 
                                   onchange="updatePayrollRow('${p._id}', this, 'deductions')"
                                   ${disabledAttr}>
                          </td>
                          <td>
                            <input type="number" class="modern-input p-loan" value="${p.loansDeducted}" 
                                   style="width:80px; padding:5px; text-align:center; border:1px dashed #f97316;"
                                   onkeyup="clientSideCalc('${p._id}')" 
                                   onchange="updatePayrollRow('${p._id}', this, 'loansDeducted')"
                                   ${disabledAttr}>
                          </td>

                          <td style="font-weight:800; font-size:17px; color:var(--success);" id="net-${p._id}">
                            ${p.totalSalary} Ø¬.Ù… 
                            <i id="status-${p._id}" style="margin-right:5px; font-size:12px;"></i>
                          </td>
                          
                          <td>
                              <button class="btn btn-outline" onclick="downloadPayslipPDF('${printData}')" title="Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ù‚Ø³ÙŠÙ…Ø©" style="padding:5px 10px; border-color:#4338ca; color:#4338ca;">
                                  <i class="fas fa-print"></i>
                              </button>
                          </td>
                      </tr>
                  `;
              });
              
              document.getElementById("payroll-preview-area").classList.remove("hidden");
              
              // Ø§Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø²Ø± Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯
              const approveBtn = document.querySelector("#payroll-preview-area .btn-success");
              const existingMsg = document.getElementById('approved-msg');
              if(existingMsg) existingMsg.remove();

              if(isMonthApproved) {
                  if(approveBtn) approveBtn.style.display = 'none';
                  const msg = document.createElement('div');
                  msg.id = 'approved-msg';
                  msg.innerHTML = '<div style="text-align:center; padding:15px; background:#dcfce7; color:#166534; border-radius:10px; margin-top:15px; font-weight:bold;"><i class="fas fa-check-circle"></i> ØªÙ… Ø§Ø¹ØªÙ…Ø§Ø¯ Ø±ÙˆØ§ØªØ¨ Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø± Ø¨Ø§Ù„ÙØ¹Ù„.</div>';
                  document.getElementById("payroll-preview-area").appendChild(msg);
              } else {
                  if(approveBtn) approveBtn.style.display = 'block';
              }

              document.getElementById('payroll-preview-area').scrollIntoView({ behavior: 'smooth' });

          } catch(e) {
              console.error(e);
              Swal.fire("Ø®Ø·Ø£", "ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„", "error");
          }
      }
      function clientSideCalc(id) {
          const row = document.getElementById(`pay-row-${id}`);
          const base = parseFloat(row.getAttribute('data-base')) || 0;
          const ot = parseFloat(row.getAttribute('data-ot')) || 0;
          
          const bonus = parseFloat(row.querySelector('.p-bonus').value) || 0;
          const deduct = parseFloat(row.querySelector('.p-deduct').value) || 0;
          const loan = parseFloat(row.querySelector('.p-loan').value) || 0;

          // Ø§Ù„Ù…Ø¹Ø§Ø¯Ù„Ø©: (Ø£Ø³Ø§Ø³ÙŠ + Ø¥Ø¶Ø§ÙÙŠ + Ù…ÙƒØ§ÙØ¢Øª) - (Ø®ØµÙˆÙ…Ø§Øª + Ø³Ù„Ù)
          let net = (base + ot + bonus) - (deduct + loan);
          if(net < 0) net = 0;

          // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø±Ø¶ ÙÙˆØ±Ø§Ù‹ Ù…Ø¹ Ø§Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ù…Ø¹Ø±Ù Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø© Ù„ÙƒÙŠ ØªØ¬Ø¯Ù‡Ø§ Ø¯Ø§Ù„Ø© Ø§Ù„Ø­ÙØ¸
          document.getElementById(`net-${id}`).innerHTML = `${net} Ø¬.Ù… <i id="status-${id}" class="fas fa-pen" style="margin-right:5px; font-size:12px; color:#aaa;" title="ØªÙ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„"></i>`;
      }

function calculateClientSideTotal() {
    document.querySelectorAll('.payroll-row').forEach(row => {
        const base = parseFloat(row.getAttribute('data-base')) || 0;
        
        // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¥Ø¶Ø§ÙÙŠ Ø§Ù„Ù…Ø­Ø³ÙˆØ¨Ø© (Ù…Ù† Ø§Ù„Ù†Øµ Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ø§Ù„Ø®Ù„ÙŠØ©)
        const otText = row.children[2].querySelector('div:last-child').innerText.replace('+', '');
        const otVal = parseFloat(otText) || 0;

        const bonus = parseFloat(row.querySelector('.p-bonus').value) || 0;
        const deduct = parseFloat(row.querySelector('.p-deduct').value) || 0;
        const loan = parseFloat(row.querySelector('.p-loan').value) || 0;

        const net = base + otVal + bonus - deduct - loan;
        row.querySelector('.p-net').innerText = net + " Ø¬.Ù…";
    });
}
function calculatePreviewTotals() {
    // This is a simplified frontend preview. Real calc happens on backend.
    // Here we just update the UI for UX purposes.
    document.querySelectorAll('.payroll-row').forEach(row => {
        // Simple logic: Base + Bonus - Deduct - Loan (Approx)
        // Note: Real overtime calculation requires backend attendance data.
        // We will just show "Calculating..." or user input effect.
        const netCell = row.querySelector('.p-net');
        netCell.innerText = "Ø³ÙŠØªÙ… Ø§Ù„Ø­Ø³Ø§Ø¨"; // Placeholder until generated
    });
}

// âœ… Ø¯Ø§Ù„Ø© Ø§Ø¹ØªÙ…Ø§Ø¯ Ø§Ù„Ø±ÙˆØ§ØªØ¨ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© (ØªØ®ØµÙ… Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª ÙˆØ§Ù„Ø³Ù„Ù)
      async function confirmPayrollGeneration() {
          const month = document.getElementById("acc-pay-month").value;
          const rId = document.getElementById("restaurant-id").value;

          const result = await Swal.fire({
              title: 'Ø§Ø¹ØªÙ…Ø§Ø¯ Ø§Ù„Ø±ÙˆØ§ØªØ¨ØŸ',
              text: "Ø³ÙŠØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø±ÙˆØ§ØªØ¨ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© ÙƒÙ…ØµØ±ÙˆÙØ§ØªØŒ ÙˆØ®ØµÙ… Ø§Ù„Ø³Ù„Ù Ù…Ù† Ø±ØµÙŠØ¯ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†ØŒ ÙˆÙ„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ù‡Ø°Ù‡ Ø§Ù„Ø®Ø·ÙˆØ©.",
              icon: 'warning',
              showCancelButton: true,
              confirmButtonText: 'Ù†Ø¹Ù…ØŒ Ø§Ø¹ØªÙ…Ø¯ ÙˆØ§ØµØ±Ù',
              cancelButtonText: 'Ø¥Ù„ØºØ§Ø¡'
          });

          if (result.isConfirmed) {
              Swal.fire({title: 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©...', didOpen: ()=> Swal.showLoading()});
              try {
                  const res = await fetch("/api/v1/accounting/approve-payroll", {
                      method: "POST",
                      headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${token}` },
                      body: JSON.stringify({ month, restaurantId: rId })
                  });
                  const data = await res.json();
                  
                  if (data.status === "success") {
                      Swal.fire("ØªÙ… Ø¨Ù†Ø¬Ø§Ø­", data.message, "success");
                      preparePayrollUI(); // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¬Ø¯ÙˆÙ„
                  } else {
                      Swal.fire("Ø®Ø·Ø£", data.message, "error");
                  }
              } catch (e) {
                  console.error(e);
                  Swal.fire("Ø®Ø·Ø£", "ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„", "error");
              }
          }
      }

      // âœ… Ø¯Ø§Ù„Ø© ØªØ­Ù…ÙŠÙ„ PDF Ù„Ù‚Ø³ÙŠÙ…Ø© Ø§Ù„Ø±Ø§ØªØ¨ (Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† Ø§Ù„Ø¹Ø±Ø¶ ÙÙ‚Ø·)
 // âœ… Ø¯Ø§Ù„Ø© ØªØ­Ù…ÙŠÙ„ PDF Ù„Ù‚Ø³ÙŠÙ…Ø© Ø§Ù„Ø±Ø§ØªØ¨ (ØªÙ… Ø§Ù„ØªØµØ­ÙŠØ­ Ù„ØªÙˆØ§ÙÙ‚ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©)
// âœ… Ø¯Ø§Ù„Ø© ØªØ­Ù…ÙŠÙ„ PDF Ù„Ù‚Ø³ÙŠÙ…Ø© Ø§Ù„Ø±Ø§ØªØ¨ (ØªÙ… Ø¥ØµÙ„Ø§Ø­ Ø¸Ù‡ÙˆØ± Ø§Ù„Ø£Ø±Ù‚Ø§Ù…)
// âœ… Ø¯Ø§Ù„Ø© ØªØ­Ù…ÙŠÙ„ PDF Ù„Ù‚Ø³ÙŠÙ…Ø© Ø§Ù„Ø±Ø§ØªØ¨ (ØªÙ… Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø¨Ù€ Flexbox Ù„Ø¶Ù…Ø§Ù† Ø¸Ù‡ÙˆØ± Ø§Ù„Ø£Ø±Ù‚Ø§Ù…)
      function downloadPayslipPDF(pDataEncoded) {
          const p = JSON.parse(decodeURIComponent(pDataEncoded));
          
          // 1. Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ù‚ÙŠÙ…
          const name = p.name || p.employee?.name || 'Ù…ÙˆØ¸Ù';
          const job = p.job || p.employee?.jobTitle || 'Ù…ÙˆØ¸Ù';
          const monthVal = p.month || (document.getElementById('acc-pay-month') ? document.getElementById('acc-pay-month').value : '-');
          
          const base = Number(p.base || p.baseAmount || 0).toLocaleString();
          const overtime = Number(p.overtime || p.overtimeAmount || 0).toLocaleString();
          const bonuses = Number(p.bonuses || 0).toLocaleString();
          const deductions = Number(p.deductions || 0).toLocaleString();
          const loans = Number(p.loans || p.loansDeducted || 0).toLocaleString();
          const net = Number(p.net || p.totalSalary || 0).toLocaleString();

          const restName = document.getElementById("page-title").innerText.split("\n")[0] || "Smart Menu";
          const date = new Date().toLocaleDateString('ar-EG');

          // 2. ØªØµÙ…ÙŠÙ… Ø§Ù„Ù‚Ø³ÙŠÙ…Ø© (Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Flexbox Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† Table Ù„Ù„Ø£Ø±Ù‚Ø§Ù…)
          const element = document.createElement('div');
          element.innerHTML = `
            <div style="padding:25px; font-family:'Tajawal', sans-serif; direction:rtl; border:2px solid #333; max-width:550px; margin:auto; background:white; color:#000;">
                
                <div style="text-align:center; border-bottom:2px solid #eee; padding-bottom:15px; margin-bottom:20px;">
                    <h2 style="margin:0; color:#4338ca; font-size:24px;">${restName}</h2>
                    <p style="margin:5px 0; color:#666; font-size:16px;">Ù‚Ø³ÙŠÙ…Ø© Ø±Ø§ØªØ¨ | Pay Slip</p>
                    <div style="background:#f3f4f6; display:inline-block; padding:5px 15px; border-radius:15px; margin-top:5px; font-size:14px; font-weight:bold;">
                        Ø¹Ù† Ø´Ù‡Ø±: ${monthVal}
                    </div>
                </div>
                
                <div style="background:#f8fafc; border:1px solid #e2e8f0; border-radius:8px; padding:15px; margin-bottom:20px;">
                    <div style="display:flex; justify-content:space-between; margin-bottom:8px;">
                        <span style="color:#64748b;">Ø§Ù„Ù…ÙˆØ¸Ù:</span>
                        <span style="font-weight:bold;">${name}</span>
                    </div>
                    <div style="display:flex; justify-content:space-between;">
                        <span style="color:#64748b;">Ø§Ù„ÙˆØ¸ÙŠÙØ©:</span>
                        <span style="font-weight:bold;">${job}</span>
                    </div>
                </div>
                
                <h3 style="font-size:16px; border-bottom:1px solid #ddd; padding-bottom:10px; margin-bottom:15px;">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø±Ø§ØªØ¨</h3>
                
                <div style="display:flex; flex-direction:column; gap:10px;">
                    
                    <div style="display:flex; justify-content:space-between; align-items:center; padding-bottom:8px; border-bottom:1px dashed #eee;">
                        <span style="font-weight:bold;">Ø§Ù„Ø±Ø§ØªØ¨ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ</span>
                        <span style="font-family:sans-serif; font-weight:bold;">${base} Ø¬.Ù…</span>
                    </div>

                    ${p.overtime > 0 ? `
                    <div style="display:flex; justify-content:space-between; align-items:center; padding-bottom:8px; border-bottom:1px dashed #eee; color:green;">
                        <span>+ Ø¥Ø¶Ø§ÙÙŠ</span>
                        <span style="font-family:sans-serif; direction:ltr;">${overtime} Ø¬.Ù…</span>
                    </div>` : ''}

                    ${p.bonuses > 0 ? `
                    <div style="display:flex; justify-content:space-between; align-items:center; padding-bottom:8px; border-bottom:1px dashed #eee; color:#2563eb;">
                        <span>+ Ù…ÙƒØ§ÙØ¢Øª</span>
                        <span style="font-family:sans-serif; direction:ltr;">${bonuses} Ø¬.Ù…</span>
                    </div>` : ''}

                    ${p.deductions > 0 ? `
                    <div style="display:flex; justify-content:space-between; align-items:center; padding-bottom:8px; border-bottom:1px dashed #eee; color:#dc2626;">
                        <span>- Ø¬Ø²Ø§Ø¡Ø§Øª/Ø®ØµÙˆÙ…Ø§Øª</span>
                        <span style="font-family:sans-serif; direction:ltr;">${deductions} Ø¬.Ù…</span>
                    </div>` : ''}

                    ${p.loans > 0 ? `
                    <div style="display:flex; justify-content:space-between; align-items:center; padding-bottom:8px; border-bottom:1px dashed #eee; color:#d97706;">
                        <span>- Ø³Ø¯Ø§Ø¯ Ø³Ù„ÙØ©</span>
                        <span style="font-family:sans-serif; direction:ltr;">${loans} Ø¬.Ù…</span>
                    </div>` : ''}

                </div>
                
                <div style="margin-top:25px; background:#1e293b; color:white; padding:15px; border-radius:12px; display:flex; justify-content:space-between; align-items:center;">
                    <span style="font-size:16px;">ØµØ§ÙÙŠ Ø§Ù„Ø±Ø§ØªØ¨:</span>
                    <span style="font-size:22px; font-weight:bold; font-family:sans-serif;">${net} Ø¬.Ù…</span>
                </div>
                
                <div style="margin-top:50px; display:flex; justify-content:space-between; font-size:13px; color:#555;">
                    <div style="text-align:center; width:40%; border-top:1px solid #ccc; padding-top:10px;">ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„Ù…Ø¯ÙŠØ±</div>
                    <div style="text-align:center; width:40%; border-top:1px solid #ccc; padding-top:10px;">ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„Ù…Ø³ØªÙ„Ù…</div>
                </div>
                
                <div style="text-align:center; margin-top:20px; font-size:11px; color:#aaa;">
                    ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥ØµØ¯Ø§Ø±: ${date}
                </div>
            </div>
          `;

          const opt = {
            margin: 10,
            filename: `Payslip_${name}_${monthVal}.pdf`,
            image: { type: 'jpeg', quality: 0.98 },
            html2canvas: { scale: 2, useCORS: true },
            jsPDF: { unit: 'mm', format: 'a5', orientation: 'portrait' }
          };

          // Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø¨Ø§Ø´Ø±
          html2pdf().set(opt).from(element).save();
      }

      async function downloadEmployeeHistory(empId, empName) {
          const rId = document.getElementById("restaurant-id").value;
          
          Swal.fire({title: 'Ø¬Ø§Ø±ÙŠ Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„ØªÙ‚Ø±ÙŠØ±...', didOpen: ()=> Swal.showLoading()});
          
          try {
              // Ø¬Ù„Ø¨ ÙƒÙ„ Ø§Ù„Ø±ÙˆØ§ØªØ¨ Ø§Ù„Ø®Ø§ØµØ© Ø¨Ø§Ù„Ù…ÙˆØ¸Ù
              const res = await fetch(`/api/v1/accounting/payroll?restaurantId=${rId}&employeeId=${empId}`, {
                  headers: { Authorization: `Bearer ${token}` }
              });
              const result = await res.json();
              
              if(result.status === 'success') {
                  const history = result.data;
                  
                  // Ø¨Ù†Ø§Ø¡ Ù…Ø­ØªÙˆÙ‰ Ø§Ù„ØªÙ‚Ø±ÙŠØ±
                  let rowsHtml = '';
                  let totalPaid = 0;
                  
                  history.forEach(h => {
                      totalPaid += h.totalSalary;
                      rowsHtml += `
                        <tr>
                            <td style="padding:8px; border:1px solid #ccc;">${h.month}</td>
                            <td style="padding:8px; border:1px solid #ccc;">${h.baseAmount}</td>
                            <td style="padding:8px; border:1px solid #ccc; color:green;">${h.overtimeAmount + h.bonuses}</td>
                            <td style="padding:8px; border:1px solid #ccc; color:red;">${h.deductions}</td>
                            <td style="padding:8px; border:1px solid #ccc; color:orange;">${h.loansDeducted}</td>
                            <td style="padding:8px; border:1px solid #ccc; font-weight:bold;">${h.totalSalary}</td>
                            <td style="padding:8px; border:1px solid #ccc;">${h.status === 'Approved' ? 'Ù…Ø¹ØªÙ…Ø¯' : 'Ù…Ø³ÙˆØ¯Ø©'}</td>
                        </tr>
                      `;
                  });

                  const element = document.createElement('div');
                  element.innerHTML = `
                    <div style="padding:20px; font-family:'Tajawal', sans-serif; direction:rtl;">
                        <h2 style="text-align:center;">Ø³Ø¬Ù„ Ø±ÙˆØ§ØªØ¨ Ù…ÙˆØ¸Ù</h2>
                        <h3 style="text-align:center; color:#4338ca;">${empName}</h3>
                        <hr/>
                        <table style="width:100%; border-collapse:collapse; margin-top:20px; font-size:12px;">
                            <thead style="background:#eee;">
                                <tr>
                                    <th style="padding:8px; border:1px solid #ccc;">Ø§Ù„Ø´Ù‡Ø±</th>
                                    <th style="padding:8px; border:1px solid #ccc;">Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ</th>
                                    <th style="padding:8px; border:1px solid #ccc;">Ø¥Ø¶Ø§ÙÙŠ/Ù…ÙƒØ§ÙØ£Ø©</th>
                                    <th style="padding:8px; border:1px solid #ccc;">Ø®ØµÙˆÙ…Ø§Øª</th>
                                    <th style="padding:8px; border:1px solid #ccc;">Ø³Ù„Ù</th>
                                    <th style="padding:8px; border:1px solid #ccc;">Ø§Ù„ØµØ§ÙÙŠ</th>
                                    <th style="padding:8px; border:1px solid #ccc;">Ø§Ù„Ø­Ø§Ù„Ø©</th>
                                </tr>
                            </thead>
                            <tbody>${rowsHtml}</tbody>
                        </table>
                        <h4 style="text-align:left; margin-top:20px;">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª: ${totalPaid} Ø¬.Ù…</h4>
                    </div>
                  `;

                  const opt = {
                    margin: 10,
                    filename: `History_${empName}.pdf`,
                    image: { type: 'jpeg', quality: 0.98 },
                    html2canvas: { scale: 2 },
                    jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
                  };

                  Swal.close();
                  html2pdf().set(opt).from(element).save();

              } else {
                  Swal.fire("ØªÙ†Ø¨ÙŠÙ‡", "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª", "info");
              }
          } catch(e) {
              console.error(e);
              Swal.fire("Ø®Ø·Ø£", "ÙØ´Ù„ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª", "error");
          }
      }
      
      async function giveAdvance(empId, empName) {
          const { value: amount } = await Swal.fire({
              title: `ØµØ±Ù Ø³Ù„ÙØ© Ù„Ù€ ${empName}`,
              input: 'number',
              inputLabel: 'Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø¨Ù„Øº',
              inputPlaceholder: 'Ø£Ø¯Ø®Ù„ Ø§Ù„Ù…Ø¨Ù„Øº...',
              showCancelButton: true,
              confirmButtonText: 'ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø³Ù„ÙØ©',
              cancelButtonText: 'Ø¥Ù„ØºØ§Ø¡'
          });

          if (amount) {
              const rId = document.getElementById("restaurant-id").value;
              try {
                  // Ù†Ø³Ø¬Ù„Ù‡Ø§ ÙƒÙ…ØµØ±ÙˆÙ Ù…Ù† Ù†ÙˆØ¹ 'salary_advance'
                  const res = await fetch("/api/v1/accounting/expenses", { // ØªØ£ÙƒØ¯ Ø£Ù† Ù„Ø¯ÙŠÙƒ Ù…Ø³Ø§Ø± Ù„Ù„Ù…ØµØ±ÙˆÙØ§ØªØŒ Ø³Ù†Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„Ø¹Ø§Ù…
                      method: "POST",
                      headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${token}` },
                      body: JSON.stringify({
                          restaurantId: rId,
                          title: `Ø³Ù„ÙØ© Ù…ÙˆØ¸Ù: ${empName}`,
                          amount: amount,
                          category: 'salary_advance',
                          employee: empId, // Ù†Ø±Ø¨Ø·Ù‡Ø§ Ø¨Ø§Ù„Ù…ÙˆØ¸Ù
                          description: 'Ø³Ù„ÙØ© ØªØ®ØµÙ… Ù…Ù† Ø§Ù„Ø±Ø§ØªØ¨ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹'
                      })
                  });
                  
                  if(res.ok) {
                      Swal.fire('ØªÙ…!', 'ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø³Ù„ÙØ© ÙˆØ³ÙŠØªÙ… Ø®ØµÙ…Ù‡Ø§ Ù…Ù† Ø§Ù„Ø±Ø§ØªØ¨ Ø§Ù„Ù‚Ø§Ø¯Ù… ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹.', 'success');
                      // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ Ø¥Ø°Ø§ Ù„Ø²Ù… Ø§Ù„Ø£Ù…Ø±
                  } else {
                      Swal.fire('Ø®Ø·Ø£', 'Ø­Ø¯Ø« Ù…Ø´ÙƒÙ„Ø© Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ³Ø¬ÙŠÙ„', 'error');
                  }
              } catch(e) { console.error(e); }
          }
      }

      // Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† Ù…Ø¹ Ø²Ø± Ø§Ù„Ø³Ù„ÙØ© (Ø§Ø³ØªØ¨Ø¯Ù„ Ø¯Ø§Ù„Ø© Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…ÙˆØ¬ÙˆØ¯Ø© Ø£Ùˆ Ø§Ø³ØªØ®Ø¯Ù… Ù‡Ø°Ù‡)
      function renderEmployeesWithActions(employees) {
          const tbody = document.getElementById("acc-emp-list");
          tbody.innerHTML = "";
          employees.forEach(emp => {
              tbody.innerHTML += `
                  <tr>
                      <td>${emp.name}</td>
                      <td>${emp.jobTitle || '--'}</td>
                      <td>${emp.salaryType === 'monthly' ? 'Ø´Ù‡Ø±ÙŠ' : 'ÙŠÙˆÙ…ÙŠØ©'}</td>
                      <td>${emp.baseSalary} Ø¬.Ù…</td>
                      <td>${emp.loanBalance || 0}</td>
                      <td>
                          <button class="btn btn-outline" style="padding:5px 10px; font-size:12px; color:orange; border-color:orange;" onclick="giveAdvance('${emp._id}', '${emp.name}')">
                              <i class="fas fa-hand-holding-usd"></i> ØµØ±Ù Ø³Ù„ÙØ©
                          </button>
                          <button class="btn btn-outline" style="padding:5px 10px; font-size:12px; color:red; border-color:red;" onclick="deleteEmployee('${emp._id}')">
                              <i class="fas fa-trash"></i>
                          </button>
                      </td>
                  </tr>
              `;
          });
      }
    </script>

    <div class="mobile-bottom-nav">
        <div class="nav-icon active" onclick="switchView('orders')" id="mob-nav-orders">
            <i class="fas fa-bell"></i>
            <span>Ø§Ù„Ø·Ù„Ø¨Ø§Øª</span>
            <span id="mob-badge" class="hidden" style="position:absolute; top:5px; right:30%; width:8px; height:8px; background:red; border-radius:50%;"></span>
        </div>
        <div class="nav-icon" onclick="switchView('products')" id="mob-nav-products">
            <i class="fas fa-hamburger"></i>
            <span>Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</span>
        </div>
        <div class="nav-icon" onclick="switchView('categories')" id="mob-nav-categories">
            <i class="fas fa-layer-group"></i>
            <span>Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</span>
        </div>
        <div class="nav-icon hidden" onclick="switchView('stock')" id="mob-nav-stock">
            <i class="fas fa-boxes"></i>
            <span>Ø§Ù„Ù…Ø®Ø²Ù†</span>
        </div>
        <div class="nav-icon" onclick="switchView('settings')" id="mob-nav-settings">
            <i class="fas fa-cog"></i>
            <span>Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</span>
        </div>
        <div class="nav-icon" onclick="toggleSidebar()">
            <i class="fas fa-bars"></i>
            <span>Ø§Ù„Ù…Ø²ÙŠØ¯</span>
        </div>
</div>
<script>
  function checkTrialWarning(warningData) {
    if (!warningData) return;

    const warningDiv = document.createElement("div");
    warningDiv.style.cssText = `
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      background-color: #d32f2f;
      color: white;
      text-align: center;
      padding: 15px;
      z-index: 99999;
      font-family: 'Tajawal', sans-serif;
      font-weight: bold;
      box-shadow: 0 -4px 10px rgba(0,0,0,0.2);
      direction: rtl;
    `;
    
    warningDiv.innerHTML = `
      âš ï¸ ${warningData.message}
      <br>
      <a href="tel:01145435095" style="color: #fff; text-decoration: underline; margin: 0 5px;">01145435095</a> | 
      <a href="tel:01040761680" style="color: #fff; text-decoration: underline; margin: 0 5px;">01040761680</a>
    `;

    document.body.appendChild(warningDiv);
    // Ø±ÙØ¹ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ù‚Ù„ÙŠÙ„Ø§Ù‹ Ù„ÙƒÙŠ Ù„Ø§ ÙŠØºØ·ÙŠÙ‡ Ø§Ù„Ø´Ø±ÙŠØ·
    document.body.style.paddingBottom = "80px";
  }

  // Ø¯Ù…Ø¬ Ù‡Ø°Ù‡ Ø§Ù„ÙˆØ¸ÙŠÙØ© Ù…Ø¹ Ø§Ù„ÙÙŠØªØ´ Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ ØµÙØ­Ø§ØªÙƒ
  // Ù…Ø«Ø§Ù„: Ø¹Ù†Ø¯ Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø·Ø¹Ù…ØŒ Ø¥Ø°Ø§ ÙˆØ¬Ø¯Øª data.warning Ø§Ø³ØªØ¯Ø¹Ù Ù‡Ø°Ù‡ Ø§Ù„Ø¯Ø§Ù„Ø©
  // if (data.warning) checkTrialWarning(data.warning);

  // --- Ø¯Ø§Ù„Ø© Ø·Ø¨Ø§Ø¹Ø© Ù‚Ø³ÙŠÙ…Ø© Ø§Ù„Ø±Ø§ØªØ¨ (Payslip) ---
      window.printPayslip = function(dataEncoded) {
          const p = JSON.parse(decodeURIComponent(dataEncoded));
          const restName = document.getElementById("page-title").innerText.split("\n")[0] || "Smart Menu";
          const date = new Date().toLocaleDateString('ar-EG');
          const monthName = document.getElementById('acc-pay-month').options[document.getElementById('acc-pay-month').selectedIndex].text;

          const slipHTML = `
            <html>
            <head>
                <style>
                    body { font-family: 'Tajawal', sans-serif; direction: rtl; padding: 20px; border: 2px solid #333; max-width: 500px; margin: auto; }
                    .header { text-align: center; border-bottom: 2px solid #eee; padding-bottom: 15px; margin-bottom: 20px; }
                    .logo { font-size: 24px; font-weight: bold; color: #4338ca; }
                    .sub-title { font-size: 16px; color: #666; margin-top: 5px; }
                    .emp-info { background: #f9fafb; padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #e5e7eb; }
                    .row { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 14px; }
                    .section-title { font-weight: bold; margin-top: 15px; margin-bottom: 5px; color: #4338ca; border-bottom: 1px dashed #ccc; padding-bottom: 5px; }
                    .amount { font-weight: bold; }
                    .green { color: green; }
                    .red { color: red; }
                    .net-box { background: #4338ca; color: white; padding: 10px; border-radius: 8px; text-align: center; margin-top: 20px; font-size: 18px; font-weight: bold; }
                    .footer { text-align: center; margin-top: 30px; font-size: 12px; color: #888; border-top: 1px solid #eee; padding-top: 10px; }
                    @media print { 
                        body { border: none; } 
                        .no-print { display: none; }
                    }
                </style>
                <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap" rel="stylesheet">
            </head>
            <body>
                <div class="header">
                    <div class="logo">${restName}</div>
                    <div class="sub-title">Ù‚Ø³ÙŠÙ…Ø© Ø±Ø§ØªØ¨ - ${monthName}</div>
                </div>

                <div class="emp-info">
                    <div class="row"><span>Ø§Ù„Ù…ÙˆØ¸Ù:</span> <strong>${p.name}</strong></div>
                    <div class="row"><span>Ø§Ù„ÙˆØ¸ÙŠÙØ©:</span> <span>${p.job}</span></div>
                    <div class="row"><span>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥ØµØ¯Ø§Ø±:</span> <span>${date}</span></div>
                </div>

                <div class="details">
                    <div class="section-title">Ø§Ù„Ø§Ø³ØªØ­Ù‚Ø§Ù‚Ø§Øª (+)</div>
                    <div class="row"><span>Ø§Ù„Ø±Ø§ØªØ¨ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ:</span> <span class="amount">${p.base}</span></div>
                    ${p.overtime > 0 ? `<div class="row"><span>Ø¥Ø¶Ø§ÙÙŠ:</span> <span class="amount green">+${p.overtime}</span></div>` : ''}
                    ${p.bonuses > 0 ? `<div class="row"><span>Ù…ÙƒØ§ÙØ¢Øª:</span> <span class="amount green">+${p.bonuses}</span></div>` : ''}
                    
                    <div class="section-title">Ø§Ù„Ø§Ø³ØªÙ‚Ø·Ø§Ø¹Ø§Øª (-)</div>
                    ${p.deductions > 0 ? `<div class="row"><span>Ø®ØµÙˆÙ…Ø§Øª/Ø¬Ø²Ø§Ø¡Ø§Øª:</span> <span class="amount red">-${p.deductions}</span></div>` : ''}
                    ${p.loans > 0 ? `<div class="row"><span>Ø³Ø¯Ø§Ø¯ Ø³Ù„ÙØ©:</span> <span class="amount red">-${p.loans}</span></div>` : ''}
                    ${p.deductions === 0 && p.loans === 0 ? '<div class="row" style="color:#999">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø®ØµÙˆÙ…Ø§Øª</div>' : ''}
                </div>

                <div class="net-box">
                    ØµØ§ÙÙŠ Ø§Ù„Ø±Ø§ØªØ¨: ${p.net} Ø¬.Ù…
                </div>

                <div class="footer">
                    ØªÙ… Ø¥ØµØ¯Ø§Ø± Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªÙ†Ø¯ Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ§Ù‹ Ù…Ù† Ù†Ø¸Ø§Ù… Smart Menu
                </div>

                <script>
                    window.onload = function() { window.print(); }
                <\/script>
            </body>
            </html>
          `;

          const popup = window.open("", "_blank", "width=600,height=700");
          popup.document.open();
          popup.document.write(slipHTML);
          popup.document.close();
      };
     async function loadReservations() {
    const tbody = document.getElementById("res-requests-list");
    // Ù„Ø§ Ù†Ù…Ø³Ø­ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ ØªØ­Ø¯ÙŠØ« Ø¨Ø³ÙŠØ·ØŒ ÙˆÙ„ÙƒÙ† Ù‡Ù†Ø§ Ø³Ù†Ø¹ÙŠØ¯ Ø§Ù„Ø¨Ù†Ø§Ø¡
    // ÙŠÙ…ÙƒÙ† ÙˆØ¶Ø¹ loading spinner ÙÙ‚Ø· Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø¬Ø¯ÙˆÙ„ ÙØ§Ø±ØºØ§Ù‹
    if(tbody.children.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" style="text-align:center">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</td></tr>';
    }

    try {
        const res = await fetch("/api/v1/reservations/requests", {
            headers: { Authorization: `Bearer ${token}` }
        });
        const data = await res.json();
        tbody.innerHTML = "";

        if(data.data.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding:20px;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ø­Ø¬Ø²</td></tr>';
            return;
        }

        data.data.forEach(r => {
            let statusBadge = "";
            let actions = "";

            if(r.status === 'pending') {
                statusBadge = '<span class="badge" style="background:#fef3c7; color:#d97706">Ø§Ù†ØªØ¸Ø§Ø±</span>';
                actions = `
                    <div style="display:flex; gap:5px;">
                        <button class="btn btn-success" style="padding:5px 10px; font-size:12px;" onclick="resAction('${r._id}', 'approved')"><i class="fas fa-check"></i></button>
                        <button class="btn btn-outline" style="padding:5px 10px; font-size:12px; color:red; border-color:red;" onclick="resAction('${r._id}', 'rejected')"><i class="fas fa-times"></i></button>
                    </div>
                `;
            } else if (r.status === 'approved') {
                statusBadge = '<span class="badge" style="background:#dcfce7; color:#166534">Ù…Ù‚Ø¨ÙˆÙ„</span>';
                // Ø²Ø± Ø±ÙØ¶ (Ù„Ù„Ø¥Ù„ØºØ§Ø¡) ÙˆØ²Ø± Ø­Ø°Ù
                actions = `
                    <div style="display:flex; gap:5px;">
                        <button class="btn btn-outline" title="Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø­Ø¬Ø²" style="padding:5px 10px; font-size:12px; color:orange; border-color:orange;" onclick="resAction('${r._id}', 'rejected')"><i class="fas fa-undo"></i></button>
                        <button class="btn btn-outline" title="Ø­Ø°Ù Ø§Ù„Ø³Ø¬Ù„" style="padding:5px 10px; font-size:12px; color:red; border-color:red;" onclick="deleteReservation('${r._id}')"><i class="fas fa-trash"></i></button>
                    </div>
                `;
            } else { // rejected
                statusBadge = '<span class="badge" style="background:#fee2e2; color:#991b1b">Ù…Ø±ÙÙˆØ¶</span>';
                // Ø²Ø± Ù‚Ø¨ÙˆÙ„ (Ù„Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªÙØ¹ÙŠÙ„) ÙˆØ²Ø± Ø­Ø°Ù
                actions = `
                    <div style="display:flex; gap:5px;">
                        <button class="btn btn-outline" title="Ø¥Ø¹Ø§Ø¯Ø© Ù‚Ø¨ÙˆÙ„" style="padding:5px 10px; font-size:12px; color:green; border-color:green;" onclick="resAction('${r._id}', 'approved')"><i class="fas fa-redo"></i></button>
                        <button class="btn btn-outline" title="Ø­Ø°Ù Ø§Ù„Ø³Ø¬Ù„" style="padding:5px 10px; font-size:12px; color:red; border-color:red;" onclick="deleteReservation('${r._id}')"><i class="fas fa-trash"></i></button>
                    </div>
                `;
            }

            tbody.innerHTML += `
                <tr id="res-row-${r._id}">
                    <td>${r.name}</td>
                    <td><a href="tel:${r.phone}">${r.phone}</a></td>
                    <td style="font-weight:bold; font-size:16px;">${r.seats}</td>
                    <td style="font-size:12px;">${new Date(r.createdAt).toLocaleString('ar-EG')}</td>
                    <td>${statusBadge}</td>
                    <td>${actions}</td>
                </tr>
            `;
        });
    } catch(e) { console.error(e); }
}

async function resAction(id, status) {
    Swal.showLoading();
    try {
        const res = await fetch(`/api/v1/reservations/action/${id}`, {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${token}` },
            body: JSON.stringify({ status })
        });
        const data = await res.json();
        Swal.close();
        
        if(data.status === 'success') {
            Swal.fire({ toast: true, icon: 'success', title: data.message });
        } else {
            Swal.fire('Ø®Ø·Ø£', data.message, 'error');
        }
    } catch(e) {
        console.error(e);
        Swal.fire('Ø®Ø·Ø£', 'ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„', 'error');
    }
}

// Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ ØªÙ†Ø¨ÙŠÙ‡ Ø§Ù„Ø­Ø¬Ø² Ø§Ù„Ø¬Ø¯ÙŠØ¯
// Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ ØªØ­Ø¯ÙŠØ«Ø§Øª Ø§Ù„Ø­Ø¬Ø² Ø§Ù„Ù„Ø­Ø¸ÙŠØ©
if(typeof socket !== 'undefined') {
    // 1. Ø·Ù„Ø¨ Ø­Ø¬Ø² Ø¬Ø¯ÙŠØ¯
    socket.on("new_reservation_request", (res) => {
        Swal.fire({
            toast: true, position: 'top-end', icon: 'info', 
            title: `Ø·Ù„Ø¨ Ø­Ø¬Ø² Ø¬Ø¯ÙŠØ¯: ${res.name}`,
            text: `${res.seats} Ù…Ù‚Ø§Ø¹Ø¯`,
            showConfirmButton: false, timer: 5000
        });
        
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„ØµÙØ­Ø© Ù…ÙØªÙˆØ­Ø©
        if(!document.getElementById('view-reservations').classList.contains('hidden')) {
            loadReservations();
        }
    });

    // 2. ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø­Ø¬Ø² (Ù‚Ø¨ÙˆÙ„/Ø±ÙØ¶)
    socket.on("reservation_updated", (res) => {
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¬Ø¯ÙˆÙ„ ÙÙ‚Ø· Ø¯ÙˆÙ† Ø¥Ø´Ø¹Ø§Ø± Ù…Ø²Ø¹Ø¬
        if(!document.getElementById('view-reservations').classList.contains('hidden')) {
            loadReservations();
        }
    });

    // 3. Ø­Ø°Ù Ø­Ø¬Ø²
    socket.on("reservation_deleted", (id) => {
        const row = document.getElementById(`res-row-${id}`);
        if(row) {
            row.style.background = '#fee2e2';
            setTimeout(() => row.remove(), 500);
        }
    });
    
    // 4. ØªØ­Ø¯ÙŠØ« Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ù‚Ø§Ø¹Ø¯ ÙÙŠ ØµÙØ­Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
    socket.on("seats_updated", (data) => {
         if(document.getElementById('res-booked-display')) {
             updateReservationStats(data.total, data.booked);
         }
    });
}
async function deleteReservation(id) {
    const result = await Swal.fire({
        title: 'Ø­Ø°Ù Ø§Ù„Ø³Ø¬Ù„ØŸ',
        text: "Ø³ÙŠØªÙ… Ø¥Ø²Ø§Ù„Ø© Ù‡Ø°Ø§ Ø§Ù„Ø·Ù„Ø¨ Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹.",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#d33',
        confirmButtonText: 'Ù†Ø¹Ù…ØŒ Ø­Ø°Ù',
        cancelButtonText: 'ØªØ±Ø§Ø¬Ø¹'
    });

    if (result.isConfirmed) {
        try {
            const res = await fetch(`/api/v1/reservations/${id}`, {
                method: 'DELETE',
                headers: { Authorization: `Bearer ${token}` }
            });
            
            if(res.ok) {
                // Ø§Ù„Ø­Ø°Ù Ù…Ù† Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø³ÙŠØªÙ… ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¹Ø¨Ø± Ø§Ù„Ø³ÙˆÙƒØªØŒ Ù„ÙƒÙ† Ù„Ù„Ø§Ø­ØªÙŠØ§Ø·:
                const row = document.getElementById(`res-row-${id}`);
                if(row) row.remove();
                Swal.fire({ toast: true, icon: 'success', title: 'ØªÙ… Ø§Ù„Ø­Ø°Ù' });
            } else {
                Swal.fire('Ø®Ø·Ø£', 'ÙØ´Ù„ Ø§Ù„Ø­Ø°Ù', 'error');
            }
        } catch(e) {
            console.error(e);
        }
    }
}
</script>
  </body>
</html>