<!doctype html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… | Smart Menu</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="/socket.io/socket.io.js"></script>

    

    <script>
      const urlParamsGate = new URLSearchParams(window.location.search);
      const tokenGate =
        urlParamsGate.get("t") || sessionStorage.getItem("ownerToken");

      if (!tokenGate) {
        window.location.href = "/login";
      }
    </script>

    <style>
      * { box-sizing: border-box; } /* Ù‡Ø°Ø§ Ø§Ù„Ø³Ø·Ø± Ø³ÙŠØ¶Ø¨Ø· Ù…Ù‚Ø§Ø³Ø§Øª Ø§Ù„Ø¹Ù†Ø§ØµØ± ØªÙ…Ø§Ù…Ø§Ù‹ */
      :root {
        --primary: #4338ca;
        --primary-light: #e0e7ff;
        --secondary: #64748b;
        --bg: #f3f4f6;
        --surface: #ffffff;
        --border-color: #e2e8f0;
        --text-main: #1e293b;
        --success: #10b981;
        --danger: #ef4444;
        --warning: #f59e0b;
      }

      body.dark-mode {
        --primary: #6366f1;
        --primary-light: #312e81;
        --secondary: #94a3b8;
        --bg: #0f172a;
        --surface: #1e293b;
        --border-color: #334155;
        --text-main: #f1f5f9;
      }

      body {
        font-family: "Tajawal", sans-serif;
        background: var(--bg);
        margin: 0;
        display: flex;
        height: 100vh;
        overflow: hidden;
        color: var(--text-main);
        transition:
          background 0.3s,
          color 0.3s;
      }

      .mobile-header {
        display: none;
        background: var(--surface);
        padding: 15px;
        justify-content: space-between;
        align-items: center;
        border-bottom: 1px solid var(--border-color);
        position: fixed;
        top: 0;
        width: 100%;
        z-index: 1000;
        box-sizing: border-box;
      }
      .mobile-menu-btn {
        background: none;
        border: none;
        font-size: 24px;
        color: var(--text-main);
        cursor: pointer;
      }

      .sidebar {
        width: 260px;
        background: var(--surface);
        height: 100%;
        border-left: 1px solid var(--border-color);
        display: flex;
        flex-direction: column;
        padding: 20px;
        box-shadow: 2px 0 10px rgba(0, 0, 0, 0.02);
        z-index: 1001;
        transition: 0.3s;
      }
      .logo {
        font-size: 22px;
        font-weight: 800;
        color: var(--primary);
        margin-bottom: 40px;
        display: flex;
        align-items: center;
        gap: 10px;
      }
      .nav-item {
        padding: 12px 15px;
        margin-bottom: 8px;
        cursor: pointer;
        border-radius: 10px;
        color: var(--secondary);
        font-weight: 500;
        transition: 0.3s;
        display: flex;
        align-items: center;
        gap: 12px;
      }
      .nav-item:hover {
        background: var(--bg);
        color: var(--primary);
      }
      .nav-item.active {
        background: var(--primary);
        color: white;
        box-shadow: 0 4px 12px rgba(67, 56, 202, 0.3);
      }
      .nav-item i {
        width: 20px;
        text-align: center;
        font-size: 18px;
      }

      .overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        display: none;
      }

      .main-content {
        flex: 1;
        padding: 30px;
        overflow-y: auto;
        width: 100%;
      }
      .header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
      }
      .page-title {
        font-size: 24px;
        font-weight: 700;
        color: var(--text-main);
      }
      .btn-preview {
        background: var(--surface);
        border: 1px solid var(--border-color);
        padding: 10px 20px;
        border-radius: 30px;
        color: var(--primary);
        font-weight: bold;
        text-decoration: none;
        display: flex;
        align-items: center;
        gap: 8px;
        transition: 0.3s;
      }
      .btn-preview:hover {
        border-color: var(--primary);
        background: var(--primary-light);
      }

      .login-wrapper {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: var(--bg);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 2000;
      }
      .login-box {
        background: var(--surface);
        padding: 40px;
        border-radius: 20px;
        width: 400px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        text-align: center;
      }

      .card {
        background: var(--surface);
        border-radius: 16px;
        padding: 25px;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
        border: 1px solid var(--border-color);
        margin-bottom: 25px;
      }
      .form-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
      }
      .form-group {
        margin-bottom: 15px;
      }
      .form-label {
        display: block;
        margin-bottom: 8px;
        font-size: 14px;
        font-weight: 600;
        color: var(--secondary);
      }
      input,
      select,
      textarea {
        width: 100%;
        padding: 12px 15px;
        border: 1px solid #cbd5e1;
        border-radius: 10px;
        font-family: inherit;
        font-size: 14px;
        transition: 0.3s;
        outline: none;
        box-sizing: border-box;
        background: var(--bg);
        color: var(--text-main);
      }
      input:focus,
      select:focus,
      textarea:focus {
        border-color: var(--primary);
        box-shadow: 0 0 0 3px var(--primary-light);
      }

      input[type="file"] {
        display: none;
      }

      .custom-file-upload {
        border: 1px solid #cbd5e1;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        padding: 10px 15px;
        cursor: pointer;
        border-radius: 10px;
        background: var(--bg);
        color: var(--secondary);
        font-size: 14px;
        font-weight: 500;
        transition: 0.2s;
        height: 45px;
        box-sizing: border-box;
        width: 100%;
        white-space: nowrap;
      }
      .custom-file-upload:hover {
        border-color: var(--primary);
        color: var(--primary);
      }

      .img-preview {
        width: 45px;
        height: 45px;
        border-radius: 8px;
        object-fit: cover;
        display: none;
        border: 1px solid var(--border-color);
        margin-right: 10px;
      }

      .btn {
        padding: 12px 20px;
        border: none;
        border-radius: 10px;
        cursor: pointer;
        font-weight: bold;
        font-size: 14px;
        transition: 0.2s;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
      }
      .btn-primary {
        background: var(--primary);
        color: white;
        width: 100%;
      }
      .btn-primary:hover {
        background: #3730a3;
      }
      .btn-success {
        background: var(--success);
        color: white;
      }
      .btn-outline {
        background: transparent;
        border: 1px solid #cbd5e1;
        color: var(--secondary);
      }

      .search-container {
        position: relative;
        max-width: 400px;
        margin-bottom: 20px;
      }
      .search-input {
        padding-right: 40px;
        border-radius: 50px;
        background: var(--surface);
        border: 1px solid var(--border-color);
        color: var(--text-main);
      }
      .search-icon {
        position: absolute;
        right: 15px;
        top: 13px;
        color: var(--secondary);
      }

      .table-wrapper {
        overflow-x: auto;
        background: var(--surface);
        border-radius: 16px;
        border: 1px solid var(--border-color);
      }
      table {
        width: 100%;
        border-collapse: collapse;
        min-width: 600px;
      }
      th {
        background: var(--bg);
        text-align: right;
        padding: 18px;
        font-size: 13px;
        color: var(--secondary);
        font-weight: 700;
        border-bottom: 1px solid var(--border-color);
      }
      td {
        padding: 15px;
        border-bottom: 1px solid var(--border-color);
        font-size: 14px;
        vertical-align: middle;
        color: var(--text-main);
      }
      tr:last-child td {
        border-bottom: none;
      }
      tr:hover {
        background: var(--bg);
      }

      .badge {
        padding: 4px 10px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: bold;
      }
      .badge-cat {
        background: var(--primary-light);
        color: var(--primary);
      }

      .bulk-card {
        background: var(--surface);
        border: 1px dashed #cbd5e1;
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 15px;
        position: relative;
        transition: 0.3s;
      }
      .bulk-card:hover {
        border-color: var(--primary);
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
      }
      .btn-remove-row {
        position: absolute;
        left: 15px;
        top: 15px;
        color: var(--danger);
        background: var(--bg);
        border: none;
        width: 30px;
        height: 30px;
        border-radius: 50%;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: 0.2s;
      }
      .btn-remove-row:hover {
        background: var(--danger);
        color: white;
      }

     .hidden {
        display: none !important;
      }

/* ================================================= */
/* ğŸ“± Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙƒØ§Ù…Ù„ (Mobile App System) */
/* ================================================= */

/* Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø¨Ø§Ø± Ø§Ù„Ø³ÙÙ„ÙŠ ÙÙŠ Ø§Ù„ÙƒÙ…Ø¨ÙŠÙˆØªØ± */
.mobile-bottom-nav { display: none; }

@media (max-width: 768px) {
    
    /* 1. Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© ÙˆØªØ­ÙˆÙŠÙ„Ù‡Ø§ Ù„Ù‚Ø§Ø¦Ù…Ø© "Ø§Ù„Ù…Ø²ÙŠØ¯" */
    .sidebar {
        position: fixed !important; /* Ù‡Ø°Ø§ Ø§Ù„Ø³Ø·Ø± Ù‡Ùˆ Ø§Ù„Ø­Ù„ Ù„ØªØ«Ø¨ÙŠØª Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© ÙˆØ¥Ø®ÙØ§Ø¦Ù‡Ø§ */
        z-index: 9999 !important;
        width: 100% !important; /* ØªØºØ·ÙŠ Ø§Ù„Ø´Ø§Ø´Ø© Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ Ø¹Ù†Ø¯ Ø§Ù„ÙØªØ­ */
        right: -100% !important;
        top: 0 !important;
        background: rgba(255,255,255,0.98) !important;
        backdrop-filter: blur(10px);
        transition: right 0.3s ease-in-out;
    }
    .sidebar.active { right: 0 !important; }

    /* 2. ØªØµÙ…ÙŠÙ… Ø§Ù„Ø¨Ø§Ø± Ø§Ù„Ø³ÙÙ„ÙŠ (App Bar) */
    .mobile-bottom-nav {
        display: flex;
        position: fixed;
        bottom: 0; left: 0; width: 100%;
        height: 65px;
        background: #ffffff;
        box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
        z-index: 9000;
        justify-content: space-around;
        align-items: center;
        border-top: 1px solid #f1f5f9;
        padding-bottom: 5px; /* Ø¹Ø´Ø§Ù† Ø§Ù„Ù€ iPhone Home Indicator */
    }

    .nav-icon {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        color: #94a3b8;
        font-size: 10px;
        width: 20%;
        cursor: pointer;
        position: relative;
    }

    .nav-icon i { font-size: 20px; margin-bottom: 4px; transition: 0.2s; }
    
    .nav-icon.active { color: var(--primary); font-weight: bold; }
    .nav-icon.active i { transform: translateY(-3px); }

    /* 3. Ø¶Ø¨Ø· Ø¬Ø³Ù… Ø§Ù„ØµÙØ­Ø© Ù„ÙŠØªÙ†Ø§Ø³Ø¨ Ù…Ø¹ Ø§Ù„Ø¨Ø§Ø± Ø§Ù„Ø³ÙÙ„ÙŠ */
    body { background: #f8fafc; padding-bottom: 80px; } /* Ù…Ø³Ø§Ø­Ø© Ù„Ù„Ø¨Ø§Ø± */
    
    .main-content {
        width: 100% !important;
        padding: 70px 15px 20px 15px !important; /* Ù…Ø³Ø§Ø­Ø© Ù„Ù„Ù‡ÙŠØ¯Ø± */
        margin: 0 !important;
    }

    /* 4. Ø§Ù„Ù‡ÙŠØ¯Ø± Ø§Ù„Ø¹Ù„ÙˆÙŠ (App Header) */
    .mobile-header {
        height: 60px;
        background: #ffffff;
        box-shadow: 0 1px 5px rgba(0,0,0,0.03);
        position: fixed; top: 0; left: 0; width: 100%;
        z-index: 8000;
        padding: 0 15px;
        display: flex !important;
        align-items: center;
        justify-content: space-between;
    }
    
    /* Ø¥Ø®ÙØ§Ø¡ Ø²Ø± Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù‚Ø¯ÙŠÙ… ÙÙŠ Ø§Ù„Ù‡ÙŠØ¯Ø± Ù„Ø£Ù†Ù†Ø§ Ù†Ù‚Ù„Ù†Ø§Ù‡ ØªØ­Øª */
    .mobile-menu-btn { display: none !important; }

    /* 5. ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ Ø¥Ù„Ù‰ ÙƒØ±ÙˆØª (Cards UI) - Ù†Ø³Ø®Ø© Ù…Ø¯Ù…Ø¬Ø© */
    .table-wrapper { background: transparent !important; border: none !important; box-shadow: none !important; }
    /* Ø¥Ø¶Ø§ÙØ© min-width: 0 Ù„Ù…Ù†Ø¹ Ø§Ù„Ø®Ø±ÙˆØ¬ Ø¹Ù† Ø§Ù„Ø´Ø§Ø´Ø© */
    table { display: block !important; width: 100% !important; min-width: 0 !important; }
    thead { display: none !important; }
    tbody, th, td, tr { display: block !important; width: 100% !important; }

    tr {
        background: #fff;
        margin-bottom: 10px; /* ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ù…Ø³Ø§ÙØ© Ø¨ÙŠÙ† Ø§Ù„ÙƒØ±ÙˆØª */
        border-radius: 12px;
        padding: 12px; /* ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ø­Ø´Ùˆ Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠ Ù„Ù„ÙƒØ§Ø±Øª */
        box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        border: 1px solid #f1f5f9;
        position: relative;
    }

    td {
        display: flex !important;
        justify-content: space-between;
        align-items: center;
        padding: 6px 0 !important; /* ØªÙ‚Ù„ÙŠÙ„ Ø§Ø±ØªÙØ§Ø¹ Ø§Ù„Ø³Ø·Ø± Ø¯Ø§Ø®Ù„ Ø§Ù„ÙƒØ§Ø±Øª */
        border-bottom: 1px dashed #f1f5f9;
        text-align: right;
        font-size: 13px; /* ØªØµØºÙŠØ± Ø§Ù„Ø®Ø· Ù‚Ù„ÙŠÙ„Ø§Ù‹ */
        color: #334155;
    }
    
    td:last-child { border-bottom: none !important; padding-top: 10px !important; justify-content: flex-end; gap: 5px; }
    
    /* ØªØ­Ø³ÙŠÙ† Ø§Ù„ØµÙˆØ± Ø¯Ø§Ø®Ù„ Ø§Ù„ÙƒØ±ÙˆØª */
    td img { width: 40px !important; height: 40px !important; border-radius: 8px !important; }

    /* 6. ØªØ­Ø³ÙŠÙ† Ø§Ù„Ù†Ù…Ø§Ø°Ø¬ (Inputs) Ù„ØªÙ†Ø§Ø³Ø¨ Ø§Ù„Ø´Ø§Ø´Ø© Ø§Ù„ØµØºÙŠØ±Ø© */
    .card {
        border-radius: 16px !important;
        border: none !important;
        box-shadow: 0 2px 10px rgba(0,0,0,0.02) !important;
        padding: 15px !important; /* ØªÙ‚Ù„ÙŠÙ„ Ø­Ø´Ùˆ Ø§Ù„Ù†Ù…Ø§Ø°Ø¬ */
        margin-bottom: 15px !important;
    }
    
    .form-grid { display: flex !important; flex-direction: column !important; gap: 10px !important; }
    
    input, select, textarea {
        height: 40px !important; /* ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ø§Ø±ØªÙØ§Ø¹ Ù…Ù† 50 Ø¥Ù„Ù‰ 40 */
        background: #f8fafc !important;
        border: 1px solid #e2e8f0 !important;
        border-radius: 8px !important;
        font-size: 14px !important;
        padding: 0 10px !important;
    }

    /* ØªØµØºÙŠØ± Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ù„ØªÙƒÙˆÙ† Ø£Ù†ÙŠÙ‚Ø© */
    .btn { 
        height: 40px !important; 
        border-radius: 8px !important; 
        font-size: 14px !important; 
        padding: 0 15px !important;
    }
    .table-wrapper { background: transparent !important; border: none !important; box-shadow: none !important; }
    /* Ø¥Ø¶Ø§ÙØ© min-width: 0 Ù„Ù…Ù†Ø¹ Ø§Ù„Ø®Ø±ÙˆØ¬ Ø¹Ù† Ø§Ù„Ø´Ø§Ø´Ø© */
    table { display: block !important; width: 100% !important; min-width: 0 !important; }
    thead { display: none !important; }
    tbody, th, td, tr { display: block !important; width: 100% !important; }

    tr {
        background: #fff;
        margin-bottom: 10px; /* ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ù…Ø³Ø§ÙØ© Ø¨ÙŠÙ† Ø§Ù„ÙƒØ±ÙˆØª */
        border-radius: 12px;
        padding: 12px; /* ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ø­Ø´Ùˆ Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠ Ù„Ù„ÙƒØ§Ø±Øª */
        box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        border: 1px solid #f1f5f9;
        position: relative;
    }

    td {
        display: flex !important;
        justify-content: space-between;
        align-items: center;
        padding: 6px 0 !important; /* ØªÙ‚Ù„ÙŠÙ„ Ø§Ø±ØªÙØ§Ø¹ Ø§Ù„Ø³Ø·Ø± Ø¯Ø§Ø®Ù„ Ø§Ù„ÙƒØ§Ø±Øª */
        border-bottom: 1px dashed #f1f5f9;
        text-align: right;
        font-size: 13px; /* ØªØµØºÙŠØ± Ø§Ù„Ø®Ø· Ù‚Ù„ÙŠÙ„Ø§Ù‹ */
        color: #334155;
    }
    
    td:last-child { border-bottom: none !important; padding-top: 10px !important; justify-content: flex-end; gap: 5px; }
    
    /* ØªØ­Ø³ÙŠÙ† Ø§Ù„ØµÙˆØ± Ø¯Ø§Ø®Ù„ Ø§Ù„ÙƒØ±ÙˆØª */
    td img { width: 40px !important; height: 40px !important; border-radius: 8px !important; }

    /* 6. ØªØ­Ø³ÙŠÙ† Ø§Ù„Ù†Ù…Ø§Ø°Ø¬ (Inputs) Ù„ØªÙ†Ø§Ø³Ø¨ Ø§Ù„Ø´Ø§Ø´Ø© Ø§Ù„ØµØºÙŠØ±Ø© */
    .card {
        border-radius: 16px !important;
        border: none !important;
        box-shadow: 0 2px 10px rgba(0,0,0,0.02) !important;
        padding: 15px !important; /* ØªÙ‚Ù„ÙŠÙ„ Ø­Ø´Ùˆ Ø§Ù„Ù†Ù…Ø§Ø°Ø¬ */
        margin-bottom: 15px !important;
    }
    
    .form-grid { display: flex !important; flex-direction: column !important; gap: 10px !important; }
    
    input, select, textarea {
        height: 40px !important; /* ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ø§Ø±ØªÙØ§Ø¹ Ù…Ù† 50 Ø¥Ù„Ù‰ 40 */
        background: #f8fafc !important;
        border: 1px solid #e2e8f0 !important;
        border-radius: 8px !important;
        font-size: 14px !important;
        padding: 0 10px !important;
    }

    /* ØªØµØºÙŠØ± Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ù„ØªÙƒÙˆÙ† Ø£Ù†ÙŠÙ‚Ø© */
    .btn { 
        height: 40px !important; 
        border-radius: 8px !important; 
        font-size: 14px !important; 
        padding: 0 15px !important;
    }

    /* 7. Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø¹Ù†Ø§ØµØ± ØºÙŠØ± Ø§Ù„Ø¶Ø±ÙˆØ±ÙŠØ© */
    #preview-link, .overlay { display: none !important; }

    /* 8. Ø¥ØµÙ„Ø§Ø­Ø§Øª Ø§Ù„ØµÙØ­Ø§Øª */
    #orders-grid { grid-template-columns: 1fr !important; }
    .phone-frame { width: 100% !important; height: 550px !important; border-width: 4px !important; }
}
/* ================================================= */
/* ğŸ“± Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙƒØ§Ù…Ù„ (Mobile App System) */
/* ================================================= */

/* Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø¨Ø§Ø± Ø§Ù„Ø³ÙÙ„ÙŠ ÙÙŠ Ø§Ù„ÙƒÙ…Ø¨ÙŠÙˆØªØ± */
.mobile-bottom-nav { display: none; }

@media (max-width: 768px) {
    
    /* 1. Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© ÙˆØªØ­ÙˆÙŠÙ„Ù‡Ø§ Ù„Ù‚Ø§Ø¦Ù…Ø© "Ø§Ù„Ù…Ø²ÙŠØ¯" */
    .sidebar {
        position: fixed !important; /* Ù‡Ø°Ø§ Ø§Ù„Ø³Ø·Ø± Ù‡Ùˆ Ø§Ù„Ø­Ù„ Ù„ØªØ«Ø¨ÙŠØª Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© ÙˆØ¥Ø®ÙØ§Ø¦Ù‡Ø§ */
        z-index: 9999 !important;
        width: 100% !important; /* ØªØºØ·ÙŠ Ø§Ù„Ø´Ø§Ø´Ø© Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ Ø¹Ù†Ø¯ Ø§Ù„ÙØªØ­ */
        right: -100% !important;
        top: 0 !important;
        background: rgba(255,255,255,0.98) !important;
        backdrop-filter: blur(10px);
        transition: right 0.3s ease-in-out;
    }
    .sidebar.active { right: 0 !important; }

    /* 2. ØªØµÙ…ÙŠÙ… Ø§Ù„Ø¨Ø§Ø± Ø§Ù„Ø³ÙÙ„ÙŠ (App Bar) */
    .mobile-bottom-nav {
        display: flex;
        position: fixed;
        bottom: 0; left: 0; width: 100%;
        height: 65px;
        background: #ffffff;
        box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
        z-index: 9000;
        justify-content: space-around;
        align-items: center;
        border-top: 1px solid #f1f5f9;
        padding-bottom: 5px; /* Ø¹Ø´Ø§Ù† Ø§Ù„Ù€ iPhone Home Indicator */
    }

    .nav-icon {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        color: #94a3b8;
        font-size: 10px;
        width: 20%;
        cursor: pointer;
        position: relative;
    }

    .nav-icon i { font-size: 20px; margin-bottom: 4px; transition: 0.2s; }
    
    .nav-icon.active { color: var(--primary); font-weight: bold; }
    .nav-icon.active i { transform: translateY(-3px); }

    /* 3. Ø¶Ø¨Ø· Ø¬Ø³Ù… Ø§Ù„ØµÙØ­Ø© Ù„ÙŠØªÙ†Ø§Ø³Ø¨ Ù…Ø¹ Ø§Ù„Ø¨Ø§Ø± Ø§Ù„Ø³ÙÙ„ÙŠ */
    body { background: #f8fafc; padding-bottom: 80px; } /* Ù…Ø³Ø§Ø­Ø© Ù„Ù„Ø¨Ø§Ø± */
    
    .main-content {
        width: 100% !important;
        padding: 70px 15px 20px 15px !important; /* Ù…Ø³Ø§Ø­Ø© Ù„Ù„Ù‡ÙŠØ¯Ø± */
        margin: 0 !important;
    }

    /* 4. Ø§Ù„Ù‡ÙŠØ¯Ø± Ø§Ù„Ø¹Ù„ÙˆÙŠ (App Header) */
    .mobile-header {
        height: 60px;
        background: #ffffff;
        box-shadow: 0 1px 5px rgba(0,0,0,0.03);
        position: fixed; top: 0; left: 0; width: 100%;
        z-index: 8000;
        padding: 0 15px;
        display: flex !important;
        align-items: center;
        justify-content: space-between;
    }
    
    /* Ø¥Ø®ÙØ§Ø¡ Ø²Ø± Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù‚Ø¯ÙŠÙ… ÙÙŠ Ø§Ù„Ù‡ÙŠØ¯Ø± Ù„Ø£Ù†Ù†Ø§ Ù†Ù‚Ù„Ù†Ø§Ù‡ ØªØ­Øª */
    .mobile-menu-btn { display: none !important; }

    /* 5. ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ Ø¥Ù„Ù‰ ÙƒØ±ÙˆØª (Cards UI) - Ù†Ø³Ø®Ø© Ù…Ø¯Ù…Ø¬Ø© */
    .table-wrapper { background: transparent !important; border: none !important; box-shadow: none !important; }
    /* Ø¥Ø¶Ø§ÙØ© min-width: 0 Ù„Ù…Ù†Ø¹ Ø§Ù„Ø®Ø±ÙˆØ¬ Ø¹Ù† Ø§Ù„Ø´Ø§Ø´Ø© */
    table { display: block !important; width: 100% !important; min-width: 0 !important; }
    thead { display: none !important; }
    tbody, th, td, tr { display: block !important; width: 100% !important; }

    tr {
        background: #fff;
        margin-bottom: 10px; /* ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ù…Ø³Ø§ÙØ© Ø¨ÙŠÙ† Ø§Ù„ÙƒØ±ÙˆØª */
        border-radius: 12px;
        padding: 12px; /* ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ø­Ø´Ùˆ Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠ Ù„Ù„ÙƒØ§Ø±Øª */
        box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        border: 1px solid #f1f5f9;
        position: relative;
    }

    td {
        display: flex !important;
        justify-content: space-between;
        align-items: center;
        padding: 6px 0 !important; /* ØªÙ‚Ù„ÙŠÙ„ Ø§Ø±ØªÙØ§Ø¹ Ø§Ù„Ø³Ø·Ø± Ø¯Ø§Ø®Ù„ Ø§Ù„ÙƒØ§Ø±Øª */
        border-bottom: 1px dashed #f1f5f9;
        text-align: right;
        font-size: 13px; /* ØªØµØºÙŠØ± Ø§Ù„Ø®Ø· Ù‚Ù„ÙŠÙ„Ø§Ù‹ */
        color: #334155;
    }
    
    td:last-child { border-bottom: none !important; padding-top: 10px !important; justify-content: flex-end; gap: 5px; }
    
    /* ØªØ­Ø³ÙŠÙ† Ø§Ù„ØµÙˆØ± Ø¯Ø§Ø®Ù„ Ø§Ù„ÙƒØ±ÙˆØª */
    td img { width: 40px !important; height: 40px !important; border-radius: 8px !important; }

    /* 6. ØªØ­Ø³ÙŠÙ† Ø§Ù„Ù†Ù…Ø§Ø°Ø¬ (Inputs) Ù„ØªÙ†Ø§Ø³Ø¨ Ø§Ù„Ø´Ø§Ø´Ø© Ø§Ù„ØµØºÙŠØ±Ø© */
    .card {
        border-radius: 16px !important;
        border: none !important;
        box-shadow: 0 2px 10px rgba(0,0,0,0.02) !important;
        padding: 15px !important; /* ØªÙ‚Ù„ÙŠÙ„ Ø­Ø´Ùˆ Ø§Ù„Ù†Ù…Ø§Ø°Ø¬ */
        margin-bottom: 15px !important;
    }
    
    .form-grid { display: flex !important; flex-direction: column !important; gap: 10px !important; }
    
    input, select, textarea {
        height: 40px !important; /* ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ø§Ø±ØªÙØ§Ø¹ Ù…Ù† 50 Ø¥Ù„Ù‰ 40 */
        background: #f8fafc !important;
        border: 1px solid #e2e8f0 !important;
        border-radius: 8px !important;
        font-size: 14px !important;
        padding: 0 10px !important;
    }

    /* ØªØµØºÙŠØ± Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ù„ØªÙƒÙˆÙ† Ø£Ù†ÙŠÙ‚Ø© */
    .btn { 
        height: 40px !important; 
        border-radius: 8px !important; 
        font-size: 14px !important; 
        padding: 0 15px !important;
    }
    .table-wrapper { background: transparent !important; border: none !important; box-shadow: none !important; }
    /* Ø¥Ø¶Ø§ÙØ© min-width: 0 Ù„Ù…Ù†Ø¹ Ø§Ù„Ø®Ø±ÙˆØ¬ Ø¹Ù† Ø§Ù„Ø´Ø§Ø´Ø© */
    table { display: block !important; width: 100% !important; min-width: 0 !important; }
    thead { display: none !important; }
    tbody, th, td, tr { display: block !important; width: 100% !important; }

    tr {
        background: #fff;
        margin-bottom: 10px; /* ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ù…Ø³Ø§ÙØ© Ø¨ÙŠÙ† Ø§Ù„ÙƒØ±ÙˆØª */
        border-radius: 12px;
        padding: 12px; /* ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ø­Ø´Ùˆ Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠ Ù„Ù„ÙƒØ§Ø±Øª */
        box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        border: 1px solid #f1f5f9;
        position: relative;
    }

    td {
        display: flex !important;
        justify-content: space-between;
        align-items: center;
        padding: 6px 0 !important; /* ØªÙ‚Ù„ÙŠÙ„ Ø§Ø±ØªÙØ§Ø¹ Ø§Ù„Ø³Ø·Ø± Ø¯Ø§Ø®Ù„ Ø§Ù„ÙƒØ§Ø±Øª */
        border-bottom: 1px dashed #f1f5f9;
        text-align: right;
        font-size: 13px; /* ØªØµØºÙŠØ± Ø§Ù„Ø®Ø· Ù‚Ù„ÙŠÙ„Ø§Ù‹ */
        color: #334155;
    }
    
    td:last-child { border-bottom: none !important; padding-top: 10px !important; justify-content: flex-end; gap: 5px; }
    
    /* ØªØ­Ø³ÙŠÙ† Ø§Ù„ØµÙˆØ± Ø¯Ø§Ø®Ù„ Ø§Ù„ÙƒØ±ÙˆØª */
    td img { width: 40px !important; height: 40px !important; border-radius: 8px !important; }

    /* 6. ØªØ­Ø³ÙŠÙ† Ø§Ù„Ù†Ù…Ø§Ø°Ø¬ (Inputs) Ù„ØªÙ†Ø§Ø³Ø¨ Ø§Ù„Ø´Ø§Ø´Ø© Ø§Ù„ØµØºÙŠØ±Ø© */
    .card {
        border-radius: 16px !important;
        border: none !important;
        box-shadow: 0 2px 10px rgba(0,0,0,0.02) !important;
        padding: 15px !important; /* ØªÙ‚Ù„ÙŠÙ„ Ø­Ø´Ùˆ Ø§Ù„Ù†Ù…Ø§Ø°Ø¬ */
        margin-bottom: 15px !important;
    }
    
    .form-grid { display: flex !important; flex-direction: column !important; gap: 10px !important; }
    
    input, select, textarea {
        height: 40px !important; /* ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ø§Ø±ØªÙØ§Ø¹ Ù…Ù† 50 Ø¥Ù„Ù‰ 40 */
        background: #f8fafc !important;
        border: 1px solid #e2e8f0 !important;
        border-radius: 8px !important;
        font-size: 14px !important;
        padding: 0 10px !important;
    }

    /* ØªØµØºÙŠØ± Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ù„ØªÙƒÙˆÙ† Ø£Ù†ÙŠÙ‚Ø© */
    .btn { 
        height: 40px !important; 
        border-radius: 8px !important; 
        font-size: 14px !important; 
        padding: 0 15px !important;
    }

    /* 7. Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø¹Ù†Ø§ØµØ± ØºÙŠØ± Ø§Ù„Ø¶Ø±ÙˆØ±ÙŠØ© */
    #preview-link, .overlay { display: none !important; }

    /* 8. Ø¥ØµÙ„Ø§Ø­Ø§Øª Ø§Ù„ØµÙØ­Ø§Øª */
    #orders-grid { grid-template-columns: 1fr !important; }
    .phone-frame { width: 100% !important; height: 550px !important; border-width: 4px !important; }
}
:root {
        --primary: #4338ca;
        --primary-light: #e0e7ff;
        --secondary: #64748b;
        --bg: #f8fafc; /* Ù„ÙˆÙ† Ø®Ù„ÙÙŠØ© Ø£ÙØªØ­ Ù‚Ù„ÙŠÙ„Ø§Ù‹ */
        --surface: #ffffff;
        --border-color: #e2e8f0;
        --text-main: #1e293b;
        --success: #10b981;
        --danger: #ef4444;
        --warning: #f59e0b;
        --radius: 16px; /* ØªÙˆØ­ÙŠØ¯ Ø§Ù„Ø§Ù†Ø­Ù†Ø§Ø¡Ø§Øª */
        --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
      }

      body.dark-mode {
        --primary: #6366f1;
        --primary-light: #312e81;
        --secondary: #94a3b8;
        --bg: #0f172a;
        --surface: #1e293b;
        --border-color: #334155;
        --text-main: #f1f5f9;
        --shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
      }

      * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
      
      body {
        font-family: "Tajawal", sans-serif;
        background: var(--bg);
        margin: 0;
        display: flex;
        height: 100vh;
        overflow: hidden;
        color: var(--text-main);
        transition: background 0.3s, color 0.3s;
      }

      /* === Animations === */
      @keyframes fadeInScale {
        0% { opacity: 0; transform: scale(0.98) translateY(10px); }
        100% { opacity: 1; transform: scale(1) translateY(0); }
      }
      
      @keyframes slideInRight {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
      }

      .view-animate {
        animation: fadeInScale 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards;
      }

      /* === Sidebar & Nav === */
      .sidebar {
        width: 280px;
        background: var(--surface);
        height: 100%;
        border-left: 1px solid var(--border-color);
        display: flex;
        flex-direction: column;
        padding: 25px;
        z-index: 1001;
        transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      }

      .logo {
        font-size: 24px;
        font-weight: 800;
        color: var(--primary);
        margin-bottom: 40px;
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 0 10px;
      }

      .nav-item {
        padding: 14px 18px;
        margin-bottom: 8px;
        cursor: pointer;
        border-radius: var(--radius);
        color: var(--secondary);
        font-weight: 600;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        gap: 15px;
        font-size: 15px;
      }

      .nav-item:hover {
        background: var(--bg);
        color: var(--primary);
        transform: translateX(-5px);
      }

      .nav-item.active {
        background: var(--primary);
        color: white;
        box-shadow: 0 4px 15px rgba(67, 56, 202, 0.25);
        transform: translateX(-5px);
      }

      /* === Main Content === */
      .main-content {
        flex: 1;
        padding: 30px; /* Default desktop padding */
        overflow-y: auto;
        width: 100%;
        scroll-behavior: smooth;
      }

      .header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
      }

      .page-title {
        font-size: 26px;
        font-weight: 800;
        color: var(--text-main);
      }

      /* === Cards & Inputs === */
      .card {
        background: var(--surface);
        border-radius: var(--radius);
        padding: 25px;
        box-shadow: var(--shadow);
        border: 1px solid var(--border-color);
        margin-bottom: 25px;
        transition: transform 0.2s, box-shadow 0.2s;
      }
      
      .form-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
      }

      .form-label {
        display: block;
        margin-bottom: 8px;
        font-size: 14px;
        font-weight: 600;
        color: var(--secondary);
      }

      input, select, textarea {
        width: 100%;
        padding: 14px 16px;
        border: 1.5px solid var(--border-color);
        border-radius: 12px;
        font-family: inherit;
        font-size: 15px;
        transition: all 0.3s;
        outline: none;
        background: var(--bg);
        color: var(--text-main);
      }

      input:focus, select:focus, textarea:focus {
        border-color: var(--primary);
        box-shadow: 0 0 0 4px var(--primary-light);
        background: var(--surface);
        transform: translateY(-2px);
      }

      /* === Buttons === */
      .btn {
        padding: 14px 24px;
        border: none;
        border-radius: 12px;
        cursor: pointer;
        font-weight: 700;
        font-size: 15px;
        transition: all 0.2s;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
        position: relative;
        overflow: hidden;
      }
      
      .btn:active { transform: scale(0.96); }

      .btn-primary {
        background: var(--primary);
        color: white;
        box-shadow: 0 4px 15px rgba(67, 56, 202, 0.2);
      }
      .btn-primary:hover { background: #3730a3; box-shadow: 0 6px 20px rgba(67, 56, 202, 0.3); }

      .btn-success { background: var(--success); color: white; }
      .btn-outline { background: transparent; border: 1.5px solid var(--border-color); color: var(--secondary); }
      .btn-outline:hover { border-color: var(--secondary); background: var(--bg); }

      .custom-file-upload {
        border: 1.5px dashed var(--border-color);
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
        padding: 12px;
        cursor: pointer;
        border-radius: 12px;
        background: var(--bg);
        color: var(--secondary);
        font-weight: 600;
        transition: 0.2s;
        width: 100%;
        height: 50px; /* Fixed height for alignment */
      }
      .custom-file-upload:hover { border-color: var(--primary); color: var(--primary); background: var(--primary-light); }

      /* === Tables === */
      .table-wrapper {
        overflow-x: auto;
        background: var(--surface);
        border-radius: var(--radius);
        border: 1px solid var(--border-color);
        box-shadow: var(--shadow);
      }
      table { width: 100%; border-collapse: collapse; min-width: 600px; }
      th { background: var(--bg); text-align: right; padding: 18px; color: var(--secondary); font-weight: 700; }
      td { padding: 18px; border-bottom: 1px solid var(--border-color); color: var(--text-main); }
      
      /* === Mobile Specific Styles === */
      .mobile-header, .mobile-bottom-nav, .overlay { display: none; }

      @media (max-width: 768px) {
        .sidebar {
          position: fixed;
          top: 0; right: -100%; width: 85%; max-width: 300px;
          box-shadow: -5px 0 25px rgba(0,0,0,0.1);
          transition: right 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        }
        .sidebar.active { right: 0; }
        
        .overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.4); backdrop-filter: blur(4px);
            z-index: 1000;
            display: none; opacity: 0; transition: opacity 0.3s;
        }
        .overlay.visible { display: block; opacity: 1; }

        .main-content {
            padding: 80px 15px 100px 15px !important; /* Ù…Ø³Ø§Ø­Ø© Ù„Ù„Ù‡ÙŠØ¯Ø± ÙˆØ§Ù„ÙÙˆØªØ± */
        }

        /* Mobile Header */
        .mobile-header {
            display: flex; justify-content: space-between; align-items: center;
            position: fixed; top: 0; left: 0; width: 100%; height: 65px;
            background: rgba(255,255,255,0.95); backdrop-filter: blur(10px);
            padding: 0 20px; z-index: 900;
            border-bottom: 1px solid var(--border-color);
            box-shadow: 0 2px 10px rgba(0,0,0,0.03);
        }
        body.dark-mode .mobile-header { background: rgba(30, 41, 59, 0.95); }

        /* Mobile Bottom Nav */
        .mobile-bottom-nav {
            display: flex; position: fixed; bottom: 0; left: 0; width: 100%;
            background: var(--surface); border-top: 1px solid var(--border-color);
            padding: 10px 0 25px 0; /* Extra padding for iPhone home indicator */
            z-index: 900; justify-content: space-around;
            box-shadow: 0 -4px 20px rgba(0,0,0,0.05);
        }
        .nav-icon {
            display: flex; flex-direction: column; align-items: center;
            font-size: 11px; color: var(--secondary); gap: 5px;
            transition: 0.3s; padding: 5px 10px; border-radius: 12px;
        }
        .nav-icon i { font-size: 22px; margin-bottom: 2px; transition: 0.3s; }
        .nav-icon.active { color: var(--primary); font-weight: bold; background: var(--primary-light); }
        .nav-icon.active i { transform: translateY(-2px); }

        /* Transform Tables to Cards on Mobile */
        .table-wrapper { background: transparent; border: none; box-shadow: none; overflow: visible; }
        table, thead, tbody, th, td, tr { display: block; }
        thead { display: none; }
        
        tr {
            background: var(--surface);
            border-radius: 16px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
            border: 1px solid var(--border-color);
            position: relative;
            animation: fadeInScale 0.4s ease-out;
        }
        
        td {
            padding: 8px 0;
            border-bottom: 1px dashed var(--border-color);
            display: flex; justify-content: space-between; align-items: center;
            font-size: 14px;
        }
        td:last-child { border-bottom: none; padding-top: 15px; justify-content: flex-end; gap: 8px; }
        
        /* Mobile Input & Form Adjustments */
        .form-grid { grid-template-columns: 1fr; gap: 15px; }
        input, select, textarea { height: 48px; font-size: 16px; /* Prevent zoom on iOS */ }
        .btn { height: 48px; width: 100%; margin-top: 5px; }
        
        /* Specific Fixes */
        .btn-preview { display: none; } /* Hide preview button on mobile header */
        .phone-frame { width: 100% !important; height: 500px !important; }
        #live-preview { border-radius: 20px; }
      }

      /* Utilities */
      .hidden { display: none !important; }
      .badge { padding: 4px 10px; border-radius: 20px; font-size: 12px; font-weight: 700; }
      .img-preview { width: 48px; height: 48px; border-radius: 10px; object-fit: cover; border: 1px solid var(--border-color); display:none; }
    </style>
  </head>
  <body>
    <div class="mobile-header">
      <div style="display:flex; align-items:center; gap:15px;">
          <button class="mobile-menu-btn" onclick="toggleSidebar()">
            <i class="fas fa-bars"></i>
          </button>
          <div class="logo" style="margin: 0; font-size: 18px; display:flex; align-items:center; gap:5px;">
            <i class="fas fa-pizza-slice" style="color:var(--primary)"></i> Smart Menu
          </div>
      </div>
      <div style="display:flex; gap:15px; align-items:center;">
          <button onclick="toggleDarkMode()" style="background:none; border:none; font-size:18px; color:var(--text-main);">
            <i class="fas fa-adjust"></i>
          </button>
          <button onclick="logout()" style="background:none; border:none; font-size:18px; color:var(--danger);">
            <i class="fas fa-sign-out-alt"></i>
          </button>
      </div>
    </div>
    <div class="overlay" onclick="toggleSidebar()"></div>

    <div
      id="dashboard-section"
      class="hidden"
      style="display: flex; width: 100%"
    >
      <div class="sidebar" id="sidebar">
        <button class="btn-close-sidebar" style="display:none;" onclick="toggleSidebar()">
            <i class="fas fa-times"></i>
        </button>

        <div class="logo"><i class="fas fa-pizza-slice"></i> Smart Menu</div>

        <div
          class="nav-item active"
          onclick="switchView('categories')"
          id="nav-categories"
        >
          <i class="fas fa-layer-group"></i> Ø§Ù„Ø£Ù‚Ø³Ø§Ù…
        </div>
        <div
          class="nav-item"
          onclick="switchView('products')"
          id="nav-products"
        >
          <i class="fas fa-hamburger"></i> Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª
        </div>
        <div class="nav-item" onclick="switchView('bulk')" id="nav-bulk">
          <i class="fas fa-rocket"></i> Ø¥Ø¶Ø§ÙØ© Ø¬Ù…Ù„Ø©
        </div>
        <div class="nav-item" onclick="switchView('orders')" id="nav-orders">
          <i class="fas fa-bell"></i> Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø­ÙŠØ©
          <span
            id="live-badge"
            class="badge badge-cat hidden"
            style="background: var(--danger); color: white"
            >0</span
          >
        </div>
        <div class="nav-item" onclick="switchView('history')" id="nav-history">
          <i class="fas fa-history"></i> Ø³Ø¬Ù„ Ø§Ù„Ø¬Ø±Ø¯
        </div>
        <div class="nav-item" onclick="switchView('design')" id="nav-design">
          <i class="fas fa-paint-brush"></i> Ø§Ù„ØªØµÙ…ÙŠÙ…
        </div>
        <div
          class="nav-item"
          onclick="switchView('settings')"
          id="nav-settings"
        >
          <i class="fas fa-cog"></i> Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…ØªØ¬Ø±
        </div>
        <div
          class="nav-item hidden"
          onclick="switchView('staff')"
          id="nav-staff"
        >
          <i class="fas fa-users-cog"></i> Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†
        </div>

        <div
          class="nav-item hidden"
          onclick="switchView('coupons')"
          id="nav-coupons"
        >
          <i class="fas fa-ticket-alt"></i> Ø§Ù„ÙƒÙˆØ¨ÙˆÙ†Ø§Øª
        </div>
        <div class="nav-item" onclick="toggleDarkMode()">
          <i class="fas fa-moon"></i> ÙˆØ¶Ø¹ Ù„ÙŠÙ„ÙŠ/Ù†Ù‡Ø§Ø±ÙŠ
        </div>

        <div style="margin-top: auto">
          <div class="nav-item" onclick="logout()" style="color: var(--danger)">
            <i class="fas fa-sign-out-alt"></i> Ø®Ø±ÙˆØ¬
          </div>
        </div>
      </div>

      <div class="main-content">
        <div class="header">
          <div class="page-title" id="page-title">Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
          <a href="#" id="preview-link" target="_blank" class="btn-preview">
            <i class="fas fa-external-link-alt"></i> Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ù…Ù†ÙŠÙˆ
          </a>
        </div>

        <div id="view-orders" class="hidden">
          <div
            style="
              display: flex;
              justify-content: space-between;
              align-items: center;
              margin-bottom: 20px;
            "
          >
            <h3 style="margin: 0; color: var(--primary)">Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„ÙˆØ§Ø±Ø¯Ø©</h3>
            <button
              id="btn-recent-orders"
              class="btn btn-primary"
              onclick="showRecentOrders()"
              style="margin-left: 10px"
            >
              <i class="fas fa-history"></i> ÙÙˆØ§ØªÙŠØ± Ø³Ø§Ø¨Ù‚Ø©
            </button>
            <button class="btn btn-outline" onclick="loadOrders()">
              <i class="fas fa-sync"></i> ØªØ­Ø¯ÙŠØ«
            </button>
          </div>
          <div style="margin-bottom: 20px; display: flex; gap: 10px">
            <input
              type="number"
              id="live-order-search"
              placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„ÙŠÙˆÙ…ÙŠ..."
              style="
                padding: 10px;
                border-radius: 8px;
                border: 1px solid var(--border-color);
                flex: 1;
              "
              onkeydown="if (event.key === 'Enter') searchOrderHistory();"
            />
            <button
              class="btn btn-primary"
              onclick="searchOrderHistory()"
              style="width: auto"
            >
              <i class="fas fa-search"></i> Ø¨Ø­Ø«
            </button>
          </div>
          <div
            id="orders-grid"
            style="
              display: grid;
              grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
              gap: 20px;
            "
          ></div>
          <audio
            id="order-sound"
            src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3"
          ></audio>
        </div>

        <div id="view-history" class="hidden">
          <div
            style="
              display: flex;
              justify-content: space-between;
              align-items: center;
              margin-bottom: 20px;
              flex-wrap: wrap;
              gap: 10px;
            "
          >
            <h3 style="margin: 0; color: var(--primary)">
              <span id="history-title">Ø³Ø¬Ù„ Ø§Ù„Ø¬Ø±Ø¯</span>
            </h3>

            <div
              id="owner-filters"
              class="hidden"
              style="display: flex; gap: 10px; align-items: center"
            >
              <input
                type="date"
                id="filter-start"
                style="padding: 5px; height: 35px"
              />
              <span style="font-weight: bold">:</span>
              <input
                type="date"
                id="filter-end"
                style="padding: 5px; height: 35px"
              />
              <button
                class="btn btn-primary"
                style="height: 35px; padding: 0 15px"
                onclick="window.loadHistory()"
              >
                <i class="fas fa-filter"></i> Ø¹Ø±Ø¶
              </button>
              <input
                type="text"
                id="history-search"
                placeholder="Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨ / Ø§Ù„Ø·Ø§ÙˆÙ„Ø©"
                style="padding: 5px; height: 35px; width: 120px"
              />
            </div>

            <button class="btn btn-outline" onclick="window.loadHistory()">
              <i class="fas fa-sync"></i> ØªØ­Ø¯ÙŠØ«
            </button>
          </div>

          <div
            style="
              background: linear-gradient(45deg, var(--primary), #6366f1);
              color: white;
              padding: 20px;
              border-radius: 16px;
              margin-bottom: 25px;
              display: flex;
              justify-content: space-between;
              align-items: center;
              box-shadow: 0 4px 15px rgba(99, 102, 241, 0.3);
            "
          >
            <div>
              <div style="font-size: 14px; opacity: 0.9">
                Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª (ÙƒÙ„ Ø§Ù„Ø£ÙˆÙ‚Ø§Øª)
              </div>
              <div
                style="font-size: 32px; font-weight: 800"
                id="total-sales-display"
              >
                0 Ø¬.Ù…
              </div>
            </div>
            <i class="fas fa-wallet fa-3x" style="opacity: 0.2"></i>
          </div>

          <div class="table-wrapper">
            <table>
              <thead>
                <tr>
                  <th>Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨</th>
                  <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                  <th>Ø§Ù„Ø·Ø§ÙˆÙ„Ø©</th>
                  <th>Ø§Ù„Ø£ØµÙ†Ø§Ù</th>
                  <th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
                  <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                </tr>
              </thead>
              <tbody id="history-list"></tbody>
            </table>
          </div>
        </div>

        <div id="view-categories">
          <div class="card">
            <h3
              style="
                margin-top: 0;
                margin-bottom: 15px;
                color: var(--primary);
                font-size: 18px;
                display: flex;
                justify-content: space-between;
              "
            >
              <span id="cat-form-title">Ø¥Ø¶Ø§ÙØ© Ù‚Ø³Ù… Ø¬Ø¯ÙŠØ¯</span>
              <button
                id="btn-cancel-cat"
                class="btn btn-outline hidden"
                onclick="resetCategoryForm()"
                style="font-size: 12px; padding: 2px 10px"
              >
                Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
              </button>
            </h3>

            <div
              style="
                display: flex;
                gap: 15px;
                align-items: flex-end;
                flex-wrap: wrap;
              "
            >
              <input type="hidden" id="edit-cat-id" />

              <div style="flex-grow: 1; min-width: 200px">
                <label class="form-label">Ø§Ø³Ù… Ø§Ù„Ù‚Ø³Ù…</label>
                <input type="text" id="c-name" placeholder="" />
              </div>
              <div style="width: auto; min-width: 180px; flex-grow: 1">
                <label class="form-label">Ø§Ù„ØºÙ„Ø§Ù (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
                <div style="display: flex; align-items: center">
                  <img id="c-preview" class="img-preview" />
                  <label for="c-image" class="custom-file-upload">
                    <i class="fas fa-image"></i> Ø§Ø®ØªØ± ØµÙˆØ±Ø©
                  </label>
                  <input
                    type="file"
                    id="c-image"
                    accept="image/*"
                    onchange="previewImage(this, 'c-preview')"
                  />
                </div>
              </div>
              <div style="width: auto">
                <button
                  id="btn-save-cat"
                  class="btn btn-primary"
                  style="height: 45px; padding: 0 25px"
                  onclick="saveCategory()"
                >
                  <i class="fas fa-plus"></i> Ø­ÙØ¸
                </button>
              </div>
            </div>
          </div>

          <div
            id="cat-stats-bar"
            style="display: flex; gap: 15px; margin-bottom: 20px"
          >
            <div
              style="
                background: white;
                padding: 15px;
                border-radius: 12px;
                border: 1px solid var(--border-color);
                flex: 1;
                display: flex;
                align-items: center;
                gap: 15px;
                box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
              "
            >
              <div
                style="
                  background: var(--primary-light);
                  color: var(--primary);
                  width: 50px;
                  height: 50px;
                  border-radius: 50%;
                  display: flex;
                  align-items: center;
                  justify-content: center;
                  font-size: 20px;
                "
              >
                <i class="fas fa-layer-group"></i>
              </div>
              <div>
                <div style="font-size: 12px; color: var(--secondary)">
                  Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…
                </div>
                <div
                  style="font-size: 20px; font-weight: 800"
                  id="stat-total-cats"
                >
                  0
                </div>
              </div>
            </div>
            <div
              style="
                background: white;
                padding: 15px;
                border-radius: 12px;
                border: 1px solid var(--border-color);
                flex: 1;
                display: flex;
                align-items: center;
                gap: 15px;
                box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
              "
            >
              <div
                style="
                  background: #dcfce7;
                  color: #166534;
                  width: 50px;
                  height: 50px;
                  border-radius: 50%;
                  display: flex;
                  align-items: center;
                  justify-content: center;
                  font-size: 20px;
                "
              >
                <i class="fas fa-hamburger"></i>
              </div>
              <div>
                <div style="font-size: 12px; color: var(--secondary)">
                  Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª
                </div>
                <div
                  style="font-size: 20px; font-weight: 800"
                  id="stat-total-prods"
                >
                  0
                </div>
              </div>
            </div>
          </div>

          <div class="table-wrapper">
            <table>
              <thead>
                <tr>
                  <th>Ø§Ù„ØºÙ„Ø§Ù</th>
                  <th>Ø§Ø³Ù… Ø§Ù„Ù‚Ø³Ù…</th>
                  <th>Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</th>
                  <th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                </tr>
              </thead>
              <tbody id="categories-list"></tbody>
            </table>
          </div>
        </div>

        <div id="view-products" class="hidden">
          <div class="search-container">
            <i class="fas fa-search search-icon"></i>
            <input
              type="text"
              class="search-input"
              id="searchInput"
              onkeyup="searchTable()"
              placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ù…Ù†ØªØ¬ Ø£Ùˆ Ù‚Ø³Ù…..."
            />
          </div>

          <div class="card">
            <h3
              style="
                margin-top: 0;
                font-size: 18px;
                margin-bottom: 20px;
                color: var(--primary);
              "
            >
              <span id="form-mode-title">Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬ Ø¬Ø¯ÙŠØ¯</span>
              <button
                id="btn-cancel"
                class="btn btn-outline hidden"
                onclick="resetProductForm()"
                style="float: left; padding: 5px 10px; font-size: 12px"
              >
                Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
              </button>
            </h3>

            <div class="form-grid">
              <div>
                <label class="form-label">Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬</label>
                <input type="text" id="p-name" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬" />
              </div>
              <div
                style="
                  background: var(--bg);
                  padding: 15px;
                  border-radius: 10px;
                  border: 1px solid var(--border-color);
                "
              >
                <div
                  style="
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    margin-bottom: 15px;
                  "
                >
                  <label class="form-label" style="margin: 0"
                    >Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ³Ø¹ÙŠØ±</label
                  >
                  <div style="display: flex; gap: 10px; font-size: 14px">
                    <label
                      style="
                        cursor: pointer;
                        display: flex;
                        align-items: center;
                        gap: 5px;
                      "
                    >
                      <input
                        type="radio"
                        name="pricingMode"
                        value="single"
                        checked
                        onchange="togglePricingMode()"
                      />
                      Ø³Ø¹Ø± Ù…ÙˆØ­Ø¯
                    </label>
                    <label
                      style="
                        cursor: pointer;
                        display: flex;
                        align-items: center;
                        gap: 5px;
                      "
                    >
                      <input
                        type="radio"
                        name="pricingMode"
                        value="multi"
                        onchange="togglePricingMode()"
                      />
                      Ø£Ø­Ø¬Ø§Ù… Ù…ØªØ¹Ø¯Ø¯Ø©
                    </label>
                  </div>
                </div>

                <div id="mode-single" class="pricing-group">
                  <div
                    style="
                      display: grid;
                      grid-template-columns: 1fr 1fr;
                      gap: 10px;
                    "
                  >
                    <div>
                      <label class="form-label">Ø§Ù„Ø³Ø¹Ø± (Ø¬.Ù…)</label>
                      <input
                        type="number"
                        id="p-price"
                        placeholder="Ù…Ø«Ø§Ù„: 150"
                      />
                    </div>
                    <div>
                      <label
                        class="form-label"
                        style="color: var(--danger); font-weight: bold"
                        >Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø£ØµÙ„ÙŠ (Ù‚Ø¨Ù„ Ø§Ù„Ø®ØµÙ…)</label
                      >
                      <input
                        type="number"
                        id="p-old-price"
                        placeholder="Ø§ÙƒØªØ¨ Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ù‚Ø¯ÙŠÙ… (Ø§Ù„Ø£ØºÙ„Ù‰)"
                        style="
                          border: 1px dashed var(--danger);
                          background: #fef2f2;
                          color: var(--danger);
                        "
                      />
                      <small style="font-size: 11px; color: var(--secondary)"
                        >Ø³ÙŠØ¨Ù‡ ÙØ§Ø¶ÙŠ Ù„Ùˆ Ù…ÙÙŠØ´ Ø®ØµÙ…</small
                      >
                    </div>
                  </div>
                </div>

                <div id="mode-multi" class="pricing-group hidden">
                  <div id="sizes-list"></div>
                  <button
                    class="btn btn-outline"
                    style="width: 100%; margin-top: 10px; border-style: dashed"
                    onclick="addSizeRow()"
                  >
                    <i class="fas fa-plus"></i> Ø¥Ø¶Ø§ÙØ© Ø­Ø¬Ù… Ø¬Ø¯ÙŠØ¯
                  </button>
                </div>
              </div>
            </div>

            <div class="form-grid" style="margin-top: 15px">
              <div>
                <label class="form-label">Ø§Ù„Ù‚Ø³Ù…</label>
                <select id="p-cat">
                  <option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ù‚Ø³Ù… --</option>
                </select>
              </div>
              <div>
                <label class="form-label">Ø§Ù„ØµÙˆØ±Ø©</label>
                <div style="display: flex; align-items: center">
                  <img id="p-preview" class="img-preview" />
                  <label for="p-image" class="custom-file-upload">
                    <i class="fas fa-cloud-upload-alt"></i> Ø±ÙØ¹ ØµÙˆØ±Ø©
                  </label>
                  <input
                    type="file"
                    id="p-image"
                    accept="image/*"
                    onchange="previewImage(this, 'p-preview')"
                  />
                </div>
              </div>
            </div>

            <div style="margin-top: 15px">
              <label class="form-label">Ø§Ù„ÙˆØµÙ</label>
              <textarea id="p-desc" rows="2" placeholder="Ø§Ù„ÙˆØµÙ"></textarea>
            </div>

            <div style="margin-top: 20px">
              <button
                id="btn-add-prod"
                class="btn btn-primary"
                onclick="saveProduct('POST')"
              >
                <i class="fas fa-plus-circle"></i> Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ù…Ù†ÙŠÙˆ
              </button>
              <button
                id="btn-update-prod"
                class="btn hidden"
                style="background: var(--warning); color: white; width: 100%"
                onclick="saveProduct('PATCH')"
              >
                <i class="fas fa-save"></i> Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª
              </button>
            </div>
          </div>

          <div class="table-wrapper">
            <table>
              <thead>
                <tr>
                  <th width="60">ØµÙˆØ±Ø©</th>
                  <th>Ø§Ù„Ø§Ø³Ù…</th>
                  <th>Ø§Ù„Ù‚Ø³Ù…</th>
                  <th>Ø§Ù„Ø³Ø¹Ø±</th>
                  <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                  <th>ØªØ­ÙƒÙ…</th>
                </tr>
              </thead>
              <tbody id="products-list"></tbody>
            </table>
          </div>
        </div>

        <div id="view-bulk" class="hidden">
          <div
            style="
              background: rgba(16, 185, 129, 0.1);
              border: 1px solid var(--success);
              padding: 15px;
              border-radius: 10px;
              color: var(--success);
              margin-bottom: 20px;
            "
          >
            <i class="fas fa-info-circle"></i> <strong>Ù†ØµÙŠØ­Ø©:</strong> ÙŠÙ…ÙƒÙ†Ùƒ
            Ø¥Ø¶Ø§ÙØ© Ø¹Ø¯Ø¯ ØºÙŠØ± Ù…Ø­Ø¯ÙˆØ¯ Ù…Ù† Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ù‡Ù†Ø§ØŒ Ø«Ù… Ø±ÙØ¹Ù‡Ø§ Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø©.
          </div>

          <div id="bulk-container"></div>

          <div style="display: flex; gap: 10px; margin-top: 20px">
            <button
              class="btn btn-outline"
              style="flex: 1; border-style: dashed"
              onclick="addBulkRow()"
            >
              <i class="fas fa-plus"></i> ØµÙ Ø¬Ø¯ÙŠØ¯
            </button>
            <button
              class="btn btn-success"
              style="flex: 1"
              onclick="submitBulkAll()"
            >
              <i class="fas fa-cloud-upload-alt"></i> Ø±ÙØ¹ ÙˆØ­ÙØ¸ Ø§Ù„ÙƒÙ„
            </button>
          </div>
        </div>
        <div id="view-staff" class="hidden">
          <div class="card">
            <h3 style="color: var(--primary); margin-top: 0">
              <i class="fas fa-user-plus"></i> Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ¸Ù Ø¬Ø¯ÙŠØ¯
            </h3>
            <div class="form-grid">
              <input type="text" id="staff-name" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù" />
              <input
                type="email"
                id="staff-email"
                placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ù„Ù„Ø¯Ø®ÙˆÙ„"
              />
            </div>
            <div class="form-grid" style="margin-top: 15px">
              <input
                type="text"
                id="staff-password"
                placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±"
              />
              <select id="staff-role">
                <option value="cashier">ÙƒØ§Ø´ÙŠØ±</option>
                <option value="kitchen">Ø´ÙŠÙ</option>
              </select>
            </div>

            <div
              style="
                background: var(--bg);
                padding: 15px;
                border-radius: 10px;
                margin-top: 15px;
                border: 1px solid var(--border-color);
              "
            >
              <h4 style="margin-top: 0; color: var(--secondary)">
                â° Ù…ÙˆØ§Ø¹ÙŠØ¯ Ø§Ù„Ø¹Ù…Ù„ ÙˆØ§Ù„Ø¥Ø¬Ø§Ø²Ø§Øª
              </h4>
              <div class="form-grid">
                <div>
                  <label class="form-label">Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø´ÙŠÙØª</label>
                  <input type="time" id="staff-start" value="09:00" />
                </div>
                <div>
                  <label class="form-label">Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø´ÙŠÙØª</label>
                  <input type="time" id="staff-end" value="17:00" />
                </div>
              </div>
              <label class="form-label" style="margin-top: 10px"
                >Ø£ÙŠØ§Ù… Ø§Ù„Ø¥Ø¬Ø§Ø²Ø© Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠØ©</label
              >
              <div
                style="display: flex; gap: 10px; flex-wrap: wrap"
                id="rest-days-container"
              >
                <label><input type="checkbox" value="6" /> Ø§Ù„Ø³Ø¨Øª</label>
                <label><input type="checkbox" value="0" /> Ø§Ù„Ø£Ø­Ø¯</label>
                <label><input type="checkbox" value="1" /> Ø§Ù„Ø¥Ø«Ù†ÙŠÙ†</label>
                <label><input type="checkbox" value="2" /> Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡</label>
                <label><input type="checkbox" value="3" /> Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡</label>
                <label><input type="checkbox" value="4" /> Ø§Ù„Ø®Ù…ÙŠØ³</label>
                <label><input type="checkbox" value="5" /> Ø§Ù„Ø¬Ù…Ø¹Ø©</label>
              </div>
            </div>
            <button
              class="btn btn-primary"
              onclick="addStaff()"
              style="margin-top: 15px"
            >
              Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            </button>
          </div>

          <div class="table-wrapper">
            <table>
              <thead>
                <tr>
                  <th>Ø§Ù„Ø§Ø³Ù…</th>
                  <th>Ø§Ù„Ø¨Ø±ÙŠØ¯</th>
                  <th>Ø§Ù„Ø¯ÙˆØ±</th>
                  <th>Ø­Ø°Ù</th>
                </tr>
              </thead>
              <tbody id="staff-list"></tbody>
            </table>
          </div>
        </div>
        <div id="view-coupons" class="hidden">
          <div class="card">
            <h3 style="color: var(--primary); margin-top: 0">
              Ø¥Ø¶Ø§ÙØ© ÙƒÙˆØ¨ÙˆÙ† Ø¬Ø¯ÙŠØ¯
            </h3>
            <div class="form-grid">
              <input
                type="text"
                id="coup-code"
                placeholder="ÙƒÙˆØ¯ Ø§Ù„ÙƒÙˆØ¨ÙˆÙ† (Ù…Ø«Ø§Ù„: SAVE20)"
              />
              <select id="coup-type">
                <option value="percent">Ù†Ø³Ø¨Ø© Ù…Ø¦ÙˆÙŠØ© (%)</option>
                <option value="fixed">Ù…Ø¨Ù„Øº Ø«Ø§Ø¨Øª (Ø¬.Ù…)</option>
              </select>
            </div>
            <div class="form-grid" style="margin-top: 10px">
              <input type="number" id="coup-value" placeholder="Ù‚ÙŠÙ…Ø© Ø§Ù„Ø®ØµÙ…" />
              <input
                type="number"
                id="coup-min"
                placeholder="Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ Ù„Ù„Ø·Ù„Ø¨ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)"
              />
            </div>
            <div class="form-grid" style="margin-top: 10px">
              <input
                type="number"
                id="coup-max-disc"
                placeholder="Ø£Ù‚ØµÙ‰ Ø®ØµÙ… (Ù„Ù„Ù†Ø³Ø¨Ø© Ø§Ù„Ù…Ø¦ÙˆÙŠØ© ÙÙ‚Ø·)"
              />
              <input
                type="number"
                id="coup-limit"
                placeholder="Ø¹Ø¯Ø¯ Ù…Ø±Ø§Øª Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… (Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ 1000)"
              />
            </div>
            <button
              class="btn btn-primary"
              style="margin-top: 15px"
              onclick="createCoupon()"
            >
              Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ÙƒÙˆØ¨ÙˆÙ†
            </button>
          </div>
          <div class="table-wrapper">
            <table>
              <thead>
                <tr>
                  <th>Ø§Ù„ÙƒÙˆØ¯</th>
                  <th>Ø§Ù„Ø®ØµÙ…</th>
                  <th>Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…</th>
                  <th>Ø­Ø°Ù</th>
                </tr>
              </thead>
              <tbody id="coupons-list"></tbody>
            </table>
          </div>
        </div>
        <div id="view-settings" class="hidden">
          <div class="card" style="max-width: 800px; margin: 0 auto">
            <h3
              style="
                color: var(--primary);
                margin-top: 0;
                border-bottom: 1px solid var(--border-color);
                padding-bottom: 15px;
                margin-bottom: 20px;
              "
            >
              <i class="fas fa-cogs"></i> Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ø·Ù„Ø¨Ø§Øª
            </h3>

            <div class="form-group">
              <label class="form-label">Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ´ØºÙŠÙ„ (Order Mode)</label>
              <select
                id="set-orderMode"
                style="height: 50px; font-size: 15px; font-weight: bold"
              >
                <option value="whatsapp">ğŸ“± ÙˆØ§ØªØ³Ø§Ø¨ (Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ Ù„Ø±Ù‚Ù…Ùƒ)</option>
                <option value="system">
                  ğŸš€ Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø°ÙƒÙŠ (Live Orders System)
                </option>
                <option value="view_only">ğŸ‘€ Ù„Ù„Ø¹Ø±Ø¶ ÙÙ‚Ø· (Ø¨Ø¯ÙˆÙ† Ø·Ù„Ø¨)</option>
              </select>
              <small
                style="color: var(--secondary); display: block; margin-top: 5px"
              >
                <i class="fas fa-info-circle"></i>
                <b>ÙˆØ§ØªØ³Ø§Ø¨:</b> Ø§Ù„Ø²Ø¨ÙˆÙ† ÙŠØ®ØªØ§Ø± Ø§Ù„Ø·Ù„Ø¨ ÙˆÙŠØªØ­ÙˆÙ„ Ù„Ù„Ø´Ø§Øª Ù…Ø¹Ø§Ùƒ. <br />
                <b>Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø°ÙƒÙŠ:</b> Ø§Ù„Ø·Ù„Ø¨Ø§Øª ØªÙ†Ø²Ù„ ÙÙŠ ØµÙØ­Ø© "Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø­ÙŠØ©" ÙˆØªØ³Ù…Ø¹
                ØµÙˆØª ØªÙ†Ø¨ÙŠÙ‡. <br />
                <b>Ù„Ù„Ø¹Ø±Ø¶ ÙÙ‚Ø·:</b> Ø¥Ø®ÙØ§Ø¡ Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¥Ø¶Ø§ÙØ© ÙˆØ§Ù„Ø³Ù„Ø© (ÙƒØªØ§Ù„ÙˆØ¬).
              </small>
            </div>

            <div class="form-grid" style="margin-top: 20px">
              <div>
                <label class="form-label">Ù†Ø³Ø¨Ø© Ø§Ù„Ø¶Ø±ÙŠØ¨Ø© (%)</label>
                <input
                  type="number"
                  id="set-taxRate"
                  placeholder="0"
                  min="0"
                  step="0.1"
                />
              </div>
              <div>
                <label class="form-label">Ù†Ø³Ø¨Ø© Ø§Ù„Ø®Ø¯Ù…Ø© (%)</label>
                <input
                  type="number"
                  id="set-serviceRate"
                  placeholder="0"
                  min="0"
                  step="0.1"
                />
              </div>
            </div>
            <div class="form-group" style="margin-top: 20px">
              <label class="form-label">Ø®ÙŠØ§Ø±Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©</label>
              <div
                style="
                  display: flex;
                  gap: 10px;
                  align-items: center;
                  background: var(--bg);
                  padding: 15px;
                  border-radius: 10px;
                  border: 1px solid var(--border-color);
                "
              >
                <input
                  type="checkbox"
                  id="set-useTableNumbers"
                  style="width: 20px; height: 20px"
                />
                <label
                  for="set-useTableNumbers"
                  style="cursor: pointer; font-weight: bold"
                  >ØªÙØ¹ÙŠÙ„ Ù†Ø¸Ø§Ù… Ø§Ù„Ø·Ø§ÙˆÙ„Ø§Øª (Table Numbers)</label
                >
              </div>
              <div
                style="
                  display: flex;
                  gap: 10px;
                  align-items: center;
                  background: var(--bg);
                  padding: 15px;
                  border-radius: 10px;
                  border: 1px solid var(--border-color);
                  margin-top: 10px;
                "
              >
                <input
                  type="checkbox"
                  id="set-enableCoupons"
                  style="width: 20px; height: 20px"
                />
                <label
                  for="set-enableCoupons"
                  style="cursor: pointer; font-weight: bold"
                  >ØªÙØ¹ÙŠÙ„ Ø§Ù„ÙƒÙˆØ¨ÙˆÙ†Ø§Øª (Coupons)</label
                >
              </div>
            </div>

            <div class="form-group" style="margin-top: 20px">
              <label class="form-label">Ø±Ù‚Ù… Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨ Ù„Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</label>
              <input
                type="text"
                id="set-whatsapp"
                placeholder="Ù…Ø«Ø§Ù„: 01000000000"
                style="font-size: 16px; font-weight: bold; letter-spacing: 1px"
              />
            </div>

            <button
              class="btn btn-success"
              onclick="saveSettings()"
              style="margin-top: 20px; font-size: 16px"
            >
              <i class="fas fa-save"></i> Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
            </button>
          </div>
        </div>

        <div id="view-design" class="hidden">
          <div
            style="
              display: flex;
              gap: 20px;
              flex-wrap: wrap;
              height: calc(100vh - 100px);
            "
          >
            <div
              class="card"
              style="flex: 1; min-width: 300px; overflow-y: auto; height: 100%"
            >
              <h3 style="color: var(--primary); margin-top: 0">
                <i class="fas fa-paint-brush"></i> Ø³ØªÙˆØ¯ÙŠÙˆ Ø§Ù„ØªØµÙ…ÙŠÙ…
              </h3>

              <div
                class="form-group"
                style="
                  background: var(--bg);
                  padding: 15px;
                  border-radius: 12px;
                  border: 1px solid var(--border-color);
                  margin-bottom: 25px;
                "
              >
                <div
                  style="
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    margin-bottom: 10px;
                  "
                >
                  <label
                    class="form-label"
                    style="color: var(--primary); margin: 0"
                    ><i class="fas fa-magic"></i> Ø§Ø®ØªØ± Ù‚Ø§Ù„Ø¨ Ø¬Ø§Ù‡Ø²</label
                  >
                  <small style="color: var(--secondary)"
                    >Ø£Ùˆ ØµÙ…Ù… Ø¨Ù†ÙØ³Ùƒ Ù…Ù† Ø§Ù„Ø£Ø³ÙÙ„ ğŸ‘‡</small
                  >
                </div>
                <div
                  class="theme-grid"
                  id="theme-library"
                  style="
                    display: grid;
                    grid-template-columns: repeat(auto-fill, minmax(70px, 1fr));
                    gap: 10px;
                  "
                ></div>
              </div>

              <div class="form-group">
                <label class="form-label">Ø·Ø±ÙŠÙ‚Ø© Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª (Layout)</label>
                <div
                  style="
                    display: grid;
                    grid-template-columns: repeat(3, 1fr);
                    gap: 8px;
                  "
                >
                  <button
                    class="btn-layout active"
                    onclick="setUiParam('layoutType', 'modern')"
                    id="btn-layout-modern"
                  >
                    <i class="fas fa-bolt"></i> Ù…ÙˆØ¯Ø±Ù†
                  </button>
                  <button
                    class="btn-layout"
                    onclick="setUiParam('layoutType', 'grid')"
                    id="btn-layout-grid"
                  >
                    <i class="fas fa-th-large"></i> Ø´Ø¨ÙƒØ©
                  </button>
                  <button
                    class="btn-layout"
                    onclick="setUiParam('layoutType', 'list')"
                    id="btn-layout-list"
                  >
                    <i class="fas fa-list-ul"></i> Ù‚Ø§Ø¦Ù…Ø©
                  </button>
                  <button
                    class="btn-layout"
                    onclick="setUiParam('layoutType', 'focus')"
                    id="btn-layout-focus"
                  >
                    <i class="fas fa-camera-retro"></i> ÙÙˆÙƒØ³ (ØµÙˆØ±)
                  </button>
                  <button
                    class="btn-layout"
                    onclick="setUiParam('layoutType', 'minimal')"
                    id="btn-layout-minimal"
                  >
                    <i class="fas fa-align-right"></i> ØªÙƒØ³Øª (Ø³Ø±ÙŠØ¹)
                  </button>
                </div>
              </div>

              <div class="form-group">
                <label class="form-label">Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ</label>
                <input
                  type="color"
                  id="ui-primaryColor"
                  oninput="setUiParam('primaryColor', this.value)"
                  style="height: 50px; cursor: pointer"
                />
              </div>

              <div class="form-group">
                <label class="form-label">Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù‡ÙŠØ¯Ø± ÙˆØ§Ù„ØºÙ„Ø§Ù</label>
                <div
                  style="
                    display: flex;
                    align-items: center;
                    gap: 10px;
                    margin-bottom: 15px;
                  "
                >
                  <img
                    id="hero-preview"
                    class="img-preview"
                    style="width: 50px; height: 50px"
                  />
                  <label
                    for="ui-heroFile"
                    class="custom-file-upload"
                    style="margin: 0"
                  >
                    <i class="fas fa-cloud-upload-alt"></i> Ø±ÙØ¹ ØµÙˆØ±Ø© Ø§Ù„ØºÙ„Ø§Ù
                  </label>
                  <input
                    type="file"
                    id="ui-heroFile"
                    accept="image/*"
                    onchange="handleHeroUpload(this)"
                  />
                </div>

                <div
                  style="
                    background: var(--bg);
                    padding: 10px;
                    border-radius: 10px;
                    border: 1px solid var(--border-color);
                  "
                >
                  <div
                    style="
                      display: flex;
                      align-items: center;
                      gap: 10px;
                      margin-bottom: 10px;
                    "
                  >
                    <i
                      class="fas fa-adjust"
                      style="color: var(--secondary)"
                    ></i>
                    <input
                      type="range"
                      min="0"
                      max="90"
                      value="30"
                      id="ui-heroOverlay"
                      oninput="setUiParam('heroOverlay', this.value)"
                      style="flex: 1"
                    />
                    <span style="font-size: 12px; width: 50px">ØªØ¹ØªÙŠÙ…</span>
                  </div>
                  <div style="display: flex; align-items: center; gap: 10px">
                    <i
                      class="fas fa-arrows-alt-v"
                      style="color: var(--secondary)"
                    ></i>
                    <input
                      type="range"
                      min="150"
                      max="500"
                      value="200"
                      id="ui-heroHeight"
                      oninput="setUiParam('heroHeight', this.value)"
                      style="flex: 1"
                    />
                    <span style="font-size: 12px; width: 50px">Ø§Ø±ØªÙØ§Ø¹</span>
                  </div>
                </div>
              </div>

              <div class="form-group">
                <label class="form-label">Ø®Ù„ÙÙŠØ© Ø§Ù„ØµÙØ­Ø©</label>
                <select
                  id="ui-bgType"
                  onchange="toggleBgInput()"
                  style="margin-bottom: 10px"
                >
                  <option value="color">Ù„ÙˆÙ† Ø«Ø§Ø¨Øª</option>
                  <option value="pattern">Ù†Ù…Ø· (Pattern)</option>
                  <option value="image">ØµÙˆØ±Ø© Ø±Ø§Ø¨Ø·</option>
                </select>
                <input
                  type="color"
                  id="ui-bgColor"
                  oninput="setUiParam('bgValue', this.value)"
                  style="height: 50px"
                />
                <div
                  id="ui-bgImage-container"
                  class="hidden"
                  style="margin-top: 10px"
                >
                  <div style="display: flex; align-items: center; gap: 10px">
                    <img
                      id="bg-preview"
                      class="img-preview"
                      style="width: 50px; height: 50px"
                    />
                    <label
                      for="ui-bgFile"
                      class="custom-file-upload"
                      style="margin: 0"
                    >
                      <i class="fas fa-cloud-upload-alt"></i> Ø§Ø®ØªØ± ØµÙˆØ±Ø©
                    </label>
                    <input
                      type="file"
                      id="ui-bgFile"
                      accept="image/*"
                      onchange="handleBgUpload(this)"
                    />
                  </div>
                  <small
                    style="
                      color: var(--secondary);
                      display: block;
                      margin-top: 5px;
                    "
                    >ÙŠÙØ¶Ù„ ØµÙˆØ±Ø© Ø·ÙˆÙ„ÙŠØ© Ø¹Ø§Ù„ÙŠØ© Ø§Ù„Ø¬ÙˆØ¯Ø©</small
                  >
                </div>
              </div>

              <div class="form-group">
                <label class="form-label">Ø³ØªØ§ÙŠÙ„ Ø§Ù„ÙƒØ§Ø±Øª</label>
                <select
                  id="ui-cardStyle"
                  onchange="setUiParam('cardStyle', this.value)"
                >
                  <option value="solid">Ù…ØµÙ…Øª (Solid)</option>
                  <option value="glass">Ø²Ø¬Ø§Ø¬ÙŠ (Glassmorphism)</option>
                  <option value="outlined">Ø¥Ø·Ø§Ø± ÙÙ‚Ø·</option>
                </select>
              </div>

              <div class="form-group">
                <label class="form-label"
                  >Ø§Ù†Ø­Ù†Ø§Ø¡ Ø§Ù„Ø­ÙˆØ§Ù (Radius):
                  <span id="radius-val">16</span>px</label
                >
                <input
                  type="range"
                  min="0"
                  max="50"
                  id="ui-cardRadius"
                  oninput="setUiParam('cardRadius', this.value)"
                />
              </div>

              <div class="form-group">
                <label class="form-label">Ù†ÙˆØ¹ Ø§Ù„Ø®Ø·</label>
                <select
                  id="ui-fontFamily"
                  onchange="setUiParam('fontFamily', this.value)"
                >
                  <option value="Tajawal">Tajawal (Ø§ÙØªØ±Ø§Ø¶ÙŠ)</option>
                  <option value="Cairo">Cairo (Ø±Ø³Ù…ÙŠ)</option>
                  <option value="Almarai">Almarai (Ø¹ØµØ±ÙŠ)</option>
                  <option value="Amiri">Amiri (ÙƒÙ„Ø§Ø³ÙŠÙƒ)</option>
                  <option value="Zain">Zain (Ø´Ø¨Ø§Ø¨ÙŠ)</option>
                </select>
              </div>

              <div style="display: flex; gap: 10px; margin-top: 20px">
                <button
                  class="btn btn-outline"
                  onclick="resetDesign()"
                  style="
                    flex: 1;
                    border-color: var(--danger);
                    color: var(--danger);
                  "
                >
                  <i class="fas fa-undo"></i> Ø§ÙØªØ±Ø§Ø¶ÙŠ
                </button>
                <button
                  class="btn btn-success"
                  onclick="saveDesignSettings()"
                  style="flex: 2; font-size: 16px"
                >
                  <i class="fas fa-save"></i> Ø­ÙØ¸
                </button>
              </div>
            </div>

            <div
              style="
                flex: 1;
                min-width: 320px;
                display: flex;
                justify-content: center;
                align-items: center;
                background: #333;
                border-radius: 20px;
                padding: 20px;
              "
            >
              <div class="phone-frame">
                <div class="notch"></div>
                <iframe
                  id="live-preview"
                  src=""
                  style="
                    width: 100%;
                    height: 100%;
                    border: none;
                    background: white;
                  "
                ></iframe>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <input type="hidden" id="restaurant-id" />

    <script>
      const urlParams = new URLSearchParams(window.location.search);
      const urlToken = urlParams.get("t");

      if (urlToken) {
        sessionStorage.setItem("ownerToken", urlToken);

        window.history.replaceState(
          {},
          document.title,
          window.location.pathname,
        );
      }

      let token = sessionStorage.getItem("ownerToken");

      let categoriesData = [];
      let editingProductId = null;
      let currentUserRole = null;
      let serverTimeOffset = 0;

      if (localStorage.getItem("theme") === "dark") {
        document.body.classList.add("dark-mode");
      }

      async function initDashboard() {
        try {
          const res = await fetch("/api/v1/restaurants/my-restaurant", {
            headers: { Authorization: `Bearer ${token}` },
          });

          const serverDateHeader = res.headers.get("date");
          if (serverDateHeader) {
            const serverTime = new Date(serverDateHeader).getTime();
            const localTime = Date.now();
            serverTimeOffset = serverTime - localTime;
            console.log("Server Time Offset:", serverTimeOffset);
          }

          const result = await res.json();

          if (result.status === "success") {
            document.getElementById("restaurant-id").value =
              result.data.restaurant._id;
            document.getElementById("preview-link").href =
              `/menu/${result.data.restaurant.slug}`;

            document.getElementById("set-orderMode").value =
              result.data.restaurant.orderMode || "whatsapp";
            document.getElementById("set-taxRate").value =
              result.data.restaurant.taxRate || 0;
            document.getElementById("set-serviceRate").value =
              result.data.restaurant.serviceRate || 0;
            document.getElementById("set-useTableNumbers").checked =
              result.data.restaurant.useTableNumbers === true;
            document.getElementById("set-enableCoupons").checked =
              result.data.restaurant.enableCoupons === true;
            if (result.data.restaurant.contactInfo) {
              document.getElementById("set-whatsapp").value =
                result.data.restaurant.contactInfo.whatsapp || "";
            }

            applyPermissions(result.data.userRole);
            currentUserRole = result.data.userRole;

            const roleNames = {
              owner: "Ø§Ù„Ù…Ø§Ù„Ùƒ",
              cashier: "Ø§Ù„ÙƒØ§Ø´ÙŠØ±",
              kitchen: "Ø§Ù„Ù…Ø·Ø¨Ø®",
            };
            const roleAr = roleNames[currentUserRole] || currentUserRole;
            const userName =
              sessionStorage.getItem("currentUserName") || "Ù…Ø³ØªØ®Ø¯Ù…";

            document.getElementById("page-title").innerHTML = `
                        <div>${result.data.restaurant.restaurantName}</div>
                        <div style="font-size:14px; color:var(--secondary); font-weight:normal; margin-top:5px;">
                            <i class="fas fa-user-circle"></i> ${userName} <span class="badge" style="background:var(--primary); color:white; font-size:12px;">${roleAr}</span>
                        </div>
                    `;

            document
              .getElementById("dashboard-section")
              .classList.remove("hidden");
            if (
              result.data.userRole === "cashier" ||
              result.data.userRole === "kitchen"
            ) {
              checkShiftStatus(result.data.userRole);
            }
            if (result.data.userRole === "owner") {
              loadCategories();
              loadProducts();
              initDesignStudio(result.data.restaurant);
            }

            const lastView = localStorage.getItem("lastActiveView");
            if (result.data.userRole === "kitchen") switchView("orders");
            else if (result.data.userRole === "cashier") {
              if (lastView === "history") switchView("history");
              else switchView("orders");
            } else {
              if (lastView && lastView !== "orders") switchView(lastView);
              else switchView("categories");
            }
          } else {
            if (res.status === 401) {
              sessionStorage.removeItem("ownerToken");
              window.location.href = "/login";
            } else {
              Swal.fire({
                icon: "warning",
                title: "ØªÙ†Ø¨ÙŠÙ‡",
                text: result.message || "Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª",
              }).then(() => {
                window.location.href = "/login";
              });
            }
          }
        } catch (e) {
          console.error(e);
          Swal.fire("Ø®Ø·Ø£", "ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±", "error");
        }
      }
      function toggleDarkMode() {
        document.body.classList.toggle("dark-mode");
        localStorage.setItem(
          "theme",
          document.body.classList.contains("dark-mode") ? "dark" : "light",
        );
      }

      function toggleSidebar() {
        const sidebar = document.getElementById("sidebar");
        const overlay = document.querySelector(".overlay");
        
        if (sidebar.classList.contains("active")) {
            sidebar.classList.remove("active");
            overlay.classList.remove("visible");
            setTimeout(() => { overlay.style.display = "none"; }, 300);
        } else {
            overlay.style.display = "block";
            // Timeout to allow display:block to apply before opacity transition
            setTimeout(() => { 
                sidebar.classList.add("active");
                overlay.classList.add("visible");
            }, 10);
        }
      }
      function previewImage(input, previewId) {
        const preview = document.getElementById(previewId);
        if (input.files && input.files[0]) {
          const reader = new FileReader();
          reader.onload = function (e) {
            preview.src = e.target.result;
            preview.style.display = "block";
          };
          reader.readAsDataURL(input.files[0]);
        } else {
          preview.src = "";
          preview.style.display = "none";
        }
      }

function switchView(viewName) {
        // 1. Scroll to top automatically
        window.scrollTo({ top: 0, behavior: 'smooth' });

        // 2. Hide all views and remove active states
        const allViews = ["categories", "products", "bulk", "design", "orders", "history", "settings", "staff", "coupons"];
        
        allViews.forEach((v) => {
            const el = document.getElementById(`view-${v}`);
            if (el) {
                el.classList.add("hidden");
                el.classList.remove("view-animate"); // Reset animation
            }

            // Desktop Sidebar
            const nav = document.getElementById(`nav-${v}`);
            if (nav) nav.classList.remove("active");
            
            // Mobile Bottom Nav
            const mobNav = document.getElementById(`mob-nav-${v}`);
            if (mobNav) mobNav.classList.remove("active");
        });

        // 3. Show Target View with Animation
        const targetEl = document.getElementById(`view-${viewName}`);
        if (targetEl) {
            targetEl.classList.remove("hidden");
            // Trigger reflow to restart animation
            void targetEl.offsetWidth; 
            targetEl.classList.add("view-animate");
        }

        // 4. Update Active Buttons
        const targetNav = document.getElementById(`nav-${viewName}`);
        if (targetNav) targetNav.classList.add("active");

        const targetMobNav = document.getElementById(`mob-nav-${viewName}`);
        if (targetMobNav) targetMobNav.classList.add("active");

        // 5. Close Mobile Sidebar if Open
        if (window.innerWidth <= 768) {
            const sidebar = document.getElementById("sidebar");
            const overlay = document.querySelector(".overlay");
            if (sidebar && sidebar.classList.contains("active")) {
                sidebar.classList.remove("active");
            }
            if (overlay) {
                overlay.classList.remove("visible");
                setTimeout(() => { overlay.style.display = 'none'; }, 300);
            }
        }

        // 6. View Specific Logic (Load Data)
        if (viewName === "orders") {
            const badge = document.getElementById("live-badge");
            if (badge) { badge.innerText = "0"; badge.classList.add("hidden"); }
            
            const mobBadge = document.getElementById("mob-badge");
            if (mobBadge) mobBadge.classList.add("hidden");

            if (typeof window.loadOrders === 'function') window.loadOrders();
        }

        if (viewName === "bulk") {
            const bulkContainer = document.getElementById("bulk-container");
            if (bulkContainer && bulkContainer.innerHTML.trim() === "") {
                if (typeof addBulkRow === 'function') addBulkRow();
            }
        }

        if (viewName === "history") {
            if (typeof window.loadHistory === 'function') window.loadHistory();
        }

        if (viewName === "coupons") {
            if (typeof loadCoupons === 'function') loadCoupons();
        }
      }
      function isNumberKey(evt) {
        var charCode = evt.which ? evt.which : evt.keyCode;
        if (charCode != 46 && charCode > 31 && (charCode < 48 || charCode > 57))
          return false;
        return true;
      }

      function logout() {
        sessionStorage.removeItem("ownerToken");
        localStorage.removeItem("ownerToken");
        location.reload();
      }

      async function saveSettings() {
        const rId = document.getElementById("restaurant-id").value;
        const orderMode = document.getElementById("set-orderMode").value;
        const useTables = document.getElementById(
          "set-useTableNumbers",
        ).checked;
        const enableCoupons =
          document.getElementById("set-enableCoupons").checked;
        const whatsapp = document.getElementById("set-whatsapp").value;
        const taxRate = document.getElementById("set-taxRate").value;
        const serviceRate = document.getElementById("set-serviceRate").value;

        const bodyData = {
          orderMode: orderMode,
          taxRate: taxRate,
          serviceRate: serviceRate,
          useTableNumbers: useTables,
          enableCoupons: enableCoupons,
          contactInfo: {
            whatsapp: whatsapp,
          },
        };

        Swal.showLoading();
        try {
          const res = await fetch(`/api/v1/restaurants/${rId}`, {
            method: "PATCH",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${token}`,
            },
            body: JSON.stringify(bodyData),
          });

          if (res.ok) {
            Swal.fire({
              icon: "success",
              title: "ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª",
              showConfirmButton: false,
              timer: 1500,
            });
          } else {
            throw new Error("ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸");
          }
        } catch (e) {
          console.error(e);
          Swal.fire("Ø®Ø·Ø£", "Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­ÙØ¸", "error");
        }
      }

      async function loadCategories() {
        const rId = document.getElementById("restaurant-id").value;
        const list = document.getElementById("categories-list");

        const statCats = document.getElementById("stat-total-cats");
        const statProds = document.getElementById("stat-total-prods");

        try {
          const res = await fetch(`/api/v1/categories/${rId}`, {
            headers: { Authorization: `Bearer ${token}` },
          });

          if (res.status === 401) return;

          const result = await res.json();

          if (result.status === "success") {
            categoriesData = result.data.categories;
            updateCategoryDropdowns();
            list.innerHTML = "";

            if (result.data.stats) {
              if (statCats) statCats.innerText = result.data.stats.totalCats;
              if (statProds) statProds.innerText = result.data.stats.totalProds;
            }

            if (categoriesData.length === 0) {
              list.innerHTML =
                '<tr><td colspan="4" style="text-align:center; padding:20px; color:#94a3b8">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ù‚Ø³Ø§Ù… Ù…Ø¶Ø§ÙØ©</td></tr>';
              return;
            }

            categoriesData.forEach((cat) => {
              const img = cat.image
                ? `<img src="${cat.image}" style="width:40px; height:40px; border-radius:8px; object-fit:cover">`
                : '<i class="fas fa-folder" style="font-size:24px; color:#cbd5e1"></i>';

              const countBadgeColor =
                cat.productCount > 0
                  ? "background:var(--primary-light); color:var(--primary)"
                  : "background:#f1f5f9; color:#64748b";

              list.innerHTML += `
    <tr>
        <td>${img}</td>
        <td style="font-weight:bold">${cat.name}</td>
        <td>
            <span class="badge" style="${countBadgeColor}; font-size:13px">
                ${cat.productCount || 0} Ù…Ù†ØªØ¬
            </span>
        </td>
        <td>
             <button class="btn btn-outline" style="padding:5px 10px; color:var(--primary); border-color:var(--primary)" 
                onclick="editCategory('${cat._id}', '${cat.name}', '${cat.image || ""}')">
                <i class="fas fa-pen"></i>
            </button>
            <button class="btn btn-outline" style="padding:5px 10px; color:var(--danger); border-color:var(--danger)" onclick="deleteCategory('${cat._id}')"><i class="fas fa-trash"></i></button>
        </td>
    </tr>
`;
            });
          }
        } catch (e) {
          console.error("Error loading categories:", e);
          list.innerHTML =
            '<tr><td colspan="4" style="text-align:center; color:red">Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</td></tr>';
        }
      }
      function updateCategoryDropdowns() {
        const select = document.getElementById("p-cat");
        const currentVal = select.value;
        select.innerHTML = '<option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ù‚Ø³Ù… --</option>';
        categoriesData.forEach((cat) => {
          const option = document.createElement("option");
          option.value = cat.name;
          option.innerText = cat.name;
          select.appendChild(option);
        });
        if (currentVal) select.value = currentVal;
      }

      async function addCategory() {
        const name = document.getElementById("c-name").value;
        const imageFile = document.getElementById("c-image").files[0];
        const rId = document.getElementById("restaurant-id").value;

        if (!name) return Swal.fire("ØªÙ†Ø¨ÙŠÙ‡", "Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ù‚Ø³Ù…", "warning");

        const formData = new FormData();
        formData.append("name", name);
        formData.append("restaurantId", rId);
        if (imageFile) formData.append("image", imageFile);

        Swal.showLoading();

        try {
          const res = await fetch("/api/v1/categories", {
            method: "POST",
            headers: { Authorization: `Bearer ${token}` },
            body: formData,
          });

          if (res.status === 401) {
            sessionStorage.removeItem("ownerToken");
            window.location.href = "/login";
            return;
          }

          const data = await res.json();
          Swal.close();

          if (data.status === "success") {
            document.getElementById("c-name").value = "";
            document.getElementById("c-image").value = "";
            document.getElementById("c-preview").style.display = "none";
            loadCategories();
            Swal.fire({ toast: true, icon: "success", title: "ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ©" });
          } else {
            Swal.fire("Ø®Ø·Ø£", data.message || "ÙØ´Ù„ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù‚Ø³Ù…", "error");
          }
        } catch (e) {
          console.error(e);
          Swal.fire("Ø®Ø·Ø£", "Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±", "error");
        }
      }
      async function deleteCategory(id) {
        if (
          (
            await Swal.fire({
              title: "Ø­Ø°Ù Ø§Ù„Ù‚Ø³Ù…ØŸ",
              text: "Ø³ÙŠØªÙ… Ø­Ø°Ù Ø§Ù„Ù‚Ø³Ù… ÙˆØ¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø¨Ø¯Ø§Ø®Ù„Ù‡!",
              icon: "warning",
              showCancelButton: true,
              confirmButtonColor: "#ef4444",
              confirmButtonText: "Ù†Ø¹Ù…ØŒ Ø§Ø­Ø°Ù",
              cancelButtonText: "Ø¥Ù„ØºØ§Ø¡",
            })
          ).isConfirmed
        ) {
          try {
            const res = await fetch(`/api/v1/categories/${id}`, {
              method: "DELETE",
              headers: { Authorization: `Bearer ${token}` },
            });

            if (res.status === 401) {
              window.location.href = "/login";
              return;
            }

            if (res.ok) {
              Swal.fire({ toast: true, icon: "success", title: "ØªÙ… Ø§Ù„Ø­Ø°Ù" });
              loadCategories();
            } else {
              Swal.fire("Ø®Ø·Ø£", "ÙØ´Ù„ Ø§Ù„Ø­Ø°Ù", "error");
            }
          } catch (e) {
            Swal.fire("Ø®Ø·Ø£", "Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„", "error");
          }
        }
      }

      async function saveCategory() {
        const id = document.getElementById("edit-cat-id").value;
        const name = document.getElementById("c-name").value;
        const imageFile = document.getElementById("c-image").files[0];
        const rId = document.getElementById("restaurant-id").value;

        if (!name) return Swal.fire("ØªÙ†Ø¨ÙŠÙ‡", "Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ù‚Ø³Ù…", "warning");

        const formData = new FormData();
        formData.append("name", name);
        if (imageFile) formData.append("image", imageFile);

        let url = "/api/v1/categories";
        let method = "POST";

        if (id) {
          url = `/api/v1/categories/${id}`;
          method = "PATCH";
        } else {
          formData.append("restaurantId", rId);
        }

        Swal.showLoading();
        try {
          const res = await fetch(url, {
            method: method,
            headers: { Authorization: `Bearer ${token}` },
            body: formData,
          });
          const data = await res.json();
          Swal.close();

          if (data.status === "success") {
            resetCategoryForm();
            loadCategories();
            Swal.fire({
              toast: true,
              icon: "success",
              title: id ? "ØªÙ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„" : "ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ©",
            });
          } else {
            Swal.fire("Ø®Ø·Ø£", data.message, "error");
          }
        } catch (e) {
          console.error(e);
          Swal.fire("Ø®Ø·Ø£", "Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„", "error");
        }
      }

      function editCategory(id, name, image) {
        document.getElementById("edit-cat-id").value = id;
        document.getElementById("c-name").value = name;
        document.getElementById("cat-form-title").innerText =
          "ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù‚Ø³Ù…: " + name;
        document.getElementById("btn-save-cat").innerHTML =
          '<i class="fas fa-save"></i> ØªØ­Ø¯ÙŠØ«';
        document.getElementById("btn-save-cat").classList.remove("btn-primary");
        document.getElementById("btn-save-cat").style.backgroundColor =
          "var(--warning)";
        document.getElementById("btn-save-cat").style.color = "white";
        document.getElementById("btn-cancel-cat").classList.remove("hidden");

        if (image) {
          document.getElementById("c-preview").src = image;
          document.getElementById("c-preview").style.display = "block";
        } else {
          document.getElementById("c-preview").style.display = "none";
        }
        window.scrollTo({ top: 0, behavior: "smooth" });
      }

      function resetCategoryForm() {
        document.getElementById("edit-cat-id").value = "";
        document.getElementById("c-name").value = "";
        document.getElementById("c-image").value = "";
        document.getElementById("c-preview").style.display = "none";
        document.getElementById("cat-form-title").innerText = "Ø¥Ø¶Ø§ÙØ© Ù‚Ø³Ù… Ø¬Ø¯ÙŠØ¯";
        document.getElementById("btn-save-cat").innerHTML =
          '<i class="fas fa-plus"></i> Ø­ÙØ¸';
        document.getElementById("btn-save-cat").classList.add("btn-primary");
        document.getElementById("btn-save-cat").style.backgroundColor = "";
        document.getElementById("btn-save-cat").style.color = "";
        document.getElementById("btn-cancel-cat").classList.add("hidden");
      }

      function searchTable() {
        let input = document.getElementById("searchInput").value.toLowerCase();
        let rows = document.querySelectorAll("#products-list tr");
        rows.forEach((row) => {
          let text = row.innerText.toLowerCase();
          row.style.display = text.includes(input) ? "" : "none";
        });
      }

      async function loadProducts() {
        const rId = document.getElementById("restaurant-id").value;
        const tbody = document.getElementById("products-list");

        try {
          const res = await fetch(`/api/v1/products/restaurant/${rId}`, {
            headers: { Authorization: `Bearer ${token}` },
          });

          if (res.status === 401) {
            sessionStorage.removeItem("ownerToken");
            window.location.href = "/login";
            return;
          }

          const result = await res.json();

          if (result.status === "success") {
            tbody.innerHTML = "";

            if (result.data.products.length === 0) {
              tbody.innerHTML =
                '<tr><td colspan="6" style="text-align:center; padding:20px; color:#94a3b8">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†</td></tr>';
              return;
            }

            result.data.products.forEach((p) => {
              const img = p.image
                ? `<img src="${p.image}" style="width:40px; height:40px; border-radius:8px; object-fit:cover">`
                : '<span style="color:#ccc">â€”</span>';

              const pData = encodeURIComponent(JSON.stringify(p));

              const toggleIcon = p.isAvailable
                ? '<i class="fas fa-eye"></i>'
                : '<i class="fas fa-eye-slash"></i>';

              const toggleClass = "btn-outline";

              const toggleStyle = p.isAvailable
                ? "color:var(--success); border-color:var(--success)"
                : "color:#94a3b8";

              tbody.innerHTML += `
                    <tr>
                        <td>${img}</td>
                        <td style="font-weight:bold; color:var(--text-main)">${p.name.ar}</td>
                        <td><span class="badge badge-cat">${p.category}</span></td>
                        <td style="color:var(--primary); font-weight:bold">${p.price}</td>
                        <td>
                            <button onclick="toggleProd('${p._id}')" class="btn ${toggleClass}" style="padding:5px 10px; ${toggleStyle}" title="ØªØºÙŠÙŠØ± Ø§Ù„Ø­Ø§Ù„Ø©">${toggleIcon}</button>
                        </td>
                        <td>
                            <button onclick="editProd('${pData}')" class="btn btn-outline" style="padding:5px 10px; color:var(--primary); border-color:var(--primary)"><i class="fas fa-pen"></i></button>
                            <button onclick="deleteProd('${p._id}')" class="btn btn-outline" style="padding:5px 10px; color:var(--danger); border-color:var(--danger)"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>
                `;
            });
          } else {
            console.error("Failed to load products:", result.message);
            tbody.innerHTML = `<tr><td colspan="6" style="text-align:center; color:red">ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª: ${result.message}</td></tr>`;
          }
        } catch (e) {
          console.error("Error loading products:", e);
          tbody.innerHTML = `<tr><td colspan="6" style="text-align:center; color:red">Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±</td></tr>`;
        }
      }

      async function saveProduct(method) {
        const url =
          method === "POST"
            ? "/api/v1/products"
            : `/api/v1/products/${editingProductId}`;
        const name = document.getElementById("p-name").value;
        const cat = document.getElementById("p-cat").value;
        const desc = document.getElementById("p-desc").value;
        const imageFile = document.getElementById("p-image").files[0];
        const pricingMode = document.querySelector(
          'input[name="pricingMode"]:checked',
        ).value;

        if (!name || !cat)
          return Swal.fire("Ù†Ø§Ù‚Øµ Ø¨ÙŠØ§Ù†Ø§Øª", "Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ù„Ù‚Ø³Ù… Ù…Ø·Ù„ÙˆØ¨ÙŠÙ†", "warning");

        const formData = new FormData();
        formData.append(
          "restaurantId",
          document.getElementById("restaurant-id").value,
        );
        formData.append("category", cat);
        formData.append("name", JSON.stringify({ ar: name, en: name }));
        formData.append("description", JSON.stringify({ ar: desc, en: "" }));
        if (imageFile) formData.append("image", imageFile);

        if (pricingMode === "single") {
          const price = parseFloat(document.getElementById("p-price").value);
          if (!price) return Swal.fire("ØªÙ†Ø¨ÙŠÙ‡", "ÙŠØ¬Ø¨ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø³Ø¹Ø±", "warning");

          let oldPriceInput =
            parseFloat(document.getElementById("p-old-price").value) || 0;

          if (oldPriceInput <= price) {
            oldPriceInput = 0;
          }

          formData.append("price", price);
          formData.append("oldPrice", oldPriceInput);
          formData.append("sizes", JSON.stringify([]));
        } else {
          const rows = document.querySelectorAll(".size-row");
          let sizesArr = [];
          rows.forEach((row) => {
            const sName = row.querySelector(".s-name").value;
            const sPrice = Number(row.querySelector(".s-price").value);
            let sOld = Number(row.querySelector(".s-old").value) || 0;

            if (sOld <= sPrice) sOld = 0;

            if (sName && sPrice) {
              sizesArr.push({ name: sName, price: sPrice, oldPrice: sOld });
            }
          });

          if (sizesArr.length === 0)
            return Swal.fire(
              "ØªÙ†Ø¨ÙŠÙ‡",
              "ÙŠØ¬Ø¨ Ø¥Ø¶Ø§ÙØ© Ø­Ø¬Ù… ÙˆØ§Ø­Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„",
              "warning",
            );

          formData.append("price", sizesArr[0].price);
          formData.append("sizes", JSON.stringify(sizesArr));
        }

        const headers = { Authorization: `Bearer ${token}` };

        Swal.showLoading();
        try {
          const res = await fetch(url, {
            method: method,
            headers: headers,
            body: formData,
          });
          const data = await res.json();

          if (data.status === "success") {
            Swal.close();
            loadProducts();
            resetProductForm();
            Swal.fire({
              toast: true,
              icon: "success",
              title: "ØªÙ… Ø§Ù„Ø­ÙØ¸ Ø¨Ù†Ø¬Ø§Ø­",
            });
          } else {
            throw new Error(data.message);
          }
        } catch (e) {
          Swal.fire("Ø®Ø·Ø£", e.message || "ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸", "error");
        }
      }

      function editProd(dataEncoded) {
        const p = JSON.parse(decodeURIComponent(dataEncoded));
        editingProductId = p._id;

        document.getElementById("p-name").value = p.name.ar;
        document.getElementById("p-cat").value = p.category;
        document.getElementById("p-desc").value = p.description
          ? p.description.ar
          : "";

        if (p.image) {
          document.getElementById("p-preview").src = p.image;
          document.getElementById("p-preview").style.display = "block";
        } else {
          document.getElementById("p-preview").style.display = "none";
        }

        const sizesList = document.getElementById("sizes-list");
        sizesList.innerHTML = "";

        if (p.sizes && p.sizes.length > 0) {
          document.querySelector(
            'input[name="pricingMode"][value="multi"]',
          ).checked = true;
          p.sizes.forEach((s) => addSizeRow(s.name, s.price, s.oldPrice));
        } else {
          document.querySelector(
            'input[name="pricingMode"][value="single"]',
          ).checked = true;
          document.getElementById("p-price").value = p.price;
          document.getElementById("p-old-price").value =
            p.oldPrice && p.oldPrice > 0 ? p.oldPrice : "";
        }

        togglePricingMode();

        document.getElementById("form-mode-title").innerText =
          `ØªØ¹Ø¯ÙŠÙ„: ${p.name.ar}`;
        document.getElementById("btn-add-prod").classList.add("hidden");
        document.getElementById("btn-update-prod").classList.remove("hidden");
        document.getElementById("btn-cancel").classList.remove("hidden");
        window.scrollTo({ top: 0, behavior: "smooth" });
      }

      function resetProductForm() {
        editingProductId = null;
        document.getElementById("p-name").value = "";
        document.getElementById("p-price").value = "";
        document.getElementById("p-cat").value = "";
        document.getElementById("p-desc").value = "";
        document.getElementById("p-image").value = "";
        document.getElementById("p-preview").style.display = "none";
        document.getElementById("form-mode-title").innerText =
          "Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬ Ø¬Ø¯ÙŠØ¯";
        document.getElementById("btn-add-prod").classList.remove("hidden");
        document.getElementById("btn-update-prod").classList.add("hidden");
        document.getElementById("btn-cancel").classList.add("hidden");
      }

      async function toggleProd(id) {
        await fetch(`/api/v1/products/${id}/toggle`, {
          method: "PATCH",
          headers: { Authorization: `Bearer ${token}` },
        });
        loadProducts();
      }

      async function deleteProd(id) {
        if (
          (
            await Swal.fire({
              title: "Ø­Ø°Ù Ø§Ù„Ù…Ù†ØªØ¬ØŸ",
              icon: "warning",
              showCancelButton: true,
            })
          ).isConfirmed
        ) {
          await fetch(`/api/v1/products/${id}`, {
            method: "DELETE",
            headers: { Authorization: `Bearer ${token}` },
          });
          loadProducts();
        }
      }

      function addBulkRow() {
        const container = document.getElementById("bulk-container");
        const rowId = Date.now();

        let catOptions = '<option value="">-- Ø§Ù„Ù‚Ø³Ù… --</option>';
        categoriesData.forEach((cat) => {
          catOptions += `<option value="${cat.name}">${cat.name}</option>`;
        });

        const html = `
        <div class="bulk-card" id="row-${rowId}">
            <button class="btn-remove-row" onclick="removeBulkRow('${rowId}')"><i class="fas fa-times"></i></button>
            
            <div class="form-grid">
                <input type="text" class="b-name" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬">
                
                <div style="background: var(--bg); padding: 10px; border-radius: 8px; border: 1px solid var(--border-color);">
                    <div style="display: flex; gap: 15px; margin-bottom: 10px; font-size: 13px;">
                        <label style="cursor: pointer; display: flex; align-items: center; gap: 5px;">
                            <input type="radio" name="mode-${rowId}" value="single" checked onchange="toggleBulkPricing('${rowId}')"> 
                            Ø³Ø¹Ø± Ù…ÙˆØ­Ø¯
                        </label>
                        <label style="cursor: pointer; display: flex; align-items: center; gap: 5px;">
                            <input type="radio" name="mode-${rowId}" value="multi" onchange="toggleBulkPricing('${rowId}')"> 
                            Ø£Ø­Ø¬Ø§Ù… Ù…ØªØ¹Ø¯Ø¯Ø©
                        </label>
                    </div>

                    <div id="single-inputs-${rowId}" style="display: flex; gap: 5px;">
                        <input type="number" class="b-price" placeholder="Ø§Ù„Ø³Ø¹Ø±" style="flex: 1; font-weight:bold;">
                        <input type="number" class="b-old-price" placeholder="Ø§Ù„Ø³Ø¹Ø± Ù‚Ø¨Ù„ Ø§Ù„Ø®ØµÙ…" style="flex: 1; border:1px dashed var(--danger); background:#fff1f2;">
                    </div>

                    <div id="multi-inputs-${rowId}" class="hidden">
                        <div id="sizes-container-${rowId}" class="bulk-sizes-list"></div>
                        <button class="btn btn-outline" style="width:100%; border-style:dashed; font-size:12px; padding:5px;" onclick="addBulkSizeRow('${rowId}')">
                            <i class="fas fa-plus"></i> Ø¥Ø¶Ø§ÙØ© Ø­Ø¬Ù…
                        </button>
                    </div>
                </div>
            </div>

            <div class="form-grid" style="margin-top:10px">
                <select class="b-cat">${catOptions}</select>
                <div style="display:flex; align-items:center;">
                    <img id="preview-${rowId}" class="img-preview">
                    <label for="img-${rowId}" class="custom-file-upload">
                        <i class="fas fa-cloud-upload-alt"></i> ØµÙˆØ±Ø©
                    </label>
                    <input type="file" id="img-${rowId}" class="b-image" accept="image/*" onchange="previewImage(this, 'preview-${rowId}')">
                </div>
            </div>
            <textarea class="b-desc" rows="1" placeholder="Ø§Ù„ÙˆØµÙ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)" style="margin-top:10px"></textarea>
        </div>
    `;
        container.insertAdjacentHTML("beforeend", html);
      }

      function removeBulkRow(id) {
        document.getElementById(`row-${id}`).remove();
      }

      async function submitBulkAll() {
        const rows = document.querySelectorAll(".bulk-card");
        const rId = document.getElementById("restaurant-id").value;
        let promises = [];
        let validCount = 0;
        for (const row of rows) {
          const name = row.querySelector(".b-name").value;
          const price = row.querySelector(".b-price").value;
          const oldPrice = row.querySelector(".b-old-price")?.value || 0;
          const cat = row.querySelector(".b-cat").value;
          const imageFile = row.querySelector(".b-image").files[0];
          if (name && price && cat) {
            validCount++;
            const currentPrice = parseFloat(price);
            let oldPriceVal =
              parseFloat(row.querySelector(".b-old-price")?.value) || 0;

            if (oldPriceVal <= currentPrice) oldPriceVal = 0;

            const formData = new FormData();
            formData.append("restaurantId", rId);
            formData.append("price", currentPrice);
            formData.append("oldPrice", oldPriceVal);
            formData.append("category", cat);
            formData.append("name", JSON.stringify({ ar: name, en: name }));
            formData.append(
              "description",
              JSON.stringify({
                ar: row.querySelector(".b-desc").value,
                en: "",
              }),
            );
            if (imageFile) formData.append("image", imageFile);
            promises.push(
              fetch("/api/v1/products", {
                method: "POST",
                headers: { Authorization: `Bearer ${token}` },
                body: formData,
              }),
            );
          }
        }
        if (validCount === 0)
          return Swal.fire(
            "ØªÙ†Ø¨ÙŠÙ‡",
            "Ø§Ù…Ù„Ø£ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù†ØªØ¬ ÙˆØ§Ø­Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„",
            "warning",
          );
        Swal.showLoading();
        await Promise.all(promises);
        Swal.close();
        Swal.fire({
          toast: true,
          icon: "success",
          title: `ØªÙ… Ø±ÙØ¹ ${validCount} Ù…Ù†ØªØ¬Ø§Øª`,
        });
        document.getElementById("bulk-container").innerHTML = "";
        addBulkRow();
        loadProducts();
      }

      const themesLibrary = [
        {
          id: "default",
          name: "Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ",
          primary: "#4338ca",
          bg: "#F3F4F6",
          type: "color",
          font: "Tajawal",
          radius: 16,
          style: "solid",
          layout: "modern",
        },
        {
          id: "dark_lux",
          name: "ÙØ®Ø§Ù…Ø©",
          primary: "#D4AF37",
          bg: "#121212",
          type: "color",
          font: "Amiri",
          radius: 8,
          style: "glass",
          layout: "focus",
        },
        {
          id: "fresh",
          name: "ÙØ±ÙŠØ´",
          primary: "#10b981",
          bg: "#ecfdf5",
          type: "color",
          font: "Almarai",
          radius: 24,
          style: "solid",
          layout: "grid",
        },
        {
          id: "burger",
          name: "Ø¨Ø±Ø¬Ø±",
          primary: "#f59e0b",
          bg: "#1f2937",
          type: "color",
          font: "Cairo",
          radius: 30,
          style: "outlined",
          layout: "modern",
        },
        {
          id: "sky",
          name: "Ø³Ù…Ø§ÙˆÙŠ",
          primary: "#0ea5e9",
          bg: "#f0f9ff",
          type: "color",
          font: "Tajawal",
          radius: 12,
          style: "glass",
          layout: "list",
        },
        {
          id: "paper",
          name: "ÙˆØ±Ù‚ÙŠ",
          primary: "#4b5563",
          bg: "#fffbeb",
          type: "color",
          font: "Cairo",
          radius: 4,
          style: "outlined",
          layout: "minimal",
        },
        {
          id: "neon",
          name: "Ù†ÙŠÙˆÙ† (Cyberpunk)",
          primary: "#0ff",
          bg: "#050505",
          type: "color",
          font: "Cairo",
          radius: 0,
          style: "neon",
          layout: "focus",
        },
        {
          id: "soft",
          name: "Ø³ÙˆÙØª (3D)",
          primary: "#8899a6",
          bg: "#e0e5ec",
          type: "color",
          font: "Tajawal",
          radius: 20,
          style: "neumorphism",
          layout: "modern",
        },
        {
          id: "luxury",
          name: "ÙØ®Ø§Ù…Ø© (Royal)",
          primary: "#D4AF37",
          bg: "#1a1a1a",
          type: "pattern",
          font: "Amiri",
          radius: 8,
          style: "glass",
          layout: "magazine",
        },
        {
          id: "brutal",
          name: "Ø¨Ø±ÙˆØªØ§Ù„ (Trend)",
          primary: "#000000",
          bg: "#fffd00",
          type: "color",
          font: "Cairo",
          radius: 0,
          style: "brutalism",
          layout: "zigzag",
        },
        {
          id: "oriental",
          name: "Ø´Ø±Ù‚ÙŠ (Ø£ØµÙŠÙ„)",
          primary: "#c2410c",
          bg: "#fff7ed",
          type: "pattern",
          font: "Amiri",
          radius: 12,
          style: "solid",
          layout: "list",
        },
      ];

      let currentDesign = {
        layoutType: "modern",
        primaryColor: "#B78728",
        bgType: "color",
        bgValue: "#F9F9F9",
        cardStyle: "solid",
        cardRadius: 16,
        fontFamily: "Tajawal",
        heroOverlay: 30,
        heroHeight: 200,
      };

      function initDesignStudio(restaurantData) {
        if (restaurantData.customUI) {
          currentDesign = { ...currentDesign, ...restaurantData.customUI };
        }

        const themeContainer = document.getElementById("theme-library");
        if (themeContainer) {
          themeContainer.innerHTML = "";
          themesLibrary.forEach((t) => {
            const btn = document.createElement("div");
            btn.style.cssText = "cursor:pointer; text-align:center;";
            btn.onclick = () => applyTheme(t.id);
            btn.innerHTML = `
                <div style="height:45px; border-radius:10px; background:${t.bg}; border:2px solid ${t.primary}; position:relative; overflow:hidden; box-shadow:0 2px 5px rgba(0,0,0,0.1); margin-bottom:5px;">
                    <div style="position:absolute; bottom:0; width:100%; height:15px; background:${t.primary}"></div>
                </div>
                <div style="font-size:11px; font-weight:bold; color:var(--secondary)">${t.name}</div>
            `;
            themeContainer.appendChild(btn);
          });
        }

        if (document.getElementById("ui-heroOverlay"))
          document.getElementById("ui-heroOverlay").value =
            currentDesign.heroOverlay || 30;
        if (document.getElementById("ui-heroHeight"))
          document.getElementById("ui-heroHeight").value =
            currentDesign.heroHeight || 200;

        document.getElementById("ui-primaryColor").value =
          currentDesign.primaryColor;
        document.getElementById("ui-bgType").value = currentDesign.bgType;
        document.getElementById("ui-cardStyle").value = currentDesign.cardStyle;
        document.getElementById("ui-cardRadius").value =
          currentDesign.cardRadius;
        document.getElementById("ui-fontFamily").value =
          currentDesign.fontFamily;

        toggleBgInput();
        if (currentDesign.bgType === "color")
          document.getElementById("ui-bgColor").value = currentDesign.bgValue;
        else
          document.getElementById("ui-bgImage").value = currentDesign.bgValue;

        if (currentDesign.heroImage) {
          const heroPreview = document.getElementById("hero-preview");
          heroPreview.src = currentDesign.heroImage.replace(/\\/g, "/");
          heroPreview.style.display = "block";
        }

        document
          .querySelectorAll(".btn-layout")
          .forEach((b) => b.classList.remove("active"));
        document
          .getElementById(`btn-layout-${currentDesign.layoutType}`)
          .classList.add("active");

        const previewFrame = document.getElementById("live-preview");
        previewFrame.src = `/menu/${restaurantData.slug}`;

        previewFrame.onload = () => {
          updatePreview();
        };
      }

      function setUiParam(key, value) {
        currentDesign[key] = value;
        if (key === "cardRadius")
          document.getElementById("radius-val").innerText = value;
        if (key === "layoutType") {
          document
            .querySelectorAll(".btn-layout")
            .forEach((b) => b.classList.remove("active"));
          document
            .getElementById(`btn-layout-${value}`)
            .classList.add("active");
        }
        updatePreview();
      }

      function toggleBgInput() {
        const type = document.getElementById("ui-bgType").value;
        currentDesign.bgType = type;

        const colorInput = document.getElementById("ui-bgColor");
        const imgContainer = document.getElementById("ui-bgImage-container");

        if (type === "color") {
          colorInput.classList.remove("hidden");
          imgContainer.classList.add("hidden");
        } else if (type === "image") {
          colorInput.classList.add("hidden");
          imgContainer.classList.remove("hidden");
        } else {
          colorInput.classList.remove("hidden");
          imgContainer.classList.add("hidden");
        }
        updatePreview();
      }
      function updatePreview() {
        const iframe = document.getElementById("live-preview");
        if (iframe.contentWindow) {
          iframe.contentWindow.postMessage(
            { type: "UPDATE_THEME", config: currentDesign },
            "*",
          );
        }
      }

      async function saveDesignSettings() {
        const rId = document.getElementById("restaurant-id").value;
        const bgFile = document.getElementById("ui-bgFile").files[0];

        const formData = new FormData();

        formData.append("customUI", JSON.stringify(currentDesign));

        if (bgFile && currentDesign.bgType === "image") {
          formData.append("bgImage", bgFile);
        }

        const heroFile = document.getElementById("ui-heroFile").files[0];
        if (heroFile) {
          formData.append("heroImage", heroFile);
        }

        Swal.showLoading();
        try {
          const res = await fetch(`/api/v1/restaurants/${rId}`, {
            method: "PATCH",
            headers: { Authorization: `Bearer ${token}` },
            body: formData,
          });

          if (res.ok) {
            Swal.fire({
              icon: "success",
              title: "ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØµÙ…ÙŠÙ… ÙˆØ§Ù„ØµÙˆØ±Ø©",
              timer: 1500,
              showConfirmButton: false,
            });
          } else {
            throw new Error("ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸");
          }
        } catch (e) {
          console.error(e);
          Swal.fire("Ø®Ø·Ø£", "Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­ÙØ¸", "error");
        }
      }

      const defaultDesign = {
        layoutType: "modern",
        primaryColor: "#B78728",
        bgType: "color",
        bgValue: "#F9F9F9",
        cardStyle: "solid",
        cardRadius: 16,
        fontFamily: "Tajawal",
      };

      function resetDesign() {
        Swal.fire({
          title: "Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ",
          text: "Ø³ÙŠØ¹ÙˆØ¯ Ø§Ù„ØªØµÙ…ÙŠÙ… Ù„Ù„Ø´ÙƒÙ„ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ (Ù„Ù† ÙŠØªÙ… Ø§Ù„Ø­ÙØ¸ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¥Ù„Ø§ Ø¨Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø­ÙØ¸).",
          icon: "warning",
          showCancelButton: true,
          confirmButtonColor: "#3085d6",
          cancelButtonColor: "#d33",
          confirmButtonText: "Ù†Ø¹Ù…ØŒ Ø§Ø³ØªØ¹Ø¯ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ",
          cancelButtonText: "Ø¥Ù„ØºØ§Ø¡",
        }).then((result) => {
          if (result.isConfirmed) {
            currentDesign = { ...defaultDesign };

            document.getElementById("ui-primaryColor").value =
              currentDesign.primaryColor;
            document.getElementById("ui-bgType").value = currentDesign.bgType;
            document.getElementById("ui-cardStyle").value =
              currentDesign.cardStyle;
            document.getElementById("ui-cardRadius").value =
              currentDesign.cardRadius;
            document.getElementById("ui-fontFamily").value =
              currentDesign.fontFamily;
            document.getElementById("radius-val").innerText =
              currentDesign.cardRadius;

            toggleBgInput();
            if (currentDesign.bgType === "color") {
              document.getElementById("ui-bgColor").value =
                currentDesign.bgValue;
            } else {
              document.getElementById("ui-bgImage").value = "";
            }

            document
              .querySelectorAll(".btn-layout")
              .forEach((b) => b.classList.remove("active"));
            document
              .getElementById(`btn-layout-${currentDesign.layoutType}`)
              .classList.add("active");

            updatePreview();

            Swal.fire({
              toast: true,
              position: "top-end",
              icon: "info",
              title: "ØªÙ… Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø´ÙƒÙ„ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ",
              showConfirmButton: false,
              timer: 1500,
            });
          }
        });
      }

      function handleBgUpload(input) {
        previewImage(input, "bg-preview");

        if (input.files && input.files[0]) {
          const reader = new FileReader();
          reader.onload = function (e) {
            setUiParam("bgValue", e.target.result);
          };
          reader.readAsDataURL(input.files[0]);
        }
      }
      function handleHeroUpload(input) {
        previewImage(input, "hero-preview");
        if (input.files && input.files[0]) {
          const reader = new FileReader();
          reader.onload = function (e) {
            setUiParam("heroImage", e.target.result);
          };
          reader.readAsDataURL(input.files[0]);
        }
      }

      let socket;

      window.loadOrders = async function () {
        const rId = document.getElementById("restaurant-id").value;

        const badge = document.getElementById("live-badge");
        if (badge) {
          badge.classList.add("hidden");
          badge.innerText = "0";
        }

        const container = document.getElementById("orders-grid");
        if (!container) return;

        container.innerHTML =
          '<div class="loading"><i class="fas fa-circle-notch fa-spin"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>';

        try {
          const res = await fetch(`/api/v1/orders/${rId}/active`, {
            headers: { Authorization: `Bearer ${token}` },
          });
          const data = await res.json();
          container.innerHTML = "";

          if (!data.data || data.data.orders.length === 0) {
            container.innerHTML =
              '<div style="grid-column: 1/-1; text-align:center; padding:40px; color:var(--secondary)"><i class="fas fa-clipboard-list fa-3x" style="margin-bottom:15px; opacity:0.5"></i><p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ù†Ø´Ø·Ø© Ø­Ø§Ù„ÙŠØ§Ù‹.</p></div>';
            return;
          }

          data.data.orders.forEach((order) => {
            container.innerHTML += window.createOrderCardHTML(order);
          });
        } catch (e) {
          console.error(e);
          container.innerHTML =
            '<p style="color:red; text-align:center">Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</p>';
        }
      };

      window.createOrderCardHTML = function (order) {
        const role =
          currentUserRole && currentUserRole !== ""
            ? currentUserRole
            : "cashier";

        if (
          role === "kitchen" &&
          (order.status === "completed" || order.status === "canceled")
        ) {
          return "";
        }

        const time = new Date(order.createdAt).toLocaleTimeString("ar-EG", {
          hour: "2-digit",
          minute: "2-digit",
        });

        let statusColor = "#f59e0b";
        let statusText = "Ø¬Ø¯ÙŠØ¯ (Ø§Ù†ØªØ¸Ø§Ø±)";
        let cardBg = "var(--surface)";

        if (order.status === "preparing") {
          statusColor = "#3b82f6";
          statusText = "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ¬Ù‡ÙŠØ²";
        }

        let textColor = "var(--text-main)";

        if (order.status === "completed") {
          statusColor = "#10b981";
          statusText = "Ù…ÙƒØªÙ…Ù„";
          cardBg = "#ecfdf5";
          textColor = "#1f2937";
        }
        if (order.status === "canceled") {
          statusColor = "#ef4444";
          statusText = "Ù…Ù„ØºÙŠ";
          cardBg = "#fee2e2";
          textColor = "#1f2937";
        }

        let itemsHtml = "";
        order.items.forEach((item) => {
          itemsHtml += `<div style="display:flex; justify-content:space-between; margin-bottom:5px; font-size:14px; border-bottom:1px solid #eee; padding-bottom:5px;">
            <span>- ${item.name} <span style="font-weight:bold">x${item.qty}</span></span>
            ${role !== "kitchen" ? `<span>${item.price * item.qty}</span>` : ""} </div>`;
        });

        if (order.discountAmount > 0 && role !== "kitchen") {
          itemsHtml += `<div style="display:flex; justify-content:space-between; margin-bottom:5px; font-size:14px; color:var(--danger); font-weight:bold;">
            <span>Ø®ØµÙ… ÙƒÙˆØ¨ÙˆÙ† (${order.couponCode || ""}):</span>
            <span>-${order.discountAmount}</span>
        </div>`;
        }

        const orderDataEncoded = encodeURIComponent(JSON.stringify(order));
        let actions = "";

        const printBtn =
          role !== "kitchen"
            ? `<button class="btn btn-outline" onclick="window.printOrder('${orderDataEncoded}')" style="margin-left:5px; color:var(--text-main);" title="Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ÙØ§ØªÙˆØ±Ø©"><i class="fas fa-print"></i></button>`
            : "";

        if (order.status === "pending") {
          actions = `${printBtn} <button class="btn btn-primary" onclick="window.updateOrderStatus('${order._id}', 'preparing')" style="width:100%; margin-left:5px;">Ø¨Ø¯Ø¡ Ø§Ù„ØªØ­Ø¶ÙŠØ± <i class="fas fa-fire"></i></button>`;
        } else if (order.status === "preparing") {
          actions = `${printBtn} <button class="btn btn-success" onclick="window.updateOrderStatus('${order._id}', 'completed')" style="width:100%; margin-left:5px;">ØªÙ… Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ <i class="fas fa-check"></i></button>`;
        } else {
          actions = `${printBtn}`;
        }

        const cancelBtn =
          role !== "kitchen" &&
          order.status !== "completed" &&
          order.status !== "canceled"
            ? `<button class="btn btn-outline" onclick="window.updateOrderStatus('${order._id}', 'canceled')" style="color:var(--danger); border-color:var(--danger); padding:0 15px;"><i class="fas fa-times"></i></button>`
            : "";

        const tableDisplay =
          order.tableNumber === 0
            ? "ØªÙŠÙƒ Ø£ÙˆØ§ÙŠ ğŸƒ"
            : `Ø·Ø§ÙˆÙ„Ø©: ${order.tableNumber}`;

        const displayNum = order.orderNum
          ? `#${order.orderNum}`
          : `#${String(order._id).slice(-4)}`;

        return `
        <div class="card" id="order-${order._id}" style="border-top: 4px solid ${statusColor}; padding:15px; position:relative; background: ${cardBg}; color: ${textColor}">
            <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                <span style="font-weight:bold; font-size:18px; background:var(--primary); color:white; padding:2px 12px; border-radius:8px">${displayNum}</span>
                <span id="status-text-${order._id}" style="background:${statusColor}20; color:${statusColor}; padding:2px 8px; border-radius:10px; font-size:12px; font-weight:bold;">${statusText}</span>
            </div>
            <div style="font-weight:bold; font-size:18px; margin-bottom:5px;">${tableDisplay}</div>
            <div style="color:var(--secondary); font-size:12px; margin-bottom:15px;"><i class="far fa-clock"></i> ${time}</div>
            
            <div style="background:var(--bg); padding:10px; border-radius:8px; margin-bottom:15px; max-height:150px; overflow-y:auto;">
                ${itemsHtml}
            </div>
            
            ${
              role !== "kitchen"
                ? `
            <div style="display:flex; justify-content:space-between; font-weight:bold; margin-bottom:15px; border-top:1px dashed var(--border-color); padding-top:10px;">
                <span>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ:</span>
                <span style="color:var(--primary); font-size:18px">${order.totalPrice} Ø¬.Ù…</span>
            </div>`
                : ""
            } 
            
            <div id="actions-${order._id}" style="display:flex; justify-content:space-between;">
                <div style="flex:1; display:flex;">${actions}</div>
                ${cancelBtn}
            </div>
        </div>
    `;
      };
      window.updateOrderStatus = async function (orderId, status) {
        try {
          const btn = document.querySelector(`#order-${orderId} button`);
          if (btn) {
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
          }

          await fetch(`/api/v1/orders/${orderId}/status`, {
            method: "PATCH",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${token}`,
            },
            body: JSON.stringify({ status }),
          });

          const card = document.getElementById(`order-${orderId}`);
          if (card) {
            if (status === "completed") {
              card.style.background = "#ecfdf5";
              card.style.borderTopColor = "#10b981";
              const statusText = document.getElementById(
                `status-text-${orderId}`,
              );
              if (statusText) {
                statusText.innerText = "Ù…ÙƒØªÙ…Ù„";
                statusText.style.color = "#10b981";
              }
              window.loadOrders();
            } else if (status === "preparing") {
              card.style.borderTopColor = "#3b82f6";
              window.loadOrders();
            } else {
              window.loadOrders();
            }
          }
        } catch (e) {
          console.error(e);
          Swal.fire("Ø®Ø·Ø£", "ÙØ´Ù„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø©", "error");
        }
      };

      window.prependOrderCard = function (order) {
        const container = document.getElementById("orders-grid");
        if (container) {
          const html = window.createOrderCardHTML(order);
          container.insertAdjacentHTML("afterbegin", html);
        }
      };

      window.initSocket = function (rId) {
        if (socket) return;

        socket = io({
          transports: ["websocket"],
          upgrade: false,
        });

        socket.on("connect", () => {
          console.log("âœ… Connected to Live Orders System");
          socket.emit("join-restaurant", rId);
        });

        socket.on("order-updated", (updatedOrder) => {
          console.log("ğŸ”„ Order Updated:", updatedOrder);

          const isOrdersPageOpen = !document
            .getElementById("view-orders")
            .classList.contains("hidden");
          if (isOrdersPageOpen) {
            window.loadOrders();
          }
        });

        socket.on("new-order", (order) => {
          console.log("ğŸ”” New Order Received:", order);

          const audio = document.getElementById("order-sound");
          if (audio) {
            if (currentUserRole === "kitchen") {
              audio.src =
                "https://assets.mixkit.co/active_storage/sfx/alarm-tone-996.wav";
            } else {
              audio.src =
                "https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3";
            }
            audio.currentTime = 0;
            audio
              .play()
              .catch((err) =>
                console.log("ğŸ”Š Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø£ÙŠ Ù…ÙƒØ§Ù† ÙÙŠ Ø§Ù„ØµÙØ­Ø© Ù„ØªÙØ¹ÙŠÙ„ Ø§Ù„ØµÙˆØª"),
              );
          }

          Swal.fire({
            position: "top-end",
            icon: "success",
            title: `Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯! Ø·Ø§ÙˆÙ„Ø©: ${order.tableNumber}`,
            showConfirmButton: false,
            timer: 3000,
            toast: true,
          });

          const isOrdersPageOpen = !document
            .getElementById("view-orders")
            .classList.contains("hidden");

          if (isOrdersPageOpen) {
            window.prependOrderCard(order);
          } else {
            const badge = document.getElementById("live-badge");
            if (badge) {
              let currentCount = parseInt(badge.innerText || "0");
              if (isNaN(currentCount)) currentCount = 0;
              badge.innerText = currentCount + 1;
              badge.classList.remove("hidden");
              badge.style.display = "inline-block";
            }
          }
        });
      };

      function startShiftMonitor() {
        const shiftEndStr = sessionStorage.getItem("shiftEnd");
        if (!shiftEndStr) return;

        checkTime(shiftEndStr);

        setInterval(() => {
          checkTime(shiftEndStr);
        }, 30000);
      }

      function checkTime(shiftEndStr) {
        const now = new Date(Date.now() + serverTimeOffset);

        const [endH, endM] = shiftEndStr.split(":").map(Number);

        const currentMinutes = now.getHours() * 60 + now.getMinutes();
        const endMinutes = endH * 60 + endM;

        const isOvernightOverlap = currentMinutes - endMinutes > 720;

        const gracePeriod = 10;

        if (currentMinutes > endMinutes && !isOvernightOverlap) {
          const diff = currentMinutes - endMinutes;

          if (diff < gracePeriod) {
            const remaining = gracePeriod - diff;
            if (remaining === 5 || remaining === 1) {
              Swal.fire({
                icon: "warning",
                title: "Ø§Ù†ØªÙ‡Ù‰ ÙˆÙ‚Øª Ø§Ù„Ø´ÙŠÙØª!",
                text: `Ø³ÙŠØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø®Ù„Ø§Ù„ ${remaining} Ø¯Ù‚Ø§Ø¦Ù‚.`,
                timer: 3000,
                showConfirmButton: false,
                toast: true,
                position: "top",
              });
            }
          } else {
            Swal.fire({
              icon: "error",
              title: "Ø§Ù†ØªÙ‡Øª ÙØªØ±Ø© Ø§Ù„Ø³Ù…Ø§Ø­",
              text: "Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„Ø´ÙŠÙØª ÙˆØªÙ… Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†Ø¸Ø§Ù….",
              allowOutsideClick: false,
              confirmButtonText: "Ø­Ø³Ù†Ø§Ù‹",
            }).then(() => {
              logout();
            });
          }
        }
      }

      const startApp = async function () {
        if (!token) {
          document.getElementById("login-section").style.display = "flex";
          return;
        }

        await initDashboard();

        const rId = document.getElementById("restaurant-id").value;
        if (rId) {
          window.initSocket(rId);
        }

        if (
          !document.getElementById("view-orders").classList.contains("hidden")
        ) {
          window.loadOrders();
        }

        startShiftMonitor();
      };

      if (document.readyState === "loading") {
        document.addEventListener("DOMContentLoaded", () => {
            startApp();
            // Ø¥Ø¬Ø¨Ø§Ø± Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø¥ØºÙ„Ø§Ù‚ Ø¹Ù†Ø¯ Ø§Ù„ÙØªØ­
            document.getElementById('sidebar').classList.remove('active');
            document.querySelector('.overlay').style.display = 'none';
        });
      } else {
        startApp();
        // Ø¥Ø¬Ø¨Ø§Ø± Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø¥ØºÙ„Ø§Ù‚ Ø¹Ù†Ø¯ Ø§Ù„ÙØªØ­
        document.getElementById('sidebar').classList.remove('active');
        document.querySelector('.overlay').style.display = 'none';
      }
      window.loadHistory = async function () {
        const rId = document.getElementById("restaurant-id").value;
        const tbody = document.getElementById("history-list");
        const salesDisplay = document.getElementById("total-sales-display");
        const title = document.getElementById("history-title");

        let queryParams = "";

        const role =
          typeof currentUserRole !== "undefined" ? currentUserRole : "cashier";

        if (role === "owner") {
          const filterDiv = document.getElementById("owner-filters");
          if (filterDiv) filterDiv.style.display = "flex";
          if (title) title.innerText = "Ø³Ø¬Ù„ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª (Ø´Ø§Ù…Ù„)";

          const start = document.getElementById("filter-start").value;
          const end = document.getElementById("filter-end").value;

          if (start && end) {
            queryParams = `?startDate=${start}&endDate=${end}`;
          }
          const searchVal = document.getElementById("history-search").value;
          if (searchVal) {
            queryParams += queryParams
              ? `&search=${searchVal}`
              : `?search=${searchVal}`;
          }
        } else {
          const filterDiv = document.getElementById("owner-filters");
          if (filterDiv) filterDiv.style.display = "none";
          if (title) title.innerText = "Ø¬Ø±Ø¯ Ø§Ù„Ø´ÙŠÙØª Ø§Ù„Ø­Ø§Ù„ÙŠ (Ø§Ù„ÙŠÙˆÙ…)";
        }

        tbody.innerHTML =
          '<tr><td colspan="6" style="text-align:center">Ø¬Ø§Ø±Ù Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</td></tr>';

        try {
          const res = await fetch(
            `/api/v1/orders/${rId}/history${queryParams}`,
            {
              headers: { Authorization: `Bearer ${token}` },
            },
          );

          const data = await res.json();

          tbody.innerHTML = "";

          if (data.status !== "success") {
            tbody.innerHTML = `<tr><td colspan="6" style="text-align:center; color:red">${data.message || "Ø­Ø¯Ø« Ø®Ø·Ø£"}</td></tr>`;
            return;
          }

          if (salesDisplay)
            salesDisplay.innerText =
              (data.data.totalSales || 0).toLocaleString() + " Ø¬.Ù…";

          if (!data.data.orders || data.data.orders.length === 0) {
            tbody.innerHTML =
              '<tr><td colspan="6" style="text-align:center; padding:20px;">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø³Ø¬Ù„ Ù…Ø¨ÙŠØ¹Ø§Øª Ù„Ù‡Ø°Ù‡ Ø§Ù„ÙØªØ±Ø©</td></tr>';
            return;
          }

          const groups = {};
          data.data.orders.forEach((order) => {
            const dateObj = new Date(order.createdAt);
            const monthKey = dateObj.toLocaleDateString("ar-EG", {
              month: "long",
              year: "numeric",
            });

            if (!groups[monthKey]) {
              groups[monthKey] = { orders: [], total: 0, count: 0 };
            }

            groups[monthKey].orders.push(order);
            if (order.status === "completed") {
              groups[monthKey].total += order.totalPrice;
              groups[monthKey].count += 1;
            }
          });

          for (const [month, info] of Object.entries(groups)) {
            tbody.innerHTML += `
                    <tr style="background-color: var(--primary-light); border-top: 2px solid var(--primary);">
                        <td colspan="6" style="padding: 10px 15px;">
                            <div style="display:flex; justify-content:space-between; align-items:center; font-weight:bold; color:var(--primary)">
                                <span><i class="fas fa-calendar-alt"></i> ${month}</span>
                                <span>Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„Ø´Ù‡Ø±: ${info.total.toLocaleString()} Ø¬.Ù… (${info.count} Ø·Ù„Ø¨)</span>
                            </div>
                        </td>
                    </tr>
                `;

            info.orders.forEach((order) => {
              const time = new Date(order.createdAt).toLocaleTimeString(
                "ar-EG",
                { hour: "2-digit", minute: "2-digit" },
              );
              const dateDay = new Date(order.createdAt).toLocaleDateString(
                "ar-EG",
                { day: "numeric", month: "numeric" },
              );
              const itemsSummary = order.items
                .map((i) => `${i.name} (${i.qty})`)
                .join(", ");

              let statusBadge = "";
              if (order.status === "completed")
                statusBadge =
                  '<span class="badge" style="background:#dcfce7; color:#166534">Ù…ÙƒØªÙ…Ù„</span>';
              else if (order.status === "canceled")
                statusBadge =
                  '<span class="badge" style="background:#fee2e2; color:#991b1b">Ù…Ù„ØºÙŠ</span>';

              const tableNum =
                order.tableNumber === 0 ? "ØªÙŠÙƒ Ø£ÙˆØ§ÙŠ" : order.tableNumber;

              tbody.innerHTML += `
                        <tr style="background:var(--surface)">
                            <td style="font-weight:bold">#${order.orderNum || String(order._id).slice(-4)}</td>
                            <td style="font-size:12px">${dateDay} - ${time}</td>
                            <td>${tableNum}</td>
                            <td style="font-size:13px; color:var(--secondary); max-width:200px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap" title="${itemsSummary}">${itemsSummary}</td>
                            <td style="font-weight:bold">${order.totalPrice}</td>
                            <td>${statusBadge}</td>
                        </tr>
                    `;
            });
          }
        } catch (e) {
          console.error(e);
          tbody.innerHTML =
            '<tr><td colspan="6" style="text-align:center; color:red">Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„</td></tr>';
        }
      };

      function applyPermissions(role) {
        const allNavs = [
          "nav-categories",
          "nav-products",
          "nav-bulk",
          "nav-history",
          "nav-design",
          "nav-settings",
          "nav-staff",
        ];

        const permissions = {
          owner: [
            "nav-categories",
            "nav-products",
            "nav-bulk",
            "nav-history",
            "nav-design",
            "nav-settings",
            "nav-orders",
            "nav-staff",
            "nav-coupons",
          ],
          cashier: ["nav-orders", "nav-history"],
          kitchen: ["nav-orders"],
        };

        const allowed = permissions[role] || [];

        allNavs.forEach((id) => {
          const el = document.getElementById(id);
          if (el) el.classList.add("hidden");
        });

        allowed.forEach((id) => {
          const el = document.getElementById(id);
          if (el) el.classList.remove("hidden");
        });

        if (role === "owner") loadStaff();

        const recentBtn = document.getElementById("btn-recent-orders");
        if (recentBtn) {
          if (role === "kitchen") {
            recentBtn.classList.add("hidden");
          } else {
            recentBtn.classList.remove("hidden");
          }
        }
      }

      async function loadStaff() {
        try {
          const res = await fetch("/api/v1/users/my-staff", {
            headers: { Authorization: `Bearer ${token}` },
          });
          const data = await res.json();
          const list = document.getElementById("staff-list");
          list.innerHTML = "";
          data.data.staff.forEach((u) => {
            let roleBadge =
              u.role === "cashier"
                ? '<span class="badge" style="background:#dbeafe; color:#1e40af">ÙƒØ§Ø´ÙŠØ±</span>'
                : '<span class="badge" style="background:#ffedd5; color:#9a3412">Ù…Ø·Ø¨Ø®</span>';

            const shiftInfo =
              u.shiftStart && u.shiftEnd
                ? `<div style="font-size:11px; color:var(--secondary); margin-top:5px;"><i class="far fa-clock"></i> ${u.shiftStart} - ${u.shiftEnd}</div>`
                : "";

            list.innerHTML += `
                    <tr>
                        <td>
                            ${u.name}
                            ${shiftInfo}
                        </td>
                        <td>${u.email}</td>
                        <td>${roleBadge}</td>
                        <td><button class="btn btn-outline" style="color:red" onclick="deleteStaff('${u._id}')"><i class="fas fa-trash"></i></button></td>
                    </tr>
                `;
          });
        } catch (e) {
          console.error(e);
        }
      }

      async function addStaff() {
        const name = document.getElementById("staff-name").value;
        const email = document.getElementById("staff-email").value;
        const password = document.getElementById("staff-password").value;
        const role = document.getElementById("staff-role").value;
        const rId = document.getElementById("restaurant-id").value;

        const shiftStart = document.getElementById("staff-start").value;
        const shiftEnd = document.getElementById("staff-end").value;

        const restDays = [];
        document
          .querySelectorAll("#rest-days-container input:checked")
          .forEach((cb) => {
            restDays.push(parseInt(cb.value));
          });

        if (!name || !email || !password)
          return Swal.fire("ØªÙ†Ø¨ÙŠÙ‡", "Ø£ÙƒÙ…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©", "warning");

        try {
          const res = await fetch("/api/v1/users/create-staff", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${token}`,
            },
            body: JSON.stringify({
              name,
              email,
              password,
              role,
              restaurantId: rId,
              shiftStart,
              shiftEnd,
              restDays,
            }),
          });
          const data = await res.json();
          if (data.status === "success") {
            Swal.fire("ØªÙ…", "ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…ÙˆØ¸Ù ÙˆØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø´ÙŠÙØª", "success");
            document.getElementById("staff-name").value = "";
            document.getElementById("staff-email").value = "";
            document.getElementById("staff-password").value = "";
            document
              .querySelectorAll("#rest-days-container input")
              .forEach((cb) => (cb.checked = false));
            loadStaff();
          } else {
            Swal.fire("Ø®Ø·Ø£", data.message, "error");
          }
        } catch (e) {
          console.error(e);
        }
      }

      async function deleteStaff(id) {
        if (
          (
            await Swal.fire({
              title: "Ø­Ø°Ù Ø§Ù„Ù…ÙˆØ¸ÙØŸ",
              icon: "warning",
              showCancelButton: true,
            })
          ).isConfirmed
        ) {
          await fetch(`/api/v1/users/staff/${id}`, {
            method: "DELETE",
            headers: { Authorization: `Bearer ${token}` },
          });
          loadStaff();
        }
      }

      window.printOrder = function (orderEncoded) {
        const order = JSON.parse(decodeURIComponent(orderEncoded));

        let fullTitle = document.getElementById("page-title").innerText;
        const restName = fullTitle.split("\n")[0] || "Smart Menu";

        const cashierName =
          sessionStorage.getItem("currentUserName") || "Cashier";

        const date = new Date(order.createdAt).toLocaleString("ar-EG");
        const orderNumDisplay = order.orderNum
          ? order.orderNum
          : String(order._id).slice(-4);

        let itemsHtml = "";
        order.items.forEach((item) => {
          itemsHtml += `
                <div style="display:flex; justify-content:space-between; margin-bottom:5px; font-size:12px;">
                    <span style="font-weight:bold;">${item.name}</span>
                    <span>${item.qty} x ${item.price}</span>
                </div>
                <div style="text-align:left; border-bottom:1px dashed #000; margin-bottom:5px; padding-bottom:2px;">
                    ${item.qty * item.price} Ø¬.Ù…
                </div>
            `;
        });

        const subTotal = order.subTotal || order.totalPrice;
        const taxVal = order.taxAmount || 0;
        const serviceVal = order.serviceAmount || 0;

        const receiptHTML = `
            <html>
            <head>
                <style>
                    body { font-family: 'Courier New', monospace; width: 300px; margin: 0; padding: 10px; direction: rtl; }
                    .header { text-align: center; margin-bottom: 10px; }
                    .title { font-size: 20px; font-weight: bold; }
                    .meta { font-size: 12px; margin-bottom: 10px; border-bottom: 1px solid #000; padding-bottom: 5px; }
                    .totals { margin-top: 10px; border-top: 1px dashed #000; padding-top: 5px; font-size: 14px; }
                    .row { display: flex; justify-content: space-between; }
                    .grand-total { font-size: 18px; font-weight: bold; margin-top: 5px; }
                    @media print { .no-print { display: none; } }
                </style>
            </head>
            <body>
                <div class="header">
                    <div class="title">${restName}</div>
                    <div style="font-size:12px">Ø£ÙˆØ±Ø¯Ø± #${orderNumDisplay}</div>
                </div>
                
                <div class="meta">
                    <div>Ø§Ù„ØªØ§Ø±ÙŠØ®: ${date}</div>
                    <div>Ø¨ÙˆØ§Ø³Ø·Ø©: ${cashierName}</div>
                    <div>Ø§Ù„Ø·Ø§ÙˆÙ„Ø©: <strong>${order.tableNumber}</strong></div>
                    <div>Ù†ÙˆØ¹ Ø§Ù„Ø·Ù„Ø¨: ${order.tableNumber === 0 ? "ØªÙŠÙƒ Ø£ÙˆØ§ÙŠ" : "ØµØ§Ù„Ø©"}</div>
                </div>

                <div class="items">${itemsHtml}</div>

                <div class="totals">
                    <div class="row"><span>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹:</span> <span>${subTotal}</span></div>
                    ${taxVal > 0 ? `<div class="row"><span>Ø¶Ø±ÙŠØ¨Ø©:</span> <span>${taxVal}</span></div>` : ""}
                    ${serviceVal > 0 ? `<div class="row"><span>Ø®Ø¯Ù…Ø©:</span> <span>${serviceVal}</span></div>` : ""}
                    ${order.discountAmount > 0 ? `<div class="row" style="color:black"><span>Ø®ØµÙ…:</span> <span>-${order.discountAmount}</span></div>` : ""}
                    <div class="row grand-total">
                        <span>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ:</span> <span>${order.totalPrice} Ø¬.Ù…</span>
                    </div>
                </div>

                <div style="text-align:center; margin-top:20px; font-size:12px;">
                    *** Ø´ÙƒØ±Ø§Ù‹ Ù„Ø²ÙŠØ§Ø±ØªÙƒÙ… ***
                </div>

                <script>
                    window.onload = function() { window.print(); setTimeout(() => window.close(), 1000); }
                <\/script>
            </body>
            </html>
        `;

        const popup = window.open("", "_blank", "width=350,height=600");
        popup.document.open();
        popup.document.write(receiptHTML);
        popup.document.close();
      };
    </script>

    <div
      id="recent-orders-modal"
      class="overlay"
      style="z-index: 2000; display: none"
    >
      <div
        class="card"
        style="
          width: 90%;
          max-width: 600px;
          max-height: 80vh;
          margin: 5vh auto;
          display: flex;
          flex-direction: column;
          padding: 0;
        "
      >
        <div
          style="
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
          "
        >
          <h3 style="margin: 0; color: var(--primary)">ğŸ§¾ ÙÙˆØ§ØªÙŠØ± Ø¢Ø®Ø± Ø³Ø§Ø¹ØªÙŠÙ†</h3>
          <button
            onclick="
              document.getElementById('recent-orders-modal').style.display =
                'none'
            "
            style="
              background: none;
              border: none;
              font-size: 20px;
              cursor: pointer;
              color: var(--text-main);
            "
          >
            <i class="fas fa-times"></i>
          </button>
        </div>
        <div
          id="recent-orders-list"
          style="padding: 20px; overflow-y: auto; flex: 1"
        ></div>
      </div>
    </div>

    <script>
      window.showRecentOrders = async function () {
        const rId = document.getElementById("restaurant-id").value;
        const modal = document.getElementById("recent-orders-modal");
        const container = document.getElementById("recent-orders-list");

        modal.style.display = "block";
        container.innerHTML =
          '<div style="text-align:center"><i class="fas fa-spinner fa-spin"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>';

        try {
          const res = await fetch(`/api/v1/orders/${rId}/recent-completed`, {
            headers: {
              Authorization: `Bearer ${sessionStorage.getItem("ownerToken")}`,
            },
          });
          const data = await res.json();

          container.innerHTML = "";
          if (data.data.orders.length === 0) {
            container.innerHTML =
              '<p style="text-align:center; color:var(--secondary)">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ù…ÙƒØªÙ…Ù„Ø© ÙÙŠ Ø¢Ø®Ø± Ø³Ø§Ø¹ØªÙŠÙ†</p>';
            return;
          }

          data.data.orders.forEach((order) => {
            const time = new Date(order.updatedAt).toLocaleTimeString("ar-EG", {
              hour: "2-digit",
              minute: "2-digit",
            });
            const orderDataEncoded = encodeURIComponent(JSON.stringify(order));

            container.innerHTML += `
                <div style="background:var(--bg); border:1px solid var(--border-color); padding:10px; border-radius:10px; margin-bottom:10px; display:flex; justify-content:space-between; align-items:center;">
                    <div>
                        <div style="font-weight:bold; color:var(--text-main)">Ø£ÙˆØ±Ø¯Ø± #${String(order._id).slice(-4)} <span style="font-size:12px; color:var(--success)">(${time})</span></div>
                        <div style="font-size:12px; color:var(--secondary)">${order.tableNumber === 0 ? "ØªÙŠÙƒ Ø£ÙˆØ§ÙŠ" : "Ø·Ø§ÙˆÙ„Ø© " + order.tableNumber} - ${order.totalPrice} Ø¬.Ù…</div>
                    </div>
                    <button class="btn btn-outline" onclick="window.printOrder('${orderDataEncoded}')" style="padding:5px 15px;">
                        <i class="fas fa-print"></i> Ø·Ø¨Ø§Ø¹Ø©
                    </button>
                </div>
            `;
          });
        } catch (e) {
          container.innerHTML =
            '<p style="color:red; text-align:center">Ø­Ø¯Ø« Ø®Ø·Ø£</p>';
        }
      };

      let currentSizes = [];

      function togglePricingMode() {
        const mode = document.querySelector(
          'input[name="pricingMode"]:checked',
        ).value;
        if (mode === "single") {
          document.getElementById("mode-single").classList.remove("hidden");
          document.getElementById("mode-multi").classList.add("hidden");
        } else {
          document.getElementById("mode-single").classList.add("hidden");
          document.getElementById("mode-multi").classList.remove("hidden");
          if (document.getElementById("sizes-list").innerHTML === "")
            addSizeRow();
        }
      }

      function addSizeRow(name = "", price = "", oldPrice = "") {
        const id = Date.now();
        const oldValDisplay = oldPrice && oldPrice > 0 ? oldPrice : "";

        const html = `
                <div class="size-row" id="size-${id}" style="display:flex; gap:10px; margin-bottom:10px; align-items:flex-end;">
                    <div style="flex:2">
                        <input type="text" class="s-name" placeholder="Ø§Ø³Ù… Ø§Ù„Ø­Ø¬Ù… (ØµØºÙŠØ±ØŒ ÙˆØ³Ø·)" value="${name}">
                    </div>
                    <div style="flex:1">
                        <input type="number" class="s-price" placeholder="Ø§Ù„Ø³Ø¹Ø±" value="${price}">
                    </div>
                    <div style="flex:1">
                        <input type="number" class="s-old" placeholder="Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø£ØµÙ„ÙŠ" value="${oldValDisplay}" 
                               style="border: 1px dashed var(--danger); background: #fff1f2; color: var(--danger);">
                    </div>
                    <button class="btn btn-outline" style="color:red; height:42px" onclick="document.getElementById('size-${id}').remove()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;
        document
          .getElementById("sizes-list")
          .insertAdjacentHTML("beforeend", html);
      }
      async function loadCoupons() {
        const rId = document.getElementById("restaurant-id").value;
        const res = await fetch(`/api/v1/coupons/${rId}`, {
          headers: { Authorization: `Bearer ${token}` },
        });
        const data = await res.json();
        const list = document.getElementById("coupons-list");
        list.innerHTML = "";
        data.data.coupons.forEach((c) => {
          const val =
            c.discountType === "percent" ? `${c.value}%` : `${c.value} Ø¬.Ù…`;
          list.innerHTML += `
            <tr>
                <td style="font-weight:bold; color:var(--primary)">${c.code}</td>
                <td>${val}</td>
                <td>${c.usedCount} / ${c.usageLimit}</td>
                <td><button class="btn btn-outline" style="color:red" onclick="deleteCoupon('${c._id}')"><i class="fas fa-trash"></i></button></td>
            </tr>
        `;
        });
      }

      async function createCoupon() {
        const rId = document.getElementById("restaurant-id").value;
        const body = {
          code: document.getElementById("coup-code").value,
          discountType: document.getElementById("coup-type").value,
          value: document.getElementById("coup-value").value,
          minOrderVal: document.getElementById("coup-min").value || 0,
          maxDiscount: document.getElementById("coup-max-disc").value || 0,
          usageLimit: document.getElementById("coup-limit").value || 1000,
        };
        if (!body.code || !body.value)
          return Swal.fire("ØªÙ†Ø¨ÙŠÙ‡", "Ø£Ø¯Ø®Ù„ Ø§Ù„ÙƒÙˆØ¯ ÙˆØ§Ù„Ù‚ÙŠÙ…Ø©", "warning");

        const res = await fetch(`/api/v1/coupons/${rId}`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${token}`,
          },
          body: JSON.stringify(body),
        });
        const data = await res.json();
        if (data.status === "success") {
          Swal.fire({
            toast: true,
            icon: "success",
            title: "ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ÙƒÙˆØ¨ÙˆÙ†",
          });
          document.getElementById("coup-code").value = "";
          loadCoupons();
        } else {
          Swal.fire("Ø®Ø·Ø£", data.message, "error");
        }
      }

      async function deleteCoupon(id) {
        if (
          (
            await Swal.fire({
              title: "Ø­Ø°Ù Ø§Ù„ÙƒÙˆØ¨ÙˆÙ†ØŸ",
              icon: "warning",
              showCancelButton: true,
            })
          ).isConfirmed
        ) {
          await fetch(`/api/v1/coupons/${id}`, {
            method: "DELETE",
            headers: { Authorization: `Bearer ${token}` },
          });
          loadCoupons();
        }
      }
      function createRecentOrderHTML(order) {
        const time = new Date(order.updatedAt).toLocaleTimeString("ar-EG", {
          hour: "2-digit",
          minute: "2-digit",
        });
        const orderDataEncoded = encodeURIComponent(JSON.stringify(order));

        let itemsTxt = order.items
          .map((i) => `${i.name} (x${i.qty})`)
          .join("ØŒ ");

        return `
        <div style="background:var(--bg); border:1px solid var(--border-color); padding:15px; border-radius:10px; margin-bottom:10px;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                <div>
                    <span style="font-weight:bold; color:var(--text-main); font-size:16px;">Ø£ÙˆØ±Ø¯Ø± #${order.orderNum}</span>
                    <span style="font-size:12px; color:var(--success); margin-right:5px;">(${time})</span>
                </div>
                <button class="btn btn-outline" onclick="window.printOrder('${orderDataEncoded}')" style="padding:5px 15px;">
                    <i class="fas fa-print"></i>
                </button>
            </div>
            
            <div style="font-size:13px; color:var(--text-main); margin-bottom:8px; line-height:1.6;">
                <strong>Ø§Ù„Ø£ØµÙ†Ø§Ù:</strong> ${itemsTxt}
            </div>
            
            <div style="display:flex; justify-content:space-between; font-size:12px; color:var(--secondary); border-top:1px dashed #ddd; padding-top:5px;">
                <span>${order.tableNumber === 0 ? "ØªÙŠÙƒ Ø£ÙˆØ§ÙŠ" : "Ø·Ø§ÙˆÙ„Ø© " + order.tableNumber}</span>
                <span style="font-weight:bold; color:var(--primary); font-size:14px;">${order.totalPrice} Ø¬.Ù…</span>
            </div>
        </div>
    `;
      }

      window.searchOrderHistory = async function () {
        const orderNum = document.getElementById("live-order-search").value;
        if (!orderNum) return;

        const rId = document.getElementById("restaurant-id").value;
        Swal.showLoading();

        try {
          const res = await fetch(
            `/api/v1/orders/${rId}/history?search=${orderNum}`,
            {
              headers: { Authorization: `Bearer ${token}` },
            },
          );
          const data = await res.json();
          Swal.close();

          if (data.status === "success" && data.data.orders.length > 0) {
            const modal = document.getElementById("recent-orders-modal");
            const container = document.getElementById("recent-orders-list");
            modal.style.display = "block";

            container.innerHTML = `<h4 style="text-align:center; margin-top:0">Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø£ÙˆØ±Ø¯Ø± #${orderNum}</h4>`;

            data.data.orders.forEach((order) => {
              container.innerHTML += createRecentOrderHTML(order);
            });
          } else {
            Swal.fire("ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯", "Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø·Ù„Ø¨ Ø¨Ù‡Ø°Ø§ Ø§Ù„Ø±Ù‚Ù…", "info");
          }
        } catch (e) {
          Swal.fire("Ø®Ø·Ø£", "Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨Ø­Ø«", "error");
        }
      };

      window.showRecentOrders = async function () {
        const rId = document.getElementById("restaurant-id").value;
        const modal = document.getElementById("recent-orders-modal");
        const container = document.getElementById("recent-orders-list");

        modal.style.display = "block";
        container.innerHTML =
          '<div style="text-align:center"><i class="fas fa-spinner fa-spin"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>';

        try {
          const res = await fetch(`/api/v1/orders/${rId}/recent-completed`, {
            headers: {
              Authorization: `Bearer ${sessionStorage.getItem("ownerToken")}`,
            },
          });
          const data = await res.json();

          container.innerHTML = "";
          if (data.data.orders.length === 0) {
            container.innerHTML =
              '<p style="text-align:center; color:var(--secondary)">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ù…ÙƒØªÙ…Ù„Ø© Ø­Ø¯ÙŠØ«Ø§Ù‹</p>';
            return;
          }

          data.data.orders.forEach((order) => {
            container.innerHTML += createRecentOrderHTML(order);
          });
        } catch (e) {
          container.innerHTML =
            '<p style="color:red; text-align:center">Ø­Ø¯Ø« Ø®Ø·Ø£</p>';
        }
      };
      function applyTheme(themeId) {
        const theme = themesLibrary.find((t) => t.id === themeId);
        if (!theme) return;

        currentDesign.primaryColor = theme.primary;
        currentDesign.bgType = theme.type;
        currentDesign.bgValue = theme.bg;
        currentDesign.fontFamily = theme.font;
        currentDesign.cardRadius = theme.radius;
        currentDesign.cardStyle = theme.style;
        currentDesign.layoutType = theme.layout;

        document.getElementById("ui-primaryColor").value = theme.primary;
        document.getElementById("ui-fontFamily").value = theme.font;
        document.getElementById("ui-cardRadius").value = theme.radius;
        document.getElementById("ui-cardStyle").value = theme.style;
        document.getElementById("radius-val").innerText = theme.radius;

        document.getElementById("ui-bgType").value = theme.type;
        toggleBgInput();
        if (theme.type === "color")
          document.getElementById("ui-bgColor").value = theme.bg;

        document
          .querySelectorAll(".btn-layout")
          .forEach((b) => b.classList.remove("active"));
        const activeBtn = document.getElementById(`btn-layout-${theme.layout}`);
        if (activeBtn) activeBtn.classList.add("active");

        updatePreview();

        Swal.fire({
          toast: true,
          position: "top-end",
          icon: "success",
          title: `ØªÙ… ØªØ·Ø¨ÙŠÙ‚ Ù‚Ø§Ù„Ø¨: ${theme.name}`,
          showConfirmButton: false,
          timer: 1000,
        });
      }
      async function checkShiftStatus(role) {
        setInterval(async () => {
          const now = new Date();
          try {
            const res = await fetch("/api/v1/users/my-staff", {
              headers: { Authorization: `Bearer ${token}` },
            });

            if (res.status === 403) {
              const data = await res.json();
              if (data.message.includes("Ø®Ø§Ø±Ø¬ ÙˆÙ‚Øª Ø§Ù„Ø´ÙŠÙØª")) {
                logout();
              }
            }
          } catch (e) {}
        }, 60000);
      }

      function toggleBulkPricing(rowId) {
        const mode = document.querySelector(
          `input[name="mode-${rowId}"]:checked`,
        ).value;
        const singleDiv = document.getElementById(`single-inputs-${rowId}`);
        const multiDiv = document.getElementById(`multi-inputs-${rowId}`);

        if (mode === "single") {
          singleDiv.classList.remove("hidden");
          multiDiv.classList.add("hidden");
        } else {
          singleDiv.classList.add("hidden");
          multiDiv.classList.remove("hidden");

          const container = document.getElementById(`sizes-container-${rowId}`);
          if (container.innerHTML.trim() === "") {
            addBulkSizeRow(rowId);
          }
        }
      }

      function addBulkSizeRow(rowId) {
        const container = document.getElementById(`sizes-container-${rowId}`);
        const sizeHtml = `
        <div class="b-size-row" style="display:flex; gap:5px; margin-bottom:5px; align-items:center;">
            <input type="text" class="bs-name" placeholder="Ø§Ù„Ø§Ø³Ù… (Ù…Ø«Ø§Ù„: ÙˆØ³Ø·)" style="flex:2; font-size:12px;">
            <input type="number" class="bs-price" placeholder="Ø§Ù„Ø³Ø¹Ø±" style="flex:1; font-size:12px;">
            <input type="number" class="bs-old" placeholder="Ù‚Ø¯ÙŠÙ…" style="flex:1; font-size:12px; background:#fff1f2;">
            <button onclick="this.parentElement.remove()" style="background:none; border:none; color:red; cursor:pointer;"><i class="fas fa-times"></i></button>
        </div>
    `;
        container.insertAdjacentHTML("beforeend", sizeHtml);
      }
      async function submitBulkAll() {
        const rows = document.querySelectorAll(".bulk-card");
        const rId = document.getElementById("restaurant-id").value;
        let promises = [];
        let validCount = 0;

        for (const row of rows) {
          const rowId = row.id.split("-")[1];

          const name = row.querySelector(".b-name").value;
          const cat = row.querySelector(".b-cat").value;
          const desc = row.querySelector(".b-desc").value;
          const imageFile = row.querySelector(".b-image").files[0];
          const mode = row.querySelector(
            `input[name="mode-${rowId}"]:checked`,
          ).value;

          if (!name || !cat) continue;

          let finalPrice = 0;
          let finalOldPrice = 0;
          let finalSizes = [];

          if (mode === "single") {
            const priceVal = row.querySelector(".b-price").value;
            if (!priceVal) continue;

            finalPrice = parseFloat(priceVal);
            finalOldPrice =
              parseFloat(row.querySelector(".b-old-price").value) || 0;
            if (finalOldPrice <= finalPrice) finalOldPrice = 0;
          } else {
            const sizeRows = row.querySelectorAll(
              `#sizes-container-${rowId} .b-size-row`,
            );
            if (sizeRows.length === 0) continue;

            let hasValidSize = false;
            sizeRows.forEach((sr) => {
              const sName = sr.querySelector(".bs-name").value;
              const sPrice = parseFloat(sr.querySelector(".bs-price").value);
              let sOld = parseFloat(sr.querySelector(".bs-old").value) || 0;

              if (sName && sPrice) {
                if (sOld <= sPrice) sOld = 0;
                finalSizes.push({ name: sName, price: sPrice, oldPrice: sOld });
                hasValidSize = true;
              }
            });

            if (!hasValidSize) continue;

            finalPrice = finalSizes[0].price;
            finalOldPrice = 0;
          }

          validCount++;
          const formData = new FormData();
          formData.append("restaurantId", rId);
          formData.append("name", JSON.stringify({ ar: name, en: name }));
          formData.append("description", JSON.stringify({ ar: desc, en: "" }));
          formData.append("category", cat);
          formData.append("price", finalPrice);
          formData.append("oldPrice", finalOldPrice);
          formData.append("sizes", JSON.stringify(finalSizes));

          if (imageFile) formData.append("image", imageFile);

          promises.push(
            fetch("/api/v1/products", {
              method: "POST",
              headers: { Authorization: `Bearer ${token}` },
              body: formData,
            }),
          );
        }

        if (validCount === 0)
          return Swal.fire(
            "ØªÙ†Ø¨ÙŠÙ‡",
            "ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø§Ø³Ù…ØŒ Ø§Ù„Ù‚Ø³Ù…ØŒ ÙˆØ§Ù„Ø³Ø¹Ø± Ù„Ù…Ù†ØªØ¬ ÙˆØ§Ø­Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„",
            "warning",
          );

        Swal.showLoading();

        try {
          await Promise.all(promises);
          Swal.close();
          Swal.fire({
            toast: true,
            icon: "success",
            title: `ØªÙ… Ø±ÙØ¹ ${validCount} Ù…Ù†ØªØ¬Ø§Øª Ø¨Ù†Ø¬Ø§Ø­`,
          });

          document.getElementById("bulk-container").innerHTML = "";
          addBulkRow();
          loadProducts();
        } catch (e) {
          console.error(e);
          Swal.fire("Ø®Ø·Ø£", "Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø±ÙØ¹ØŒ Ø±Ø§Ø¬Ø¹ Ø§Ù„Ù…Ø¯Ø®Ù„Ø§Øª", "error");
        }
      }
    </script>
    <div class="mobile-bottom-nav">
    <div class="nav-icon active" onclick="switchView('orders')" id="mob-nav-orders">
        <i class="fas fa-bell"></i>
        <span>Ø§Ù„Ø·Ù„Ø¨Ø§Øª</span>
        <span id="mob-badge" class="hidden" style="position:absolute; top:5px; right:30%; width:8px; height:8px; background:red; border-radius:50%;"></span>
    </div>
    <div class="nav-icon" onclick="switchView('products')" id="mob-nav-products">
        <i class="fas fa-hamburger"></i>
        <span>Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</span>
    </div>
    <div class="nav-icon" onclick="switchView('categories')" id="mob-nav-categories">
        <i class="fas fa-layer-group"></i>
        <span>Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</span>
    </div>
    <div class="nav-icon" onclick="switchView('settings')" id="mob-nav-settings">
        <i class="fas fa-cog"></i>
        <span>Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</span>
    </div>
    <div class="nav-icon" onclick="toggleSidebar()">
        <i class="fas fa-bars"></i>
        <span>Ø§Ù„Ù…Ø²ÙŠØ¯</span>
    </div>
</div>
  </body>
</html>