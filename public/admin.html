<!doctype html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>لوحة التحكم | Smart Menu</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    

    <script>
      const urlParamsGate = new URLSearchParams(window.location.search);
      const tokenGate =
        urlParamsGate.get("t") || sessionStorage.getItem("ownerToken");

      if (!tokenGate) {
        window.location.href = "/login";
      }
    </script>

    <style>
      * { box-sizing: border-box; }
      :root {
        --primary: #4338ca;
        --primary-light: #e0e7ff;
        --secondary: #64748b;
        --bg: #f3f4f6;
        --surface: #ffffff;
        --border-color: #e2e8f0;
        --text-main: #1e293b;
        --success: #10b981;
        --danger: #ef4444;
        --warning: #f59e0b;
      }

      body.dark-mode {
        --primary: #6366f1;
        --primary-light: #312e81;
        --secondary: #94a3b8;
        --bg: #0f172a;
        --surface: #1e293b;
        --border-color: #334155;
        --text-main: #f1f5f9;
      }

      body {
        font-family: "Tajawal", sans-serif;
        background: var(--bg);
        margin: 0;
        display: flex;
        height: 100vh;
        overflow: hidden;
        color: var(--text-main);
        transition:
          background 0.3s,
          color 0.3s;
      }

      .mobile-header {
        display: none;
        background: var(--surface);
        padding: 15px;
        justify-content: space-between;
        align-items: center;
        border-bottom: 1px solid var(--border-color);
        position: fixed;
        top: 0;
        width: 100%;
        z-index: 1000;
        box-sizing: border-box;
      }
      .mobile-menu-btn {
        background: none;
        border: none;
        font-size: 24px;
        color: var(--text-main);
        cursor: pointer;
      }

      .sidebar {
        width: 260px;
        background: var(--surface);
        height: 100%;
        border-left: 1px solid var(--border-color);
        display: flex;
        flex-direction: column;
        padding: 20px;
        box-shadow: 2px 0 10px rgba(0, 0, 0, 0.02);
        z-index: 1001;
        transition: 0.3s;
      }
      .logo {
        font-size: 22px;
        font-weight: 800;
        color: var(--primary);
        margin-bottom: 40px;
        display: flex;
        align-items: center;
        gap: 10px;
      }
      .nav-item {
        padding: 12px 15px;
        margin-bottom: 8px;
        cursor: pointer;
        border-radius: 10px;
        color: var(--secondary);
        font-weight: 500;
        transition: 0.3s;
        display: flex;
        align-items: center;
        gap: 12px;
      }
      .nav-item:hover {
        background: var(--bg);
        color: var(--primary);
      }
      .nav-item.active {
        background: var(--primary);
        color: white;
        box-shadow: 0 4px 12px rgba(67, 56, 202, 0.3);
      }
      .nav-item i {
        width: 20px;
        text-align: center;
        font-size: 18px;
      }

      .overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        display: none;
      }

      .main-content {
        flex: 1;
        padding: 30px;
        overflow-y: auto;
        width: 100%;
      }
      .header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
      }
      .page-title {
        font-size: 24px;
        font-weight: 700;
        color: var(--text-main);
      }
      .btn-preview {
        background: var(--surface);
        border: 1px solid var(--border-color);
        padding: 10px 20px;
        border-radius: 30px;
        color: var(--primary);
        font-weight: bold;
        text-decoration: none;
        display: flex;
        align-items: center;
        gap: 8px;
        transition: 0.3s;
      }
      .btn-preview:hover {
        border-color: var(--primary);
        background: var(--primary-light);
      }

      .login-wrapper {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: var(--bg);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 2000;
      }
      .login-box {
        background: var(--surface);
        padding: 40px;
        border-radius: 20px;
        width: 400px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        text-align: center;
      }

      .card {
        background: var(--surface);
        border-radius: 16px;
        padding: 25px;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
        border: 1px solid var(--border-color);
        margin-bottom: 25px;
      }
      .form-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
      }
      .form-group {
        margin-bottom: 15px;
      }
      .form-label {
        display: block;
        margin-bottom: 8px;
        font-size: 14px;
        font-weight: 600;
        color: var(--secondary);
      }
      input,
      select,
      textarea {
        width: 100%;
        padding: 12px 15px;
        border: 1px solid #cbd5e1;
        border-radius: 10px;
        font-family: inherit;
        font-size: 14px;
        transition: 0.3s;
        outline: none;
        box-sizing: border-box;
        background: var(--bg);
        color: var(--text-main);
      }
      input:focus,
      select:focus,
      textarea:focus {
        border-color: var(--primary);
        box-shadow: 0 0 0 3px var(--primary-light);
      }

      input[type="file"] {
        display: none;
      }

      .custom-file-upload {
        border: 1px solid #cbd5e1;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        padding: 10px 15px;
        cursor: pointer;
        border-radius: 10px;
        background: var(--bg);
        color: var(--secondary);
        font-size: 14px;
        font-weight: 500;
        transition: 0.2s;
        height: 45px;
        box-sizing: border-box;
        width: 100%;
        white-space: nowrap;
      }
      .custom-file-upload:hover {
        border-color: var(--primary);
        color: var(--primary);
      }

      .img-preview {
        width: 45px;
        height: 45px;
        border-radius: 8px;
        object-fit: cover;
        display: none;
        border: 1px solid var(--border-color);
        margin-right: 10px;
      }

      .btn {
        padding: 12px 20px;
        border: none;
        border-radius: 10px;
        cursor: pointer;
        font-weight: bold;
        font-size: 14px;
        transition: 0.2s;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
      }
      .btn-primary {
        background: var(--primary);
        color: white;
        width: 100%;
      }
      .btn-primary:hover {
        background: #3730a3;
      }
      .btn-success {
        background: var(--success);
        color: white;
      }
      .btn-outline {
        background: transparent;
        border: 1px solid #cbd5e1;
        color: var(--secondary);
      }

      .search-container {
        position: relative;
        max-width: 400px;
        margin-bottom: 20px;
      }
      .search-input {
        padding-right: 40px;
        border-radius: 50px;
        background: var(--surface);
        border: 1px solid var(--border-color);
        color: var(--text-main);
      }
      .search-icon {
        position: absolute;
        right: 15px;
        top: 13px;
        color: var(--secondary);
      }

      .table-wrapper {
        overflow-x: auto;
        background: var(--surface);
        border-radius: 16px;
        border: 1px solid var(--border-color);
      }
      table {
        width: 100%;
        border-collapse: collapse;
        min-width: 600px;
      }
      th {
        background: var(--bg);
        text-align: right;
        padding: 18px;
        font-size: 13px;
        color: var(--secondary);
        font-weight: 700;
        border-bottom: 1px solid var(--border-color);
      }
      td {
        padding: 15px;
        border-bottom: 1px solid var(--border-color);
        font-size: 14px;
        vertical-align: middle;
        color: var(--text-main);
      }
      tr:last-child td {
        border-bottom: none;
      }
      tr:hover {
        background: var(--bg);
      }

      .badge {
        padding: 4px 10px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: bold;
      }
      .badge-cat {
        background: var(--primary-light);
        color: var(--primary);
      }

      .bulk-card {
        background: var(--surface);
        border: 1px dashed #cbd5e1;
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 15px;
        position: relative;
        transition: 0.3s;
      }
      .bulk-card:hover {
        border-color: var(--primary);
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
      }
      .btn-remove-row {
        position: absolute;
        left: 15px;
        top: 15px;
        color: var(--danger);
        background: var(--bg);
        border: none;
        width: 30px;
        height: 30px;
        border-radius: 50%;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: 0.2s;
      }
      .btn-remove-row:hover {
        background: var(--danger);
        color: white;
      }

     .hidden {
        display: none !important;
      }


.mobile-bottom-nav { display: none; }

@media (max-width: 768px) {
    
    .sidebar {
        position: fixed !important;
        z-index: 9999 !important;
        width: 100% !important;
        right: -100% !important;
        top: 0 !important;
        background: rgba(255,255,255,0.98) !important;
        backdrop-filter: blur(10px);
        transition: right 0.3s ease-in-out;
    }
    .sidebar.active { right: 0 !important; }

    .mobile-bottom-nav {
        display: flex;
        position: fixed;
        bottom: 0; left: 0; width: 100%;
        height: 65px;
        background: #ffffff;
        box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
        z-index: 9000;
        justify-content: space-around;
        align-items: center;
        border-top: 1px solid #f1f5f9;
        padding-bottom: 5px;
    }

    .nav-icon {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        color: #94a3b8;
        font-size: 10px;
        width: 20%;
        cursor: pointer;
        position: relative;
    }

    .nav-icon i { font-size: 20px; margin-bottom: 4px; transition: 0.2s; }
    
    .nav-icon.active { color: var(--primary); font-weight: bold; }
    .nav-icon.active i { transform: translateY(-3px); }

    body { background: #f8fafc; padding-bottom: 80px; }
    
    .main-content {
        width: 100% !important;
        padding: 70px 15px 20px 15px !important;
        margin: 0 !important;
    }

    .mobile-header {
        height: 60px;
        background: #ffffff;
        box-shadow: 0 1px 5px rgba(0,0,0,0.03);
        position: fixed; top: 0; left: 0; width: 100%;
        z-index: 8000;
        padding: 0 15px;
        display: flex !important;
        align-items: center;
        justify-content: space-between;
    }
    
    .mobile-menu-btn { display: none !important; }

    .table-wrapper { background: transparent !important; border: none !important; box-shadow: none !important; }
    table { display: block !important; width: 100% !important; min-width: 0 !important; }
    thead { display: none !important; }
    tbody, th, td, tr { display: block !important; width: 100% !important; }

    tr {
        background: #fff;
        margin-bottom: 10px;
        border-radius: 12px;
        padding: 12px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        border: 1px solid #f1f5f9;
        position: relative;
    }

    td {
        display: flex !important;
        justify-content: space-between;
        align-items: center;
        padding: 6px 0 !important;
        border-bottom: 1px dashed #f1f5f9;
        text-align: right;
        font-size: 13px;
        color: #334155;
    }
    
    td:last-child { border-bottom: none !important; padding-top: 10px !important; justify-content: flex-end; gap: 5px; }
    
    td img { width: 40px !important; height: 40px !important; border-radius: 8px !important; }

    .card {
        border-radius: 16px !important;
        border: none !important;
        box-shadow: 0 2px 10px rgba(0,0,0,0.02) !important;
        padding: 15px !important;
        margin-bottom: 15px !important;
    }
    
    .form-grid { display: flex !important; flex-direction: column !important; gap: 10px !important; }
    
    input, select, textarea {
        height: 40px !important;
        background: #f8fafc !important;
        border: 1px solid #e2e8f0 !important;
        border-radius: 8px !important;
        font-size: 14px !important;
        padding: 0 10px !important;
    }

    .btn { 
        height: 40px !important; 
        border-radius: 8px !important; 
        font-size: 14px !important; 
        padding: 0 15px !important;
    }
    .table-wrapper { background: transparent !important; border: none !important; box-shadow: none !important; }
    table { display: block !important; width: 100% !important; min-width: 0 !important; }
    thead { display: none !important; }
    tbody, th, td, tr { display: block !important; width: 100% !important; }

    tr {
        background: #fff;
        margin-bottom: 10px;
        border-radius: 12px;
        padding: 12px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        border: 1px solid #f1f5f9;
        position: relative;
    }

    td {
        display: flex !important;
        justify-content: space-between;
        align-items: center;
        padding: 6px 0 !important;
        border-bottom: 1px dashed #f1f5f9;
        text-align: right;
        font-size: 13px;
        color: #334155;
    }
    
    td:last-child { border-bottom: none !important; padding-top: 10px !important; justify-content: flex-end; gap: 5px; }
    
    td img { width: 40px !important; height: 40px !important; border-radius: 8px !important; }

    .card {
        border-radius: 16px !important;
        border: none !important;
        box-shadow: 0 2px 10px rgba(0,0,0,0.02) !important;
        padding: 15px !important;
        margin-bottom: 15px !important;
    }
    
    .form-grid { display: flex !important; flex-direction: column !important; gap: 10px !important; }
    
    input, select, textarea {
        height: 40px !important;
        background: #f8fafc !important;
        border: 1px solid #e2e8f0 !important;
        border-radius: 8px !important;
        font-size: 14px !important;
        padding: 0 10px !important;
    }

    .btn { 
        height: 40px !important; 
        border-radius: 8px !important; 
        font-size: 14px !important; 
        padding: 0 15px !important;
    }


    #preview-link { display: none !important; }

    #recent-orders-modal {
        z-index: 999999 !important;
        background: rgba(0,0,0,0.85) !important;
    }

    #recent-orders-modal[style*="block"] {
        display: flex !important;
        align-items: center;
        justify-content: center;
    }

    #recent-orders-modal .card {
        width: 90% !important;
        max-width: 90% !important;
        margin: 0 !important;
        max-height: 80vh !important;
    }

    
    #recent-orders-modal.overlay { 
        display: none; 
        z-index: 99999 !important;
    }

    #orders-grid { grid-template-columns: 1fr !important; }
    .phone-frame { width: 100% !important; height: 550px !important; border-width: 4px !important; }
}

.mobile-bottom-nav { display: none; }

@media (max-width: 768px) {
    
    .sidebar {
        position: fixed !important;
        z-index: 9999 !important;
        width: 100% !important;
        right: -100% !important;
        top: 0 !important;
        background: rgba(255,255,255,0.98) !important;
        backdrop-filter: blur(10px);
        transition: right 0.3s ease-in-out;
    }
    .sidebar.active { right: 0 !important; }

    .mobile-bottom-nav {
        display: flex;
        position: fixed;
        bottom: 0; left: 0; width: 100%;
        height: 65px;
        background: #ffffff;
        box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
        z-index: 9000;
        justify-content: space-around;
        align-items: center;
        border-top: 1px solid #f1f5f9;
        padding-bottom: 5px;
    }

    .nav-icon {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        color: #94a3b8;
        font-size: 10px;
        width: 20%;
        cursor: pointer;
        position: relative;
    }

    .nav-icon i { font-size: 20px; margin-bottom: 4px; transition: 0.2s; }
    
    .nav-icon.active { color: var(--primary); font-weight: bold; }
    .nav-icon.active i { transform: translateY(-3px); }

    body { background: #f8fafc; padding-bottom: 80px; }
    
    .main-content {
        width: 100% !important;
        padding: 70px 15px 20px 15px !important;
        margin: 0 !important;
    }

    .mobile-header {
        height: 60px;
        background: #ffffff;
        box-shadow: 0 1px 5px rgba(0,0,0,0.03);
        position: fixed; top: 0; left: 0; width: 100%;
        z-index: 8000;
        padding: 0 15px;
        display: flex !important;
        align-items: center;
        justify-content: space-between;
    }
    
    .mobile-menu-btn { display: none !important; }

    .table-wrapper { background: transparent !important; border: none !important; box-shadow: none !important; }
    table { display: block !important; width: 100% !important; min-width: 0 !important; }
    thead { display: none !important; }
    tbody, th, td, tr { display: block !important; width: 100% !important; }

    tr {
        background: #fff;
        margin-bottom: 10px;
        border-radius: 12px;
        padding: 12px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        border: 1px solid #f1f5f9;
        position: relative;
    }

    td {
        display: flex !important;
        justify-content: space-between;
        align-items: center;
        padding: 6px 0 !important;
        border-bottom: 1px dashed #f1f5f9;
        text-align: right;
        font-size: 13px;
        color: #334155;
    }
    
    td:last-child { border-bottom: none !important; padding-top: 10px !important; justify-content: flex-end; gap: 5px; }
    
    td img { width: 40px !important; height: 40px !important; border-radius: 8px !important; }

    .card {
        border-radius: 16px !important;
        border: none !important;
        box-shadow: 0 2px 10px rgba(0,0,0,0.02) !important;
        padding: 15px !important;
        margin-bottom: 15px !important;
    }
    
    .form-grid { display: flex !important; flex-direction: column !important; gap: 10px !important; }
    
    input, select, textarea {
        height: 40px !important;
        background: #f8fafc !important;
        border: 1px solid #e2e8f0 !important;
        border-radius: 8px !important;
        font-size: 14px !important;
        padding: 0 10px !important;
    }

    .btn { 
        height: 40px !important; 
        border-radius: 8px !important; 
        font-size: 14px !important; 
        padding: 0 15px !important;
    }
    .table-wrapper { background: transparent !important; border: none !important; box-shadow: none !important; }
    table { display: block !important; width: 100% !important; min-width: 0 !important; }
    thead { display: none !important; }
    tbody, th, td, tr { display: block !important; width: 100% !important; }

    tr {
        background: #fff;
        margin-bottom: 10px;
        border-radius: 12px;
        padding: 12px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        border: 1px solid #f1f5f9;
        position: relative;
    }

    td {
        display: flex !important;
        justify-content: space-between;
        align-items: center;
        padding: 6px 0 !important;
        border-bottom: 1px dashed #f1f5f9;
        text-align: right;
        font-size: 13px;
        color: #334155;
    }
    
    td:last-child { border-bottom: none !important; padding-top: 10px !important; justify-content: flex-end; gap: 5px; }
    
    td img { width: 40px !important; height: 40px !important; border-radius: 8px !important; }

    .card {
        border-radius: 16px !important;
        border: none !important;
        box-shadow: 0 2px 10px rgba(0,0,0,0.02) !important;
        padding: 15px !important;
        margin-bottom: 15px !important;
    }
    
    .form-grid { display: flex !important; flex-direction: column !important; gap: 10px !important; }
    
    input, select, textarea {
        height: 40px !important;
        background: #f8fafc !important;
        border: 1px solid #e2e8f0 !important;
        border-radius: 8px !important;
        font-size: 14px !important;
        padding: 0 10px !important;
    }

    .btn { 
        height: 40px !important; 
        border-radius: 8px !important; 
        font-size: 14px !important; 
        padding: 0 15px !important;
    }


    #preview-link { display: none !important; }

    #recent-orders-modal {
        z-index: 999999 !important;
        background: rgba(0,0,0,0.85) !important;
    }

    #recent-orders-modal[style*="block"] {
        display: flex !important;
        align-items: center;
        justify-content: center;
    }

    #recent-orders-modal .card {
        width: 90% !important;
        max-width: 90% !important;
        margin: 0 !important;
        max-height: 80vh !important;
    }

    #recent-orders-modal.overlay { 
        display: none; 
        z-index: 99999 !important;
    }

    #orders-grid { grid-template-columns: 1fr !important; }
    .phone-frame { width: 100% !important; height: 550px !important; border-width: 4px !important; }
}
:root {
        --primary: #4338ca;
        --primary-light: #e0e7ff;
        --secondary: #64748b;
        --bg: #f8fafc;
        --surface: #ffffff;
        --border-color: #e2e8f0;
        --text-main: #1e293b;
        --success: #10b981;
        --danger: #ef4444;
        --warning: #f59e0b;
        --radius: 16px;
        --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
      }

      body.dark-mode {
        --primary: #6366f1;
        --primary-light: #312e81;
        --secondary: #94a3b8;
        --bg: #0f172a;
        --surface: #1e293b;
        --border-color: #334155;
        --text-main: #f1f5f9;
        --shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
      }

      * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
      
      body {
        font-family: "Tajawal", sans-serif;
        background: var(--bg);
        margin: 0;
        display: flex;
        height: 100vh;
        overflow: hidden;
        color: var(--text-main);
        transition: background 0.3s, color 0.3s;
      }

      @keyframes fadeInScale {
        0% { opacity: 0; transform: scale(0.98) translateY(10px); }
        100% { opacity: 1; transform: scale(1) translateY(0); }
      }
      
      @keyframes slideInRight {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
      }

      .view-animate {
        animation: fadeInScale 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards;
      }

      .sidebar {
        width: 280px;
        background: var(--surface);
        height: 100%;
        border-left: 1px solid var(--border-color);
        display: flex;
        flex-direction: column;
        padding: 15px 10px;
        z-index: 1001;
        transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        overflow-y: auto;
      }
      .sidebar::-webkit-scrollbar { width: 4px; }
      .sidebar::-webkit-scrollbar-track { background: transparent; }
      .sidebar::-webkit-scrollbar-thumb { background: var(--border-color); border-radius: 10px; }

      .logo {
        font-size: 24px;
        font-weight: 800;
        color: var(--primary);
        margin-bottom: 40px;
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 0 10px;
      }

      .nav-item {
        padding: 10px 14px;
        margin-bottom: 4px;
        cursor: pointer;
        border-radius: 10px;
        color: var(--secondary);
        font-weight: 600;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        gap: 12px;
        font-size: 14px;
      }

      .nav-item:hover {
        background: var(--bg);
        color: var(--primary);
        transform: translateX(-5px);
      }

      .nav-item.active {
        background: var(--primary);
        color: white;
        box-shadow: 0 4px 15px rgba(67, 56, 202, 0.25);
        transform: translateX(-5px);
      }

      .main-content {
        flex: 1;
        padding: 30px;
        overflow-y: auto;
        width: 100%;
        scroll-behavior: smooth;
      }

      .header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
      }

      .page-title {
        font-size: 26px;
        font-weight: 800;
        color: var(--text-main);
      }

      .card {
        background: var(--surface);
        border-radius: var(--radius);
        padding: 25px;
        box-shadow: var(--shadow);
        border: 1px solid var(--border-color);
        margin-bottom: 25px;
        transition: transform 0.2s, box-shadow 0.2s;
      }
      
      .form-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
      }

      .form-label {
        display: block;
        margin-bottom: 8px;
        font-size: 14px;
        font-weight: 600;
        color: var(--secondary);
      }

      input, select, textarea {
        width: 100%;
        padding: 14px 16px;
        border: 1.5px solid var(--border-color);
        border-radius: 12px;
        font-family: inherit;
        font-size: 15px;
        transition: all 0.3s;
        outline: none;
        background: var(--bg);
        color: var(--text-main);
      }

      input:focus, select:focus, textarea:focus {
        border-color: var(--primary);
        box-shadow: 0 0 0 4px var(--primary-light);
        background: var(--surface);
        transform: translateY(-2px);
      }

      .btn {
        padding: 14px 24px;
        border: none;
        border-radius: 12px;
        cursor: pointer;
        font-weight: 700;
        font-size: 15px;
        transition: all 0.2s;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
        position: relative;
        overflow: hidden;
      }
      
      .btn:active { transform: scale(0.96); }

      .btn-primary {
        background: var(--primary);
        color: white;
        box-shadow: 0 4px 15px rgba(67, 56, 202, 0.2);
      }
      .btn-primary:hover { background: #3730a3; box-shadow: 0 6px 20px rgba(67, 56, 202, 0.3); }

      .btn-success { background: var(--success); color: white; }
      .btn-outline { background: transparent; border: 1.5px solid var(--border-color); color: var(--secondary); }
      .btn-outline:hover { border-color: var(--secondary); background: var(--bg); }

      .custom-file-upload {
        border: 1.5px dashed var(--border-color);
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
        padding: 12px;
        cursor: pointer;
        border-radius: 12px;
        background: var(--bg);
        color: var(--secondary);
        font-weight: 600;
        transition: 0.2s;
        width: 100%;
        height: 50px;
      }
      .custom-file-upload:hover { border-color: var(--primary); color: var(--primary); background: var(--primary-light); }

      .table-wrapper {
        overflow-x: auto;
        background: var(--surface);
        border-radius: var(--radius);
        border: 1px solid var(--border-color);
        box-shadow: var(--shadow);
      }
      table { width: 100%; border-collapse: collapse; min-width: 600px; }
      th { background: var(--bg); text-align: right; padding: 18px; color: var(--secondary); font-weight: 700; }
      td { padding: 18px; border-bottom: 1px solid var(--border-color); color: var(--text-main); }
      
      .mobile-header, .mobile-bottom-nav, .overlay { display: none; }

      @media (max-width: 768px) {
        .sidebar {
          position: fixed;
          top: 0; right: -100%; width: 85%; max-width: 300px;
          box-shadow: -5px 0 25px rgba(0,0,0,0.1);
          transition: right 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        }
        .sidebar.active { right: 0; }
        
        .overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.4); backdrop-filter: blur(4px);
            z-index: 1000;
            display: none; opacity: 0; transition: opacity 0.3s;
        }
        .overlay.visible { display: block; opacity: 1; }

        .main-content {
            padding: 80px 15px 100px 15px !important;
        }

        .mobile-header {
            display: flex; justify-content: space-between; align-items: center;
            position: fixed; top: 0; left: 0; width: 100%; height: 65px;
            background: rgba(255,255,255,0.95); backdrop-filter: blur(10px);
            padding: 0 20px; z-index: 900;
            border-bottom: 1px solid var(--border-color);
            box-shadow: 0 2px 10px rgba(0,0,0,0.03);
        }
        body.dark-mode .mobile-header { background: rgba(30, 41, 59, 0.95); }

        .mobile-bottom-nav {
            display: flex; position: fixed; bottom: 0; left: 0; width: 100%;
            background: var(--surface); border-top: 1px solid var(--border-color);
            padding: 10px 0 25px 0;
            z-index: 900; justify-content: space-around;
            box-shadow: 0 -4px 20px rgba(0,0,0,0.05);
        }
        .nav-icon {
            display: flex; flex-direction: column; align-items: center;
            font-size: 11px; color: var(--secondary); gap: 5px;
            transition: 0.3s; padding: 5px 10px; border-radius: 12px;
        }
        .nav-icon i { font-size: 22px; margin-bottom: 2px; transition: 0.3s; }
        .nav-icon.active { color: var(--primary); font-weight: bold; background: var(--primary-light); }
        .nav-icon.active i { transform: translateY(-2px); }

        .table-wrapper { background: transparent; border: none; box-shadow: none; overflow: visible; }
        table, thead, tbody, th, td, tr { display: block; }
        thead { display: none; }
        
        tr {
            background: var(--surface);
            border-radius: 16px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
            border: 1px solid var(--border-color);
            position: relative;
            animation: fadeInScale 0.4s ease-out;
        }
        
        td {
            padding: 8px 0;
            border-bottom: 1px dashed var(--border-color);
            display: flex; justify-content: space-between; align-items: center;
            font-size: 14px;
        }
        td:last-child { border-bottom: none; padding-top: 15px; justify-content: flex-end; gap: 8px; }
        
        .form-grid { grid-template-columns: 1fr; gap: 15px; }
        input, select, textarea { height: 48px; font-size: 16px; }
        .btn { height: 48px; width: 100%; margin-top: 5px; }
        
        .btn-preview { display: none; }
        .phone-frame { width: 100% !important; height: 500px !important; }
        #live-preview { border-radius: 20px; }
      }

      .hidden { display: none !important; }
      .badge { padding: 4px 10px; border-radius: 20px; font-size: 12px; font-weight: 700; }
      .img-preview { width: 48px; height: 48px; border-radius: 10px; object-fit: cover; border: 1px solid var(--border-color); display:none; }
      .layout-options-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 12px;
        margin-top: 10px;
      }

      .btn-layout {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: 8px;
        padding: 15px 10px;
        background: var(--surface);
        border: 2px solid var(--border-color);
        border-radius: 16px;
        cursor: pointer;
        transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        color: var(--secondary);
        font-size: 13px;
        font-weight: 700;
        height: 100px;
      }

      .btn-layout i {
        font-size: 28px;
        margin-bottom: 5px;
        color: var(--secondary);
        transition: 0.2s;
      }

      .btn-layout:hover {
        border-color: var(--primary);
        background: var(--bg);
        transform: translateY(-3px);
      }

      .btn-layout.active {
        border-color: var(--primary);
        background: var(--primary-light);
        color: var(--primary);
        box-shadow: 0 4px 12px rgba(67, 56, 202, 0.15);
      }

      .btn-layout.active i {
        color: var(--primary);
        transform: scale(1.1);
      }

      .phone-mockup-wrapper {
        flex: 1;
        min-width: 350px;
        display: flex;
        justify-content: center;
        align-items: center;
        background: #1e293b;
        border-radius: 30px;
        padding: 40px 20px;
        box-shadow: inset 0 0 50px rgba(0,0,0,0.3);
        position: relative;
        overflow: hidden;
      }

      .phone-frame {
        width: 340px;
        height: 700px;
        background: #000;
        border-radius: 50px;
        box-shadow: 
            0 0 0 12px #2d3748,
            0 0 0 14px #000,
            0 25px 50px -12px rgba(0, 0, 0, 0.6);
        border: 8px solid #000;
        overflow: hidden;
        position: relative;
        z-index: 10;
        transition: transform 0.3s;
      }

      .phone-frame::before {
        content: '';
        position: absolute;
        top: 0;
        left: 50%;
        transform: translateX(-50%);
        width: 150px;
        height: 30px;
        background: #000;
        border-bottom-left-radius: 16px;
        border-bottom-right-radius: 16px;
        z-index: 20;
      }

      iframe#live-preview {
        width: 100%;
        height: 100%;
        border: none;
        background: white;
        border-radius: 40px;
        display: block;
      }

      @media (max-width: 1200px) {
        .phone-frame {
            transform: scale(0.9);
        }
      }
    </style>
  </head>
  <body>
    <div class="mobile-header">
      <div style="display:flex; align-items:center; gap:15px;">
          <button class="mobile-menu-btn" onclick="toggleSidebar()">
            <i class="fas fa-bars"></i>
          </button>
          <div class="logo" style="margin: 0; font-size: 18px; display:flex; align-items:center; gap:5px;">
            <i class="fas fa-pizza-slice" style="color:var(--primary)"></i> Smart Menu
          </div>
      </div>
      <div style="display:flex; gap:15px; align-items:center;">
          <button onclick="toggleDarkMode()" style="background:none; border:none; font-size:18px; color:var(--text-main);">
            <i class="fas fa-adjust"></i>
          </button>
          <button onclick="logout()" style="background:none; border:none; font-size:18px; color:var(--danger);">
            <i class="fas fa-sign-out-alt"></i>
          </button>
      </div>
    </div>
    <div class="overlay" onclick="toggleSidebar()"></div>

    <div
      id="dashboard-section"
      class="hidden"
      style="display: flex; width: 100%"
    >
      <div class="sidebar" id="sidebar">
        <button class="btn-close-sidebar" style="display:none;" onclick="toggleSidebar()">
            <i class="fas fa-times"></i>
        </button>

        <div class="logo"><i class="fas fa-pizza-slice"></i> Smart Menu</div>

        <div
          class="nav-item active"
          onclick="switchView('categories')"
          id="nav-categories"
        >
          <i class="fas fa-layer-group"></i> الأقسام
        </div>
        <div
          class="nav-item"
          onclick="switchView('products')"
          id="nav-products"
        >
          <i class="fas fa-hamburger"></i> المنتجات
        </div>
        <div class="nav-item" onclick="switchView('bulk')" id="nav-bulk">
          <i class="fas fa-rocket"></i> إضافة جملة
        </div>
        
        <div class="nav-item" onclick="switchView('orders')" id="nav-orders">
          <i class="fas fa-bell"></i> الطلبات الحية
          <span
            id="live-badge"
            class="badge badge-cat hidden"
            style="background: var(--danger); color: white"
            >0</span
          >
        </div>

        <div class="nav-item hidden" onclick="switchView('recipes')" id="nav-recipes">
          <i class="fas fa-blender"></i> إدارة المقادير
        </div>
        <div class="nav-item hidden" onclick="switchView('stock')" id="nav-stock">
          <i class="fas fa-boxes"></i> إدارة المخزن
        </div>
        <div class="nav-item" onclick="switchView('history')" id="nav-history">
          <i class="fas fa-history"></i> سجل المبيعات
        </div>
        <div class="nav-item" onclick="switchView('design')" id="nav-design">
          <i class="fas fa-paint-brush"></i> التصميم
        </div>
        <div
          class="nav-item"
          onclick="switchView('settings')"
          id="nav-settings"
        >
          <i class="fas fa-cog"></i> إعدادات المتجر
        </div>
        <div
          class="nav-item hidden"
          onclick="switchView('staff')"
          id="nav-staff"
        >
          <i class="fas fa-users-cog"></i> إدارة الموظفين
        </div>

        <div
          class="nav-item hidden"
          onclick="switchView('coupons')"
          id="nav-coupons"
        >
          <i class="fas fa-ticket-alt"></i> الكوبونات
        </div>
        <div class="nav-item" onclick="toggleDarkMode()">
          <i class="fas fa-moon"></i> وضع ليلي/نهاري
        </div>

        <div style="margin-top: auto">
          <div class="nav-item" onclick="logout()" style="color: var(--danger)">
            <i class="fas fa-sign-out-alt"></i> خروج
          </div>
        </div>
      </div>

      <div class="main-content">
        <div class="header">
          <div class="page-title" id="page-title">جارِ التحميل...</div>
          <a href="#" id="preview-link" target="_blank" class="btn-preview">
            <i class="fas fa-external-link-alt"></i> معاينة المنيو
          </a>
        </div>

        <div id="view-orders" class="hidden">
          <div
            style="
              display: flex;
              justify-content: space-between;
              align-items: center;
              margin-bottom: 20px;
            "
          >
            <h3 style="margin: 0; color: var(--primary)">الطلبات الواردة</h3>
            <button
              id="btn-recent-orders"
              class="btn btn-primary"
              onclick="showRecentOrders()"
              style="margin-left: 10px"
            >
              <i class="fas fa-history"></i> فواتير سابقة
            </button>
            <button 
              class="btn btn-success" 
              onclick="openManualOrderModal()"
              style="margin-left: 10px; background: #059669;"
            >
              <i class="fas fa-plus-circle"></i> أوردر يدوي
            </button>
            <button class="btn btn-outline" onclick="loadOrders()">
              <i class="fas fa-sync"></i> تحديث
            </button>
          </div>
          <div style="margin-bottom: 20px; display: flex; gap: 10px">
            <input
              type="number"
              id="live-order-search"
              placeholder="ابحث برقم الطلب اليومي..."
              style="
                padding: 10px;
                border-radius: 8px;
                border: 1px solid var(--border-color);
                flex: 1;
              "
              onkeydown="if (event.key === 'Enter') searchOrderHistory();"
            />
            <button
              class="btn btn-primary"
              onclick="searchOrderHistory()"
              style="width: auto"
            >
              <i class="fas fa-search"></i> بحث
            </button>
          </div>
          <div
            id="orders-grid"
            style="
              display: grid;
              grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
              gap: 20px;
            "
          ></div>
          <audio
            id="order-sound"
            src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3"
          ></audio>
        </div>

        <div id="view-history" class="hidden">
          <div
            style="
              display: flex;
              justify-content: space-between;
              align-items: center;
              margin-bottom: 20px;
              flex-wrap: wrap;
              gap: 10px;
            "
          >
            <h3 style="margin: 0; color: var(--primary)">
              <span id="history-title">سجل الجرد</span>
            </h3>

            <div
              id="owner-filters"
              class="hidden"
              style="display: flex; gap: 10px; align-items: center"
            >
              <input
                type="date"
                id="filter-start"
                style="padding: 5px; height: 35px"
              />
              <span style="font-weight: bold">:</span>
              <input
                type="date"
                id="filter-end"
                style="padding: 5px; height: 35px"
              />
              <button
                class="btn btn-primary"
                style="height: 35px; padding: 0 15px"
                onclick="window.loadHistory()"
              >
                <i class="fas fa-filter"></i> عرض
              </button>
              <input
                type="text"
                id="history-search"
                placeholder="رقم الطلب / الطاولة"
                style="padding: 5px; height: 35px; width: 120px"
              />
            </div>

            <button class="btn btn-outline" onclick="window.loadHistory()">
              <i class="fas fa-sync"></i> تحديث
            </button>
            <button class="btn btn-success" onclick="exportToExcel('sales-table', 'تقرير_المبيعات')">
  <i class="fas fa-file-excel"></i> تصدير Excel
</button>
          </div>

          <div
            style="
              background: linear-gradient(45deg, var(--primary), #6366f1);
              color: white;
              padding: 20px;
              border-radius: 16px;
              margin-bottom: 25px;
              display: flex;
              justify-content: space-between;
              align-items: center;
              box-shadow: 0 4px 15px rgba(99, 102, 241, 0.3);
            "
          >
            <div>
              <div style="font-size: 14px; opacity: 0.9">
                إجمالي المبيعات (كل الأوقات)
              </div>
              <div
                style="font-size: 32px; font-weight: 800"
                id="total-sales-display"
              >
                0 ج.م
              </div>
            </div>
            <i class="fas fa-wallet fa-3x" style="opacity: 0.2"></i>
          </div>

          <div class="table-wrapper">
  <table id="sales-table">
    <thead>
                <tr>
                  <th>رقم الطلب</th>
                  <th>التاريخ</th>
                  <th>الطاولة</th>
                  <th>الأصناف</th>
                  <th>الإجمالي</th>
                  <th>الحالة</th>
                </tr>
              </thead>
              <tbody id="history-list"></tbody>
            </table>
          </div>
        </div>

        <div id="view-categories">
          <div class="card">
            <h3
              style="
                margin-top: 0;
                margin-bottom: 15px;
                color: var(--primary);
                font-size: 18px;
                display: flex;
                justify-content: space-between;
              "
            >
              <span id="cat-form-title">إضافة قسم جديد</span>
              <button
                id="btn-cancel-cat"
                class="btn btn-outline hidden"
                onclick="resetCategoryForm()"
                style="font-size: 12px; padding: 2px 10px"
              >
                إلغاء التعديل
              </button>
            </h3>

            <div
              style="
                display: flex;
                gap: 15px;
                align-items: flex-end;
                flex-wrap: wrap;
              "
            >
              <input type="hidden" id="edit-cat-id" />

              <div style="flex-grow: 1; min-width: 200px">
                <label class="form-label">اسم القسم</label>
                <input type="text" id="c-name" placeholder="" />
              </div>
              <div style="width: auto; min-width: 180px; flex-grow: 1">
                <label class="form-label">الغلاف (اختياري)</label>
                <div style="display: flex; align-items: center">
                  <img id="c-preview" class="img-preview" />
                  <label for="c-image" class="custom-file-upload">
                    <i class="fas fa-image"></i> اختر صورة
                  </label>
                  <input
                    type="file"
                    id="c-image"
                    accept="image/*"
                    onchange="previewImage(this, 'c-preview')"
                  />
                </div>
              </div>
              <div style="width: auto">
                <button
                  id="btn-save-cat"
                  class="btn btn-primary"
                  style="height: 45px; padding: 0 25px"
                  onclick="saveCategory()"
                >
                  <i class="fas fa-plus"></i> حفظ
                </button>
              </div>
            </div>
          </div>

          <div
            id="cat-stats-bar"
            style="display: flex; gap: 15px; margin-bottom: 20px"
          >
            <div
              style="
                background: white;
                padding: 15px;
                border-radius: 12px;
                border: 1px solid var(--border-color);
                flex: 1;
                display: flex;
                align-items: center;
                gap: 15px;
                box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
              "
            >
              <div
                style="
                  background: var(--primary-light);
                  color: var(--primary);
                  width: 50px;
                  height: 50px;
                  border-radius: 50%;
                  display: flex;
                  align-items: center;
                  justify-content: center;
                  font-size: 20px;
                "
              >
                <i class="fas fa-layer-group"></i>
              </div>
              <div>
                <div style="font-size: 12px; color: var(--secondary)">
                  عدد الأقسام
                </div>
                <div
                  style="font-size: 20px; font-weight: 800"
                  id="stat-total-cats"
                >
                  0
                </div>
              </div>
            </div>
            <div
              style="
                background: white;
                padding: 15px;
                border-radius: 12px;
                border: 1px solid var(--border-color);
                flex: 1;
                display: flex;
                align-items: center;
                gap: 15px;
                box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
              "
            >
              <div
                style="
                  background: #dcfce7;
                  color: #166534;
                  width: 50px;
                  height: 50px;
                  border-radius: 50%;
                  display: flex;
                  align-items: center;
                  justify-content: center;
                  font-size: 20px;
                "
              >
                <i class="fas fa-hamburger"></i>
              </div>
              <div>
                <div style="font-size: 12px; color: var(--secondary)">
                  إجمالي المنتجات
                </div>
                <div
                  style="font-size: 20px; font-weight: 800"
                  id="stat-total-prods"
                >
                  0
                </div>
              </div>
            </div>
          </div>

          <div class="table-wrapper">
            <table>
              <thead>
                <tr>
                  <th>الغلاف</th>
                  <th>اسم القسم</th>
                  <th>عدد المنتجات</th>
                  <th>إجراءات</th>
                </tr>
              </thead>
              <tbody id="categories-list"></tbody>
            </table>
          </div>
        </div>

        <div id="view-products" class="hidden">
          <div class="search-container">
            <i class="fas fa-search search-icon"></i>
            <input
              type="text"
              class="search-input"
              id="searchInput"
              onkeyup="searchTable()"
              placeholder="ابحث عن منتج أو قسم..."
            />
          </div>

          <div class="card">
            <h3
              style="
                margin-top: 0;
                font-size: 18px;
                margin-bottom: 20px;
                color: var(--primary);
              "
            >
              <span id="form-mode-title">إضافة منتج جديد</span>
              <button
                id="btn-cancel"
                class="btn btn-outline hidden"
                onclick="resetProductForm()"
                style="float: left; padding: 5px 10px; font-size: 12px"
              >
                إلغاء التعديل
              </button>
            </h3>

            <div class="form-grid">
              <div>
                <label class="form-label">اسم المنتج</label>
                <input type="text" id="p-name" placeholder="اسم المنتج" />
              </div>
              <div
                style="
                  background: var(--bg);
                  padding: 15px;
                  border-radius: 10px;
                  border: 1px solid var(--border-color);
                "
              >
                <div
                  style="
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    margin-bottom: 15px;
                  "
                >
                  <label class="form-label" style="margin: 0"
                    >نظام التسعير</label
                  >
                  <div style="display: flex; gap: 10px; font-size: 14px">
                    <label
                      style="
                        cursor: pointer;
                        display: flex;
                        align-items: center;
                        gap: 5px;
                      "
                    >
                      <input
                        type="radio"
                        name="pricingMode"
                        value="single"
                        checked
                        onchange="togglePricingMode()"
                      />
                      سعر موحد
                    </label>
                    <label
                      style="
                        cursor: pointer;
                        display: flex;
                        align-items: center;
                        gap: 5px;
                      "
                    >
                      <input
                        type="radio"
                        name="pricingMode"
                        value="multi"
                        onchange="togglePricingMode()"
                      />
                      أحجام متعددة
                    </label>
                  </div>
                </div>

                <div id="mode-single" class="pricing-group">
                  <div
                    style="
                      display: grid;
                      grid-template-columns: 1fr 1fr;
                      gap: 10px;
                    "
                  >
                    <div>
                      <label class="form-label">السعر (ج.م)</label>
                      <input
                        type="number"
                        id="p-price"
                        placeholder="مثال: 150"
                      />
                    </div>
                    <div>
                      <label
                        class="form-label"
                        style="color: var(--danger); font-weight: bold"
                        >السعر الأصلي (قبل الخصم)</label
                      >
                      <input
                        type="number"
                        id="p-old-price"
                        placeholder="اكتب السعر القديم (الأغلى)"
                        style="
                          border: 1px dashed var(--danger);
                          background: #fef2f2;
                          color: var(--danger);
                        "
                      />
                      <small style="font-size: 11px; color: var(--secondary)"
                        >سيبه فاضي لو مفيش خصم</small
                      >
                    </div>
                  </div>
                </div>

                

                <div id="mode-multi" class="pricing-group hidden">
                  <div id="sizes-list"></div>
                  <button
                    class="btn btn-outline"
                    style="width: 100%; margin-top: 10px; border-style: dashed"
                    onclick="addSizeRow()"
                  >
                    <i class="fas fa-plus"></i> إضافة حجم جديد
                  </button>
                </div>
              </div>
            </div>

            <div class="form-grid" style="margin-top: 15px">
              <div>
                <label class="form-label">القسم</label>
                <select id="p-cat">
                  <option value="">-- اختر القسم --</option>
                </select>
              </div>
              <div>
                <label class="form-label">الصورة</label>
                <div style="display: flex; align-items: center">
                  <img id="p-preview" class="img-preview" />
                  <label for="p-image" class="custom-file-upload">
                    <i class="fas fa-cloud-upload-alt"></i> رفع صورة
                  </label>
                  <input
                    type="file"
                    id="p-image"
                    accept="image/*"
                    onchange="previewImage(this, 'p-preview')"
                  />
                </div>
              </div>
            </div>

            <div style="margin-top: 15px">
              <label class="form-label">الوصف</label>
              <textarea id="p-desc" rows="2" placeholder="الوصف"></textarea>
            </div>
            <div id="ingredients-section" class="hidden" style="margin-top: 15px; background: #f0f9ff; padding: 15px; border-radius: 10px; border: 1px dashed #bae6fd;">
                <label class="form-label" style="color:#0284c7"><i class="fas fa-blender"></i> مقادير ومكونات المنتج (للخصم من المخزن)</label>
                <div id="prod-ingredients-list"></div>
                <div style="display:flex; gap:10px; margin-top:10px;">
                    <select id="stock-select" style="flex:2"></select>
                    <input type="number" id="stock-qty" placeholder="الكمية" style="flex:1">
                    <button class="btn btn-primary" style="width:auto; background:#0284c7" onclick="addIngredientRow()">إضافة</button>
                </div>
                <small style="color:var(--secondary)">مثال: اختر "بن" واكتب "0.02" إذا كان الكيلو هو الوحدة والمنتج يستهلك 20 جرام.</small>
            </div>

            <div style="margin-top: 20px">
              <button
                id="btn-add-prod"
                class="btn btn-primary"
                onclick="saveProduct('POST')"
              >
                <i class="fas fa-plus-circle"></i> إضافة للمنيو
              </button>
              <button
                id="btn-update-prod"
                class="btn hidden"
                style="background: var(--warning); color: white; width: 100%"
                onclick="saveProduct('PATCH')"
              >
                <i class="fas fa-save"></i> حفظ التعديلات
              </button>
            </div>
          </div>

          <div class="table-wrapper">
            <table>
              <thead>
                <tr>
                  <th width="60">صورة</th>
                  <th>الاسم</th>
                  <th>القسم</th>
                  <th>السعر</th>
                  <th>الحالة</th>
                  <th>تحكم</th>
                </tr>
              </thead>
              <tbody id="products-list"></tbody>
            </table>
          </div>
        </div>

        <div id="view-recipes" class="hidden">
            <div style="display:flex; gap:20px; flex-wrap:wrap; height:calc(100vh - 150px);">
                
                <div class="card" style="flex:1; min-width:300px; display:flex; flex-direction:column; padding:15px; height:100%;">
                    <h3 style="margin-top:0; color:var(--primary); border-bottom:1px solid var(--border-color); padding-bottom:10px;">
                        <i class="fas fa-hamburger"></i> اختر المنتج
                    </h3>
                    <input type="text" id="recipe-search" placeholder="ابحث عن منتج..." 
                           style="margin-bottom:10px; padding:10px; border-radius:8px; border:1px solid var(--border-color); width:100%;"
                           onkeyup="filterRecipeProducts()">
                    
                    <div id="recipe-products-list" style="overflow-y:auto; flex:1; display:flex; flex-direction:column; gap:8px;">
                        </div>
                </div>

                <div class="card" style="flex:2; min-width:300px; display:flex; flex-direction:column; padding:20px; height:100%;">
                    <div id="recipe-editor-empty" style="text-align:center; margin:auto; color:var(--secondary);">
                        <i class="fas fa-arrow-right fa-3x" style="opacity:0.3; margin-bottom:20px;"></i>
                        <h3>اختر منتجاً من القائمة لبدء ربط المكونات</h3>
                    </div>

                    <div id="recipe-editor-content" class="hidden" style="height:100%; display:flex; flex-direction:column;">
                        <h3 style="margin-top:0; color:var(--primary); display:flex; justify-content:space-between; align-items:center;">
                            <span><i class="fas fa-edit"></i> مقادير: <span id="recipe-active-name" style="color:var(--text-main)">--</span></span>
                            <button class="btn btn-success" onclick="saveActiveRecipe()" style="width:auto; padding:5px 20px;">
                                <i class="fas fa-save"></i> حفظ التعديلات
                            </button>
                        </h3>

                        <div style="background:var(--bg); padding:15px; border-radius:12px; border:1px solid var(--border-color); margin-bottom:15px;">
                            <label class="form-label" style="margin-bottom:5px;">إضافة مكون من المخزن</label>
                            <div style="display:flex; gap:10px;">
                                <select id="recipe-stock-select" style="flex:2"></select>
                                <input type="number" id="recipe-stock-qty" placeholder="الكمية" style="flex:1">
                                <button class="btn btn-primary" onclick="addIngredientToActive()" style="width:auto;">
                                    <i class="fas fa-plus"></i>
                                </button>
                            </div>
                            <small id="recipe-unit-hint" style="color:var(--secondary); font-size:12px; margin-top:5px; display:block;"></small>
                        </div>

                        <div class="table-wrapper" style="flex:1; overflow-y:auto;">
                            <table style="width:100%;">
                                <thead>
                                    <tr>
                                        <th>الخامة</th>
                                        <th>الكمية المستهلكة</th>
                                        <th>الوحدة</th>
                                        <th>حذف</th>
                                    </tr>
                                </thead>
                                <tbody id="recipe-active-list"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="view-bulk" class="hidden">
          <div
            style="
              background: rgba(16, 185, 129, 0.1);
              border: 1px solid var(--success);
              padding: 15px;
              border-radius: 10px;
              color: var(--success);
              margin-bottom: 20px;
            "
          >
            <i class="fas fa-info-circle"></i> <strong>نصيحة:</strong> يمكنك
            إضافة عدد غير محدود من المنتجات هنا، ثم رفعها مرة واحدة.
          </div>

          <div id="bulk-container"></div>

          <div style="display: flex; gap: 10px; margin-top: 20px">
            <button
              class="btn btn-outline"
              style="flex: 1; border-style: dashed"
              onclick="addBulkRow()"
            >
              <i class="fas fa-plus"></i> صف جديد
            </button>
            <button
              class="btn btn-success"
              style="flex: 1"
              onclick="submitBulkAll()"
            >
              <i class="fas fa-cloud-upload-alt"></i> رفع وحفظ الكل
            </button>
          </div>
        </div>
        <div id="view-staff" class="hidden">
          <div class="card">
            <h3 style="color: var(--primary); margin-top: 0">
              <i class="fas fa-user-plus"></i> إضافة موظف جديد
            </h3>
            <div class="form-grid">
              <input type="text" id="staff-name" placeholder="اسم الموظف" />
              <input
                type="email"
                id="staff-email"
                placeholder="البريد الإلكتروني للدخول"
              />
            </div>
            <div class="form-grid" style="margin-top: 15px">
              <input
                type="text"
                id="staff-password"
                placeholder="كلمة المرور"
              />
              <select id="staff-role">
                <option value="cashier">كاشير</option>
                <option value="kitchen">شيف</option>
              </select>
            </div>

            <div
              style="
                background: var(--bg);
                padding: 15px;
                border-radius: 10px;
                margin-top: 15px;
                border: 1px solid var(--border-color);
              "
            >
              <h4 style="margin-top: 0; color: var(--secondary)">
                ⏰ مواعيد العمل والإجازات
              </h4>
              <div class="form-grid">
                <div>
                  <label class="form-label">بداية الشيفت</label>
                  <input type="time" id="staff-start" value="09:00" />
                </div>
                <div>
                  <label class="form-label">نهاية الشيفت</label>
                  <input type="time" id="staff-end" value="17:00" />
                </div>
              </div>
              <label class="form-label" style="margin-top: 10px"
                >أيام الإجازة الأسبوعية</label
              >
              <div
                style="display: flex; gap: 10px; flex-wrap: wrap"
                id="rest-days-container"
              >
                <label><input type="checkbox" value="6" /> السبت</label>
                <label><input type="checkbox" value="0" /> الأحد</label>
                <label><input type="checkbox" value="1" /> الإثنين</label>
                <label><input type="checkbox" value="2" /> الثلاثاء</label>
                <label><input type="checkbox" value="3" /> الأربعاء</label>
                <label><input type="checkbox" value="4" /> الخميس</label>
                <label><input type="checkbox" value="5" /> الجمعة</label>
              </div>
            </div>
            <button
              class="btn btn-primary"
              onclick="addStaff()"
              style="margin-top: 15px"
            >
              حفظ البيانات
            </button>
          </div>

          <div class="table-wrapper">
            <table>
              <thead>
                <tr>
                  <th>الاسم</th>
                  <th>البريد</th>
                  <th>الدور</th>
                  <th>حذف</th>
                </tr>
              </thead>
              <tbody id="staff-list"></tbody>
            </table>
          </div>
        </div>
        <div id="view-coupons" class="hidden">
          <div class="card">
            <h3 style="color: var(--primary); margin-top: 0">
              إضافة كوبون جديد
            </h3>
            <div class="form-grid">
              <input
                type="text"
                id="coup-code"
                placeholder="كود الكوبون (مثال: SAVE20)"
              />
              <select id="coup-type">
                <option value="percent">نسبة مئوية (%)</option>
                <option value="fixed">مبلغ ثابت (ج.م)</option>
              </select>
            </div>
            <div class="form-grid" style="margin-top: 10px">
              <input type="number" id="coup-value" placeholder="قيمة الخصم" />
              <input
                type="number"
                id="coup-min"
                placeholder="الحد الأدنى للطلب (اختياري)"
              />
            </div>
            <div class="form-grid" style="margin-top: 10px">
              <input
                type="number"
                id="coup-max-disc"
                placeholder="أقصى خصم (للنسبة المئوية فقط)"
              />
              <input
                type="number"
                id="coup-limit"
                placeholder="عدد مرات الاستخدام (الافتراضي 1000)"
              />
            </div>
            <button
              class="btn btn-primary"
              style="margin-top: 15px"
              onclick="createCoupon()"
            >
              إنشاء الكوبون
            </button>
          </div>
          <div class="table-wrapper">
            <table>
              <thead>
                <tr>
                  <th>الكود</th>
                  <th>الخصم</th>
                  <th>الاستخدام</th>
                  <th>حذف</th>
                </tr>
              </thead>
              <tbody id="coupons-list"></tbody>
            </table>
          </div>
        </div>
        <div id="view-stock" class="hidden">
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <div>
                        <h3 style="color: var(--primary); margin: 0;"><i class="fas fa-cubes"></i> دولاب الخامات</h3>
                        <p style="margin: 5px 0 0; color: var(--secondary); font-size: 13px;">هنا بتسجل كل الخامات اللي بتشتريها (بن، سكر، حليب، لحوم...)</p>
                    </div>
                    <button class="btn btn-primary" style="width: auto;" onclick="openStockModal()">
                        <i class="fas fa-plus"></i> تسجيل خامة جديدة
                    </button>
                </div>

                <div class="table-wrapper">
                    <table>
                        <thead>
                            <tr>
                                <th>اسم الخامة</th>
                                <th>الكمية الحالية</th>
                                <th>الوحدة</th>
                                <th>التكلفة</th>
                                <th>إجراءات</th>
                            </tr>
                        </thead>
                        <tbody id="stock-items-list"></tbody>
                    </table>
                </div>
            </div>

            <div class="card" style="margin-top: 25px;">
                <h3 style="color: var(--primary); margin-top: 0; margin-bottom: 15px;">
                    <i class="fas fa-history"></i> سجل حركة المخزن (وارد / صادر)
                </h3>
                
                <div style="display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap; align-items: center; background: var(--bg); padding: 10px; border-radius: 10px;">
                    <label style="font-weight: bold; font-size: 13px;">تاريخ:</label>
                    <input type="date" id="stock-report-start" style="width: auto; height: 35px;">
                    <span style="font-weight: bold;">إلى</span>
                    <input type="date" id="stock-report-end" style="width: auto; height: 35px;">
                    <button class="btn btn-outline" style="width: auto; height: 35px; padding: 0 15px;" onclick="loadStockLogs()">
                        <i class="fas fa-filter"></i> عرض التقرير
                    </button>
                    <button class="btn btn-success" style="width: auto; height: 35px; padding: 0 15px;" onclick="exportToExcel('stock-table', 'سجل_المخزن')">
    <i class="fas fa-file-excel"></i> Excel
</button>
                </div>

                <div class="table-wrapper">
    <table id="stock-table">
        <thead>
            <tr>
                <th>التاريخ</th>
                                <th>الصنف</th>
                                <th>نوع الحركة</th>
                                <th>الكمية</th>
                                <th>السبب</th>
                            </tr>
                        </thead>
                        <tbody id="stock-logs-list"></tbody>
                    </table>
                </div>
            </div>
        </div>
        <div id="view-settings" class="hidden">
          <div class="card" style="max-width: 800px; margin: 0 auto">
            <h3
              style="
                color: var(--primary);
                margin-top: 0;
                border-bottom: 1px solid var(--border-color);
                padding-bottom: 15px;
                margin-bottom: 20px;
              "
            >
              <i class="fas fa-cogs"></i> إعدادات استلام الطلبات
            </h3>

            <div class="form-group">
              <label class="form-label">نظام التشغيل (Order Mode)</label>
              <select
                id="set-orderMode"
                style="height: 50px; font-size: 15px; font-weight: bold"
              >
                <option value="whatsapp">📱 واتساب (إرسال الطلب لرقمك)</option>
                <option value="system">
                  🚀 النظام الذكي (Live Orders System)
                </option>
                <option value="view_only">👀 للعرض فقط (بدون طلب)</option>
              </select>
              <small
                style="color: var(--secondary); display: block; margin-top: 5px"
              >
                <i class="fas fa-info-circle"></i>
                <b>واتساب:</b> الزبون يختار الطلب ويتحول للشات معاك. <br />
                <b>النظام الذكي:</b> الطلبات تنزل في صفحة "الطلبات الحية" وتسمع
                صوت تنبيه. <br />
                <b>للعرض فقط:</b> إخفاء أزرار الإضافة والسلة (كتالوج).
              </small>
            </div>

            <div class="form-grid" style="margin-top: 20px">
              <div>
                <label class="form-label">نسبة الضريبة (%)</label>
                <input
                  type="number"
                  id="set-taxRate"
                  placeholder="0"
                  min="0"
                  step="0.1"
                />
              </div>
              <div>
                <label class="form-label">نسبة الخدمة (%)</label>
                <input
                  type="number"
                  id="set-serviceRate"
                  placeholder="0"
                  min="0"
                  step="0.1"
                />
              </div>
            </div>
            <div class="form-group" style="margin-top: 20px">
              <label class="form-label">خيارات إضافية</label>
              <div
                style="
                  display: flex;
                  gap: 10px;
                  align-items: center;
                  background: var(--bg);
                  padding: 15px;
                  border-radius: 10px;
                  border: 1px solid var(--border-color);
                "
              >
                <input
                  type="checkbox"
                  id="set-useTableNumbers"
                  style="width: 20px; height: 20px"
                />
                <label
                  for="set-useTableNumbers"
                  style="cursor: pointer; font-weight: bold"
                  >تفعيل نظام الطاولات (Table Numbers)</label
                >
              </div>
              <div
                style="
                  display: flex;
                  gap: 10px;
                  align-items: center;
                  background: var(--bg);
                  padding: 15px;
                  border-radius: 10px;
                  border: 1px solid var(--border-color);
                  margin-top: 10px;
                "
              >
                <input
                  type="checkbox"
                  id="set-enableCoupons"
                  style="width: 20px; height: 20px"
                />
                <label
                  for="set-enableCoupons"
                  style="cursor: pointer; font-weight: bold"
                  >تفعيل الكوبونات (Coupons)</label
                >
              </div>
              
              <div
                style="
                  display: flex;
                  gap: 10px;
                  align-items: center;
                  background: var(--bg);
                  padding: 15px;
                  border-radius: 10px;
                  border: 1px solid var(--border-color);
                  margin-top: 10px;
                "
              >
                <input
                  type="checkbox"
                  id="set-printOrderNum"
                  style="width: 20px; height: 20px"
                />
                <label
                  for="set-printOrderNum"
                  style="cursor: pointer; font-weight: bold"
                  >طباعة رقم الطلب في الفاتورة (Order #)</label
                >
              </div>
              </div>

            <div class="form-group" style="margin-top: 20px">
              <label class="form-label">رقم الواتساب لاستقبال الطلبات</label>
              <input
                type="text"
                id="set-whatsapp"
                placeholder="مثال: 01000000000"
                style="font-size: 16px; font-weight: bold; letter-spacing: 1px"
              />
            </div>

            <button
              class="btn btn-success"
              onclick="saveSettings()"
              style="margin-top: 20px; font-size: 16px"
            >
              <i class="fas fa-save"></i> حفظ الإعدادات
            </button>
          </div>
        </div>

        <div id="view-design" class="hidden">
          <div style="display: flex; gap: 30px; flex-wrap: wrap; height: calc(100vh - 100px);">
            
            <div class="card" style="flex: 1; min-width: 380px; overflow-y: auto; height: 100%; padding-right:15px;">
              <h3 style="color: var(--primary); margin-top: 0; display:flex; align-items:center; gap:10px;">
                <i class="fas fa-paint-brush"></i> ستوديو التصميم
              </h3>

              <div class="form-group" style="background: var(--bg); padding: 15px; border-radius: 16px; border: 1px solid var(--border-color); margin-bottom: 25px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                  <label class="form-label" style="color: var(--primary); margin: 0; font-size:16px;">
                    <i class="fas fa-magic"></i> قوالب جاهزة
                  </label>
                  <span class="badge" style="background:var(--primary-light); color:var(--primary)">اختر وطبق فوراً</span>
                </div>
                <div class="theme-grid" id="theme-library" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 12px;"></div>
              </div>

              <div class="form-group">
                <label class="form-label" style="font-size:15px;">طريقة عرض المنتجات (Layout)</label>
                <div class="layout-options-grid">
                  <button class="btn-layout active" onclick="setUiParam('layoutType', 'modern')" id="btn-layout-modern">
                    <i class="fas fa-bolt"></i>
                    <span>مودرن</span>
                  </button>
                  <button class="btn-layout" onclick="setUiParam('layoutType', 'grid')" id="btn-layout-grid">
                    <i class="fas fa-th-large"></i>
                    <span>شبكة</span>
                  </button>
                  <button class="btn-layout" onclick="setUiParam('layoutType', 'list')" id="btn-layout-list">
                    <i class="fas fa-list-ul"></i>
                    <span>قائمة</span>
                  </button>
                  <button class="btn-layout" onclick="setUiParam('layoutType', 'focus')" id="btn-layout-focus">
                    <i class="fas fa-camera-retro"></i>
                    <span>صور (Focus)</span>
                  </button>
                  <button class="btn-layout" onclick="setUiParam('layoutType', 'minimal')" id="btn-layout-minimal">
                    <i class="fas fa-align-right"></i>
                    <span>نصي (سريع)</span>
                  </button>
                  <button class="btn-layout" onclick="setUiParam('layoutType', 'magazine')" id="btn-layout-magazine">
                    <i class="fas fa-newspaper"></i>
                    <span>مجلة</span>
                  </button>
                </div>
              </div>

              <hr style="border:0; border-top:1px dashed var(--border-color); margin: 25px 0;">

              <div class="form-grid">
                 <div>
                    <label class="form-label">اللون الأساسي</label>
                    <div style="display:flex; align-items:center; gap:10px; border:1px solid var(--border-color); padding:5px; border-radius:12px;">
                        <input type="color" id="ui-primaryColor" oninput="setUiParam('primaryColor', this.value)" style="height: 40px; width:40px; border:none; padding:0; background:none; cursor: pointer;">
                        <span style="font-size:13px; color:var(--secondary);">اضغط للتغيير</span>
                    </div>
                 </div>
                 <div>
                    <label class="form-label">نوع الخط</label>
                    <select id="ui-fontFamily" onchange="setUiParam('fontFamily', this.value)" style="height:52px;">
                      <option value="Tajawal">Tajawal (افتراضي)</option>
                      <option value="Cairo">Cairo (رسمي)</option>
                      <option value="Almarai">Almarai (عصري)</option>
                      <option value="Amiri">Amiri (كلاسيك)</option>
                      <option value="Zain">Zain (شبابي)</option>
                    </select>
                 </div>
              </div>

              <div class="form-group" style="margin-top:20px;">
                <label class="form-label">خلفية الصفحة</label>
                <div style="background:var(--bg); padding:15px; border-radius:12px; border:1px solid var(--border-color);">
                    <select id="ui-bgType" onchange="toggleBgInput()" style="margin-bottom: 10px">
                      <option value="color">لون ثابت</option>
                      <option value="pattern">نمط (Pattern)</option>
                      <option value="image">صورة خاصة</option>
                    </select>
                    
                    <input type="color" id="ui-bgColor" oninput="setUiParam('bgValue', this.value)" style="height: 45px; width:100%;">
                    
                    <div id="ui-bgImage-container" class="hidden" style="margin-top: 10px;">
                      <div style="display: flex; align-items: center; gap: 10px;">
                        <img id="bg-preview" class="img-preview" style="width: 50px; height: 50px;">
                        <label for="ui-bgFile" class="custom-file-upload" style="margin: 0; background:white;">
                          <i class="fas fa-cloud-upload-alt"></i> رفع خلفية
                        </label>
                        <input type="file" id="ui-bgFile" accept="image/*" onchange="handleBgUpload(this)">
                      </div>
                    </div>
                </div>
              </div>

              <div class="form-group" style="margin-top:20px;">
                <label class="form-label">صورة الغلاف (Header)</label>
                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px;">
                  <img id="hero-preview" class="img-preview" style="width: 60px; height: 60px; border-radius:10px;">
                  <label for="ui-heroFile" class="custom-file-upload" style="margin: 0; flex:1;">
                    <i class="fas fa-image"></i> تغيير الغلاف
                  </label>
                  <input type="file" id="ui-heroFile" accept="image/*" onchange="handleHeroUpload(this)">
                </div>

                <div style="background: var(--bg); padding: 15px; border-radius: 12px; border: 1px solid var(--border-color);">
                  <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px;">
                    <i class="fas fa-adjust" style="color: var(--secondary)"></i>
                    <input type="range" min="0" max="90" value="30" id="ui-heroOverlay" oninput="setUiParam('heroOverlay', this.value)" style="flex: 1;">
                    <span style="font-size: 12px; font-weight:bold; width: 60px; text-align:left;">تعتيم</span>
                  </div>
                  <div style="display: flex; align-items: center; gap: 10px;">
                    <i class="fas fa-arrows-alt-v" style="color: var(--secondary)"></i>
                    <input type="range" min="150" max="500" value="200" id="ui-heroHeight" oninput="setUiParam('heroHeight', this.value)" style="flex: 1;">
                    <span style="font-size: 12px; font-weight:bold; width: 60px; text-align:left;">ارتفاع</span>
                  </div>
                </div>
              </div>
              
              <div class="form-group" style="margin-top:20px;">
                 <label class="form-label">إعدادات الكروت</label>
                 <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px;">
                    <div>
                        <select id="ui-cardStyle" onchange="setUiParam('cardStyle', this.value)">
                          <option value="solid">Solid (مصمت)</option>
                          <option value="glass">Glass (زجاجي)</option>
                          <option value="outlined">Outlined (إطار)</option>
                        </select>
                    </div>
                    <div>
                        <div style="display:flex; align-items:center; height:100%; gap:5px; font-size:13px; font-weight:bold; color:var(--secondary);">
                             <span>انحناء:</span>
                             <input type="range" min="0" max="30" id="ui-cardRadius" oninput="setUiParam('cardRadius', this.value)" style="flex:1;">
                             <span id="radius-val">16</span>px
                        </div>
                    </div>
                 </div>
              </div>

              <div style="display: flex; gap: 15px; margin-top: 30px; position:sticky; bottom:0; background:var(--surface); padding-top:10px; border-top:1px solid var(--border-color);">
                <button class="btn btn-outline" onclick="resetDesign()" style="flex: 1; border-color: var(--danger); color: var(--danger);">
                  <i class="fas fa-undo"></i> استعادة
                </button>
                <button class="btn btn-success" onclick="saveDesignSettings()" style="flex: 2; font-size: 16px; box-shadow: 0 4px 15px rgba(16, 185, 129, 0.2);">
                  <i class="fas fa-save"></i> حفظ التصميم
                </button>
              </div>
            </div>

            <div class="phone-mockup-wrapper">
              <div class="phone-frame">
                <iframe id="live-preview" src="" scrolling="yes"></iframe>
              </div>
            </div>
            
          </div>
        </div>
    <input type="hidden" id="restaurant-id" />
<input type="hidden" id="setting-print-num" value="true" />

    <script>
      const urlParams = new URLSearchParams(window.location.search);
      const urlToken = urlParams.get("t");

      if (urlToken) {
        sessionStorage.setItem("ownerToken", urlToken);

        window.history.replaceState(
          {},
          document.title,
          window.location.pathname,
        );
      }

      let token = sessionStorage.getItem("ownerToken");

      let categoriesData = [];
      let stockItemsData = [];
      let currentIngredients = [];
      let editingProductId = null;
      let currentUserRole = null;
      let serverTimeOffset = 0;

      if (localStorage.getItem("theme") === "dark") {
        document.body.classList.add("dark-mode");
      }

      async function initDashboard() {
        try {
          const res = await fetch("/api/v1/restaurants/my-restaurant", {
            headers: { Authorization: `Bearer ${token}` },
          });

          const serverDateHeader = res.headers.get("date");
          if (serverDateHeader) {
            const serverTime = new Date(serverDateHeader).getTime();
            const localTime = Date.now();
            serverTimeOffset = serverTime - localTime;
            console.log("Server Time Offset:", serverTimeOffset);
          }

          const result = await res.json();

          if (result.status === "success") {
            document.getElementById("restaurant-id").value =
              result.data.restaurant._id;
            document.getElementById("preview-link").href =
              `/menu/${result.data.restaurant.slug}`;

            document.getElementById("set-orderMode").value =
              result.data.restaurant.orderMode || "whatsapp";
            document.getElementById("set-taxRate").value =
              result.data.restaurant.taxRate || 0;
            document.getElementById("set-serviceRate").value =
              result.data.restaurant.serviceRate || 0;
            document.getElementById("set-useTableNumbers").checked =
              result.data.restaurant.useTableNumbers === true;
            document.getElementById("set-enableCoupons").checked =
              result.data.restaurant.enableCoupons === true;
            
            const localPrintSetting = localStorage.getItem("localPrintOrderNum");
            let shouldPrintNum;

            if (localPrintSetting !== null) {
                shouldPrintNum = (localPrintSetting === "true");
            } else {
                shouldPrintNum = result.data.restaurant.printOrderNumber !== false;
            }

            document.getElementById("set-printOrderNum").checked = shouldPrintNum;
            document.getElementById("setting-print-num").value = shouldPrintNum;

            if (result.data.restaurant.contactInfo) {
              document.getElementById("set-whatsapp").value =
                result.data.restaurant.contactInfo.whatsapp || "";
            }

            applyPermissions(result.data.userRole);
            currentUserRole = result.data.userRole;

            const roleNames = {
              owner: "المالك",
              cashier: "الكاشير",
              kitchen: "المطبخ",
            };
            const roleAr = roleNames[currentUserRole] || currentUserRole;
            const userName =
              sessionStorage.getItem("currentUserName") || "مستخدم";

            document.getElementById("page-title").innerHTML = `
                        <div>${result.data.restaurant.restaurantName}</div>
                        <div style="font-size:14px; color:var(--secondary); font-weight:normal; margin-top:5px;">
                            <i class="fas fa-user-circle"></i> ${userName} <span class="badge" style="background:var(--primary); color:white; font-size:12px;">${roleAr}</span>
                        </div>
                    `;

            document
              .getElementById("dashboard-section")
              .classList.remove("hidden");
            if (
              result.data.userRole === "cashier" ||
              result.data.userRole === "kitchen"
            ) {
              checkShiftStatus(result.data.userRole);
            }
            if (result.data.userRole === "owner") {
              loadCategories();
              loadProducts();
              initDesignStudio(result.data.restaurant);
              
              if(result.data.restaurant.owner.hasStock || result.data.restaurant.hasStock) {
                  document.getElementById('nav-stock').classList.remove('hidden');
                  document.getElementById('nav-recipes').classList.remove('hidden');
                  document.getElementById('ingredients-section').classList.remove('hidden');
                  loadStockItems();
              }
            }

            const lastView = localStorage.getItem("lastActiveView");
            if (result.data.userRole === "kitchen") switchView("orders");
            else if (result.data.userRole === "cashier") {
              if (lastView === "history") switchView("history");
              else switchView("orders");
            } else {
              if (lastView && lastView !== "orders") switchView(lastView);
              else switchView("categories");
            }
          } else {
            if (res.status === 401) {
              sessionStorage.removeItem("ownerToken");
              window.location.href = "/login";
            } else {
              Swal.fire({
                icon: "warning",
                title: "تنبيه",
                text: result.message || "خطأ في البيانات",
              }).then(() => {
                window.location.href = "/login";
              });
            }
          }
        } catch (e) {
          console.error(e);
          Swal.fire("خطأ", "فشل الاتصال بالسيرفر", "error");
        }
      }
      function toggleDarkMode() {
        document.body.classList.toggle("dark-mode");
        localStorage.setItem(
          "theme",
          document.body.classList.contains("dark-mode") ? "dark" : "light",
        );
      }

      function toggleSidebar() {
        const sidebar = document.getElementById("sidebar");
        const overlay = document.querySelector(".overlay");
        
        if (sidebar.classList.contains("active")) {
            sidebar.classList.remove("active");
            overlay.classList.remove("visible");
            setTimeout(() => { overlay.style.display = "none"; }, 300);
        } else {
            overlay.style.display = "block";
            setTimeout(() => { 
                sidebar.classList.add("active");
                overlay.classList.add("visible");
            }, 10);
        }
      }
      function previewImage(input, previewId) {
        const preview = document.getElementById(previewId);
        if (input.files && input.files[0]) {
          const reader = new FileReader();
          reader.onload = function (e) {
            preview.src = e.target.result;
            preview.style.display = "block";
          };
          reader.readAsDataURL(input.files[0]);
        } else {
          preview.src = "";
          preview.style.display = "none";
        }
      }

function switchView(viewName) {
        window.scrollTo({ top: 0, behavior: 'smooth' });

const allViews = ["categories", "products", "recipes", "bulk", "design", "orders", "history", "stock", "settings", "staff", "coupons"];
        
        allViews.forEach((v) => {
            const el = document.getElementById(`view-${v}`);
            if (el) {
                el.classList.add("hidden");
                el.classList.remove("view-animate");
            }

            const nav = document.getElementById(`nav-${v}`);
            if (nav) nav.classList.remove("active");
            
            const mobNav = document.getElementById(`mob-nav-${v}`);
            if (mobNav) mobNav.classList.remove("active");
        });

        const targetEl = document.getElementById(`view-${viewName}`);
        if (targetEl) {
            targetEl.classList.remove("hidden");
            void targetEl.offsetWidth; 
            targetEl.classList.add("view-animate");
        }

        const targetNav = document.getElementById(`nav-${viewName}`);
        if (targetNav) targetNav.classList.add("active");

        const targetMobNav = document.getElementById(`mob-nav-${viewName}`);
        if (targetMobNav) targetMobNav.classList.add("active");

        if (window.innerWidth <= 768) {
            const sidebar = document.getElementById("sidebar");
            const overlay = document.querySelector(".overlay");
            if (sidebar && sidebar.classList.contains("active")) {
                sidebar.classList.remove("active");
            }
            if (overlay) {
                overlay.classList.remove("visible");
                setTimeout(() => { overlay.style.display = 'none'; }, 300);
            }
        }

        if (viewName === "orders") {
            const badge = document.getElementById("live-badge");
            if (badge) { badge.innerText = "0"; badge.classList.add("hidden"); }
            
            const mobBadge = document.getElementById("mob-badge");
            if (mobBadge) mobBadge.classList.add("hidden");

            if (typeof window.loadOrders === 'function') window.loadOrders();
        }

        if (viewName === "bulk") {
            const bulkContainer = document.getElementById("bulk-container");
            if (bulkContainer && bulkContainer.innerHTML.trim() === "") {
                if (typeof addBulkRow === 'function') addBulkRow();
            }
        }

        if (viewName === "history") {
            if (typeof window.loadHistory === 'function') window.loadHistory();
        }

        if (viewName === "coupons") {
            if (typeof loadCoupons === 'function') loadCoupons();
        }
        if (viewName === "recipes") {
            if (typeof initRecipesView === 'function') initRecipesView();
        }
      }
      function isNumberKey(evt) {
        var charCode = evt.which ? evt.which : evt.keyCode;
        if (charCode != 46 && charCode > 31 && (charCode < 48 || charCode > 57))
          return false;
        return true;
      }

      function logout() {
        sessionStorage.removeItem("ownerToken");
        localStorage.removeItem("ownerToken");
        location.reload();
      }

      async function saveSettings() {
        const rId = document.getElementById("restaurant-id").value;
        const orderMode = document.getElementById("set-orderMode").value;
        const useTables = document.getElementById(
          "set-useTableNumbers",
        ).checked;
        const enableCoupons =
          document.getElementById("set-enableCoupons").checked;
        const printOrderNum = document.getElementById("set-printOrderNum").checked;
        document.getElementById("setting-print-num").value = printOrderNum;
        localStorage.setItem("localPrintOrderNum", printOrderNum);

        const whatsapp = document.getElementById("set-whatsapp").value;
        const taxRate = document.getElementById("set-taxRate").value;
        const serviceRate = document.getElementById("set-serviceRate").value;

        const bodyData = {
          orderMode: orderMode,
          taxRate: taxRate,
          serviceRate: serviceRate,
          useTableNumbers: useTables,
          enableCoupons: enableCoupons,
          printOrderNumber: printOrderNum,
          contactInfo: {
            whatsapp: whatsapp,
          },
        };

        Swal.showLoading();
        try {
          const res = await fetch(`/api/v1/restaurants/${rId}`, {
            method: "PATCH",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${token}`,
            },
            body: JSON.stringify(bodyData),
          });

          if (res.ok) {
            Swal.fire({
              icon: "success",
              title: "تم حفظ الإعدادات",
              showConfirmButton: false,
              timer: 1500,
            });
          } else {
            throw new Error("فشل الحفظ");
          }
        } catch (e) {
          console.error(e);
          Swal.fire("خطأ", "حدث خطأ أثناء الحفظ", "error");
        }
      }

      async function loadCategories() {
        const rId = document.getElementById("restaurant-id").value;
        const list = document.getElementById("categories-list");

        const statCats = document.getElementById("stat-total-cats");
        const statProds = document.getElementById("stat-total-prods");

        try {
          const res = await fetch(`/api/v1/categories/${rId}`, {
            headers: { Authorization: `Bearer ${token}` },
          });

          if (res.status === 401) return;

          const result = await res.json();

          if (result.status === "success") {
            categoriesData = result.data.categories;
            updateCategoryDropdowns();
            list.innerHTML = "";

            if (result.data.stats) {
              if (statCats) statCats.innerText = result.data.stats.totalCats;
              if (statProds) statProds.innerText = result.data.stats.totalProds;
            }

            if (categoriesData.length === 0) {
              list.innerHTML =
                '<tr><td colspan="4" style="text-align:center; padding:20px; color:#94a3b8">لا توجد أقسام مضافة</td></tr>';
              return;
            }

            categoriesData.forEach((cat) => {
              const img = cat.image
                ? `<img src="${cat.image}" style="width:40px; height:40px; border-radius:8px; object-fit:cover">`
                : '<i class="fas fa-folder" style="font-size:24px; color:#cbd5e1"></i>';

              const countBadgeColor =
                cat.productCount > 0
                  ? "background:var(--primary-light); color:var(--primary)"
                  : "background:#f1f5f9; color:#64748b";

              list.innerHTML += `
    <tr>
        <td>${img}</td>
        <td style="font-weight:bold">${cat.name}</td>
        <td>
            <span class="badge" style="${countBadgeColor}; font-size:13px">
                ${cat.productCount || 0} منتج
            </span>
        </td>
        <td>
             <button class="btn btn-outline" style="padding:5px 10px; color:var(--primary); border-color:var(--primary)" 
                onclick="editCategory('${cat._id}', '${cat.name}', '${cat.image || ""}')">
                <i class="fas fa-pen"></i>
            </button>
            <button class="btn btn-outline" style="padding:5px 10px; color:var(--danger); border-color:var(--danger)" onclick="deleteCategory('${cat._id}')"><i class="fas fa-trash"></i></button>
        </td>
    </tr>
`;
            });
          }
        } catch (e) {
          console.error("Error loading categories:", e);
          list.innerHTML =
            '<tr><td colspan="4" style="text-align:center; color:red">خطأ في تحميل الأقسام</td></tr>';
        }
      }
      function updateCategoryDropdowns() {
        const select = document.getElementById("p-cat");
        const currentVal = select.value;
        select.innerHTML = '<option value="">-- اختر القسم --</option>';
        categoriesData.forEach((cat) => {
          const option = document.createElement("option");
          option.value = cat.name;
          option.innerText = cat.name;
          select.appendChild(option);
        });
        if (currentVal) select.value = currentVal;
      }

      async function addCategory() {
        const name = document.getElementById("c-name").value;
        const imageFile = document.getElementById("c-image").files[0];
        const rId = document.getElementById("restaurant-id").value;

        if (!name) return Swal.fire("تنبيه", "اكتب اسم القسم", "warning");

        const formData = new FormData();
        formData.append("name", name);
        formData.append("restaurantId", rId);
        if (imageFile) formData.append("image", imageFile);

        Swal.showLoading();

        try {
          const res = await fetch("/api/v1/categories", {
            method: "POST",
            headers: { Authorization: `Bearer ${token}` },
            body: formData,
          });

          if (res.status === 401) {
            sessionStorage.removeItem("ownerToken");
            window.location.href = "/login";
            return;
          }

          const data = await res.json();
          Swal.close();

          if (data.status === "success") {
            document.getElementById("c-name").value = "";
            document.getElementById("c-image").value = "";
            document.getElementById("c-preview").style.display = "none";
            loadCategories();
            Swal.fire({ toast: true, icon: "success", title: "تمت الإضافة" });
          } else {
            Swal.fire("خطأ", data.message || "فشل إضافة القسم", "error");
          }
        } catch (e) {
          console.error(e);
          Swal.fire("خطأ", "حدث خطأ في الاتصال بالسيرفر", "error");
        }
      }
      async function deleteCategory(id) {
        if (
          (
            await Swal.fire({
              title: "حذف القسم؟",
              text: "سيتم حذف القسم وجميع المنتجات بداخله!",
              icon: "warning",
              showCancelButton: true,
              confirmButtonColor: "#ef4444",
              confirmButtonText: "نعم، احذف",
              cancelButtonText: "إلغاء",
            })
          ).isConfirmed
        ) {
          try {
            const res = await fetch(`/api/v1/categories/${id}`, {
              method: "DELETE",
              headers: { Authorization: `Bearer ${token}` },
            });

            if (res.status === 401) {
              window.location.href = "/login";
              return;
            }

            if (res.ok) {
              Swal.fire({ toast: true, icon: "success", title: "تم الحذف" });
              loadCategories();
            } else {
              Swal.fire("خطأ", "فشل الحذف", "error");
            }
          } catch (e) {
            Swal.fire("خطأ", "مشكلة في الاتصال", "error");
          }
        }
      }

      async function saveCategory() {
        const id = document.getElementById("edit-cat-id").value;
        const name = document.getElementById("c-name").value;
        const imageFile = document.getElementById("c-image").files[0];
        const rId = document.getElementById("restaurant-id").value;

        if (!name) return Swal.fire("تنبيه", "اكتب اسم القسم", "warning");

        const formData = new FormData();
        formData.append("name", name);
        if (imageFile) formData.append("image", imageFile);

        let url = "/api/v1/categories";
        let method = "POST";

        if (id) {
          url = `/api/v1/categories/${id}`;
          method = "PATCH";
        } else {
          formData.append("restaurantId", rId);
        }

        Swal.showLoading();
        try {
          const res = await fetch(url, {
            method: method,
            headers: { Authorization: `Bearer ${token}` },
            body: formData,
          });
          const data = await res.json();
          Swal.close();

          if (data.status === "success") {
            resetCategoryForm();
            loadCategories();
            Swal.fire({
              toast: true,
              icon: "success",
              title: id ? "تم التعديل" : "تمت الإضافة",
            });
          } else {
            Swal.fire("خطأ", data.message, "error");
          }
        } catch (e) {
          console.error(e);
          Swal.fire("خطأ", "حدث خطأ في الاتصال", "error");
        }
      }

      function editCategory(id, name, image) {
        document.getElementById("edit-cat-id").value = id;
        document.getElementById("c-name").value = name;
        document.getElementById("cat-form-title").innerText =
          "تعديل القسم: " + name;
        document.getElementById("btn-save-cat").innerHTML =
          '<i class="fas fa-save"></i> تحديث';
        document.getElementById("btn-save-cat").classList.remove("btn-primary");
        document.getElementById("btn-save-cat").style.backgroundColor =
          "var(--warning)";
        document.getElementById("btn-save-cat").style.color = "white";
        document.getElementById("btn-cancel-cat").classList.remove("hidden");

        if (image) {
          document.getElementById("c-preview").src = image;
          document.getElementById("c-preview").style.display = "block";
        } else {
          document.getElementById("c-preview").style.display = "none";
        }
        window.scrollTo({ top: 0, behavior: "smooth" });
      }

      function resetCategoryForm() {
        document.getElementById("edit-cat-id").value = "";
        document.getElementById("c-name").value = "";
        document.getElementById("c-image").value = "";
        document.getElementById("c-preview").style.display = "none";
        document.getElementById("cat-form-title").innerText = "إضافة قسم جديد";
        document.getElementById("btn-save-cat").innerHTML =
          '<i class="fas fa-plus"></i> حفظ';
        document.getElementById("btn-save-cat").classList.add("btn-primary");
        document.getElementById("btn-save-cat").style.backgroundColor = "";
        document.getElementById("btn-save-cat").style.color = "";
        document.getElementById("btn-cancel-cat").classList.add("hidden");
      }

      function searchTable() {
        let input = document.getElementById("searchInput").value.toLowerCase();
        let rows = document.querySelectorAll("#products-list tr");
        rows.forEach((row) => {
          let text = row.innerText.toLowerCase();
          row.style.display = text.includes(input) ? "" : "none";
        });
      }

      async function loadProducts() {
        const rId = document.getElementById("restaurant-id").value;
        const tbody = document.getElementById("products-list");

        try {
          const res = await fetch(`/api/v1/products/restaurant/${rId}`, {
            headers: { Authorization: `Bearer ${token}` },
          });

          if (res.status === 401) {
            sessionStorage.removeItem("ownerToken");
            window.location.href = "/login";
            return;
          }

          const result = await res.json();

          if (result.status === "success") {
            window.allProductsGlobal = result.data.products;
            
            tbody.innerHTML = "";

            if (result.data.products.length === 0) {
              tbody.innerHTML =
                '<tr><td colspan="6" style="text-align:center; padding:20px; color:#94a3b8">لا توجد منتجات حتى الآن</td></tr>';
              return;
            }

            result.data.products.forEach((p) => {
              const img = p.image
                ? `<img src="${p.image}" style="width:40px; height:40px; border-radius:8px; object-fit:cover">`
                : '<span style="color:#ccc">—</span>';

              const pData = encodeURIComponent(JSON.stringify(p));

              const toggleIcon = p.isAvailable
                ? '<i class="fas fa-eye"></i>'
                : '<i class="fas fa-eye-slash"></i>';

              const toggleClass = "btn-outline";

              const toggleStyle = p.isAvailable
                ? "color:var(--success); border-color:var(--success)"
                : "color:#94a3b8";

              tbody.innerHTML += `
                    <tr>
                        <td>${img}</td>
                        <td style="font-weight:bold; color:var(--text-main)">${p.name.ar}</td>
                        <td><span class="badge badge-cat">${p.category}</span></td>
                        <td style="color:var(--primary); font-weight:bold">${p.price}</td>
                        <td>
                            <button onclick="toggleProd('${p._id}')" class="btn ${toggleClass}" style="padding:5px 10px; ${toggleStyle}" title="تغيير الحالة">${toggleIcon}</button>
                        </td>
                        <td>
                            <button onclick="editProd('${pData}')" class="btn btn-outline" style="padding:5px 10px; color:var(--primary); border-color:var(--primary)"><i class="fas fa-pen"></i></button>
                            <button onclick="deleteProd('${p._id}')" class="btn btn-outline" style="padding:5px 10px; color:var(--danger); border-color:var(--danger)"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>
                `;
            });
          } else {
            console.error("Failed to load products:", result.message);
            tbody.innerHTML = `<tr><td colspan="6" style="text-align:center; color:red">فشل تحميل المنتجات: ${result.message}</td></tr>`;
          }
        } catch (e) {
          console.error("Error loading products:", e);
          tbody.innerHTML = `<tr><td colspan="6" style="text-align:center; color:red">حدث خطأ في الاتصال بالسيرفر</td></tr>`;
        }
      }

      async function saveProduct(method) {
        const url =
          method === "POST"
            ? "/api/v1/products"
            : `/api/v1/products/${editingProductId}`;
        const name = document.getElementById("p-name").value;
        const cat = document.getElementById("p-cat").value;
        const desc = document.getElementById("p-desc").value;
        const imageFile = document.getElementById("p-image").files[0];
        const pricingMode = document.querySelector(
          'input[name="pricingMode"]:checked',
        ).value;

        if (!name || !cat)
          return Swal.fire("ناقص بيانات", "الاسم والقسم مطلوبين", "warning");

        const formData = new FormData();
        formData.append(
          "restaurantId",
          document.getElementById("restaurant-id").value,
        );
        formData.append("category", cat);
        formData.append("name", JSON.stringify({ ar: name, en: name }));
        formData.append("description", JSON.stringify({ ar: desc, en: "" }));
        if(currentIngredients.length > 0) {
            formData.append("ingredients", JSON.stringify(currentIngredients));
        }
        if (imageFile) formData.append("image", imageFile);

        if (pricingMode === "single") {
          const price = parseFloat(document.getElementById("p-price").value);
          if (!price) return Swal.fire("تنبيه", "يجب تحديد السعر", "warning");

          let oldPriceInput =
            parseFloat(document.getElementById("p-old-price").value) || 0;

          if (oldPriceInput <= price) {
            oldPriceInput = 0;
          }

          formData.append("price", price);
          formData.append("oldPrice", oldPriceInput);
          formData.append("sizes", JSON.stringify([]));
        } else {
          const rows = document.querySelectorAll(".size-row");
          let sizesArr = [];
          rows.forEach((row) => {
            const sName = row.querySelector(".s-name").value;
            const sPrice = Number(row.querySelector(".s-price").value);
            let sOld = Number(row.querySelector(".s-old").value) || 0;

            if (sOld <= sPrice) sOld = 0;

            if (sName && sPrice) {
              sizesArr.push({ name: sName, price: sPrice, oldPrice: sOld });
            }
          });

          if (sizesArr.length === 0)
            return Swal.fire(
              "تنبيه",
              "يجب إضافة حجم واحد على الأقل",
              "warning",
            );

          formData.append("price", sizesArr[0].price);
          formData.append("sizes", JSON.stringify(sizesArr));
        }

        const headers = { Authorization: `Bearer ${token}` };

        Swal.showLoading();
        try {
          const res = await fetch(url, {
            method: method,
            headers: headers,
            body: formData,
          });
          const data = await res.json();

          if (data.status === "success") {
            Swal.close();
            loadProducts();
            resetProductForm();
            Swal.fire({
              toast: true,
              icon: "success",
              title: "تم الحفظ بنجاح",
            });
          } else {
            throw new Error(data.message);
          }
        } catch (e) {
          Swal.fire("خطأ", e.message || "فشل الحفظ", "error");
        }
      }

      function editProd(dataEncoded) {
        const p = JSON.parse(decodeURIComponent(dataEncoded));
        editingProductId = p._id;

        document.getElementById("p-name").value = p.name.ar;
        document.getElementById("p-cat").value = p.category;
        document.getElementById("p-desc").value = p.description
          ? p.description.ar
          : "";

        if (p.image) {
          document.getElementById("p-preview").src = p.image;
          document.getElementById("p-preview").style.display = "block";
        } else {
          document.getElementById("p-preview").style.display = "none";
        }

        const sizesList = document.getElementById("sizes-list");
        sizesList.innerHTML = "";

        if (p.sizes && p.sizes.length > 0) {
          document.querySelector(
            'input[name="pricingMode"][value="multi"]',
          ).checked = true;
          p.sizes.forEach((s) => addSizeRow(s.name, s.price, s.oldPrice));
        } else {
          document.querySelector(
            'input[name="pricingMode"][value="single"]',
          ).checked = true;
          document.getElementById("p-price").value = p.price;
          document.getElementById("p-old-price").value =
            p.oldPrice && p.oldPrice > 0 ? p.oldPrice : "";
        }

        togglePricingMode();

        document.getElementById("form-mode-title").innerText =
          `تعديل: ${p.name.ar}`;
        document.getElementById("btn-add-prod").classList.add("hidden");
        document.getElementById("btn-update-prod").classList.remove("hidden");
        currentIngredients = p.ingredients || [];
        renderIngredientsList();

        document.getElementById("btn-cancel").classList.remove("hidden");
        window.scrollTo({ top: 0, behavior: "smooth" });
      }

      function resetProductForm() {
        editingProductId = null;
        document.getElementById("p-name").value = "";
        document.getElementById("p-price").value = "";
        document.getElementById("p-cat").value = "";
        document.getElementById("p-desc").value = "";
        document.getElementById("p-image").value = "";
        document.getElementById("p-preview").style.display = "none";
        document.getElementById("form-mode-title").innerText =
          "إضافة منتج جديد";
        document.getElementById("btn-add-prod").classList.remove("hidden");
        document.getElementById("btn-update-prod").classList.add("hidden");
        document.getElementById("btn-cancel").classList.add("hidden");
        currentIngredients = [];
        renderIngredientsList();
      }

      async function toggleProd(id) {
        await fetch(`/api/v1/products/${id}/toggle`, {
          method: "PATCH",
          headers: { Authorization: `Bearer ${token}` },
        });
        loadProducts();
      }

      async function deleteProd(id) {
        if (
          (
            await Swal.fire({
              title: "حذف المنتج؟",
              icon: "warning",
              showCancelButton: true,
            })
          ).isConfirmed
        ) {
          await fetch(`/api/v1/products/${id}`, {
            method: "DELETE",
            headers: { Authorization: `Bearer ${token}` },
          });
          loadProducts();
        }
      }

      function addBulkRow() {
        const container = document.getElementById("bulk-container");
        const rowId = Date.now();

        let catOptions = '<option value="">-- القسم --</option>';
        categoriesData.forEach((cat) => {
          catOptions += `<option value="${cat.name}">${cat.name}</option>`;
        });

        const html = `
        <div class="bulk-card" id="row-${rowId}">
            <button class="btn-remove-row" onclick="removeBulkRow('${rowId}')"><i class="fas fa-times"></i></button>
            
            <div class="form-grid">
                <input type="text" class="b-name" placeholder="اسم المنتج">
                
                <div style="background: var(--bg); padding: 10px; border-radius: 8px; border: 1px solid var(--border-color);">
                    <div style="display: flex; gap: 15px; margin-bottom: 10px; font-size: 13px;">
                        <label style="cursor: pointer; display: flex; align-items: center; gap: 5px;">
                            <input type="radio" name="mode-${rowId}" value="single" checked onchange="toggleBulkPricing('${rowId}')"> 
                            سعر موحد
                        </label>
                        <label style="cursor: pointer; display: flex; align-items: center; gap: 5px;">
                            <input type="radio" name="mode-${rowId}" value="multi" onchange="toggleBulkPricing('${rowId}')"> 
                            أحجام متعددة
                        </label>
                    </div>

                    <div id="single-inputs-${rowId}" style="display: flex; gap: 5px;">
                        <input type="number" class="b-price" placeholder="السعر" style="flex: 1; font-weight:bold;">
                        <input type="number" class="b-old-price" placeholder="السعر قبل الخصم" style="flex: 1; border:1px dashed var(--danger); background:#fff1f2;">
                    </div>

                    <div id="multi-inputs-${rowId}" class="hidden">
                        <div id="sizes-container-${rowId}" class="bulk-sizes-list"></div>
                        <button class="btn btn-outline" style="width:100%; border-style:dashed; font-size:12px; padding:5px;" onclick="addBulkSizeRow('${rowId}')">
                            <i class="fas fa-plus"></i> إضافة حجم
                        </button>
                    </div>
                </div>
            </div>

            <div class="form-grid" style="margin-top:10px">
                <select class="b-cat">${catOptions}</select>
                <div style="display:flex; align-items:center;">
                    <img id="preview-${rowId}" class="img-preview">
                    <label for="img-${rowId}" class="custom-file-upload">
                        <i class="fas fa-cloud-upload-alt"></i> صورة
                    </label>
                    <input type="file" id="img-${rowId}" class="b-image" accept="image/*" onchange="previewImage(this, 'preview-${rowId}')">
                </div>
            </div>
            <textarea class="b-desc" rows="1" placeholder="الوصف (اختياري)" style="margin-top:10px"></textarea>
        </div>
    `;
        container.insertAdjacentHTML("beforeend", html);
      }

      function removeBulkRow(id) {
        document.getElementById(`row-${id}`).remove();
      }

      async function submitBulkAll() {
    const rows = document.querySelectorAll(".bulk-card");
    const rId = document.getElementById("restaurant-id").value;

    if (!rId) {
        return Swal.fire("خطأ جسيم", "لا يوجد ID للمطعم! قم بعمل Refresh للصفحة وحاول مرة أخرى.", "error");
    }
    console.log("🚀 Starting Upload for Restaurant ID:", rId);

    let hasValidRow = false;
    for (const row of rows) {
        if (row.querySelector(".b-name").value && row.querySelector(".b-cat").value) {
            hasValidRow = true;
            break;
        }
    }
    
    if (!hasValidRow) return Swal.fire("تنبيه", "املأ بيانات منتج واحد على الأقل", "warning");

    Swal.fire({
        title: 'جاري الرفع...',
        html: 'يتم رفع المنتجات... يرجى الانتظار ومراقبة الـ Console لو حدث خطأ.',
        allowOutsideClick: false,
        didOpen: () => { Swal.showLoading(); }
    });

    let successCount = 0;
    let errorCount = 0;
    let limitReached = false;

    for (const row of rows) {
        const rowId = row.id.split("-")[1];
        const name = row.querySelector(".b-name").value;
        const cat = row.querySelector(".b-cat").value;
        const desc = row.querySelector(".b-desc").value;
        const imageFile = row.querySelector(".b-image").files[0];
        
        let mode = "single";
        const modeRadio = row.querySelector(`input[name="mode-${rowId}"]:checked`);
        if(modeRadio) mode = modeRadio.value;

        if (!name || !cat) continue;

        let finalPrice = 0;
        let finalOldPrice = 0;
        let finalSizes = [];

        if (mode === "single") {
            const priceVal = row.querySelector(".b-price").value;
            if (!priceVal) continue;
            finalPrice = parseFloat(priceVal);
            finalOldPrice = parseFloat(row.querySelector(".b-old-price").value) || 0;
            if (finalOldPrice <= finalPrice) finalOldPrice = 0;
        } else {
            const sizeRows = row.querySelectorAll(`#sizes-container-${rowId} .b-size-row`);
            if (sizeRows.length === 0) continue;
            let hasValidSize = false;
            sizeRows.forEach((sr) => {
                const sName = sr.querySelector(".bs-name").value;
                const sPrice = parseFloat(sr.querySelector(".bs-price").value);
                let sOld = parseFloat(sr.querySelector(".bs-old").value) || 0;
                if (sName && sPrice) {
                    if (sOld <= sPrice) sOld = 0;
                    finalSizes.push({ name: sName, price: sPrice, oldPrice: sOld });
                    hasValidSize = true;
                }
            });
            if (!hasValidSize) continue;
            finalPrice = finalSizes[0].price;
            finalOldPrice = 0;
        }

        const formData = new FormData();
        formData.append("restaurantId", rId);
        formData.append("name", JSON.stringify({ ar: name, en: name }));
        formData.append("description", JSON.stringify({ ar: desc, en: "" }));
        formData.append("category", cat);
        formData.append("price", finalPrice);
        formData.append("oldPrice", finalOldPrice);
        formData.append("sizes", JSON.stringify(finalSizes));
        if (imageFile) formData.append("image", imageFile);

        try {
            console.log(`⏳ Uploading: ${name}...`);

            const res = await fetch("/api/v1/products", {
                method: "POST",
                headers: { Authorization: `Bearer ${token}` },
                body: formData,
            });

            const responseData = await res.json(); 

            console.log(`📬 Server Response for ${name}:`, responseData);

            if (res.status === 403) {
                console.warn("⛔ Limit Reached!");
                limitReached = true;
                break; 
            }

            if (res.ok && responseData.status === 'success') {
                successCount++;
            } else {
                console.error(`❌ Failed to upload ${name}:`, responseData.message);
                errorCount++;
            }

        } catch (e) {
            console.error(`💥 Exception for ${name}:`, e);
            errorCount++;
        }
    }

    Swal.close();

    if (limitReached) {
        Swal.fire("تنبيه الباقة", `تم رفع ${successCount} منتجات وتوقفت العملية بسبب الحد الأقصى.`, "warning");
    } else if (errorCount > 0) {
        Swal.fire("انتبه", `تم رفع ${successCount} بنجاح، ولكن فشل ${errorCount} منتجات. راجع الـ Console للتفاصيل.`, "warning");
    } else {
        Swal.fire("نجاح", `تم رفع ${successCount} منتجات بنجاح`, "success");
    }

    document.getElementById("bulk-container").innerHTML = "";
    addBulkRow();
    loadProducts();
}

      const themesLibrary = [
        {
          id: "default",
          name: "الافتراضي",
          primary: "#4338ca",
          bg: "#F3F4F6",
          type: "color",
          font: "Tajawal",
          radius: 16,
          style: "solid",
          layout: "modern",
        },
        {
          id: "dark_lux",
          name: "فخامة",
          primary: "#D4AF37",
          bg: "#121212",
          type: "color",
          font: "Amiri",
          radius: 8,
          style: "glass",
          layout: "focus",
        },
        {
          id: "fresh",
          name: "فريش",
          primary: "#10b981",
          bg: "#ecfdf5",
          type: "color",
          font: "Almarai",
          radius: 24,
          style: "solid",
          layout: "grid",
        },
        {
          id: "burger",
          name: "برجر",
          primary: "#f59e0b",
          bg: "#1f2937",
          type: "color",
          font: "Cairo",
          radius: 30,
          style: "outlined",
          layout: "modern",
        },
        {
          id: "sky",
          name: "سماوي",
          primary: "#0ea5e9",
          bg: "#f0f9ff",
          type: "color",
          font: "Tajawal",
          radius: 12,
          style: "glass",
          layout: "list",
        },
        {
          id: "paper",
          name: "ورقي",
          primary: "#4b5563",
          bg: "#fffbeb",
          type: "color",
          font: "Cairo",
          radius: 4,
          style: "outlined",
          layout: "minimal",
        },
        {
          id: "neon",
          name: "نيون (Cyberpunk)",
          primary: "#0ff",
          bg: "#050505",
          type: "color",
          font: "Cairo",
          radius: 0,
          style: "neon",
          layout: "focus",
        },
        {
          id: "soft",
          name: "سوفت (3D)",
          primary: "#8899a6",
          bg: "#e0e5ec",
          type: "color",
          font: "Tajawal",
          radius: 20,
          style: "neumorphism",
          layout: "modern",
        },
        {
          id: "luxury",
          name: "فخامة (Royal)",
          primary: "#D4AF37",
          bg: "#1a1a1a",
          type: "pattern",
          font: "Amiri",
          radius: 8,
          style: "glass",
          layout: "magazine",
        },
        {
          id: "brutal",
          name: "بروتال (Trend)",
          primary: "#000000",
          bg: "#fffd00",
          type: "color",
          font: "Cairo",
          radius: 0,
          style: "brutalism",
          layout: "zigzag",
        },
        {
          id: "oriental",
          name: "شرقي (أصيل)",
          primary: "#c2410c",
          bg: "#fff7ed",
          type: "pattern",
          font: "Amiri",
          radius: 12,
          style: "solid",
          layout: "list",
        },
      ];

      let currentDesign = {
        layoutType: "modern",
        primaryColor: "#B78728",
        bgType: "color",
        bgValue: "#F9F9F9",
        cardStyle: "solid",
        cardRadius: 16,
        fontFamily: "Tajawal",
        heroOverlay: 30,
        heroHeight: 200,
      };

      function initDesignStudio(restaurantData) {
        if (restaurantData.customUI) {
          currentDesign = { ...currentDesign, ...restaurantData.customUI };
        }

        const themeContainer = document.getElementById("theme-library");
        if (themeContainer) {
          themeContainer.innerHTML = "";
          themesLibrary.forEach((t) => {
            const btn = document.createElement("div");
            btn.style.cssText = "cursor:pointer; text-align:center;";
            btn.onclick = () => applyTheme(t.id);
            btn.innerHTML = `
                <div style="height:45px; border-radius:10px; background:${t.bg}; border:2px solid ${t.primary}; position:relative; overflow:hidden; box-shadow:0 2px 5px rgba(0,0,0,0.1); margin-bottom:5px;">
                    <div style="position:absolute; bottom:0; width:100%; height:15px; background:${t.primary}"></div>
                </div>
                <div style="font-size:11px; font-weight:bold; color:var(--secondary)">${t.name}</div>
            `;
            themeContainer.appendChild(btn);
          });
        }

        if (document.getElementById("ui-heroOverlay"))
          document.getElementById("ui-heroOverlay").value =
            currentDesign.heroOverlay || 30;
        if (document.getElementById("ui-heroHeight"))
          document.getElementById("ui-heroHeight").value =
            currentDesign.heroHeight || 200;

        document.getElementById("ui-primaryColor").value =
          currentDesign.primaryColor;
        document.getElementById("ui-bgType").value = currentDesign.bgType;
        document.getElementById("ui-cardStyle").value = currentDesign.cardStyle;
        document.getElementById("ui-cardRadius").value =
          currentDesign.cardRadius;
        document.getElementById("ui-fontFamily").value =
          currentDesign.fontFamily;

        toggleBgInput();
        if (currentDesign.bgType === "color")
          document.getElementById("ui-bgColor").value = currentDesign.bgValue;
        else
          document.getElementById("ui-bgImage").value = currentDesign.bgValue;

        if (currentDesign.heroImage) {
          const heroPreview = document.getElementById("hero-preview");
          heroPreview.src = currentDesign.heroImage.replace(/\\/g, "/");
          heroPreview.style.display = "block";
        }

        document
          .querySelectorAll(".btn-layout")
          .forEach((b) => b.classList.remove("active"));
        document
          .getElementById(`btn-layout-${currentDesign.layoutType}`)
          .classList.add("active");

        const previewFrame = document.getElementById("live-preview");
        previewFrame.src = `/menu/${restaurantData.slug}`;

        previewFrame.onload = () => {
          updatePreview();
        };
      }

      function setUiParam(key, value) {
        currentDesign[key] = value;
        if (key === "cardRadius")
          document.getElementById("radius-val").innerText = value;
        if (key === "layoutType") {
          document
            .querySelectorAll(".btn-layout")
            .forEach((b) => b.classList.remove("active"));
          document
            .getElementById(`btn-layout-${value}`)
            .classList.add("active");
        }
        updatePreview();
      }

      function toggleBgInput() {
        const type = document.getElementById("ui-bgType").value;
        currentDesign.bgType = type;

        const colorInput = document.getElementById("ui-bgColor");
        const imgContainer = document.getElementById("ui-bgImage-container");

        if (type === "color") {
          colorInput.classList.remove("hidden");
          imgContainer.classList.add("hidden");
        } else if (type === "image") {
          colorInput.classList.add("hidden");
          imgContainer.classList.remove("hidden");
        } else {
          colorInput.classList.remove("hidden");
          imgContainer.classList.add("hidden");
        }
        updatePreview();
      }
      function updatePreview() {
        const iframe = document.getElementById("live-preview");
        if (iframe.contentWindow) {
          iframe.contentWindow.postMessage(
            { type: "UPDATE_THEME", config: currentDesign },
            "*",
          );
        }
      }

      async function saveDesignSettings() {
        const rId = document.getElementById("restaurant-id").value;
        const bgFile = document.getElementById("ui-bgFile").files[0];

        const formData = new FormData();

        formData.append("customUI", JSON.stringify(currentDesign));

        if (bgFile && currentDesign.bgType === "image") {
          formData.append("bgImage", bgFile);
        }

        const heroFile = document.getElementById("ui-heroFile").files[0];
        if (heroFile) {
          formData.append("heroImage", heroFile);
        }

        Swal.showLoading();
        try {
          const res = await fetch(`/api/v1/restaurants/${rId}`, {
            method: "PATCH",
            headers: { Authorization: `Bearer ${token}` },
            body: formData,
          });

          if (res.ok) {
            Swal.fire({
              icon: "success",
              title: "تم حفظ التصميم والصورة",
              timer: 1500,
              showConfirmButton: false,
            });
          } else {
            throw new Error("فشل الحفظ");
          }
        } catch (e) {
          console.error(e);
          Swal.fire("خطأ", "حدث خطأ أثناء الحفظ", "error");
        }
      }

      const defaultDesign = {
        layoutType: "modern",
        primaryColor: "#B78728",
        bgType: "color",
        bgValue: "#F9F9F9",
        cardStyle: "solid",
        cardRadius: 16,
        fontFamily: "Tajawal",
      };

      function resetDesign() {
        Swal.fire({
          title: "هل أنت متأكد؟",
          text: "سيعود التصميم للشكل الافتراضي (لن يتم الحفظ في قاعدة البيانات إلا بالضغط على حفظ).",
          icon: "warning",
          showCancelButton: true,
          confirmButtonColor: "#3085d6",
          cancelButtonColor: "#d33",
          confirmButtonText: "نعم، استعد الافتراضي",
          cancelButtonText: "إلغاء",
        }).then((result) => {
          if (result.isConfirmed) {
            currentDesign = { ...defaultDesign };

            document.getElementById("ui-primaryColor").value =
              currentDesign.primaryColor;
            document.getElementById("ui-bgType").value = currentDesign.bgType;
            document.getElementById("ui-cardStyle").value =
              currentDesign.cardStyle;
            document.getElementById("ui-cardRadius").value =
              currentDesign.cardRadius;
            document.getElementById("ui-fontFamily").value =
              currentDesign.fontFamily;
            document.getElementById("radius-val").innerText =
              currentDesign.cardRadius;

            toggleBgInput();
            if (currentDesign.bgType === "color") {
              document.getElementById("ui-bgColor").value =
                currentDesign.bgValue;
            } else {
              document.getElementById("ui-bgImage").value = "";
            }

            document
              .querySelectorAll(".btn-layout")
              .forEach((b) => b.classList.remove("active"));
            document
              .getElementById(`btn-layout-${currentDesign.layoutType}`)
              .classList.add("active");

            updatePreview();

            Swal.fire({
              toast: true,
              position: "top-end",
              icon: "info",
              title: "تم استعادة الشكل الافتراضي",
              showConfirmButton: false,
              timer: 1500,
            });
          }
        });
      }

      function handleBgUpload(input) {
        previewImage(input, "bg-preview");

        if (input.files && input.files[0]) {
          const reader = new FileReader();
          reader.onload = function (e) {
            setUiParam("bgValue", e.target.result);
          };
          reader.readAsDataURL(input.files[0]);
        }
      }
      function handleHeroUpload(input) {
        previewImage(input, "hero-preview");
        if (input.files && input.files[0]) {
          const reader = new FileReader();
          reader.onload = function (e) {
            setUiParam("heroImage", e.target.result);
          };
          reader.readAsDataURL(input.files[0]);
        }
      }

      let socket;

      window.loadOrders = async function () {
        const rId = document.getElementById("restaurant-id").value;

        const badge = document.getElementById("live-badge");
        if (badge) {
          badge.classList.add("hidden");
          badge.innerText = "0";
        }

        const container = document.getElementById("orders-grid");
        if (!container) return;

        container.innerHTML =
          '<div class="loading"><i class="fas fa-circle-notch fa-spin"></i> جاري التحميل...</div>';

        try {
          const res = await fetch(`/api/v1/orders/${rId}/active`, {
            headers: { Authorization: `Bearer ${token}` },
          });
          const data = await res.json();
          container.innerHTML = "";

          if (!data.data || data.data.orders.length === 0) {
            container.innerHTML =
              '<div style="grid-column: 1/-1; text-align:center; padding:40px; color:var(--secondary)"><i class="fas fa-clipboard-list fa-3x" style="margin-bottom:15px; opacity:0.5"></i><p>لا توجد طلبات نشطة حالياً.</p></div>';
            return;
          }

          data.data.orders.forEach((order) => {
            container.innerHTML += window.createOrderCardHTML(order);
          });
        } catch (e) {
          console.error(e);
          container.innerHTML =
            '<p style="color:red; text-align:center">حدث خطأ في تحميل الطلبات</p>';
        }
      };

      window.createOrderCardHTML = function (order) {
        const role =
          currentUserRole && currentUserRole !== ""
            ? currentUserRole
            : "cashier";

        if (
          role === "kitchen" &&
          (order.status === "completed" || order.status === "canceled")
        ) {
          return "";
        }

        const time = new Date(order.createdAt).toLocaleTimeString("ar-EG", {
          hour: "2-digit",
          minute: "2-digit",
        });

        let statusColor = "#f59e0b";
        let statusText = "جديد (انتظار)";
        let cardBg = "var(--surface)";

        if (order.status === "preparing") {
          statusColor = "#3b82f6";
          statusText = "جاري التجهيز";
        }

        let textColor = "var(--text-main)";

        if (order.status === "completed") {
          statusColor = "#10b981";
          statusText = "مكتمل";
          cardBg = "#ecfdf5";
          textColor = "#1f2937";
        }
        if (order.status === "canceled") {
          statusColor = "#ef4444";
          statusText = "ملغي";
          cardBg = "#fee2e2";
          textColor = "#1f2937";
        }

        let itemsHtml = "";
        order.items.forEach((item) => {
          itemsHtml += `<div style="display:flex; justify-content:space-between; margin-bottom:5px; font-size:14px; border-bottom:1px solid #eee; padding-bottom:5px;">
            <span>- ${item.name} <span style="font-weight:bold">x${item.qty}</span></span>
            ${role !== "kitchen" ? `<span>${item.price * item.qty}</span>` : ""} </div>`;
        });

        if (order.discountAmount > 0 && role !== "kitchen") {
          itemsHtml += `<div style="display:flex; justify-content:space-between; margin-bottom:5px; font-size:14px; color:var(--danger); font-weight:bold;">
            <span>خصم كوبون (${order.couponCode || ""}):</span>
            <span>-${order.discountAmount}</span>
        </div>`;
        }

        const orderDataEncoded = encodeURIComponent(JSON.stringify(order));
        let actions = "";

        const printBtn =
          role !== "kitchen"
            ? `<button class="btn btn-outline" onclick="window.printOrder('${orderDataEncoded}')" style="margin-left:5px; color:var(--text-main);" title="طباعة الفاتورة"><i class="fas fa-print"></i></button>`
            : "";

        if (order.status === "pending") {
          actions = `${printBtn} <button class="btn btn-primary" onclick="window.updateOrderStatus('${order._id}', 'preparing')" style="width:100%; margin-left:5px;">بدء التحضير <i class="fas fa-fire"></i></button>`;
        } else if (order.status === "preparing") {
          actions = `${printBtn} <button class="btn btn-success" onclick="window.updateOrderStatus('${order._id}', 'completed')" style="width:100%; margin-left:5px;">تم الانتهاء <i class="fas fa-check"></i></button>`;
        } else {
          actions = `${printBtn}`;
        }

        const cancelBtn =
          role !== "kitchen" &&
          order.status !== "completed" &&
          order.status !== "canceled"
            ? `<button class="btn btn-outline" onclick="window.updateOrderStatus('${order._id}', 'canceled')" style="color:var(--danger); border-color:var(--danger); padding:0 15px;"><i class="fas fa-times"></i></button>`
            : "";

        const tableDisplay =
          order.tableNumber === 0
            ? "تيك أواي 🏃"
            : `طاولة: ${order.tableNumber}`;

        const displayNum = order.orderNum
          ? `#${order.orderNum}`
          : `#${String(order._id).slice(-4)}`;

        return `
        <div class="card" id="order-${order._id}" style="border-top: 4px solid ${statusColor}; padding:15px; position:relative; background: ${cardBg}; color: ${textColor}">
            <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                <span style="font-weight:bold; font-size:18px; background:var(--primary); color:white; padding:2px 12px; border-radius:8px">${displayNum}</span>
                <span id="status-text-${order._id}" style="background:${statusColor}20; color:${statusColor}; padding:2px 8px; border-radius:10px; font-size:12px; font-weight:bold;">${statusText}</span>
            </div>
            <div style="font-weight:bold; font-size:18px; margin-bottom:5px;">${tableDisplay}</div>
            <div style="color:var(--secondary); font-size:12px; margin-bottom:15px;"><i class="far fa-clock"></i> ${time}</div>
            
            <div style="background:var(--bg); padding:10px; border-radius:8px; margin-bottom:15px; max-height:150px; overflow-y:auto;">
                ${itemsHtml}
            </div>
            
            ${
              role !== "kitchen"
                ? `
            <div style="display:flex; justify-content:space-between; font-weight:bold; margin-bottom:15px; border-top:1px dashed var(--border-color); padding-top:10px;">
                <span>الإجمالي:</span>
                <span style="color:var(--primary); font-size:18px">${order.totalPrice} ج.م</span>
            </div>`
                : ""
            } 
            
            <div id="actions-${order._id}" style="display:flex; justify-content:space-between;">
                <div style="flex:1; display:flex;">${actions}</div>
                ${cancelBtn}
            </div>
        </div>
    `;
      };
      window.updateOrderStatus = async function (orderId, status) {
        try {
          const btn = document.querySelector(`#order-${orderId} button`);
          if (btn) {
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
          }

          await fetch(`/api/v1/orders/${orderId}/status`, {
            method: "PATCH",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${token}`,
            },
            body: JSON.stringify({ status }),
          });

          const card = document.getElementById(`order-${orderId}`);
          if (card) {
            if (status === "completed") {
              card.style.background = "#ecfdf5";
              card.style.borderTopColor = "#10b981";
              const statusText = document.getElementById(
                `status-text-${orderId}`,
              );
              if (statusText) {
                statusText.innerText = "مكتمل";
                statusText.style.color = "#10b981";
              }
              window.loadOrders();
            } else if (status === "preparing") {
              card.style.borderTopColor = "#3b82f6";
              window.loadOrders();
            } else {
              window.loadOrders();
            }
          }
        } catch (e) {
          console.error(e);
          Swal.fire("خطأ", "فشل تحديث الحالة", "error");
        }
      };

      window.prependOrderCard = function (order) {
        const container = document.getElementById("orders-grid");
        if (container) {
          const html = window.createOrderCardHTML(order);
          container.insertAdjacentHTML("afterbegin", html);
        }
      };

      window.initSocket = function (rId) {
        if (socket) return;

        socket = io({
          transports: ["websocket"],
          upgrade: false,
        });

        socket.on("connect", () => {
          console.log("✅ Connected to Live Orders System");
          socket.emit("join-restaurant", rId);
        });

        socket.on("order-updated", (updatedOrder) => {
          console.log("🔄 Order Updated:", updatedOrder);

          const isOrdersPageOpen = !document
            .getElementById("view-orders")
            .classList.contains("hidden");
          if (isOrdersPageOpen) {
            window.loadOrders();
          }
        });

        socket.on("new-order", (order) => {
          console.log("🔔 New Order Received:", order);

          const audio = document.getElementById("order-sound");
          if (audio) {
            if (currentUserRole === "kitchen") {
              audio.src =
                "https://assets.mixkit.co/active_storage/sfx/alarm-tone-996.wav";
            } else {
              audio.src =
                "https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3";
            }
            audio.currentTime = 0;
            audio
              .play()
              .catch((err) =>
                console.log("🔊 اضغط على أي مكان في الصفحة لتفعيل الصوت"),
              );
          }

          Swal.fire({
            position: "top-end",
            icon: "success",
            title: `طلب جديد! طاولة: ${order.tableNumber}`,
            showConfirmButton: false,
            timer: 3000,
            toast: true,
          });

          const isOrdersPageOpen = !document
            .getElementById("view-orders")
            .classList.contains("hidden");

          if (isOrdersPageOpen) {
            window.prependOrderCard(order);
          } else {
            const badge = document.getElementById("live-badge");
            if (badge) {
              let currentCount = parseInt(badge.innerText || "0");
              if (isNaN(currentCount)) currentCount = 0;
              badge.innerText = currentCount + 1;
              badge.classList.remove("hidden");
              badge.style.display = "inline-block";
            }
          }
        });
      };

      function startShiftMonitor() {
        const shiftEndStr = sessionStorage.getItem("shiftEnd");
        if (!shiftEndStr) return;

        checkTime(shiftEndStr);

        setInterval(() => {
          checkTime(shiftEndStr);
        }, 30000);
      }

      function checkTime(shiftEndStr) {
        const now = new Date(Date.now() + serverTimeOffset);

        const [endH, endM] = shiftEndStr.split(":").map(Number);

        const currentMinutes = now.getHours() * 60 + now.getMinutes();
        const endMinutes = endH * 60 + endM;

        const isOvernightOverlap = currentMinutes - endMinutes > 720;

        const gracePeriod = 10;

        if (currentMinutes > endMinutes && !isOvernightOverlap) {
          const diff = currentMinutes - endMinutes;

          if (diff < gracePeriod) {
            const remaining = gracePeriod - diff;
            if (remaining === 5 || remaining === 1) {
              Swal.fire({
                icon: "warning",
                title: "انتهى وقت الشيفت!",
                text: `سيتم تسجيل الخروج تلقائياً خلال ${remaining} دقائق.`,
                timer: 3000,
                showConfirmButton: false,
                toast: true,
                position: "top",
              });
            }
          } else {
            Swal.fire({
              icon: "error",
              title: "انتهت فترة السماح",
              text: "انتهى الشيفت وتم إغلاق النظام.",
              allowOutsideClick: false,
              confirmButtonText: "حسناً",
            }).then(() => {
              logout();
            });
          }
        }
      }

      function exportToExcel(tableId, filename) {
        const table = document.getElementById(tableId);
        if (!table) return;

        const wb = XLSX.utils.table_to_book(table, { sheet: "Sheet1" });

       
        const date = new Date().toLocaleDateString('ar-EG').replace(/\//g, "-");
        const fullName = `${filename}_${date}.xlsx`;

        
        XLSX.writeFile(wb, fullName);
      }
      
      const startApp = async function () {
        if (!token) {
          document.getElementById("login-section").style.display = "flex";
          return;
        }

        await initDashboard();

        const rId = document.getElementById("restaurant-id").value;
        if (rId) {
          window.initSocket(rId);
        }

        if (
          !document.getElementById("view-orders").classList.contains("hidden")
        ) {
          window.loadOrders();
        }

        startShiftMonitor();
      };

      if (document.readyState === "loading") {
        document.addEventListener("DOMContentLoaded", () => {
            startApp();
            document.getElementById('sidebar').classList.remove('active');
            document.querySelector('.overlay').style.display = 'none';
        });
      } else {
        startApp();
        document.getElementById('sidebar').classList.remove('active');
        document.querySelector('.overlay').style.display = 'none';
      }
      window.loadHistory = async function () {
        const rId = document.getElementById("restaurant-id").value;
        const tbody = document.getElementById("history-list");
        const salesDisplay = document.getElementById("total-sales-display");
        const title = document.getElementById("history-title");

        let queryParams = "";

        const role =
          typeof currentUserRole !== "undefined" ? currentUserRole : "cashier";

        if (role === "owner") {
          const filterDiv = document.getElementById("owner-filters");
          if (filterDiv) filterDiv.style.display = "flex";
          if (title) title.innerText = "سجل المبيعات (شامل)";

          const start = document.getElementById("filter-start").value;
          const end = document.getElementById("filter-end").value;

          if (start && end) {
            queryParams = `?startDate=${start}&endDate=${end}`;
          }
          const searchVal = document.getElementById("history-search").value;
          if (searchVal) {
            queryParams += queryParams
              ? `&search=${searchVal}`
              : `?search=${searchVal}`;
          }
        } else {
          const filterDiv = document.getElementById("owner-filters");
          if (filterDiv) filterDiv.style.display = "none";
          if (title) title.innerText = "جرد الشيفت الحالي (اليوم)";
        }

        tbody.innerHTML =
          '<tr><td colspan="6" style="text-align:center">جارِ جلب البيانات...</td></tr>';

        try {
          const res = await fetch(
            `/api/v1/orders/${rId}/history${queryParams}`,
            {
              headers: { Authorization: `Bearer ${token}` },
            },
          );

          const data = await res.json();

          tbody.innerHTML = "";

          if (data.status !== "success") {
            tbody.innerHTML = `<tr><td colspan="6" style="text-align:center; color:red">${data.message || "حدث خطأ"}</td></tr>`;
            return;
          }

          if (salesDisplay)
            salesDisplay.innerText =
              (data.data.totalSales || 0).toLocaleString() + " ج.م";

          if (!data.data.orders || data.data.orders.length === 0) {
            tbody.innerHTML =
              '<tr><td colspan="6" style="text-align:center; padding:20px;">لا يوجد سجل مبيعات لهذه الفترة</td></tr>';
            return;
          }

          const groups = {};
          data.data.orders.forEach((order) => {
            const dateObj = new Date(order.createdAt);
            const monthKey = dateObj.toLocaleDateString("ar-EG", {
              month: "long",
              year: "numeric",
            });

            if (!groups[monthKey]) {
              groups[monthKey] = { orders: [], total: 0, count: 0 };
            }

            groups[monthKey].orders.push(order);
            if (order.status === "completed") {
              groups[monthKey].total += order.totalPrice;
              groups[monthKey].count += 1;
            }
          });

          for (const [month, info] of Object.entries(groups)) {
            tbody.innerHTML += `
                    <tr style="background-color: var(--primary-light); border-top: 2px solid var(--primary);">
                        <td colspan="6" style="padding: 10px 15px;">
                            <div style="display:flex; justify-content:space-between; align-items:center; font-weight:bold; color:var(--primary)">
                                <span><i class="fas fa-calendar-alt"></i> ${month}</span>
                                <span>مبيعات الشهر: ${info.total.toLocaleString()} ج.م (${info.count} طلب)</span>
                            </div>
                        </td>
                    </tr>
                `;

            info.orders.forEach((order) => {
              const time = new Date(order.createdAt).toLocaleTimeString(
                "ar-EG",
                { hour: "2-digit", minute: "2-digit" },
              );
              const dateDay = new Date(order.createdAt).toLocaleDateString(
                "ar-EG",
                { day: "numeric", month: "numeric" },
              );
              const itemsSummary = order.items
                .map((i) => `${i.name} (${i.qty})`)
                .join(", ");

              let statusBadge = "";
              if (order.status === "completed")
                statusBadge =
                  '<span class="badge" style="background:#dcfce7; color:#166534">مكتمل</span>';
              else if (order.status === "canceled")
                statusBadge =
                  '<span class="badge" style="background:#fee2e2; color:#991b1b">ملغي</span>';

              const tableNum =
                order.tableNumber === 0 ? "تيك أواي" : order.tableNumber;

              tbody.innerHTML += `
                        <tr style="background:var(--surface)">
                            <td style="font-weight:bold">#${order.orderNum || String(order._id).slice(-4)}</td>
                            <td style="font-size:12px">${dateDay} - ${time}</td>
                            <td>${tableNum}</td>
                            <td style="font-size:13px; color:var(--secondary); max-width:200px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap" title="${itemsSummary}">${itemsSummary}</td>
                            <td style="font-weight:bold">${order.totalPrice}</td>
                            <td>${statusBadge}</td>
                        </tr>
                    `;
            });
          }
        } catch (e) {
          console.error(e);
          tbody.innerHTML =
            '<tr><td colspan="6" style="text-align:center; color:red">حدث خطأ في الاتصال</td></tr>';
        }
      };

      function applyPermissions(role) {
        const allNavs = [
          "nav-categories",
          "nav-products",
          "nav-bulk",
          "nav-history",
          "nav-design",
          "nav-settings",
          "nav-staff",
        ];

        const permissions = {
          owner: [
            "nav-categories",
            "nav-products",
            "nav-bulk",
            "nav-history",
            "nav-design",
            "nav-settings",
            "nav-orders",
            "nav-staff",
            "nav-coupons",
          ],
          cashier: ["nav-orders", "nav-history"],
          kitchen: ["nav-orders"],
        };

        const allowed = permissions[role] || [];

        allNavs.forEach((id) => {
          const el = document.getElementById(id);
          if (el) el.classList.add("hidden");
        });

        allowed.forEach((id) => {
          const el = document.getElementById(id);
          if (el) el.classList.remove("hidden");
        });

        if (role === "owner") loadStaff();

        const recentBtn = document.getElementById("btn-recent-orders");
        if (recentBtn) {
          if (role === "kitchen") {
            recentBtn.classList.add("hidden");
          } else {
            recentBtn.classList.remove("hidden");
          }
        }
      }

      async function loadStaff() {
        try {
          const res = await fetch("/api/v1/users/my-staff", {
            headers: { Authorization: `Bearer ${token}` },
          });
          const data = await res.json();
          const list = document.getElementById("staff-list");
          list.innerHTML = "";
          data.data.staff.forEach((u) => {
            let roleBadge =
              u.role === "cashier"
                ? '<span class="badge" style="background:#dbeafe; color:#1e40af">كاشير</span>'
                : '<span class="badge" style="background:#ffedd5; color:#9a3412">مطبخ</span>';

            const shiftInfo =
              u.shiftStart && u.shiftEnd
                ? `<div style="font-size:11px; color:var(--secondary); margin-top:5px;"><i class="far fa-clock"></i> ${u.shiftStart} - ${u.shiftEnd}</div>`
                : "";

            list.innerHTML += `
                    <tr>
                        <td>
                            ${u.name}
                            ${shiftInfo}
                        </td>
                        <td>${u.email}</td>
                        <td>${roleBadge}</td>
                        <td><button class="btn btn-outline" style="color:red" onclick="deleteStaff('${u._id}')"><i class="fas fa-trash"></i></button></td>
                    </tr>
                `;
          });
        } catch (e) {
          console.error(e);
        }
      }

      async function addStaff() {
        const name = document.getElementById("staff-name").value;
        const email = document.getElementById("staff-email").value;
        const password = document.getElementById("staff-password").value;
        const role = document.getElementById("staff-role").value;
        const rId = document.getElementById("restaurant-id").value;

        const shiftStart = document.getElementById("staff-start").value;
        const shiftEnd = document.getElementById("staff-end").value;

        const restDays = [];
        document
          .querySelectorAll("#rest-days-container input:checked")
          .forEach((cb) => {
            restDays.push(parseInt(cb.value));
          });

        if (!name || !email || !password)
          return Swal.fire("تنبيه", "أكمل البيانات الأساسية", "warning");

        try {
          const res = await fetch("/api/v1/users/create-staff", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${token}`,
            },
            body: JSON.stringify({
              name,
              email,
              password,
              role,
              restaurantId: rId,
              shiftStart,
              shiftEnd,
              restDays,
            }),
          });
          const data = await res.json();
          if (data.status === "success") {
            Swal.fire("تم", "تم إضافة الموظف وتحديد الشيفت", "success");
            document.getElementById("staff-name").value = "";
            document.getElementById("staff-email").value = "";
            document.getElementById("staff-password").value = "";
            document
              .querySelectorAll("#rest-days-container input")
              .forEach((cb) => (cb.checked = false));
            loadStaff();
          } else {
            Swal.fire("خطأ", data.message, "error");
          }
        } catch (e) {
          console.error(e);
        }
      }

      async function deleteStaff(id) {
        if (
          (
            await Swal.fire({
              title: "حذف الموظف؟",
              icon: "warning",
              showCancelButton: true,
            })
          ).isConfirmed
        ) {
          await fetch(`/api/v1/users/staff/${id}`, {
            method: "DELETE",
            headers: { Authorization: `Bearer ${token}` },
          });
          loadStaff();
        }
      }

      window.printOrder = function (orderEncoded) {
        const order = JSON.parse(decodeURIComponent(orderEncoded));

        let fullTitle = document.getElementById("page-title").innerText;
        const restName = fullTitle.split("\n")[0] || "Smart Menu";

        const cashierName =
          sessionStorage.getItem("currentUserName") || "Cashier";

        const date = new Date(order.createdAt).toLocaleString("ar-EG");
        const orderNumDisplay = order.orderNum
          ? order.orderNum
          : String(order._id).slice(-4);
        
        const showOrderNum = document.getElementById("setting-print-num").value === "true";
        const orderNumHTML = showOrderNum ? `<div style="font-size:12px">أوردر #${orderNumDisplay}</div>` : '';

        let itemsHtml = "";
        order.items.forEach((item) => {
          itemsHtml += `
                <div style="display:flex; justify-content:space-between; margin-bottom:5px; font-size:12px;">
                    <span style="font-weight:bold;">${item.name}</span>
                    <span>${item.qty} x ${item.price}</span>
                </div>
                <div style="text-align:left; border-bottom:1px dashed #000; margin-bottom:5px; padding-bottom:2px;">
                    ${item.qty * item.price} ج.م
                </div>
            `;
        });

        const subTotal = order.subTotal || order.totalPrice;
        const taxVal = order.taxAmount || 0;
        const serviceVal = order.serviceAmount || 0;

        const receiptHTML = `
            <html>
            <head>
                <style>
                    body { font-family: 'Courier New', monospace; width: 300px; margin: 0; padding: 10px; direction: rtl; }
                    .header { text-align: center; margin-bottom: 10px; }
                    .title { font-size: 20px; font-weight: bold; }
                    .meta { font-size: 12px; margin-bottom: 10px; border-bottom: 1px solid #000; padding-bottom: 5px; }
                    .totals { margin-top: 10px; border-top: 1px dashed #000; padding-top: 5px; font-size: 14px; }
                    .row { display: flex; justify-content: space-between; }
                    .grand-total { font-size: 18px; font-weight: bold; margin-top: 5px; }
                    @media print { .no-print { display: none; } }
                </style>
            </head>
            <body>
                <div class="header">
                    <div class="title">${restName}</div>
                    ${orderNumHTML}
                </div>
                
                <div class="meta">
                    <div>التاريخ: ${date}</div>
                    <div>بواسطة: ${cashierName}</div>
                    <div>الطاولة: <strong>${order.tableNumber}</strong></div>
                    <div>نوع الطلب: ${order.tableNumber === 0 ? "تيك أواي" : "صالة"}</div>
                </div>

                <div class="items">${itemsHtml}</div>

                <div class="totals">
                    <div class="row"><span>المجموع:</span> <span>${subTotal}</span></div>
                    ${taxVal > 0 ? `<div class="row"><span>ضريبة:</span> <span>${taxVal}</span></div>` : ""}
                    ${serviceVal > 0 ? `<div class="row"><span>خدمة:</span> <span>${serviceVal}</span></div>` : ""}
                    ${order.discountAmount > 0 ? `<div class="row" style="color:black"><span>خصم:</span> <span>-${order.discountAmount}</span></div>` : ""}
                    <div class="row grand-total">
                        <span>الإجمالي:</span> <span>${order.totalPrice} ج.م</span>
                    </div>
                </div>

                <div style="text-align:center; margin-top:20px; font-size:12px;">
                    *** شكراً لزيارتكم ***
                </div>

                <script>
                    window.onload = function() { window.print(); setTimeout(() => window.close(), 1000); }
                <\/script>
            </body>
            </html>
        `;

        const popup = window.open("", "_blank", "width=350,height=600");
        popup.document.open();
        popup.document.write(receiptHTML);
        popup.document.close();
      };
    </script>

    <div
      id="recent-orders-modal"
      class="overlay"
      style="z-index: 2000; display: none"
    >
      <div
        class="card"
        style="
          width: 90%;
          max-width: 600px;
          max-height: 80vh;
          margin: 5vh auto;
          display: flex;
          flex-direction: column;
          padding: 0;
        "
      >
        <div
          style="
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
          "
        >
          <h3 style="margin: 0; color: var(--primary)">🧾 فواتير آخر ساعتين</h3>
          <button
            onclick="
              document.getElementById('recent-orders-modal').style.display =
                'none'
            "
            style="
              background: none;
              border: none;
              font-size: 20px;
              cursor: pointer;
              color: var(--text-main);
            "
          >
            <i class="fas fa-times"></i>
          </button>
        </div>
        <div
          id="recent-orders-list"
          style="padding: 20px; overflow-y: auto; flex: 1"
        ></div>
      </div>
    </div>

    <script>
      window.showRecentOrders = async function () {
        const rId = document.getElementById("restaurant-id").value;
        const modal = document.getElementById("recent-orders-modal");
        const container = document.getElementById("recent-orders-list");

        modal.style.display = "block";
        container.innerHTML =
          '<div style="text-align:center"><i class="fas fa-spinner fa-spin"></i> جاري التحميل...</div>';

        try {
          const res = await fetch(`/api/v1/orders/${rId}/recent-completed`, {
            headers: {
              Authorization: `Bearer ${sessionStorage.getItem("ownerToken")}`,
            },
          });
          const data = await res.json();

          container.innerHTML = "";
          if (data.data.orders.length === 0) {
            container.innerHTML =
              '<p style="text-align:center; color:var(--secondary)">لا توجد طلبات مكتملة في آخر ساعتين</p>';
            return;
          }

          data.data.orders.forEach((order) => {
            const time = new Date(order.updatedAt).toLocaleTimeString("ar-EG", {
              hour: "2-digit",
              minute: "2-digit",
            });
            const orderDataEncoded = encodeURIComponent(JSON.stringify(order));

            container.innerHTML += `
                <div style="background:var(--bg); border:1px solid var(--border-color); padding:10px; border-radius:10px; margin-bottom:10px; display:flex; justify-content:space-between; align-items:center;">
                    <div>
                        <div style="font-weight:bold; color:var(--text-main)">أوردر #${String(order._id).slice(-4)} <span style="font-size:12px; color:var(--success)">(${time})</span></div>
                        <div style="font-size:12px; color:var(--secondary)">${order.tableNumber === 0 ? "تيك أواي" : "طاولة " + order.tableNumber} - ${order.totalPrice} ج.م</div>
                    </div>
                    <button class="btn btn-outline" onclick="window.printOrder('${orderDataEncoded}')" style="padding:5px 15px;">
                        <i class="fas fa-print"></i> طباعة
                    </button>
                </div>
            `;
          });
        } catch (e) {
          container.innerHTML =
            '<p style="color:red; text-align:center">حدث خطأ</p>';
        }
      };

      let currentSizes = [];

      function togglePricingMode() {
        const mode = document.querySelector(
          'input[name="pricingMode"]:checked',
        ).value;
        if (mode === "single") {
          document.getElementById("mode-single").classList.remove("hidden");
          document.getElementById("mode-multi").classList.add("hidden");
        } else {
          document.getElementById("mode-single").classList.add("hidden");
          document.getElementById("mode-multi").classList.remove("hidden");
          if (document.getElementById("sizes-list").innerHTML === "")
            addSizeRow();
        }
      }

      function addSizeRow(name = "", price = "", oldPrice = "") {
        const id = Date.now();
        const oldValDisplay = oldPrice && oldPrice > 0 ? oldPrice : "";

        const html = `
                <div class="size-row" id="size-${id}" style="display:flex; gap:10px; margin-bottom:10px; align-items:flex-end;">
                    <div style="flex:2">
                        <input type="text" class="s-name" placeholder="اسم الحجم (صغير، وسط)" value="${name}">
                    </div>
                    <div style="flex:1">
                        <input type="number" class="s-price" placeholder="السعر" value="${price}">
                    </div>
                    <div style="flex:1">
                        <input type="number" class="s-old" placeholder="السعر الأصلي" value="${oldValDisplay}" 
                               style="border: 1px dashed var(--danger); background: #fff1f2; color: var(--danger);">
                    </div>
                    <button class="btn btn-outline" style="color:red; height:42px" onclick="document.getElementById('size-${id}').remove()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;
        document
          .getElementById("sizes-list")
          .insertAdjacentHTML("beforeend", html);
      }
      async function loadCoupons() {
        const rId = document.getElementById("restaurant-id").value;
        const res = await fetch(`/api/v1/coupons/${rId}`, {
          headers: { Authorization: `Bearer ${token}` },
        });
        const data = await res.json();
        const list = document.getElementById("coupons-list");
        list.innerHTML = "";
        data.data.coupons.forEach((c) => {
          const val =
            c.discountType === "percent" ? `${c.value}%` : `${c.value} ج.م`;
          list.innerHTML += `
            <tr>
                <td style="font-weight:bold; color:var(--primary)">${c.code}</td>
                <td>${val}</td>
                <td>${c.usedCount} / ${c.usageLimit}</td>
                <td><button class="btn btn-outline" style="color:red" onclick="deleteCoupon('${c._id}')"><i class="fas fa-trash"></i></button></td>
            </tr>
        `;
        });
      }

      async function createCoupon() {
        const rId = document.getElementById("restaurant-id").value;
        const body = {
          code: document.getElementById("coup-code").value,
          discountType: document.getElementById("coup-type").value,
          value: document.getElementById("coup-value").value,
          minOrderVal: document.getElementById("coup-min").value || 0,
          maxDiscount: document.getElementById("coup-max-disc").value || 0,
          usageLimit: document.getElementById("coup-limit").value || 1000,
        };
        if (!body.code || !body.value)
          return Swal.fire("تنبيه", "أدخل الكود والقيمة", "warning");

        const res = await fetch(`/api/v1/coupons/${rId}`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${token}`,
          },
          body: JSON.stringify(body),
        });
        const data = await res.json();
        if (data.status === "success") {
          Swal.fire({
            toast: true,
            icon: "success",
            title: "تم إنشاء الكوبون",
          });
          document.getElementById("coup-code").value = "";
          loadCoupons();
        } else {
          Swal.fire("خطأ", data.message, "error");
        }
      }

      async function deleteCoupon(id) {
        if (
          (
            await Swal.fire({
              title: "حذف الكوبون؟",
              icon: "warning",
              showCancelButton: true,
            })
          ).isConfirmed
        ) {
          await fetch(`/api/v1/coupons/${id}`, {
            method: "DELETE",
            headers: { Authorization: `Bearer ${token}` },
          });
          loadCoupons();
        }
      }
      function createRecentOrderHTML(order) {
        const time = new Date(order.updatedAt).toLocaleTimeString("ar-EG", {
          hour: "2-digit",
          minute: "2-digit",
        });
        const orderDataEncoded = encodeURIComponent(JSON.stringify(order));

        let itemsTxt = order.items
          .map((i) => `${i.name} (x${i.qty})`)
          .join("، ");

        return `
        <div style="background:var(--bg); border:1px solid var(--border-color); padding:15px; border-radius:10px; margin-bottom:10px;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                <div>
                    <span style="font-weight:bold; color:var(--text-main); font-size:16px;">أوردر #${order.orderNum}</span>
                    <span style="font-size:12px; color:var(--success); margin-right:5px;">(${time})</span>
                </div>
                <button class="btn btn-outline" onclick="window.printOrder('${orderDataEncoded}')" style="padding:5px 15px;">
                    <i class="fas fa-print"></i>
                </button>
            </div>
            
            <div style="font-size:13px; color:var(--text-main); margin-bottom:8px; line-height:1.6;">
                <strong>الأصناف:</strong> ${itemsTxt}
            </div>
            
            <div style="display:flex; justify-content:space-between; font-size:12px; color:var(--secondary); border-top:1px dashed #ddd; padding-top:5px;">
                <span>${order.tableNumber === 0 ? "تيك أواي" : "طاولة " + order.tableNumber}</span>
                <span style="font-weight:bold; color:var(--primary); font-size:14px;">${order.totalPrice} ج.م</span>
            </div>
        </div>
    `;
      }

      window.searchOrderHistory = async function () {
        const orderNum = document.getElementById("live-order-search").value;
        if (!orderNum) return;

        const rId = document.getElementById("restaurant-id").value;
        Swal.showLoading();

        try {
          const res = await fetch(
            `/api/v1/orders/${rId}/history?search=${orderNum}`,
            {
              headers: { Authorization: `Bearer ${token}` },
            },
          );
          const data = await res.json();
          Swal.close();

          if (data.status === "success" && data.data.orders.length > 0) {
            const modal = document.getElementById("recent-orders-modal");
            const container = document.getElementById("recent-orders-list");
            modal.style.display = "block";

            container.innerHTML = `<h4 style="text-align:center; margin-top:0">نتائج البحث عن أوردر #${orderNum}</h4>`;

            data.data.orders.forEach((order) => {
              container.innerHTML += createRecentOrderHTML(order);
            });
          } else {
            Swal.fire("غير موجود", "لم يتم العثور على طلب بهذا الرقم", "info");
          }
        } catch (e) {
          Swal.fire("خطأ", "حدث خطأ في البحث", "error");
        }
      };

      window.showRecentOrders = async function () {
        const rId = document.getElementById("restaurant-id").value;
        const modal = document.getElementById("recent-orders-modal");
        const container = document.getElementById("recent-orders-list");

        modal.style.display = "block";
        container.innerHTML =
          '<div style="text-align:center"><i class="fas fa-spinner fa-spin"></i> جاري التحميل...</div>';

        try {
          const res = await fetch(`/api/v1/orders/${rId}/recent-completed`, {
            headers: {
              Authorization: `Bearer ${sessionStorage.getItem("ownerToken")}`,
            },
          });
          const data = await res.json();

          container.innerHTML = "";
          if (data.data.orders.length === 0) {
            container.innerHTML =
              '<p style="text-align:center; color:var(--secondary)">لا توجد طلبات مكتملة حديثاً</p>';
            return;
          }

          data.data.orders.forEach((order) => {
            container.innerHTML += createRecentOrderHTML(order);
          });
        } catch (e) {
          container.innerHTML =
            '<p style="color:red; text-align:center">حدث خطأ</p>';
        }
      };
      function applyTheme(themeId) {
        const theme = themesLibrary.find((t) => t.id === themeId);
        if (!theme) return;

        currentDesign.primaryColor = theme.primary;
        currentDesign.bgType = theme.type;
        currentDesign.bgValue = theme.bg;
        currentDesign.fontFamily = theme.font;
        currentDesign.cardRadius = theme.radius;
        currentDesign.cardStyle = theme.style;
        currentDesign.layoutType = theme.layout;

        document.getElementById("ui-primaryColor").value = theme.primary;
        document.getElementById("ui-fontFamily").value = theme.font;
        document.getElementById("ui-cardRadius").value = theme.radius;
        document.getElementById("ui-cardStyle").value = theme.style;
        document.getElementById("radius-val").innerText = theme.radius;

        document.getElementById("ui-bgType").value = theme.type;
        toggleBgInput();
        if (theme.type === "color")
          document.getElementById("ui-bgColor").value = theme.bg;

        document
          .querySelectorAll(".btn-layout")
          .forEach((b) => b.classList.remove("active"));
        const activeBtn = document.getElementById(`btn-layout-${theme.layout}`);
        if (activeBtn) activeBtn.classList.add("active");

        updatePreview();

        Swal.fire({
          toast: true,
          position: "top-end",
          icon: "success",
          title: `تم تطبيق قالب: ${theme.name}`,
          showConfirmButton: false,
          timer: 1000,
        });
      }
      async function checkShiftStatus(role) {
        setInterval(async () => {
          const now = new Date();
          try {
            const res = await fetch("/api/v1/users/my-staff", {
              headers: { Authorization: `Bearer ${token}` },
            });

            if (res.status === 403) {
              const data = await res.json();
              if (data.message.includes("خارج وقت الشيفت")) {
                logout();
              }
            }
          } catch (e) {}
        }, 60000);
      }

      function toggleBulkPricing(rowId) {
        const mode = document.querySelector(
          `input[name="mode-${rowId}"]:checked`,
        ).value;
        const singleDiv = document.getElementById(`single-inputs-${rowId}`);
        const multiDiv = document.getElementById(`multi-inputs-${rowId}`);

        if (mode === "single") {
          singleDiv.classList.remove("hidden");
          multiDiv.classList.add("hidden");
        } else {
          singleDiv.classList.add("hidden");
          multiDiv.classList.remove("hidden");

          const container = document.getElementById(`sizes-container-${rowId}`);
          if (container.innerHTML.trim() === "") {
            addBulkSizeRow(rowId);
          }
        }
      }

      function addBulkSizeRow(rowId) {
        const container = document.getElementById(`sizes-container-${rowId}`);
        const sizeHtml = `
        <div class="b-size-row" style="display:flex; gap:5px; margin-bottom:5px; align-items:center;">
            <input type="text" class="bs-name" placeholder="الاسم (مثال: وسط)" style="flex:2; font-size:12px;">
            <input type="number" class="bs-price" placeholder="السعر" style="flex:1; font-size:12px;">
            <input type="number" class="bs-old" placeholder="قديم" style="flex:1; font-size:12px; background:#fff1f2;">
            <button onclick="this.parentElement.remove()" style="background:none; border:none; color:red; cursor:pointer;"><i class="fas fa-times"></i></button>
        </div>
    `;
        container.insertAdjacentHTML("beforeend", sizeHtml);
      }
      async function submitBulkAll() {
        const rows = document.querySelectorAll(".bulk-card");
        const rId = document.getElementById("restaurant-id").value;
        let promises = [];
        let validCount = 0;

        for (const row of rows) {
          const rowId = row.id.split("-")[1];

          const name = row.querySelector(".b-name").value;
          const cat = row.querySelector(".b-cat").value;
          const desc = row.querySelector(".b-desc").value;
          const imageFile = row.querySelector(".b-image").files[0];
          const mode = row.querySelector(
            `input[name="mode-${rowId}"]:checked`,
          ).value;

          if (!name || !cat) continue;

          let finalPrice = 0;
          let finalOldPrice = 0;
          let finalSizes = [];

          if (mode === "single") {
            const priceVal = row.querySelector(".b-price").value;
            if (!priceVal) continue;

            finalPrice = parseFloat(priceVal);
            finalOldPrice =
              parseFloat(row.querySelector(".b-old-price").value) || 0;
            if (finalOldPrice <= finalPrice) finalOldPrice = 0;
          } else {
            const sizeRows = row.querySelectorAll(
              `#sizes-container-${rowId} .b-size-row`,
            );
            if (sizeRows.length === 0) continue;

            let hasValidSize = false;
            sizeRows.forEach((sr) => {
              const sName = sr.querySelector(".bs-name").value;
              const sPrice = parseFloat(sr.querySelector(".bs-price").value);
              let sOld = parseFloat(sr.querySelector(".bs-old").value) || 0;

              if (sName && sPrice) {
                if (sOld <= sPrice) sOld = 0;
                finalSizes.push({ name: sName, price: sPrice, oldPrice: sOld });
                hasValidSize = true;
              }
            });

            if (!hasValidSize) continue;

            finalPrice = finalSizes[0].price;
            finalOldPrice = 0;
          }

          validCount++;
          const formData = new FormData();
          formData.append("restaurantId", rId);
          formData.append("name", JSON.stringify({ ar: name, en: name }));
          formData.append("description", JSON.stringify({ ar: desc, en: "" }));
          formData.append("category", cat);
          formData.append("price", finalPrice);
          formData.append("oldPrice", finalOldPrice);
          formData.append("sizes", JSON.stringify(finalSizes));

          if (imageFile) formData.append("image", imageFile);

          promises.push(
            fetch("/api/v1/products", {
              method: "POST",
              headers: { Authorization: `Bearer ${token}` },
              body: formData,
            }),
          );
        }

        if (validCount === 0)
          return Swal.fire(
            "تنبيه",
            "تأكد من إدخال الاسم، القسم، والسعر لمنتج واحد على الأقل",
            "warning",
          );

        Swal.showLoading();

        try {
          await Promise.all(promises);
          Swal.close();
          Swal.fire({
            toast: true,
            icon: "success",
            title: `تم رفع ${validCount} منتجات بنجاح`,
          });

          document.getElementById("bulk-container").innerHTML = "";
          addBulkRow();
          loadProducts();
        } catch (e) {
          console.error(e);
          Swal.fire("خطأ", "حدث خطأ أثناء الرفع، راجع المدخلات", "error");
        }
      }

async function loadStockItems() {
    const rId = document.getElementById("restaurant-id").value;
    const tbody = document.getElementById('stock-items-list');
    
    tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;">جاري التحميل...</td></tr>';

    try {
        const res = await fetch(`/api/v1/stock/${rId}`, { headers: { 'Authorization': `Bearer ${token}` } });
        const data = await res.json();
        
        if(data.status === 'success') {
            stockItemsData = data.data.items;
            renderStockTable();
            renderStockDropdown();
        } else {
            tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; color:red;">فشل التحميل</td></tr>';
        }
    } catch(e) { console.error(e); }
}

function renderStockTable() {
    const tbody = document.getElementById('stock-items-list');
    tbody.innerHTML = '';
    
    if(stockItemsData.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; color:var(--secondary); padding:20px;">المخزن فارغ! ابدأ بإضافة خاماتك.</td></tr>';
        return;
    }

    stockItemsData.forEach(item => {
        const isLow = item.quantity <= item.alertLevel;
        const qtyStyle = isLow ? 'color:red; font-weight:bold; background:#fee2e2; padding:2px 8px; border-radius:4px;' : 'font-weight:bold; color:green;';
        const alertIcon = isLow ? '<i class="fas fa-exclamation-circle" style="color:red" title="كمية منخفضة"></i>' : '';

        tbody.innerHTML += `
            <tr>
                <td style="font-weight:bold; font-size:15px;">${item.name} ${alertIcon}</td>
                <td><span style="${qtyStyle}">${item.quantity}</span></td>
                <td>${item.unit}</td>
                <td>${item.costPerUnit || 0}</td>
                <td>
                    <div style="display:flex; gap:5px;">
                        <button class="btn btn-outline" style="font-size:12px; padding:5px 10px; color:var(--primary); border-color:var(--primary)" 
                            onclick="adjustStock('${item._id}', '${item.name}')" title="تحديث الكمية (شراء/استهلاك)">
                            <i class="fas fa-sync-alt"></i> جرد
                        </button>
                        <button class="btn btn-outline" style="font-size:12px; padding:5px 10px; color:var(--danger); border-color:var(--danger)" 
                            onclick="deleteStockItem('${item._id}')" title="حذف الخامة نهائياً">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </td>
            </tr>
        `;
    });
}

function renderStockDropdown() {
    const selectors = ['stock-select', 'recipe-stock-select'];
    
    selectors.forEach(selId => {
        const sel = document.getElementById(selId);
        if(sel) {
            sel.innerHTML = '<option value="">-- اختر الخامة --</option>';
            stockItemsData.forEach(item => {
                sel.innerHTML += `<option value="${item._id}" data-unit="${item.unit}" data-name="${item.name}">${item.name} (بالـ ${item.unit})</option>`;
            });
        }
    });
}

async function openStockModal() {
    const { value: formValues } = await Swal.fire({
        title: '📝 إضافة خامة جديدة',
        html:
            '<label style="display:block; text-align:right; margin-bottom:5px;">اسم الخامة</label>' +
            '<input id="swal-st-name" class="swal2-input" placeholder="مثال: بن برازيلي" style="margin-top:0;">' +
            
            '<label style="display:block; text-align:right; margin-bottom:5px; margin-top:10px;">وحدة القياس</label>' +
            '<input id="swal-st-unit" class="swal2-input" placeholder="مثال: kg أو liter أو قطعة" style="margin-top:0;">' +
            
            '<div style="display:flex; gap:10px; margin-top:10px;">' +
                '<div style="flex:1"><label style="display:block; text-align:right; font-size:12px;">الكمية الحالية</label><input id="swal-st-qty" type="number" class="swal2-input" placeholder="0" style="margin:0;"></div>' +
                '<div style="flex:1"><label style="display:block; text-align:right; font-size:12px;">سعر الوحدة</label><input id="swal-st-cost" type="number" class="swal2-input" placeholder="0" style="margin:0;"></div>' +
            '</div>' +
            
            '<label style="display:block; text-align:right; margin-bottom:5px; margin-top:10px; font-size:12px; color:var(--secondary)">نبهني لما الكمية توصل لـ:</label>' +
            '<input id="swal-st-alert" type="number" class="swal2-input" value="5" style="margin-top:0;">',
        focusConfirm: false,
        confirmButtonText: 'حفظ الخامة',
        showCancelButton: true,
        cancelButtonText: 'إلغاء',
        preConfirm: () => {
            const name = document.getElementById('swal-st-name').value;
            const unit = document.getElementById('swal-st-unit').value;
            if(!name || !unit) Swal.showValidationMessage('الاسم والوحدة مطلوبين!');
            
            return {
                name: name,
                quantity: document.getElementById('swal-st-qty').value || 0,
                unit: unit,
                costPerUnit: document.getElementById('swal-st-cost').value || 0,
                alertLevel: document.getElementById('swal-st-alert').value || 5
            }
        }
    });

    if (formValues) {
        const rId = document.getElementById("restaurant-id").value;
        try {
            await fetch('/api/v1/stock', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                body: JSON.stringify({ ...formValues, restaurantId: rId })
            });
            loadStockItems();
            Swal.fire({ toast: true, icon: 'success', title: 'تمت الإضافة بنجاح' });
        } catch(e) { Swal.fire('خطأ', 'حدث خطأ في الحفظ', 'error'); }
    }
}

async function adjustStock(id, name) {
    const { value: adjustment } = await Swal.fire({
        title: `جرد: ${name}`,
        html: `
            <p>أدخل الكمية التي تريد إضافتها أو خصمها.</p>
            <ul style="text-align:right; font-size:13px; color:var(--secondary)">
                <li>لإضافة مشتريات جديدة: اكتب رقم موجب (مثال: 5)</li>
                <li>لتسجيل هالك أو عجز: اكتب رقم سالب (مثال: -1)</li>
            </ul>
        `,
        input: 'number',
        inputLabel: 'الكمية',
        showCancelButton: true,
        confirmButtonText: 'تحديث الرصيد',
        cancelButtonText: 'إلغاء'
    });

    if (adjustment) {
        const type = Number(adjustment) > 0 ? 'restock' : 'adjustment';
        try {
            await fetch(`/api/v1/stock/${id}/adjust`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                body: JSON.stringify({ amount: Number(adjustment), type })
            });
            loadStockItems();
            Swal.fire({ toast: true, icon: 'success', title: 'تم تحديث الرصيد' });
        } catch(e) { Swal.fire('خطأ', 'فشل التحديث', 'error'); }
    }
}

async function deleteStockItem(id) {
    const result = await Swal.fire({
        title: 'حذف الخامة؟',
        text: "سيتم حذف الخامة من المخزن. إذا كانت مرتبطة بمنتجات (في المقادير) يفضل تعديل المنتجات أولاً.",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#d33',
        confirmButtonText: 'نعم، احذف',
        cancelButtonText: 'تراجع'
    });

    if (result.isConfirmed) {
        try {
            const res = await fetch(`/api/v1/stock/${id}`, {
                method: 'DELETE',
                headers: { 'Authorization': `Bearer ${token}` }
            });
            if(res.ok) {
                loadStockItems();
                Swal.fire({ toast: true, icon: 'success', title: 'تم الحذف' });
            } else {
                Swal.fire('خطأ', 'فشل الحذف', 'error');
            }
        } catch(e) { Swal.fire('خطأ', 'مشكلة في الاتصال', 'error'); }
    }
}

async function loadStockLogs() {
    const rId = document.getElementById("restaurant-id").value;
    const start = document.getElementById('stock-report-start').value;
    const end = document.getElementById('stock-report-end').value;
    const tbody = document.getElementById('stock-logs-list');
    
    tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;">جاري جلب السجل...</td></tr>';

    let query = `?restaurantId=${rId}`;
    if(start && end) query += `&startDate=${start}&endDate=${end}`;

    try {
        const res = await fetch(`/api/v1/stock/logs${query}`, { headers: { 'Authorization': `Bearer ${token}` } });
        const data = await res.json();
        
        tbody.innerHTML = '';
        
        if(data.data.logs.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;">لا يوجد سجل حركة في هذه الفترة</td></tr>';
            return;
        }

        data.data.logs.forEach(log => {
            let typeAr = '';
            let typeColor = '';
            
            switch(log.type) {
                case 'consumption': typeAr = 'بيع (أوردر)'; typeColor = '#64748b'; break;
                case 'restock': typeAr = 'شراء / توريد'; typeColor = 'green'; break;
                case 'adjustment': typeAr = 'تسويه جرد / هالك'; typeColor = 'orange'; break;
                default: typeAr = log.type;
            }

            let changeColor = log.changeAmount > 0 ? 'green' : 'red';
            let note = log.orderId ? `<span style="font-family:monospace; background:#f1f5f9; padding:2px 5px; border-radius:4px;">#${String(log.orderId).slice(-4)}</span>` : '-';
            
            tbody.innerHTML += `
                <tr>
                    <td>${new Date(log.date).toLocaleDateString('ar-EG')} <span style="font-size:11px; color:#999">${new Date(log.date).toLocaleTimeString('ar-EG')}</span></td>
                    <td style="font-weight:bold;">${log.itemName || 'خامة محذوفة'}</td>
                    <td style="color:${typeColor}; font-weight:bold;">${typeAr}</td>
                    <td style="color:${changeColor}; direction:ltr; text-align:right; font-weight:bold;">${log.changeAmount}</td>
                    <td>${note}</td>
                </tr>
            `;
        });
    } catch(e) {
        tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; color:red;">خطأ في تحميل السجل</td></tr>';
    }
}


function addIngredientRow(stockItem = null, qty = null) {
    const select = document.getElementById('stock-select');
    const qtyInput = document.getElementById('stock-qty');
    
    let id, name, unit, amount;

    if (stockItem) {
        id = stockItem.stockItem._id || stockItem.stockItem; 
        name = stockItem.stockItem.name || 'خامة';
        unit = stockItem.stockItem.unit || '';
        amount = stockItem.quantity;
    } else {
        id = select.value;
        const selectedOpt = select.options[select.selectedIndex];
        name = selectedOpt.getAttribute('data-name');
        unit = selectedOpt.getAttribute('data-unit');
        amount = qtyInput.value;
    }

    if(!id || !amount) return;

    currentIngredients.push({ stockItem: id, quantity: Number(amount) });
    renderIngredientsList();
    
    qtyInput.value = '';
    select.value = '';
}

function renderIngredientsList() {
    const container = document.getElementById('prod-ingredients-list');
    container.innerHTML = '';
    
    currentIngredients.forEach((ing, index) => {
        let stockObj = stockItemsData.find(s => s._id === ing.stockItem || s._id === ing.stockItem._id);
        
        let displayName = stockObj ? stockObj.name : 'خامة';
        let displayUnit = stockObj ? stockObj.unit : '';

        container.innerHTML += `
            <div style="display:flex; justify-content:space-between; align-items:center; background:white; padding:8px 12px; margin-bottom:5px; border-radius:6px; border:1px solid #e2e8f0;">
                <span style="font-size:14px;">🔹 ${displayName}: <strong>${ing.quantity}</strong> ${displayUnit}</span>
                <button onclick="removeIngredient(${index})" style="color:#ef4444; background:none; border:none; cursor:pointer; font-size:16px;">&times;</button>
            </div>
        `;
    });
}

function removeIngredient(index) {
    currentIngredients.splice(index, 1);
    renderIngredientsList();
}
      let activeRecipeProduct = null;
      let activeIngredients = [];

      function initRecipesView() {
          loadStockItems().then(() => {
              renderRecipeStockSelect();
          });
          loadRecipeProducts();
      }

      async function loadRecipeProducts() {
          const rId = document.getElementById("restaurant-id").value;
          const container = document.getElementById("recipe-products-list");
          container.innerHTML = '<div style="text-align:center; padding:10px;"><i class="fas fa-spinner fa-spin"></i></div>';

          try {
              const res = await fetch(`/api/v1/products/restaurant/${rId}`, {
                  headers: { Authorization: `Bearer ${token}` },
              });
              const data = await res.json();
              
              if (data.status === "success") {
                  window.allRecipeProducts = data.data.products;
                  renderRecipeProductList(window.allRecipeProducts);
              }
          } catch (e) {
              console.error(e);
              container.innerHTML = '<div style="color:red; text-align:center;">خطأ في التحميل</div>';
          }
      }

      function renderRecipeProductList(products) {
          const container = document.getElementById("recipe-products-list");
          container.innerHTML = "";
          
          if(products.length === 0) {
              container.innerHTML = '<div style="text-align:center; color:gray;">لا توجد منتجات</div>';
              return;
          }

          products.forEach(p => {
              const hasIngredients = p.ingredients && p.ingredients.length > 0;
              const statusIcon = hasIngredients 
                  ? '<i class="fas fa-check-circle" style="color:var(--success)"></i>' 
                  : '<i class="fas fa-circle" style="color:#e2e8f0"></i>';

              const div = document.createElement("div");
              div.style.cssText = `
                  padding: 10px; background: var(--bg); border-radius: 8px; cursor: pointer;
                  display: flex; align-items: center; gap: 10px; transition: 0.2s; border: 1px solid transparent;
              `;
              div.innerHTML = `
                  ${statusIcon}
                  <div style="flex:1; font-weight:bold; font-size:14px;">${p.name.ar}</div>
                  <i class="fas fa-chevron-left" style="font-size:12px; color:var(--secondary)"></i>
              `;
              
              div.onclick = () => {
                  document.querySelectorAll("#recipe-products-list > div").forEach(d => d.style.borderColor = "transparent");
                  div.style.borderColor = "var(--primary)";
                  div.style.background = "var(--primary-light)";
                  openRecipeEditor(p);
              };
              container.appendChild(div);
          });
      }

      function filterRecipeProducts() {
          const term = document.getElementById("recipe-search").value.toLowerCase();
          const filtered = window.allRecipeProducts.filter(p => p.name.ar.toLowerCase().includes(term));
          renderRecipeProductList(filtered);
      }

      function openRecipeEditor(product) {
          activeRecipeProduct = product;
          activeIngredients = product.ingredients ? [...product.ingredients] : [];

          document.getElementById("recipe-editor-empty").classList.add("hidden");
          document.getElementById("recipe-editor-content").classList.remove("hidden");
          document.getElementById("recipe-active-name").innerText = product.name.ar;

          renderActiveIngredientsTable();
      }

      function renderRecipeStockSelect() {
          const select = document.getElementById("recipe-stock-select");
          select.innerHTML = '<option value="">-- اختر الخامة --</option>';
          
          if(typeof stockItemsData !== 'undefined') {
              stockItemsData.forEach(item => {
                  select.innerHTML += `<option value="${item._id}" data-unit="${item.unit}" data-name="${item.name}">${item.name} (${item.unit})</option>`;
              });
          }

          select.onchange = function() {
              const unit = this.options[this.selectedIndex].getAttribute("data-unit");
              document.getElementById("recipe-unit-hint").innerText = unit ? `الوحدة المستخدمة: ${unit}` : "";
          };
      }

      function addIngredientToActive() {
          const select = document.getElementById("recipe-stock-select");
          const qtyInput = document.getElementById("recipe-stock-qty");
          
          const stockId = select.value;
          const qty = parseFloat(qtyInput.value);
          const name = select.options[select.selectedIndex]?.getAttribute("data-name");
          const unit = select.options[select.selectedIndex]?.getAttribute("data-unit");

          if(!stockId || !qty || qty <= 0) return Swal.fire("تنبيه", "اختر الخامة والكمية الصحيحة", "warning");

          const existing = activeIngredients.find(i => i.stockItem && (i.stockItem._id || i.stockItem) === stockId);
          if(existing) {
              existing.quantity = qty;
          } else {
              activeIngredients.push({
                  stockItem: { _id: stockId, name: name, unit: unit }, 
                  quantity: qty
              });
          }

          renderActiveIngredientsTable();
          select.value = "";
          qtyInput.value = "";
          document.getElementById("recipe-unit-hint").innerText = "";
      }

      function renderActiveIngredientsTable() {
          const tbody = document.getElementById("recipe-active-list");
          tbody.innerHTML = "";

          activeIngredients.forEach((ing, index) => {
              if (!ing.stockItem) {
                  tbody.innerHTML += `
                      <tr style="background:#fff1f2;">
                          <td style="color:red; font-weight:bold;">⚠️ خامة محذوفة</td>
                          <td style="font-weight:bold;">${ing.quantity}</td>
                          <td>-</td>
                          <td>
                              <button class="btn btn-outline" style="color:red; padding:2px 8px;" onclick="removeActiveIngredient(${index})">
                                  <i class="fas fa-trash"></i>
                              </button>
                          </td>
                      </tr>
                  `;
                  return;
              }

              let name = ing.stockItem.name || "خامة";
              let unit = ing.stockItem.unit || "-";
              
              if(!ing.stockItem.name && typeof stockItemsData !== 'undefined') {
                  const s = stockItemsData.find(x => x._id === ing.stockItem);
                  if(s) { name = s.name; unit = s.unit; }
              }

              tbody.innerHTML += `
                  <tr>
                      <td>${name}</td>
                      <td style="font-weight:bold; color:var(--primary)">${ing.quantity}</td>
                      <td>${unit}</td>
                      <td>
                          <button class="btn btn-outline" style="color:red; padding:2px 8px;" onclick="removeActiveIngredient(${index})">
                              <i class="fas fa-trash"></i>
                          </button>
                      </td>
                  </tr>
              `;
          });

          if(activeIngredients.length === 0) {
              tbody.innerHTML = '<tr><td colspan="4" style="text-align:center; color:gray;">لم يتم إضافة مقادير بعد</td></tr>';
          }
      }

      function removeActiveIngredient(index) {
          activeIngredients.splice(index, 1);
          renderActiveIngredientsTable();
      }

      async function saveActiveRecipe() {
          if(!activeRecipeProduct) return;

          const cleanIngredients = activeIngredients.map(i => ({
              stockItem: i.stockItem._id || i.stockItem,
              quantity: i.quantity
          }));

          const formData = new FormData();
          
          formData.append("ingredients", JSON.stringify(cleanIngredients));
          
          formData.append("name", JSON.stringify(activeRecipeProduct.name));
          formData.append("category", activeRecipeProduct.category);
          formData.append("restaurantId", document.getElementById("restaurant-id").value);

          Swal.showLoading();
          try {
              const res = await fetch(`/api/v1/products/${activeRecipeProduct._id}`, {
                  method: "PATCH",
                  headers: { Authorization: `Bearer ${token}` },
                  body: formData
              });
              
              const data = await res.json();
              Swal.close();

              if (data.status === "success") {
                  Swal.fire({ toast: true, icon: "success", title: "تم حفظ المقادير بنجاح" });
                  
                  const updatedProd = data.data.product;
                  const idx = window.allRecipeProducts.findIndex(p => p._id === updatedProd._id);
                  if(idx !== -1) window.allRecipeProducts[idx] = updatedProd;
                  
                  renderRecipeProductList(window.allRecipeProducts);
              } else {
                  Swal.fire("خطأ", data.message, "error");
              }
          } catch (e) {
              console.error(e);
              Swal.fire("خطأ", "فشل الاتصال بالسيرفر", "error");
          }
      }
    </script>
    <div id="manual-order-modal" class="overlay" style="z-index: 9999; display: none;">
        <div class="card" style="width: 90%; max-width: 800px; margin: 2vh auto; max-height: 95vh; display: flex; flex-direction: column; padding: 0;">
            <div style="padding: 15px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; background: var(--bg);">
                <h3 style="margin: 0; color: var(--primary)"><i class="fas fa-cash-register"></i> إنشاء طلب يدوي</h3>
                <button onclick="closeManualOrderModal()" style="background: none; border: none; font-size: 20px; cursor: pointer; color: var(--danger);"><i class="fas fa-times"></i></button>
            </div>
            
            <div style="padding: 15px; overflow-y: auto; flex: 1;">
                <div style="display: flex; gap: 15px; flex-wrap: wrap; margin-bottom: 20px;">
                    <div style="flex: 1; min-width: 200px;">
                         <label class="form-label">بحث عن منتج</label>
                         <input type="text" id="manual-search" placeholder="اكتب اسم المنتج..." onkeyup="filterManualProducts()" style="margin-bottom: 5px;">
                         <div id="manual-products-results" style="border: 1px solid var(--border-color); max-height: 150px; overflow-y: auto; display: none; background: var(--surface); position: absolute; width: 300px; z-index: 100; border-radius: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.1);"></div>
                    </div>
                    <div style="flex: 1; min-width: 150px;">
                        <label class="form-label">رقم الطاولة (اختياري)</label>
                        <input type="text" id="manual-table" placeholder="مثال: 5 أو تيك أواي">
                    </div>
                </div>

                <div class="table-wrapper" style="margin-bottom: 15px;">
                    <table style="min-width: 100%;">
                        <thead>
                            <tr>
                                <th>المنتج</th>
                                <th>السعر</th>
                                <th>الكمية</th>
                                <th>الإجمالي</th>
                                <th>حذف</th>
                            </tr>
                        </thead>
                        <tbody id="manual-cart-list">
                            </tbody>
                    </table>
                </div>

                <div style="background: var(--bg); padding: 15px; border-radius: 12px; border: 1px solid var(--border-color);">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                        <span>المجموع:</span> <span id="manual-subtotal" style="font-weight: bold;">0</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                         <span>الضريبة / الخدمة:</span> <span id="manual-tax-serv">0</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; font-size: 18px; font-weight: bold; color: var(--primary); border-top: 1px dashed var(--border-color); padding-top: 5px;">
                        <span>الإجمالي النهائي:</span> <span id="manual-final">0</span>
                    </div>
                </div>
            </div>

            <div style="padding: 15px; border-top: 1px solid var(--border-color); background: var(--bg); text-align: left;">
                <button class="btn btn-success" onclick="submitManualOrder()" style="width: 100%; font-size: 16px;">
                    <i class="fas fa-check"></i> تأكيد وإنشاء الطلب
                </button>
            </div>
        </div>
    </div>

    <script>
        let manualCart = [];

        function openManualOrderModal() {
            if (!window.allProductsGlobal || window.allProductsGlobal.length === 0) {
                loadProducts().then(() => {
                    document.getElementById('manual-order-modal').style.display = 'block';
                });
            } else {
                document.getElementById('manual-order-modal').style.display = 'block';
            }
            manualCart = [];
            renderManualCart();
            document.getElementById('manual-table').value = '';
        }

        function closeManualOrderModal() {
            document.getElementById('manual-order-modal').style.display = 'none';
        }

        function filterManualProducts() {
            const term = document.getElementById('manual-search').value.toLowerCase();
            const resultsDiv = document.getElementById('manual-products-results');
            
            if (!term) {
                resultsDiv.style.display = 'none';
                return;
            }

            const filtered = window.allProductsGlobal.filter(p => p.name.ar.toLowerCase().includes(term));
            
            resultsDiv.innerHTML = '';
            if (filtered.length > 0) {
                resultsDiv.style.display = 'block';
                filtered.forEach(p => {
                    const price = p.sizes && p.sizes.length > 0 ? p.sizes[0].price : p.price;
                    const name = p.name.ar;
                    const pData = encodeURIComponent(JSON.stringify(p));
                    
                    const div = document.createElement('div');
                    div.style.padding = '10px';
                    div.style.borderBottom = '1px solid #eee';
                    div.style.cursor = 'pointer';
                    div.innerHTML = `<b>${name}</b> - <small>${price} ج.م</small>`;
                    div.onclick = () => selectManualProduct(pData);
                    resultsDiv.appendChild(div);
                });
            } else {
                resultsDiv.style.display = 'none';
            }
        }

        function selectManualProduct(pData) {
            const product = JSON.parse(decodeURIComponent(pData));
            document.getElementById('manual-products-results').style.display = 'none';
            document.getElementById('manual-search').value = '';

            let finalPrice = product.price;
            let finalName = product.name.ar;

            if (product.sizes && product.sizes.length > 0) {
                finalPrice = product.sizes[0].price;
                finalName += ` (${product.sizes[0].name})`;
            }

            const existing = manualCart.find(item => item.id === product._id && item.name === finalName);
            if (existing) {
                existing.qty++;
            } else {
                manualCart.push({
                    id: product._id,
                    name: finalName,
                    price: finalPrice,
                    qty: 1
                });
            }
            renderManualCart();
        }

        function renderManualCart() {
            const tbody = document.getElementById('manual-cart-list');
            tbody.innerHTML = '';
            let subtotal = 0;

            manualCart.forEach((item, index) => {
                const total = item.price * item.qty;
                subtotal += total;
                tbody.innerHTML += `
                    <tr>
                        <td>${item.name}</td>
                        <td>${item.price}</td>
                        <td style="display:flex; gap:5px; align-items:center;">
                            <button onclick="updateManualQty(${index}, 1)" class="btn btn-outline" style="padding:2px 8px;">+</button>
                            <span>${item.qty}</span>
                            <button onclick="updateManualQty(${index}, -1)" class="btn btn-outline" style="padding:2px 8px;">-</button>
                        </td>
                        <td>${total}</td>
                        <td><button onclick="removeFromManualCart(${index})" style="color:red; border:none; background:none; cursor:pointer;"><i class="fas fa-trash"></i></button></td>
                    </tr>
                `;
            });

            const taxRate = parseFloat(document.getElementById('set-taxRate').value) || 0;
            const serviceRate = parseFloat(document.getElementById('set-serviceRate').value) || 0;

            const taxVal = (subtotal * taxRate) / 100;
            const serviceVal = (subtotal * serviceRate) / 100;
            const finalTotal = subtotal + taxVal + serviceVal;

            document.getElementById('manual-subtotal').innerText = subtotal.toFixed(2);
            document.getElementById('manual-tax-serv').innerText = (taxVal + serviceVal).toFixed(2);
            document.getElementById('manual-final').innerText = finalTotal.toFixed(2);
        }

        function updateManualQty(index, change) {
            manualCart[index].qty += change;
            if (manualCart[index].qty <= 0) manualCart.splice(index, 1);
            renderManualCart();
        }

        function removeFromManualCart(index) {
            manualCart.splice(index, 1);
            renderManualCart();
        }

        async function submitManualOrder() {
            if (manualCart.length === 0) return Swal.fire('تنبيه', 'السلة فارغة', 'warning');

            const tableNum = document.getElementById('manual-table').value || 'تيك أواي';
            const rId = document.getElementById('restaurant-id').value;

            const subTotal = parseFloat(document.getElementById('manual-subtotal').innerText);
            const taxServ = parseFloat(document.getElementById('manual-tax-serv').innerText);
            const finalTotal = parseFloat(document.getElementById('manual-final').innerText);

            const taxRate = parseFloat(document.getElementById('set-taxRate').value) || 0;
            const serviceRate = parseFloat(document.getElementById('set-serviceRate').value) || 0;
            
            const taxAmount = (subTotal * taxRate) / 100;
            const serviceAmount = (subTotal * serviceRate) / 100;

            const items = manualCart.map(i => ({
                name: i.name,
                qty: i.qty,
                price: i.price
            }));

            const body = {
                restaurantId: rId,
                tableNumber: tableNum,
                items: items,
                subTotal: subTotal,
                taxAmount: taxAmount,
                serviceAmount: serviceAmount,
                couponCode: null,
                discountAmount: 0,
                totalPrice: finalTotal
            };

            Swal.showLoading();
            try {
                const res = await fetch('/api/v1/orders', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });
                
                const data = await res.json();
                
                if (data.status === 'success') {
                    Swal.fire({ icon: 'success', title: 'تم إنشاء الطلب', timer: 1500, showConfirmButton: false });
                    closeManualOrderModal();
                    loadOrders();
                } else {
                    Swal.fire('خطأ', data.message, 'error');
                }
            } catch (e) {
                console.error(e);
                Swal.fire('خطأ', 'فشل الاتصال', 'error');
            }
        }
    </script>

    <div class="mobile-bottom-nav">
    <div class="nav-icon active" onclick="switchView('orders')" id="mob-nav-orders">
        <i class="fas fa-bell"></i>
        <span>الطلبات</span>
        <span id="mob-badge" class="hidden" style="position:absolute; top:5px; right:30%; width:8px; height:8px; background:red; border-radius:50%;"></span>
    </div>
    <div class="nav-icon" onclick="switchView('products')" id="mob-nav-products">
        <i class="fas fa-hamburger"></i>
        <span>المنتجات</span>
    </div>
    <div class="nav-icon" onclick="switchView('categories')" id="mob-nav-categories">
        <i class="fas fa-layer-group"></i>
        <span>الأقسام</span>
    </div>
    <div class="nav-icon hidden" onclick="switchView('stock')" id="mob-nav-stock">
            <i class="fas fa-boxes"></i>
            <span>المخزن</span>
        </div>
    <div class="nav-icon" onclick="switchView('settings')" id="mob-nav-settings">
        <i class="fas fa-cog"></i>
        <span>الإعدادات</span>
    </div>
    <div class="nav-icon" onclick="toggleSidebar()">
        <i class="fas fa-bars"></i>
        <span>المزيد</span>
    </div>
</div>
  </body>
</html>