<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Super Admin | Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@200;300;400;500;700;800;900&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="/socket.io/socket.io.js"></script> 
    <script>
        // --- FIX ADDED HERE ---
        // This ID must match the one defined in server.js
        const SUPER_ADMIN_ID = "000000000000000000000000"; 

        const superToken = localStorage.getItem('superAdminToken');
        if (!superToken) {
            window.location.href = '/login';
        }
    </script>

    <style>
        :root {
            /* Palette: Deep Luxury Space */
            --bg-dark: #0f1115;
            --bg-panel: rgba(30, 35, 45, 0.7);
            --primary: #d4af37; /* Royal Gold */
            --primary-glow: rgba(212, 175, 55, 0.4);
            --text-main: #ffffff;
            --text-muted: #9ca3af;
            --glass-border: rgba(255, 255, 255, 0.08);
            
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;

            --radius-xl: 24px;
            --radius-md: 16px;
            
            --transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        * {
            box-sizing: border-box;
            outline: none;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Tajawal', sans-serif;
            background-color: var(--bg-dark);
            background-image: 
                radial-gradient(circle at 10% 20%, rgba(212, 175, 55, 0.05) 0%, transparent 40%),
                radial-gradient(circle at 90% 80%, rgba(60, 80, 100, 0.1) 0%, transparent 40%);
            color: var(--text-main);
            margin: 0;
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        /* --- Scrollbar --- */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--primary); }

        /* --- Sidebar --- */
        .sidebar {
            width: 280px;
            background: var(--bg-panel);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-left: 1px solid var(--glass-border);
            display: flex;
            flex-direction: column;
            padding: 24px;
            transition: var(--transition);
            z-index: 100;
            box-shadow: 0 0 40px rgba(0,0,0,0.2);
        }

        .brand {
            font-size: 26px;
            font-weight: 900;
            background: linear-gradient(135deg, #fff 20%, var(--primary) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 40px;
            display: flex;
            align-items: center;
            gap: 15px;
            letter-spacing: -0.5px;
        }

        .nav-btn {
            background: transparent;
            border: none;
            width: 100%;
            text-align: right;
            padding: 14px 20px;
            border-radius: var(--radius-md);
            cursor: pointer;
            font-family: inherit;
            font-size: 15px;
            font-weight: 500;
            color: var(--text-muted);
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 8px;
            transition: var(--transition);
            position: relative;
            overflow: hidden;
        }

        .nav-btn:hover {
            background: rgba(255, 255, 255, 0.05);
            color: #fff;
        }

        .nav-btn.active {
            background: linear-gradient(90deg, rgba(212, 175, 55, 0.15), transparent);
            color: var(--primary);
            border-right: 3px solid var(--primary);
            font-weight: 700;
        }
        
        .nav-btn.active i {
            text-shadow: 0 0 15px var(--primary);
        }

        /* --- Main Content --- */
        .main {
            flex: 1;
            padding: 30px 40px;
            overflow-y: auto;
            position: relative;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            margin-bottom: 40px;
        }

        .page-title h2 {
            margin: 0;
            font-size: 32px;
            font-weight: 800;
            color: #fff;
        }
        .page-title p {
            color: var(--primary);
            margin: 5px 0 0 0;
            font-size: 14px;
            opacity: 0.8;
        }

        /* --- Cards --- */
        .content-card {
            background: linear-gradient(160deg, rgba(255,255,255,0.05) 0%, rgba(255,255,255,0.01) 100%);
            backdrop-filter: blur(20px);
            padding: 35px;
            border-radius: var(--radius-xl);
            border: 1px solid var(--glass-border);
            box-shadow: 0 20px 50px rgba(0,0,0,0.3);
            max-width: 900px;
            margin-bottom: 30px;
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- Forms --- */
        .form-group { margin-bottom: 20px; }
        .label { display: block; margin-bottom: 10px; font-size: 13px; font-weight: 600; color: var(--text-muted); }
        
        input, select {
            width: 100%;
            padding: 16px;
            background: rgba(0,0,0,0.3);
            border: 1px solid var(--glass-border);
            border-radius: 14px;
            font-family: inherit;
            outline: none;
            color: #fff;
            transition: var(--transition);
        }
        
        input:focus, select:focus {
            border-color: var(--primary);
            background: rgba(0,0,0,0.5);
            box-shadow: 0 0 0 4px rgba(212, 175, 55, 0.1);
        }

        input[type="file"] {
            padding: 12px;
            background: rgba(255,255,255,0.05);
            border: 1px dashed var(--glass-border);
            cursor: pointer;
        }

        /* --- Buttons --- */
        .btn-primary {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, var(--primary), #966f1e);
            color: #000;
            border: none;
            border-radius: 14px;
            font-size: 16px;
            font-weight: 800;
            cursor: pointer;
            transition: var(--transition);
            box-shadow: 0 10px 20px rgba(212, 175, 55, 0.15);
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 15px 30px rgba(212, 175, 55, 0.3);
            color: #fff;
        }

        /* --- Tables --- */
        table { width: 100%; border-collapse: separate; border-spacing: 0 12px; }
        
        th {
            background: transparent;
            padding: 0 20px 10px;
            text-align: right;
            color: var(--text-muted);
            font-size: 12px;
            font-weight: 700;
            border: none;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        tbody tr {
            background: rgba(255,255,255,0.03);
            transition: var(--transition);
        }

        tbody tr:hover {
            transform: scale(1.01);
            background: rgba(255,255,255,0.06);
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
        }

        td {
            padding: 20px;
            border-top: 1px solid var(--glass-border);
            border-bottom: 1px solid var(--glass-border);
            color: #fff;
            vertical-align: middle;
        }

        td:first-child { border-right: 1px solid var(--glass-border); border-top-right-radius: 16px; border-bottom-right-radius: 16px; }
        td:last-child { border-left: 1px solid var(--glass-border); border-top-left-radius: 16px; border-bottom-left-radius: 16px; }

        /* --- Action Buttons --- */
        .action-btn { border: none; padding: 8px 14px; border-radius: 10px; cursor: pointer; font-size: 13px; margin-left: 5px; color: white; transition: 0.2s; display: inline-flex; align-items: center; gap: 6px; font-weight: 600; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .btn-edit { background: rgba(245, 158, 11, 0.2); color: #fbbf24; border: 1px solid rgba(245, 158, 11, 0.3); } 
        .btn-edit:hover { background: #fbbf24; color: #000; }
        
        .btn-qr { background: rgba(16, 185, 129, 0.2); color: #34d399; border: 1px solid rgba(16, 185, 129, 0.3); } 
        .btn-qr:hover { background: #34d399; color: #000; }
        
        .btn-login-as { background: rgba(99, 102, 241, 0.2); color: #818cf8; border: 1px solid rgba(99, 102, 241, 0.3); } 
        .btn-login-as:hover { background: #818cf8; color: #fff; }

        /* --- Modals & Utilities --- */
        .login-wrapper { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); backdrop-filter: blur(10px); z-index: 2000; display: flex; align-items: center; justify-content: center; }
        .login-box { 
            background: var(--bg-dark); 
            border: 1px solid var(--glass-border);
            padding: 40px; 
            border-radius: var(--radius-xl); 
            width: 90%; 
            max-width: 500px; 
            text-align: center; 
            box-shadow: 0 25px 50px rgba(0,0,0,0.5); 
        }

        .hidden { display: none !important; }
        
        .slug-badge {
            background: rgba(255,255,255,0.1);
            padding: 4px 10px;
            border-radius: 8px;
            font-family: monospace;
            font-size: 13px;
            color: var(--primary);
            border: 1px solid rgba(212, 175, 55, 0.2);
        }

        /* --- SweetAlert Customization for Dark Theme --- */
        div:where(.swal2-container) div:where(.swal2-popup) {
            background: #1a1d24 !important;
            border: 1px solid var(--glass-border);
            color: #fff !important;
            border-radius: 20px !important;
        }
        div:where(.swal2-container) input.swal2-input, 
        div:where(.swal2-container) select.swal2-input {
            background: rgba(0,0,0,0.4) !important;
            color: #fff !important;
            border: 1px solid var(--glass-border) !important;
            margin: 10px auto !important; 
            width: 80% !important;
        }
        div:where(.swal2-container) h2.swal2-title { color: var(--primary) !important; }
        div:where(.swal2-container) div:where(.swal2-html-container) { color: #ccc !important; }

        /* --- Responsive --- */
        @media (max-width: 768px) {
            body { flex-direction: column; height: auto; overflow: auto; padding-bottom: 80px; }
            .sidebar { 
                position: fixed; bottom: 0; left: 0; width: 100%; height: 70px; 
                flex-direction: row; padding: 10px; justify-content: space-around;
                border-left: none; border-top: 1px solid var(--glass-border);
                background: rgba(15, 17, 21, 0.95);
            }
            .brand, .nav-btn span, .logout-btn span { display: none; }
            .nav-btn { width: auto; padding: 10px; margin: 0; justify-content: center; border-radius: 50%; width: 50px; height: 50px; }
            .nav-btn.active { border-right: none; background: var(--primary); color: #000; box-shadow: 0 0 15px var(--primary); }
            .main { padding: 20px; }
            .header { flex-direction: column; align-items: flex-start; gap: 20px; }
        }
    </style>
</head>
<body>
    <div class="sidebar">
        <div class="brand"><i class="fas fa-layer-group" style="color: var(--primary)"></i> Super Admin</div>
        <button class="nav-btn active" onclick="switchTab('owners')" id="btn-owners"><i class="fas fa-user-plus"></i> <span>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù„Ø§Ùƒ</span></button>
        <button class="nav-btn" onclick="switchTab('restaurants')" id="btn-restaurants"><i class="fas fa-store"></i> <span>Ø¥Ù†Ø´Ø§Ø¡ Ù…ØªØ¬Ø±</span></button>
        <button class="nav-btn" onclick="switchTab('ai-upload')" id="btn-ai-upload"><i class="fas fa-magic"></i> <span>Ø±ÙØ¹ Ø¨Ø§Ù„Ø°ÙƒØ§Ø¡ AI</span></button>
        <button class="nav-btn" onclick="switchTab('sales-stats')" id="btn-sales-stats"><i class="fas fa-chart-pie"></i> <span>Ø£Ø¯Ø§Ø¡ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</span></button>
        <button class="nav-btn" onclick="switchTab('sales-agents')" id="btn-sales-agents"><i class="fas fa-users"></i> <span>Ø§Ù„ÙˆÙƒÙ„Ø§Ø¡ ÙˆØ§Ù„Ø·Ù„Ø¨Ø§Øª</span></button>
        <button class="nav-btn" onclick="switchTab('requests')" id="btn-requests">
            <i class="fas fa-bell"></i> <span>Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù…</span> 
            <span id="req-badge" style="background:var(--danger); color:white; font-size:10px; padding:2px 6px; border-radius:10px; display:none; margin-right:5px;">New</span>
        </button>
        
        <div style="margin-top:auto">
            <button class="nav-btn logout-btn" onclick="logoutSuperAdmin()" style="color:var(--danger)"><i class="fas fa-sign-out-alt"></i> <span>Ø®Ø±ÙˆØ¬</span></button>
        </div>
    </div>

    <div class="main">
        <div class="header">
            <div class="page-title">
                <h2>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù†Ø¸Ø§Ù…</h2>
                <p>Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„ÙƒØ§Ù…Ù„ ÙÙŠ Ø§Ù„Ù…Ù„Ø§ÙƒØŒ Ø§Ù„Ù…ØªØ§Ø¬Ø±ØŒ ÙˆØ§Ù„Ø§Ø´ØªØ±Ø§ÙƒØ§Øª</p>
            </div>
            <div>
                <button id="enable-push-btn" onclick="subscribeUser()" class="action-btn" style="background:#6366f1; padding:12px 25px; font-size:14px; display:none;">
                    <i class="fas fa-bell"></i> ØªÙØ¹ÙŠÙ„ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ø¬Ù‡Ø§Ø²
                </button>
            </div>
        </div>

        <div id="tab-owners">
            <div class="content-card">
                <h3 style="margin-top:0; margin-bottom:25px; color:var(--primary); font-size: 20px;"><i class="fas fa-plus-circle"></i> Ø¥Ø¶Ø§ÙØ© Ù…Ø§Ù„Ùƒ Ø¬Ø¯ÙŠØ¯</h3>
    
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
                    <div class="form-group">
                        <label class="label">Ø§Ù„Ø§Ø³Ù…</label>
                        <input type="text" id="u-name" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„" autocomplete="off" name="new_owner_name_field_random">
                    </div>
                    <div class="form-group">
                        <label class="label">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</label>
                        <input type="text" id="u-phone" oninput="this.value = this.value.replace(/[^0-9]/g, '')" placeholder="01xxxxxxxxx">
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
                    <div class="form-group">
                        <label class="label">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label>
                        <input type="email" id="u-email" placeholder="email@example.com">
                    </div>
                    <div class="form-group">
                        <label class="label">ØªØ§Ø±ÙŠØ® Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ</label>
                        <input type="date" id="u-date" style="color-scheme: dark;">
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
                    <div class="form-group">
                        <label class="label">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
                        <input type="password" id="u-pass" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" autocomplete="new-password">
                    </div>
                    <div class="form-group">
                        <label class="label">ØªØ£ÙƒÙŠØ¯ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
                        <input type="password" id="u-pass-conf" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" autocomplete="new-password">
                    </div>
                </div>
    
                <div class="form-group" style="margin-top: 15px; background: rgba(99, 102, 241, 0.1); padding: 15px; border-radius: 12px; border: 1px solid rgba(99, 102, 241, 0.3);">
                    <label style="display: flex; align-items: center; gap: 10px; cursor: pointer; margin: 0; color: #fff;">
                        <input type="checkbox" id="u-stock" style="width: 20px; height: 20px;">
                        <span>ØªÙØ¹ÙŠÙ„ Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø®Ø§Ø²Ù† ÙˆØ§Ù„Ø¬Ø±Ø¯ (Stock System)</span>
                    </label>
                </div>

                <div class="form-group" style="margin-top: 10px;">
                    <label class="label">Ø¨Ø§Ù‚Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù…Ø³Ù…ÙˆØ­Ø©</label>
                    <select id="u-limit" style="font-weight:bold; color:var(--primary);">
                        <option value="75">Ø¨Ø§Ù‚Ø© ØµØºØ±Ù‰ (75 Ù…Ù†ØªØ¬)</option>
                        <option value="120">Ø¨Ø§Ù‚Ø© ÙˆØ³Ø·Ù‰ (120 Ù…Ù†ØªØ¬)</option>
                        <option value="200">Ø¨Ø§Ù‚Ø© ÙƒØ¨Ø±Ù‰ (200 Ù…Ù†ØªØ¬)</option>
                        <option value="-1">Ø¨Ø§Ù‚Ø© Ù…ÙØªÙˆØ­Ø© (Unlimited)</option>
                    </select>
                </div>

                <div style="margin-top: 25px;">
                    <button class="btn-primary" onclick="createOwner()">Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¢Ù†</button>
                </div>
            </div>

            <div class="content-card" style="max-width: 100%;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; flex-wrap: wrap; gap:15px;">
                    <h3 style="color:var(--text-main); margin:0;">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù„Ø§Ùƒ Ø§Ù„Ù…Ø³Ø¬Ù„ÙŠÙ†</h3>
                    <div style="position:relative; width: 300px;">
                        <input type="text" id="owner-table-search" onkeyup="filterTable('owners-tbody', 'owner-table-search')" placeholder="Ø¨Ø­Ø« Ø³Ø±ÙŠØ¹..." style="padding-right: 40px;">
                        <i class="fas fa-search" style="position:absolute; top:18px; right:15px; color:var(--text-muted);"></i>
                    </div>
                </div>
                
                <div style="overflow-x:auto;">
                    <table>
                        <thead>
                            <tr>
                                <th>Ø§Ù„Ø§Ø³Ù…</th>
                                <th>Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø§ØªØµØ§Ù„</th>
                                <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                            </tr>
                        </thead>
                        <tbody id="owners-tbody">
                            </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="tab-restaurants" class="hidden">
            <div class="content-card">
                <h3 style="margin-top:0; margin-bottom:25px; color:var(--primary)">Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù†Ø´Ø§Ø· (Ù…Ø·Ø¹Ù…/ÙƒØ§ÙÙŠÙ‡)</h3>
                <div class="form-group">
                    <label class="label">Ø§Ø³Ù… Ø§Ù„Ù†Ø´Ø§Ø·</label>
                    <input type="text" id="r-name" onkeyup="generateSlug()" placeholder="Ù…Ø«Ø§Ù„: Ù…Ø·Ø¹Ù… Ø§Ù„Ø¨Ø±ÙƒØ©">
                </div>
                <div class="form-group">
                    <label class="label">Ø§Ù„Ø±Ø§Ø¨Ø· (Slug)</label>
                    <input type="text" id="r-slug" readonly style="background:rgba(255,255,255,0.05); color:var(--text-muted)">
                </div>
                <div class="form-group">
                    <label class="label">ØµÙˆØ±Ø© Ø§Ù„ØºÙ„Ø§Ù</label>
                    <input type="file" id="r-cover">
                </div>
                <div class="form-group">
                    <label class="label">Ø§Ù„Ù…Ø§Ù„Ùƒ Ø§Ù„Ù…Ø®ØªØ§Ø±</label>
                    <div style="display: flex; gap: 10px;">
                        <input type="text" id="selected-owner-name" readonly placeholder="Ø§Ø¶ØºØ· Ù„Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø§Ù„Ùƒ..." style="background: rgba(255,255,255,0.05); flex: 1; cursor: pointer;" onclick="openOwnerModal()">
                        <input type="hidden" id="r-owner"> 
                        <button class="btn-primary" onclick="openOwnerModal()" style="width: auto; padding: 0 25px; background: var(--text-muted); color: #000;">Ø§Ø®ØªÙŠØ§Ø±</button>
                    </div>
                </div>
                <button class="btn-primary" onclick="createRestaurant()">Ø¥Ø·Ù„Ø§Ù‚ Ø§Ù„Ù…Ø·Ø¹Ù…</button>
            </div>

            <div class="content-card" style="max-width: 100%;">
                <h3 style="color:var(--text-main); margin-top:0;">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ØªØ§Ø¬Ø± Ø§Ù„Ù…Ø³Ø¬Ù„Ø©</h3>
                <div style="margin-bottom:20px; position:relative;">
                    <input type="text" id="res-table-search" onkeyup="filterTable('restaurants-tbody', 'res-table-search')" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ø³Ù… Ø§Ù„Ù†Ø´Ø§Ø·ØŒ Ø§Ù„Ù…Ø§Ù„ÙƒØŒ Ø£Ùˆ Ø§Ù„Ø±Ø§Ø¨Ø· (Slug)...">
                    <i class="fas fa-search" style="position:absolute; top:18px; left:15px; color:var(--text-muted);"></i>
                </div>
                <div style="overflow-x:auto;">
                    <table>
                       <thead>
                            <tr>
                                <th style="width: 25%;">Ø§Ù„Ù…Ø·Ø¹Ù…</th>
                                <th style="width: 20%;">Ø§Ù„Ù…Ø§Ù„Ùƒ</th>
                                <th style="width: 20%; text-align: center;">Ø§Ù„Ø±Ø§Ø¨Ø· (Slug)</th>
                                <th style="width: 15%; text-align: center;">QR Ø§Ù„Ù…Ø­ÙÙˆØ¸</th>
                                <th style="width: 20%; text-align: left; padding-left: 20px;">Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                            </tr>
                        </thead>
                        <tbody id="restaurants-tbody">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="tab-ai-upload" class="hidden">
            <div class="content-card">
                <h3 style="color:var(--primary); display:flex; align-items:center; gap:10px;"><i class="fas fa-magic"></i> Ø³Ø­Ø± Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ</h3>
                <p style="color:var(--text-muted); margin-bottom:20px;">Ø§Ø±ÙØ¹ ØµÙˆØ± Ø§Ù„Ù…Ù†ÙŠÙˆ ÙˆØ³Ù†Ù‚ÙˆÙ… Ø¨ØªØµÙ†ÙŠÙÙ‡Ø§ ÙˆØ±ÙØ¹Ù‡Ø§ Ø¨Ø¯Ù„Ø§Ù‹ Ø¹Ù†Ùƒ.</p>
                
                <div class="form-group">
                    <label class="label">Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø·Ø¹Ù… Ø§Ù„Ù…Ø³ØªÙ‡Ø¯Ù</label>
                    <div style="display: flex; gap: 10px;">
                        <input type="text" id="ai-res-name" readonly placeholder="Ø§Ø¶ØºØ· Ù„Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø·Ø¹Ù…..." 
                               style="background: rgba(255,255,255,0.05); flex: 1; cursor: pointer;" onclick="openOwnerModalForAI()">
                        <input type="hidden" id="ai-res-id">
                    </div>
                </div>

                <div class="form-group">
                    <label class="label">ØµÙˆØ± Ø§Ù„Ù…Ù†ÙŠÙˆ (ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ø®ØªÙŠØ§Ø± Ø£ÙƒØ«Ø± Ù…Ù† ØµÙˆØ±Ø©)</label>
                    <input type="file" id="ai-menu-images" multiple accept="image/*" 
                           style="padding:25px; border:2px dashed var(--primary); width:100%; text-align:center;">
                </div>

                <button class="btn-primary" id="start-ai-btn" onclick="startAiProcessing()">
                    Ø§Ø¨Ø¯Ø£ Ø§Ù„ØªØ­Ù„ÙŠÙ„ ÙˆØ§Ù„Ø±ÙØ¹ Ø§Ù„ØµØ§Ø±ÙˆØ®ÙŠ ğŸš€
                </button>
            </div>
        </div>

        <div id="tab-sales-stats" class="hidden">
            <div class="content-card">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                    <h3 style="color:var(--primary); margin:0;">ğŸ“Š Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª ÙˆØ£Ø¯Ø§Ø¡ Ø§Ù„ÙØ±ÙŠÙ‚</h3>
                    <button class="action-btn" onclick="loadSalesStats()" style="background: rgba(255,255,255,0.1); border: 1px solid var(--glass-border); color: #fff;">
                        <i class="fas fa-sync"></i> ØªØ­Ø¯ÙŠØ«
                    </button>
                </div>
                <div id="salesGrid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px;"></div>
            </div>
            
            <div id="salesDetailsModal" class="login-wrapper hidden" style="display:none;">
                <div class="login-box" style="width:650px; max-width:95%; height:80vh; overflow-y:auto; text-align:right;">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; border-bottom:1px solid var(--glass-border); padding-bottom:15px;">
                        <h3 id="detailTitle" style="margin:0; color:var(--primary);">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</h3>
                        <button onclick="document.getElementById('salesDetailsModal').style.display='none'" style="background:transparent; border:none; color:#fff; font-size:24px; cursor:pointer;">&times;</button>
                    </div>
                    <div id="clientsListContent"></div>
                </div>
            </div>
        </div>

        <div id="tab-sales-agents" class="hidden">
            <div id="createSalesModal" class="login-wrapper hidden" style="display:none;">
                <div class="login-box" style="width:400px;">
                    <h3 style="color:var(--primary); margin-top:0; margin-bottom:20px;">âœ¨ ØªØ³Ø¬ÙŠÙ„ Ù…ÙˆØ¸Ù Ø¬Ø¯ÙŠØ¯</h3>
                    <input type="text" id="salesName" placeholder="Ø§Ù„Ø§Ø³Ù… Ø¨Ø§Ù„ÙƒØ§Ù…Ù„" style="margin-bottom:10px;">
                    <input type="email" id="salesEmail" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ" style="margin-bottom:10px;">
                    <input type="text" id="salesPhone" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ" style="margin-bottom:10px;">
                    <input type="password" id="salesPass" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" style="margin-bottom:20px;">
                    <div style="display:flex; justify-content:space-between; gap:10px;">
                        <button onclick="createSalesAgent()" class="btn-primary" style="flex:1;">Ø­ÙØ¸</button>
                        <button onclick="document.getElementById('createSalesModal').style.display='none'" style="flex:1; background:rgba(255,255,255,0.1); border:none; padding:12px; border-radius:12px; cursor:pointer; color:#fff;">Ø¥Ù„ØºØ§Ø¡</button>
                    </div>
                </div>
            </div>

            <div class="content-card" style="max-width: 100%;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap:wrap; gap:10px;">
                   
                    <button class="action-btn" onclick="loadSalesRequests()" style="background: rgba(255,255,255,0.1); padding: 12px 20px;">
                        <i class="fas fa-sync"></i> ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
                    </button>
                </div>

                <h4 style="color:var(--text-muted); margin-bottom:15px;">ğŸ“‹ Ø§Ù„ÙˆÙƒÙ„Ø§Ø¡ ÙˆØ·Ù„Ø¨Ø§Øª Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù…</h4>
                
                <div style="margin-bottom: 15px; position: relative;">
                    <i class="fas fa-search" style="position: absolute; top: 18px; right: 15px; color: var(--text-muted);"></i>
                    <input type="text" id="sales-search-input" onkeyup="filterSalesTable()" 
                           placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ø³Ù… Ø§Ù„ÙˆÙƒÙŠÙ„ØŒ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙØŒ Ø£Ùˆ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ..." 
                           style="padding-right: 40px;">
                </div>
                <div style="overflow-x:auto;">
                    <table style="min-width: 100%;">
                        <thead>
                            <tr>
                                <th style="padding:15px;">Ø§Ù„ØµÙˆØ±Ø©</th>
                                <th style="padding:15px;">Ø§Ù„Ø§Ø³Ù…</th>
                                <th style="padding:15px;">Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø§ØªØµØ§Ù„</th>
                                <th style="padding:15px;">Ø§Ù„Ù…Ø­ÙØ¸Ø©</th>
                                <th style="padding:15px;">Ø§Ù„Ø­Ø§Ù„Ø©</th>
                                <th style="padding:15px;">Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡</th>
                            </tr>
                        </thead>
                        <tbody id="sales-tbody">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="tab-requests" class="hidden">
            <div class="content-card" style="max-width:100%">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 20px;">
                    <h3 style="color:var(--primary); margin:0;">Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©</h3>
                    <div style="display:flex; gap:10px;">
                        <button class="action-btn" onclick="deleteSelectedRequests()" style="background:var(--danger); display:none;" id="btn-delete-all">
                            <i class="fas fa-trash"></i> Ø­Ø°Ù Ø§Ù„Ù…Ø­Ø¯Ø¯
                        </button>
                        <button class="action-btn" onclick="loadRequests()" style="background:rgba(255,255,255,0.1)">
                            <i class="fas fa-sync"></i> ØªØ­Ø¯ÙŠØ«
                        </button>
                    </div>
                </div>
                <div style="overflow-x:auto;">
                    <table>
                        <thead>
                            <tr>
                                <th style="width: 40px; text-align: center;">
                                    <input type="checkbox" id="select-all-req" onchange="toggleSelectAll(this)" style="width:18px; height:18px;">
                                </th>
                                <th>Ø§Ù„Ø§Ø³Ù…</th>
                                <th>Ø§Ù„Ù…ØªØ¬Ø±</th>
                                <th>Ø§Ù„Ù‡Ø§ØªÙ</th>
                                <th>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</th>
                                <th>Ø§Ù„ØªÙˆÙ‚ÙŠØª</th>
                                <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡</th>
                            </tr>
                        </thead>
                        <tbody id="requests-tbody">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <audio id="notif-sound" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3" preload="auto"></audio>

    <div id="owner-modal" class="login-wrapper hidden">
        <div class="login-box" style="padding: 25px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 style="margin: 0; color: var(--primary);">Ø§Ø®ØªØ± Ù…Ø§Ù„Ùƒ Ø§Ù„Ù…Ø·Ø¹Ù…</h3>
                <button onclick="closeOwnerModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #fff;">&times;</button>
            </div>
            
            <div class="search-container" style="max-width: 100%; margin-bottom: 15px;">
                <input type="text" class="search-input" id="owner-search" onkeyup="filterOwners()" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù…ØŒ Ø§Ù„Ø±Ù‚Ù…ØŒ Ø£Ùˆ Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„..."/>
            </div>

            <div id="modal-owners-list" style="max-height: 300px; overflow-y: auto; text-align: right; border: 1px solid var(--glass-border); border-radius: 12px; background: rgba(0,0,0,0.2);">
            </div>
        </div>
    </div>

    <script>
       let token = localStorage.getItem('superAdminToken') || '';
        const socket = io();
        let hasUnsavedChanges = false; // Ù…ØªØºÙŠØ± Ù„ØªØªØ¨Ø¹ Ù‡Ù„ Ù‡Ù†Ø§Ùƒ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø¹Ù„Ù‚Ø© Ù„Ù… ØªØ­ÙØ¸

        // ØªÙØ¹ÙŠÙ„ Ø±Ø³Ø§Ù„Ø© ØªØ­Ø°ÙŠØ± Ø§Ù„Ù…ØªØµÙØ­ Ø§Ù„Ù‚ÙŠØ§Ø³ÙŠØ© Ø¹Ù†Ø¯ Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø®Ø±ÙˆØ¬ ÙˆÙÙŠ Ø¨ÙŠØ§Ù†Ø§Øª Ù…ÙƒØªÙˆØ¨Ø©
        window.addEventListener('beforeunload', (e) => {
            if (hasUnsavedChanges) {
                e.preventDefault();
                e.returnValue = ''; // Ù‡Ø°Ø§ Ø§Ù„Ø³Ø·Ø± Ø¶Ø±ÙˆØ±ÙŠ Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„ØªØ­Ø°ÙŠØ± ÙÙŠ ÙƒØ±ÙˆÙ… ÙˆØ¥ÙŠØ¯Ø¬
            }
        });

        document.addEventListener('DOMContentLoaded', () => {
            if (token) {
                // 1. ØªÙ†Ø¸ÙŠÙ Ø´Ø§Ù…Ù„ ÙˆÙÙˆØ±ÙŠ: Ù…Ø³Ø­ Ø£ÙŠ Ù†ØµÙˆØµ ÙÙŠ ÙƒÙ„ Ø§Ù„Ø­Ù‚ÙˆÙ„ (Ø´Ø§Ù…Ù„Ø© ØµÙØ­Ø© Ø§Ù„Ù…Ø§Ù„Ùƒ ÙˆØ§Ù„Ù…Ø·Ø¹Ù…)
                document.querySelectorAll('input:not([type="button"]):not([type="submit"]), textarea, select').forEach(el => {
                    if(el.type === 'checkbox' || el.type === 'radio') el.checked = false;
                    else el.value = '';
                    
                    // Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø­Ù‚Ù„: Ø¨Ù…Ø¬Ø±Ø¯ Ø§Ù„ÙƒØªØ§Ø¨Ø© ÙÙŠÙ‡ØŒ Ù†Ø¹ØªØ¨Ø± Ø£Ù† Ù‡Ù†Ø§Ùƒ ØªØºÙŠÙŠØ±Ø§Øª ØºÙŠØ± Ù…Ø­ÙÙˆØ¸Ø©
                    el.addEventListener('input', () => { hasUnsavedChanges = true; });
                    el.addEventListener('change', () => { hasUnsavedChanges = true; });
                });

                // 2. Ø§Ù„Ø°Ø§ÙƒØ±Ø© Ø§Ù„Ø°ÙƒÙŠØ©: ÙØªØ­ Ø¢Ø®Ø± ØªØ¨ÙˆÙŠØ¨ ÙƒÙ†Øª ÙˆØ§Ù‚ÙØ§Ù‹ Ø¹Ù„ÙŠÙ‡
                const lastTab = localStorage.getItem('activeTab') || 'owners';
                switchTab(lastTab);

                // 3. ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø®Ù„ÙÙŠØ©
                loadRequests();
                checkPushSubscription();
            } else {
                window.location.href = '/login';
            }
        });

        async function checkPushSubscription() {
            if ('serviceWorker' in navigator && 'PushManager' in window) {
                const reg = await navigator.serviceWorker.register('/sw.js');
                const sub = await reg.pushManager.getSubscription();
                if (!sub) {
                    document.getElementById('enable-push-btn').style.display = 'inline-block';
                }
            }
        }

        async function subscribeUser() {
            if ('serviceWorker' in navigator) {
                try {
                    const reg = await navigator.serviceWorker.register('/sw.js');
                    
                    const keyRes = await fetch('/api/v1/vapid-key');
                    const { publicKey } = await keyRes.json();
                    
                    const subscription = await reg.pushManager.subscribe({
                        userVisibleOnly: true,
                        applicationServerKey: urlBase64ToUint8Array(publicKey)
                    });

                    await fetch('/api/v1/subscribe', {
                        method: 'POST',
                        body: JSON.stringify(subscription),
                        headers: { 'Content-Type': 'application/json' }
                    });

                    Swal.fire('ØªÙ… Ø§Ù„ØªÙØ¹ÙŠÙ„', 'Ø³ØªØµÙ„Ùƒ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø­ØªÙ‰ Ù„Ùˆ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ù…ØºÙ„Ù‚!', 'success');
                    document.getElementById('enable-push-btn').style.display = 'none';
                } catch (err) {
                    console.error(err);
                    Swal.fire('Ø®Ø·Ø£', 'ÙØ´Ù„ ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª', 'error');
                }
            }
        }

        function urlBase64ToUint8Array(base64String) {
            const padding = '='.repeat((4 - base64String.length % 4) % 4);
            const base64 = (base64String + padding).replace(/-/g, '+').replace(/_/g, '/');
            const rawData = window.atob(base64);
            const outputArray = new Uint8Array(rawData.length);
            for (let i = 0; i < rawData.length; ++i) {
                outputArray[i] = rawData.charCodeAt(i);
            }
            return outputArray;
        }

        socket.on('new-menu-request', (data) => {
            const audio = document.getElementById('notif-sound');
            audio.play().catch(e => console.log('Audio play failed', e));

            if (Notification.permission === "granted") {
                new Notification("Ø·Ù„Ø¨ Ù…Ù†ÙŠÙˆ Ø¬Ø¯ÙŠØ¯! ğŸš€", {
                    body: `Ø§Ù„Ø¹Ù…ÙŠÙ„: ${data.name} - Ø§Ù„Ù…Ø·Ø¹Ù…: ${data.storeName}`,
                    icon: '/favicon.ico'
                });
            } else {
                Swal.fire({
                    position: 'top-end',
                    icon: 'info',
                    title: 'Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯!',
                    text: `${data.name} ÙŠØ±ÙŠØ¯ Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù…`,
                    showConfirmButton: false,
                    timer: 3000,
                    toast: true
                });
            }

            const badge = document.getElementById('req-badge');
            badge.style.display = 'inline-block';
            
            prependRequestRow(data);
        });

        async function loadRequests() {
            try {
                const res = await fetch('/api/v1/requests', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const response = await res.json();
                const tbody = document.getElementById('requests-tbody');
                tbody.innerHTML = '';
                
                response.data.forEach(req => {
                    prependRequestRow(req, false);
                });
            } catch(e) { console.error(e); }
        }

        function prependRequestRow(data, animate = true) {
            const tbody = document.getElementById('requests-tbody');
            const tr = document.createElement('tr');
            if(animate) tr.style.animation = "highlightRow 2s";
            
            const date = new Date(data.createdAt).toLocaleString('ar-EG');
            
            tr.innerHTML = `
                <td style="text-align: center;">
                    <input type="checkbox" class="req-checkbox" value="${data._id}" onchange="toggleDeleteButton()" style="width:18px; height:18px;">
                </td>
                <td style="font-weight:bold">${data.name}</td>
                <td style="color:var(--primary)">${data.storeName}</td>
                <td><a href="https://wa.me/20${data.phone}" target="_blank" style="text-decoration:none; color:#fff; display:flex; align-items:center; gap:5px;">${data.phone} <i class="fab fa-whatsapp" style="color:#25d366"></i></a></td>
                <td>${data.address}</td>
                <td style="font-size:12px; color:var(--text-muted)">${date}</td>
                <td>
                    <button class="action-btn" style="background:rgba(16, 185, 129, 0.2); color:#34d399; border:1px solid #34d399;" onclick="copyToClipboard('${data.name}', '${data.phone}')">
                        <i class="fas fa-copy"></i> Ù†Ø³Ø®
                    </button>
                </td>
            `;
            tbody.insertBefore(tr, tbody.firstChild);
        }

        function toggleSelectAll(source) {
            const checkboxes = document.querySelectorAll('.req-checkbox');
            checkboxes.forEach(cb => cb.checked = source.checked);
            toggleDeleteButton();
        }

        function toggleDeleteButton() {
            const checkedCount = document.querySelectorAll('.req-checkbox:checked').length;
            const btn = document.getElementById('btn-delete-all');
            if (checkedCount > 0) {
                btn.style.display = 'block';
                btn.innerHTML = `<i class="fas fa-trash"></i> Ø­Ø°Ù Ø§Ù„Ù…Ø­Ø¯Ø¯ (${checkedCount})`;
            } else {
                btn.style.display = 'none';
            }
        }

        async function deleteSelectedRequests() {
            const selected = Array.from(document.querySelectorAll('.req-checkbox:checked')).map(cb => cb.value);
            
            if (selected.length === 0) return;

            const confirm = await Swal.fire({
                title: 'Ø­Ø°Ù Ø§Ù„Ø·Ù„Ø¨Ø§ØªØŸ',
                text: `Ø³ÙŠØªÙ… Ø­Ø°Ù ${selected.length} Ø·Ù„Ø¨Ø§Øª Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#ef4444',
                confirmButtonText: 'Ù†Ø¹Ù…ØŒ Ø§Ø­Ø°Ù',
                cancelButtonText: 'Ø¥Ù„ØºØ§Ø¡'
            });

            if (confirm.isConfirmed) {
                try {
                    const res = await fetch('/api/v1/requests', {
                        method: 'DELETE',
                        headers: { 
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({ ids: selected })
                    });
                    
                    if (res.ok) {
                        Swal.fire('ØªÙ… Ø§Ù„Ø­Ø°Ù', 'ØªÙ… Ø­Ø°Ù Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©', 'success');
                        document.getElementById('select-all-req').checked = false;
                        document.getElementById('btn-delete-all').style.display = 'none';
                        loadRequests();
                    }
                } catch (e) {
                    Swal.fire('Ø®Ø·Ø£', 'ÙØ´Ù„ ÙÙŠ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø­Ø°Ù', 'error');
                }
            }
        }

        function copyToClipboard(name, phone) {
            navigator.clipboard.writeText(`Ø§Ù„Ø§Ø³Ù…: ${name}\nØ§Ù„Ù‡Ø§ØªÙ: ${phone}`);
            const Toast = Swal.mixin({ toast: true, position: 'top-end', showConfirmButton: false, timer: 2000 });
            Toast.fire({ icon: 'success', title: 'ØªÙ… Ù†Ø³Ø® Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª' });
        }

        async function createOwner() {
            const name = document.getElementById('u-name').value;
            const email = document.getElementById('u-email').value;
            const phone = document.getElementById('u-phone').value;
            const subscriptionExpires = document.getElementById('u-date').value; 
            const password = document.getElementById('u-pass').value;
            const passwordConfirm = document.getElementById('u-pass-conf').value;
            const productLimit = document.getElementById('u-limit').value;

            if(!name || !email || !password) return Swal.fire('ØªÙ†Ø¨ÙŠÙ‡', 'Ø§Ù…Ù„Ø£ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©', 'warning');
            
            try {
                Swal.showLoading();
                const res = await fetch('/api/v1/users/signup', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify({ 
                        name, 
                        email, 
                        phone, 
                        subscriptionExpires,
                        password, 
                        passwordConfirm, 
                        hasStock: document.getElementById('u-stock').checked,
                        productLimit: productLimit,
                        role: 'owner' 
                    })
                });
                const data = await res.json();
                Swal.close();

                if(data.status === 'success') {
                    hasUnsavedChanges = false; // ØªÙ… Ø§Ù„Ø­ÙØ¸ØŒ Ø§Ù„ØºÙ Ø§Ù„ØªØ­Ø°ÙŠØ±
                    Swal.fire('ØªÙ… Ø¨Ù†Ø¬Ø§Ø­', 'ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø§Ù„Ùƒ', 'success');
                    document.getElementById('u-name').value = '';
                    document.getElementById('u-email').value = '';
                    document.getElementById('u-phone').value = '';
                    document.getElementById('u-date').value = '';
                    document.getElementById('u-pass').value = '';
                    document.getElementById('u-pass-conf').value = '';
                    loadOwnersList(); 
                } else {
                    Swal.fire('ÙØ´Ù„Øª Ø§Ù„Ø¹Ù…Ù„ÙŠØ©', data.message || 'ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'error');
                }
            } catch(e) { Swal.fire('Ø®Ø·Ø£', 'Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„', 'error'); }
        }

        async function loadOwnersList() {
            try {
                const res = await fetch('/api/v1/users', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();

                if (data.status === 'success' && data.data && data.data.users) {
                    allOwners = data.data.users;
                    const tbody = document.getElementById('owners-tbody');
                    tbody.innerHTML = '';

                    data.data.users.forEach(u => {
                        if(u.role === 'admin' && u._id === SUPER_ADMIN_ID) return; // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø³ÙˆØ¨Ø± Ø£Ø¯Ù…Ù† Ù†ÙØ³Ù‡ ÙÙ‚Ø·

                        const isActive = u.active !== false; 
                        const statusIcon = isActive ? 'fa-user-check' : 'fa-user-slash';
                        const statusColor = isActive ? 'rgba(16, 185, 129, 0.2)' : 'rgba(239, 68, 68, 0.2)';
                        
                        // ØªØ¹ÙŠÙŠÙ† Ù„ÙˆÙ† ÙˆØ´ÙƒÙ„ Ø§Ù„Ù€ Badge Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø±ØªØ¨Ø©
                        let roleBadge = '';
                        if(u.role === 'owner') roleBadge = '<span style="background:rgba(212, 175, 55, 0.15); color:var(--primary); padding:2px 8px; border-radius:6px; font-size:11px; font-weight:bold; border:1px solid rgba(212, 175, 55, 0.3);">Ù…Ø§Ù„Ùƒ Ù…Ø·Ø¹Ù…</span>';
                        else if(u.role === 'sales') roleBadge = '<span style="background:rgba(99, 102, 241, 0.15); color:#818cf8; padding:2px 8px; border-radius:6px; font-size:11px; font-weight:bold; border:1px solid rgba(99, 102, 241, 0.3);">ÙˆÙƒÙŠÙ„ Ù…Ø¨ÙŠØ¹Ø§Øª</span>';
                        else roleBadge = `<span style="background:rgba(255,255,255,0.1); color:#fff; padding:2px 8px; border-radius:6px; font-size:11px;">${u.role}</span>`;

                        // Ø¥Ø¶Ø§ÙØ© Ø´Ø§Ø±Ø© "ØªØ¬Ø±ÙŠØ¨ÙŠ" Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø­Ø³Ø§Ø¨ Trial
                        let trialBadge = '';
                        if (u.isTrial) {
                            trialBadge = '<span style="background:rgba(245, 158, 11, 0.2); color:#fbbf24; padding:2px 6px; border-radius:6px; font-size:10px; font-weight:bold; border:1px solid rgba(245, 158, 11, 0.3); margin-right:5px;">ØªØ¬Ø±ÙŠØ¨ÙŠ â³</span>';
                        }

                        const expiryDate = u.subscriptionExpires ? u.subscriptionExpires.split('T')[0] : '';
                        const pLimit = u.productLimit || 75;

                        // ØªØ­Ø¯ÙŠØ¯ ÙˆØ¬Ù‡Ø© Ø²Ø± "Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙƒÙ€" Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø±ØªØ¨Ø©
                        const loginTarget = u.role === 'sales' ? '/sales-dashboard' : '/owner';

                        tbody.innerHTML += `
                            <tr>
                                <td style="font-weight:bold">
                                    ${u.name}
                                    <div style="margin-top:5px;">${roleBadge} ${trialBadge}</div>
                                </td>
                                <td>
                                    <div style="font-size:13px">${u.email}</div>
                                    <div style="font-size:12px; color:var(--text-muted)">
                                        ${u.phone || '---'} 
                                        ${u.role === 'owner' ? `| <span style="background:rgba(255,255,255,0.05); padding:1px 4px; border-radius:3px;">Ø¨Ø§Ù‚Ø©: ${pLimit == -1 ? 'âˆ' : pLimit}</span>` : ''}
                                    </div>
                                </td>
                                <td>
                                    <div style="display:flex; flex-wrap:wrap; gap:5px;">
                                        <button class="action-btn" style="background:${statusColor}; color:${isActive ? '#34d399' : '#f87171'}" onclick="toggleUserStatus('${u._id}')" title="ØªØºÙŠÙŠØ± Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø³Ø§Ø¨">
                                            <i class="fas ${statusIcon}"></i>
                                        </button>

                                        <button class="action-btn btn-edit" onclick="editUser('${u._id}', '${u.name}', '${u.email}', '${u.phone || ''}', '${u.whatsapp || ''}', '${expiryDate}', '${pLimit}', ${u.hasStock}, ${u.isTrial})">
                                            <i class="fas fa-edit"></i>
                                        </button>

                                        <button class="action-btn" style="background:rgba(16, 185, 129, 0.2); color:#34d399; border: 1px solid rgba(16, 185, 129, 0.3);" onclick="generateQRPopup('${u.name}')" title="Ø¥Ù†Ø´Ø§Ø¡ QR Code">
                                            <i class="fas fa-qrcode"></i>
                                        </button>

                                        <button class="action-btn btn-login-as" onclick="loginAsAny('${u._id}', '${loginTarget}')" title="Ø¯Ø®ÙˆÙ„ ÙƒÙ€ ${u.role}">
                                            <i class="fas ${u.role === 'sales' ? 'fa-user-tie' : 'fa-utensils'}"></i>
                                        </button>

                                        <button class="action-btn" style="background:rgba(239, 68, 68, 0.2); color:#f87171; border: 1px solid rgba(239, 68, 68, 0.3);" onclick="deleteUser('${u._id}')" title="Ø­Ø°Ù Ù†Ù‡Ø§Ø¦ÙŠ">
                                            <i class="fas fa-trash"></i>
                                        </button>

                                        <button class="action-btn" style="background:rgba(147, 51, 234, 0.2); color:#d8b4fe; border: 1px solid rgba(147, 51, 234, 0.3);" onclick="changePasswordPrompt('${u._id}', '${u.name}')" title="ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
                                            <i class="fas fa-key"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        `;
                    });
                } else {
                    console.error('ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ø§Ùƒ:', data);
                    if (res.status === 401 || data.message === 'jwt malformed') {
                        localStorage.removeItem('superAdminToken');
                        window.location.href = '/login';
                    }
                }
            } catch(e) { console.error('Error loading owners:', e); }
        }

        async function loadRestaurantsList() {
            try {
                const res = await fetch('/api/v1/restaurants', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();
                const tbody = document.getElementById('restaurants-tbody');
                tbody.innerHTML = '';

                if (data.status === 'success') {
                    const restaurants = data.data.restaurants || data.data; 
                    restaurants.forEach(r => {
                        const qrPreview = r.qrImage ? 
                            `<img src="${r.qrImage}" style="width:40px; height:40px; border-radius:8px; cursor:pointer; border:1px solid var(--glass-border);" onclick="viewSavedQR('${r.qrImage}', '${r.qrName}')" title="${r.qrName}">` 
                            : '<span style="color:var(--text-muted); font-size:12px;">Ù„Ø§ ÙŠÙˆØ¬Ø¯</span>';

                        tbody.innerHTML += `
                            <tr>
                                <td style="font-weight:bold; color:var(--primary);">${r.restaurantName}</td>
                                <td>${r.owner ? r.owner.name : 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</td>
                                <td style="text-align:center;"><span class="slug-badge">${r.slug}</span></td>
                                <td style="text-align:center;">${qrPreview}</td> 
                                <td style="text-align: left; white-space: nowrap;">
                                    <div style="display:flex; gap:5px;">
                                        <button class="action-btn btn-edit" onclick="editRestaurantPrompt('${r._id}')">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        
                                        <button class="action-btn" style="background:rgba(59, 130, 246, 0.2); color:#60a5fa; border:1px solid rgba(59, 130, 246, 0.3)" onclick="downloadSavedQR('${r.qrImage}', '${r.slug}')" title="ØªØ­Ù…ÙŠÙ„ QR">
                                            <i class="fas fa-download"></i>
                                        </button>

                                        <button class="action-btn" style="background:rgba(239, 68, 68, 0.2); color:#f87171; border:1px solid rgba(239, 68, 68, 0.3)" onclick="deleteRestaurant('${r._id}')">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        `;
                    });
                }
            } catch (e) { console.error("Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø·Ø§Ø¹Ù…:", e); }
        }

        async function deleteRestaurant(id) {
            const confirm = await Swal.fire({
                title: 'Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ',
                text: "Ø³ÙŠØªÙ… Ø­Ø°Ù Ø§Ù„Ù…ØªØ¬Ø± ÙˆØ¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ù‚Ø³Ø§Ù… ÙˆØ§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„ØªØ§Ø¨Ø¹Ø© Ù„Ù‡!",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#ef4444',
                confirmButtonText: 'Ù†Ø¹Ù…ØŒ Ø§Ø­Ø°Ù Ø§Ù„Ù…Ø·Ø¹Ù…',
                cancelButtonText: 'Ø¥Ù„ØºØ§Ø¡'
            });

            if (confirm.isConfirmed) {
                try {
                    const res = await fetch(`/api/v1/restaurants/${id}`, {
                        method: 'DELETE',
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    if (res.ok) {
                        Swal.fire('ØªÙ… Ø§Ù„Ø­Ø°Ù', 'ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ø·Ø¹Ù… Ø¨Ù†Ø¬Ø§Ø­', 'success');
                        loadRestaurantsList();
                    }
                } catch (e) { Swal.fire('Ø®Ø·Ø£', 'ÙØ´Ù„ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ù…Ø·Ø¹Ù…', 'error'); }
            }
        }

        function switchTab(tab) {
            localStorage.setItem('activeTab', tab); // Ø­ÙØ¸ Ù…ÙƒØ§Ù†Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ Ù„Ø§Ø³ØªØ¹Ø§Ø¯ØªÙ‡ Ø¹Ù†Ø¯ Ø§Ù„Ø±ÙŠÙØ±ÙŠØ´
            const allTabs = ['owners', 'restaurants', 'ai-upload', 'requests', 'sales-stats', 'sales-agents'];

            allTabs.forEach(t => {
                const tabEl = document.getElementById(`tab-${t}`);
                const btnEl = document.getElementById(`btn-${t}`);
                if(tabEl) tabEl.classList.add('hidden');
                if(btnEl) btnEl.classList.remove('active');
            });

            const selectedTab = document.getElementById(`tab-${tab}`);
            const selectedBtn = document.getElementById(`btn-${tab}`);
            
            if(selectedTab) selectedTab.classList.remove('hidden');
            if(selectedBtn) selectedBtn.classList.add('active');

            if (tab === 'sales-stats') {
                if(typeof loadSalesStats === 'function') loadSalesStats();
            } else if (tab === 'sales-agents') {
                loadSalesRequests();
            } else if (tab === 'requests') {
                document.getElementById('req-badge').style.display = 'none';
                loadRequests();
            } else if (tab === 'restaurants') {
                loadRestaurantsList();
            } else if (tab === 'owners') {
                loadOwnersList();
            }
        }

        async function editUser(id, currentName, currentEmail, currentPhone, currentWhatsapp, currentExpiryDate, currentLimit, currentHasStock, isTrial) {
            const { value: formValues } = await Swal.fire({
                title: 'ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø§Ù„Ùƒ',
                html:
                    `<div style="text-align:right; margin-bottom:5px; font-size:14px;">Ø§Ù„Ø§Ø³Ù…:</div>` +
                    `<input id="swal-name" class="swal2-input" value="${currentName}">` +
                    `<div style="text-align:right; margin-top:10px; margin-bottom:5px; font-size:14px;">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ:</div>` +
                    `<input id="swal-email" class="swal2-input" value="${currentEmail}">` +
                    `<div style="text-align:right; margin-top:10px; margin-bottom:5px; font-size:14px;">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ:</div>` +
                    `<input id="swal-phone" class="swal2-input" value="${currentPhone}">` +
                    `<div style="text-align:right; margin-top:10px; margin-bottom:5px; font-size:14px;">ÙˆØ§ØªØ³Ø§Ø¨ Ø§Ù„Ù…Ø·Ø¹Ù…:</div>` +
                    `<input id="swal-whatsapp" class="swal2-input" value="${currentWhatsapp}">` +
                    
                    `<div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:15px;">` +
                        `<div>` +
                            `<div style="text-align:right; font-size:13px; font-weight:bold;">Ø¨Ø§Ù‚Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª:</div>` +
                            `<select id="swal-limit" class="swal2-input" style="margin-top:5px;">` +
                                `<option value="75" ${currentLimit == 75 ? 'selected' : ''}>75 Ù…Ù†ØªØ¬</option>` +
                                `<option value="120" ${currentLimit == 120 ? 'selected' : ''}>120 Ù…Ù†ØªØ¬</option>` +
                                `<option value="200" ${currentLimit == 200 ? 'selected' : ''}>200 Ù…Ù†ØªØ¬</option>` +
                                `<option value="-1" ${currentLimit == -1 ? 'selected' : ''}>Ù…ÙØªÙˆØ­ (Unlimited)</option>` +
                            `</select>` +
                        `</div>` +
                        `<div>` +
                            `<div style="text-align:right; font-size:13px; font-weight:bold;">Ù†ÙˆØ¹ Ø§Ù„Ø­Ø³Ø§Ø¨:</div>` +
                            `<select id="swal-trial-status" class="swal2-input" style="margin-top:5px;">` +
                                `<option value="false" ${!isTrial ? 'selected' : ''}>Ø­Ø³Ø§Ø¨ Ø±Ø³Ù…ÙŠ (Ø¹Ø§Ø¯ÙŠ)</option>` +
                                `<option value="true" ${isTrial ? 'selected' : ''}>Ø­Ø³Ø§Ø¨ ØªØ¬Ø±ÙŠØ¨ÙŠ</option>` +
                            `</select>` +
                        `</div>` +
                    `</div>` +

                    `<div style="text-align:right; margin-top:10px; margin-bottom:5px; font-size:14px; color:var(--primary); font-weight:bold;">ØªØ§Ø±ÙŠØ® Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ:</div>` +
                    `<input id="swal-expiry" type="date" class="swal2-input" value="${currentExpiryDate}" style="color-scheme: dark;">` +

                    `<div style="margin-top: 15px; text-align: right; background: rgba(99, 102, 241, 0.1); padding: 10px; border-radius: 8px;">` +
                        `<label style="display: flex; align-items: center; gap: 10px; cursor: pointer; color: #fff;">` +
                            `<input type="checkbox" id="swal-stock" style="width: 20px; height: 20px;" ${currentHasStock ? 'checked' : ''}>` +
                            `<span>ØªÙØ¹ÙŠÙ„ Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø®Ø§Ø²Ù† (Stock)</span>` +
                        `</label>` +
                    `</div>`,
                
                focusConfirm: false,
                showCancelButton: true,
                confirmButtonText: 'Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª',
                cancelButtonText: 'Ø¥Ù„ØºØ§Ø¡',
                preConfirm: () => {
                    return {
                        name: document.getElementById('swal-name').value,
                        email: document.getElementById('swal-email').value,
                        phone: document.getElementById('swal-phone').value,
                        whatsapp: document.getElementById('swal-whatsapp').value,
                        productLimit: document.getElementById('swal-limit').value,
                        subscriptionExpires: document.getElementById('swal-expiry').value,
                        hasStock: document.getElementById('swal-stock').checked,
                        isTrial: document.getElementById('swal-trial-status').value === 'true'
                    };
                }
            });

            if (formValues) {
                try {
                    Swal.showLoading();
                    const res = await fetch(`/api/v1/users/${id}`, {
                        method: 'PATCH',
                        headers: { 
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify(formValues)
                    });
                    const result = await res.json();
                    Swal.close();
                    
                    if(result.status === 'success') {
                        Swal.fire('ØªÙ…!', 'ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­', 'success');
                        loadOwnersList();
                    } else {
                        Swal.fire('Ø®Ø·Ø£', result.message, 'error');
                    }
                } catch(e) { 
                    Swal.fire('Ø®Ø·Ø£', 'ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±', 'error'); 
                }
            }
        }

       async function generateQRPopup(ownerName, slug) {
            let finalSlug = slug;
            // Ø¥Ø°Ø§ Ù„Ù… ÙŠØªÙ… ØªÙ…Ø±ÙŠØ± Ø§Ù„Ø±Ø§Ø¨Ø·ØŒ Ù†Ø·Ù„Ø¨Ù‡ Ù…Ù† Ø§Ù„Ø£Ø¯Ù…Ù†
            if (!finalSlug) {
                const { value: inputSlug } = await Swal.fire({
                    title: '<span style="color:var(--primary)">Ø¥Ù†Ø´Ø§Ø¡ QR Code</span>',
                    html: `<p style="color:#ccc">Ø£Ø¯Ø®Ù„ Ø±Ø§Ø¨Ø· Ø§Ù„Ù…Ù†ÙŠÙˆ (Slug) Ø§Ù„Ø®Ø§Øµ Ø¨Ù€ <b style="color:#fff">${ownerName}</b></p>`,
                    input: 'text',
                    inputPlaceholder: 'Ù…Ø«Ø§Ù„: al-baraka-restaurant',
                    background: '#1a1d24',
                    color: '#fff',
                    inputAttributes: {
                        style: 'background: rgba(0,0,0,0.3); border: 1px solid var(--glass-border); color: #fff;'
                    },
                    showCancelButton: true,
                    confirmButtonText: 'Ù…ØªØ§Ø¨Ø¹Ø©',
                    cancelButtonText: 'Ø¥Ù„ØºØ§Ø¡',
                    confirmButtonColor: '#d4af37',
                    cancelButtonColor: '#4b5563'
                });
                if (!inputSlug) return;
                finalSlug = inputSlug;
            }

           const url = `${window.location.origin}/menu/${finalSlug}`;
            
            Swal.fire({
                title: `<span style="color:#fff; font-size:20px;">QR Code: <span style="color:var(--primary)">${finalSlug}</span></span>`,
                html: `
                    <div style="background: rgba(255,255,255,0.05); padding: 20px; border-radius: 16px; border: 1px solid var(--glass-border);">
                        <div id="qr-download-area" style="background:white; padding:20px; border-radius:15px; display:inline-block; box-shadow: 0 10px 30px rgba(0,0,0,0.5);">
                            <div id="qrcode-container"></div>
                            <p style="margin-top:10px; color:#000; font-weight:800; font-size:16px; font-family:'Tajawal';">${finalSlug}</p>
                        </div>
                        
                        <div style="text-align:right; margin-top:20px; padding-top:20px; border-top:1px solid var(--glass-border);">
                            <label style="font-size:13px; color:#9ca3af; display:block; margin-bottom:8px;">Ø§Ø³Ù… Ø§Ù„Ù…Ù„Ù Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„:</label>
                            <input type="text" id="qr-file-name" value="QR-${finalSlug}" style="width:100%; padding:10px; background:rgba(0,0,0,0.3); border:1px solid var(--glass-border); border-radius:8px; color:#fff; margin-bottom:15px;">
                            
                            <label style="font-size:13px; color:#9ca3af; display:block; margin-bottom:8px;">Ø¯Ù…Ø¬ Ù„ÙˆØ¬Ùˆ ÙÙŠ Ø§Ù„Ù…Ù†ØªØµÙ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ):</label>
                            <div style="display:flex; gap:10px;">
                                <input type="file" id="qr-logo-input" accept="image/*" style="font-size:12px; background:rgba(255,255,255,0.05); border:1px dashed var(--glass-border); padding:8px; width:100%;" onchange="drawQRWithLogo('${url}')">
                                <button onclick="resetToNormalQR('${url}')" style="background:rgba(239, 68, 68, 0.2); color:#f87171; border:1px solid rgba(239, 68, 68, 0.3); border-radius:8px; padding:0 15px; cursor:pointer;" title="Ø­Ø°Ù Ø§Ù„Ù„ÙˆØ¬Ùˆ"><i class="fas fa-trash"></i></button>
                            </div>
                        </div>
                    </div>
                `,
                background: '#1a1d24',
                showConfirmButton: true,
                confirmButtonText: '<i class="fas fa-save"></i> Ø­ÙØ¸ ÙˆØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø©',
                confirmButtonColor: '#10b981',
                showCloseButton: true,
                width: 500,
                didOpen: () => {
                    resetToNormalQR(url); 
                },
                preConfirm: () => {
                    downloadCustomQR(finalSlug);
                    return false; // Ù„Ù…Ù†Ø¹ Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†Ø§ÙØ°Ø© ÙÙˆØ±Ø§Ù‹
                }
            });
        }

        function renderQRWindow(name, slug) {
            const url = `${window.location.origin}/menu/${finalSlug}`;
            Swal.fire({
                title: `QR Code: ${name}`,
                html: `
                    <div id="qr-download-area" style="background:white; padding:20px; border-radius:15px; display:inline-block;">
                        <div id="qrcode-container"></div>
                        <p style="margin-top:10px; color:#000; font-weight:bold;">${slug} Menu</p>
                    </div>
                    <div style="margin-top:15px;">
                        <button class="btn-primary" onclick="downloadQR('${slug}')" style="background:#10b981">ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙƒÙˆØ¯</button>
                    </div>`,
                showConfirmButton: false,
                didOpen: () => {
                    new QRCode(document.getElementById("qrcode-container"), {
                        text: url, width: 250, height: 250, correctLevel: QRCode.CorrectLevel.H
                    });
                }
            });
        }

        async function downloadCustomQR(slug) {
            const area = document.getElementById('qr-download-area');
            const customName = document.getElementById('qr-file-name').value || 'My-QR-Code';
            
            try {
                Swal.showLoading();
                const canvas = await html2canvas(area, { 
                    backgroundColor: "#ffffff", 
                    scale: 3,
                    useCORS: true 
                });
                const imgData = canvas.toDataURL("image/png");

                const link = document.createElement('a');
                link.download = `${customName}.png`;
                link.href = imgData;
                link.click();

                const res = await fetch(`/api/v1/restaurants/update-qr/${slug}`, {
                    method: 'PATCH',
                    headers: { 
                        'Content-Type': 'application/json', 
                        'Authorization': `Bearer ${token}` 
                    },
                    body: JSON.stringify({ 
                        qrImage: imgData, 
                        qrName: customName 
                    })
                });

                const result = await res.json();
                
                if(result.status === 'success') {
                    Swal.fire({
                        icon: 'success',
                        title: 'ØªÙ… Ø§Ù„Ø­ÙØ¸ ÙˆØ§Ù„ØªØ­Ù…ÙŠÙ„',
                        text: 'ØªÙ… Ø±Ø¨Ø· ØªØµÙ…ÙŠÙ… Ø§Ù„Ù€ QR Code Ø¨Ø§Ù„Ù…Ø·Ø¹Ù… Ø¨Ù†Ø¬Ø§Ø­',
                        timer: 2000
                    });
                    if (typeof loadRestaurantsList === "function") loadRestaurantsList();
                } else {
                    Swal.fire('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­ÙØ¸', result.message, 'error');
                }
            } catch(e) { 
                console.error("Error saving QR:", e);
                Swal.fire('Ø®Ø·Ø£', 'Ø­Ø¯Ø«Øª Ù…Ø´ÙƒÙ„Ø© Ø£Ø«Ù†Ø§Ø¡ Ù…Ø­Ø§ÙˆÙ„Ø© Ø­ÙØ¸ Ø§Ù„Ù€ QR', 'error'); 
            }
        }

        async function loginAsAny(userId, targetPath) {
            try {
                // Ø¥Ø¸Ù‡Ø§Ø± Ù…Ø¤Ø´Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„
                Swal.fire({ 
                    title: 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­ÙˆÙŠÙ„...', 
                    html: 'ÙŠØªÙ… Ø§Ù„Ø¢Ù† ØªØ­Ø¶ÙŠØ± Ø¬Ù„Ø³Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©',
                    allowOutsideClick: false, 
                    didOpen: () => Swal.showLoading() 
                });

                const res = await fetch(`/api/v1/users/impersonate/${userId}`, {
                    method: 'POST',
                    headers: { 
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ø§Ù„Ø´Ø¨ÙƒØ© Ù‚Ø¨Ù„ Ù…Ø­Ø§ÙˆÙ„Ø© Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù€ JSON
                if (!res.ok) {
                    const errorData = await res.json();
                    throw new Error(errorData.message || 'ÙØ´Ù„ Ø§Ù„Ø³ÙŠØ±ÙØ± ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø·Ù„Ø¨');
                }

                const data = await res.json();
                Swal.close();
                
                if(data.status === 'success') {
                    // ØªØ®Ø²ÙŠÙ† Ø§Ù„ØªÙˆÙƒÙ† Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„Ù…Ø³ØªÙ‡Ø¯Ù
                    if(targetPath.includes('sales')) {
                        localStorage.setItem('salesToken', data.token);
                        // ÙØªØ­ Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ø³ÙŠÙ„Ø² ÙÙŠ Ù†Ø§ÙØ°Ø© Ø¬Ø¯ÙŠØ¯Ø©
                        window.open(targetPath, '_blank');
                    } else {
                        // ÙØªØ­ Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ù…Ø§Ù„Ùƒ ÙÙŠ Ù†Ø§ÙØ°Ø© Ø¬Ø¯ÙŠØ¯Ø© Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¨Ø§Ø±Ø§Ù…ÙŠØªØ± t
                        window.open(`${targetPath}?t=${data.token}`, '_blank');
                    }
                }
            } catch(e) { 
                console.error('Login error:', e);
                Swal.fire({
                    icon: 'error',
                    title: 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø´Ø¨ÙƒØ©',
                    text: 'ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„Ø³ÙŠØ±ÙØ± ÙŠØ¹Ù…Ù„ Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­ Ø£Ùˆ Ø£Ù†Ùƒ Ù…Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„ Ø¨ØµÙ„Ø§Ø­ÙŠØ© Ø£Ø¯Ù…Ù†.',
                    confirmButtonText: 'Ø­Ø³Ù†Ø§Ù‹'
                });
            }
        }
        async function createRestaurant() {
            const restaurantName = document.getElementById('r-name').value;
            const slug = document.getElementById('r-slug').value;
            const owner = document.getElementById('r-owner').value;
            const coverFile = document.getElementById('r-cover').files[0];

            if(!restaurantName || !slug || !owner) return Swal.fire('ØªÙ†Ø¨ÙŠÙ‡', 'Ø§Ù…Ù„Ø£ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ§Ø®ØªØ± Ø§Ù„Ù…Ø§Ù„Ùƒ', 'warning');

            const formData = new FormData();
            formData.append('restaurantName', restaurantName);
            formData.append('slug', slug);
            formData.append('owner', owner);
            if(coverFile) formData.append('image', coverFile);

            try {
                Swal.showLoading();
                const res = await fetch('/api/v1/restaurants', {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` },
                    body: formData
                });
                const data = await res.json();
                Swal.close();

                if(data.status === 'success') {
                    hasUnsavedChanges = false; // ØªÙ… Ø§Ù„Ø­ÙØ¸ØŒ Ø§Ù„ØºÙ Ø§Ù„ØªØ­Ø°ÙŠØ±
                    Swal.fire({
                        icon: 'success', 
                        title: 'ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø·Ø¹Ù… Ø¨Ù†Ø¬Ø§Ø­', 
                        showConfirmButton: false,
                        timer: 1500
                    });
                    document.getElementById('r-name').value = '';
                    document.getElementById('r-slug').value = '';
                    document.getElementById('r-cover').value = '';
                    document.getElementById('r-owner').value = '';
                    document.getElementById('selected-owner-name').value = '';
                    
                    loadRestaurantsList(); 
                    
                } else {
                    Swal.fire('Ø®Ø·Ø£', data.message, 'error');
                }
            } catch(e) { Swal.fire('Ø®Ø·Ø£', 'Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„', 'error'); }
        }

        function generateSlug() {
            const name = document.getElementById('r-name').value;
            const slug = name.trim().toLowerCase()
                .replace(/\s+/g, '-')
                .replace(/[^\w\u0621-\u064A-]+/g, '')
                .replace(/--+/g, '-');

            document.getElementById('r-slug').value = slug;
        }

        function logoutSuperAdmin() {
            localStorage.removeItem('superAdminToken');
            window.location.href = '/login';
        }

        const style = document.createElement('style');
        style.innerHTML = `
            @keyframes highlightRow {
                0% { background-color: rgba(212, 175, 55, 0.3); }
                100% { background-color: transparent; }
            }
        `;
        document.head.appendChild(style);

        async function toggleUserStatus(id) {
            try {
                Swal.fire({
                    title: 'Ø¬Ø§Ø±ÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø©...',
                    allowOutsideClick: false,
                    didOpen: () => { Swal.showLoading(); }
                });

                const res = await fetch(`/api/v1/users/${id}/toggle-status`, {
                    method: 'PATCH',
                    headers: { 
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                const result = await res.json();
                Swal.close();
                
                if(result.status === 'success') {
                    Swal.fire({
                        toast: true,
                        icon: 'success',
                        title: result.message,
                        position: 'top-end',
                        showConfirmButton: false,
                        timer: 2000
                    });
                    
                    await loadOwnersList(); 
                } else {
                    Swal.fire('Ø®Ø·Ø£', result.message, 'error');
                }
            } catch(e) { 
                console.error('Error:', e);
                Swal.fire('Ø®Ø·Ø£', 'ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±', 'error'); 
            }
        }

        async function deleteUser(id) {
            const confirm = await Swal.fire({
                title: 'Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ',
                text: "Ø³ÙŠØªÙ… Ø­Ø°Ù Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø§Ù„Ùƒ ÙˆÙƒÙ„ Ø¨ÙŠØ§Ù†Ø§ØªÙ‡ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹!",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#ef4444',
                cancelButtonColor: '#6b7280',
                confirmButtonText: 'Ù†Ø¹Ù…ØŒ Ø§Ø­Ø°Ù Ø§Ù„Ø­Ø³Ø§Ø¨',
                cancelButtonText: 'Ø¥Ù„ØºØ§Ø¡'
            });

            if (confirm.isConfirmed) {
                try {
                    const res = await fetch(`/api/v1/users/${id}`, {
                        method: 'DELETE',
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    const result = await res.json();
                    if(res.ok) {
                        Swal.fire('ØªÙ… Ø§Ù„Ø­Ø°Ù', 'ØªÙ… Ù…Ø³Ø­ Ø§Ù„Ø­Ø³Ø§Ø¨ Ù…Ù† Ø§Ù„Ù†Ø¸Ø§Ù…', 'success');
                        loadOwnersList();
                    } else {
                        Swal.fire('Ø®Ø·Ø£', result.message, 'error');
                    }
                } catch(e) { Swal.fire('Ø®Ø·Ø£', 'ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±', 'error'); }
            }
        }

        async function changePasswordPrompt(id, name) {
            const { value: newPassword } = await Swal.fire({
                title: `ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ±: ${name}`,
                input: 'password',
                inputLabel: 'ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©',
                inputPlaceholder: 'Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©',
                inputAttributes: {
                    autocapitalize: 'off',
                    autocorrect: 'off'
                },
                showCancelButton: true,
                confirmButtonText: 'ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¢Ù†',
                cancelButtonText: 'Ø¥Ù„ØºØ§Ø¡'
            });

            if (newPassword) {
                try {
                    Swal.showLoading();
                    const res = await fetch(`/api/v1/users/${id}/change-password-admin`, {
                        method: 'PATCH',
                        headers: { 
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({ password: newPassword })
                    });
                    const result = await res.json();
                    Swal.close();

                    if (result.status === 'success') {
                        Swal.fire('ØªÙ…!', 'ØªÙ… ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø¨Ù†Ø¬Ø§Ø­', 'success');
                    } else {
                        Swal.fire('Ø®Ø·Ø£', result.message, 'error');
                    }
                } catch (e) {
                    Swal.fire('Ø®Ø·Ø£', 'ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±', 'error');
                }
            }
        }

        let allOwners = [];

        function openOwnerModal() {
            document.getElementById('owner-modal').classList.remove('hidden');
            renderModalOwners(allOwners);
        }

        function closeOwnerModal() {
            document.getElementById('owner-modal').classList.add('hidden');
        }

        function renderModalOwners(owners) {
            const list = document.getElementById('modal-owners-list');
            list.innerHTML = '';
            owners.forEach(u => {
                if(u.role === 'admin') return;
                const div = document.createElement('div');
                div.className = 'owner-item';
                div.style.padding = '12px';
                div.style.borderBottom = '1px solid var(--glass-border)';
                div.style.cursor = 'pointer';
                div.style.color = '#fff';
                div.innerHTML = `
                    <div style="font-weight:bold">${u.name}</div>
                    <div style="font-size:12px; color:var(--text-muted)">${u.email} | ${u.phone || 'Ø¨Ø¯ÙˆÙ† Ù‡Ø§ØªÙ'}</div>
                `;
                div.onclick = () => {
                    if(window.selectingForAI) {
                        document.getElementById('ai-res-id').value = u._id; 
                        document.getElementById('ai-res-name').value = u.name;
                        window.selectingForAI = false;
                    } else {
                        document.getElementById('r-owner').value = u._id;
                        document.getElementById('selected-owner-name').value = u.name;
                    }
                    closeOwnerModal();
                };
                list.appendChild(div);
            });
        }

        function filterOwners() {
            const term = document.getElementById('owner-search').value.toLowerCase();
            const filtered = allOwners.filter(u => 
                u.name.toLowerCase().includes(term) || 
                u.email.toLowerCase().includes(term) || 
                (u.phone && u.phone.includes(term))
            );
            renderModalOwners(filtered);
        }

        function drawQRWithLogo(url) {
            const input = document.getElementById('qr-logo-input');
            const container = document.getElementById('qrcode-container');
            
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    container.innerHTML = "";
                    
                    const tempDiv = document.createElement('div');
                    new QRCode(tempDiv, {
                        text: url,
                        width: 600,
                        height: 600,
                        colorDark : "#000000",
                        colorLight : "#ffffff",
                        correctLevel : QRCode.CorrectLevel.H
                    });

                    setTimeout(() => {
                        const qrCanvas = tempDiv.querySelector('canvas');
                        const finalCanvas = document.createElement('canvas');
                        finalCanvas.width = 600;
                        finalCanvas.height = 600;
                        const ctx = finalCanvas.getContext('2d');

                        ctx.drawImage(qrCanvas, 0, 0);

                        const logo = new Image();
                        logo.src = e.target.result;
                        logo.onload = function() {
                            const logoSize = 140;
                            const x = (finalCanvas.width - logoSize) / 2;
                            const y = (finalCanvas.height - logoSize) / 2;

                            ctx.fillStyle = "#ffffff";
                            ctx.fillRect(x - 10, y - 10, logoSize + 20, logoSize + 20);

                            ctx.drawImage(logo, x, y, logoSize, logoSize);
                            
                            const imgData = finalCanvas.toDataURL("image/png");
                            container.innerHTML = `<img src="${imgData}" style="width:250px; height:250px;">`;
                        };
                    }, 100);
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        function resetToNormalQR(url) {
            const container = document.getElementById('qrcode-container');
            container.innerHTML = "";
            new QRCode(container, {
                text: url,
                width: 250,
                height: 250,
                colorDark : "#000000",
                colorLight : "#ffffff",
                correctLevel : QRCode.CorrectLevel.H
            });
            if(document.getElementById('qr-logo-input')) document.getElementById('qr-logo-input').value = "";
        }

        async function editRestaurantPrompt(id) {
            Swal.showLoading();
            try {
                const resFetch = await fetch(`/api/v1/restaurants/`, { 
                    headers: { 'Authorization': `Bearer ${token}` } 
                });
                const dataAll = await resFetch.json();
                const r = dataAll.data.restaurants.find(item => item._id === id);
                Swal.close();

                if (!r) return Swal.fire('Ø®Ø·Ø£', 'Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø·Ø¹Ù…', 'error');

                const { value: formValues } = await Swal.fire({
                    title: 'ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø·Ø¹Ù…',
                    html:
                        `<div style="text-align:right; margin-bottom:5px; font-size:14px;">Ø§Ø³Ù… Ø§Ù„Ù†Ø´Ø§Ø·:</div>` +
                        `<input id="swal-input1" class="swal2-input" value="${r.restaurantName}" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯">` +
                        
                        `<div style="text-align:right; margin-top:15px; margin-bottom:5px; font-size:14px;">Ø§Ù„Ø±Ø§Ø¨Ø· (Slug):</div>` +
                        `<input id="swal-input2" class="swal2-input" value="${r.slug}" placeholder="Ø§Ù„Ø±Ø§Ø¨Ø· Ø§Ù„Ø¬Ø¯ÙŠØ¯">` +
                        
                        `<div style="text-align:right; margin-top:15px; margin-bottom:5px; font-size:14px;">Ø§Ù„Ù…Ø§Ù„Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ:</div>` +
                        `<div style="display: flex; gap: 10px;">` +
                            `<input type="text" id="swal-owner-name" readonly value="${r.owner ? r.owner.name : 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}" style="background: rgba(255,255,255,0.05); flex: 1; height: 45px; border: 1px solid var(--glass-border); border-radius: 5px; padding: 0 10px;">` +
                            `<input type="hidden" id="swal-owner-id" value="${r.owner ? r.owner._id : ''}">` +
                            `<button type="button" class="action-btn btn-login-as" onclick="openOwnerModalForEdit()" style="width: auto; height: 45px; padding: 0 15px;">ØªØºÙŠÙŠØ±</button>` +
                        `</div>`,
                    focusConfirm: false,
                    showCancelButton: true,
                    confirmButtonText: 'Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª',
                    cancelButtonText: 'Ø¥Ù„ØºØ§Ø¡',
                    preConfirm: () => {
                        return {
                            restaurantName: document.getElementById('swal-input1').value,
                            slug: document.getElementById('swal-input2').value,
                            owner: document.getElementById('swal-owner-id').value
                        }
                    }
                });

                if (formValues) {
                    Swal.showLoading();
                    const res = await fetch(`/api/v1/restaurants/${id}`, {
                        method: 'PATCH',
                        headers: { 
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}` 
                        },
                        body: JSON.stringify(formValues)
                    });
                    const data = await res.json();
                    Swal.close();

                    if (data.status === 'success') {
                        Swal.fire('ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ«', 'ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø¨Ù†Ø¬Ø§Ø­', 'success');
                        loadRestaurantsList(); 
                    } else {
                        Swal.fire('Ø®Ø·Ø£', data.message, 'error');
                    }
                }
            } catch (e) {
                Swal.close();
                Swal.fire('Ø®Ø·Ø£', 'Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±', 'error');
            }
        }

        function viewSavedQR(img, name) {
            Swal.fire({
                title: name,
                imageUrl: img,
                imageAlt: 'QR Code',
                confirmButtonText: 'Ø¥ØºÙ„Ø§Ù‚'
            });
        }

        function filterTable(tbodyId, inputId) {
            const term = document.getElementById(inputId).value.toLowerCase();
            const rows = document.querySelectorAll(`#${tbodyId} tr`);
            rows.forEach(row => {
                const rowText = row.innerText.toLowerCase();
                row.style.display = rowText.includes(term) ? '' : 'none';
            });
        }

        function openOwnerModalForEdit() {
            document.getElementById('owner-modal').classList.remove('hidden');
            
            const originalRender = renderModalOwners;
            renderModalOwners = (owners) => {
                const list = document.getElementById('modal-owners-list');
                list.innerHTML = '';
                owners.forEach(u => {
                    if(u.role === 'admin') return;
                    const div = document.createElement('div');
                    div.className = 'owner-item';
                    div.style.padding = '12px';
                    div.style.borderBottom = '1px solid var(--glass-border)';
                    div.style.cursor = 'pointer';
                    div.style.color = '#fff';
                    div.innerHTML = `
                        <div style="font-weight:bold">${u.name}</div>
                        <div style="font-size:12px; color:var(--text-muted)">${u.email}</div>
                    `;
                    div.onclick = () => {
                        document.getElementById('swal-owner-id').value = u._id;
                        document.getElementById('swal-owner-name').value = u.name;
                        closeOwnerModal();
                        renderModalOwners = originalRender;
                    };
                    list.appendChild(div);
                });
            };
            renderModalOwners(allOwners);
        }

        function downloadSavedQR(imgUrl, name) {
            if(!imgUrl) return Swal.fire('ØªÙ†Ø¨ÙŠÙ‡', 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ QR Ù…Ø­ÙÙˆØ¸ Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…Ø·Ø¹Ù…ØŒ Ø§Ø·Ù„Ø¨ Ù…Ù† Ø§Ù„Ù…Ø§Ù„Ùƒ Ø¥Ù†Ø´Ø§Ø¤Ù‡.', 'info');
            const link = document.createElement('a');
            link.href = imgUrl;
            link.download = `QR-${name}.png`;
            link.click();
        }

        function openOwnerModalForAI() {
            window.selectingForAI = true; 
            openOwnerModal();
        }

        async function startAiProcessing() {
            const ownerId = document.getElementById('ai-res-id').value;
            const files = document.getElementById('ai-menu-images').files;
            const btn = document.getElementById('start-ai-btn');

            if(!ownerId || files.length === 0) return Swal.fire('ØªÙ†Ø¨ÙŠÙ‡', 'Ø§Ø®ØªØ± Ø§Ù„Ù…Ø·Ø¹Ù… ÙˆØ§Ù„ØµÙˆØ± Ø£ÙˆÙ„Ø§Ù‹', 'warning');

            const formData = new FormData();
            formData.append('ownerId', ownerId); 
            for (let i = 0; i < files.length; i++) {
                formData.append('menuImages', files[i]);
            }

            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Ø¬Ø§Ø±ÙŠ ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…Ù†ÙŠÙˆ.. Ù‚Ø¯ ÙŠØ³ØªØºØ±Ù‚ Ø¯Ù‚ÙŠÙ‚Ø©';
            
            try {
                const res = await fetch('/api/v1/ai/process-menu', {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` },
                    body: formData
                });
                const data = await res.json();
                
                if(data.status === 'success') {
                    Swal.fire('Ù†Ø¬Ø§Ø­ Ù…Ø°Ù‡Ù„!', 'ØªÙ… Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ±ÙØ¹ Ø§Ù„Ù…Ù†ÙŠÙˆ Ø¨Ù†Ø¬Ø§Ø­', 'success');
                    document.getElementById('ai-menu-images').value = '';
                } else {
                    Swal.fire('Ø®Ø·Ø£', data.message, 'error');
                }
            } catch(e) {
                Swal.fire('Ø®Ø·Ø£', 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±', 'error');
            } finally {
                btn.disabled = false;
                btn.innerText = 'Ø§Ø¨Ø¯Ø£ Ø§Ù„ØªØ­Ù„ÙŠÙ„ ÙˆØ§Ù„Ø±ÙØ¹ Ø§Ù„ØµØ§Ø±ÙˆØ®ÙŠ ğŸš€';
            }
        }

        function filterSalesTable() {
            const input = document.getElementById('sales-search-input');
            const filter = input.value.toLowerCase();
            const rows = document.querySelectorAll('#sales-tbody tr');

            rows.forEach(row => {
                const text = row.innerText.toLowerCase();
                if (text.includes(filter)) {
                    row.style.display = "";
                } else {
                    row.style.display = "none";
                }
            });
        }

        async function createSalesAgent() {
            try {
                const name = document.getElementById('salesName').value;
                const email = document.getElementById('salesEmail').value;
                const phone = document.getElementById('salesPhone').value;
                const password = document.getElementById('salesPass').value;
                await axios.post('/api/v1/users/create-sales-agent', { name, email, password, phone }, { headers: { Authorization: `Bearer ${token}` } });
                Swal.fire('Ù†Ø¬Ø§Ø­', 'ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø§Ù„Ø³ÙŠÙ„Ø² Ø¨Ù†Ø¬Ø§Ø­', 'success');
                document.getElementById('createSalesModal').style.display = 'none';
                loadSalesStats();
            } catch (err) {
                Swal.fire('Ø®Ø·Ø£', err.response?.data?.message || err.message, 'error');
            }
        }
        
        async function loadSalesStats() {
            try {
                const res = await axios.get('/api/v1/admin/sales-stats', { headers: { Authorization: `Bearer ${token}` } });
                const stats = res.data.data.stats;
                const grid = document.getElementById('salesGrid');
                grid.innerHTML = '';
                stats.forEach((agent, index) => {
                    const agentData = encodeURIComponent(JSON.stringify(agent));
                    const rankColor = index === 0 ? '#fbbf24' : (index === 1 ? '#9ca3af' : (index === 2 ? '#b45309' : 'rgba(255,255,255,0.1)'));
                    const borderColor = index < 3 ? rankColor : 'rgba(255,255,255,0.1)';
                    const card = `
                        <div onclick="showSalesDetails('${agentData}')" style="background:linear-gradient(160deg, rgba(255,255,255,0.08) 0%, rgba(255,255,255,0.02) 100%); border:1px solid ${borderColor}; border-top: 4px solid ${borderColor}; border-radius:16px; padding:20px; cursor:pointer; transition:transform 0.2s; position:relative; box-shadow:0 10px 20px rgba(0,0,0,0.1);">
                            <div style="display:flex; align-items:center; gap:15px; margin-bottom:15px;">
                                <div style="width:50px; height:50px; background:rgba(255,255,255,0.1); color:#fff; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:20px; font-weight:bold;">${agent.salesName.charAt(0)}</div>
                                <div style="text-align:right;">
                                    <h3 style="margin:0; font-size:16px; color:#fff;">${agent.salesName}</h3>
                                    <small style="color:var(--text-muted);">${agent.salesEmail}</small>
                                </div>
                            </div>
                            <div style="display:flex; justify-content:space-between; background:rgba(0,0,0,0.2); padding:10px; border-radius:8px; text-align:center;">
                                <div><div style="font-size:11px; color:var(--text-muted);">Ø§Ù„Ù†Ø´Ø·ÙŠÙ†</div><div style="font-weight:bold; color:#34d399; font-size:16px;">${agent.activeClients}</div></div>
                                <div style="border-right:1px solid rgba(255,255,255,0.1); padding-right:10px;"><div style="font-size:11px; color:var(--text-muted);">ØªØ¬Ø±ÙŠØ¨ÙŠ</div><div style="font-weight:bold; color:#fbbf24; font-size:16px;">${agent.trialClients}</div></div>
                                <div style="border-right:1px solid rgba(255,255,255,0.1); padding-right:10px;"><div style="font-size:11px; color:var(--text-muted);">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</div><div style="font-weight:bold; color:#fff; font-size:16px;">${agent.totalClients}</div></div>
                            </div>
                        </div>`;
                    grid.innerHTML += card;
                });
            } catch (err) { console.error(err); }
        }

        function showSalesDetails(encodedData) {
            const agent = JSON.parse(decodeURIComponent(encodedData));
            document.getElementById('detailTitle').innerText = `Ø¹Ù…Ù„Ø§Ø¡: ${agent.salesName}`;
            const listContainer = document.getElementById('clientsListContent');
            if (agent.clientsList.length === 0) {
                listContainer.innerHTML = '<p style="text-align:center; color:var(--text-muted); padding:20px;">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¹Ù…Ù„Ø§Ø¡ Ù„Ù‡Ø°Ø§ Ø§Ù„ÙˆÙƒÙŠÙ„ Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†.</p>';
            } else {
                let html = '<table style="width:100%; border-collapse:collapse;"><thead><tr style="text-align:right;"><th style="padding:12px; font-size:13px; color:var(--text-muted);">Ø§Ù„Ø¹Ù…ÙŠÙ„</th><th style="padding:12px; font-size:13px; color:var(--text-muted);">Ø§Ù„Ù‡Ø§ØªÙ</th><th style="padding:12px; font-size:13px; color:var(--text-muted);">Ø§Ù„Ø­Ø§Ù„Ø©</th></tr></thead><tbody>';
                agent.clientsList.forEach(client => {
                    const statusBadge = client.isTrial ? '<span style="background:rgba(245, 158, 11, 0.2); color:#fbbf24; padding:2px 8px; border-radius:10px; font-size:11px;">ØªØ¬Ø±ÙŠØ¨ÙŠ</span>' : '<span style="background:rgba(16, 185, 129, 0.2); color:#34d399; padding:2px 8px; border-radius:10px; font-size:11px;">Ù†Ø´Ø·</span>';
                    html += `<tr style="border-bottom:1px solid var(--glass-border);"><td style="padding:12px; color:#fff;">${client.name}<br><small style="color:var(--text-muted)">${client.email}</small></td><td style="padding:12px; color:#fff;">${client.phone}</td><td style="padding:12px;">${statusBadge}</td></tr>`;
                });
                html += '</tbody></table>';
                listContainer.innerHTML = html;
            }
            document.getElementById('salesDetailsModal').style.display = 'flex';
        }

        async function loadSalesRequests() {
            try {
                const res = await fetch('/api/v1/sales/requests', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const response = await res.json();
                const tbody = document.getElementById('sales-tbody');
                tbody.innerHTML = '';

                if(response.data && response.data.length > 0) {
                    response.data.forEach(req => {
                        let statusBadge = req.status === 'pending' ? '<span style="background:rgba(245, 158, 11, 0.2); color:#fbbf24; padding:2px 8px; border-radius:10px; font-size:12px">Ø§Ù†ØªØ¸Ø§Ø±</span>' :
                                          req.status === 'approved' ? '<span style="background:rgba(16, 185, 129, 0.2); color:#34d399; padding:2px 8px; border-radius:10px; font-size:12px">Ù…Ù‚Ø¨ÙˆÙ„</span>' :
                                          '<span style="background:rgba(239, 68, 68, 0.2); color:#f87171; padding:2px 8px; border-radius:10px; font-size:12px">Ù…Ø±ÙÙˆØ¶</span>';
                        
                        tbody.innerHTML += `
                            <tr>
                                <td>
                                    <img src="${req.image || 'https://via.placeholder.com/40'}" onclick="viewSalesImage('${req.image}', '${req.name}')" 
                                         style="width:40px; height:40px; border-radius:50%; object-fit:cover; border:1px solid var(--glass-border); cursor: pointer;">
                                </td>
                                <td>
                                    <div style="font-weight:bold; color:#fff;">${req.name}</div>
                                    <div style="font-size:12px; color:var(--text-muted)">${req.email || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¨Ø±ÙŠØ¯'}</div>
                                </td>
                                <td>
                                    <div style="font-weight:bold; color:#fff;">${req.phone}</div>
                                    <a href="https://wa.me/20${req.phone.replace(/^0+/, '')}" target="_blank" style="color:#25d366; font-size:12px; text-decoration:none">
                                        <i class="fab fa-whatsapp"></i> ÙˆØ§ØªØ³Ø§Ø¨
                                    </a>
                                </td>
                                <td style="font-family:monospace; color:var(--primary); font-weight:bold; font-size:14px;">
                                    ${req.walletNumber || '-'}
                                </td>
                                <td>${statusBadge}</td>
                                <td>
                                    <div style="display:flex; gap:5px;">
                                        ${req.status === 'pending' ? `
                                        <button class="action-btn" style="background:rgba(16, 185, 129, 0.2); color:#34d399;" onclick="approveAndCreateAgent('${req._id}', '${req.name}', '${req.email || ''}', '${req.phone}')" title="Ù‚Ø¨ÙˆÙ„ ÙˆØ¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨">
                                            <i class="fas fa-user-check"></i>
                                        </button>
                                        <button class="action-btn" style="background:rgba(245, 158, 11, 0.2); color:#fbbf24;" onclick="updateSalesStatus('${req._id}', 'rejected')" title="Ø±ÙØ¶ Ø§Ù„Ø·Ù„Ø¨">
                                            <i class="fas fa-ban"></i>
                                        </button>
                                        ` : ''}
                                        
                                        <button class="action-btn" style="background:rgba(239, 68, 68, 0.2); color:#f87171;" onclick="deleteSalesAgent('${req._id}', '${req.name}')" title="Ø­Ø°Ù Ø§Ù„ÙˆÙƒÙŠÙ„ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹">
                                            <i class="fas fa-trash-alt"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        `;
                    });
                } else {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding:20px; color:var(--text-muted)">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ø­Ø§Ù„ÙŠØ§Ù‹</td></tr>';
                }
            } catch(e) { console.error(e); }
        }

        async function approveAndCreateAgent(reqId, name, email, phone) {
            const { value: formValues } = await Swal.fire({
                title: `Ù‚Ø¨ÙˆÙ„ Ø§Ù„ÙˆÙƒÙŠÙ„: ${name}`,
                html:
                    `<p style="font-size:13px; color:#aaa;">Ø³ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯ Ù„Ù‡Ø°Ø§ Ø§Ù„ÙˆÙƒÙŠÙ„ ÙˆØªÙØ¹ÙŠÙ„ Ø­Ø³Ø§Ø¨Ù‡ ÙÙˆØ±Ø§Ù‹.</p>` +
                    `<input id="swal-new-email" class="swal2-input" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ" value="${email}">` +
                    `<input id="swal-new-pass" type="password" class="swal2-input" placeholder="ØªØ¹ÙŠÙŠÙ† ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ù„Ù„Ø¯Ø®ÙˆÙ„">`,
                focusConfirm: false,
                showCancelButton: true,
                confirmButtonText: 'Ø¥Ù†Ø´Ø§Ø¡ ÙˆÙ‚Ø¨ÙˆÙ„',
                cancelButtonText: 'Ø¥Ù„ØºØ§Ø¡',
                preConfirm: () => {
                    return {
                        email: document.getElementById('swal-new-email').value,
                        password: document.getElementById('swal-new-pass').value
                    }
                }
            });

            if (!formValues) return;
            if (!formValues.email || !formValues.password) return Swal.fire('ØªÙ†Ø¨ÙŠÙ‡', 'Ø§Ù„Ø¨Ø±ÙŠØ¯ ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ù…Ø·Ù„ÙˆØ¨ÙŠÙ†', 'warning');

            try {
                Swal.showLoading();
                
                await axios.post('/api/v1/users/create-sales-agent', {
                    name: name,
                    email: formValues.email,
                    phone: phone,
                    password: formValues.password
                }, { headers: { Authorization: `Bearer ${token}` } });

                await updateSalesStatus(reqId, 'approved', false);

                Swal.fire('ØªÙ…Øª Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­', 'ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø§Ù„ÙˆÙƒÙŠÙ„ ÙˆÙ‚Ø¨ÙˆÙ„ Ø·Ù„Ø¨Ù‡ ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù…', 'success');
                
                loadSalesRequests();
                loadSalesStats();

            } catch (err) {
                Swal.close();
                let errorMsg = err.response?.data?.message || err.message;
                if(errorMsg.includes('email')) errorMsg = "Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ù…Ø³Ø¬Ù„ Ø¨Ø§Ù„ÙØ¹Ù„ Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¢Ø®Ø±";
                Swal.fire('ÙØ´Ù„Øª Ø§Ù„Ø¹Ù…Ù„ÙŠØ©', errorMsg, 'error');
            }
        }

        async function updateSalesStatus(id, status, showMessage = true) {
            try {
                if(showMessage) Swal.showLoading();
                const res = await fetch(`/api/v1/sales/requests/${id}`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify({ status })
                });
                const data = await res.json();
                
                if(showMessage) {
                    Swal.close();
                    if(res.ok) {
                        Swal.fire('ØªÙ…', 'ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø© Ø¨Ù†Ø¬Ø§Ø­', 'success');
                        loadSalesRequests();
                    } else {
                        Swal.fire('Ø®Ø·Ø£', data.message, 'error');
                    }
                }
                return res.ok;
            } catch(e) { 
                if(showMessage) Swal.fire('Ø®Ø·Ø£', 'ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„', 'error'); 
                throw e;
            }
        }

        async function deleteSalesAgent(id, name) {
            const confirm = await Swal.fire({
                title: 'Ø­Ø°Ù Ø§Ù„ÙˆÙƒÙŠÙ„ØŸ',
                text: `Ø£Ù†Øª Ø¹Ù„Ù‰ ÙˆØ´Ùƒ Ø­Ø°Ù "${name}" Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ Ù…Ù† Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª. Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡.`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#ef4444',
                cancelButtonColor: '#6b7280',
                confirmButtonText: 'Ù†Ø¹Ù…ØŒ Ø§Ø­Ø°ÙÙ‡',
                cancelButtonText: 'Ø¥Ù„ØºØ§Ø¡'
            });

            if (confirm.isConfirmed) {
                try {
                    Swal.showLoading();
                    const res = await fetch(`/api/v1/sales/${id}`, {
                        method: 'DELETE',
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    
                    Swal.close();
                    
                    if (res.ok) {
                        Swal.fire('ØªÙ… Ø§Ù„Ø­Ø°Ù', 'ØªÙ… Ø­Ø°Ù Ø§Ù„ÙˆÙƒÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­', 'success');
                        loadSalesRequests(); 
                        loadSalesStats();    
                    } else {
                        const data = await res.json();
                        Swal.fire('Ø®Ø·Ø£', data.message || 'ÙØ´Ù„ Ø§Ù„Ø­Ø°Ù', 'error');
                    }
                } catch (e) {
                    Swal.fire('Ø®Ø·Ø£', 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„', 'error');
                }
            }
        }

        function viewSalesImage(url, name) {
            Swal.fire({
                title: name,
                imageUrl: url,
                imageWidth: 400,
                imageAlt: name,
                confirmButtonText: 'Ø¥ØºÙ„Ø§Ù‚',
                showClass: { popup: 'animate__animated animate__fadeInDown' },
                hideClass: { popup: 'animate__animated animate__fadeOutUp' }
            });
        }
    </script>
</body>
</html>