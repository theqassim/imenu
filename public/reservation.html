<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø­Ø¬Ø² Ù…Ù‚Ø¹Ø¯ | Smart Reserve</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700;800&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
   <script src="/socket.io/socket.io.js"></script>
    
    <style>
        body { font-family: 'Tajawal', sans-serif; background: #f3f4f6; margin: 0; display: flex; justify-content: center; align-items: center; min-height: 100vh; }
        .card { background: white; width: 90%; max-width: 400px; padding: 30px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); text-align: center; position: relative; overflow: hidden; }
        h1 { color: #4338ca; margin-bottom: 5px; }
        .status-box { background: #e0e7ff; color: #4338ca; padding: 15px; border-radius: 12px; margin: 20px 0; font-size: 18px; font-weight: bold; border: 2px solid #4338ca; }
        .status-box.full { background: #fee2e2; color: #dc2626; border-color: #dc2626; }
        .btn { background: #4338ca; color: white; border: none; padding: 15px; width: 100%; border-radius: 12px; font-size: 18px; font-weight: bold; cursor: pointer; transition: 0.2s; margin-top: 10px; }
        .btn:disabled { background: #ccc; cursor: not-allowed; }
        .input-seats { width: 100%; padding: 15px; border: 2px solid #e5e7eb; border-radius: 12px; font-size: 18px; text-align: center; box-sizing: border-box; margin-bottom: 10px; font-family: inherit; }
        .input-seats:focus { border-color: #4338ca; outline: none; }
        .loader { display: none; position: absolute; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.9); justify-content:center; align-items:center; z-index: 10; }
        .pulse { animation: pulse 2s infinite; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
    </style>
</head>
<body>

    <div class="card" id="main-card">
        <div class="loader" id="loader"><i class="fas fa-circle-notch fa-spin fa-3x" style="color:#4338ca"></i></div>
        
        <div id="active-view">
            <h1 id="rest-name">...</h1>
            <p style="color: #6b7280; margin-top: 0;">Ù†Ø¸Ø§Ù… Ø§Ù„Ø­Ø¬Ø² Ø§Ù„ÙÙˆØ±ÙŠ</p>

            <div id="status-container" class="status-box">
                <div>Ø§Ù„Ù…Ù‚Ø§Ø¹Ø¯ Ø§Ù„Ù…ØªØ§Ø­Ø©</div>
                <div id="seats-count" style="font-size: 32px; margin-top: 5px;">...</div>
            </div>

            <div id="booking-form">
                <div style="text-align: right; margin-bottom: 10px;">
                    <label style="font-weight:bold; display:block; margin-bottom:5px;">Ø§Ù„Ø§Ø³Ù…:</label>
                    <input type="text" id="res-name" class="input-seats" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ±ÙŠÙ…" style="text-align: right;">
                </div>
                
                <div style="text-align: right; margin-bottom: 10px;">
                    <label style="font-weight:bold; display:block; margin-bottom:5px;">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ:</label>
                    <input type="tel" id="res-phone" class="input-seats" placeholder="01xxxxxxxxx" style="text-align: right;">
                </div>

                <div style="text-align: right; margin-bottom: 15px;">
                    <label style="font-weight:bold; display:block; margin-bottom:5px;">Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ù‚Ø§Ø¹Ø¯:</label>
                    <input type="number" id="seat-input" class="input-seats" min="1" value="1">
                </div>

                <button class="btn pulse" onclick="bookSeats()">Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø§Ù„Ø­Ø¬Ø² <i class="fas fa-paper-plane"></i></button>
            </div>
        </div>

        <div id="full-view" style="display: none;">
            <i class="fas fa-ban fa-4x" style="color: #dc2626; margin-bottom: 20px;"></i>
            <h2 style="color: #dc2626; margin: 0;">Ø¹Ø°Ø±Ø§Ù‹ØŒ Ø§Ù„Ø¹Ø¯Ø¯ Ù…ÙƒØªÙ…Ù„!</h2>
            <p style="color: #6b7280;">Ù†Ø¹ØªØ°Ø± Ù…Ù†ÙƒØŒ Ù„Ù‚Ø¯ ØªÙ… Ø­Ø¬Ø² Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù‚Ø§Ø¹Ø¯ Ø§Ù„Ù…ØªØ§Ø­Ø©.</p>
            <div style="margin-top: 20px; font-size: 14px; color: #9ca3af;">Ø³ÙŠØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙØ­Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ ÙÙŠ Ø­Ø§Ù„ ØªÙˆÙØ± Ù…Ù‚Ø§Ø¹Ø¯.</div>
        </div>
    </div>

    <script>
        // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ slug Ù…Ù† Ø§Ù„Ø±Ø§Ø¨Ø·
        const pathParts = window.location.pathname.split('/');
        const slug = pathParts[pathParts.length - 1];
        let currentAvailable = 0;
        let socket;

        async function init() {
            try {
                const res = await fetch(`/api/v1/reservations/status/${slug}`);
                const data = await res.json();

                if(res.status === 403) {
                    document.body.innerHTML = `<div style="text-align:center;"><h1>ğŸš« Ø§Ù„Ø­Ø¬Ø² Ù…ØºÙ„Ù‚</h1><p>ØµØ§Ø­Ø¨ Ø§Ù„Ù…ÙƒØ§Ù† Ù„Ù… ÙŠÙ‚Ù… Ø¨ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø­Ø¬Ø².</p></div>`;
                    return;
                }

                if (data.status === 'success') {
                    document.getElementById('rest-name').innerText = data.data.restaurantName;
                    updateUI(data.data.available);
                    
                    // Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙˆÙƒØª Ù„Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù„Ø­Ø¸ÙŠ
                    // Ù†Ø­ØªØ§Ø¬ Ù…Ø¹Ø±ÙØ© ID Ø§Ù„Ù…Ø·Ø¹Ù… Ù„Ù„Ø§Ø´ØªØ±Ø§Ùƒ ÙÙŠ Ø§Ù„ØºØ±ÙØ©ØŒ Ù„ÙƒÙ† Ø§Ù„Ø³ÙˆÙƒØª ÙŠØ¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ slug Ù‡Ù†Ø§ ØµØ¹Ø¨ØŒ 
                    // Ù„Ø°Ø§ Ø§Ù„Ø£ÙØ¶Ù„ Ø£Ù† Ø§Ù„Ù€ API ÙŠØ±Ø¬Ø¹ ID Ø§Ù„Ù…Ø·Ø¹Ù… Ø£ÙŠØ¶Ø§Ù‹ Ø£Ùˆ Ù†Ø¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ Ø£Ù† Ø§Ù„Ø³ÙŠØ±ÙØ± ÙŠØ±Ø³Ù„ Ù„Ù„ØºØ±ÙØ©
                    // Ù‡Ù†Ø§ Ø³Ù†Ù‚ÙˆÙ… Ø¨Ø¹Ù…Ù„ poll Ø¨Ø³ÙŠØ· Ø£Ùˆ Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯ Ø¹Ù„Ù‰ Ø£Ù† Ø§Ù„Ø®Ø§Ø¯Ù… ÙŠØ±Ø³Ù„ ØªØ­Ø¯ÙŠØ« Ø¹Ø§Ù…
                    
                    // Ø§Ù„Ø­Ù„ Ø§Ù„Ø£Ù…Ø«Ù„: Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙˆÙƒØª
                    socket = io();
                    // Ù†Ø­Ù† Ø¨Ø­Ø§Ø¬Ø© Ù„Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ù„ØºØ±ÙØ© Ø§Ù„Ù…Ø·Ø¹Ù…. ÙÙŠ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø£ØµÙ„ÙŠ Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… ÙŠØªÙ… Ø¨Ù€ ID.
                    // Ø³Ù†Ù‚ÙˆÙ… Ø¨Ø¹Ù…Ù„ fetch Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ ID Ø§Ù„Ù…Ø·Ø¹Ù… Ø£ÙˆÙ„Ø§Ù‹
                    const restInfo = await fetch(`/api/v1/restaurants/${slug}`);
                    const restData = await restInfo.json();
                    if(restData.status === 'success') {
                        const rId = restData.data.restaurant._id;
                        socket.emit("join-restaurant", rId);
                        
                        // Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù„Ø­Ø¸ÙŠ
socket.on("seats_updated", (data) => {
    console.log("Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³ÙˆÙƒØª Ø§Ù„ÙˆØ§ØµÙ„Ø©:", data); // Ù„Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø´ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ø§Ù„Ù€ Console

    let newAvailable;

    // 1. Ø§Ø­ØªÙ…Ø§Ù„ Ø£Ù† Ø§Ù„Ø³ÙŠØ±ÙØ± ÙŠØ±Ø³Ù„ Ø§Ù„Ø±Ù‚Ù… Ø¬Ø§Ù‡Ø²Ø§Ù‹ Ø¨Ø§Ø³Ù… available
    if (data.available !== undefined) {
        newAvailable = data.available;
    } 
    // 2. Ø§Ø­ØªÙ…Ø§Ù„ Ø£Ù† Ø§Ù„Ø³ÙŠØ±ÙØ± ÙŠØ±Ø³Ù„ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ ÙˆØ§Ù„Ù…Ø­Ø¬ÙˆØ² ÙˆÙ†Ø­ØªØ§Ø¬ Ù„Ø·Ø±Ø­Ù‡Ù…
    else if (data.total !== undefined && data.booked !== undefined) {
        newAvailable = data.total - data.booked;
    }
    // 3. Ø§Ø­ØªÙ…Ø§Ù„ Ø£Ù† Ø§Ù„Ø³ÙŠØ±ÙØ± ÙŠØ±Ø³Ù„ Ø§Ù„ÙƒØ§Ø¦Ù† Ø¯Ø§Ø®Ù„ Ø®Ø§ØµÙŠØ© Ø§Ø³Ù…Ù‡Ø§ data (Ø¨Ø¹Ø¶ Ù‡ÙŠÙƒÙ„ÙŠØ§Øª Ø§Ù„Ù€ API)
    else if (data.data && data.data.available !== undefined) {
        newAvailable = data.data.available;
    }

    // Ø¥Ø°Ø§ ØªÙ… Ø­Ø³Ø§Ø¨ Ø§Ù„Ø±Ù‚Ù… Ø¨Ù†Ø¬Ø§Ø­ØŒ ÙˆØªØ£ÙƒØ¯Ù†Ø§ Ø£Ù† Ø§Ù„ØªØ­Ø¯ÙŠØ« ÙŠØ®Øµ Ù†ÙØ³ Ø§Ù„Ù…Ø·Ø¹Ù…
    if (newAvailable !== undefined) {
        // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„ØªØ­Ø¯ÙŠØ« ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ slug Ù†ØªØ£ÙƒØ¯ Ù…Ù†Ù‡ØŒ Ø£Ùˆ Ù†Ø­Ø¯Ø« Ù…Ø¨Ø§Ø´Ø±Ø©
        if (!data.slug || window.location.pathname.includes(data.slug)) {
            updateUI(newAvailable);
        }
    }
});
                    }
                }
            } catch (e) {
                console.error(e);
                Swal.fire('Ø®Ø·Ø£', 'ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'error');
            }
        }

        function updateUI(available) {
            currentAvailable = available;
            const countEl = document.getElementById('seats-count');
            const statusBox = document.getElementById('status-container');
            const form = document.getElementById('booking-form');
            const fullView = document.getElementById('full-view');
            const activeView = document.getElementById('active-view');

            if (available <= 0) {
                activeView.style.display = 'none';
                fullView.style.display = 'block';
            } else {
                activeView.style.display = 'block';
                fullView.style.display = 'none';
                countEl.innerText = available;
                statusBox.classList.remove('full');
            }
        }

        async function bookSeats() {
            const seats = document.getElementById('seat-input').value;
            const name = document.getElementById('res-name').value;
            const phone = document.getElementById('res-phone').value;

            if(!name || !phone) return Swal.fire('ØªÙ†Ø¨ÙŠÙ‡', 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø§Ø³Ù… ÙˆØ±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ', 'warning');
            if(!seats || seats <= 0) return Swal.fire('ØªÙ†Ø¨ÙŠÙ‡', 'Ø£Ø¯Ø®Ù„ Ø¹Ø¯Ø¯ Ù…Ù‚Ø§Ø¹Ø¯ ØµØ­ÙŠØ­', 'warning');
            if(seats > currentAvailable) return Swal.fire('ØªÙ†Ø¨ÙŠÙ‡', `Ø§Ù„Ù…ØªØ§Ø­ ÙÙ‚Ø· ${currentAvailable} Ù…Ù‚Ø§Ø¹Ø¯`, 'warning');

            document.getElementById('loader').style.display = 'flex';

            try {
                const res = await fetch(`/api/v1/reservations/book/${slug}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ seats, name, phone })
                });
                const data = await res.json();
                document.getElementById('loader').style.display = 'none';

                if (data.status === 'success') {
                    Swal.fire({
                        icon: 'success',
                        title: 'ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨! ğŸ‰',
                        text: 'Ø³ÙŠØµÙ„Ùƒ ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø¬Ø² Ù‚Ø±ÙŠØ¨Ø§Ù‹ Ù…Ù† Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©.',
                        showConfirmButton: true,
                        confirmButtonText: 'Ø­Ø³Ù†Ø§Ù‹'
                    });
                    if(data.data && data.data.available) {
        updateUI(data.data.available);
    } else {
        // ØªØ­Ø¯ÙŠØ« ÙŠØ¯ÙˆÙŠ Ù…Ø¤Ù‚Øª (Ù†Ø·Ø±Ø­ Ø§Ù„Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø­Ø¬ÙˆØ² Ù…Ù† Ø§Ù„Ø¹Ø¯Ø¯ Ø§Ù„Ø­Ø§Ù„ÙŠ)
        updateUI(currentAvailable - seats);
    }
                    document.getElementById('res-name').value = '';
                    document.getElementById('res-phone').value = '';
                } else {
                    Swal.fire('Ø¹Ø°Ø±Ø§Ù‹', data.message, 'error');
                    init();
                }
            } catch (e) {
                document.getElementById('loader').style.display = 'none';
                Swal.fire('Ø®Ø·Ø£', 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„', 'error');
            }
        }

        init();
    </script>
</body>
</html>